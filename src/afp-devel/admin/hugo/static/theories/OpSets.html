<div id="OpSet">
<div class="head">
<h1>Theory OpSet</h1>
</div>
<pre class="source"><span class="comment1">(* Martin Kleppmann, University of Cambridge
   Victor B. F. Gomes, University of Cambridge
   Dominic P. Mulligan, Arm Research, Cambridge
   Alastair Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Abstract OpSet›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section, we define a general-purpose OpSet abstraction that is not
specific to any one particular datatype. We develop a library of useful lemmas
that we can build upon later when reasoning about a specific datatype.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> OpSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹OpSet definition›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An OpSet is a set of (ID, operation) pairs with an associated total order
on IDs (represented here with the \isa{linorder} typeclass), and satisfying the
following properties:
\begin{enumerate}
\item The ID is unique (that is, if any two pairs in the set have the same ID,
then their operation is also the same).
\item If the operation references the IDs of any other operations, those
referenced IDs are less than that of the operation itself, according to the
total order on IDs. To avoid assuming anything about the structure of operations
here, we use a function \isa{deps} that returns the set of dependent IDs for a
given operation. This requirement is a weak expression of causality: an operation
can only depend on causally prior operations, and by making the total order on
IDs a linear extension of the causal order, we can easily ensure that any
referenced IDs are less than that of the operation itself.
\item The OpSet is finite (but we do not assume any particular maximum size).
\end{enumerate}›</span></span>

<span class="keyword1"><span class="command">locale</span></span> opset <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">opset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oper</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">deps</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oper</span> <span class="main">⇒</span> <span class="tfree">'oid</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unique_oid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">op1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">opset</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">op2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">opset</span> <span class="main">⟹</span> <span class="free">op1</span> <span class="main">=</span> <span class="free">op2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ref_older<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span> <span class="main">∈</span> <span class="free">opset</span> <span class="main">⟹</span> <span class="free">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="free">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> finite_opset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">opset</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We prove that any subset of an OpSet is also a valid OpSet. This is the
case because, although an operation can depend on causally prior operations,
the OpSet does not require those prior operations to actually exist. This weak
assumption makes the OpSet model more general and simplifies reasoning about
OpSets.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> opset_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"opset <span class="free">Y</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"opset <span class="free">X</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">oid</span> <span class="skolem">op1</span> <span class="skolem">op2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">op1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">op2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">op1</span> <span class="main">=</span> <span class="skolem">op2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> opset.unique_oid subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">oid</span> <span class="skolem">oper</span> <span class="skolem">ref</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">oper</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> opset.ref_older rev_subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms opset.finite_opset finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> opset_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"opset <span class="main">(</span>insert <span class="free">x</span> <span class="free">ops</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"opset <span class="free">ops</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms opset_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> opset_sublist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"opset <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"opset <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"opset <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms opset_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Helper lemmas about lists›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Some general-purpose lemas about lists and sets that are helpful for
subsequent proofs.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_rem_mid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_fst_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_set_remove_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_set_remove_mid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_list_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xa</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ya</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xb</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">yb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">=</span> <span class="free">xb</span> <span class="main">∧</span> <span class="free">ya</span> <span class="main">=</span> <span class="free">yb</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xa</span></span> <span class="quoted"><span class="free">xb</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="skolem">xb</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">=</span> <span class="skolem">xa</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="free">ya</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">xb</span> <span class="main">∧</span> <span class="free">ya</span> <span class="main">=</span> <span class="free">yb</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">xs</span> <span class="skolem">xa</span> <span class="skolem">xb</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span> <span class="bound">xb</span> <span class="bound">x</span><span class="main">.</span> distinct <span class="skolem">xs</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">xa</span> <span class="main">@</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">ya</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">xb</span> <span class="main">@</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">yb</span> <span class="main">⟹</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">xb</span> <span class="main">∧</span> <span class="free">ya</span> <span class="main">=</span> <span class="free">yb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xa</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="free">ya</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xb</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="free">yb</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">xb</span> <span class="main">∧</span> <span class="free">ya</span> <span class="main">=</span> <span class="free">yb</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">xa</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xb</span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_append_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> append_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">zs</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff assms set_append subsetI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> append_set_rem_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms distinct_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms distinct_set_remove_last<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms distinct_rem_mid <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms distinct_set_remove_mid <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_map_fst_remove1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="free">x</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="free">x</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span>remove1 <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.prems distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_iff
          list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> notin_set_remove1 set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The \isa{spec-ops} predicate›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \isa{spec-ops} predicate describes a list of (ID, operation) pairs that
corresponds to the linearisation of an OpSet, and which we use for sequentially
interpreting the OpSet. A list satisfies \isa{spec-ops} iff it is sorted in ascending
order of IDs, if the IDs are unique, and if every operation's dependencies have
lower IDs than the operation itself. A list is implicitly finite in Isabelle/HOL.
These requirements correspond to the OpSet definition above, and indeed we prove
later that every OpSet has a linearisation that satisfies \isa{spec-ops}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spec_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oper</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oper</span> <span class="main">⇒</span> <span class="tfree">'oid</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spec_ops</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="free"><span class="bound"><span class="entity">deps</span></span></span> <span class="main">≡</span> <span class="main">(</span>sorted <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">ops</span></span></span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">ops</span></span></span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">oid</span> <span class="bound">oper</span> <span class="bound">ref</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">∧</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">deps</span></span></span> <span class="bound">oper</span> <span class="main">⟶</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="bound">oid</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">[]</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">ops</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ops</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_map spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_distinct_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">ops</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">ops</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_rem_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">oid</span> <span class="bound">oper</span> <span class="bound">ref</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">oper</span> <span class="main">⟶</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="bound">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms set_subset_Cons spec_ops_def subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_rem_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append distinct_butlast distinct_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">oid</span> <span class="bound">oper</span> <span class="bound">ref</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">oper</span> <span class="main">⟶</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="bound">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms butlast_snoc in_set_butlastD spec_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_remove1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span>remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_map_fst_remove1 spec_ops_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> notin_set_remove1 sorted_map_remove1 spec_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_ref_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_ref_less_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms spec_ops_ref_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_id_inc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map fst <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map fst <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> le_neq_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_add_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_append spec_ops_sorted <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms spec_ops_distinct_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">oid</span> <span class="bound">oper</span> <span class="bound">ref</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">oper</span> <span class="main">⟶</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="bound">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">opr</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">opr</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">opr</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_add_any<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_add_last<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc spec_ops_rem_last<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">yo</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yo</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> oid_yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snoc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> y_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> yi_biggest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> oid_yi assms<span class="main">(</span>2<span class="main">)</span> less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI append_assoc map_append set_append snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> spec_ops_id_inc y_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> oid_yi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">yi</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> yi_biggest
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append dual_order.strict_implies_order<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">yi</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH yi_biggest spec_ops_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct1_rotate order_less_irrefl rotate1.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">opr</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">opr</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>
                     <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">opr</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">opr</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">opr</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">opr</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IH spec_ops_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ref</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">yo</span> <span class="main">⟶</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> spec_ops_ref_less append_is_Nil_conv last_appendR last_in_set last_snoc
          list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> y_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> y_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="bound">suf</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">suf</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="skolem">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="skolem">suf</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI map_append set_append snoc spec_ops_rem_last<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xi_less<span class="main">:</span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH spec_ops_id_inc snoc.prems<span class="main">(</span>1<span class="main">)</span> y_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">suf</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">suf</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xi_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suf</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="main">(</span><span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH xi_less y_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> y_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH y_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_exists_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">oid</span> <span class="bound">op1</span> <span class="bound">op2</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">op1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">op2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">⟹</span> <span class="bound">op1</span> <span class="main">=</span> <span class="bound">op2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">oid</span> <span class="bound">oper</span> <span class="bound">ref</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">oper</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="bound">oid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">op_list</span><span class="main">.</span> set <span class="bound">op_list</span> <span class="main">=</span> <span class="free">ops</span> <span class="main">∧</span> spec_ops <span class="bound">op_list</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Finite_Set.finite_induct_select<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">op_list</span><span class="main">.</span> set <span class="bound">op_list</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> spec_ops <span class="bound">op_list</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>select <span class="skolem">subset</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">op_list</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">op_list</span> <span class="main">=</span> <span class="skolem">subset</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="skolem">op_list</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">-</span> <span class="skolem">subset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> select.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span><span class="main">.</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="bound">op2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">⟹</span> <span class="bound">op2</span> <span class="main">=</span> <span class="skolem">oper</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oid</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="skolem">subset</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffD2 select image_iff prod.collapse psubsetD select.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">op_list</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">suf</span><span class="main">)</span><span class="main">.</span> <span class="skolem">oid</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spec_ops_split calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span> <span class="skolem">subset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation spec_ops_add_any assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD1<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We prove that for any given OpSet, a \isa{spec-ops} linearisation exists:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"opset <span class="free">ops</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">op_list</span><span class="main">.</span> set <span class="bound">op_list</span> <span class="main">=</span> <span class="free">ops</span> <span class="main">∧</span> spec_ops <span class="bound">op_list</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">ops</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms opset.finite_opset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">oid</span> <span class="bound">op1</span> <span class="bound">op2</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">op1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">op2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">⟹</span> <span class="bound">op1</span> <span class="main">=</span> <span class="bound">op2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms opset.unique_oid <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">oid</span> <span class="bound">oper</span> <span class="bound">ref</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ops</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">oper</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="bound">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms opset.ref_older <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">op_list</span><span class="main">.</span> set <span class="bound">op_list</span> <span class="main">=</span> <span class="free">ops</span> <span class="main">∧</span> spec_ops <span class="bound">op_list</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_exists_base<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_oid_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">op_list</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">op1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">op_list</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">op2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">op_list</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">op1</span> <span class="main">=</span> <span class="free">op2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">op_list</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">op_list</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">op_list</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> spec_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">op_list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">op1</span> <span class="main">=</span> <span class="free">op2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> <span class="free">oid</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">op1</span> <span class="main">=</span> <span class="free">op2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems notin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject in_set_zipE set_ConsD zip_map_fst_snd<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">op1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">op_list</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">op2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">op_list</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">op1</span> <span class="main">=</span> <span class="free">op2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems<span class="main">(</span>1<span class="main">)</span> spec_ops_rem_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Conversely, for any given \isa{spec-ops} list, the set of pairs in the
list is an OpSet:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_ops_is_opset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="free">op_list</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"opset <span class="main">(</span>set <span class="free">op_list</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">oid</span> <span class="bound">op1</span> <span class="bound">op2</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">op1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">op_list</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">op2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">op_list</span> <span class="main">⟹</span> <span class="bound">op1</span> <span class="main">=</span> <span class="bound">op2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms spec_ops_oid_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">oid</span> <span class="bound">oper</span> <span class="bound">ref</span><span class="main">.</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">op_list</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">oper</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="bound">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms spec_ops_ref_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="free">op_list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"opset <span class="main">(</span>set <span class="free">op_list</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The \isa{crdt-ops} predicate›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Like \isa{spec-ops}, the \isa{crdt-ops} predicate describes the linearisation of
an OpSet into a list. Like \isa{spec-ops}, it requires IDs to be unique. However,
its other properties are different: \isa{crdt-ops} does not require operations to
appear in sorted order, but instead, whenever any operation references the
ID of a prior operation, that prior operation must appear previously in the
\isa{crdt-ops} list. Thus, the order of operations is partially constrained:
operations must appear in causal order, but concurrent operations can be
ordered arbitrarily.

This list describes the operation sequence in the order it is typically applied to
an operation-based CRDT. Applying operations in the order they appear in
\isa{crdt-ops} requires that concurrent operations commute. For any \isa{crdt-ops}
operation sequence, there is a permutation that satisfies the \isa{spec-ops}
predicate. Thus, to check whether a CRDT satisfies its sequential specification,
we can prove that interpreting any \isa{crdt-ops} operation sequence with the
commutative operation interpretation results in the same end result as
interpreting the \isa{spec-ops} permutation of that operation sequence with the
sequential operation interpretation.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">crdt_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oper</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oper</span> <span class="main">⇒</span> <span class="tfree">'oid</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">crdt_ops</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">deps</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">crdt_ops</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">deps</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">oid</span></span></span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">ref</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">deps</span></span></span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">.</span> <span class="bound">ref</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">oid</span></span></span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">crdt_ops</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">deps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> crdt_ops_last<span class="main">:</span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_intro<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_rem_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops.cases snoc_eq_iff_butlast <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_ref_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> crdt_ops.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_ref_less_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_ref_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_distinct_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> crdt_ops_last fstI image_set<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_distinct_fst distinct_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_unique_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_unique_mid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> crdt_ops_unique_last Nil_is_map_conv append_Nil2 empty_iff empty_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">yr</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_rem_last snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_unique_last <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 snoc.prems y_pair<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH y_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_ref_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span> <span class="main">#</span> <span class="free">suf</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">pre</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">suf</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> crdt_ops_last prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_no_future_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ref</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ref</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crdt_ops_ref_exists<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_distinct_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ref</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_fst_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ref</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_reorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">yo</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yo</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snoc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append.assoc crdt_ops_rem_last<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.IH snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> y_pair append_assoc crdt_ops_unique_last set_map snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">yo</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">yo</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> y_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">yo</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> y_pair append_assoc snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> crdt_ops_ref_exists<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">yo</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> crdt_ops_ref_less snoc.prems<span class="main">(</span>1<span class="main">)</span> y_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">yo</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> crdt_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> y_pair crdt_ops_intro <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_unique_mid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnE image_Un
        image_set set_append snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_ref_exists
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI append_Cons image_Un set_append snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">oper</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH crdt_ops_ref_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_intro <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_rem_middle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_rem_last crdt_ops_reorder append_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_independent_suf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> spec_ops_id_inc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i2</span> <span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i2</span><span class="main">,</span> <span class="bound">op2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="bound">i2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> spec_ops_ref_less spec_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">zs</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms spec_ops_distinct crdt_ops_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> append_set_rem_last assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">zs</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> append_subset<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_reorder_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_independent_suf <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> crdt_ops_reorder x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_rem_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_rem_last crdt_ops_reorder_spec append_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_rem_penultimate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">i1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> crdt_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> crdt_ops_distinct_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_ref_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="free">i2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> crdt_ops_ref_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crdt_ops_intro<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> crdt_ops_spec_ops_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="free">xs</span> <span class="free">deps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="bound">ys</span> <span class="main">∧</span> spec_ops <span class="bound">ys</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="main">[]</span> <span class="main">=</span> set <span class="bound">ys</span> <span class="main">∧</span> spec_ops <span class="bound">ys</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="skolem">xs</span> <span class="main">=</span> set <span class="bound">ys</span> <span class="main">∧</span> spec_ops <span class="bound">ys</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">ref</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="skolem">ys</span> <span class="free">deps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">pre</span><span class="main">@</span><span class="bound">suf</span> <span class="main">∧</span>
                       <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span><span class="main">)</span> <span class="main">∧</span>
                       <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">suf</span><span class="main">)</span><span class="main">.</span> <span class="skolem">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> crdt_ops_unique_last snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oid</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> spec_ops_split <span class="quoted"><span class="quoted">‹spec_ops <span class="skolem">ys</span> <span class="free">deps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">suf</span><span class="main">)</span><span class="main">.</span> <span class="skolem">oid</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_distinct calculation snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">deps</span> <span class="skolem">ref</span><span class="main">.</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> crdt_ops_ref_less_last snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spec_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> <span class="free">deps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> spec_ops_add_any calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="bound">ys</span> <span class="main">∧</span> spec_ops <span class="bound">ys</span> <span class="free">deps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Insert_Spec">
<div class="head">
<h1>Theory Insert_Spec</h1>
</div>
<pre class="source"><span class="comment1">(* Martin Kleppmann, University of Cambridge
   Victor B. F. Gomes, University of Cambridge
   Dominic P. Mulligan, Arm Research, Cambridge
   Alastair Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Specifying list insertion›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Insert_Spec
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="OpSet.html">OpSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we consider only list insertion. We model an insertion
operation as a pair (\isa{ID, ref}), where \isa{ref} is either \isa{None}
(signifying an insertion at the head of the list) or \isa{Some r}
(an insertion immediately after a reference element with ID \isa{r}).
If the reference element does not exist, the operation does nothing.

We provide two different definitions of the interpretation function for list
insertion: \isa{insert-spec} and \isa{insert-alt}. The \isa{insert-alt} definition
matches the paper, while \isa{insert-spec} uses the Isabelle/HOL list datatype,
making it more suitable for formal reasoning. In a later subsection we prove
that the two definitions are in fact equivalent.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'oid</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_spec</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> None<span class="main">)</span>     <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_spec</span> <span class="main">[]</span>     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>        <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_spec</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">oid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
                 <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">insert_spec</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_alt</span> <span class="free"><span class="bound"><span class="entity">list_rel</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">list_rel</span></span></span>
      <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">list_rel</span></span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
           <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oid</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">list_rel</span></span></span><span class="main">}</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">list_rel</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\isa{interp-ins} is the sequential interpretation of a set of insertion
operations. It starts with an empty list as initial state, and then applies
the operations from left to right.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'oid</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_ins</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> foldl insert_spec <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \isa{insert-ops} predicate›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We now specialise the definitions from the abstract OpSet section for list
insertion. \isa{insert-opset} is an opset consisting only of insertion operations,
and \isa{insert-ops} is the specialisation of the \isa{spec-ops} predicate for
insertion operations. We prove several useful lemmas about \isa{insert-ops}.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> insert_opset <span class="main">=</span> opset <span class="quoted"><span class="free">opset</span></span> <span class="quoted">set_option</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">opset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_ops</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">≡</span> spec_ops <span class="free"><span class="bound"><span class="entity">list</span></span></span> set_option"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_NilI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def spec_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_rem_last <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms insert_ops_def spec_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_rem_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms insert_ops_def spec_ops_rem_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_appendD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> insert_ops_rem_last append_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_rem_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">suf</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pre</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span> <span class="main">⟹</span> insert_ops <span class="free">suf</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">pre</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">suf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def sorted_append spec_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">suf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def spec_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">pre</span><span class="main">)</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span> <span class="main">⟹</span> insert_ops <span class="free">suf</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def spec_ops_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_remove1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms insert_ops_def spec_ops_remove1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> last_op_greatest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">op_list</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">op_list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms spec_ops_id_inc insert_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_ref_older<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def spec_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_memb_ref_older<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">op_list</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">op_list</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms insert_ops_ref_older split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of the \isa{insert-spec} function›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_spec_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">oid</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute sup_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_spec_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">oid</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">[]</span> <span class="main">∪</span> <span class="main">{</span><span class="free">oid</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> set <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">oid</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_spec <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">oid</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">ref</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute sup_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_spec_nonex <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">⟹</span> insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">ref</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute sup_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_greater_non_memb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">oid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1"><span class="command">lemma</span></span> inserted_item_ident<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ref</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">ref</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_spec_distinct <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">oid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ref</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insert_spec <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insert_spec <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">id</span>
    <span class="keyword3"><span class="command">assume</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="skolem">id</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">id</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D EQ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">≠</span> <span class="free">oid</span> <span class="main">∧</span> <span class="skolem">id</span> <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">oid</span> <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">∧</span> distinct <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> T <span class="main">=</span> this
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> NEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">id</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="skolem">id</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D L <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_spec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_spec_none insert_spec_nonex
            insert_spec_set insert_iff list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_less_iff_gr_or_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="skolem">id</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S IH<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="skolem">id</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="skolem">id</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this S T <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_after_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">oid</span> <span class="main">#</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_somewhere<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="free">list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">list</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="free">list</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">list</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">[]</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">[]</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">[]</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">list</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">list</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="skolem">list</span> <span class="main">⟹</span>
         <span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">list</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="skolem">list</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> set <span class="skolem">list</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil insert_spec.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> set <span class="skolem">list</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">list</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∧</span> insert_spec <span class="skolem">list</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∧</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_first_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xsa</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> insert_spec <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">xs</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">⟹</span>
             <span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ref</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> insert_spec <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> None"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_second_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span>insert_spec <span class="free">ys</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> insert_spec <span class="free">ys</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> insert_spec <span class="free">ys</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> insert_spec <span class="free">ys</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of the \isa{interp-ins} function›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_tail_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_subset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="free">op_list</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="free">op_list</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">op_list</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">[]</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interp_ins_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> spec<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ref</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH spec x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH spec x_pair <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">op_list</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_ins <span class="free">op_list</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">op_list</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_ins <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> last_op_greatest snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interp_ins_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insert_spec <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH insert_spec_distinct insert_spec_nonex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_pair interp_ins_tail_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalence of the two definitions of insertion›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹At the beginning of this section we gave two different definitions of
interpretation functions for list insertion: \isa{insert-spec} and
\isa{insert-alt}. In this section we prove that the two are equivalent.

We first define how to derive the successor relation from an Isabelle list.
This relation contains (\isa{id}, \isa{None}) if \isa{id} is the last element
of the list, and (\isa{id1}, \isa{id2}) if \isa{id1} is immediately
followed by \isa{id2} in the list.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">succ_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ_rel</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">succ_rel</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">head</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">head</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">succ_rel</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">head</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">head</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">succ_rel</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\isa{interp-alt} is the equivalent of \isa{interp-ins}, but using
\isa{insert-alt} instead of \isa{insert-spec}. To match the paper, it uses a
distinct head element to refer to the beginning of the list.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_alt</span> <span class="free"><span class="bound"><span class="entity">head</span></span></span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> foldl insert_alt <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">head</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
            <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> None<span class="main">)</span>     <span class="main">⇒</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">head</span></span></span><span class="main">)</span> <span class="main">|</span>
            <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> Some <span class="bound">ref</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">ref</span><span class="main">)</span><span class="main">)</span> 
      <span class="free"><span class="bound"><span class="entity">ops</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_set_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">(</span>succ_rel <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> succ_rel.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_functional<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b1</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">=</span> <span class="free">b2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> succ_rel.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">head</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">head</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">head</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>succ_rel <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> succ_rel_set_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">=</span> <span class="free">b2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 image_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> succ_rel <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">=</span> <span class="free">b2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_rem_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> succ_rel <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> head_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fst <span class="main">`</span> succ_rel <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succ_rel_set_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> succ_rel <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation head_notin image_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject fst_conv head_notin image_eqI insertE insert_is_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> succ_rel <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_iff calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> succ_rel <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_swap_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">oid</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> succ_rel <span class="free">list</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">list</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff assms singletonI succ_rel.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> succ_rel_functional<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_insert_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">ref</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">oid</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> Some <span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">ref</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> Some <span class="free">oid</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
           <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">oid</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">ref</span><span class="main">}</span> <span class="main">=</span>
                 <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> Some <span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">ref</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">ref</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> Some <span class="free">oid</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
           <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">oid</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">oid</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
                 <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">oid</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_insert_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ref_in_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">list</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">ref</span><span class="main">}</span> <span class="main">=</span> succ_rel <span class="free">list</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms succ_rel_rem_head <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">oid</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nx</span><span class="main">.</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">nx</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">nx</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succ_rel_functional ref_in_rel<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">i</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">ref</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">i</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">ref</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_in_rel<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">ref</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> Some <span class="free">oid</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
                   <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">oid</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ref_in_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span>
                   succ_rel <span class="free">list</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> Some <span class="free">oid</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">oid</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> succ_rel <span class="free">list</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ref_in_rel succ_rel_swap_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">oid</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> Some <span class="free">oid</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> succ_rel <span class="free">list</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">ref</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_insert_later<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">ref</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> Some <span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span>
                 <span class="free">a</span> <span class="main">#</span> <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> Some <span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> Some <span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> Some <span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_rel_insert_alt assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rel_insert_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">list</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="free">list</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert_alt <span class="main">(</span>succ_rel <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">list</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert_alt <span class="main">(</span>succ_rel <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">ref</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> succ_rel_insert_head <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="free">ref</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="skolem">list</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   insert_alt <span class="main">(</span>succ_rel <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                     insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">list</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Cons.prems succ_rel_insert_later<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The main result of this section, that \isa{insert-spec} and \isa{insert-alt}
are equivalent.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> insert_alt_equivalent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">head</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> Some <span class="bound">r</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">ops</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">head</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="free">ops</span><span class="main">)</span> <span class="main">=</span> interp_alt <span class="free">head</span> <span class="free">ops</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> interp_alt <span class="free">head</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_def interp_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> interp_alt <span class="free">head</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_list<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_ins_distinct snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_ins_subset snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> interp_alt <span class="free">head</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_alt <span class="free">head</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_alt <span class="main">(</span>interp_alt <span class="free">head</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="free">head</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_alt_def None x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="free">head</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> Some <span class="free">head</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_list succ_rel_insert_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> <span class="main">(</span>insert_spec <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold None x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ref</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">≠</span> <span class="free">head</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Some snoc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_alt <span class="free">head</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_alt <span class="main">(</span>interp_alt <span class="free">head</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_alt_def Some x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> insert_alt <span class="main">(</span>succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> succ_rel <span class="main">(</span>insert_spec <span class="main">(</span><span class="free">head</span> <span class="main">#</span> interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> Some <span class="skolem">ref</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_list succ_rel_insert_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> <span class="main">(</span>insert_spec <span class="main">(</span>interp_ins <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> Some <span class="skolem">ref</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ref</span> <span class="main">≠</span> <span class="free">head</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> succ_rel <span class="main">(</span><span class="free">head</span> <span class="main">#</span> <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold Some x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \isa{list-order} predicate›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\isa{list-order ops x y} holds iff, after interpreting the list of
insertion operations \isa{ops}, the list element with ID \isa{x} appears
before the list element with ID \isa{y} in the resulting list. We prove several
lemmas about this predicate; in particular, that executing additional insertion
operations does not change the relative ordering of existing list elements.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'oid</span> <span class="main">⇒</span> <span class="tfree">'oid</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_order</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> interp_ins <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_orderI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">ops</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_orderE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> interp_ins <span class="free">ops</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_memb1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_memb2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">op_list</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">op_list</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">op_list</span> <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">op_list</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xxs</span></span> <span class="skolem"><span class="skolem">xys</span></span> <span class="skolem"><span class="skolem">xzs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">op_list</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xxs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="skolem">xys</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="skolem">xzs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_def interp_ins_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yxs</span></span> <span class="skolem"><span class="skolem">yys</span></span> <span class="skolem"><span class="skolem">yzs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">op_list</span> <span class="main">=</span> <span class="skolem">yxs</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="main">(</span><span class="skolem">yys</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">@</span><span class="skolem">yzs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_def interp_ins_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_ins <span class="free">op_list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms interp_ins_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xzs</span> <span class="main">=</span> <span class="skolem">yys</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">@</span><span class="skolem">yzs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_list_split<span class="main">[</span><span class="operator">OF</span> 3<span class="main">,</span> <span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">op_list</span> <span class="main">=</span> <span class="skolem">xxs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="skolem">xys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">@</span><span class="skolem">yys</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">@</span><span class="skolem">yzs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">op_list</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc list_orderI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_preserves_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">rest</span> <span class="main">=</span> <span class="free">before</span> <span class="main">@</span> <span class="free">after</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span>  <span class="main">=</span> <span class="free">before</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="free">after</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> interp_ins <span class="free">rest</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> interp_ins <span class="free">ops</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">after</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rest</span></span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">ops</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="free">before</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> interp_ins <span class="skolem">rest</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> interp_ins <span class="skolem">ops</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ref</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">rest</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">(</span>interp_ins <span class="free">before</span><span class="main">)</span> <span class="main">∧</span>
           interp_ins <span class="skolem">ops</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>interp_ins <span class="free">before</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 Nil.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">before</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">before</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∧</span>
          insert_spec <span class="main">(</span>interp_ins <span class="free">before</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">oid</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_somewhere Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">rest</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∧</span> interp_ins <span class="skolem">ops</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 Nil.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">ops</span> <span class="main">=</span> <span class="main">(</span>interp_ins <span class="skolem">rest</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_spec_nonex 1 Nil.prems<span class="main">(</span>3<span class="main">)</span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">oper</span> <span class="skolem">op_list</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">op_list</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">oper</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="skolem">op_list</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">oper</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ops1<span class="main">:</span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="skolem">op_list</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ops2<span class="main">:</span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">op_list</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_ops_appendD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="skolem">op_list</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">op_list</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oper</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> interp_ins <span class="skolem">rest</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> interp_ins <span class="skolem">ops</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="skolem">op_list</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">oper</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1 <span class="quoted"><span class="quoted">‹<span class="skolem">oper</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> append.assoc append_Cons insert_spec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          interp_ins_tail_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">op_list</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">oper</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH2 None <span class="quoted"><span class="quoted">‹<span class="skolem">oper</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> append.assoc append_Cons insert_spec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          interp_ins_tail_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>3<span class="main">)</span> snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">op_list</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
                  insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH2 append.assoc append_Cons interp_ins_tail_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">before</span> <span class="main">@</span> <span class="skolem">op_list</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1 append.assoc interp_ins_tail_unfold Some<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>r_xs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="main">|</span> <span class="main">(</span>r_ys<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="main">|</span> <span class="main">(</span>r_zs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">zs</span>"</span></span> <span class="main">|</span>
      <span class="main">(</span>r_nonex<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∉</span> set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> interp_ins <span class="skolem">rest</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> interp_ins <span class="skolem">ops</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> r_xs
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span>
                      <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> insert_first_part<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> r_xs insert_first_part<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="quoted"><span class="quoted">‹<span class="skolem">oper</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> r_ys
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∉</span> set <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH2 ops2 interp_ins_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span>
                               <span class="skolem">xs</span> <span class="main">@</span> <span class="main">(</span>insert_spec <span class="skolem">ys</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_first_part insert_second_part insert_spec_nonex
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Some UnE r_ys set_append<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Some calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="quoted"><span class="quoted">‹<span class="skolem">oper</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> r_zs
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH2 ops2 interp_ins_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span>
                               <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">(</span>insert_spec <span class="skolem">zs</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Some UnE insert_second_part insert_spec_nonex set_append<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">(</span>insert_spec <span class="skolem">zs</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_zs calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_second_part<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="quoted"><span class="quoted">‹<span class="skolem">oper</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> r_nonex
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_nonex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="quoted"><span class="quoted">‹<span class="skolem">oper</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_distinct_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">⊆</span> set <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A</span> <span class="main">≤</span> length <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A</span> <span class="main">≤</span> length <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True length_remove1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">A</span> <span class="main">⊆</span> set <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A</span> <span class="main">≤</span> length <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_subset_length_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">⊆</span> set <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">B</span> <span class="main">≤</span> length <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">=</span> set <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A</span> <span class="main">≤</span> length <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_distinct_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_card le_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">=</span> set <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_subset_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_diff_Suc_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> length <span class="free">ys</span> <span class="main">=</span> Suc <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">[]</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">-</span> length <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> One_nat_def Suc_pred True diff_Suc_Suc length_Cons
            length_pos_if_in_set length_remove1<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Cons.IH Cons.prems distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_remove1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_set_remove1 set_subset_Cons subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> app_length_lt_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xsa</span> <span class="main">@</span> <span class="free">zsa</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xsa</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xsa</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">xsa</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xsa</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zsa</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> append_eq_append_conv_if append_take_drop_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_monotonic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">⊆</span> set <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">A</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">B</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span>length <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">-</span></span> length <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">xa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">xa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def spec_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="skolem">xa</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xa</span> <span class="main">-</span> length <span class="free">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">=</span> set <span class="skolem">xa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_subset_length_eq less.prems<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹distinct <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xa</span>›</span></span> diff_is_0_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">xa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>map fst <span class="free">A</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>map fst <span class="skolem">xa</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹sorted <span class="main">(</span>map fst <span class="free">A</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="main">(</span>map fst <span class="skolem">xa</span><span class="main">)</span>›</span></span> map_sorted_distinct_set_unique
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_map less.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_Un_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="skolem">xa</span> <span class="free">x</span> <span class="free">y</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∉</span> set <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_diff_Suc_exists <span class="quoted"><span class="quoted">‹distinct <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xa</span>›</span></span> less.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span>remove1 <span class="skolem">e</span> <span class="skolem">xa</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>remove1 <span class="skolem">e</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">-</span> length <span class="free">A</span> <span class="main">&lt;</span> Suc <span class="skolem">nat</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> diff_Suc_1 diff_commute length_remove1 less_Suc_eq Suc <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">xa</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>remove1 <span class="skolem">e</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_remove1 less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">⊆</span> set <span class="main">(</span>remove1 <span class="skolem">e</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∉</span> set <span class="free">A</span>›</span></span> in_set_remove1 less.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rev_subsetD subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc less.IH less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span>remove1 <span class="skolem">e</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> xa_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">ps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∉</span> set <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list_first <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="skolem">xa</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"remove1 <span class="skolem">e</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">@</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ps</span> <span class="main">@</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove1_append<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="skolem">ps</span> <span class="main">@</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="skolem">ps</span> <span class="main">@</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xa_split less.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil insert_ops_remove1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xsa</span></span> <span class="skolem"><span class="skolem">ysa</span></span> <span class="skolem"><span class="skolem">zsa</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="skolem">ps</span> <span class="main">@</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">zsa</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> interp_xa<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="skolem">ps</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">ysa</span> <span class="main">@</span> <span class="skolem">zsa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_preserves_order e_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> xsa_zsa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">zsa</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_ins_def remove1_append calculation xa_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="skolem">xa</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xsa</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span><span class="main">@</span><span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> app_length_lt_exists xsa_zsa <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">ysa</span> <span class="main">@</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> calculation xa_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="skolem">xa</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="skolem">xa</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xsa</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> xsa_zsa1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">zsa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xsa_zsa<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> app_length_lt_exists True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xsa</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> append_eq_append_conv_if id_take_nth_drop linorder_not_less
            nth_append nth_append_length False <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zsa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True xsa_zsa1 append_eq_append_conv_if append_eq_conv_conj calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span>
              <span class="main">(</span><span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ysa</span> <span class="main">@</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_pair interp_xa xa_split<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="skolem">xa</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> list_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xsa</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">xsa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">zsa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xsa_zsa<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">xsa</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> app_length_lt_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="main">@</span> <span class="skolem">ysa</span> <span class="main">@</span> <span class="skolem">zsa</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">ysa</span> <span class="main">@</span> <span class="skolem">zsa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">ysa</span> <span class="main">@</span> <span class="skolem">zsa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> e_pair interp_xa xa_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="skolem">xa</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> list_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="List_Spec">
<div class="head">
<h1>Theory List_Spec</h1>
</div>
<pre class="source"><span class="comment1">(* Martin Kleppmann, University of Cambridge
   Victor B. F. Gomes, University of Cambridge
   Dominic P. Mulligan, Arm Research, Cambridge
   Alastair Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Relationship to Strong List Specification›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we show that our list specification is stronger than the
$\mathcal{A}_\textsf{strong}$ specification of collaborative text editing by
Attiya et al.~\cite{Attiya:2016kh}. We do this by showing that the OpSet
interpretation of any set of insertion and deletion operations satisfies all
of the consistency criteria that constitute the $\mathcal{A}_\textsf{strong}$
specification.

Attiya et al.'s specification is as follows~\cite{Attiya:2016kh}:

\begin{displayquote}
An abstract execution $A = (H, \textsf{vis})$ belongs to the
\emph{strong list specification} $\mathcal{A}_\textsf{strong}$ if and only if
there is a relation
$\textsf{lo} \subseteq \textsf{elems}(A) \times \textsf{elems}(A)$, called the
\emph{list order}, such that:
\begin{enumerate}
\item Each event $e = \mathit{do}(\mathit{op}, w) \in H$ returns a sequence of
elements $w=a_0 \dots a_{n-1}$, where $a_i \in \textsf{elems}(A)$, such that
\begin{enumerate}
\item $w$ contains exactly the elements visible to $e$ that have been inserted,
but not deleted:
\[ \forall a.\; a \in w \quad\Longleftrightarrow\quad (\mathit{do}(\textsf{ins}(a, \_), \_) \le_\textsf{vis} e)
\;\wedge\; \neg(\mathit{do}(\textsf{del}(a), \_) \le_\textsf{vis} e). \]
\item The order of the elements is consistent with the list order:
\[ \forall i, j.\; (i &lt; j) \;\Longrightarrow\; (a_i, a_j) \in \textsf{lo}. \]
\item Elements are inserted at the specified position:
if $\mathit{op} = \textsf{ins}(a, k)$, then $a = a_{\mathrm{min} \{k,\; n-1\}}$.
\end{enumerate}
\item The list order $\textsf{lo}$ is transitive, irreflexive and total, and
thus determines the order of all insert operations in the execution.
\end{enumerate}
\end{displayquote}

This specification considers only insertion and deletion operations, but no
assignment. Moreover, it considers only a single list object, not a graph of
composable objects like in our paper. Thus, we prove the relationship to
$\mathcal{A}_\textsf{strong}$ using a simplified interpretation function that
defines only insertion and deletion on a single list.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> List_Spec
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Insert_Spec.html">Insert_Spec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We first define a datatype for list operations, with two constructors:
\isa{Insert ref val}, and \isa{Delete ref}. For insertion, the \isa{ref} argument
is the ID of the existing element after which we want to insert, or \isa{None}
to insert at the head of the list.
The \isa{val} argument is an arbitrary value to associate with the list element.
For deletion, the \isa{ref} argument is the ID of the existing list element
to delete.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op <span class="main">=</span>
  Insert <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span> option"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span> <span class="main">|</span>
  Delete <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹When interpreting operations, the result is a pair (\isa{list, vals}).
The \isa{list} contains the IDs of list elements in the correct order
(equivalent to the list relation in the paper), and \isa{vals} is a mapping
from list element IDs to values (equivalent to the element relation in the paper).

Insertion delegates to the previously defined \isa{insert-spec} interpretation
function. Deleting a list element removes it from \isa{vals}.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">interp_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">⇀</span> <span class="tfree">'val</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span>
               <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">⇀</span> <span class="tfree">'val</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_op</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vals</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> Insert <span class="free"><span class="bound"><span class="entity">ref</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert_spec <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vals</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_op</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vals</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> Delete <span class="free"><span class="bound"><span class="entity">ref</span></span></span>    <span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vals</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ref</span></span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">⇀</span> <span class="tfree">'val</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_ops</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> foldl interp_op <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Map.empty<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\isa{list-order ops x y} holds iff, after interpreting the list of
operations \isa{ops}, the list element with ID \isa{x} appears before the
list element with ID \isa{y} in the resulting list.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'oid</span> <span class="main">⇒</span> <span class="tfree">'oid</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_order</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> fst <span class="main">(</span>interp_ops <span class="free"><span class="bound"><span class="entity">ops</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \isa{make-insert} function generates a new operation for insertion into
a given index in a given list.
The exclamation mark is Isabelle's list subscript operator.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">make_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span> list <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_insert</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">0</span>       <span class="main">=</span> Insert None <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">make_insert</span> <span class="main">[]</span>   <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>       <span class="main">=</span> Insert None <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">make_insert</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> Insert <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">!</span> <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \isa{list-ops} predicate is a specialisation of \isa{spec-ops} to
the \isa{list-op} datatype: it describes a list of (ID, operation) pairs that
is sorted by ID, and can thus be used for the sequential interpretation of
the OpSet.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_op_deps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op <span class="main">⇒</span> <span class="tfree">'oid</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_op_deps</span> <span class="main">(</span>Insert <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list_op_deps</span> <span class="main">(</span>Insert  None      <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>    <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list_op_deps</span> <span class="main">(</span>Delete  <span class="free"><span class="bound"><span class="entity">ref</span></span></span>        <span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> list_opset <span class="main">=</span> opset <span class="quoted"><span class="free">opset</span></span> <span class="quoted">list_op_deps</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">opset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_ops</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> spec_ops <span class="free"><span class="bound"><span class="entity">ops</span></span></span> list_op_deps"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about insertion and deletion›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insertions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insertions</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">oper</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="bound">oper</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> Insert <span class="bound">ref</span> <span class="bound">val</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">ref</span><span class="main">)</span> <span class="main">|</span>
                   <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> Delete <span class="bound">ref</span>    <span class="main">)</span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inserted_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'oid</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inserted_ids</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">oper</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="bound">oper</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> Insert <span class="bound">ref</span> <span class="bound">val</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">oid</span> <span class="main">|</span>
                   <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> Delete <span class="bound">ref</span>    <span class="main">)</span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deleted_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'oid</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> list_op<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'oid</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deleted_ids</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">oper</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="bound">oper</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> Insert <span class="bound">ref</span> <span class="bound">val</span><span class="main">)</span> <span class="main">⇒</span> None <span class="main">|</span>
                   <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> Delete <span class="bound">ref</span>    <span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">ref</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ops_unfold_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_op <span class="main">(</span>interp_ops <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"List.map_filter <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> List.map_filter <span class="free">P</span> <span class="free">xs</span> <span class="main">@</span> List.map_filter <span class="free">P</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"List.map_filter <span class="free">P</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms map_filter_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_filter_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"List.map_filter <span class="free">P</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms map_filter_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_filter_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insertions_last_ins<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Insert <span class="free">ref</span> <span class="free">val</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_Some map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insertions_last_del<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Delete <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_None map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insertions_fst_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>insertions <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="free">ops</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>insertions <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def spec_ops_def insertions_def map_filter_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ops</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">oper</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">ref</span> <span class="skolem">val</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair insertions_last_ins<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc.IH a_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">ref</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair insertions_last_del<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insertions_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">A</span> <span class="main">⊆</span> set <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>insertions <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="skolem">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>insertions <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ops</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="skolem">ops</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_ops_def spec_ops_rem_last snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="skolem">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> A_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">bs</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">as</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list_first<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"remove1 <span class="skolem">a</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove1_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> as_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> insertions <span class="skolem">as</span> <span class="main">@</span> insertions <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_append<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> as_a_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"insertions <span class="skolem">A</span> <span class="main">=</span> insertions <span class="skolem">as</span> <span class="main">@</span> insertions <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> insertions <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insertions_def map_filter_append<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> list_ops_def spec_ops_remove1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> list_ops_def spec_ops_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">ops</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_remove1_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹list_ops <span class="skolem">ops</span>›</span></span> snoc.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">oper</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">ref</span> <span class="skolem">val</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_Some a_pair<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>insertions <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> as_a_bs as_bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Insert a_pair insertions_last_ins<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">ref</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_None a_pair<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>insertions <span class="main">(</span>remove1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> as_a_bs as_bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Delete a_pair insertions_last_del<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">A</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiffE snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="skolem">A</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.IH snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹list_ops <span class="skolem">ops</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_append<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_ops_insertions<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">ops</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>insertions <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>insertions <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_ops_def spec_ops_def insertions_def map_filter_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ops</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_ops_def spec_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">oper</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">ref</span> <span class="skolem">val</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair insertions_last_ins<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ops</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_pair list_ops_def snoc.prems spec_ops_id_inc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insertions_fst_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_op_deps <span class="skolem">oper</span> <span class="main">=</span> set_option <span class="skolem">ref</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ref</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> set_option <span class="skolem">ref</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_ops_def spec_ops_ref_less
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_pair last_in_set snoc.prems snoc_eq_iff_butlast<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH insert_ops_def spec_ops_add_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">ref</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair insertions_last_del<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inserted_ids_last_ins<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inserted_ids <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Insert <span class="free">ref</span> <span class="free">val</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> inserted_ids <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inserted_ids_def map_filter_Some map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inserted_ids_last_del<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inserted_ids <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Delete <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> inserted_ids <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inserted_ids_def map_filter_None map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inserted_ids_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>inserted_ids <span class="free">ops</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ref</span> <span class="bound">val</span><span class="main">.</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Insert <span class="bound">ref</span> <span class="bound">val</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>inserted_ids <span class="main">[]</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ref</span> <span class="bound">val</span><span class="main">.</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Insert <span class="bound">ref</span> <span class="bound">val</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inserted_ids_def List.map_filter_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ops</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>inserted_ids <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">∃</span><span class="bound">ref</span> <span class="bound">val</span><span class="main">.</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Insert <span class="bound">ref</span> <span class="bound">val</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">oper</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inserted_ids <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> inserted_ids <span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair inserted_ids_last_ins<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.IH a_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inserted_ids <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> inserted_ids <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair inserted_ids_last_del<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair snoc.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deleted_ids_last_ins<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"deleted_ids <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Insert <span class="free">ref</span> <span class="free">val</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> deleted_ids <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deleted_ids_def map_filter_None map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> deleted_ids_last_del<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"deleted_ids <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Delete <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> deleted_ids <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">ref</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deleted_ids_def map_filter_Some map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> deleted_ids_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>deleted_ids <span class="free">ops</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Delete <span class="free">ref</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>deleted_ids <span class="main">[]</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Delete <span class="free">ref</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deleted_ids_def List.map_filter_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ops</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>deleted_ids <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Delete <span class="free">ref</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">oper</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">r</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deleted_ids <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> deleted_ids <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair deleted_ids_last_ins<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a_pair snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deleted_ids <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> deleted_ids <span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">r</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair deleted_ids_last_del<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a_pair snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deleted_ids_refs_older<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">oper</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ref</span><span class="main">.</span> <span class="bound">ref</span> <span class="main">∈</span> set <span class="main">(</span>deleted_ids <span class="free">ops</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ref</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">∈</span> set <span class="main">(</span>deleted_ids <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> in_ops<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> Delete <span class="skolem">ref</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deleted_ids_exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">oper</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">oper</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> list_op_deps <span class="bound">oper</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms list_ops_def spec_ops_ref_less spec_ops_rem_last<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_ops <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ops</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_ops_def spec_ops_id_inc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_ops in_set_zipE zip_map_fst_snd<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about interpreting operations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ops_list_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span> <span class="main">=</span> interp_ins <span class="main">(</span>insertions <span class="free">ops</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span>insertions <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertions_def map_filter_def interp_ins_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> interp_ins <span class="main">(</span>insertions <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ops</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> interp_ins <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">oper</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">ref</span> <span class="skolem">val</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair insertions_last_ins<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span>insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="main">(</span>insertions <span class="skolem">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="skolem">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Insert a_pair fst_conv interp_op.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> interp_ops_unfold_last prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">ref</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insertions <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertions <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_pair insertions_last_del<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>interp_ops <span class="skolem">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Delete a_pair eq_fst_iff interp_op.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> interp_ops_unfold_last<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ops_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">ops</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms interp_ins_distinct interp_ops_list_equiv list_ops_insertions<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> Insert_Spec.list_order <span class="main">(</span>insertions <span class="free">ops</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Insert_Spec.list_order_def List_Spec.list_order_def interp_ops_list_equiv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ops_vals_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">ops</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>snd <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>inserted_ids <span class="free">ops</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ops <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Map.empty<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"inserted_ids <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"deleted_ids <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inserted_ids_def deleted_ids_def map_filter_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>snd <span class="main">(</span>interp_ops <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>inserted_ids <span class="main">[]</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>snd <span class="main">(</span>interp_ops <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>inserted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_ops_def spec_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">oper</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">list</span></span> <span class="skolem"><span class="skolem">vals</span></span> <span class="keyword2"><span class="keyword">where</span></span> interp_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ops <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">list</span><span class="main">,</span> <span class="skolem">vals</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>snd <span class="main">(</span>interp_ops <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             set <span class="main">(</span>inserted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">oper</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">ref</span> <span class="skolem">val</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ops <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert_spec <span class="skolem">list</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">,</span> <span class="skolem">vals</span><span class="main">(</span><span class="skolem">oid</span> <span class="main">↦</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ops_unfold_last interp_xs x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>snd <span class="main">(</span>interp_ops <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dom <span class="skolem">vals</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">oid</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inserted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> dom <span class="skolem">vals</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH interp_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inserted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> inserted_ids <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">oid</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Insert inserted_ids_last_ins x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deleted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> deleted_ids <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Insert deleted_ids_last_ins x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inserted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">{</span><span class="skolem">oid</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>inserted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">oid</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="main">(</span>inserted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deleted_ids_refs_older snoc.prems x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">ref</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_ops <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">list</span><span class="main">,</span> <span class="skolem">vals</span><span class="main">(</span><span class="skolem">ref</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ops_unfold_last interp_xs x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>snd <span class="main">(</span>interp_ops <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dom <span class="skolem">vals</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ref</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inserted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> dom <span class="skolem">vals</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH interp_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inserted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> inserted_ids <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Delete inserted_ids_last_del x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deleted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> deleted_ids <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ref</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Delete deleted_ids_last_del x_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inserted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           set <span class="main">(</span>inserted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>set <span class="main">(</span>deleted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ref</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>inserted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>deleted_ids <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ref</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_spec_nth_oid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="free">n</span> <span class="main">=</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">[]</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="main">[]</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="free">oid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> gr_implies_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> gr_implies_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc_pred' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_spec_inc_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>insert_spec <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> <span class="free">oid</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nat</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>insert_spec <span class="skolem">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">nat</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_split_two_elems<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">mid</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">mid</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">suf</span> <span class="main">∨</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">mid</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">suf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="skolem">as</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> as_bs<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> as_bs assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> as_bs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Satisfying all conditions of $\mathcal{A}_\textsf{strong}$›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Part 1(a) of Attiya et al.'s specification states that whenever the
list is observed, the elements of the list are exactly those that have
been inserted but not deleted. $\mathcal{A}_\textsf{strong}$ uses the
visibility relation $\le_\textsf{vis}$ to capture the operations known
to a node at some arbitrary point in the execution; in the OpSet model,
we can simply prove the theorem for an arbitrary OpSet, since the
contents of the OpSet at a particular time on a particular node correspond
exactly to the set of operations known to that node at that time.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> inserted_but_not_deleted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interp_ops <span class="free">ops</span> <span class="main">=</span> <span class="main">(</span><span class="free">list</span><span class="main">,</span> <span class="free">vals</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">vals</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ref</span> <span class="bound">val</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> Insert <span class="bound">ref</span> <span class="bound">val</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span><span class="main">)</span> <span class="main">∧</span>
                            <span class="main">(</span><span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Delete <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms deleted_ids_exist inserted_ids_exist interp_ops_vals_domain
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff snd_conv<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Part 1(b) states that whenever the list is observed, the order of
list elements is consistent with the global list order. We can define the
global list order simply as the list order that arises from interpreting
the OpSet containing all operations in the entire execution. Then, at any
point in the execution, the OpSet is some subset of the set of all
operations.

We can then rephrase condition 1(b) as follows: whenever list element \isa{x}
appears before list element \isa{y} in the interpretation of \isa{some-ops},
then for any OpSet \isa{all-ops} that is a superset of \isa{some-ops},
\isa{x} must also appear before \isa{y} in the interpretation of \isa{all-ops}.
In other words, adding more operations to the OpSet does not change the
relative order of any existing list elements.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> list_order_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">some_ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">all_ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">some_ops</span> <span class="main">⊆</span> set <span class="free">all_ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">some_ops</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">all_ops</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms list_order_monotonic list_ops_insertions insertions_subset list_order_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Part 1(c) states that inserted elements appear at the specified position:
that is, immediately after an insertion of \isa{oid} at index \isa{k}, the list
index \isa{k} does indeed contain \isa{oid} (provided that \isa{k} is less than the
length of the list). We prove this property below.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> correct_position_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ins</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="main">=</span> make_insert <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="free">val</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">list</span> <span class="main">=</span> fst <span class="main">(</span>interp_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ins</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">list</span> <span class="main">!</span> <span class="main">(</span>min <span class="free">k</span> <span class="main">(</span>length <span class="free">list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">oid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"make_insert <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="free">val</span> <span class="free">k</span> <span class="main">=</span> Insert None <span class="free">val</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> min_k<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">k</span> <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ins</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">oid</span> <span class="main">#</span> fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> interp_ops_unfold_last
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv insert_spec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> interp_op.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_k assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nat</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> Suc <span class="skolem">nat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"make_insert <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="free">val</span> <span class="free">k</span> <span class="main">=</span>
      Insert <span class="main">(</span>Some <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>min <span class="skolem">nat</span> <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ins</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         insert_spec <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>min <span class="skolem">nat</span> <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fst_conv interp_op.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> interp_ops_unfold_last prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="skolem">nat</span> <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> min.strict_coboundedI2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interp_ops_distinct list_ops_def spec_ops_rem_last assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">list</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_spec_inc_length<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms insert_spec_nth_oid
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_1 <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">=</span> Suc <span class="skolem">nat</span>›</span></span> diff_Suc_1 length_greater_0_conv min_Suc_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Part 2 states that the list order relation must be transitive, irreflexive,
and total. These three properties are straightforward to prove, using our
definition of the \isa{list-order} predicate.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> list_order_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms list_order_trans list_ops_insertions list_order_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> list_order_irrefl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">ops</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">x</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> List_Spec.list_order_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms interp_ops_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> list_order_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∨</span> list_order <span class="free">ops</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ops_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">mid</span></span> <span class="skolem"><span class="skolem">suf</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">mid</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">suf</span> <span class="main">∨</span>
           fst <span class="main">(</span>interp_ops <span class="free">ops</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">mid</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">suf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_split_two_elems assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∨</span> list_order <span class="free">ops</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Interleaving">
<div class="head">
<h1>Theory Interleaving</h1>
</div>
<pre class="source"><span class="comment1">(* Martin Kleppmann, University of Cambridge
   Victor B. F. Gomes, University of Cambridge
   Dominic P. Mulligan, Arm Research, Cambridge
   Alastair Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Interleaving of concurrent insertions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we prove that our list specification rules out
interleaving of concurrent insertion sequences starting at the same position.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Interleaving
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Insert_Spec.html">Insert_Spec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about \isa{insert-ops}›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_fst_append1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">ops</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="bound">suf</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">suf</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> last_op_greatest snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">suf</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.IH snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH append.assoc insert_ops_def spec_ops_def snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> xi_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH last_op_greatest snoc.prems<span class="main">(</span>1<span class="main">)</span> x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">suf</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> xi_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suf</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dual_order.asym xi_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xi</span> <span class="main">≠</span> <span class="free">oid</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH map_fst_append1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">pre</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">oid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH x_pair<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_split_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xid</span><span class="main">,</span> <span class="free">xr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yid</span><span class="main">,</span> <span class="free">yr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xid</span> <span class="main">&lt;</span> <span class="free">yid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span> <span class="bound">bs</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">ops</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">xid</span><span class="main">,</span> <span class="free">xr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">yid</span><span class="main">,</span> <span class="free">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="bound">cs</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">xid</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="free">xid</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">yid</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="bound">cs</span><span class="main">)</span><span class="main">.</span> <span class="free">yid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">as1</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">xid</span><span class="main">,</span> <span class="free">xr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">as1</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">xid</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">as1</span><span class="main">)</span><span class="main">.</span> <span class="free">xid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms insert_ops_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">xid</span><span class="main">,</span> <span class="free">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">as1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="skolem">as1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> insert_ops_rem_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yid</span><span class="main">,</span> <span class="free">yr</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">as1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_split assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as1</span> <span class="main">=</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">yid</span><span class="main">,</span> <span class="free">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">bs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">yid</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">cs</span><span class="main">)</span><span class="main">.</span> <span class="free">yid</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms insert_ops_split <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">as1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">xid</span><span class="main">,</span> <span class="free">xr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">yid</span><span class="main">,</span> <span class="free">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">bs</span><span class="main">)</span><span class="main">.</span> <span class="free">xid</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">yid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_split y_split<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> x_split y_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_sorted_oids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">i2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc assms last_op_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> <span class="free">i2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_subset_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> last <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> last <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> last <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ys_nonempty<span class="main">:</span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mid</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">mid</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">l</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> append_butlast_last_id ys_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">li</span></span> <span class="skolem"><span class="skolem">lr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">li</span><span class="main">,</span> <span class="skolem">lr</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">mid</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">li</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_op_greatest Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation append_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">li</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> fst <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> last_op_greatest <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> fst <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> last <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems insert_ops_rem_cons ys_nonempty
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans last_ConsR set_ConsD set_subset_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_butlast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_append_butlast1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_butlastD map_butlast subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_append_butlast2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span> <span class="main">@</span> map fst <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">[]</span> <span class="main">@</span> map fst <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_butlast map_butlast<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_butlastD map_butlast subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">xs</span> <span class="main">@</span> map fst <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="skolem">xs</span> <span class="main">@</span> map fst <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about \isa{interp-ins}›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_maybe_grow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">∨</span>
         set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">oid</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ref</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> insert_spec_nonex insert_spec_set interp_ins_tail_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_maybe_grow2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">∨</span>
         set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms interp_ins_maybe_grow <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_maybe_grow3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc insert_ops_rem_last<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span> <span class="main">∧</span>
            set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc interp_ins_maybe_grow2 snoc.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH Un_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_ref_nonex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">ops</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nil.prems last_op_greatest <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> interp_ins_subset subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> append_Cons insert_ops_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snoc.IH snoc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 insert_ops_def spec_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
         set <span class="main">(</span>interp_ins <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interp_ins_maybe_grow2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_last_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_monotonic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">pre</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms interp_ins_maybe_grow3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_append_non_memb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">pre</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">suf</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 insert_spec_nonex interp_ins_tail_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc insert_ops_rem_last<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_ops_ref_older snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">&lt;</span> fst <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_ops_sorted_oids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_ins <span class="main">(</span><span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
        set <span class="main">(</span>interp_ins <span class="main">(</span><span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> append.assoc interp_ins_maybe_grow2 snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">oid</span> <span class="main">&lt;</span> fst <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_append_memb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">pre</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI append_assoc insert_spec_set interp_ins_monotonic
      interp_ins_tail_unfold singletonI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_append_forward<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> imageE prod.collapse set_map snoc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> split_list_last<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">&lt;</span> fst <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_ops_sorted_oids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">≠</span> fst <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.IH snoc.prems<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> inserted_item_ident
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc insert_ops_appendD interp_ins_tail_unfold prod.collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_ins_find_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> insert_ops_ref_older <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> interp_ins_subset subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> fst <span class="skolem">x</span> <span class="main">=</span> <span class="free">ref</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.exhaust_sel x_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_prop prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_prop x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>›</span></span> x_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 fst_conv min.strict_order_iff set_ConsD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_appendD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid</span> <span class="main">&lt;</span> <span class="free">ref</span>"</span></span> <span class="comment1">(* contradiction *)</span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_sorted_oids <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ref</span> <span class="main">&lt;</span> <span class="free">oid</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about \isa{list-order}›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">pre</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">suf</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff assms list_order_monotonic insert_ops_appendD set_append subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_insert_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ref</span> <span class="free">oid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">ops</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">ref</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">ref</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> insert_after_ref interp_ins_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ref</span> <span class="free">oid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> list_orderI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_insert_none<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">oid</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">ops</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">oid</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> list_orderI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_order_insert_between<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">ref</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">oid</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_spec <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">ops</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">ref</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms list_orderE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> interp_ins_distinct insert_ops_rem_last<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">oid</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_after_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">ref</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">oid</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="free">ops</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">oid</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> list_orderI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The \isa{insert-seq} predicate›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The predicate \isa{insert-seq start ops} is true iff \isa{ops} is a list
of insertion operations that begins by inserting after \isa{start}, and then
continues by placing each subsequent insertion directly after its predecessor.
This definition models the sequential insertion of text at a particular place
in a text document.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">insert_seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_seq</span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">start</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">insert_seq</span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">insert_seq</span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">prev</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insert_seq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">oid</span><span class="main">.</span> hd <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="free">start</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insert_seq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> append_self_conv2 hd_append2 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_rem_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms insert_seq.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_butlast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[</span>last <span class="free">xs</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_lessI add_0_left append_butlast_last_id append_eq_append_conv
        append_self_conv2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"butlast <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_butlast less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id insert_seq_rem_last<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_last_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">xi</span><span class="main">,</span> <span class="free">xr</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">yi</span><span class="main">,</span> <span class="free">yr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">yr</span> <span class="main">=</span> Some <span class="free">xi</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms insert_seq.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_start_none<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq None <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv append_is_Nil_conv insert_ops_appendD insert_seq_rem_last
        le_supE list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> set_append split_list<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_seq_hd snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_last_None<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oid</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_ins_monotonic snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> None<span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rest</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> snoc_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">rest</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> append_butlast_last_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">yr</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> yx_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">=</span> Some <span class="skolem">yi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_seq_last_ref snoc.prems<span class="main">(</span>2<span class="main">)</span> snoc_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_sorted_oids snoc_y yx_pairs snoc.prems<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_eq_append_conv2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> snoc_y yx_pairs <span class="quoted"><span class="quoted">‹<span class="skolem">xr</span> <span class="main">=</span> Some <span class="skolem">yi</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ops_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_split_2 <span class="quoted"><span class="quoted">‹<span class="skolem">yi</span> <span class="main">&lt;</span> <span class="skolem">xi</span>›</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH snoc_y yx_pairs<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ops_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> interp_ins_append_forward <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> interp_ins_append_memb ops_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ops_split<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH yx_pairs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_after_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="main">(</span>Some <span class="free">ref</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="free">ref</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="free">ref</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.IH snoc.prems insert_seq_rem_last insert_ops_appendD
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv Un_subset_iff empty_set equals0D set_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">ref</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> Some <span class="free">ref</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_seq_hd snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ref</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x_split <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">=</span> Some <span class="free">ref</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 prod.collapse snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ref</span><span class="main">,</span> <span class="skolem">rr</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> interp_ins_find_ref x_split <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">=</span> Some <span class="free">ref</span>›</span></span> assms<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_Cons append_self_conv2 prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_split <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">=</span> Some <span class="free">ref</span>›</span></span> append_Cons append_self_conv2 prod.collapse<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">cs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> calculation interp_ins_append_forward interp_ins_append_non_memb <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ref</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_order_insert_ref <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc insert_ops_appendD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation x_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_Cons_conv append_eq_append_conv2 append_self_conv2 prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">ref</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_order_append snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rest</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> snoc_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">rest</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> append_butlast_last_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">yr</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> yx_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">=</span> Some <span class="skolem">yi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_seq_last_ref snoc.prems<span class="main">(</span>2<span class="main">)</span> snoc_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_sorted_oids snoc_y yx_pairs snoc.prems<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_eq_append_conv2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> snoc_y yx_pairs <span class="quoted"><span class="quoted">‹<span class="skolem">xr</span> <span class="main">=</span> Some <span class="skolem">yi</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ops_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_split_2 <span class="quoted"><span class="quoted">‹<span class="skolem">yi</span> <span class="main">&lt;</span> <span class="skolem">xi</span>›</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">ref</span> <span class="skolem">yi</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH snoc_y yx_pairs<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">yi</span> <span class="skolem">xi</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ops_split snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">yi</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_ops_appendD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_order <span class="free">ops</span> <span class="free">ref</span> <span class="skolem">yi</span>›</span></span> list_order_memb2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> interp_ins_append_non_memb ops_split snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> list_order_insert_ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="skolem">yi</span> <span class="skolem">xi</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc list_order_append ops_split snoc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order <span class="free">ops</span> <span class="free">ref</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_order_trans snoc.prems<span class="main">(</span>1<span class="main">)</span> yx_pairs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="free">ref</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_seq_no_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="main">(</span>Some <span class="free">ref</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.IH snoc.prems insert_seq_rem_last insert_ops_appendD
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_is_Nil_conv le_sup_iff list.map_disc_iff set_append split_list_first<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> split_list last_in_set snoc_eq_iff_butlast subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_seq_hd snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="skolem">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_ins_monotonic snoc.prems<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_ref_nonex <span class="quoted"><span class="quoted">‹<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> xs_nonempty<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">yr</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">=</span> Some <span class="skolem">yi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_seq.cases snoc.prems<span class="main">(</span>2<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH calculation 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv fst_conv last_in_set last_map snoc_eq_iff_butlast<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="skolem">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs</span>›</span></span> interp_ins_monotonic snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_ins_ref_nonex snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ops</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">yr</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The proof of no interleaving›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_interleaving_ordered<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span>hd <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                                 <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ops</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ops</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="skolem">ops</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a_in_xs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="main">|</span> <span class="main">(</span>a_in_ys<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="main">|</span> <span class="main">(</span>neither<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> a_in_xs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>7<span class="main">)</span> DiffE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> a_in_xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_subset_last snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span>  list_order <span class="skolem">ops</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                                      <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst          <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span>  list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_seq_after_start <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">ops</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> snoc.prems
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 calculation insert_seq_hd interp_ins_append_non_memb list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> xs_longer<span class="main">:</span> False
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_fst subset_butlast<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_seq_butlast insert_seq_nonempty xs_longer <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> snoc.prems<span class="main">(</span>3<span class="main">)</span> insert_ops_appendD
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id insert_seq_nonempty<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> map fst <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> distinct_append_butlast1 snoc.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> hd <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_append2 insert_seq_nonempty snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hd <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span>hd <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snoc.prems<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="main">=</span> Some <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xid</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert_seq_hd snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">xid</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_in_set insert_ops_memb_ref_older insert_seq_nonempty snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snoc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xid</span> <span class="main">&lt;</span> fst <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> insert_seq_nonempty <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span>›</span></span> insert_seq_nonempty list.set_sel<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹hd <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> hd <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹insert_seq <span class="free">start</span> <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xid</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_zipE zip_map_fst_snd<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>3<span class="main">)</span> last_op_greatest <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> fst <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dual_order.asym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>10<span class="main">)</span> interp_ins_maybe_grow2 <span class="quoted"><span class="quoted">‹<span class="free">start</span> <span class="main">=</span> Some <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">ops</span>›</span></span> snoc.IH snoc.prems<span class="main">(</span>4<span class="main">)</span> snoc.prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> x_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">start</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span> distinct_map snoc.prems<span class="main">(</span>6<span class="main">)</span> snoc.prems<span class="main">(</span>8<span class="main">)</span> subset_butlast <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_seq_start_none <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">ops</span>›</span></span> snoc.prems 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> empty_iff empty_set
            insert_ops_rem_last insert_seq_butlast insert_seq_nonempty list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH list_order_memb2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> xs_a<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="keyword2"><span class="keyword">where</span></span> yi_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="free">start</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>tl <span class="skolem">ys</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_Cons_tl insert_seq_hd snoc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="free">start</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ops</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetCE<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ops</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">&lt;</span> fst <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> last_op_greatest <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">yi</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> yi_def xs_a fst_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snoc.prems<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> less_not_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_seq_nonempty snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> xs_longer<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> butlast_split<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span> insert_seq_butlast insert_seq_nonempty snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> ref_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>last <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x_exists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_in_set last_map map_is_Nil_conv snoc_eq_iff_butlast<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> butlast_split <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span> append.assoc append_butlast_last_id butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
            insert_seq_nonempty last_ConsL last_ConsR list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="main">(</span>last <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> insert_seq_last_ref <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_order_insert_ref ref_exists snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">y</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH butlast_split last_in_set last_map map_is_Nil_conv snoc_eq_iff_butlast<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_order_append snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_order_trans snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> map_fst_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">xs</span> <span class="main">=</span> map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> map fst <span class="main">[</span>last <span class="skolem">xs</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id insert_seq_nonempty map_append snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">start</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_seq_after_start <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">xs</span>›</span></span> map_fst_xs<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                                  <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> a_in_ys
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>6<span class="main">)</span> DiffE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> a_in_ys <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_subset_last snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>  list_order <span class="skolem">ops</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst          <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span>  list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                                      <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_seq_after_start <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">ops</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> snoc.prems
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 calculation insert_seq_hd interp_ins_append_non_memb list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> ys_longer<span class="main">:</span> False
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_fst subset_butlast<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert_seq_butlast insert_seq_nonempty ys_longer <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>›</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> snoc.prems<span class="main">(</span>5<span class="main">)</span> insert_ops_appendD
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id insert_seq_nonempty<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">xs</span> <span class="main">@</span> map fst <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> distinct_append_butlast2 snoc.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> hd <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_append2 insert_seq_nonempty snoc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hd <span class="skolem">xs</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span>hd <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snoc.prems<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="main">=</span> Some <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yid</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert_seq_hd snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">yid</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_in_set insert_ops_memb_ref_older insert_seq_nonempty snoc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> snoc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yid</span> <span class="main">&lt;</span> fst <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> insert_seq_nonempty <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span>›</span></span> insert_seq_nonempty list.set_sel<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹hd <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> hd <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹insert_seq <span class="free">start</span> <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yid</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_zipE zip_map_fst_snd<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>5<span class="main">)</span> last_op_greatest <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> fst <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dual_order.asym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>10<span class="main">)</span> interp_ins_maybe_grow2 <span class="quoted"><span class="quoted">‹<span class="free">start</span> <span class="main">=</span> Some <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">ops</span>›</span></span> snoc.IH snoc.prems<span class="main">(</span>2<span class="main">)</span> snoc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ys_a<span class="main">:</span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">start</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> insert_seq_start_none list_order_insert_none snoc.prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">ops</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> fst_conv insert_seq_hd list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ys_a<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="skolem">r</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>4<span class="main">)</span> list_order_insert_between
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv insert_seq_hd list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ys_a<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> ys_longer<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> butlast_split<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>›</span></span> insert_seq_butlast insert_seq_nonempty snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>›</span></span> append.assoc append_butlast_last_id butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
            insert_seq_nonempty last_ConsL last_ConsR list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snoc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="main">(</span>last <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>4<span class="main">)</span> insert_seq_last_ref <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH butlast_split last_in_set last_map map_is_Nil_conv snoc_eq_iff_butlast<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_order_insert_between snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> map_fst_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">ys</span> <span class="main">=</span> map fst <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> map fst <span class="main">[</span>last <span class="skolem">ys</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id insert_seq_nonempty map_append snoc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>butlast <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">start</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_seq_after_start <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> last <span class="skolem">ys</span>›</span></span> map_fst_xs<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                                  <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">ops</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>6<span class="main">)</span> snoc.prems<span class="main">(</span>7<span class="main">)</span> DiffE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert_seq_nonempty snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> xs_nonempty<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xsa</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="main">=</span> Some <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert_seq_hd xs_nonempty snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ops</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> xs_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">xi</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹insert_ops <span class="skolem">ops</span>›</span></span> insert_ops_memb_ref_older <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ops</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ops</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">&lt;</span> fst <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> last_op_greatest snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> order.asym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="skolem">ops</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>10<span class="main">)</span> interp_ins_maybe_grow2 <span class="quoted"><span class="quoted">‹<span class="free">start</span> <span class="main">=</span> Some <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                                   <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="skolem">ops</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems snoc.IH <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">ops</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                                  <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="main">(</span><span class="skolem">ops</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_order_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Consider an execution that contains two distinct insertion sequences,
\isa{xs} and \isa{ys}, that both begin at the same initial position \isa{start}.
We prove that, provided the starting element exists, the two insertion sequences
are not interleaved. That is, in the final list order, either all insertions by
\isa{xs} appear before all insertions by \isa{ys}, or vice versa.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> no_interleaving<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="free">start</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span> <span class="main">@</span> map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span>hd <span class="free">ys</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms no_interleaving_ordered <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hd <span class="free">ys</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>8<span class="main">)</span> insert_seq_nonempty distinct_fst_append
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> hd_in_set hd_map list.map_disc_iff map_append neqE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">ys</span> <span class="main">@</span> map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span> distinct_append_swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">start</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">.</span> list_order <span class="free">ops</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms no_interleaving_ordered <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For completeness, we also prove what happens if there are two insertion
sequences, \isa{xs} and \isa{ys}, but their initial position \isa{start} does
not exist. In that case, none of the insertions in \isa{xs} or \isa{ys} take
effect.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> missing_start_no_insertion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="main">(</span>Some <span class="free">start</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_seq <span class="main">(</span>Some <span class="free">start</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">ops</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> set <span class="main">(</span>interp_ins <span class="free">ops</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms insert_seq_no_start <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnE<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RGA">
<div class="head">
<h1>Theory RGA</h1>
</div>
<pre class="source"><span class="comment1">(* Martin Kleppmann, University of Cambridge
   Victor B. F. Gomes, University of Cambridge
   Dominic P. Mulligan, Arm Research, Cambridge
   Alastair Beresford, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹The Replicated Growable Array (RGA)›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The RGA algorithm \cite{Roh:2011dw} is a replicated list (or
collaborative text-editing) algorithm. In this section we prove that
RGA satisfies our list specification. The Isabelle/HOL definition of
RGA in this section is based on our prior work on formally verifying
CRDTs \cite{Gomes:2017gy,Gomes:2017vo}.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> RGA
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Insert_Spec.html">Insert_Spec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> list <span class="main">⇒</span> <span class="tfree">'oid</span> <span class="main">⇒</span> <span class="tfree">'oid</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_body</span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_body</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
               <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">insert_body</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_rga</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oid</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'oid</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_rga</span>  <span class="free"><span class="bound"><span class="entity">xs</span></span></span>      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> None<span class="main">)</span>   <span class="main">=</span> insert_body <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_rga</span>  <span class="main">[]</span>      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_rga</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span>
        <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> insert_body <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
      <span class="keyword1">else</span>
        <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">insert_rga</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_rga</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'oid</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_rga</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span> foldl insert_rga <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Commutativity of \isa{insert-rga}›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_set_ins <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">e</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_set_ins<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">oid</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_body <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e1</span><span class="main">)</span> <span class="free">e2</span> <span class="main">=</span> insert_body <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e2</span><span class="main">)</span> <span class="free">e1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_insert_body_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> Some <span class="free">e1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span>insert_body <span class="free">xs</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> insert_body <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="free">e1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_commutes<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_None_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> Some <span class="free">e1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e1</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> <span class="free">i2</span>  <span class="main">)</span> <span class="main">=</span>
         insert_rga <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> <span class="free">i2</span>  <span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">e1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_commutes<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_nonexistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> Some <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_Some_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">≠</span> <span class="free">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">≠</span> <span class="free">i1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e1</span><span class="main">,</span> Some <span class="free">i1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> Some <span class="free">i2</span><span class="main">)</span> <span class="main">=</span>
         insert_rga <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> Some <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">e1</span><span class="main">,</span> Some <span class="free">i1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">i1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">i2</span>"</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_commutes insert_rga_insert_body_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> Some <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> Some <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e1</span><span class="main">,</span> <span class="free">i1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span>
         insert_rga <span class="main">(</span>insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e2</span><span class="main">,</span> <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">e1</span><span class="main">,</span> <span class="free">i1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> insert_rga_None_commutes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> some_r1<span class="main">:</span> <span class="main">(</span>Some <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> insert_rga_None_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> some_r2<span class="main">:</span> <span class="main">(</span>Some <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="skolem">r2</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms some_r1 some_r2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_rga_Some_commutes<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms some_r1 some_r2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff insert_rga_nonexistent insert_rga_set_ins<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_body_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">s</span> <span class="main">∧</span> insert_body <span class="free">xs</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">∧</span> insert_body <span class="skolem">xs</span> <span class="free">e</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">s</span> <span class="main">∧</span> insert_body <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> insert_body <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">∧</span> insert_body <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_between_elements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">pre</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">suf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="free">pre</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">e</span> <span class="main">#</span> <span class="free">suf</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">pre</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">e</span> <span class="main">#</span> <span class="free">suf</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pre</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> pre_nil<span class="main">:</span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">ref</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems pre_nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">suf</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">pre'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="skolem">xs</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pre'</span> <span class="main">@</span> <span class="free">ref</span> <span class="main">#</span> <span class="free">e</span> <span class="main">#</span> <span class="free">suf</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> local.Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_after_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> <span class="free">a</span> <span class="main">≠</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_body <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> Some <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_rga_preserves_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="free">i</span> <span class="main">=</span> Some <span class="bound">i'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="bound">suf</span> <span class="main">∧</span> insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="bound">suf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="bound">suf</span> <span class="main">∧</span> insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="bound">suf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_body_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">bs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs</span> <span class="bound">ds</span><span class="main">.</span> <span class="skolem">bs</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">ds</span> <span class="main">∧</span> insert_body <span class="skolem">bs</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="bound">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_body_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">ds</span> <span class="main">∧</span> insert_body <span class="skolem">bs</span> <span class="free">e</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds</span> <span class="main">∧</span> insert_rga <span class="free">xs</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="free">e</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_rga_after_ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about the \isa{rga-ops} predicate›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rga_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'oid</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> <span class="main">×</span> <span class="tfree">'oid</span> option<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rga_ops</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">≡</span> crdt_ops <span class="free"><span class="bound"><span class="entity">list</span></span></span> set_option"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rga_ops_rem_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_rem_last rga_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> rga_ops_rem_penultimate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">r2</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">i1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> set_option"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_rem_penultimate rga_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i2</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rga_ops_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rga_ops_ref_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="free">suf</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">pre</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> Some <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="free">suf</span><span class="main">)</span> set_option"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rga_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_option <span class="main">(</span>Some <span class="free">ref</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">ref</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ref</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">pre</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crdt_ops_ref_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas about the \isa{interp-rga} function›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_rga_tail_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert_rga <span class="main">(</span>interp_rga <span class="main">(</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_rga_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_rga_ids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_rga <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_rga <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_rga_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_rga <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rga_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_rga <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xr</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH x_pair <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_rga_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_rga <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH rga_ops_ref_exists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_pair list.set_map snoc.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_rga <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">xi</span> <span class="main">(</span>set <span class="main">(</span>interp_rga <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_rga_set_ins interp_rga_tail_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>interp_rga <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_rga_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_rga <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_rga <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_rga_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_rga <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rga_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xi</span> <span class="main">∉</span> set <span class="main">(</span>interp_rga <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interp_rga_ids crdt_ops_unique_last rga_ops_rem_last
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rga_ops_def snoc.prems<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pre</span> <span class="bound">suf</span><span class="main">.</span> interp_rga <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">pre</span><span class="main">@</span><span class="bound">suf</span> <span class="main">∧</span>
           insert_rga <span class="main">(</span>interp_rga <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">=</span> <span class="bound">pre</span> <span class="main">@</span> <span class="skolem">xi</span> <span class="main">#</span> <span class="bound">suf</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> set_option <span class="skolem">xr</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> crdt_ops_ref_exists rga_ops_def snoc.prems x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">xr</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> option.set_sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">xr</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_rga <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_rga_ids rga_ops_rem_last snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH insert_rga_preserves_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>interp_rga <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff disjoint_insert<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_append 
        interp_rga_tail_unfold list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Proof that RGA satisfies the list specification›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> final_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="free">xs</span> <span class="main">=</span> interp_ins <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_ins <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms crdt_ops_distinct spec_ops_distinct rga_ops_def insert_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> oid_greatest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_rga <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_ops_id_inc x_pair insert_ops_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>interp_rga <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> interp_rga_ids rga_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_ins <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ref</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span>interp_rga <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">oid</span> <span class="main">#</span> interp_rga <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> oid_greatest hd_in_set insert_body.elims insert_body.simps<span class="main">(</span>1<span class="main">)</span>
        insert_rga.simps<span class="main">(</span>1<span class="main">)</span> list.sel<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_ins <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_ins_tail_unfold interp_rga_tail_unfold x_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> interp_rga <span class="free">xs</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="bound">bs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rga_ops_ref_exists x_pair<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span>interp_rga <span class="free">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> interp_rga_ids rga_ops_rem_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_rga <span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> interp_rga_distinct rga_ops_rem_last<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert_rga <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">oid</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> as_bs insert_between_elements oid_greatest<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_spec <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> Some <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">oid</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span>›</span></span> insert_after_ref<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_ins <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Some as_bs interp_ins_tail_unfold interp_rga_tail_unfold x_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_rga_reorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Some <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">suf</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">suf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="free">suf</span><span class="main">)</span> <span class="main">=</span> interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="free">suf</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">suf</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ref_not_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> fst <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">ref</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> fst <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_not_x<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rga_ops_rem_penultimate
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_eq_append_conv prod.collapse<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xi</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        insert_rga <span class="main">(</span>interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH interp_rga_tail_unfold <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> insert_rga <span class="main">(</span>insert_rga <span class="main">(</span>interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interp_rga_tail_unfold <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> insert_rga <span class="main">(</span>insert_rga <span class="main">(</span>interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xi</span><span class="main">,</span> <span class="skolem">xr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xrr</span><span class="main">.</span> <span class="skolem">xr</span> <span class="main">=</span> Some <span class="bound">xrr</span> <span class="main">⟹</span> <span class="bound">xrr</span> <span class="main">≠</span> <span class="free">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_pair snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_rga_commutes ref_not_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv x_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc interp_rga_tail_unfold x_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
                   interp_rga <span class="main">(</span><span class="free">pre</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">oid</span><span class="main">,</span> <span class="free">ref</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rga_spec_equal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert_ops <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="free">xs</span> <span class="main">=</span> interp_rga <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_rga_def interp_ins_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_in_set snoc_eq_iff_butlast<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">suf</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"interp_ins <span class="skolem">xs</span> <span class="main">=</span> interp_rga <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> set_option"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> set_option"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rga_ops_def snoc.prems<span class="main">(</span>3<span class="main">)</span> ys_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span> set_option"</span></span>
        <span class="keyword1"><span class="command">using</span></span> crdt_ops_rem_spec snoc.prems ys_split insert_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rga_ops_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_set_rem_last crdt_ops_distinct insert_ops_def rga_ops_def
          snoc.prems spec_ops_distinct ys_split<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_ops_rem_last ys_split snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_rga<span class="main">:</span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"crdt_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> set_option"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems ys_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crdt_ops_reorder_spec insert_ops_def rga_ops_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rga_ops_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_rga <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>1<span class="main">)</span> ys_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH snoc.prems<span class="main">(</span>2<span class="main">)</span> valid_rga final_insert append_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> interp_rga <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">oid</span><span class="main">,</span> <span class="skolem">ref</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">op2</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">suf</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> set_option <span class="bound">op2</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crdt_ops_independent_suf insert_ops_def rga_ops_def x_pair ys_split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Some <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">suf</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">oid</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">ref</span> <span class="main">=</span> Some <span class="bound">r</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">suf</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> crdt_ops_no_future_ref snoc.prems<span class="main">(</span>3<span class="main">)</span> x_pair ys_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.set_intros rga_ops_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"interp_rga <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="skolem">suf</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_rga <span class="main">(</span><span class="skolem">pre</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">suf</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interp_rga_reorder valid_rga x_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"interp_ins <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> interp_rga <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ys_split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_ops_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="bound">ys</span> <span class="main">∧</span> insert_ops <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crdt_ops_spec_ops_exist insert_ops_def rga_ops_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> rga_meets_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rga_ops <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∧</span> insert_ops <span class="bound">ys</span> <span class="main">∧</span> interp_ins <span class="bound">ys</span> <span class="main">=</span> interp_rga <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms rga_spec_equal insert_ops_exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>