<div id="Density_Predicates">
<div class="head">
<h1>Theory Density_Predicates</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: Density_Predicates.thy
  Authors: Manuel Eberl
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Density Predicates›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Density_Predicates
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probability Densities›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_subprob_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> measure <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_subprob_density</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∈</span> borel_measurable <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∧</span> space <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
                           <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>space <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>

<span class="keyword1" id="Density_Predicates-is_subprob_densityI"><span class="command">lemma</span></span> is_subprob_densityI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">M</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">;</span> space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">⟧</span>
        <span class="main">⟹</span> is_subprob_density <span class="free">M</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Density_Predicates-is_subprob_densityD"><span class="command">lemma</span></span> is_subprob_densityD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_subprob_density <span class="free">M</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_subprob_density <span class="free">M</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_subprob_density <span class="free">M</span> <span class="free">f</span> <span class="main">⟹</span> space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_subprob_density <span class="free">M</span> <span class="free">f</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Measure spaces with densities›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> measure <span class="main">⇒</span> <span class="tfree">'a</span> measure <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_density</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∈</span> borel_measurable <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">∧</span> space <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> density <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="Density_Predicates-has_densityI"><span class="command">lemma</span></span> has_densityI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">N</span><span class="main">;</span> <span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span><span class="main">;</span> space <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Density_Predicates-has_densityD"><span class="command">lemma</span></span> has_densityD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"space <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> has_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>


<span class="keyword1" id="Density_Predicates-has_density_sets"><span class="command">lemma</span></span> has_density_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">⟹</span> sets <span class="free">M</span> <span class="main">=</span> sets <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Density_Predicates-has_density_space"><span class="command">lemma</span></span> has_density_space<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">⟹</span> space <span class="free">M</span> <span class="main">=</span> space <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Density_Predicates-has_density_emeasure"><span class="command">lemma</span></span> has_density_emeasure<span class="main">:</span>
    <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> sets <span class="free">M</span> <span class="main">⟹</span> emeasure <span class="free">M</span> <span class="free">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-nn_integral_cong'"><span class="command">lemma</span></span> nn_integral_cong'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="keyword1">=simp=&gt;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp_implies_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_density_emeasure_space"><span class="command">lemma</span></span> has_density_emeasure_space<span class="main">:</span>
    <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">⟹</span> emeasure <span class="free">M</span> <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_emeasure<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_space <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong'<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_density_emeasure_space'"><span class="command">lemma</span></span> has_density_emeasure_space'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">⟹</span> emeasure <span class="main">(</span>density <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>density <span class="free">N</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> has_densityD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_emeasure_space<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_density_imp_is_subprob_density"><span class="command">lemma</span></span> has_density_imp_is_subprob_density<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">;</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">⟧</span> <span class="main">⟹</span> is_subprob_density <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_density_imp_is_subprob_density'"><span class="command">lemma</span></span> has_density_imp_is_subprob_density'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">;</span> prob_space <span class="free">M</span><span class="main">⟧</span> <span class="main">⟹</span> is_subprob_density <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_density_imp_is_subprob_density <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prob_space.emeasure_space_1
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_density_emeasure_space<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_density_equal_on_space"><span class="command">lemma</span></span> has_density_equal_on_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> density_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"space <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-has_density_cong"><span class="command">lemma</span></span> has_density_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">=</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> has_density_equal_on_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Density_Predicates-has_density_dens_AE"><span class="command">lemma</span></span> has_density_dens_AE<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="free">N</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">y</span><span class="main">;</span> <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="free">N</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">;</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">⟧</span>
        <span class="main">⟹</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> density_cong<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probability spaces with densities›</span></span>

<span class="keyword1" id="Density_Predicates-is_subprob_density_imp_has_density"><span class="command">lemma</span></span> is_subprob_density_imp_has_density<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_subprob_density <span class="free">N</span> <span class="free">f</span><span class="main">;</span> <span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span><span class="main">⟧</span> <span class="main">⟹</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_imp_subprob_space'"><span class="command">lemma</span></span> has_subprob_density_imp_subprob_space'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">;</span> is_subprob_density <span class="free">N</span> <span class="free">f</span><span class="main">⟧</span> <span class="main">⟹</span> subprob_space <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_spaceI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">...</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_emeasure_space <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_imp_subprob_space"><span class="command">lemma</span></span> has_subprob_density_imp_subprob_space<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_subprob_density <span class="free">M</span> <span class="free">f</span> <span class="main">⟹</span> subprob_space <span class="main">(</span>density <span class="free">M</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_density_imp_subprob_space'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">has_subprob_density</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> has_density <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> subprob_space <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Density_Predicates-subprob_space_density_not_empty"><span class="command">lemma</span></span> subprob_space_density_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>density <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> space_density<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> subprob_space.subprob_not_empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Density_Predicates-has_subprob_densityI"><span class="command">lemma</span></span> has_subprob_densityI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">N</span><span class="main">;</span> <span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span><span class="main">;</span> subprob_space <span class="free">M</span><span class="main">⟧</span> <span class="main">⟹</span> has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subprob_space_density_not_empty<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_subprob_densityI'"><span class="command">lemma</span></span> has_subprob_densityI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"space <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> D <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subprob_spaceI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_density_emeasure_space emeasure_density
             <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-has_subprob_densityD"><span class="command">lemma</span></span> has_subprob_densityD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_measurable"><span class="command">lemma</span></span> has_subprob_density_measurable<span class="main">[</span><span class="operator">measurable_dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_imp_has_density"><span class="command">lemma</span></span> has_subprob_density_imp_has_density<span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">⟹</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_subprob_density_def<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_equal_on_space"><span class="command">lemma</span></span> has_subprob_density_equal_on_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_density_equal_on_space<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_cong"><span class="command">lemma</span></span> has_subprob_density_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">=</span> has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> has_subprob_density_equal_on_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_dens_AE"><span class="command">lemma</span></span> has_subprob_density_dens_AE<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="free">N</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">y</span><span class="main">;</span> <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="free">N</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">;</span> has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">⟧</span>
      <span class="main">⟹</span> has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_dens_AE<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parametrized probability densities›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_parametrized_subprob_density</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> space <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> has_subprob_density <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> case_prod <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Density_Predicates-has_parametrized_subprob_densityI"><span class="command">lemma</span></span> has_parametrized_subprob_densityI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">N</span> <span class="bound">x</span> <span class="main">=</span> density <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> subprob_space <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">R</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ballI conjI has_subprob_densityI<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Density_Predicates-has_parametrized_subprob_densityD"><span class="command">lemma</span></span> has_parametrized_subprob_densityD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">R</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">N</span> <span class="bound">x</span> <span class="main">=</span> density <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> subprob_space <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">measurable_dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_parametrized_subprob_density_integral"><span class="command">lemma</span></span> has_parametrized_subprob_density_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">R</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">R</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">R</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_density <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">N</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">...</span> <span class="main">(</span>space <span class="main">...</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subprob_space.emeasure_space_le_1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-has_parametrized_subprob_density_cong"><span class="command">lemma</span></span> has_parametrized_subprob_density_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">N</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">N'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">R</span> <span class="free">f</span> <span class="main">=</span> has_parametrized_subprob_density <span class="free">M</span> <span class="free">N'</span> <span class="free">R</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Density_Predicates-has_parametrized_subprob_density_dens_AE"><span class="command">lemma</span></span> has_parametrized_subprob_density_dens_AE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="free">R</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
          <span class="quoted"><span class="quoted">"case_prod <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">R</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">R</span> <span class="free">f'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span><span class="free">N</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> space <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="free">N</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> has_subprob_density_dens_AE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_density_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Density in the Giry monad›</span></span>

<span class="keyword1" id="Density_Predicates-emeasure_bind_density"><span class="command">lemma</span></span> emeasure_bind_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> has_density <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> sets <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span> <span class="main">∂</span><span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">X</span> <span class="main">∂</span><span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_bind<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span> <span class="main">∂</span><span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_density_emeasure sets_kernel<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-bind_density"><span class="command">lemma</span></span> bind_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">N</span>"</span></span>
          <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> has_density <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> density <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> sfN<span class="main">:</span> sigma_finite_measure <span class="quoted"><span class="free">N</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> sfNM<span class="main">:</span> pair_sigma_finite <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pair_sigma_finite_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sets_bind<span class="main">[</span><span class="operator">OF</span> sets_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span> <span class="main">∂</span><span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_bind_density<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sfNM.Fubini'<span class="main">)</span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> space <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> case_prod <span class="free">g</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> space <span class="free">N</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> measurable_Pair2'<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong nn_integral_multc<span class="main">)</span>  <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_density<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sfN.borel_measurable_nn_integral<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Density_Predicates-bind_has_density"><span class="command">lemma</span></span> bind_has_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">N</span>"</span></span>
          <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> has_density <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"case_prod <span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> borel_measurable_nn_integral<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_pair_swap_iff<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> density <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_density<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"space <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-bind_has_density'"><span class="command">lemma</span></span> bind_has_density'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sfM<span class="main">:</span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sfR<span class="main">:</span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dens_M<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">δM</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dens_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> has_density <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="free">δf</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Mδf<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">δf</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">N</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">N</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δM</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> dens_M <span class="keyword1"><span class="command">have</span></span> M_M<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens_M <span class="keyword1"><span class="command">have</span></span> M_MR<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> measurable <span class="main">(</span><span class="free">N</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets sets_pair_measure_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δf</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bind_has_density<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms M_MR M_M<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> space <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δf</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> case_prod <span class="free">δf</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Mδf<span class="main"><span class="main">]</span></span> measurable_Pair2' A<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> M_δf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δf</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">from</span></span> dens_M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">δM</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dens_M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δf</span> <span class="bound">x</span> <span class="skolem">y</span> <span class="main">∂</span><span class="main">...</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δM</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="skolem">y</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_density<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_δf'<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δf</span> <span class="bound">x</span> <span class="skolem">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δM</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="skolem">y</span> <span class="main">∂</span><span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δM</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_density_equal_on_space<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-bind_has_subprob_density"><span class="command">lemma</span></span> bind_has_subprob_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">N</span>"</span></span>
          <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> has_density <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"case_prod <span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_has_density<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subprob_space_imp_sigma_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_bind<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-bind_has_subprob_density'"><span class="command">lemma</span></span> bind_has_subprob_density'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">δM</span>"</span></span> <span class="quoted"><span class="quoted">"space <span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">R</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> has_subprob_density <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="free">δf</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"case_prod <span class="free">δf</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">N</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">N</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δM</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.subprob_not_empty has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δM</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_has_density' has_densityI<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subprob_space_imp_sigma_finite <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_bind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-null_measure_has_subprob_density"><span class="command">lemma</span></span> null_measure_has_subprob_density<span class="main">:</span>
  <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> has_subprob_density <span class="main">(</span>null_measure <span class="free">M</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_densityI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> null_measure_eq_density <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subprob_space_null_measure_iff<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-emeasure_has_parametrized_subprob_density"><span class="command">lemma</span></span> emeasure_has_parametrized_subprob_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">R</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> sets <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">N</span> <span class="free">x</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> has_parametrized_subprob_densityD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> borel_measurable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="free">x</span> <span class="main">=</span> density <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_parametrized_subprob_densityD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Mf <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">...</span> <span class="free">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_density<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-emeasure_count_space_density_singleton"><span class="command">lemma</span></span> emeasure_count_space_density_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> has_densityD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="bound">y</span> <span class="main">∂</span>count_space <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M emeasure_density<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_indicator_singleton<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-subprob_count_space_density_le_1"><span class="command">lemma</span></span> subprob_count_space_density_le_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> subprob_space <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_count_space_density_singleton<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_subprob_density_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_emeasure_le_1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_density_embed_measure"><span class="command">lemma</span></span> has_density_embed_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>embed_measure <span class="free">M</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span><span class="main">)</span> <span class="main">⟷</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">δ</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?M'</span> <span class="var">?N'</span> <span class="var">?δ'</span> <span class="main">⟷</span> has_density <span class="free">M</span> <span class="free">N</span> <span class="free">δ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="var">?M'</span> <span class="var">?N'</span> <span class="var">?δ'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"space <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> Mδf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="var">?N'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> Mδf'f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> measurable_comp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> measurable_embed_measure2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> Mδ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> measurable_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"embed_measure <span class="free">M</span> <span class="free">f</span> <span class="main">=</span> density <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> embed_measure <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> density_embed_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj Mδf'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density <span class="free">N</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> density_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mδf'f Mδ<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_measure_eq_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="free">N</span> <span class="free">δ</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?M'</span> <span class="var">?N'</span> <span class="var">?δ'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"space <span class="var">?N'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> Mf'f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">N</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> Mδ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∈</span> borel_measurable <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Mf'f <span class="keyword2"><span class="keyword">and</span></span> dens <span class="keyword3"><span class="command">show</span></span> Mδf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_comp<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> measurable_embed_measure1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> has_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"embed_measure <span class="free">M</span> <span class="free">f</span> <span class="main">=</span> embed_measure <span class="main">(</span>density <span class="free">N</span> <span class="free">δ</span><span class="main">)</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> measurable_comp<span class="main">[</span><span class="operator">OF</span> Mf'f Mδ<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density <span class="free">N</span> <span class="free">δ</span> <span class="main">=</span> density <span class="free">N</span> <span class="main">(</span><span class="var">?δ'</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> density_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mδ<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"embed_measure <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="var">?δ'</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> density <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> density_embed_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj Mδf'<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"embed_measure <span class="free">M</span> <span class="free">f</span> <span class="main">=</span> density <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-has_density_embed_measure'"><span class="command">lemma</span></span> has_density_embed_measure'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> has_density <span class="free">M</span> <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sets'<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>embed_measure <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_embed_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Mff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">N</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> inv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sets_eq_imp_space_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure inv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>embed_measure <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl _ inv'<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_embed_measure inj sets_M<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> embed_measure <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> embed_measure_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> distr_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl sets'<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_embed_measure2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_embed_measure1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Mff'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> distr_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> embed_measure <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> M<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> has_density_embed_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj inv<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure inv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_density_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Density_Predicates-has_density_embed_measure''"><span class="command">lemma</span></span> has_density_embed_measure''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> has_density_embed_measure'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>

<span class="keyword1" id="Density_Predicates-has_subprob_density_embed_measure''"><span class="command">lemma</span></span> has_subprob_density_embed_measure''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_embed_measure'' has_subprob_density_imp_has_density<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">N</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> measurable_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>embed_measure <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def has_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.subprob_space_distr has_subprob_densityD<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M space_embed_measure <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_embed_measure1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PDF_Transformations">
<div class="head">
<h1>Theory PDF_Transformations</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Transformations.thy
  Author: Manuel Eberl

  Provides lemmas for transformations of measure spaces with a density.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Measure Space Transformations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Transformations
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Density_Predicates.html">Density_Predicates</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="PDF_Transformations-not_top_le_1_ennreal"><span class="command">lemma</span></span> not_top_le_1_ennreal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> top <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>ennreal<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> top_unique<span class="main">)</span>

<span class="keyword1" id="PDF_Transformations-range_int"><span class="command">lemma</span></span> range_int<span class="main">:</span> <span class="quoted"><span class="quoted">"range int <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> range int"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Transformations-range_exp"><span class="command">lemma</span></span> range_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>exp <span class="main">::</span> real <span class="main">⇒</span> real<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> exp <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range exp"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Transformations-Int_stable_Icc"><span class="command">lemma</span></span> Int_stable_Icc<span class="main">:</span> <span class="quoted"><span class="quoted">"Int_stable <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span> <span class="main">..</span> <span class="bound">b</span><span class="main">::</span>real<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_stable_def<span class="main">)</span>

<span class="keyword1" id="PDF_Transformations-distr_mult_real"><span class="command">lemma</span></span> distr_mult_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> lborel <span class="main">(</span><span class="free">f</span> <span class="main">::</span> real <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span><span class="main">(*)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span>abs <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?M'</span> <span class="main">_</span> <span class="var">?f'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density lborel <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>density lborel <span class="free">f</span><span class="main">)</span> borel <span class="main">(</span><span class="main">(*)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> density lborel <span class="var">?f'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>distr <span class="main">(</span>density lborel <span class="free">f</span><span class="main">)</span> borel <span class="main">(</span><span class="main">(*)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> emeasure_density<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_sets_borel nn_integral_cong
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="var">?f'</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">x</span> <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lborel_distr_mult'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"inverse <span class="free"><span class="free">c</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_density<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_distr <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_density<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> borel <span class="main">(</span><span class="main">(*)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> density lborel <span class="var">?f'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>

<span class="keyword1" id="PDF_Transformations-distr_uminus_real"><span class="command">lemma</span></span> distr_uminus_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> lborel <span class="main">(</span><span class="free">f</span> <span class="main">::</span> real <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> borel uminus<span class="main">)</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span><span class="main">(*)</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> lborel
                       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span>abs <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_mult_real<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>uminus <span class="main">::</span> real <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span>abs <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_ennreal_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Transformations-distr_plus_real"><span class="command">lemma</span></span> distr_plus_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> lborel <span class="main">(</span><span class="free">f</span> <span class="main">::</span> real <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density lborel <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>density lborel <span class="free">f</span><span class="main">)</span> borel <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> density lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>distr <span class="main">(</span>density lborel <span class="free">f</span><span class="main">)</span> borel <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> emeasure_density<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_sets_borel nn_integral_cong
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">x</span> <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lborel_distr_plus<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="free"><span class="free"><span class="free">c</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nn_integral_distr<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_density<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_density <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> borel_measurable_diff Mf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> borel <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> density lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>

<span class="keyword1" id="PDF_Transformations-count_space_uminus"><span class="command">lemma</span></span> count_space_uminus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count_space UNIV <span class="main">=</span> distr <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>uminus <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ring <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> distr_bij_count_space<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>uminus <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> o_bij<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">uminus</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Transformations-count_space_plus"><span class="command">lemma</span></span> count_space_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count_space UNIV <span class="main">=</span> distr <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ring<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distr_bij_count_space <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Transformations-distr_uminus_ring_count_space"><span class="command">lemma</span></span> distr_uminus_ring_count_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">_</span> <span class="main">::</span> ring <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> uminus<span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> uminus <span class="main">=</span>
               density <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>distr <span class="main">(</span>density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> uminus<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> emeasure_density<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_sets_borel nn_integral_cong
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> count_space_uminus<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_distr emeasure_density<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> uminus <span class="main">=</span> density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>

<span class="keyword1" id="PDF_Transformations-distr_plus_ring_count_space"><span class="command">lemma</span></span> distr_plus_ring_count_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">_</span> <span class="main">::</span> ring <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span>
               density <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>distr <span class="main">(</span>density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> emeasure_density<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_sets_borel nn_integral_cong
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> count_space_plus<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="free"><span class="free"><span class="free">c</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_distr emeasure_density<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> density <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>


<span class="keyword1" id="PDF_Transformations-subprob_density_distr_real_eq"><span class="command">lemma</span></span> subprob_density_distr_real_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> lborel <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> measure_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span> emeasure <span class="main">(</span>distr <span class="main">(</span>density lborel <span class="free">f</span><span class="main">)</span> lborel <span class="free">h</span><span class="main">)</span> <span class="main">{</span><span class="bound">a</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span> <span class="main">=</span>
                          emeasure <span class="main">(</span>density lborel <span class="free">g</span><span class="main">)</span> <span class="main">{</span><span class="bound">a</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span><span class="free">h</span> <span class="main">::</span> real <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> lborel <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_densityI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets borel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> meas_M<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable borel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Mh <span class="keyword2"><span class="keyword">and</span></span> dens <span class="keyword3"><span class="command">show</span></span> subprob_space<span class="main">:</span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>distr <span class="free">M</span> borel <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.subprob_space_distr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> borel <span class="free">h</span> <span class="main">=</span> density lborel <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI_generator_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Int_stable_Icc<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">UNIV</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> abs <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reals_Archimedean2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span>real <span class="bound">n</span><span class="main">..</span>real <span class="bound">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">{</span><span class="main">-</span>real <span class="bound">i</span><span class="main">..</span>real <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">from</span></span> subprob_space <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> borel <span class="free">h</span><span class="main">)</span> <span class="main">{</span><span class="main">-</span>real <span class="skolem">i</span><span class="main">..</span>real <span class="skolem">i</span><span class="main">}</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.subprob_emeasure_le_1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> borel <span class="free">h</span><span class="main">)</span> <span class="main">{</span><span class="main">-</span> real <span class="skolem">i</span><span class="main">..</span>real <span class="skolem">i</span><span class="main">}</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> dens <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> lborel <span class="free">h</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span>density lborel <span class="free">g</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measure_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> lborel <span class="free">h</span> <span class="main">=</span> distr <span class="free">M</span> borel <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distr_cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> borel <span class="free">h</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span>density lborel <span class="free">g</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> borel_eq_atLeastAtMost<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PDF_Transformations-subprob_density_distr_real_exp"><span class="command">lemma</span></span> subprob_density_distr_real_exp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> lborel <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> borel exp<span class="main">)</span> lborel
           <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
           <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">_</span> <span class="main">_</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_density_distr_real_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable borel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span>inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">::</span> real <span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>density lborel <span class="free">f</span><span class="main">)</span> lborel exp"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?M2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"density lborel <span class="var">?g</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LIMSEQ_inverse_real_of_nat<span class="main"><span class="main">]</span></span><span class="main">)</span>
                     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> always_eventually less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?C</span> <span class="main">∪</span> <span class="var">?D</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> not_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> dual_order.strict_trans1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="var">?M1</span> <span class="var">?C</span> <span class="main">+</span> emeasure <span class="var">?M1</span> <span class="var">?D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> decomp<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> plus_emeasure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?C</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nn_integral_0_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_emeasure_incseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incseq_def max_def not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>Suc <span class="improper">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> True<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>max <span class="var">?a</span> <span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">=</span> <span class="var">?F</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?E</span> <span class="main">=</span> emeasure <span class="var">?M1</span> <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_mono_on ln <span class="main">{</span>max <span class="main">(</span>inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ln_less_cancel_iff<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> True dens
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?F</span> <span class="main">=</span> emeasure <span class="main">(</span>density lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="var">?F</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_density_distr_interval<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mf not_less not_le range_exp <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> DERIV_ln continuous_on_inverse continuous_on_id <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> A<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>density lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="var">?E</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="var">?E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> emeasure_density<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_emeasure_incseq<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incseq_def max_def not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M2</span> <span class="var">?C</span> <span class="main">+</span> emeasure <span class="var">?M2</span> <span class="var">?D</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?C</span> <span class="main">∪</span> <span class="var">?D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> plus_emeasure<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> decomp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> dens<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="PDF_Transformations-subprob_density_distr_real_inverse_aux"><span class="command">lemma</span></span> subprob_density_distr_real_inverse_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> lborel <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> lborel
              <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">_</span> <span class="main">_</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_density_distr_real_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> Mg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">∈</span> borel_measurable borel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

  <span class="keyword1"><span class="command">have</span></span> surj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> inverse <span class="bound">x</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> surjI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> inverse <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{..</span><span class="main">-</span>inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">::</span> real<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="var"><span class="quoted"><span class="var">?A2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span>inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">::</span> real <span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>density lborel <span class="free">f</span><span class="main">)</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> inverse <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?M2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"density lborel <span class="var">?g</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inv_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> not_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> dual_order.strict_trans1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≥</span> inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LIMSEQ_inverse_real_of_nat<span class="main"><span class="main">]</span></span><span class="main">)</span>
                      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> always_eventually less_imp_le <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A2</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">-</span>inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">-</span>inverse <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_upperbound<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> always_eventually less_imp_le LIMSEQ_inverse_real_of_nat_add_minus <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A1</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_minus_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A1</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A2</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> B<span class="main">)</span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> UN_Int_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">∩</span> <span class="bound">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?C</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?D</span> <span class="main">∪</span> <span class="var">?E</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Int_UNIV_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> C Int_Un_distrib2 UN_Int_distrib<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="var">?M1</span> <span class="var">?D</span> <span class="main">+</span> emeasure <span class="var">?M1</span> <span class="var">?E</span> <span class="main">+</span> emeasure <span class="var">?M1</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> decomp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> plus_emeasure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> plus_emeasure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le le_minus_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> inverse <span class="bound">x</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span> <span class="main">::</span> real<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?C</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_density Mf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M2</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> order.antisym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> order.trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> emeasure_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_emeasure_incseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incseq_def max_def not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">-</span>inverse <span class="main">(</span>Suc <span class="improper">i</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> True<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span>inverse <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">-</span>inverse <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A1</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span>min <span class="var">?a</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">=</span> <span class="var">?G</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?F</span> <span class="main">=</span> emeasure <span class="var">?M1</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_mono_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span>min <span class="var">?a</span> <span class="skolem">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_onI<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_minus_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> True dens
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?G</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="var">?G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_density_distr_interval<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mf not_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD inv_le
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> continuous_on_mult continuous_on_inverse continuous_on_id<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> A<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A1</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A1</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A1</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_emeasure_incseq<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incseq_def max_def not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_emeasure_incseq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incseq_def max_def not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>Suc <span class="improper">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> True<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A2</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>max <span class="var">?a</span> <span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">=</span> <span class="var">?G</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?F</span> <span class="main">=</span> emeasure <span class="var">?M1</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_mono_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="main">{</span>max <span class="var">?a</span> <span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_onI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> True dens
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="var">?G</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="var">?G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_density_distr_interval<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mf not_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD inv_le
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> continuous_on_mult continuous_on_inverse continuous_on_id<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> A<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A2</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A2</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M1</span> <span class="main">(</span><span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">i</span><span class="main">.</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?A2</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_emeasure_incseq<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incseq_def max_def not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M2</span> <span class="var">?D</span> <span class="main">+</span> emeasure <span class="var">?M2</span> <span class="var">?E</span> <span class="main">+</span> emeasure <span class="var">?M2</span> <span class="var">?C</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> decomp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> plus_emeasure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le le_minus_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> plus_emeasure<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_le <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le le_minus_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Transformations-subprob_density_distr_real_inverse"><span class="command">lemma</span></span> subprob_density_distr_real_inverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> lborel <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> borel inverse<span class="main">)</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> prob<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> lborel <span class="var">?g'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_density_distr_real_inverse_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets borel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable borel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prob <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> lborel
                 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> distr_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> distr_uminus_real<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> borel inverse<span class="main">)</span> lborel
              <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distr_distr o_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> distr_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>distr <span class="free">M</span> borel inverse<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.subprob_space_distr has_subprob_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Transformations-distr_convolution_real"><span class="command">lemma</span></span> distr_convolution_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> lborel <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?M'</span> <span class="main">_</span> <span class="var">?f'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> has_densityD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> Mf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">∈</span> borel_measurable lborel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets borel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sets_eq_imp_space_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sets_M <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable borel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> M_add<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="main">(+)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="main">::</span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> measure<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> borel_prod<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> borel <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span> <span class="main">=</span> density lborel <span class="var">?f'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_add emeasure_distr<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="bound">z</span> <span class="main">∂</span><span class="main">(</span>lborel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density has_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span>
                     measurable_sets_borel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M_add<span class="main"><span class="main">]</span></span> lborel_prod<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∂</span>lborel <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lborel.nn_integral_fst<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> borel_prod<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span>
                          <span class="main">∂</span>distr lborel borel <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> lborel_distr_plus<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span>
                          <span class="main">∂</span>lborel <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_distr<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> space_count_space<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">z</span> <span class="main">∂</span>lborel <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">z</span> <span class="main">∂</span>lborel <span class="main">∂</span>lborel"</span></span> <span class="keyword1"><span class="command">using</span></span> X
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lborel_pair.Fubini'<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_sigma_finite_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">z</span> <span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>density lborel <span class="var">?f'</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span>density lborel <span class="var">?f'</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Transformations-distr_convolution_ring_count_space"><span class="command">lemma</span></span> distr_convolution_ring_count_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"countable <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ring<span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?M'</span> <span class="main">_</span> <span class="var">?f'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?CS</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space UNIV <span class="main">::</span> <span class="tfree">'a</span> measure"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?CSP</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> measure"</span></span>
  <span class="keyword3"><span class="command">show</span></span> Mf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="var">?CS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_M<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="var"><span class="quoted"><span class="var">?CS</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sigma_finite_measure_count_space_countable<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> <span class="var">?CS</span> <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span> <span class="main">=</span> density <span class="var">?CS</span> <span class="var">?f'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>distr <span class="free">M</span> <span class="var">?CS</span> <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> <span class="var">?CS</span> <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_distr<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="bound">z</span> <span class="main">∂</span><span class="main">(</span><span class="var">?CS</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="var">?CS</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density has_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main">]</span></span>
                     sets_M pair_measure_countable C<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∂</span><span class="var">?CS</span> <span class="main">∂</span><span class="var">?CS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_fst<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_measure_countable C<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span>
                          <span class="main">∂</span>distr <span class="var">?CS</span> <span class="var">?CS</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="var">?CS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> count_space_plus<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">∂</span><span class="var">?CS</span> <span class="main">∂</span><span class="var">?CS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_distr<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">z</span> <span class="main">∂</span><span class="var">?CS</span> <span class="main">∂</span><span class="var">?CS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">z</span> <span class="main">∂</span><span class="var">?CS</span> <span class="main">∂</span><span class="var">?CS</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pair_sigma_finite.Fubini'<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_sigma_finite_def sigma_finite_measure_count_space_countable
                        C pair_measure_countable<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">∂</span><span class="var">?CS</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">z</span> <span class="main">∂</span><span class="var">?CS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="var">?CS</span> <span class="var">?f'</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> <span class="var">?CS</span> <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="var">?CS</span> <span class="var">?f'</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PDF_Values">
<div class="head">
<h1>Theory PDF_Values</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Values.thy
  Author: Manuel Eberl

  Defines the values and types in the PDF language and the corresponding stock measure spaces.
  Additionally, some functions and lemmas for lifting functions on the HOL types (int, real, …)
  to PDF values are provided.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Source Language Values›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Values
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Density_Predicates.html">Density_Predicates</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Values and stock measures›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pdf_type <span class="main">=</span>  UNIT <span class="main">|</span> BOOL <span class="main">|</span> INTEG <span class="main">|</span> REAL <span class="main">|</span> PRODUCT <span class="quoted">pdf_type</span> <span class="quoted">pdf_type</span>

<span class="keyword1"><span class="command">datatype</span></span> val <span class="main">=</span> UnitVal
  <span class="main">|</span> BoolVal <span class="main">(</span><span class="free"><span class="free"><span class="entity">extract_bool</span></span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
  <span class="main">|</span> IntVal <span class="main">(</span><span class="free"><span class="free"><span class="entity">extract_int</span></span></span><span class="main">:</span> <span class="quoted">int</span><span class="main">)</span>
  <span class="main">|</span> RealVal <span class="main">(</span><span class="free"><span class="free"><span class="entity">extract_real</span></span></span><span class="main">:</span> <span class="quoted">real</span><span class="main">)</span>
  <span class="main">|</span> PairVal <span class="main">(</span><span class="free"><span class="free"><span class="entity">extract_fst</span></span></span><span class="main">:</span> <span class="quoted">val</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">extract_snd</span></span></span><span class="main">:</span> <span class="quoted">val</span><span class="main">)</span>  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">&lt;|</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">|&gt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span>  <span class="main">[</span>0<span class="main">,</span> 61<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_bool</span> UnitVal <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_bool</span> <span class="main">(</span>IntVal <span class="free">i</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_bool</span> <span class="main">(</span>RealVal <span class="free">r</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_bool</span> <span class="main">(</span>PairVal <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_int</span> UnitVal <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_int</span> <span class="main">(</span>BoolVal <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_int</span> <span class="main">(</span>RealVal <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_int</span> <span class="main">(</span>PairVal <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_real</span> UnitVal <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_real</span> <span class="main">(</span>BoolVal <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_real</span> <span class="main">(</span>IntVal <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">extract_real</span> <span class="main">(</span>PairVal <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">extract_pair'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_pair'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&lt;|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">|&gt;</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_int_pair</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_int_pair</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">&lt;|</span> IntVal <span class="bound">a</span><span class="main">,</span> IntVal <span class="bound">b</span> <span class="main">|&gt;</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_real_pair</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_real_pair</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">&lt;|</span> RealVal <span class="bound">a</span><span class="main">,</span> RealVal <span class="bound">b</span> <span class="main">|&gt;</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">TRUE</span> <span class="main">≡</span> BoolVal True"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FALSE</span> <span class="main">≡</span> BoolVal False"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> vname <span class="main">=</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> val"</span></span>

<span class="keyword1" id="PDF_Values-map_int_pair"><span class="command">lemma</span></span> map_int_pair<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_int_pair <span class="free">f</span> <span class="free">g</span> <span class="main">&lt;|</span> IntVal <span class="free">i</span><span class="main">,</span> IntVal <span class="free">j</span> <span class="main">|&gt;</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_int_pair_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-map_int_pair_REAL"><span class="command">lemma</span></span> map_int_pair_REAL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_int_pair <span class="free">f</span> <span class="free">g</span> <span class="main">&lt;|</span> RealVal <span class="free">i</span><span class="main">,</span> RealVal <span class="free">j</span> <span class="main">|&gt;</span> <span class="main">=</span> <span class="free">g</span> <span class="main">&lt;|</span> RealVal <span class="free">i</span><span class="main">,</span> RealVal <span class="free">j</span> <span class="main">|&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_int_pair_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-map_real_pair"><span class="command">lemma</span></span> map_real_pair<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_real_pair <span class="free">f</span> <span class="free">g</span> <span class="main">&lt;|</span> RealVal <span class="free">i</span><span class="main">,</span> RealVal <span class="free">j</span> <span class="main">|&gt;</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_real_pair_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_pair</span> <span class="main">≡</span> extract_pair' id id"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_real_pair</span> <span class="main">≡</span> extract_pair' extract_real extract_real"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_int_pair</span> <span class="main">≡</span> extract_pair' extract_int extract_int"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">RealPairVal</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span>RealVal <span class="bound">x</span><span class="main">,</span> RealVal <span class="bound">y</span><span class="main">|&gt;</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">IntPairVal</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span>IntVal <span class="bound">x</span><span class="main">,</span> IntVal <span class="bound">y</span><span class="main">|&gt;</span>"</span></span>

<span class="keyword1" id="PDF_Values-inj_RealPairVal"><span class="command">lemma</span></span> inj_RealPairVal<span class="main">:</span> <span class="quoted"><span class="quoted">"inj RealPairVal"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RealPairVal_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>
<span class="keyword1" id="PDF_Values-inj_IntPairVal"><span class="command">lemma</span></span> inj_IntPairVal<span class="main">:</span> <span class="quoted"><span class="quoted">"inj IntPairVal"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IntPairVal_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> pdf_type"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val_type</span> <span class="main">(</span>BoolVal <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> BOOL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val_type</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> INTEG"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val_type</span> UnitVal <span class="main">=</span> UNIT"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val_type</span> <span class="main">(</span>RealVal <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> REAL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val_type</span> <span class="main">(</span><span class="main">&lt;|</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">val_type</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">val_type</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Values-val_type_eq_REAL"><span class="command">lemma</span></span> val_type_eq_REAL<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> REAL <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> RealVal<span class="main">`</span>UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Values-val_type_eq_INTEG"><span class="command">lemma</span></span> val_type_eq_INTEG<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> INTEG <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> IntVal<span class="main">`</span>UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_universe</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> val_type <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="PDF_Values-type_universe_nonempty"><span class="command">lemma</span></span> type_universe_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"type_universe <span class="free">t</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> val_type.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_universe_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-val_in_type_universe"><span class="command">lemma</span></span> val_in_type_universe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="main">(</span>val_type <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-BoolVal_in_type_universe"><span class="command">lemma</span></span> BoolVal_in_type_universe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"BoolVal <span class="free">v</span> <span class="main">∈</span> type_universe BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-IntVal_in_type_universe"><span class="command">lemma</span></span> IntVal_in_type_universe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">v</span> <span class="main">∈</span> type_universe INTEG"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-type_universe_type"><span class="command">lemma</span></span> type_universe_type<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> type_universe <span class="free">t</span> <span class="main">⟷</span> val_type <span class="free">w</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-type_universe_REAL"><span class="command">lemma</span></span> type_universe_REAL<span class="main">:</span> <span class="quoted"><span class="quoted">"type_universe REAL <span class="main">=</span> RealVal <span class="main">`</span> UNIV"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Values-type_universe_eq_imp_type_eq"><span class="command">lemma</span></span> type_universe_eq_imp_type_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"type_universe <span class="free">t1</span> <span class="main">=</span> type_universe <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">=</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> type_universe_nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> type_universe <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">=</span> val_type <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> type_universe <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val_type <span class="skolem">v</span> <span class="main">=</span> <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Values-type_universe_eq_iff"><span class="command">lemma</span></span> type_universe_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"type_universe <span class="free">t1</span> <span class="main">=</span> type_universe <span class="free">t2</span> <span class="main">⟷</span> <span class="free">t1</span> <span class="main">=</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> type_universe_eq_imp_type_eq<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">stock_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_type <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stock_measure</span> UNIT <span class="main">=</span> count_space <span class="main">{</span>UnitVal<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stock_measure</span> INTEG <span class="main">=</span> count_space <span class="main">(</span>range IntVal<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stock_measure</span> BOOL <span class="main">=</span> count_space <span class="main">(</span>range BoolVal<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stock_measure</span> REAL <span class="main">=</span> embed_measure lborel RealVal"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stock_measure</span> <span class="main">(</span>PRODUCT <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span>
       embed_measure <span class="main">(</span><span class="free">stock_measure</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">stock_measure</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted">stock_measure</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1" id="PDF_Values-sigma_finite_stock_measure"><span class="command">lemma</span></span> sigma_finite_stock_measure<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sigma_finite_measure_count_space_countable sigma_finite_pair_measure
                   sigma_finite_embed_measure injI sigma_finite_lborel<span class="main">)</span>

<span class="keyword1" id="PDF_Values-val_case_stock_measurable"><span class="command">lemma</span></span> val_case_stock_measurable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> UNIT <span class="main">⟹</span> <span class="free">c</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> BOOL <span class="main">⟹</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> INTEG <span class="main">⟹</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> REAL <span class="main">⟹</span> <span class="free">j</span> <span class="main">∈</span> measurable borel <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> PRODUCT <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⟹</span> case_prod <span class="free">k</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="bound">t1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="bound">t2</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> UnitVal <span class="main">⇒</span> <span class="free">c</span> <span class="main">|</span> BoolVal <span class="bound">b</span> <span class="main">⇒</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">|</span> IntVal <span class="bound">i</span> <span class="main">⇒</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">|</span> RealVal <span class="bound">r</span> <span class="main">⇒</span> <span class="free">j</span> <span class="bound">r</span>
                <span class="main">|</span> PairVal <span class="bound">y</span> <span class="bound">z</span> <span class="main">⇒</span> <span class="free">k</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">t</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_embed_measure1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_embed_measure1 assms<span class="main">)</span>

<span class="keyword1" id="PDF_Values-space_stock_measure"><span class="command">lemma</span></span> space_stock_measure<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def space_pair_measure space_embed_measure
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> val_type.elims<span class="main">)</span>

<span class="keyword1" id="PDF_Values-type_universe_stock_measure"><span class="command">lemma</span></span> type_universe_stock_measure<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"type_universe <span class="free">t</span> <span class="main">∈</span> sets <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sets.top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"stock_measure <span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Values-inj_RealVal"><span class="command">lemma</span></span> inj_RealVal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj RealVal"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
<span class="keyword1" id="PDF_Values-inj_IntVal"><span class="command">lemma</span></span> inj_IntVal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj IntVal"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
<span class="keyword1" id="PDF_Values-inj_BoolVal"><span class="command">lemma</span></span> inj_BoolVal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj BoolVal"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
<span class="keyword1" id="PDF_Values-inj_PairVal"><span class="command">lemma</span></span> inj_PairVal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span> <span class="bound">x</span> <span class="main">,</span>  <span class="bound">y</span> <span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_PairVal"><span class="command">lemma</span></span> measurable_PairVal<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted">pdf_type</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_prod PairVal <span class="main">∈</span> measurable <span class="main">(</span><span class="free">t1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> measurable_embed_measure2<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Values-measurable_RealVal"><span class="command">lemma</span></span> measurable_RealVal<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RealVal <span class="main">∈</span> measurable borel REAL"</span></span>
  <span class="keyword1"><span class="command">using</span></span> measurable_embed_measure2<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Values-nn_integral_BoolVal"><span class="command">lemma</span></span> nn_integral_BoolVal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>BoolVal <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>BOOL<span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>BoolVal True<span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="main">(</span>BoolVal False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"range BoolVal <span class="main">=</span> <span class="main">{</span>BoolVal True<span class="main">,</span> BoolVal False<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> stock_measure.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nn_integral_count_space_finite<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Values-nn_integral_RealVal"><span class="command">lemma</span></span> nn_integral_RealVal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable REAL <span class="main">⟹</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>REAL<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>RealVal <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stock_measure.simps <span class="keyword1"><span class="command">using</span></span> measurable_embed_measure2<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_eq_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_distr<span class="main">)</span>

<span class="keyword1" id="PDF_Values-nn_integral_IntVal"><span class="command">lemma</span></span> nn_integral_IntVal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>INTEG<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>IntVal <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> measurable_embed_measure1<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> stock_measure.simps embed_measure_count_space<span class="main">[</span><span class="operator">OF</span> inj_IntVal<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_IntVal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_distr space_embed_measure<span class="main">)</span>

<span class="keyword1" id="PDF_Values-nn_integral_PairVal"><span class="command">lemma</span></span> nn_integral_PairVal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>PairVal <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="main">(</span><span class="free">t1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stock_measure.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_embed_measure<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta' inj_on_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-BOOL_E"><span class="command">lemma</span></span> BOOL_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>val_type <span class="free">v</span> <span class="main">=</span> BOOL<span class="main">;</span> <span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> BoolVal <span class="bound">b</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Values-PROD_E"><span class="command">lemma</span></span> PROD_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>val_type <span class="free">v</span> <span class="main">=</span> PRODUCT <span class="free">t1</span> <span class="free">t2</span> <span class="main">;</span>
     <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> val_type <span class="bound">a</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">⟹</span> val_type <span class="bound">b</span> <span class="main">=</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> <span class="main">&lt;|</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span> <span class="main">|&gt;</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Values-REAL_E"><span class="command">lemma</span></span> REAL_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>val_type <span class="free">v</span> <span class="main">=</span> REAL<span class="main">;</span> <span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> RealVal <span class="bound">b</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Values-INTEG_E"><span class="command">lemma</span></span> INTEG_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>val_type <span class="free">v</span> <span class="main">=</span> INTEG<span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> IntVal <span class="bound">i</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Values-measurable_extract_pair'"><span class="command">lemma</span></span> measurable_extract_pair'<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted">pdf_type</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">t1</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="free">t2</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> measurable <span class="free">K</span> <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> extract_pair' <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">K</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> h<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> stock_measure.simps<span class="main"><span class="main">]</span></span> measurable_embed_measure1<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_extract_pair"><span class="command">lemma</span></span> measurable_extract_pair<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extract_pair <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">(</span><span class="free">t1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Values-measurable_extract_real"><span class="command">lemma</span></span> measurable_extract_real<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extract_real <span class="main">∈</span> measurable REAL borel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_embed_measure1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Values-measurable_extract_int"><span class="command">lemma</span></span> measurable_extract_int<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extract_int <span class="main">∈</span> measurable INTEG <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Values-measurable_extract_int_pair"><span class="command">lemma</span></span> measurable_extract_int_pair<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"extract_int_pair <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span> <span class="main">(</span>count_space UNIV <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Values-measurable_extract_real_pair"><span class="command">lemma</span></span> measurable_extract_real_pair<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"extract_real_pair <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Values-measurable_extract_real_pair'"><span class="command">lemma</span></span> measurable_extract_real_pair'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"extract_real_pair <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> borel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> borel_prod<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Values-measurable_extract_bool"><span class="command">lemma</span></span> measurable_extract_bool<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extract_bool <span class="main">∈</span> measurable BOOL <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Values-map_int_pair_measurable"><span class="command">lemma</span></span> map_int_pair_measurable<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>count_space UNIV <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV<span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_int_pair <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> space <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_int_pair <span class="free">f</span> <span class="free">g</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span>case_prod <span class="free">f</span> <span class="keyword1">o</span> extract_int_pair<span class="main">)</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure space_pair_measure<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘</span> extract_int_pair <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span><span class="main">)</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> measurable_extract_int_pair f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">measurable</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Values-map_int_pair_measurable_REAL"><span class="command">lemma</span></span> map_int_pair_measurable_REAL<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_int_pair <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> space <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_int_pair <span class="free">f</span> <span class="free">g</span> <span class="skolem">w</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure space_pair_measure map_int_pair_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>

<span class="keyword1" id="PDF_Values-map_real_pair_measurable"><span class="command">lemma</span></span> map_real_pair_measurable<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_real_pair <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> space <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_real_pair <span class="free">f</span> <span class="free">g</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span>case_prod <span class="free">f</span> <span class="keyword1">o</span> extract_real_pair<span class="main">)</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure space_pair_measure<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘</span> extract_real_pair <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span><span class="main">)</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> measurable_extract_real_pair f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">measurable</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Values-count_space_IntVal_prod"><span class="command">lemma</span></span> count_space_IntVal_prod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"INTEG <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> INTEG <span class="main">=</span> count_space <span class="main">(</span>range IntVal <span class="main">×</span> range IntVal<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pair_measure_countable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-count_space_BoolVal_prod"><span class="command">lemma</span></span> count_space_BoolVal_prod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"BOOL <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> BOOL <span class="main">=</span> count_space <span class="main">(</span>range BoolVal <span class="main">×</span> range BoolVal<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pair_measure_countable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_stock_measure_val_type"><span class="command">lemma</span></span> measurable_stock_measure_val_type<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_space<span class="main">)</span>

<span class="keyword1" id="PDF_Values-singleton_in_stock_measure"><span class="command">lemma</span></span> singleton_in_stock_measure<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="free">v</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PairVal <span class="skolem">v1</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">&lt;|</span><span class="skolem">v1</span><span class="main">,</span> <span class="skolem">v2</span><span class="main">|&gt;</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="skolem">v1</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="skolem">v2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> pair_measureI<span class="main">[</span><span class="operator">OF</span> PairVal.IH<span class="main">,</span> <span class="operator">OF</span> refl refl<span class="main">]</span> PairVal.prems<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> val_type.simps stock_measure.simps A in_sets_embed_measure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sets_embed_measure<span class="main">)</span>

<span class="keyword1" id="PDF_Values-emeasure_stock_measure_singleton_finite"><span class="command">lemma</span></span> emeasure_stock_measure_singleton_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>stock_measure <span class="main">(</span>val_type <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RealVal <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>RealVal <span class="skolem">r</span><span class="main">}</span> <span class="main">=</span> RealVal <span class="main">`</span> <span class="main">{</span><span class="skolem">r</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RealVal <span class="main">`</span> <span class="main">{</span><span class="skolem">r</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>embed_measure lborel RealVal<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_sets_embed_measure<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> A val_type.simps stock_measure.simps emeasure_embed_measure
                            inj_RealVal inj_vimage_image_eq<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PairVal <span class="skolem">v1</span> <span class="skolem">v2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span>val_type <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>val_type <span class="skolem">v2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sigma_finite_stock_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">&lt;|</span><span class="skolem">v1</span><span class="main">,</span> <span class="skolem">v2</span><span class="main">|&gt;</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="skolem">v1</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="skolem">v2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">v1</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="skolem">v2</span><span class="main">}</span> <span class="main">∈</span> <span class="var">?M</span> <span class="skolem">v1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="var">?M</span> <span class="skolem">v2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pair_measureI singleton_in_stock_measure<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="var">?M</span> <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">&lt;|</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">|&gt;</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="main">(</span><span class="var">?M</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">{</span><span class="skolem">v1</span><span class="main">}</span> <span class="main">*</span> emeasure <span class="main">(</span><span class="var">?M</span> <span class="skolem">v2</span><span class="main">)</span> <span class="main">{</span><span class="skolem">v2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> stock_measure.simps val_type.simps A emeasure_embed_measure_image inj_PairVal
                     inj_vimage_image_eq emeasure_pair_measure_Times singleton_in_stock_measure B<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> PairVal.IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_mult_eq_top_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Measures on states›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname set <span class="main">⇒</span> <span class="main">(</span>vname <span class="main">⇒</span> pdf_type<span class="main">)</span> <span class="main">⇒</span> state measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_measure</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">y</span>"</span></span>

<span class="keyword1" id="PDF_Values-state_measure_nonempty"><span class="command">lemma</span></span> state_measure_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM PiE_eq_empty_iff<span class="main">)</span>

<span class="keyword1" id="PDF_Values-space_state_measure"><span class="command">lemma</span></span> space_state_measure<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">y</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM PiE_eq_empty_iff<span class="main">)</span>

<span class="keyword1" id="PDF_Values-state_measure_var_type"><span class="command">lemma</span></span> state_measure_var_type<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> val_type <span class="main">(</span><span class="free">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>

<span class="keyword1" id="PDF_Values-merge_in_state_measure"><span class="command">lemma</span></span> merge_in_state_measure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">A</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">B</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
      merge <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">A</span><span class="main">∪</span><span class="free">B</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_merge<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_pair_measure<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_merge_stock"><span class="command">lemma</span></span> measurable_merge_stock<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> state_measure <span class="free">V</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-comp_in_state_measure"><span class="command">lemma</span></span> comp_in_state_measure<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM<span class="main">)</span>

<span class="keyword1" id="PDF_Values-sigma_finite_state_measure"><span class="command">lemma</span></span> sigma_finite_state_measure<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"finite <span class="free">V</span> <span class="main">⟹</span> sigma_finite_measure <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> product_sigma_finite.sigma_finite <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> product_sigma_finite_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equalities of measure embeddings›</span></span>

<span class="keyword1" id="PDF_Values-embed_measure_RealPairVal"><span class="command">lemma</span></span> embed_measure_RealPairVal<span class="main">:</span>
   <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="main">=</span> embed_measure lborel RealPairVal"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span> <span class="bound">x</span> <span class="main">,</span>  <span class="bound">y</span> <span class="main">|&gt;</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>RealVal <span class="bound">x</span><span class="main">,</span> RealVal <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> RealPairVal"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RealPairVal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="main">=</span>
            embed_measure <span class="main">(</span>embed_measure lborel <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>RealVal <span class="bound">x</span><span class="main">,</span> RealVal <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_prod PairVal<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> embed_measure_prod sigma_finite_lborel lborel_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> embed_measure lborel RealPairVal"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_comp<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Values-embed_measure_IntPairVal"><span class="command">lemma</span></span> embed_measure_IntPairVal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span> <span class="main">=</span> count_space <span class="main">(</span>range IntPairVal<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span> <span class="bound">x</span> <span class="main">,</span>  <span class="bound">y</span> <span class="main">|&gt;</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>range IntVal <span class="main">×</span> range IntVal<span class="main">)</span> <span class="main">=</span> range IntPairVal"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IntPairVal_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> count_space_IntVal_prod <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> embed_measure_prod embed_measure_count_space<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monadic operations on values›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">return_val</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> return <span class="main">(</span>stock_measure <span class="main">(</span>val_type <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Values-sets_return_val"><span class="command">lemma</span></span> sets_return_val<span class="main">[</span><span class="operator">measurable_cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>return_val <span class="free">x</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="main">(</span>val_type <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_return_val"><span class="command">lemma</span></span> measurable_return_val<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"return_val <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> return_val_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> type_universe_type<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> return_measurable<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Values-bind_return_val"><span class="command">lemma</span></span> bind_return_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> measurable_stock_measure_val_type<span class="main">)</span>

<span class="keyword1" id="PDF_Values-bind_return_val'"><span class="command">lemma</span></span> bind_return_val'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"return_val <span class="free">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_val <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"return_val <span class="free">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_val<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> return_val_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> measurable_cong_sets<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_return<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms type_universe_def
                                        <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_space<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> type_universe_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"return <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> return_val <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Values-bind_return_val''"><span class="command">lemma</span></span> bind_return_val''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="main">(</span>val_type <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"return_val <span class="free">x</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> return_val_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Values-bind_assoc_return_val"><span class="command">lemma</span></span> bind_assoc_return_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t''</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_return_val<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Mf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mg measurable_return_val<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sets_eq_imp_space_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_val'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t'</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t''</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mg<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Values-bind_return_val_distr"><span class="command">lemma</span></span> bind_return_val_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> return_val <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> return_val <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⤜</span> return <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sets_eq_imp_space_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_return_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_eq_imp_space_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Mf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lifting of functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_RealVal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_RealVal</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span> RealVal <span class="bound">v</span> <span class="main">⇒</span> RealVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RealVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_IntVal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_IntVal</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span> IntVal <span class="bound">v</span> <span class="main">⇒</span> IntVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> IntVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_RealIntVal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_RealIntVal</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span> IntVal <span class="bound">v</span> <span class="main">⇒</span> IntVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> RealVal <span class="bound">v</span> <span class="main">⇒</span> RealVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_RealIntVal2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_RealIntVal2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span>
    map_int_pair <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> IntVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>map_real_pair <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> RealVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
      id<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">lift_Comp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_Comp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> map_int_pair <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> BoolVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>map_real_pair <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> BoolVal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> FALSE<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Values-lift_RealVal_eq"><span class="command">lemma</span></span> lift_RealVal_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lift_RealVal <span class="free">f</span> <span class="main">(</span>RealVal <span class="free">x</span><span class="main">)</span> <span class="main">=</span> RealVal <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_RealVal_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-lift_RealIntVal_Real"><span class="command">lemma</span></span> lift_RealIntVal_Real<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">⟹</span> lift_RealIntVal <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> lift_RealVal <span class="free">g</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure lift_RealIntVal_def lift_RealVal_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-lift_RealIntVal_Int"><span class="command">lemma</span></span> lift_RealIntVal_Int<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">⟹</span> lift_RealIntVal <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> lift_IntVal <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure lift_RealIntVal_def lift_IntVal_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> stock_measure.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span><span class="main">]</span>

<span class="keyword1" id="PDF_Values-measurable_lift_RealVal"><span class="command">lemma</span></span> measurable_lift_RealVal<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift_RealVal <span class="free">f</span> <span class="main">∈</span> measurable REAL REAL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_RealVal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_lift_IntVal"><span class="command">lemma</span></span> measurable_lift_IntVal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lift_IntVal <span class="free">f</span> <span class="main">∈</span> range IntVal <span class="main">→</span> range IntVal"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_IntVal_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_lift_IntVal'"><span class="command">lemma</span></span> measurable_lift_IntVal'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lift_IntVal <span class="free">f</span> <span class="main">∈</span> measurable INTEG INTEG"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_IntVal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-split_apply"><span class="command">lemma</span></span> split_apply<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Values-measurable_lift_Comp_RealVal"><span class="command">lemma</span></span> measurable_lift_Comp_RealVal<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span> <span class="main">(</span>case_prod <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift_Comp <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_Comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Values-measurable_lift_Comp_IntVal"><span class="command">lemma</span></span> measurable_lift_Comp_IntVal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_Comp <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_Comp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_lift_RealIntVal_IntVal"><span class="command">lemma</span></span> measurable_lift_RealIntVal_IntVal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lift_RealIntVal <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> range IntVal <span class="main">→</span> range IntVal"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> embed_measure_count_space lift_RealIntVal_def<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_lift_RealIntVal_IntVal'"><span class="command">lemma</span></span> measurable_lift_RealIntVal_IntVal'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"lift_RealIntVal <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable INTEG INTEG"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_lift_RealIntVal_RealVal"><span class="command">lemma</span></span> measurable_lift_RealIntVal_RealVal<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift_RealIntVal <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable REAL REAL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_RealIntVal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_lift_RealIntVal2_IntVal"><span class="command">lemma</span></span> measurable_lift_RealIntVal2_IntVal<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_RealIntVal2 <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span> INTEG"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_RealIntVal2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable<span class="main">)</span>

<span class="keyword1" id="PDF_Values-measurable_lift_RealIntVal2_RealVal"><span class="command">lemma</span></span> measurable_lift_RealIntVal2_RealVal<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift_RealIntVal2 <span class="free">f</span> <span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> REAL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_RealIntVal2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Values-distr_lift_RealVal"><span class="command">lemma</span></span> distr_lift_RealVal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pdens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">δ</span><span class="main">.</span> has_subprob_density <span class="bound">M</span> lborel <span class="bound">δ</span> <span class="main">⟹</span> has_density <span class="main">(</span>distr <span class="bound">M</span> borel <span class="free">f</span><span class="main">)</span> lborel <span class="main">(</span><span class="free">g</span> <span class="bound">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>lift_RealVal <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">N</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> sets_M<span class="main">[</span><span class="operator">measurable_cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> measurable_embed_measure1<span class="main">[</span><span class="operator">measurable</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>lift_RealVal <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>RealVal <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> sets_M<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealVal_def stock_measure.simps space_embed_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> lborel extract_real<span class="main">)</span> borel <span class="free">f</span><span class="main">)</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> RealVal"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distr_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_comp<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ Mf<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> dens''<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> lborel extract_real<span class="main">)</span> borel <span class="free">f</span><span class="main">)</span> lborel <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> RealVal<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dens' has_subprob_density_embed_measure''<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> pdens<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>distr <span class="free">M</span> lborel extract_real<span class="main">)</span> borel <span class="free">f</span> <span class="main">=</span> density lborel <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> RealVal<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">...</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> RealVal <span class="main">=</span> embed_measure <span class="main">...</span> RealVal"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_RealVal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_embed_measure stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> density <span class="main">(</span>embed_measure lborel RealVal<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> density_embed_measure'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_densityD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> density <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">,</span> <span class="operator">THEN</span> has_densityD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>  measurable_extract_real
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_comp<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> space_stock_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="PDF_Values-distr_lift_IntVal"><span class="command">lemma</span></span> distr_lift_IntVal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pdens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">δ</span><span class="main">.</span> has_density <span class="bound">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="bound">δ</span> <span class="main">⟹</span>
                            has_density <span class="main">(</span>distr <span class="bound">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span>lift_IntVal <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">N</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space <span class="main">(</span>range IntVal<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="var">?R</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> sets_M<span class="main">[</span><span class="operator">measurable_cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets INTEG"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_densityD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span>lift_IntVal <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span>IntVal <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> sets_M<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_embed_measure lift_IntVal_def stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> <span class="var">?R</span> extract_int<span class="main">)</span> <span class="var">?R</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> IntVal"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distr_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_comp<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ Mf<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> dens''<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> <span class="var">?R</span> extract_int<span class="main">)</span> <span class="var">?R</span> <span class="free">f</span><span class="main">)</span> <span class="var">?R</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> IntVal<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dens' has_density_embed_measure''<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> dens<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_int_def embed_measure_count_space stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>distr <span class="free">M</span> <span class="var">?R</span> extract_int<span class="main">)</span> <span class="var">?R</span> <span class="free">f</span> <span class="main">=</span> density <span class="var">?R</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> IntVal<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">...</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> IntVal <span class="main">=</span> embed_measure <span class="main">...</span> IntVal"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_IntVal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sets_embed_measure subset_image_iff stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> density <span class="main">(</span>embed_measure <span class="var">?R</span> IntVal<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> density_embed_measure'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_int_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_densityD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> density <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_measure_count_space stock_measure.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure INTEG<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_measure_count_space stock_measure.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> space_stock_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="PDF_Values-distr_lift_RealPairVal"><span class="command">lemma</span></span> distr_lift_RealPairVal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">f'</span> <span class="free">g</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pdens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">δ</span><span class="main">.</span> has_subprob_density <span class="bound">M</span> lborel <span class="bound">δ</span> <span class="main">⟹</span> has_density <span class="main">(</span>distr <span class="bound">M</span> borel <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span><span class="main">)</span> lborel <span class="main">(</span><span class="free">g</span> <span class="bound">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>lift_RealIntVal2 <span class="free">f'</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">N</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sets_M<span class="main">[</span><span class="operator">measurable_cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pdens<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>lift_RealIntVal2 <span class="free">f'</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>RealVal <span class="main">∘</span> case_prod <span class="free">f</span> <span class="main">∘</span> extract_real_pair<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> sets_M<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal2_def space_embed_measure space_pair_measure stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> lborel extract_real_pair<span class="main">)</span> borel <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span><span class="main">)</span> REAL RealVal"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distr_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_comp<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ Mf<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> dens''<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> lborel extract_real_pair<span class="main">)</span> borel <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span><span class="main">)</span> lborel
                      <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> RealPairVal<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_RealPairVal embed_measure_RealPairVal
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dens' has_subprob_density_embed_measure''<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> pdens<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RealPairVal_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>distr <span class="free">M</span> lborel extract_real_pair<span class="main">)</span> borel <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span> <span class="main">=</span>
             density lborel <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> RealPairVal<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">...</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> RealVal <span class="main">=</span> embed_measure <span class="main">...</span> RealVal"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_RealVal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_embed_measure stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> density <span class="main">(</span>embed_measure lborel RealVal<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> density_embed_measure'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">erule</span> has_densityD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> density <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>RealPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_comp<span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> measurable_extract_real<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_lborel2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> has_densityD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> space_stock_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="PDF_Values-distr_lift_IntPairVal"><span class="command">lemma</span></span> distr_lift_IntPairVal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">f'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pdens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">δ</span><span class="main">.</span> has_density <span class="bound">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="bound">δ</span> <span class="main">⟹</span>
                            has_density <span class="main">(</span>distr <span class="bound">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span><span class="main">)</span>
                                        <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span>lift_RealIntVal2 <span class="free">f</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_density <span class="free">N</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space <span class="main">(</span>range IntVal<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space <span class="main">(</span>range IntPairVal<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?tp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"PRODUCT INTEG INTEG"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="var">?R</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> MIV<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="main">∈</span> measurable <span class="var">?R</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="free">M</span> <span class="main">(</span>stock_measure <span class="var">?tp</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="var">?tp</span><span class="main">)</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> sets_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_IntPairVal<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="free">M</span> <span class="main">=</span> space <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_eq_imp_space_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sets_M <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable <span class="main">(</span>count_space <span class="main">(</span>range IntPairVal<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span>lift_RealIntVal2 <span class="free">f</span> <span class="free">f'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span>IntVal <span class="main">∘</span> case_prod <span class="free">f</span> <span class="main">∘</span> extract_int_pair<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal2_def space_embed_measure space_pair_measure IntPairVal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> extract_int_pair<span class="main">)</span>
                        <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> IntVal"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?R</span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> stock_measure.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> MIV<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> distr_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> dens''<span class="main">:</span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="main">(</span>distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> extract_int_pair<span class="main">)</span> <span class="var">?R</span> <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="var">?R</span>
                      <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> IntPairVal<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_IntPairVal embed_measure_IntPairVal
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dens' has_density_embed_measure''<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> dens<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_int_def embed_measure_count_space IntPairVal_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>distr <span class="free">M</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> extract_int_pair<span class="main">)</span> <span class="var">?R</span> <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span> <span class="main">=</span>
             density <span class="var">?R</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">δ</span> <span class="main">∘</span> IntPairVal<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">...</span> <span class="main">(</span>stock_measure INTEG<span class="main">)</span> IntVal <span class="main">=</span> embed_measure <span class="main">...</span> IntVal"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> embed_measure_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_IntVal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sets_embed_measure subset_image_iff stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> density <span class="main">(</span>embed_measure <span class="var">?R</span> IntVal<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> density_embed_measure'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_int_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">erule</span> has_densityD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> density <span class="main">(</span>stock_measure INTEG<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_measure_count_space stock_measure.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> dens''<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>IntPairVal <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure INTEG<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_measure_count_space stock_measure.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> space_stock_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PDF_Semantics">
<div class="head">
<h1>Theory PDF_Semantics</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Semantics.thy
  Author: Manuel Eberl

  Defines the expressions of the PDF language and their typing rules and semantics
  as well as a number of standard semantics-related theorems such as substitution.
*)</span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Semantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PDF_Values.html">PDF_Values</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_subprob_algebra_density"><span class="command">lemma</span></span> measurable_subprob_algebra_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sigma_finite_measure <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"space <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> density <span class="free">N</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_subprob_algebra<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_spaceI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_density <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="free">N</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> emeasure <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span>density <span class="free">N</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> measurable_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Built-in Probability Distributions›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bernoulli›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernoulli_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> bool <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bernoulli_density</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> <span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernoulli</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bernoulli</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> density BOOL <span class="main">(</span>bernoulli_density <span class="main">(</span>extract_real <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">o</span> extract_bool<span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_bernoulli_density"><span class="command">lemma</span></span> measurable_bernoulli_density<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_prod bernoulli_density <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bernoulli_density_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Semantics-measurable_bernoulli"><span class="command">lemma</span></span> measurable_bernoulli<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">∈</span> measurable REAL <span class="main">(</span>subprob_algebra BOOL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bernoulli_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_subprob_algebra_density
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_split_conv nn_integral_BoolVal bernoulli_density_def
             ennreal_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ennreal_plus<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Uniform›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniform_real_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">×</span> real <span class="main">⇒</span> real <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uniform_real_density</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span> <span class="keyword1">then</span> inverse <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="bound">a</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniform_int_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int <span class="main">⇒</span> int <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uniform_int_density</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span> <span class="keyword1">then</span> inverse <span class="main">(</span>nat <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="bound">a</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_uniform_density_int"><span class="command">lemma</span></span> measurable_uniform_density_int<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod uniform_int_density<span class="main">)</span>
       <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="main">(</span>count_space UNIV <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV<span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_measure_countable<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-measurable_uniform_density_real"><span class="command">lemma</span></span> measurable_uniform_density_real<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod uniform_real_density<span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod uniform_real_density<span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> uniform_real_density <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> uniform_real_density_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> borel_prod<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniform_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uniform_int</span> <span class="main">=</span> map_int_pair <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">u</span><span class="main">.</span> density INTEG <span class="main">(</span>uniform_int_density <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="keyword1">o</span> extract_int<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniform_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uniform_real</span> <span class="main">=</span> map_real_pair <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">u</span><span class="main">.</span> density REAL <span class="main">(</span>uniform_real_density <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="keyword1">o</span> extract_real<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-if_bounded"><span class="command">lemma</span></span> if_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">v</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> indicator <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Semantics-measurable_uniform_int"><span class="command">lemma</span></span> measurable_uniform_int<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"uniform_int <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT INTEG INTEG<span class="main">)</span> <span class="main">(</span>subprob_algebra INTEG<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uniform_int_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">measurable</span></span> measurable_subprob_algebra_density<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> INTEG <span class="main">(</span>uniform_int_density <span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> snd <span class="skolem">x</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">≤</span> snd <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uniform_int_density_def comp_def nn_integral_IntVal nn_integral_cmult
                    nn_integral_set_ennreal<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ennreal_of_nat_eq_real_of_nat
                    if_bounded<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">int</span><span class="main"><span class="main">]</span></span> ennreal_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
               <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ennreal_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uniform_int_density_def comp_def split_beta' if_bounded<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">int</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-density_cong'"><span class="command">lemma</span></span> density_cong'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> density <span class="free">M</span> <span class="free">f</span> <span class="main">=</span> density <span class="free">M</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> density_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sets.sets_into_space <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong measure_of_eq<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-measurable_uniform_real"><span class="command">lemma</span></span> measurable_uniform_real<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"uniform_real <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="main">(</span>subprob_algebra REAL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uniform_real_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">measurable</span></span> measurable_subprob_algebra_density<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">×</span> real"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span>uniform_real_density <span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> snd <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">o</span> extract_real<span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>REAL<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_RealVal uniform_real_density_def if_bounded nn_integral_cmult
                    nn_integral_set_ennreal<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ennreal_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uniform_real_density_def comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def borel_prod<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Gaussian›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gaussian_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">×</span> real <span class="main">⇒</span> real <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gaussian_density</span> <span class="main">≡</span>
      <span class="main">λ</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="bound">m</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> sqrt <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="bound">s</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_gaussian_density"><span class="command">lemma</span></span> measurable_gaussian_density<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_prod gaussian_density <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod gaussian_density <span class="main">=</span>
              <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> snd <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="main">(</span><span class="bound">y</span> <span class="main">-</span> fst <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> snd <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
                             sqrt <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> snd <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gaussian_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> borel_prod<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gaussian</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gaussian</span> <span class="main">=</span> map_real_pair <span class="main">(</span><span class="main">λ</span><span class="bound">m</span> <span class="bound">s</span><span class="main">.</span> density REAL <span class="main">(</span>gaussian_density <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="keyword1">o</span> extract_real<span class="main">)</span><span class="main">)</span> undefined"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_gaussian"><span class="command">lemma</span></span> measurable_gaussian<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gaussian <span class="main">∈</span> measurable <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="main">(</span>subprob_algebra REAL<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gaussian_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">measurable</span></span> measurable_subprob_algebra_density<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">×</span> real"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>gaussian_density <span class="main">(</span>fst <span class="skolem">x</span><span class="main">,</span> snd <span class="skolem">x</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> lborel <span class="main">(</span>gaussian_density <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> normal_density <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gaussian_density_def normal_density_def split_beta' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_eq_integral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> normal_density_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_RealVal comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> snd <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_RealVal comp_def gaussian_density_def zero_ennreal_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def borel_prod<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Poisson›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poisson_density'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> int <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">poisson_density'</span> <span class="free"><span class="bound"><span class="entity">rate</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> pmf <span class="main">(</span>poisson_pmf <span class="free"><span class="bound"><span class="entity">rate</span></span></span><span class="main">)</span> <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">&lt;..}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rate</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_poisson_density'"><span class="command">lemma</span></span> measurable_poisson_density'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"case_prod poisson_density' <span class="main">∈</span> borel_measurable <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod poisson_density' <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">rate</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="bound">rate</span> <span class="main">^</span> nat <span class="bound">k</span> <span class="main">/</span> real_of_nat <span class="main">(</span>fact <span class="main">(</span>nat <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span><span class="bound">rate</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">&lt;..}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">(</span><span class="bound">rate</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff poisson_density'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poisson</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">poisson</span> <span class="free"><span class="bound"><span class="entity">rate</span></span></span> <span class="main">=</span> density INTEG <span class="main">(</span>poisson_density' <span class="main">(</span>extract_real <span class="free"><span class="bound"><span class="entity">rate</span></span></span><span class="main">)</span> <span class="keyword1">o</span> extract_int<span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_poisson"><span class="command">lemma</span></span> measurable_poisson<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"poisson <span class="main">∈</span> measurable REAL <span class="main">(</span>subprob_algebra INTEG<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> poisson_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">measurable</span></span> measurable_subprob_algebra_density<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="skolem">r</span> <span class="main">^</span> nat <span class="bound">x</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="main">(</span>nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>poisson_pmf <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>count_space <span class="main">{</span><span class="main">0</span> <span class="main">..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_count_space_indicator <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> measure_pmf.emeasure_space_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"poisson_pmf <span class="skolem">r</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_pmf'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="skolem">r</span> <span class="main">^</span> nat <span class="bound">x</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="main">(</span>nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> INTEG <span class="main">(</span>poisson_density' <span class="skolem">r</span> <span class="main">∘</span> extract_int<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nn_integral_IntVal poisson_density'_def zero_ennreal_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Source Language Syntax and Semantics›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expressions›</span></span>

<span class="keyword1"><span class="command">class</span></span> expr <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">free_vars</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> vname set"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pdf_dist <span class="main">=</span> Bernoulli <span class="main">|</span> UniformInt <span class="main">|</span> UniformReal <span class="main">|</span> Poisson <span class="main">|</span> Gaussian

<span class="keyword1"><span class="command">datatype</span></span> pdf_operator <span class="main">=</span> Fst <span class="main">|</span> Snd <span class="main">|</span> Add <span class="main">|</span> Mult <span class="main">|</span> Minus <span class="main">|</span> Less <span class="main">|</span> Equals <span class="main">|</span> And <span class="main">|</span> Not <span class="main">|</span> Or <span class="main">|</span> Pow <span class="main">|</span>
                        Sqrt <span class="main">|</span> Exp <span class="main">|</span> Ln <span class="main">|</span> Fact <span class="main">|</span> Inverse <span class="main">|</span> Pi <span class="main">|</span> Cast <span class="quoted">pdf_type</span>

<span class="keyword1"><span class="command">datatype</span></span> expr <span class="main">=</span>
      Var <span class="quoted">vname</span>
    <span class="main">|</span> Val <span class="quoted">val</span>
    <span class="main">|</span> LetVar <span class="quoted">expr</span> <span class="quoted">expr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">LET</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">IN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>0<span class="main">,</span> 60<span class="main">]</span> 61<span class="main">)</span>
    <span class="main">|</span> Operator <span class="quoted">pdf_operator</span> <span class="quoted">expr</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$$</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 999<span class="main">)</span>
    <span class="main">|</span> Pair <span class="quoted">expr</span> <span class="quoted">expr</span>  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">&lt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>  _<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">&gt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span>  <span class="main">[</span>0<span class="main">,</span> 60<span class="main">]</span> 1000<span class="main">)</span>
    <span class="main">|</span> Random <span class="quoted">pdf_dist</span> <span class="quoted">expr</span>
    <span class="main">|</span> IfThenElse <span class="quoted">expr</span> <span class="quoted">expr</span> <span class="quoted">expr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">IF</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">ELSE</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 70<span class="main">]</span> 71<span class="main">)</span>
    <span class="main">|</span> Fail <span class="quoted">pdf_type</span>

<span class="keyword1"><span class="command">type_synonym</span></span> tyenv <span class="main">=</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> pdf_type"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> expr <span class="main">::</span> <span class="quoted">expr</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">free_vars_expr</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span>Val <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span>LetVar <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> Suc <span class="main">-`</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span>Operator <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span>Random <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
       <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∪</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">free_vars_expr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr</span> <span class="main">(</span>Fail <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">free_vars_expr_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span>Val <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span>LetVar <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span>Operator <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span>Random <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
       <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∪</span> <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">free_vars_expr_code</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_expr_code</span> <span class="main">(</span>Fail <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-free_vars_expr_code"><span class="command">lemma</span></span> free_vars_expr_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="free">e</span><span class="main">::</span>expr<span class="main">)</span> <span class="main">=</span> free_vars_expr_code <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> Suc <span class="main">-`</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="bound">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">dist_param_type</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_param_type</span> Bernoulli <span class="main">=</span> REAL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_param_type</span> Poisson <span class="main">=</span> REAL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_param_type</span> Gaussian <span class="main">=</span> PRODUCT REAL REAL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_param_type</span> UniformInt <span class="main">=</span> PRODUCT INTEG INTEG"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_param_type</span> UniformReal <span class="main">=</span> PRODUCT REAL REAL"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">dist_result_type</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_result_type</span> Bernoulli <span class="main">=</span> BOOL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_result_type</span> UniformInt <span class="main">=</span> INTEG"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_result_type</span> UniformReal <span class="main">=</span> REAL"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_result_type</span> Poisson <span class="main">=</span> INTEG"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_result_type</span> Gaussian <span class="main">=</span> REAL"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">dist_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_dist <span class="main">⇒</span> val <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_measure</span> Bernoulli <span class="main">=</span> bernoulli"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_measure</span> UniformInt <span class="main">=</span> uniform_int"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_measure</span> UniformReal <span class="main">=</span> uniform_real"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_measure</span> Poisson <span class="main">=</span> poisson"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_measure</span> Gaussian <span class="main">=</span> gaussian"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_dist_measure"><span class="command">lemma</span></span> measurable_dist_measure<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dist_measure <span class="free">d</span> <span class="main">∈</span> measurable <span class="main">(</span>dist_param_type <span class="free">d</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>dist_result_type <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Semantics-sets_dist_measure"><span class="command">lemma</span></span> sets_dist_measure<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> dist_param_type <span class="free">dst</span> <span class="main">⟹</span>
       sets <span class="main">(</span>dist_measure <span class="free">dst</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_dist_measure<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Semantics-space_dist_measure"><span class="command">lemma</span></span> space_dist_measure<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> dist_param_type <span class="free">dst</span> <span class="main">⟹</span>
       space <span class="main">(</span>dist_measure <span class="free">dst</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> space_stock_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> sets_eq_imp_space_eq sets_dist_measure<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">dist_dens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_dist <span class="main">⇒</span> val <span class="main">⇒</span> val <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_dens</span> Bernoulli <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> bernoulli_density <span class="main">(</span>extract_real <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>extract_bool <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens</span> UniformInt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> uniform_int_density <span class="main">(</span>extract_int_pair <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>extract_int <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens</span> UniformReal <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> uniform_real_density <span class="main">(</span>extract_real_pair <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>extract_real <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens</span> Gaussian <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> gaussian_density <span class="main">(</span>extract_real_pair <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>extract_real <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens</span> Poisson <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> poisson_density' <span class="main">(</span>extract_real <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>extract_int <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_dist_dens"><span class="command">lemma</span></span> measurable_dist_dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>stock_measure <span class="main">(</span>dist_param_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> dist_dens <span class="free">dst</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"dist_dens <span class="free"><span class="free">dst</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dist_dens_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">dst</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Semantics-dist_measure_has_density"><span class="command">lemma</span></span> dist_measure_has_density<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="main">(</span>dist_param_type <span class="free">dst</span><span class="main">)</span> <span class="main">⟹</span>
       has_density <span class="main">(</span>dist_measure <span class="free">dst</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dist_dens <span class="free">dst</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> has_densityI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> type_universe <span class="main">(</span>dist_param_type <span class="free">dst</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dist_measure <span class="free">dst</span> <span class="skolem">v</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dist_dens <span class="free">dst</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dst</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_def uniform_int_def uniform_real_def poisson_def gaussian_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_cong' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PROD_E REAL_E INTEG_E<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Semantics-subprob_space_dist_measure"><span class="command">lemma</span></span> subprob_space_dist_measure<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="main">(</span>dist_param_type <span class="free">dst</span><span class="main">)</span> <span class="main">⟹</span> subprob_space <span class="main">(</span>dist_measure <span class="free">dst</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subprob_space_kernel<span class="main">[</span><span class="operator">OF</span> measurable_dist_measure<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">dst</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Semantics-dist_measure_has_subprob_density"><span class="command">lemma</span></span> dist_measure_has_subprob_density<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="main">(</span>dist_param_type <span class="free">dst</span><span class="main">)</span> <span class="main">⟹</span>
       has_subprob_density <span class="main">(</span>dist_measure <span class="free">dst</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dist_dens <span class="free">dst</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subprob_space_dist_measure dist_measure_has_density<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-dist_dens_integral_space"><span class="command">lemma</span></span> dist_dens_integral_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="main">(</span>dist_param_type <span class="free">dst</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">u</span><span class="main">.</span> dist_dens <span class="free">dst</span> <span class="free">v</span> <span class="bound">u</span> <span class="main">∂</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"density <span class="main">(</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dist_dens <span class="free">dst</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">u</span><span class="main">.</span> dist_dens <span class="free">dst</span> <span class="free">v</span> <span class="bound">u</span> <span class="main">∂</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                       emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> space_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> emeasure_density<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_dist_dens <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> dist_measure <span class="free">dst</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dist_measure_has_density<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">...</span> <span class="main">(</span>space <span class="main">...</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.emeasure_space_le_1 subprob_space_dist_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">op_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_operator <span class="main">⇒</span> pdf_type <span class="main">⇒</span> pdf_type option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Add <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
         PRODUCT INTEG INTEG <span class="main">⇒</span> Some INTEG
       <span class="main">|</span> PRODUCT REAL REAL <span class="main">⇒</span> Some REAL
       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Mult <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
         PRODUCT INTEG INTEG <span class="main">⇒</span> Some INTEG
       <span class="main">|</span> PRODUCT REAL REAL <span class="main">⇒</span> Some REAL
       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Minus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
         INTEG <span class="main">⇒</span> Some INTEG
       <span class="main">|</span> REAL <span class="main">⇒</span> Some REAL
       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Equals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
         PRODUCT <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t1</span> <span class="main">=</span> <span class="bound">t2</span> <span class="keyword1">then</span> Some BOOL <span class="keyword1">else</span> None
       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Less <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
         PRODUCT INTEG INTEG <span class="main">⇒</span> Some BOOL
       <span class="main">|</span> PRODUCT REAL REAL <span class="main">⇒</span> Some BOOL
       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> <span class="main">(</span>Cast <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
         <span class="main">(</span>BOOL<span class="main">,</span> INTEG<span class="main">)</span> <span class="main">⇒</span> Some INTEG
       <span class="main">|</span> <span class="main">(</span>BOOL<span class="main">,</span> REAL<span class="main">)</span> <span class="main">⇒</span> Some REAL
       <span class="main">|</span> <span class="main">(</span>INTEG<span class="main">,</span> REAL<span class="main">)</span> <span class="main">⇒</span> Some REAL
       <span class="main">|</span> <span class="main">(</span>REAL<span class="main">,</span> INTEG<span class="main">)</span> <span class="main">⇒</span> Some INTEG
       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Or <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> PRODUCT BOOL BOOL <span class="main">⇒</span> Some BOOL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> And <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> PRODUCT BOOL BOOL <span class="main">⇒</span> Some BOOL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Not <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> BOOL <span class="main">⇒</span> Some BOOL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Inverse <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> REAL <span class="main">⇒</span> Some REAL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Fact <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> INTEG <span class="main">⇒</span> Some INTEG <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Sqrt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> REAL <span class="main">⇒</span> Some REAL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Exp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> REAL <span class="main">⇒</span> Some REAL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Ln <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> REAL <span class="main">⇒</span> Some REAL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Pi <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> UNIT <span class="main">⇒</span> Some REAL <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Pow <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
                      PRODUCT REAL INTEG <span class="main">⇒</span> Some REAL
                    <span class="main">|</span> PRODUCT INTEG INTEG <span class="main">⇒</span> Some INTEG
                    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> PRODUCT <span class="bound">t</span> <span class="main"><span class="bound">_</span></span>  <span class="main">⇒</span> Some <span class="bound">t</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_type</span> Snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> PRODUCT <span class="main"><span class="bound">_</span></span> <span class="bound">t</span>  <span class="main">⇒</span> Some <span class="bound">t</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">de_bruijn_insert</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">de_bruijn_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> case_nat <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">expr_typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> expr <span class="main">⇒</span> pdf_type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span>_<span class="keyword3">/ </span><span class="keyword1">⊢</span><span class="keyword3">/ </span><span class="keyword3">(</span>_ <span class="keyword1">:</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  et_var<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> et_val<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Val <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">:</span></span> val_type <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> et_let<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> LetVar <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> et_op<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> op_type <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Operator <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> et_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span>  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">&gt;</span> <span class="main"><span class="free">:</span></span> PRODUCT <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> et_rand<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> dist_param_type <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Random <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span>  dist_result_type <span class="free"><span class="bound"><span class="entity">dst</span></span></span>"</span></span>
<span class="main">|</span> et_if<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="free">:</span></span> BOOL <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> et_fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Fail <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Semantics-expr_typing_cong'"><span class="command">lemma</span></span> expr_typing_cong'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> free_vars <span class="free">e</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ'</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_let <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">Γ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> et_let.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_let.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t1</span> <span class="skolem">Γ'</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> et_let.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> expr_typing.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> expr_typing.intros<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-expr_typing_cong"><span class="command">lemma</span></span> expr_typing_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> free_vars <span class="free">e</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">Γ'</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_typing_cong'<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_valE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Val <span class="free">v</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_varE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Var <span class="free">x</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_letE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> LetVar <span class="free">e1</span> <span class="free">e2</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_ifE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> IfThenElse <span class="free">b</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_opE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Operator <span class="free">oper</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_pairE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">&lt;</span><span class="free">e1</span><span class="main">,</span> <span class="free">e2</span><span class="main">&gt;</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_randE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Random <span class="free">dst</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> expr_typing_failE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Fail <span class="free">t</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-expr_typing_unique"><span class="command">lemma</span></span> expr_typing_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> expr_typing_letE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> expr_typing_opE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> expr_typing_pairE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> expr_typing_randE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> expr_typing_ifE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">expr_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> expr <span class="main">⇒</span> pdf_type option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>val_type <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>LetVar <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">of</span>
          Some <span class="bound">t</span> <span class="main">⇒</span> <span class="free">expr_type</span> <span class="main">(</span>case_nat <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>
        <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Operator <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> op_type <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
          <span class="main">(</span>Some <span class="bound">t1</span><span class="main">,</span> Some <span class="bound">t2</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>PRODUCT <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>
        <span class="main">|</span>  <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Random <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Some <span class="main">(</span>dist_param_type <span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
           Some <span class="main">(</span>dist_result_type <span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> Some BOOL <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
             <span class="main">(</span>Some <span class="bound">t</span><span class="main">,</span> Some <span class="bound">t'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">t'</span> <span class="keyword1">then</span> Some <span class="bound">t</span> <span class="keyword1">else</span> None
           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Fail <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Semantics-expr_type_Some_iff"><span class="command">lemma</span></span> expr_type_Some_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_type <span class="free">Γ</span> <span class="free">e</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> expr_typing.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> expr_typing_code<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span> <span class="main">=</span> expr_type_Some_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Countable types›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">countable_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_type <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">countable_type</span> UNIT <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">countable_type</span> BOOL <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">countable_type</span> INTEG <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">countable_type</span> REAL <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">countable_type</span> <span class="main">(</span>PRODUCT <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">countable_type</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> <span class="free">countable_type</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-countable_type_countable"><span class="command">lemma</span></span> countable_type_countable<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"countable_type <span class="free">t</span> <span class="main">⟹</span> countable <span class="main">(</span>space <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_measure_countable space_embed_measure space_pair_measure stock_measure.simps<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-countable_type_imp_count_space"><span class="command">lemma</span></span> countable_type_imp_count_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"countable_type <span class="free">t</span> <span class="main">⟹</span> stock_measure <span class="free">t</span> <span class="main">=</span> count_space <span class="main">(</span>type_universe <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> space_stock_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> countable<span class="main">:</span> <span class="quoted"><span class="quoted">"countable_type <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"countable_type <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> PRODUCT.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> countable<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> B <span class="main">=</span> PRODUCT.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> countable<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> count_space <span class="main">(</span>space <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> stock_measure.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> B<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> pair_measure_countable<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> countable_type_countable <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> countable <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> space_stock_measure<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> embed_measure_count_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-return_val_countable"><span class="command">lemma</span></span> return_val_countable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable_type <span class="main">(</span>val_type <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"return_val <span class="free">v</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="main">(</span>val_type <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>indicator <span class="main">{</span><span class="free">v</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"count_space <span class="main">(</span>type_universe <span class="main">(</span>val_type <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="var">?M1</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M2</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> indicator <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">x</span>
                                              <span class="main">∂</span>count_space <span class="main">(</span>type_universe <span class="main">(</span>val_type <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def emeasure_density countable_type_imp_count_space<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">x</span> <span class="main">::</span> ennreal<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">(</span><span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> Int_commute<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nn_integral <span class="var">?M3</span> <span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M3</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_indicator<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M1</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bool_to_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_to_int</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_bool_to_int"><span class="command">lemma</span></span> measurable_bool_to_int<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bool_to_int <span class="main">∈</span> measurable <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_count_space<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bool_to_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_to_real</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_bool_to_real"><span class="command">lemma</span></span> measurable_bool_to_real<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bool_to_real <span class="main">∈</span> borel_measurable <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> borel_measurable_count_space<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_ln</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_ln</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> ln <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-safe_ln_gt_0"><span class="command">lemma</span></span> safe_ln_gt_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> safe_ln <span class="free">x</span> <span class="main">=</span> ln <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_ln_def<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-borel_measurable_safe_ln"><span class="command">lemma</span></span> borel_measurable_safe_ln<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_ln <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_ln_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_sqrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_sqrt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> sqrt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-safe_sqrt_ge_0"><span class="command">lemma</span></span> safe_sqrt_ge_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> safe_sqrt <span class="free">x</span> <span class="main">=</span> sqrt <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_sqrt_def<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-borel_measurable_safe_sqrt"><span class="command">lemma</span></span> borel_measurable_safe_sqrt<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_sqrt <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_sqrt_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">op_sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_operator <span class="main">⇒</span> val <span class="main">⇒</span> val"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Add <span class="main">=</span> lift_RealIntVal2 <span class="main">(+)</span> <span class="main">(+)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Mult <span class="main">=</span> lift_RealIntVal2 <span class="main">(*)</span> <span class="main">(*)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Minus <span class="main">=</span> lift_RealIntVal uminus uminus"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Equals <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">&lt;|</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">|&gt;</span> <span class="main">⇒</span> BoolVal <span class="main">(</span><span class="bound">v1</span> <span class="main">=</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Less <span class="main">=</span> lift_Comp <span class="main">(&lt;)</span> <span class="main">(&lt;)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Or <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">&lt;|</span>BoolVal <span class="bound">a</span><span class="main">,</span> BoolVal <span class="bound">b</span><span class="main">|&gt;</span> <span class="main">⇒</span> BoolVal <span class="main">(</span><span class="bound">a</span> <span class="main">∨</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> And <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">&lt;|</span>BoolVal <span class="bound">a</span><span class="main">,</span> BoolVal <span class="bound">b</span><span class="main">|&gt;</span> <span class="main">⇒</span> BoolVal <span class="main">(</span><span class="bound">a</span> <span class="main">∧</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Not <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> BoolVal <span class="bound">a</span> <span class="main">⇒</span> BoolVal <span class="main">(</span><span class="main">¬</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> <span class="main">(</span>Cast <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
                        INTEG <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span> BoolVal <span class="bound">b</span> <span class="main">⇒</span> IntVal <span class="main">(</span>bool_to_int <span class="bound">b</span><span class="main">)</span>
                                  <span class="main">|</span> RealVal <span class="bound">r</span> <span class="main">⇒</span> IntVal <span class="main">(</span>floor <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">|</span> REAL <span class="main">⇒</span>  <span class="main">(</span><span class="main">λ</span> BoolVal <span class="bound">b</span> <span class="main">⇒</span> RealVal <span class="main">(</span>bool_to_real <span class="bound">b</span><span class="main">)</span>
                                  <span class="main">|</span> IntVal <span class="bound">i</span> <span class="main">⇒</span> RealVal <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Inverse <span class="main">=</span> lift_RealVal inverse"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Fact <span class="main">=</span> lift_IntVal <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">::</span>int<span class="main">.</span> fact <span class="main">(</span>nat <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Sqrt <span class="main">=</span> lift_RealVal safe_sqrt"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Exp <span class="main">=</span> lift_RealVal exp"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Ln <span class="main">=</span> lift_RealVal safe_ln"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Pi <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> RealVal pi<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Pow <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">&lt;|</span>RealVal <span class="bound">x</span><span class="main">,</span> IntVal <span class="bound">n</span><span class="main">|&gt;</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> RealVal <span class="main">0</span> <span class="keyword1">else</span> RealVal <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> nat <span class="bound">n</span><span class="main">)</span>
                 <span class="main">|</span> <span class="main">&lt;|</span>IntVal <span class="bound">x</span><span class="main">,</span> IntVal <span class="bound">n</span><span class="main">|&gt;</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> IntVal <span class="main">0</span> <span class="keyword1">else</span> IntVal <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> nat <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Fst <span class="main">=</span> fst <span class="main">∘</span> extract_pair"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">op_sem</span> Snd <span class="main">=</span> snd <span class="main">∘</span> extract_pair"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The semantics of expressions. Assumes that the expression given is well-typed.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">expr_sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> expr <span class="main">⇒</span> val measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> return_val <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> return_val <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">v</span> <span class="main">←</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">;</span>
        <span class="free">expr_sem</span> <span class="main">(</span><span class="bound">v</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>
      <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x</span> <span class="main">←</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
        return_val <span class="main">(</span>op_sem <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="bound">x</span><span class="main">)</span>
      <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">&gt;</span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x</span> <span class="main">←</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span>
        <span class="bound">y</span> <span class="main">←</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span>
        return_val <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">|&gt;</span>
      <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">b'</span> <span class="main">←</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">b'</span> <span class="main">=</span> TRUE <span class="keyword1">then</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">else</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>
     <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Random <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">x</span> <span class="main">←</span> <span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
       dist_measure <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="bound">x</span>
     <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Fail <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> null_measure <span class="main">(</span>stock_measure <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-expr_sem_pair_vars"><span class="command">lemma</span></span> expr_sem_pair_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_sem <span class="free">σ</span> <span class="main">&lt;</span>Var <span class="free">x</span><span class="main">,</span> Var <span class="free">y</span><span class="main">&gt;</span> <span class="main">=</span> return_val <span class="main">&lt;|</span><span class="free">σ</span> <span class="free">x</span><span class="main">,</span> <span class="free">σ</span> <span class="free">y</span><span class="main">|&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def bind_return<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"PRODUCT <span class="main">(</span>val_type <span class="main">(</span><span class="free">σ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>val_type <span class="main">(</span><span class="free">σ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
           <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_cong_simp<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Well-typed expressions produce a result in the measure space that corresponds to their type
›</span></span>

<span class="keyword1" id="PDF_Semantics-op_sem_val_type"><span class="command">lemma</span></span> op_sem_val_type<span class="main">:</span>
    <span class="quoted"><span class="quoted">"op_type <span class="free">oper</span> <span class="main">(</span>val_type <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> val_type <span class="main">(</span>op_sem <span class="free">oper</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oper</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split if_split_asm pdf_type.split_asm
                        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal_def lift_Comp_def
                              lift_IntVal_def lift_RealVal_def lift_RealIntVal2_def
                        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PROD_E INTEG_E REAL_E<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-sets_expr_sem"><span class="command">lemma</span></span> sets_expr_sem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">w</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> free_vars <span class="free">w</span><span class="main">.</span> val_type <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
       sets <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_var <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_val <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_let <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A et_let <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="main">(</span>case_nat <span class="var">?v</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_nonempty<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_op <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">oper</span> <span class="skolem">t'</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> et_op.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> et_op.prems
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> et_op <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_nonempty return_val_def op_sem_val_type<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_pair <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t1</span>"</span></span>
                <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_eq_imp_space_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> et_pair.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_nonempty return_val_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_rand <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">dst</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> et_rand.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> et_rand.prems
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="main">(</span>dist_param_type <span class="skolem">dst</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sets_bind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_if <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">t</span> <span class="skolem">e2</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure BOOL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> et_if.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_if.IH<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"sets <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> et_if.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_if.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_nonempty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Semantics-space_expr_sem"><span class="command">lemma</span></span> space_expr_sem<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">w</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> free_vars <span class="free">w</span><span class="main">.</span> val_type <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span>
      <span class="main">⟹</span> space <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> space_stock_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> sets_expr_sem sets_eq_imp_space_eq<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-measurable_expr_sem_eq"><span class="command">lemma</span></span> measurable_expr_sem_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span>
       measurable <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets sets_expr_sem<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-measurable_expr_semI"><span class="command">lemma</span></span> measurable_expr_semI<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span>
       <span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_expr_sem_eq<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-expr_sem_eq_on_vars"><span class="command">lemma</span></span> expr_sem_eq_on_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>free_vars <span class="free">e</span> <span class="main">⟹</span> <span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> expr_sem <span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e</span> <span class="main">=</span> expr_sem <span class="free">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">σ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> LetVar.prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ1</span> <span class="skolem">e1</span> <span class="main">=</span> expr_sem <span class="skolem">σ2</span> <span class="skolem">e1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LetVar.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> LetVar.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> A<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_cong LetVar.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Operator <span class="skolem">oper</span> <span class="skolem">e</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Operator.IH<span class="main">[</span><span class="operator">OF</span> Operator.prems<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Pair.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ1</span> <span class="skolem">e1</span> <span class="main">=</span> expr_sem <span class="skolem">σ2</span> <span class="skolem">e1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pair.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Pair.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ1</span> <span class="skolem">e2</span> <span class="main">=</span> expr_sem <span class="skolem">σ2</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pair.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Random.prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ1</span> <span class="skolem">e</span> <span class="main">=</span> expr_sem <span class="skolem">σ2</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Random.IH<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> A<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ1</span> <span class="skolem">b</span> <span class="main">=</span> expr_sem <span class="skolem">σ2</span> <span class="skolem">b</span>"</span></span>
          <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ1</span> <span class="skolem">e1</span> <span class="main">=</span> expr_sem <span class="skolem">σ2</span> <span class="skolem">e1</span>"</span></span>
          <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ1</span> <span class="skolem">e2</span> <span class="main">=</span> expr_sem <span class="skolem">σ2</span> <span class="skolem">e2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IfThenElse.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IfThenElse.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> expr_sem.simps A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Measurability›</span></span>

<span class="keyword1" id="PDF_Semantics-borel_measurable_eq"><span class="command">lemma</span></span> borel_measurable_eq<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_equals"><span class="command">lemma</span></span> measurable_equals<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> REAL
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> extract_real <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure REAL <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure REAL<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_pair_measure <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> REAL_E<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure REAL <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure REAL<span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?g</span> <span class="main">(</span>fst <span class="main">(</span>extract_pair <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span>extract_pair <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                <span class="var">?g</span> <span class="main">(</span>snd <span class="main">(</span>extract_pair <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>extract_pair <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_pair_measure<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> PROD_E<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">note</span></span> PRODUCT<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_measure_countable stock_measure.simps<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-measurable_equals_stock_measure"><span class="command">lemma</span></span> measurable_equals_stock_measure<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> measurable_compose<span class="main">[</span><span class="operator">OF</span> measurable_Pair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> measurable_equals<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Semantics-measurable_op_sem"><span class="command">lemma</span></span> measurable_op_sem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"op_type <span class="free">oper</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"op_sem <span class="free">oper</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">oper</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fst <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Snd <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Equals <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Pow <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
      g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">if</span></span> extract_int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="main"><span class="main">0</span></span> <span class="keyword1"><span class="keyword1">then</span></span> RealVal <span class="main"><span class="main">0</span></span> <span class="keyword1"><span class="keyword1">else</span></span> RealVal <span class="main"><span class="main">(</span></span>extract_real <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">^</span></span> nat <span class="main"><span class="main">(</span></span>extract_int <span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_pair_measure <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> REAL_E INTEG_E<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Less <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_case_stock_measurable<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shift_var_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname set <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift_var_set</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Semantics-shift_var_set_0"><span class="command">lemma</span></span> shift_var_set_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> shift_var_set <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-shift_var_set_Suc"><span class="command">lemma</span></span> shift_var_set_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">x</span> <span class="main">∈</span> shift_var_set <span class="free">V</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-case_nat_update_0"><span class="command">lemma</span></span> case_nat_update_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat <span class="free">x</span> <span class="free">σ</span><span class="main">)</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="free">y</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-case_nat_delete_var_1"><span class="command">lemma</span></span> case_nat_delete_var_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"case_nat <span class="free">x</span> <span class="main">(</span>case_nat <span class="free">y</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∘</span> case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="free">x</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-delete_var_1_vimage"><span class="command">lemma</span></span> delete_var_1_vimage<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> shift_var_set <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>


<span class="keyword1" id="PDF_Semantics-measurable_case_nat"><span class="command">lemma</span></span> measurable_case_nat<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="free">R</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> measurable <span class="free">R</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">V</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> case_nat <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">R</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">N</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="main">λ</span><span class="bound">x</span><span class="main">∈</span>shift_var_set <span class="free">V</span><span class="main">.</span> case_nat <span class="bound">t</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>
          <span class="main">∈</span> measurable <span class="main">(</span><span class="free">N</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> PiM <span class="free">V</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>PiM <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">N</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> space <span class="main">(</span>PiM <span class="free">V</span> <span class="free">M</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">V</span> <span class="main">⟹</span> undefined <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> space_PiM<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> PiE_arb<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">f</span><span class="main">)</span><span class="main">.</span> case_nat <span class="bound">t</span> <span class="bound">f</span><span class="main">)</span>
           <span class="main">∈</span> measurable <span class="main">(</span><span class="free">N</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> PiM <span class="free">V</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>PiM <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">N</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?P</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong ext<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_image_mem_iff space_pair_measure shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Semantics-measurable_case_nat'"><span class="command">lemma</span></span> measurable_case_nat'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="free">R</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> measurable <span class="free">R</span> <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> case_nat <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
           measurable <span class="free">R</span> <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 case_nat <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Semantics-case_nat_in_state_measure"><span class="command">lemma</span></span> case_nat_in_state_measure<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> type_universe <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">x</span> <span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t1</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_case_nat'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_ident_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_const<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Semantics-subset_shift_var_set"><span class="command">lemma</span></span> subset_shift_var_set<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Suc <span class="main">-`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> shift_var_set <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-measurable_expr_sem"><span class="command">lemma</span></span> measurable_expr_sem<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>
                                         <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_var <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_val <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> et_var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> measurable_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_component_singleton<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_val <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_const subprob_space_return
                      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_subprob_algebra return_val_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_let <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">V</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> stock_measure <span class="main">(</span>case_nat <span class="skolem">t1</span> <span class="skolem">Γ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 case_nat <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> et_let.prems <span class="keyword2"><span class="keyword">and</span></span> et_let.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> et_let.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ et_let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"shift_var_set <span class="skolem"><span class="skolem">V</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_shift_var_set<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_op <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">oper</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_bind2 measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_return_val<span class="main"><span class="main">]</span></span>
                              measurable_op_sem <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> measurable_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_pair <span class="skolem">t</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> et_pair <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_bind<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_bind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_fst<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_return_val<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_rand <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">dst</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> et_rand.prems <span class="keyword2"><span class="keyword">and</span></span> et_rand.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> et_rand.IH measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_snd<span class="main"><span class="main">]</span></span>
                     measurable_bind measurable_dist_measure<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_if <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">t</span> <span class="skolem">e2</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span>
                      measurable <span class="main">(</span>state_measure <span class="skolem">V</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> et_if.prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">b</span> BOOL"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">e1</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">e2</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_if.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_bind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_fail <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_subprob_algebra subprob_spaceI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Randomfree expressions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">randomfree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>Val <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∧</span> <span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>Operator <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>LetVar <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∧</span> <span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>IfThenElse <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∧</span> <span class="free">randomfree</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>Random <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">randomfree</span> <span class="main">(</span>Fail <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">expr_sem_rf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> expr <span class="main">⇒</span> val"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">&lt;|</span><span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">|&gt;</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Operator <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> op_sem <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">(</span><span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>LetVar <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">expr_sem_rf</span> <span class="main">(</span><span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>IfThenElse <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> BoolVal True <span class="keyword1">then</span> <span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">else</span> <span class="free">expr_sem_rf</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Random <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_sem_rf</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Fail <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>


<span class="keyword1" id="PDF_Semantics-measurable_expr_sem_rf"><span class="command">lemma</span></span> measurable_expr_sem_rf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> randomfree <span class="free">e</span> <span class="main">⟹</span> free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_val <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_const <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_var <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_component_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_pair <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> et_pair <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_op <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">oper</span> <span class="skolem">t'</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_op_sem<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_let <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> M1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="skolem">V</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> M2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="skolem">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t1</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>
                                           <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_shift_var_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> et_let.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">V</span></span><span class="main"><span class="main">]</span></span> et_let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"shift_var_set <span class="skolem">V</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> expr_sem_rf <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="skolem">V</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> measurable_comp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_Pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_ident_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M1<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_case_nat'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_snd<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_fst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> M2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_sem_rf_def<span class="main">)</span>

<span class="keyword1" id="PDF_Semantics-expr_sem_rf_sound"><span class="command">lemma</span></span> expr_sem_rf_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> randomfree <span class="free">e</span> <span class="main">⟹</span> free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
       return_val <span class="main">(</span>expr_sem_rf <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="free">σ</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_val <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_var <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_pair <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">V</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"state_measure <span class="skolem">V</span> <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> et_pair.hyps <span class="keyword2"><span class="keyword">and</span></span> et_pair.prems
    <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         e2<span class="main">:</span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> et_pair.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> e1 <span class="keyword2"><span class="keyword">and</span></span> et_pair.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> e1<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> space_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> et_pair.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> state_measure_var_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span> <span class="main">∈</span> type_universe <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> e2 <span class="keyword2"><span class="keyword">and</span></span> et_pair.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> e2<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> space_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> et_pair.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> state_measure_var_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span> <span class="main">∈</span> type_universe <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="main">&lt;</span><span class="skolem">e1</span><span class="main">,</span> <span class="skolem">e2</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span> <span class="main">⤜</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span> <span class="main">=</span> return <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> et_pair.prems return_val_def A<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">...</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> space <span class="main">(</span>return <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> type_universe <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              return <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> et_pair.prems return_val_def B<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> return <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⤜</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> return <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> space <span class="main">(</span>return <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">=</span> return <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def v w<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v B
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT <span class="skolem"><span class="skolem"><span class="skolem">t1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="skolem">e2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="skolem">v</span><span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"return <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> return_val <span class="main">(</span><span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             return_val <span class="main">(</span><span class="main">&lt;|</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_return_val<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="main">(</span><span class="main">&lt;</span><span class="skolem">e1</span><span class="main">,</span><span class="skolem">e2</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="main">&lt;</span><span class="skolem">e1</span><span class="main">,</span> <span class="skolem">e2</span><span class="main">&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_if <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">t</span> <span class="skolem">e2</span> <span class="skolem">V</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> expr_sem <span class="skolem">σ</span> <span class="bound">e</span> <span class="main">=</span> return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> et_if.prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">e1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> et_if.IH<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> et_if.prems <span class="keyword2"><span class="keyword">and</span></span> et_if.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> type_universe BOOL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> space_expr_sem<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_var_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> BOOL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A return_val_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> et_if.hyps <span class="keyword2"><span class="keyword">and</span></span> et_if.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_expr_sem<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A bind_return_val''<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_op <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">oper</span> <span class="skolem">t'</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"PiM <span class="skolem">V</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> et_op.prems <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_op.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">with</span></span> et_op.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> e<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> space_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> et_op.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> state_measure_var_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span> <span class="main">∈</span> type_universe <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> et_op.prems e
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="main">(</span>Operator <span class="skolem">oper</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span>
                 return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> return_val <span class="main">(</span>op_sem <span class="skolem">oper</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> return_val <span class="main">(</span>op_sem <span class="skolem">oper</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> return_val_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bind_return<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_op_sem measurable_return_val<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A et_op.hyps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="main">(</span>Operator <span class="skolem">oper</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="main">(</span>Operator <span class="skolem">oper</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>et_let <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">t1</span> <span class="skolem">e2</span> <span class="skolem">t2</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"state_measure <span class="skolem">V</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"state_measure <span class="main">(</span>shift_var_set <span class="skolem">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t1</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> et_let.prems <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="skolem">e1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> et_let.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">V</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> et_let.prems <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> e1<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> space_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> et_let.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> state_measure_var_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span> <span class="main">∈</span> type_universe <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> et_let.prems <span class="keyword1"><span class="command">have</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="var">?N</span> <span class="main">⟹</span> return_val <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="bound">σ</span> <span class="skolem">e2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_shift_var_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> et_let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"shift_var_set <span class="skolem"><span class="skolem"><span class="skolem">V</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> et_let.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span>
                              return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> expr_sem <span class="main">(</span>case_nat <span class="bound">v</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> et_let.prems
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> return_val <span class="main">(</span>expr_sem_rf <span class="main">(</span>case_nat <span class="bound">v</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> e2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> et_let <span class="keyword1"><span class="command">have</span></span> Me2<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="var">?N</span> <span class="main">(</span>stock_measure <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_shift_var_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_expr_sem_rf<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="skolem">t1</span><span class="main">)</span> <span class="var">?N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="main">∈</span> space <span class="var">?M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> return_val <span class="main">(</span>expr_sem_rf <span class="main">(</span>case_nat <span class="bound">v</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              return_val <span class="main">(</span>expr_sem_rf <span class="var">?σ'</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="main">∈</span> space <span class="var">?M</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> return_val_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bind_return<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> A<span class="main">)</span>
     <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_return_val<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Semantics-val_type_expr_sem_rf"><span class="command">lemma</span></span> val_type_expr_sem_rf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"randomfree <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"type_universe <span class="main">(</span>val_type <span class="main">(</span>expr_sem_rf <span class="free">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> space <span class="main">(</span>return_val <span class="main">(</span>expr_sem_rf <span class="free">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>expr_sem_rf <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="free">σ</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_rf_sound<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">...</span> <span class="main">=</span> type_universe <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> space_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Semantics-expr_sem_rf_eq_on_vars"><span class="command">lemma</span></span> expr_sem_rf_eq_on_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>free_vars <span class="free">e</span> <span class="main">⟹</span> <span class="free">σ1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">σ2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> expr_sem_rf <span class="free">σ1</span> <span class="free">e</span> <span class="main">=</span> expr_sem_rf <span class="free">σ2</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ1</span></span> <span class="quoted"><span class="free">σ2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Operator <span class="skolem">oper</span> <span class="skolem">e</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Operator.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e1</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LetVar.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> free_vars <span class="skolem">e2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="main">(</span>expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">σ1</span> <span class="skolem">y</span> <span class="main">=</span> case_nat <span class="main">(</span>expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">σ2</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LetVar<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="main">(</span>case_nat <span class="main">(</span>expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">σ1</span><span class="main">)</span> <span class="skolem">e2</span> <span class="main">=</span>
           expr_sem_rf <span class="main">(</span>case_nat <span class="main">(</span>expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e1</span><span class="main">)</span> <span class="skolem">σ2</span><span class="main">)</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LetVar.IH<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e1</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e1</span>"</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e2</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pair.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">b</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e1</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e1</span>"</span></span>
       <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e2</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IfThenElse.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IfThenElse<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">σ1</span> <span class="skolem">e</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ2</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Random.IH<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Random<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="comment1">(*
subsection {* Substitution of free variables *}

primrec expr_subst :: "expr ⇒ expr ⇒ vname ⇒ expr" ("_⟨_'/_⟩" [1000,0,0] 999) where
  "(Val v)⟨_/_⟩ = Val v"
| "(Var y)⟨f/x⟩ = (if y = x then f else Var y)"
| "&lt;e1,e2&gt;⟨f/x⟩ = &lt;e1⟨f/x⟩, e2⟨f/x⟩&gt;"
| "(&lt;oper&gt; e)⟨f/x⟩ = &lt;oper&gt; (e⟨f/x⟩)"
| "(LET e1 IN e2)⟨f/x⟩ = LET y = e1⟨f/x⟩ IN if y = x then e2 else e2⟨f/x⟩"
| "(IF b THEN e1 ELSE e2)⟨f/x⟩ = IF b⟨f/x⟩ THEN e1⟨f/x⟩ ELSE e2⟨f/x⟩"
| "(Random dst e)⟨f/x⟩ = Random dst (e⟨f/x⟩)"
| "(Fail t)⟨f/x⟩ = Fail t"

primrec bound_vars :: "expr ⇒ vname set" where
  "bound_vars (Val _) = {}"
| "bound_vars (Var _) = {}"
| "bound_vars &lt;e1,e2&gt; = bound_vars e1 ∪ bound_vars e2"
| "bound_vars (&lt;_&gt; e) = bound_vars e"
| "bound_vars (LET x = e1 IN e2) = {x} ∪ bound_vars e1 ∪ bound_vars e2"
| "bound_vars (IF b THEN e1 ELSE e2) = bound_vars b ∪ bound_vars e1 ∪ bound_vars e2"
| "bound_vars (Random _ e) = bound_vars e"
| "bound_vars (Fail _) = {}"

lemma expr_typing_eq_on_free_vars:
  "Γ1 ⊢ e : t ⟹ (⋀x. x ∈ free_vars e ⟹ Γ1 x = Γ2 x) ⟹ Γ2 ⊢ e : t"
proof (induction arbitrary: Γ2 rule: expr_typing.induct)
  case et_let
  thus ?case by (intro expr_typing.intros) auto
qed (auto intro!: expr_typing.intros simp del: fun_upd_apply)

lemma expr_typing_subst:
  assumes "Γ ⊢ e : t1" "Γ ⊢ f : t'" "Γ x = t'" "free_vars f ∩ bound_vars e = {}"
  shows "Γ ⊢ e⟨f/x⟩ : t1"
using assms
proof (induction rule: expr_typing.induct)
  case (et_let Γ e1 t1 y e2 t2)
  from et_let.prems have A: "Γ ⊢ e1⟨f/x⟩ : t1" by (intro et_let.IH) auto
  show ?case
  proof (cases "y = x")
    assume "y ≠ x"
    from et_let.prems have "Γ(y := t1) ⊢ f : t'"
      by (intro expr_typing_eq_on_free_vars[OF `Γ ⊢ f : t'`]) auto
    moreover from `y ≠ x` have "(Γ(y := t1)) x = Γ x" by simp
    ultimately have "Γ(y := t1) ⊢ e2⟨f/x⟩ : t2" using et_let.prems
      by (intro et_let.IH) (auto simp del: fun_upd_apply)
    with A and `y ≠ x` show ?thesis by (auto intro: expr_typing.intros)
  qed (insert et_let, auto intro!: expr_typing.intros simp del: fun_upd_apply)
qed (insert assms(2), auto intro: expr_typing.intros)

lemma expr_subst_randomfree:
  assumes "Γ ⊢ f : t" "randomfree f" "free_vars f ⊆ V" "free_vars f ∩ bound_vars e = {}"
          "σ ∈ space (state_measure V Γ)"
  shows   "expr_sem σ (e⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ)) e"
using assms(1,3,4,5)
proof (induction e arbitrary: σ V Γ)
  case (Pair e1 e2 σ V Γ)
    from Pair.prems have "expr_sem σ (e1⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ)) e1"
                     and "expr_sem σ (e2⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ)) e2"
      by (auto intro!: Pair.IH[of Γ V σ])
    thus ?case by (simp del: fun_upd_apply)
next
  case (IfThenElse b e1 e2 σ V Γ)
    from IfThenElse.prems
      have "expr_sem σ (b⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ)) b"
           "expr_sem σ (e1⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ)) e1"
           "expr_sem σ (e2⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ)) e2"
      by (auto intro!: IfThenElse.IH[of Γ V σ])
    thus ?case by (simp only: expr_sem.simps expr_subst.simps)
next
  case (LetVar y e1 e2)
  from LetVar.prems have A: "expr_sem σ (e1⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ)) e1"
    by (intro LetVar.IH) auto
  show ?case
  proof (cases "y = x")
    assume "y = x"
    with LetVar.prems show ?case by (auto simp add: A simp del: fun_upd_apply)
  next
    assume "y ≠ x"
    {
      fix v assume "v ∈ space (expr_sem (σ(x := expr_sem_rf f σ)) e1)"
      let ?σ' = "σ(y := v)" and ?Γ' = "Γ(y := val_type v)"
      from LetVar.prems have "Γ(y := val_type v) ⊢ f : t" by (auto intro: expr_typing_eq_on_free_vars)
      moreover from LetVar.prems have "?σ' ∈ space (state_measure (insert y V) ?Γ')"
        by (auto simp: state_measure_def space_PiM split: if_split_asm)
      ultimately have "expr_sem ?σ' (e2⟨f/x⟩) = expr_sem (?σ'(x := expr_sem_rf f ?σ')) e2"
        using LetVar.prems and `y ≠ x`
        by (intro LetVar.IH(2)[of "Γ(y := val_type v)" "insert y V"]) (auto simp del: fun_upd_apply)
      also from LetVar.prems have "expr_sem_rf f ?σ' = expr_sem_rf f σ"
        by (intro expr_sem_rf_eq_on_vars) auto
      finally have "expr_sem (σ(y := v)) (e2⟨f/x⟩) = expr_sem (σ(x := expr_sem_rf f σ, y := v)) e2"
        using `y ≠ x` by (subst fun_upd_twist) (simp_all del: fun_upd_apply)
    }
    with A and `y ≠ x` show ?thesis by (auto simp del: fun_upd_apply intro!: bind_cong)
  qed
qed (simp_all add: expr_sem_rf_sound assms)

lemma stock_measure_context_upd:
  "(λy. stock_measure ((Γ(x := t)) y)) = (λy. stock_measure (Γ y))(x := stock_measure t)"
  by (intro ext) simp

lemma Let_det_eq_subst:
  assumes "Γ ⊢ LET x = f IN e : t" "randomfree f" "free_vars (LET x = f IN e) ⊆ V"
          "free_vars f ∩ bound_vars e = {}" "σ ∈ space (state_measure V Γ)"
  shows   "expr_sem σ (LET x = f IN e) = expr_sem σ (e⟨f/x⟩)"
proof-
  from assms(1) obtain t' where t1: "Γ ⊢ f : t'" and t2: "Γ(x := t') ⊢ e : t" by auto
  with assms have "expr_sem σ (LET x = f IN e) =
                       return_val (expr_sem_rf f σ) ⤜ (λv. expr_sem (σ(x := v)) e)" (is "_ = ?M")
    by (auto simp: expr_sem_rf_sound)
  also have "(λσ. expr_sem σ e) ∘ (λ(σ,v). σ(x := v)) ∘ (λv. (σ,v)) ∈
                 measurable (stock_measure ((Γ(x := t')) x)) (subprob_algebra (stock_measure t))"
    apply (intro measurable_comp, rule measurable_Pair1', rule assms)
    apply (subst fun_upd_same, unfold state_measure_def)
    apply (rule measurable_add_dim', subst stock_measure_context_upd[symmetric])
    apply (insert assms, auto intro!: measurable_expr_sem[unfolded state_measure_def] t1 t2
                              simp del: fun_upd_apply)
    done
  hence "(λv. expr_sem (σ(x := v)) e) ∈
                 measurable (stock_measure ((Γ(x := t')) x)) (subprob_algebra (stock_measure t))"
    by (simp add: o_def)
  with assms have "?M = expr_sem (σ(x := expr_sem_rf f σ)) e"
    unfolding return_val_def
    by (intro bind_return) (auto simp: val_type_expr_sem_rf[OF t1]
                                       type_universe_def simp del: type_universe_type)
  also from assms t1 t2 have "... = expr_sem σ (e⟨f/x⟩)"
    by (intro expr_subst_randomfree[symmetric]) auto
  finally show ?thesis .
qed *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PDF_Density_Contexts">
<div class="head">
<h1>Theory PDF_Density_Contexts</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Density_Contexts.thy
  Authors: Manuel Eberl
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Density Contexts›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Density_Contexts
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PDF_Semantics.html">PDF_Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_proj_state_measure"><span class="command">lemma</span></span> measurable_proj_state_measure<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_dens_ctxt_fun_upd"><span class="command">lemma</span></span> measurable_dens_ctxt_fun_upd<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">V</span> <span class="main">=</span> <span class="free">V'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span>
    <span class="free">g</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">ω</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">g</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_fun_upd<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> J<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">V'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_case_nat_Suc_PiM"><span class="command">lemma</span></span> measurable_case_nat_Suc_PiM<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>PiM <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">M</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PiM <span class="free">A</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">λ</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable
      <span class="main">(</span>PiM <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">M</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> case_nat <span class="free">M</span> <span class="free">N</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟷</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_cong ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_case_nat_Suc"><span class="command">lemma</span></span> measurable_case_nat_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="free">A</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">λ</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable
      <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟷</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_cong ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A density context holds a set of variables <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, their types (using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), and a
common density function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the finite product space of all the variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> takes a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span> <span class="main"><span class="main">∈</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">Π<span class="hidden">⇩</span><sub>E</sub></span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">∈</span></span><span class="free"><span class="free">V</span></span><span class="main"><span class="main">.</span></span> type_universe <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Γ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and returns the common density
of these variables.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> dens_ctxt <span class="main">=</span> <span class="quoted"><span class="quoted">"vname set <span class="main">×</span> vname set <span class="main">×</span> <span class="main">(</span>vname <span class="main">⇒</span> pdf_type<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>state <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> expr_density <span class="main">=</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> val <span class="main">⇒</span> ennreal"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_dens_ctxt</span> <span class="main">::</span> <span class="quoted">dens_ctxt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_dens_ctxt</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_measure'</span>
    <span class="main">::</span> <span class="quoted"><span class="quoted">"vname set <span class="main">⇒</span> vname set <span class="main">⇒</span> <span class="main">(</span>vname <span class="main">⇒</span> pdf_type<span class="main">)</span> <span class="main">⇒</span> state <span class="main">⇒</span> state measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_measure'</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span>
       distr <span class="main">(</span>state_measure <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The marginal density of a variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is obtained by integrating the common density
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over all the remaining variables.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">marg_dens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dens_ctxt <span class="main">⇒</span> vname <span class="main">⇒</span> expr_density"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">marg_dens</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">V'</span><span class="main">,</span><span class="bound">Γ</span><span class="main">,</span><span class="bound">δ</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">ρ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="bound">δ</span> <span class="main">(</span>merge <span class="bound">V</span> <span class="bound">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span><span class="bound">V</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">Γ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">marg_dens2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dens_ctxt <span class="main">⇒</span> vname <span class="main">⇒</span> vname <span class="main">⇒</span> expr_density"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">marg_dens2</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">V'</span><span class="main">,</span><span class="bound">Γ</span><span class="main">,</span><span class="bound">δ</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ρ</span> <span class="bound">v</span><span class="main">.</span>
       <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="bound">δ</span> <span class="main">(</span>merge <span class="bound">V</span> <span class="bound">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> fst <span class="main">(</span>extract_pair <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span> <span class="main">:=</span> snd <span class="main">(</span>extract_pair <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>
           <span class="main">∂</span>state_measure <span class="main">(</span><span class="bound">V</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="bound">Γ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dens_ctxt_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dens_ctxt <span class="main">⇒</span> state <span class="main">⇒</span> state measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dens_ctxt_measure</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">V'</span><span class="main">,</span><span class="bound">Γ</span><span class="main">,</span><span class="bound">δ</span><span class="main">)</span> <span class="bound">ρ</span><span class="main">.</span> density <span class="main">(</span>state_measure' <span class="bound">V</span> <span class="bound">V'</span> <span class="bound">Γ</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">δ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">branch_prob</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dens_ctxt <span class="main">⇒</span> state <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">branch_prob</span> <span class="free"><span class="bound"><span class="entity">𝒴</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> emeasure <span class="main">(</span>dens_ctxt_measure <span class="free"><span class="bound"><span class="entity">𝒴</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>dens_ctxt_measure <span class="free"><span class="bound"><span class="entity">𝒴</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Density_Contexts-dens_ctxt_measure_nonempty"><span class="command">lemma</span></span> dens_ctxt_measure_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"space <span class="main">(</span>dens_ctxt_measure <span class="free">𝒴</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">𝒴</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Density_Contexts-sets_dens_ctxt_measure_eq"><span class="command">lemma</span></span> sets_dens_ctxt_measure_eq<span class="main">[</span><span class="operator">measurable_cong</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"sets <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_dens_ctxt_measure_eq"><span class="command">lemma</span></span> measurable_dens_ctxt_measure_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"measurable <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-space_dens_ctxt_measure"><span class="command">lemma</span></span> space_dens_ctxt_measure<span class="main">:</span>
    <span class="quoted"><span class="quoted">"space <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_dist_to_dens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_dist <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> val <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> val <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_dist_to_dens</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">*</span> dist_dens <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="main">(</span>dist_param_type <span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_var</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_remove_var"><span class="command">lemma</span></span> measurable_remove_var<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"remove_var <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">λ</span><span class="bound">x</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable
      <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="free">V</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">V</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
                       <span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> space_PiM<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> PiE_arb<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_PiM shift_var_set_def inj_image_mem_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="var">?M</span> <span class="main">⟷</span> remove_var <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> remove_var_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">undefined</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_case_nat_undefined"><span class="command">lemma</span></span> measurable_case_nat_undefined<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_nat undefined <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">A</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">λ</span><span class="bound">x</span><span class="main">∈</span>Suc<span class="main">`</span><span class="free">A</span><span class="main">.</span> case_nat undefined <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_restrict<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="var">?M</span> <span class="main">⟷</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong ext<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_dens</span>
     <span class="main">::</span> <span class="quoted"><span class="quoted">"vname set <span class="main">⇒</span> vname set <span class="main">⇒</span> expr_density <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> state <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_dens</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span>remove_var <span class="bound">σ</span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>remove_var <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">if_dens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> val <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">if_dens</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">σ</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">σ</span> <span class="main">(</span>BoolVal <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">if_dens_det</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> expr <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> ennreal<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">if_dens_det</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">σ</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> expr_sem_rf <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> BoolVal <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_if_dens"><span class="command">lemma</span></span> measurable_if_dens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="main">(</span>range BoolVal<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"if_dens <span class="free">δ</span> <span class="free">f</span> <span class="free">b</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> if_dens_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_if_dens_det"><span class="command">lemma</span></span> measurable_if_dens_det<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> BOOL"</span></span> <span class="quoted"><span class="quoted">"randomfree <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"if_dens_det <span class="free">δ</span> <span class="free">e</span> <span class="free">b</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> if_dens_det_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> borel_measurable_times_ennreal assms measurable_If<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span><span class="main">.</span> expr_sem_rf <span class="bound">x</span> <span class="free">e</span> <span class="main">=</span> BoolVal <span class="free">b</span><span class="main">}</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>BoolVal <span class="free">b</span><span class="main">}</span> <span class="main">∩</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> sets <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_sets<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_expr_sem_rf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> e<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span><span class="main">.</span> expr_sem_rf <span class="bound">x</span> <span class="free">e</span> <span class="main">=</span> BoolVal <span class="free">b</span><span class="main">}</span>
                    <span class="main">∈</span> sets <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">locale</span></span> density_context <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">δ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subprob_space_dens<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> subprob_space <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="bound">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> finite_vars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>     <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> measurable_dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
                                 <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> disjoint<span class="main">:</span>              <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∩</span> <span class="free">V'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒴</span> <span class="main">≡</span> <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Density_Contexts-branch_prob_altdef"><span class="command">lemma</span></span> branch_prob_altdef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"branch_prob 𝒴 <span class="free">ρ</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"branch_prob 𝒴 <span class="free">ρ</span> <span class="main">=</span>
          <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span>space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> branch_prob_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> dens_ctxt_measure_def state_measure'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density ennreal_mult'' ennreal_indicator nn_integral_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_branch_prob"><span class="command">lemma</span></span> measurable_branch_prob<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"branch_prob 𝒴 <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_altdef <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> measurable_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_marg_dens'"><span class="command">lemma</span></span> measurable_marg_dens'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="main">(</span>marg_dens 𝒴 <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"state_measure <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> product_sigma_finite.sigma_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> product_sigma_finite_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"PiM <span class="free">V</span> <span class="main">=</span> PiM <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> marg_dens_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-insert_Diff"><span class="command">lemma</span></span> insert_Diff<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_marg_dens2'"><span class="command">lemma</span></span> measurable_marg_dens2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="main">(</span>marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span>
             borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"state_measure <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> product_sigma_finite.sigma_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> product_sigma_finite_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> marg_dens2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_marg_dens"><span class="command">lemma</span></span> measurable_marg_dens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"marg_dens 𝒴 <span class="free">x</span> <span class="free">ρ</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_marg_dens'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_marg_dens2"><span class="command">lemma</span></span> measurable_marg_dens2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_marg_dens2'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_state_measure_component"><span class="command">lemma</span></span> measurable_state_measure_component<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_component_singleton<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_dens_ctxt_measure_component"><span class="command">lemma</span></span> measurable_dens_ctxt_measure_component<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_component_singleton<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-space_dens_ctxt_measure_dens_ctxt_measure'"><span class="command">lemma</span></span> space_dens_ctxt_measure_dens_ctxt_measure'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">{</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">σ</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"state_measure <span class="free">V</span> <span class="free">Γ</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">σ</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def space_PiM PiE_insert_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def Bex_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-state_measure_integral_split"><span class="command">lemma</span></span> state_measure_integral_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">A</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">A</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> product_sigma_finite_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">A</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">σ</span> <span class="main">∂</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">v</span><span class="main">∈</span>insert <span class="free">x</span> <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> product_nn_integral_insert_rev<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-fun_upd_in_state_measure"><span class="command">lemma</span></span> fun_upd_in_state_measure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">A</span> <span class="free">Γ</span><span class="main">)</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-marg_dens_integral"><span class="command">lemma</span></span> marg_dens_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val set"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> sets <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">-`</span> <span class="free">X</span> <span class="main">∩</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> marg_dens 𝒴 <span class="free">x</span> <span class="free">ρ</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X'</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="free">V</span> <span class="main">=</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> product_sigma_finite_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X'</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∂</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> state_measure_integral_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">y</span>
                      <span class="main">∂</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_upd_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> marg_dens 𝒴 <span class="free">x</span> <span class="free">ρ</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> measurable_dens_ctxt_fun_upd <span class="keyword1"><span class="command">unfolding</span></span> marg_dens_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-marg_dens2_integral"><span class="command">lemma</span></span> marg_dens2_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> sets <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="free">x</span><span class="main">,</span> <span class="bound">σ</span> <span class="free">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">-`</span> <span class="free">X</span> <span class="main">∩</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="bound">z</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">z</span> <span class="main">∂</span>stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X'</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> product_sigma_finite_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="bound">z</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">z</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="main">(</span>case_prod PairVal <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="main">(</span>case_prod PairVal <span class="bound">z</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_PairVal<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> borel_measurable_times_ennreal measurable_marg_dens2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> V''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> insert <span class="free">y</span> <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> X'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">∈</span> sets <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> stock_measure.simps<span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_embed_measure2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_PairVal<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">erule</span> measurable_component_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> measurable_component_singleton<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> V<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">y</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">y</span> <span class="free">V</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X'</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X'</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="main">(</span>insert <span class="free">y</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">nn_integral</span></span></span><span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">state_measure</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">w</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">v</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∂</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> product_nn_integral_insert_rev<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state_measure_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> V<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> product_nn_integral_insert_rev<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-5<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">w</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
               <span class="main">⟹</span> <span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X'</span> <span class="main">⟷</span> <span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X'_def space_state_measure PiE_iff extensional_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">w</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">v</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span>
               <span class="main">∂</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">w</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">,</span><span class="free">y</span> <span class="main">:=</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
                    <span class="main">*</span> indicator <span class="free">X</span> <span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_mult'' ennreal_indicator<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong nn_integral_multc<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">w</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">v</span><span class="main">.</span> marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="main">&lt;|</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">|&gt;</span>
                       <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> marg_dens2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="main">(</span>case_prod PairVal <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="main">(</span>case_prod PairVal <span class="bound">z</span><span class="main">)</span>
                    <span class="main">∂</span><span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pair_sigma_finite.nn_integral_snd<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_sigma_finite_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> borel_measurable_times_ennreal measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_marg_dens2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="bound">z</span> <span class="main">*</span> indicator <span class="free">X</span> <span class="bound">z</span> <span class="main">∂</span>stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stock_measure.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> embed_measure_eq_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_PairVal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_embed_measure2 inj_PairVal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stock_measure.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> borel_measurable_times_ennreal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> measurable_marg_dens2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The space described by the marginal density is the same as the space obtained by projecting
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) out of the common distribution of all variables.›</span></span>

<span class="keyword1" id="PDF_Density_Contexts-density_marg_dens_eq"><span class="command">lemma</span></span> density_marg_dens_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>marg_dens 𝒴 <span class="free">x</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span>
              distr <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?M1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="var">?X'</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms measurable_marg_dens measurable_dens
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_density<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_distr nn_integral_distr
        dens_ctxt_measure_def state_measure'_def emeasure_density marg_dens_integral<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                                        indicator <span class="var">?X''</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_state_measure merge_def PiE_iff extensional_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> measurable_dens
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_distr emeasure_density nn_integral_distr ennreal_indicator ennreal_mult''
                   dens_ctxt_measure_def state_measure'_def state_measure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Density_Contexts-density_marg_dens2_eq"><span class="command">lemma</span></span> density_marg_dens2_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density <span class="free">M</span> <span class="main">(</span>marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span>
              distr <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="free">x</span><span class="main">,</span><span class="bound">σ</span> <span class="free">y</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?M1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="free">x</span> <span class="main">,</span> <span class="bound">σ</span> <span class="free">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="free">x</span> <span class="main">,</span> <span class="bound">σ</span> <span class="free">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> meas<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="free">x</span><span class="main">,</span><span class="bound">σ</span> <span class="free">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
                                                        <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stock_measure.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_embed_measure2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_PairVal<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_component_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> X meas <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M2</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="free">ρ</span><span class="main">)</span> <span class="var">?X''</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_dens_ctxt_measure_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> state_measure_def M_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_dens_ctxt_measure state_measure_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> X meas
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="var">?X''</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density nn_integral_distr ennreal_indicator ennreal_mult''<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> X
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span><span class="main">∈</span>space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?X''</span> <span class="main">⟷</span> <span class="bound">σ</span> <span class="main">∈</span> <span class="var">?X'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_state_measure merge_def PiE_iff extensional_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> indicator <span class="var">?X'</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> marg_dens2 𝒴 <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="bound">z</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">z</span> <span class="main">∂</span><span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> marg_dens2_integral<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M1</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms measurable_dens <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_marg_dens2<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Density_Contexts-measurable_insert_dens"><span class="command">lemma</span></span> measurable_insert_dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span>
             <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span>stock_measure <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_dens_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-nn_integral_dens_ctxt_measure"><span class="command">lemma</span></span> nn_integral_dens_ctxt_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def <span class="keyword1"><span class="command">using</span></span> assms measurable_dens
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nn_integral_density<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nn_integral_distr state_measure_def <span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-shift_var_set_Un"><span class="command">lemma</span></span> shift_var_set_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"shift_var_set <span class="free">V</span> <span class="main">∪</span> Suc <span class="main">`</span> <span class="free">V'</span> <span class="main">=</span> shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-emeasure_dens_ctxt_measure_insert"><span class="command">lemma</span></span> emeasure_dens_ctxt_measure_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">f</span> <span class="free">ρ</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> dens_ctxt_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">,</span> Suc<span class="main">`</span><span class="free">V'</span><span class="main">,</span> case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">,</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">F</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="free">X</span> <span class="main">=</span>
           <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                 indicator <span class="free">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∂</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> has_parametrized_subprob_densityD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dens<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> shift_var_set_Un <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_var_set_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> indicator <span class="free">X</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_indicator<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> MI<span class="main">:</span> <span class="quoted"><span class="quoted">"indicator <span class="free">X</span> <span class="main">∈</span> borel_measurable
                     <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">unfolding</span></span> M_def dens_ctxt_measure_def state_measure'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> indicator <span class="free">X</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="var">?I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">unfolding</span></span> M_def dens_ctxt_measure_def state_measure'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_density<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_density nn_integral_distr MI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-merge_Suc_aux'"><span class="command">lemma</span></span> merge_Suc_aux'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_Pair measurable_merge<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measurable_const<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-merge_Suc_aux"><span class="command">lemma</span></span> merge_Suc_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_dens<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_Pair measurable_merge<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measurable_const<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-nn_integral_PiM_Suc"><span class="command">lemma</span></span> nn_integral_PiM_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sigma_finite_measure <span class="main">(</span><span class="free">N</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">V</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">M</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">V</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">V</span> <span class="free">N</span><span class="main">)</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"nn_integral <span class="main">(</span><span class="var">?M1</span> <span class="free">V</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> Mf
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span>
                 <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_vars<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> empty insert<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PiM_empty nn_integral_distr <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">v</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="skolem">v</span> <span class="skolem">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?M3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="skolem">V</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M4</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="skolem">V</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="main">(</span>count_space <span class="main">{}</span><span class="main">)</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M4'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>Suc <span class="main">`</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="main">(</span>count_space <span class="main">{}</span><span class="main">)</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M3</span> <span class="main">=</span> <span class="var">?M4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> PiM_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"case_nat <span class="main">(</span>count_space <span class="main">{}</span><span class="main">)</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> product_sigma_finite_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fin sigma_finite_measure_count_space_countable <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> insert<span class="main">(</span>4<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="var">?M1</span> <span class="var">?V</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">∂</span><span class="var">?M4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nn_integral_distr<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_case_nat_Suc_PiM image_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span>Suc <span class="skolem">v</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">∂</span><span class="free">N</span> <span class="skolem">v</span> <span class="main">∂</span><span class="var">?M4'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> product_nn_integral_insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> image_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_case_nat_Suc_PiM<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span>Suc <span class="skolem">v</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M4'</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>Suc <span class="main">`</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> PiM_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="free">N</span> <span class="skolem">v</span> <span class="main">∂</span><span class="main">...</span><span class="main">)</span> <span class="main">=</span>
                             <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="free">N</span> <span class="skolem">v</span> <span class="main">∂</span><span class="var">?M1</span> <span class="skolem">V</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_distr<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> borel_measurable_nn_integral measurable_case_nat_Suc_PiM<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="free">N</span> <span class="skolem">v</span> <span class="main">∂</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">V</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> insert<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∂</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="var">?V</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> product_sigma_finite.product_nn_integral_insert<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms product_sigma_finite_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-PiM_Suc"><span class="command">lemma</span></span> PiM_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sigma_finite_measure <span class="main">(</span><span class="free">N</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">M</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">V</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">V</span> <span class="free">N</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_indicator<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nn_integral_PiM_Suc assms
               <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nn_integral_indicator<span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-distr_state_measure_Suc"><span class="command">lemma</span></span> distr_state_measure_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distr <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">=</span>
     state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> PiM_Suc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> stock_measure <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Γ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"stock_measure <span class="free"><span class="free">t</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong PiM_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Density_Contexts-emeasure_dens_ctxt_measure_insert'"><span class="command">lemma</span></span> emeasure_dens_ctxt_measure_insert'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">f</span> <span class="free">ρ</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> dens_ctxt_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">,</span> Suc<span class="main">`</span><span class="free">V'</span><span class="main">,</span> case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">,</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">F</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="free">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span>
                       indicator <span class="free">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> merge <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">:</span>
      <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_parametrized_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> Mf<span class="main">[</span><span class="operator">unfolded</span> state_measure_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> meas_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def shift_var_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un image_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Un_insert_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_insert Un_insert_left<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> measurable_insert_dens' <span class="main">=</span>
           measurable_insert_dens<span class="main">[</span><span class="operator">unfolded</span> shift_var_set_def state_measure_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> meas_merge'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>
                    <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ meas_merge<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> meas_integral<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span>
                            indicator <span class="free">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">∂</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sigma_finite_measure.borel_measurable_nn_integral<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> borel_measurable_times_ennreal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_fst merge_Suc_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_fst merge_Suc_aux'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> meas_merge' borel_measurable_indicator<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> X<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> meas'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>
                  <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span>
                      indicator <span class="free">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> borel_measurable_times_ennreal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_const<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> merge_Suc_aux'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ borel_measurable_indicator<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_case_nat'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_ident_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> measurable_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> meas_merge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="free">X</span> <span class="main">=</span>
           <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                 indicator <span class="free">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∂</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_dens_ctxt_measure_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span> <span class="main">(</span><span class="var">?m</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span>
                  indicator <span class="free">X</span> <span class="main">(</span><span class="var">?m</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ρ X meas_merge
    <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def M_def dens_ctxt_measure_def state_measure'_def state_measure_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> product_sigma_finite.product_nn_integral_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> product_sigma_finite_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> borel_measurable_times_ennreal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_insert_dens'<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ borel_measurable_indicator<span class="main"><span class="main">]</span></span> image_Un<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
                   <span class="bound">y</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
                   <span class="main">(</span>remove_var <span class="main">(</span>merge <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="main">0</span><span class="main">:=</span><span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                       merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_def remove_var_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span>
                       indicator <span class="free">X</span> <span class="main">(</span><span class="var">?m</span> <span class="bound">σ</span> <span class="bound">y</span><span class="main">)</span>
                  <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_dens_def inj_image_mem_iff merge_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> m_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="var">?m</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_def shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span>
                       indicator <span class="free">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ X
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_state_measure_Suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_case_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> meas_integral<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span>
                       indicator <span class="free">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ X
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_cmult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meas'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="PDF_Density_Contexts-density_context_insert"><span class="command">lemma</span></span> density_context_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">F</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_context <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"density_context <span class="var">?V</span> <span class="var">?V'</span> <span class="var">?Γ'</span> <span class="var">?δ'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> density_context_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI impI<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> measurable_insert_dens<span class="main">[</span><span class="operator">OF</span> has_parametrized_subprob_densityD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span>
          <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span> <span class="main">∪</span> Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> image_Un Un_insert_left<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="var">?V'</span> <span class="var">?Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> ρ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∘</span> Suc <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> dens' <span class="main">=</span> has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> dens<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> dens'<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> M_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">∈</span> measurable <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> stock_measure <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> shift_var_set_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> state_measure_def<span class="main">)</span>
               <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_var_set_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> shift_var_set_Un Un_insert_left<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="var">?V</span><span class="main">,</span><span class="var">?V'</span><span class="main">,</span><span class="var">?Γ'</span><span class="main">,</span><span class="var">?δ'</span><span class="main">)</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="var">?M</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_spaceI<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> product_sigma_finite_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> Suc_state_measure<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
              merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> merge_in_state_measure<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> S<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> Suc <span class="bound">x</span> <span class="main">∈</span> Suc <span class="main">`</span> <span class="bound">X</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_image_mem_iff<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="var">?V</span><span class="main">,</span><span class="var">?V'</span><span class="main">,</span><span class="var">?Γ'</span><span class="main">,</span><span class="var">?δ'</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="var">?V</span> <span class="var">?Γ'</span><span class="main">)</span> <span class="main">⟹</span> merge <span class="var">?V</span> <span class="var">?V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∈</span> space <span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> shift_var_set_Un
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> merge_in_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="var">?V</span> <span class="var">?V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="var">?V</span> <span class="var">?Γ'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_dens_ctxt_measure_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens ρ<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="var">?V</span> <span class="var">?V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>
                              <span class="main">∂</span>state_measure <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="var">?Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="var">?V</span> <span class="var">?V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="var">?Γ'</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">using</span></span> M_merge
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> product_nn_integral_insert<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>remove_var <span class="main">(</span>merge <span class="var">?V</span> <span class="var">?V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="main">0</span><span class="main">:=</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                               <span class="free">f</span> <span class="main">(</span>remove_var <span class="main">(</span>merge <span class="var">?V</span> <span class="var">?V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="main">0</span><span class="main">:=</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>
                        <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="var">?Γ'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_dens_def merge_def shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> remove_var <span class="main">(</span>merge <span class="var">?V</span> <span class="var">?V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="main">0</span><span class="main">:=</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> remove_var_def merge_def shift_var_set_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">x</span>
                  <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="var">?Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                            <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="free">t</span><span class="main">)</span>
                       <span class="main">∂</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="var">?Γ'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ρ disjoint
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong nn_integral_cmult<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_const<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Suc_state_measure<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="var">?Γ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"density <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="var">?σ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="var">?N</span> <span class="main">(</span>space <span class="var">?N</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dens'<span class="main">(</span>3<span class="main">)</span> Suc_state_measure<span class="main">[</span><span class="operator">OF</span> σ<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong' <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="free">F</span> <span class="var">?σ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dens'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_state_measure σ<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="free">F</span> <span class="var">?σ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dens'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_state_measure σ<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">F</span> <span class="var">?σ'</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span><span class="free">F</span> <span class="var">?σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space.emeasure_space_le_1<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">∂</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="var">?Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_mono mult_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span>
                       <span class="main">∂</span>distr <span class="main">(</span>state_measure <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="var">?Γ'</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∘</span> Suc<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> nn_integral <span class="var">?N</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_case_nat_Suc merge_Suc_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distr_state_measure_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="main">1</span> <span class="main">∂</span>dens_ctxt_measure 𝒴 <span class="main">(</span><span class="skolem">ρ</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> nn_integral <span class="var">?N</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_dens_ctxt_measure<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ρ'<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> indicator <span class="main">(</span>space <span class="var">?N</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">∂</span><span class="var">?N</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?N</span> <span class="main">(</span>space <span class="var">?N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subprob_space.emeasure_space_le_1 subprob_space_dens ρ'<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_dens_ctxt_measure state_measure_def space_PiM PiE_eq_empty_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>


<span class="keyword1" id="PDF_Density_Contexts-dens_ctxt_measure_insert"><span class="command">lemma</span></span> dens_ctxt_measure_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> meas_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> meas_f<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> has_dens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
                         has_subprob_density <span class="main">(</span><span class="free">M</span> <span class="bound">ρ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">σ</span> <span class="main">←</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
             <span class="bound">y</span> <span class="main">←</span> <span class="free">M</span> <span class="bound">σ</span><span class="main">;</span>
             return <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
         dens_ctxt_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">,</span> Suc<span class="main">`</span><span class="free">V'</span><span class="main">,</span> case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">,</span> insert_dens <span class="free">V</span> <span class="free">V'</span> <span class="free">f</span> <span class="free">δ</span><span class="main">)</span>
                           <span class="main">(</span>case_nat undefined <span class="free">ρ</span><span class="main">)</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"bind <span class="var">?N</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bind <span class="main">_</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return <span class="var">?R</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dens_ctxt_measure <span class="main">(</span><span class="var">?V</span><span class="main">,</span><span class="var">?V'</span><span class="main">,</span><span class="var">?Γ'</span><span class="main">,</span><span class="var">?δ'</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="main">.</span> <span class="free">M</span> <span class="bound">σ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return <span class="var">?R</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="var">?V</span><span class="main">,</span><span class="var">?V'</span><span class="main">,</span><span class="var">?Γ'</span><span class="main">,</span><span class="var">?δ'</span><span class="main">)</span> <span class="main">(</span>case_nat undefined <span class="free">ρ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> meas_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> measurable <span class="bound">M</span> <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
                         <span class="bound">h</span> <span class="main">∈</span> measurable <span class="bound">M</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="bound">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="var">?Γ'</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="var">?N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def
                     space_PiM PiE_eq_empty_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> meas_N_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="var">?N</span> <span class="main">=</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> meas_M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> measurable <span class="var">?N</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> meas_N_eq<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> meas_M<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> meas_N'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> measurable <span class="main">(</span><span class="var">?N</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">R</span><span class="main">)</span> <span class="main">=</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> sets_pair_measure_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> meas_M_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="var">?N</span> <span class="main">⟹</span> measurable <span class="main">(</span><span class="free">M</span> <span class="bound">ρ</span><span class="main">)</span> <span class="main">=</span> measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets sets_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> meas_M'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> meas_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span><span class="main">.</span> measurable <span class="bound">M</span> <span class="var">?rhs</span> <span class="main">=</span> measurable <span class="bound">M</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> subprob_algebra_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"subprob_algebra <span class="var">?rhs</span> <span class="main">=</span> subprob_algebra <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="var">?Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_algebra_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nonempty'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="var">?N</span> <span class="main">⟹</span> space <span class="main">(</span><span class="free">M</span> <span class="bound">ρ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space.subprob_not_empty<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD has_dens <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_dens_ctxt_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> merge_in_space<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
                              merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="free">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_dens_ctxt_measure merge_in_state_measure ρ<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sets <span class="var">?lhs</span> <span class="main">=</span> sets <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="var">?Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sets_bind<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sets_bind<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> sets_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="var">?lhs</span> <span class="main">=</span> sets <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> meas_merge<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">measurable</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?lhs</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">M</span> <span class="bound">σ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return <span class="var">?R</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span><span class="var">?N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_bind measurable_bind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> meas_M'<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ return_measurable<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span><span class="free">M</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return <span class="var">?R</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_dens_ctxt_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_emeasure_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_bind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> meas_M<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ return_measurable<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                              <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> indicator <span class="skolem">X</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                   <span class="main">∂</span><span class="free">M</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nonempty'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_in_space<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ return_measurable<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_in_space meas_M_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
                  <span class="free">M</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_dens<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_in_state_measure ρ<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> indicator <span class="skolem">X</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="main">∂</span>density <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                     <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">∂</span>stock_measure <span class="free">t</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nn_integral_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult.assoc dens_ctxt_measure_def state_measure'_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> merge_in_state_measure ρ AE_I'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span>
                     has_subprob_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat undefined <span class="free">ρ</span> <span class="main">∘</span> Suc <span class="main">=</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">x</span><span class="main">,</span> case_nat undefined <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_def shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="main">(</span>merge <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">`</span><span class="free">V'</span><span class="main">)</span>
                 <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">x</span><span class="main">,</span>case_nat undefined <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> emeasure <span class="var">?rhs</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_dens_ctxt_measure_insert'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> F <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> has_dens<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_density_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_case_nat_undefined ρ<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A C<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?lhs</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?rhs</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-density_context_if_dens"><span class="command">lemma</span></span> density_context_if_dens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">M</span>
               <span class="main">(</span>count_space <span class="main">(</span>range BoolVal<span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="main">(</span>if_dens <span class="free">δ</span> <span class="free">f</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> density_context_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI impI subprob_spaceI<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> D <span class="main">=</span> has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> D<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"if_dens <span class="free">δ</span> <span class="free">f</span> <span class="free">b</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_if_dens<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
                            measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ρ <span class="keyword1"><span class="command">have</span></span> σρ<span class="main">:</span> <span class="quoted"><span class="quoted">"merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> merge_in_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="free">M</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>count_space <span class="main">(</span>range BoolVal<span class="main">)</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> σρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>BoolVal <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subprob_count_space_density_le_1<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dens_props <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">interpret</span></span> subprob_space <span class="quoted"><span class="quoted">"dens_ctxt_measure 𝒴 <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space_dens<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span> <span class="free">V'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> if_dens <span class="free">δ</span> <span class="free">f</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> if_dens <span class="free">δ</span> <span class="free">f</span> <span class="free">b</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M ρ <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case space_density<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nn_integral_distr emeasure_density <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> if_dens_def <span class="keyword1"><span class="command">using</span></span> dens_props
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_mono mult_left_mono<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> branch_prob 𝒴 <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_space_le_1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PDF_Density_Contexts-density_context_if_dens_det"><span class="command">lemma</span></span> density_context_if_dens_det<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> BOOL"</span></span> <span class="quoted"><span class="quoted">"randomfree <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="main">(</span>if_dens_det <span class="free">δ</span> <span class="free">e</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> density_context_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI impI subprob_spaceI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"if_dens_det <span class="free">δ</span> <span class="free">e</span> <span class="free">b</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_if_dens_det<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
                            measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">interpret</span></span> subprob_space <span class="quoted"><span class="quoted">"dens_ctxt_measure 𝒴 <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space_dens<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span> <span class="free">V'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> if_dens_det <span class="free">δ</span> <span class="free">e</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> if_dens_det <span class="free">δ</span> <span class="free">e</span> <span class="free">b</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M ρ <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case space_density<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nn_integral_distr emeasure_density <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> if_dens_det_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_mono mult_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> branch_prob 𝒴 <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_space_le_1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> disjoint assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> measurable_if_dens_det<span class="main">)</span>


<span class="keyword1" id="PDF_Density_Contexts-density_context_empty"><span class="command">lemma</span></span> density_context_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"density_context <span class="main">{}</span> <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> density_context_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI impI subprob_spaceI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> merge <span class="main">{}</span> <span class="main">(</span><span class="free">V</span><span class="main">∪</span><span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_def state_measure_def space_PiM<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ρ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_density emeasure_distr state_measure_def PiM_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Density_Contexts-dens_ctxt_measure_bind_const"><span class="command">lemma</span></span> dens_ctxt_measure_bind_const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_measure 𝒴 <span class="free">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> density <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> branch_prob 𝒴 <span class="free">ρ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="var">?M1</span> <span class="main">=</span> sets <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_subprob_algebra assms<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sets <span class="var">?M1</span> <span class="main">=</span> sets <span class="var">?M2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?M1</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="free">N</span> <span class="skolem">X</span> <span class="main">*</span> branch_prob 𝒴 <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_prob_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind_const'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subprob_space_dens<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">N</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> indicator <span class="skolem">X</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">*</span> branch_prob 𝒴 <span class="free">ρ</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> branch_prob 𝒴 <span class="free">ρ</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_cmult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> branch_prob_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="PDF_Density_Contexts-nn_integral_dens_ctxt_measure_restrict"><span class="command">lemma</span></span> nn_integral_dens_ctxt_measure_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">ρ</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>restrict <span class="bound">x</span> <span class="free">V'</span><span class="main">)</span> <span class="main">∂</span>dens_ctxt_measure 𝒴 <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> branch_prob 𝒴 <span class="free">ρ</span> <span class="main">*</span> <span class="free">f</span> <span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>restrict <span class="bound">x</span> <span class="free">V'</span><span class="main">)</span> <span class="main">∂</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span>restrict <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">V'</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_dens_ctxt_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_restrict<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> measurable_component_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> disjoint
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> restrict <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">V'</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def merge_def state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="free">ρ</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="free">ρ</span> <span class="main">∂</span>dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_dens_ctxt_measure<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="free">ρ</span> <span class="main">*</span> branch_prob 𝒴 <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_const<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms branch_prob_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Density_Contexts-expr_sem_op_eq_distr"><span class="command">lemma</span></span> expr_sem_op_eq_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">oper</span> <span class="main">$$</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="free">oper</span> <span class="main">$$</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             distr <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="free">oper</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type <span class="free">oper</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subprob_algebra <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> t1 assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"return_val <span class="main">(</span>op_sem <span class="free">oper</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> return <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="free">oper</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> return_val_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> op_sem_val_type<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t2<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> return_op_sem <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword1"><span class="command">have</span></span> M_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def measurable_dens_ctxt_measure_eq measurable_expr_sem<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> return_op_sem
    <span class="keyword1"><span class="command">have</span></span> M_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span>op_sem <span class="free">oper</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="var">?N</span> <span class="var">?R</span> <span class="main">⟷</span>
                     <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="free">oper</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="var">?N</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> M_ret<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span>op_sem <span class="free">oper</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> M_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_op_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> return_measurable<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> M_e <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sets_bind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def space_subprob_algebra <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_space<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> measurable_cong_sets<span class="main">[</span><span class="operator">OF</span> this refl<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> M_op<span class="main">:</span> <span class="quoted"><span class="quoted">"op_sem <span class="free">oper</span> <span class="main">∈</span> measurable <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_op_sem t2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> space <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_eq_imp_space_eq<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> M_e <span class="keyword2"><span class="keyword">and</span></span> M_ret <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="free">oper</span> <span class="main">$$</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                              <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span>op_sem <span class="free">oper</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bind_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="free">oper</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_op_sem<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="free">oper</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def M_op<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="PDF_Density_Contexts-density_context_equiv"><span class="command">lemma</span></span> density_context_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">δ'</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">δ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> density_context_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI allI impI subprob_spaceI<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span> <span class="free">V'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ'</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span> <span class="free">V'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ'</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> space_density<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> branch_prob <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?N</span> <span class="main">(</span>space <span class="var">?N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.emeasure_space_le_1 subprob_space_dens<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> density_context_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="PDF_Compiler_Pred">
<div class="head">
<h1>Theory PDF_Compiler_Pred</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Compiler_Pred.thy
  Authors: Manuel Eberl

  The abstract compiler that compiles a PDF expression into a (HOL) density function
  on the corresponding measure spaces.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract PDF Compiler›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Compiler_Pred
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PDF_Semantics.html">PDF_Semantics</a> <a href="PDF_Density_Contexts.html">PDF_Density_Contexts</a> <a href="PDF_Transformations.html">PDF_Transformations</a> <a href="Density_Predicates.html">Density_Predicates</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Density compiler predicate›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Predicate version of the probability density compiler that compiles a expression
  to a probability density function of its distribution. The density is a HOL function of
  type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"val <span class="main"><span class="main">⇒</span></span> ennreal"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">expr_has_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dens_ctxt <span class="main">⇒</span> expr <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> val <span class="main">⇒</span> ennreal<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
              <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span>_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span><span class="keyword3">/ </span><span class="keyword3">(</span>_ <span class="keyword1">⇒</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  hd_AE<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
             <span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
                     <span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">;</span>
             case_prod <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">⟧</span>
                <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span>"</span></span>
<span class="main">|</span> hd_dens_ctxt_cong<span class="main">:</span>
           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">σ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">δ'</span></span></span> <span class="bound">σ</span><span class="main">)</span>
                 <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ'</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> hd_val<span class="main">:</span>  <span class="quoted"><span class="quoted">"countable_type <span class="main">(</span>val_type <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Val <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> branch_prob <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">*</span> indicator <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_var<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⇒</span></span> marg_dens <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> hd_let<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
             <span class="main">(</span>shift_var_set <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span>Suc<span class="main">`</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span>the<span class="main">(</span>expr_type <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span>insert_dens <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">⟧</span>
            <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> LetVar <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>case_nat undefined <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_rand<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Random <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> apply_dist_to_dens <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> hd_rand_det<span class="main">:</span> <span class="quoted"><span class="quoted">"randomfree <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span> free_vars <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="main">⟹</span>
                  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Random <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                     <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> branch_prob <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">*</span> dist_dens <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">(</span>expr_sem_rf <span class="bound">ρ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Fail <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="main">&lt;</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">&gt;</span> <span class="main"><span class="free">⇒</span></span> marg_dens2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> hd_if<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
             <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span>if_dens <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> True<span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span>if_dens <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> False<span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_if_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>randomfree <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span>if_dens_det <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> True<span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span><span class="main">;</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span>if_dens_det <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> False<span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_fst<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Fst <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ρ</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="main">(</span>the <span class="main">(</span>expr_type <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Snd <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_snd<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Snd <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ρ</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="main">(</span>the <span class="main">(</span>expr_type <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Fst <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_op_discr<span class="main">:</span> <span class="quoted"><span class="quoted">"countable_type <span class="main">(</span>the <span class="main">(</span>expr_type <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> op_sem <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ρ</span> <span class="bound">x</span>
                                                      <span class="main">∂</span>stock_measure <span class="main">(</span>the <span class="main">(</span>expr_type <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_neg<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Minus <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">σ</span> <span class="main">(</span>op_sem Minus <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_addc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> randomfree <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">⟹</span> free_vars <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="main">⟹</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Add <span class="main">$$</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">&gt;</span> <span class="main"><span class="free">⇒</span></span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ρ</span> <span class="main">(</span>op_sem Add <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="bound">ρ</span> <span class="main">(</span>Minus <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_multc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> val_type <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> REAL <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> RealVal <span class="main">0</span> <span class="main">⟹</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Mult <span class="main">$$</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Val <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">&gt;</span> <span class="main"><span class="free">⇒</span></span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ρ</span> <span class="main">(</span>op_sem Mult <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> op_sem Inverse <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">*</span>
                    inverse <span class="main">(</span>abs <span class="main">(</span>extract_real <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Exp <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> extract_real <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span>
                           <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">σ</span> <span class="main">(</span>lift_RealVal safe_ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span>extract_real <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Inverse <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">σ</span> <span class="main">(</span>op_sem Inverse <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
                                                  inverse <span class="main">(</span>extract_real <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> hd_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>d</sub></span></span> Add <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">σ</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> op_sem Add <span class="main">&lt;|</span><span class="bound">z</span><span class="main">,</span> op_sem Minus <span class="bound">x</span><span class="main">|&gt;</span><span class="main">|&gt;</span>
                                                  <span class="main">∂</span>stock_measure <span class="main">(</span>val_type <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> expr_has_density_intros <span class="main">=</span>
  hd_val hd_var hd_let hd_rand hd_rand_det hd_fail hd_pair hd_if hd_if_det
  hd_fst hd_snd hd_op_discr hd_neg hd_addc hd_multc hd_exp hd_inv hd_add

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>

<span class="keyword1" id="PDF_Compiler_Pred-has_subprob_density_distr_Fst"><span class="command">lemma</span></span> has_subprob_density_distr_Fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> stock_measure <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N'</span> <span class="main">≡</span> stock_measure <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">fst'</span> <span class="main">≡</span> op_sem Fst"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> <span class="free">N'</span> <span class="free">fst'</span><span class="main">)</span> <span class="free">N'</span> <span class="free">f'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_densityI measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">interpret</span></span> subprob_space <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> M_M<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> meas_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fst'</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fst'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> op_sem.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def N_def M_M<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>distr <span class="free">M</span> <span class="free">N'</span> <span class="free">fst'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dens <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_subprob_density_def has_density_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> meas_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f'_def N'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> <span class="free">N'</span> <span class="free">fst'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?M2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"density <span class="free">N'</span> <span class="free">f'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sets <span class="var">?M1</span> <span class="main">=</span> sets <span class="var">?M2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?M1</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>stock_measure <span class="free">t1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> meas_fst <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span><span class="free">fst'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> meas_fst <span class="keyword1"><span class="command">have</span></span> meas_fst'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fst'</span> <span class="main">∈</span> measurable <span class="free">N</span> <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">(</span><span class="free">fst'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">M</span><span class="main">)</span> <span class="main">=</span>
                            <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">fst'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> M<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> space_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> emeasure_density<span class="main">)</span>
       <span class="main">(</span><span class="operator">erule</span> has_subprob_densityD<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> measurable_sets<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> distr <span class="main">(</span><span class="free">N'</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t2</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span>case_prod PairVal<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> N_def N'_def stock_measure.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> embed_measure_eq_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_PairVal<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> nn_integral <span class="free">N</span> <span class="bound">f</span> <span class="main">=</span> nn_integral <span class="main">...</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> X
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">fst'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span><span class="var">?N</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>case_prod PairVal <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">fst'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="main">(</span>case_prod PairVal <span class="bound">x</span><span class="main">)</span>
                <span class="main">∂</span><span class="main">(</span><span class="free">N'</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_distr<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_embed_measure2 N_def N'_def fst'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> has_subprob_densityD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dens<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> X
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">fst'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="free">t2</span> <span class="main">∂</span><span class="free">N'</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sigma_finite_measure.nn_integral_fst<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N_def N'_def fst'_def comp_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> space_stock_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N'</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
                          indicator <span class="main">(</span><span class="free">fst'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">|&gt;</span> <span class="main">=</span> indicator <span class="skolem">X</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fst'_def N_def
                 space_embed_measure space_pair_measure N'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="free">t2</span> <span class="main">∂</span><span class="free">N'</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∘</span> case_prod PairVal <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="free">t2</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong nn_integral_multc<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> A<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_comp f measurable_PairVal <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> meas_f' <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_density<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Compiler_Pred-has_subprob_density_distr_Snd"><span class="command">lemma</span></span> has_subprob_density_distr_Snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> stock_measure <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N'</span> <span class="main">≡</span> stock_measure <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">snd'</span> <span class="main">≡</span> op_sem Snd"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="free">M</span> <span class="free">N</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="free">M</span> <span class="free">N'</span> <span class="free">snd'</span><span class="main">)</span> <span class="free">N'</span> <span class="free">f'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_densityI measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">interpret</span></span> subprob_space <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> M_M<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="main">=</span> measurable <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> meas_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">snd'</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> snd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> op_sem.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def N_def M_M<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>distr <span class="free">M</span> <span class="free">N'</span> <span class="free">snd'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> t1<span class="main">:</span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span> <span class="bound">x</span> <span class="main">,</span>  <span class="bound">y</span> <span class="main">|&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∘</span> case_prod PairVal"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dens <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_subprob_density_def has_density_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> meas_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f'_def N'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

  <span class="keyword1"><span class="command">interpret</span></span> N'<span class="main">:</span> sigma_finite_measure <span class="quoted"><span class="free">N'</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> N'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sigma_finite_stock_measure<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> N'_t1<span class="main">:</span> pair_sigma_finite <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">N'</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> <span class="free">N'</span> <span class="free">snd'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?M2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"density <span class="free">N'</span> <span class="free">f'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sets <span class="var">?M1</span> <span class="main">=</span> sets <span class="var">?M2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?M1</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>stock_measure <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> meas_snd <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span><span class="free">snd'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> density <span class="free">N</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_densityD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> meas_snd <span class="keyword1"><span class="command">have</span></span> meas_snd'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">snd'</span> <span class="main">∈</span> measurable <span class="free">N</span> <span class="free">N'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">(</span><span class="free">snd'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">M</span><span class="main">)</span> <span class="main">=</span>
                            <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">snd'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> M<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> space_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> emeasure_density<span class="main">)</span>
       <span class="main">(</span><span class="operator">erule</span> has_subprob_densityD<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> measurable_sets<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> distr <span class="main">(</span>stock_measure <span class="free">t1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N'</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span>case_prod PairVal<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> N_def N'_def stock_measure.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> embed_measure_eq_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_PairVal<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> nn_integral <span class="free">N</span> <span class="bound">f</span> <span class="main">=</span> nn_integral <span class="main">...</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> X
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">snd'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span><span class="var">?N</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>case_prod PairVal <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">snd'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="main">(</span>case_prod PairVal <span class="bound">x</span><span class="main">)</span>
                <span class="main">∂</span><span class="main">(</span>stock_measure <span class="free">t1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_distr<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_embed_measure2 N_def N'_def snd'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> has_subprob_densityD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dens<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> X
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">*</span> indicator <span class="main">(</span><span class="free">snd'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="free">t1</span> <span class="main">∂</span><span class="free">N'</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> N'_t1.nn_integral_snd<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N_def N'_def snd'_def comp_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> space_stock_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">N'</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
                          indicator <span class="main">(</span><span class="free">snd'</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> space <span class="free">N</span><span class="main">)</span> <span class="main">&lt;|</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">|&gt;</span> <span class="main">=</span> indicator <span class="skolem">X</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> snd'_def N_def
                 space_embed_measure space_pair_measure N'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="free">t1</span> <span class="main">∂</span><span class="free">N'</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> space <span class="free">N'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∘</span> case_prod PairVal <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="free">t1</span><span class="main">)</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">N'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong nn_integral_multc<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> meas_f' <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_density<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M1</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?M2</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Compiler_Pred-dens_ctxt_measure_empty_bind"><span class="command">lemma</span></span> dens_ctxt_measure_empty_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="free">ρ</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">ρ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"bind <span class="var">?M</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def space_PiM<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="var">?M</span> <span class="main">=</span> measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span><span class="free">f</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> sets <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sets_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> sets_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sets <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sets_bind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> merge <span class="main">{}</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_def state_measure_def space_PiM<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span>  <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span><span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonempty<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonempty meas sets_eq <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> measurable_cong_sets<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>state<span class="main">)</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">f</span> <span class="free">ρ</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span>count_space <span class="main">{</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def <span class="keyword1"><span class="command">using</span></span> X assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_density<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_emeasure_subprob_algebra<span class="main"><span class="main">]</span></span>
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  state_measure_def sets_eq PiM_empty<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_distr<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_emeasure_subprob_algebra<span class="main"><span class="main">]</span></span>
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def sets_eq PiM_empty<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span><span class="free">f</span> <span class="free">ρ</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_count_space_finite<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span><span class="free">f</span> <span class="free">ρ</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> density_context<span class="main">)</span> bind_dens_ctxt_measure_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V'</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mg<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⤜</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> disjoint
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def dens_ctxt_measure_def state_measure'_def density_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong_AE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">N</span></span></span></span><span class="main"><span class="main">]</span></span> AE_I2 refl fg<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> density_context<span class="main">)</span> bin_op_randomfree_restructure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type <span class="free">oper</span> <span class="main">(</span>PRODUCT <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">tr</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"randomfree <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vars1<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">∪</span><span class="free">V'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vars2<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e'</span> <span class="main">⊆</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≡</span> expr_sem_rf <span class="free">ρ</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="free">oper</span> <span class="main">$$</span> <span class="main">&lt;</span><span class="free">e</span><span class="main">,</span> <span class="free">e'</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              distr <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">tr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> op_sem <span class="free">oper</span> <span class="main">&lt;|</span><span class="bound">w</span><span class="main">,</span><span class="free">v</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> vars1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>free_vars <span class="free">e</span><span class="main">.</span> val_type <span class="main">(</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span> <span class="bound">x</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> vars2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>free_vars <span class="free">e'</span><span class="main">.</span> val_type <span class="main">(</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def space_dens_ctxt_measure state_measure_def space_PiM
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Me<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span>
                 measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1 vars1<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> expr_sem <span class="bound">σ</span> <span class="free">e'</span> <span class="main">=</span> return_val <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_rf_sound<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def space_dens_ctxt_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> vt_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> val_type <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_expr_sem_rf<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def space_dens_ctxt_measure<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"PRODUCT <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> vars2 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> measurable <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_expr_sem_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t2<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">V</span></span></span><span class="main"><span class="main"><span class="main">∪</span></span></span><span class="free"><span class="free"><span class="free">V'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def space_dens_ctxt_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> σ <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> space <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
                          <span class="quoted"><span class="quoted">"space <span class="main">(</span>expr_sem <span class="skolem">σ</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> space <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> space_expr_sem<span class="main">[</span><span class="operator">OF</span> t1 vars1'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> σ<span class="main"><span class="main">]</span></span><span class="main">]</span> space_expr_sem<span class="main">[</span><span class="operator">OF</span> t2 vars2'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> σ<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> expr_sem <span class="skolem">σ</span> <span class="free">e'</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return_val <span class="main">&lt;|</span> <span class="bound">x</span> <span class="main">,</span>  <span class="bound">y</span> <span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            expr_sem <span class="skolem">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return_val <span class="main">&lt;|</span> <span class="bound">x</span> <span class="main">,</span>  <span class="bound">y</span> <span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> e'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> σ<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> expr_sem <span class="skolem">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">&lt;|</span><span class="bound">x</span> <span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="free">e'</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ vars2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_return_val'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t'</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?tt'</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vt_e' M_def space_dens_ctxt_measure
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_PairVal<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="skolem">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> expr_sem <span class="skolem">σ</span> <span class="free">e'</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return_val <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                     expr_sem <span class="skolem">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="skolem">σ</span> <span class="free">e'</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="free">oper</span> <span class="main">$$</span> <span class="main">&lt;</span><span class="free">e</span><span class="main">,</span> <span class="free">e'</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span>expr_sem <span class="bound">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span>op_sem <span class="free">oper</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?T</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> expr_sem.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span> <span class="main">∈</span> space <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def vt_e' <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> measurable_op_sem<span class="main">[</span><span class="operator">OF</span> t3<span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span>op_sem <span class="free">oper</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?T</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_assoc_return_val<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?tt'</span></span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">tr</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sets_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1 vars1'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V'</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span> <span class="main">=</span> expr_sem_rf <span class="free">ρ</span> <span class="free">e'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_rf_eq_on_vars<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_expr_sem_rf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t2 rf<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> Me measurable_bind measurable_return_val
  <span class="keyword1"><span class="command">have</span></span> expr_sem_rf_space<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="free">ρ</span> <span class="free">e'</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> val_type_expr_sem_rf<span class="main">[</span><span class="operator">OF</span> t2 rf vars2 ρ<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_val <span class="main">(</span>op_sem <span class="free">oper</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span>  expr_sem_rf <span class="free">ρ</span> <span class="free">e'</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_dens_ctxt_measure_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> eq<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">measurable</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
                         return_val <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> op_sem <span class="free">oper</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="free">ρ</span> <span class="free">e'</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> expr_sem_rf_space
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_assoc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stock_measure <span class="free"><span class="free"><span class="free">t</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stock_measure <span class="free"><span class="free"><span class="free">tr</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def measurable_dens_ctxt_measure_eq o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">tr</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> op_sem <span class="free">oper</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="free">ρ</span> <span class="free">e'</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Me expr_sem_rf_space
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_val_distr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">tr</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def sets_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1 vars1'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Compiler_Pred-addc_density_measurable"><span class="command">lemma</span></span> addc_density_measurable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> REAL <span class="main">∨</span> <span class="free">t</span> <span class="main">=</span> INTEG"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"randomfree <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e'</span> <span class="main">⊆</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ρ</span> <span class="main">(</span>op_sem Add <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="bound">ρ</span> <span class="main">(</span>Minus <span class="main">$$</span> <span class="free">e'</span><span class="main">)</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> t_disj<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> REAL"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> rf vars <span class="keyword1"><span class="command">have</span></span> vt_e'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> val_type <span class="main">(</span>expr_sem_rf <span class="bound">ρ</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_expr_sem_rf<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span>
                    <span class="keyword1">in</span>  <span class="free">f</span> <span class="bound">σ</span> <span class="main">(</span>RealVal <span class="main">(</span>extract_real <span class="bound">x</span> <span class="main">-</span> extract_real <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> Mf<span class="main">[</span><span class="operator">unfolded</span> A<span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> rf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> vars<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">[</span><span class="operator">unfolded</span> A<span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def A <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span>
                case_prod <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def space_pair_measure A space_embed_measure f'_def lift_RealIntVal2_def
                   lift_RealIntVal_def extract_real_def
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vt_e' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> INTEG"</span></span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span> <span class="main">:</span> INTEG"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> rf vars <span class="keyword1"><span class="command">have</span></span> vt_e'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> val_type <span class="main">(</span>expr_sem_rf <span class="bound">ρ</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> INTEG"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_expr_sem_rf<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> expr_sem_rf <span class="bound">σ</span> <span class="free">e'</span>
                    <span class="keyword1">in</span>  <span class="free">f</span> <span class="bound">σ</span> <span class="main">(</span>IntVal <span class="main">(</span>extract_int <span class="bound">x</span> <span class="main">-</span> extract_int <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> Mf<span class="main">[</span><span class="operator">unfolded</span> A<span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> rf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> vars<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">[</span><span class="operator">unfolded</span> A<span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> Mdiff<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="main">(</span><span class="main">(-)</span> <span class="main">::</span> int <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span>
                 measurable <span class="main">(</span>count_space UNIV <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV<span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def A <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span>
                case_prod <span class="free">f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def space_pair_measure A space_embed_measure f'_def lift_RealIntVal2_def
                   lift_RealIntVal_def extract_int_def
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vt_e' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> density_context<span class="main">)</span> emeasure_bind_if_dens_ctxt_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> dens_ctxt_measure 𝒴 <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure BOOL<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mg<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mh<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> densf<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
                      <span class="free">f</span> <span class="main">(</span>stock_measure BOOL<span class="main">)</span> <span class="free">δf</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> densg<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">σ</span> <span class="main">(</span>BoolVal True<span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span> <span class="free">R</span> <span class="free">δg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> densh<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">σ</span> <span class="main">(</span>BoolVal False<span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="free">h</span><span class="main">)</span> <span class="free">R</span> <span class="free">δh</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> BoolVal True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> density <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δg</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">δh</span> <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sets_lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="var">?lhs</span> <span class="main">=</span> sets <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sets_bind_measurable<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def M_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sets <span class="var">?lhs</span> <span class="main">=</span> sets <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sets_lhs<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Mf <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> sets <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>stock_measure BOOL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_kernel<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> has_parametrized_subprob_densityD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> densf<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> Mδf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">δf</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>
        <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure BOOL<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stock_measure BOOL<span class="main">)</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> BoolVal_in_space<span class="main">:</span> <span class="quoted"><span class="quoted">"BoolVal True <span class="main">∈</span> space <span class="main">(</span>stock_measure BOOL<span class="main">)</span>"</span></span>
                         <span class="quoted"><span class="quoted">"BoolVal False <span class="main">∈</span> space <span class="main">(</span>stock_measure BOOL<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Mg <span class="keyword1"><span class="command">have</span></span> Mg'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def measurable_dens_ctxt_measure_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Mh <span class="keyword1"><span class="command">have</span></span> Mh'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def measurable_dens_ctxt_measure_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> densf <span class="keyword1"><span class="command">have</span></span> densf'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="free">M</span> <span class="free">f</span> <span class="main">(</span>stock_measure BOOL<span class="main">)</span> <span class="free">δf</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sets_pair_measure_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> M_def dens_ctxt_measure_def state_measure'_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> prod.case<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sets_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sets_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def space_dens_ctxt_measure<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">interpret</span></span> dc_True<span class="main">:</span> density_context <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">σ</span> <span class="main">(</span>BoolVal True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> density_context_if_dens<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">δf</span></span> <span class="quoted">True</span><span class="main">]</span> densf <span class="keyword1"><span class="command">unfolding</span></span> if_dens_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> dc_False<span class="main">:</span> density_context <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">σ</span> <span class="main">(</span>BoolVal False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> density_context_if_dens<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">δf</span></span> <span class="quoted">False</span><span class="main">]</span> densf <span class="keyword1"><span class="command">unfolding</span></span> if_dens_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span>
          <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span><span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_bind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">measurable</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">b</span><span class="main">.</span> emeasure <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span><span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X emeasure_bind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">R</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">b</span><span class="main">.</span> emeasure <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="bound">b</span> <span class="main">∂</span>stock_measure BOOL <span class="main">∂</span><span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> densf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AE_count_space <span class="dynamic"><span class="dynamic">field_simps</span></span> nn_integral_density
                      M_def space_dens_ctxt_measure stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="main">(</span>BoolVal True<span class="main">)</span> <span class="main">+</span>
                        emeasure <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="main">(</span>BoolVal False<span class="main">)</span> <span class="main">∂</span><span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> densf'<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nn_integral_BoolVal<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def nn_integral_BoolVal<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="main">(</span>BoolVal True<span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="main">(</span>BoolVal False<span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command">using</span></span> has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> densf'<span class="main">]</span> BoolVal_in_space
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_add<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="main">(</span>BoolVal True<span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span>
                  <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">δf</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>BoolVal True<span class="main">)</span> <span class="main">*</span>
                         <span class="main">(</span>emeasure <span class="main">(</span><span class="free">g</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> densf<span class="main">]</span> BoolVal_in_space <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_dens_ctxt_measure<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ρ mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="free">δg</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ X
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dc_True.nn_integral_dens_ctxt_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_dens_ctxt_measure_eq<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> has_parametrized_subprob_densityD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> densg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">*</span> <span class="free">δf</span> <span class="bound">x</span> <span class="main">(</span>BoolVal False<span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span>
                  <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">δf</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>BoolVal False<span class="main">)</span> <span class="main">*</span>
                         <span class="main">(</span>emeasure <span class="main">(</span><span class="free">h</span> <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> densf<span class="main">]</span> BoolVal_in_space <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_dens_ctxt_measure<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ρ mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="free">δh</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ X
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dc_False.nn_integral_dens_ctxt_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_dens_ctxt_measure_eq<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> has_parametrized_subprob_densityD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> densh<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="free">δg</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">+</span> emeasure <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="free">δh</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span>
                 emeasure <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δg</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">δh</span> <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X ρ
    <span class="keyword1"><span class="command">using</span></span> has_parametrized_subprob_densityD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> densg<span class="main">]</span>
          has_parametrized_subprob_densityD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> densh<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_density_add<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?lhs</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?rhs</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> density_context<span class="main">)</span> emeasure_bind_if_det_dens_ctxt_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> dens_ctxt_measure 𝒴 <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">=</span> BoolVal True"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">=</span> BoolVal False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dc1<span class="main">:</span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">σ</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dc2<span class="main">:</span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P'</span> <span class="bound">σ</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>stock_measure BOOL<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mg<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mh<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> densg<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">σ</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span> <span class="free">R</span> <span class="free">δg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> densh<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P'</span> <span class="bound">σ</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="free">h</span><span class="main">)</span> <span class="free">R</span> <span class="free">δh</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> density <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δg</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">δh</span> <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pred_eq_const1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pred_eq_const1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mf<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sets_lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="var">?lhs</span> <span class="main">=</span> sets <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sets_bind_measurable<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sets <span class="var">?lhs</span> <span class="main">=</span> sets <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Mg <span class="keyword1"><span class="command">have</span></span> Mg'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def measurable_dens_ctxt_measure_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Mh <span class="keyword1"><span class="command">have</span></span> Mh'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def measurable_dens_ctxt_measure_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> sets <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> sets <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> sets <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> sets <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_kernel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mh<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable_cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> sets <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"range BoolVal <span class="main">=</span> <span class="main">{</span>BoolVal True<span class="main">,</span> BoolVal False<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> X<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sets_lhs<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> dc_True<span class="main">:</span> density_context <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">σ</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> dc_False<span class="main">:</span> density_context <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P'</span> <span class="bound">σ</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span><span class="free">M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span>
          <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> emeasure <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="keyword1">else</span> emeasure <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∂</span><span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">measurable</span><span class="main">)</span>
       <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">+</span>
                        <span class="main">(</span><span class="keyword1">if</span> <span class="free">P'</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span><span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command">using</span></span> measurable_space<span class="main">[</span><span class="operator">OF</span> Mf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def P'_def stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P'</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_add<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="free">δg</span> <span class="free">ρ</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">R</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="free">δh</span> <span class="free">ρ</span> <span class="bound">y</span> <span class="main">*</span> indicator <span class="skolem">X</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">using</span></span> ρ X
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_dens_ctxt_measure<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dc_True.nn_integral_dens_ctxt_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dc_False.nn_integral_dens_ctxt_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_dens_ctxt_measure_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_has_parametrized_subprob_density<span class="main"><span class="main">[</span></span><span class="operator">OF</span> densg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_has_parametrized_subprob_density<span class="main"><span class="main">[</span></span><span class="operator">OF</span> densh<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="main">(</span>density <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">δg</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">δh</span> <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X ρ
    <span class="keyword1"><span class="command">using</span></span> has_parametrized_subprob_densityD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> densg<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> has_parametrized_subprob_densityD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> densh<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> emeasure_density<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_density_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?lhs</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="var">?rhs</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness proof›</span></span>

<span class="keyword1" id="PDF_Compiler_Pred-restrict_state_measure"><span class="command">lemma</span></span> restrict_state_measure<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> restrict <span class="bound">x</span> <span class="free">V'</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler_Pred-expr_has_density_sound_op"><span class="command">lemma</span></span> expr_has_density_sound_op<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>
                   <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Mg<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">ρ</span><span class="main">.</span> has_subprob_density <span class="bound">M</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">ρ</span><span class="main">)</span> <span class="main">⟹</span>
                            has_density <span class="main">(</span>distr <span class="bound">M</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="free">oper</span><span class="main">)</span><span class="main">)</span>
                                        <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="main">:</span> <span class="quoted"><span class="quoted">"op_type <span class="free">oper</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="free">oper</span> <span class="main">$$</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="free">oper</span> <span class="main">$$</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> Me<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="var">?M</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_dens_ctxt_measure_eq<span class="main">)</span>
         <span class="main">(</span><span class="operator">insert</span> assms t1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_expr_sem<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="free">oper</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="var">?N</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="var">?N</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.subprob_space_distr has_subprob_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_bind_measurable refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Me<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_op_sem t2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dens'<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_subprob_density_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> ρ
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="free">oper</span> <span class="main">$$</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_op_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> expr_typing.intros<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">...</span> <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Compiler_Pred-expr_has_density_sound_aux"><span class="command">lemma</span></span> expr_has_density_sound_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
          <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">σ</span> <span class="main">←</span> dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="bound">ρ</span><span class="main">;</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_has_density.induct<span class="main"><span class="main">[</span></span><span class="operator">split_format</span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_AE <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">f'</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> expr_typing_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_AE.IH<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> has_parametrized_subprob_density_dens_AE<span class="main">[</span><span class="operator">OF</span> hd_AE.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_dens_ctxt_cong <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">δ'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> dc'<span class="main">:</span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ'</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_dens_ctxt_cong.hyps <span class="keyword2"><span class="keyword">and</span></span> dc'.measurable_dens
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_cong<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"density_context <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> density_context_equiv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_dens_ctxt_cong.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> hd_dens_ctxt_cong.prems hd_dens_ctxt_cong.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> hd_dens_ctxt_cong.prems hd_dens_ctxt_cong.hyps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_dens_ctxt_cong.IH<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⟹</span>
                dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">=</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def AE_distr_iff hd_dens_ctxt_cong.hyps
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> <span class="var">?case</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_density_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_val <span class="skolem">v</span> <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> val_type <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_parametrized_subprob_densityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> branch_prob <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">*</span> indicator <span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span>
              borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_snd borel_measurable_indicator<span class="main"><span class="main">]</span></span>
                       borel_measurable_times_ennreal<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> return_probspace<span class="main">:</span> <span class="quoted"><span class="quoted">"prob_space <span class="main">(</span>return_val <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> return_val_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_space_return<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_const return_measurable<span class="main"><span class="main">]</span></span> subprob_space_bind
                      subprob_space_dens hd_val.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> hd_val.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>val_type <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> count_space <span class="main">(</span>type_universe <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> countable_type_imp_count_space<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_measure 𝒴 <span class="skolem">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            density <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> branch_prob 𝒴 <span class="skolem">ρ</span> <span class="main">*</span> indicator <span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> dens_ctxt_measure_bind_const<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> return_probspace<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def return_count_space_eq_density ρ
                     density_density_eq <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prob_space_imp_subprob_space<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_var <span class="skolem">x</span> <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_var <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_parametrized_subprob_densityI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="skolem">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> return <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="var">?f</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> hd_var ρ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_bind<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def t <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subprob_space_bind subprob_space_dens
                 measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_dens_ctxt_measure_component return_measurable<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hd_var.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="var">?f</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> return_val <span class="main">(</span><span class="bound">σ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_val_def t space_dens_ctxt_measure
                                 state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PiE_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> hd_var <span class="keyword1"><span class="command">interpret</span></span> dcm<span class="main">:</span> subprob_space <span class="quoted"><span class="quoted">"dens_ctxt_measure 𝒴 <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_dens ρ<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure 𝒴 <span class="skolem">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"density <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> marg_dens 𝒴 <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">∈</span>space <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="skolem">ρ</span><span class="main">)</span><span class="main">.</span> val_type <span class="main">(</span><span class="bound">σ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_var
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_dens_ctxt_measure space_PiM  PiE_iff
                     state_measure_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> dens_ctxt_measure 𝒴 <span class="skolem">ρ</span> <span class="main">⤜</span> <span class="main">(</span>return <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong_All<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_val_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> distr <span class="main">(</span>dens_ctxt_measure 𝒴 <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dcm.subprob_not_empty hd_var
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_distr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_dens_ctxt_measure_component<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> density_marg_dens_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">V</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t hd_var.prems ρ<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span> <span class="main">=</span> <span class="var">?M2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_marg_dens' <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_var t<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_let <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">e1</span> <span class="skolem">f</span> <span class="skolem">δ</span> <span class="skolem">e2</span> <span class="skolem">g</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="skolem">e1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="var">?t</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?δ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert_dens <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">f</span> <span class="skolem">δ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shift_var_set <span class="skolem">V</span><span class="main">,</span> Suc<span class="main">`</span><span class="skolem">V'</span><span class="main">,</span> <span class="var">?Γ'</span><span class="main">,</span> <span class="var">?δ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> hd_let.prems <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Γ'</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> dc<span class="main">:</span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density_context <span class="main">{}</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dc.density_context_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> hd_let.prems
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="skolem">V</span><span class="main">∪</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span>
                         <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_let.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> t1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_let.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_density_cong dens_ctxt_measure_empty_bind<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span><span class="main">∪</span><span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> expr_sem <span class="bound">ρ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="skolem">V'</span><span class="main">)</span> <span class="var">?Γ'</span><span class="main">)</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="var">?𝒴'</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_let.prems hd_let.hyps f subset_shift_var_set
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> t2 dc.density_context_insert<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> g<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span>case_nat undefined <span class="bound">ρ</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"state_measure <span class="main">(</span>shift_var_set <span class="main">(</span><span class="skolem">V</span><span class="main">∪</span><span class="skolem">V'</span><span class="main">)</span><span class="main">)</span> <span class="var">?Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> M_dcm<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="var">?M</span> <span class="main">=</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span><span class="main">∪</span><span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> M_dcm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">N</span><span class="main">.</span> measurable <span class="main">(</span><span class="var">?M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">N</span><span class="main">)</span> <span class="main">=</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span><span class="main">∪</span><span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">N</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="keyword1">do</span> <span class="main">{</span><span class="bound">σ</span> <span class="main">←</span> <span class="var">?M</span><span class="main">;</span> <span class="bound">y</span> <span class="main">←</span> expr_sem <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">;</span> return <span class="var">?N</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">σ</span><span class="main">)</span><span class="main">}</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> bind <span class="var">?R</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> hd_let.prems subset_shift_var_set
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> double_bind_assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> M_dcm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> M_dcm'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> hd_let.prems
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">∈</span>
                measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_expr_sem<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> dens_ctxt_measure <span class="var">?𝒴'</span> <span class="main">(</span>case_nat undefined <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_let.prems hd_let.hyps f ρ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dc.dens_ctxt_measure_insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_density_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat undefined <span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>Suc<span class="main">`</span><span class="skolem">V'</span><span class="main">)</span> <span class="var">?Γ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_case_nat_undefined ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>dens_ctxt_measure <span class="var">?𝒴'</span> <span class="main">(</span>case_nat undefined <span class="skolem">ρ</span><span class="main">)</span> <span class="main">⤜</span>
                           <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>case_nat undefined <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                                      <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>case_nat undefined <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_rand_det <span class="skolem">e</span> <span class="skolem">V'</span> <span class="skolem">V</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">dst</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span>  <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> dist_param_type <span class="skolem">dst</span>"</span></span> <span class="quoted"><span class="quoted">"randomfree <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="skolem">e</span> <span class="main">⊆</span> <span class="skolem">V'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_rand_det <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> dist_result_type <span class="skolem">dst</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dist_param_type <span class="skolem">dst</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> return_val <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⤜</span> dist_measure <span class="skolem">dst</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> hd_rand_det <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bind_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> expr_sem_rf_sound<span class="main">)</span>
                           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hd_rand_det <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="var">?M</span> <span class="main">⟹</span> val_type <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_expr_sem_rf<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> return <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⤜</span> dist_measure <span class="skolem">dst</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_rand_det <span class="keyword1"><span class="command">unfolding</span></span> return_val_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> return_val_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl bind_return<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_dist_measure<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_universe_def A <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                      <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure 𝒴 <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> branch_prob 𝒴 <span class="bound">ρ</span> <span class="main">*</span> dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">ρ</span> <span class="skolem">e</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_parametrized_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> branch_prob 𝒴 <span class="bound">ρ</span> <span class="main">*</span> dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">ρ</span> <span class="skolem">e</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>
                <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t<span class="main">)</span> <span class="operator">measurable</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dist_param_type <span class="skolem">dst</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> return_val <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⤜</span> dist_measure <span class="skolem">dst</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> hd_rand_det <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bind_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> expr_sem_rf_sound<span class="main">)</span>
                           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hd_rand_det <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="var">?M</span> <span class="main">⟹</span> val_type <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_expr_sem_rf<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> return <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⤜</span> dist_measure <span class="skolem">dst</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_rand_det <span class="keyword1"><span class="command">unfolding</span></span> return_val_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> return_val_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl bind_return<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_dist_measure<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_universe_def A <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="main">(</span>restrict <span class="bound">σ</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="bound">v</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span>"</span></span>
              <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="var">?N</span> <span class="var">?R</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bind_has_subprob_density<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"space <span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM PiE_eq_empty_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="var">?M</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_dist_measure<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
           <span class="main">(</span><span class="operator">insert</span> hd_rand_det<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_expr_sem_rf<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="main">(</span>restrict <span class="bound">x</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>
               <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="var">?M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">σ</span> <span class="skolem">V'</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def restrict_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> hd_rand_det <span class="keyword1"><span class="command">have</span></span> restr<span class="main">:</span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="main">(</span>restrict <span class="skolem">σ</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">=</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_rf_eq_on_vars<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> hd_rand_det <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="main">(</span>restrict <span class="skolem">σ</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> dist_param_type <span class="skolem">dst</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_type_expr_sem_rf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ σ'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> restr
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
               <span class="main">(</span>dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_rand_det
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> dist_measure_has_density<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> val_type_expr_sem_rf <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_universe_def dens_ctxt_measure_def
                 state_measure'_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
       <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                <span class="main">(</span>dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="main">(</span>restrict <span class="skolem">σ</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restr<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> ρ<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subprob_space_dens<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> dist_param_type <span class="skolem">dst</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_rand_det ρ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_expr_sem_rf<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e</span> <span class="main">∈</span> type_universe <span class="main">(</span>dist_param_type <span class="skolem">dst</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_universe_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> dist_measure <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> branch_prob 𝒴 <span class="skolem">ρ</span> <span class="main">*</span> dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_rand_det
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> has_subprob_density_equal_on_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_dens_ctxt_measure_restrict<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t ρ<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> has_parametrized_subprob_density_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_rand <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">dst</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dist_param_type <span class="skolem">dst</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> hd_rand.prems <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> dist_result_type <span class="skolem">dst</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hd_rand.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_rand.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_parametrized_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI conjI impI<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>dist_param_type <span class="skolem">dst</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="main">(</span>apply_dist_to_dens <span class="skolem">dst</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∈</span>
              borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> apply_dist_to_dens_def t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> meas_M<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="var">?M</span> <span class="main">=</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> hd_rand <span class="keyword1"><span class="command">have</span></span> Me<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="var">?M</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="var">?t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> meas_M<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> dist_measure <span class="skolem">dst</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bind_assoc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Me<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">insert</span> hd_rand<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_dist_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def
                     space_PiM PiE_eq_empty_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dens ρ Me <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="var">?N</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>apply_dist_to_dens <span class="skolem">dst</span> <span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> apply_dist_to_dens_def has_parametrized_subprob_density_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t2<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bind_has_subprob_density'<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_rand.IH space_bind_measurable
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_dist_dens dist_measure_has_subprob_density<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                      <span class="main">(</span>apply_dist_to_dens <span class="skolem">dst</span> <span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_fail <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
            <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> null_measure <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> hd_fail <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_density_def
                           <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> null_measure_has_subprob_density<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> <span class="var">?case</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_density_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_bind_const subprob_space_null_measure_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_pair <span class="skolem">x</span> <span class="skolem">V</span> <span class="skolem">y</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> hd_pair.prems <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> PRODUCT <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">σ</span> <span class="skolem">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span><span class="main">∪</span><span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hd_pair <span class="keyword1"><span class="command">unfolding</span></span> t state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> distr <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span><span class="main">)</span> <span class="var">?R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">σ</span> <span class="skolem">y</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>marg_dens2 𝒴 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_parametrized_subprob_densityI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> hd_pair.hyps ρ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="var">?M</span> <span class="var">?R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="skolem">x</span> <span class="main">,</span> <span class="bound">σ</span> <span class="skolem">y</span> <span class="main">|&gt;</span><span class="main">)</span> <span class="main">=</span> density <span class="var">?R</span>  <span class="main">(</span>marg_dens2 𝒴 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> density_marg_dens2_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">interpret</span></span> subprob_space <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space_dens<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>distr <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="var">?R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="skolem">x</span> <span class="main">,</span><span class="bound">σ</span> <span class="skolem">y</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space_distr<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meas measurable_dens_ctxt_measure_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_marg_dens2' hd_pair.hyps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hd_pair.hyps
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> distr <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span><span class="main">)</span> <span class="var">?R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="main">&lt;|</span><span class="bound">σ</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">σ</span> <span class="skolem">y</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> return_val <span class="main">&lt;|</span><span class="bound">σ</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">σ</span> <span class="skolem">y</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext bind_return_val<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meas measurable_dens_ctxt_measure_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> expr_sem_pair_vars<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_if <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">δ</span> <span class="skolem">e1</span> <span class="skolem">g1</span> <span class="skolem">e2</span> <span class="skolem">g2</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> dc<span class="main">:</span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_if.prems <span class="keyword1"><span class="command">have</span></span> tb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">b</span> <span class="main">:</span> BOOL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="skolem">V</span><span class="main">∪</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure BOOL<span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> hd_if.prems tb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_if.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>
                       <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>stock_measure BOOL<span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?P</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> hd_if.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_density_cong dens_ctxt_measure_empty_bind<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_expr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tb<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span> <span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span>if_dens <span class="skolem">δ</span> <span class="skolem">f</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">ρ</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> dc'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> density_context <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="main">(</span>if_dens <span class="skolem">δ</span> <span class="skolem">f</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dc.density_context_if_dens<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g1<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="var">?M'</span> True <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">g1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_if.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_if.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1 dc'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> g2<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="var">?M'</span> False <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">g2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_if.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_if.IH<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> t2 dc'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_parametrized_subprob_densityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="skolem">g1</span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">g2</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="var">?M</span> <span class="skolem">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="skolem">b</span> <span class="keyword1">THEN</span> <span class="skolem">e1</span> <span class="keyword1">ELSE</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ hd_if.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stock_measure <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dc.subprob_space_dens<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_expr_sem <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_dens_ctxt_measure_eq
               <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> expr_sem.simps<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="skolem">b</span> <span class="keyword1">THEN</span> <span class="skolem">e1</span> <span class="keyword1">ELSE</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              density <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g1</span> <span class="skolem">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">g2</span> <span class="skolem">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ hd_if.prems f g1 g2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> dc.emeasure_bind_if_dens_ctxt_measure<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_dens_ctxt_measure_eq if_dens_def
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stock_measure.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_expr_sem<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_if_det <span class="skolem">b</span> <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e1</span> <span class="skolem">g1</span> <span class="skolem">e2</span> <span class="skolem">g2</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> dc<span class="main">:</span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_if_det.prems <span class="quoted"><span class="quoted">‹randomfree <span class="skolem">b</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> tb<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">b</span> <span class="main">:</span> BOOL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"randomfree <span class="skolem">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t1<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fv_b<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="skolem">b</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fv_e1<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="skolem">e1</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fv_e2<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">raw</span><span class="main"><span class="main">)</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="skolem">e2</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span>if_dens_det <span class="skolem">δ</span> <span class="skolem">b</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="var">?M</span> <span class="bound">ρ</span><span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="keyword1">if</span> expr_sem_rf <span class="bound">σ</span> <span class="skolem">b</span> <span class="main">=</span> BoolVal True <span class="keyword1">then</span> expr_sem <span class="bound">σ</span> <span class="skolem">e1</span> <span class="keyword1">else</span> expr_sem <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> hd_if_det.hyps hd_if_det.prems tb
    <span class="keyword1"><span class="command">have</span></span> dc'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> density_context <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="main">(</span>if_dens_det <span class="skolem">δ</span> <span class="skolem">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dc.density_context_if_dens_det<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> g1<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="var">?M'</span> True <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">g1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_if_det.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_if_det.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dc' t1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g2<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="var">?M'</span> False <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">g2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_if_det.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_if_det.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dc' t2<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> val_type_expr_sem_rf<span class="main">[</span><span class="operator">OF</span> tb<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span>"</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?N</span>
            <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">g1</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="skolem">g2</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_parametrized_subprob_densityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="skolem">g1</span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">g2</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="var">?N</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ hd_if_det.prems hd_if_det.hyps t1 t2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stock_measure <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dc.subprob_space_dens<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="skolem">ρ</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g1</span> <span class="skolem">ρ</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">g2</span> <span class="skolem">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ hd_if_det.prems g1 g2 dc' hd_if_det.prems <span class="keyword1"><span class="command">unfolding</span></span> if_dens_det_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dc.emeasure_bind_if_det_dens_ctxt_measure<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_dens_ctxt_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hd_if_det.prems hd_if_det.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> <span class="var">?case</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_density_cong bind_cong refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> expr_sem_rf_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tb<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">V</span></span> <span class="main"><span class="main">∪</span></span> <span class="skolem"><span class="skolem">V'</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_dens_ctxt_measure bind_return_val''<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_fst <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_fst.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Snd <span class="main">$$</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_typing.intros<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="main">(</span>Snd <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="var">?N</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_fst.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_fst.prems hd_fst.hyps t<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="skolem">t'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Fst <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI impI<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="var">?N</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Fst<span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="var">?R</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_density_distr_Fst<span class="main">)</span>  <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hd_fst.prems <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Fst <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_op_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">...</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t2<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_snd <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_snd.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Fst <span class="main">$$</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_typing.intros<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="main">(</span>Fst <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="var">?N</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_snd.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_snd.prems hd_snd.hyps t<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Snd <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI impI<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="var">?N</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem Snd<span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="var">?R</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_density_distr_Snd<span class="main">)</span>  <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hd_snd.prems <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Snd <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_op_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">...</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t2<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_op_discr <span class="skolem">Γ</span> <span class="skolem">oper</span> <span class="skolem">e</span> <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">δ</span> <span class="skolem">f</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_op_discr.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type <span class="skolem">oper</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_op_discr.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_op_discr.prems hd_op_discr.hyps t1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> hd_op_discr t1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expr_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"expr_type <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">oper</span> <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t1'<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2'<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">oper</span> <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> hd_op_discr <span class="keyword1"><span class="command">have</span></span> countable<span class="main">:</span> <span class="quoted"><span class="quoted">"countable_type <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> distr <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>
                         <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="skolem">oper</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> op_sem <span class="skolem">oper</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_densityI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> op_sem <span class="skolem">oper</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> sigma_finite_measure.borel_measurable_nn_integral<span class="main">[</span><span class="operator">OF</span> sigma_finite_stock_measure<span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> measurable_op_sem<span class="main">[</span><span class="operator">OF</span> t2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="var">?N</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> hd_op_discr.prems t1
      <span class="keyword1"><span class="command">have</span></span> M_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span>  measurable <span class="var">?M</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_dens_ctxt_measure_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_expr_sem<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> M_e <span class="keyword1"><span class="command">have</span></span> meas_N<span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="var">?N</span> <span class="main">=</span> measurable <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext measurable_cong_sets<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_bind_measurable<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens' <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span>distr <span class="var">?N</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="skolem">oper</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space.subprob_space_distr<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_op_sem <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> meas_N<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> countable <span class="keyword1"><span class="command">have</span></span> count_space<span class="main">:</span> <span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t'</span> <span class="main">=</span> count_space <span class="main">(</span>type_universe <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> countable_type_imp_count_space<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> type_universe <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> M_e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>op_sem <span class="skolem">oper</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> op_sem_val_type<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t2<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> op_sem_type_universe <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> countable countable_type_countable measurable_op_sem<span class="main">[</span><span class="operator">OF</span> t2<span class="main">]</span> dens'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">...</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="skolem">oper</span><span class="main">)</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> count_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> distr_density_discrete<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> meas_N count_space <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> op_sem_type_universe <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distr <span class="var">?N</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="skolem">oper</span><span class="main">)</span> <span class="main">=</span>  density <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> hd_op_discr.prems
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⟹</span>
              distr <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem <span class="skolem">oper</span><span class="main">)</span> <span class="main">=</span>
                 dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="skolem">oper</span> <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_op_eq_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_density_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> t1' A<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_neg <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> hd_neg.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type Minus <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_neg.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_neg.prems hd_neg.hyps t1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> hd_neg <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lift_RealIntVal uminus uminus <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="skolem">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">(</span>op_sem Minus <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> space_M<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="skolem">M</span> <span class="main">=</span> space <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t2 <span class="keyword1"><span class="command">have</span></span> t_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">=</span> REAL <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> REAL<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">=</span> INTEG <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> INTEG<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem Minus<span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>op_sem Minus <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> REAL"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_RealVal uminus<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>
                        <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealVal <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_lift_RealVal<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distr_uminus_real <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_density_imp_has_density<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_RealVal uminus<span class="main">)</span> <span class="main">=</span>
                     distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_RealIntVal uminus uminus<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lift_RealIntVal_Real<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_M A<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">...</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealVal <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real<span class="main">)</span> <span class="main">⟷</span>
                   has_density <span class="main">...</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>lift_RealIntVal uminus uminus <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_cong<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal_def extract_real_def A space_embed_measure <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> INTEG"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> INTEG"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_IntVal uminus<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>
                        <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>IntVal <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_lift_IntVal<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distr_uminus_ring_count_space <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_subprob_density_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_IntVal uminus<span class="main">)</span> <span class="main">=</span>
                     distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_RealIntVal uminus uminus<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lift_RealIntVal_Int<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_M A<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">...</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>IntVal <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int<span class="main">)</span> <span class="main">⟷</span>
                   has_density <span class="main">...</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>lift_RealIntVal uminus uminus <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_cong<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal_def extract_int_def A space_embed_measure <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_exp <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> hd_exp.prems <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_exp.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_exp.prems hd_exp.hyps t1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> hd_exp <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">REAL</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lift_RealVal safe_ln <span class="main">∈</span> measurable <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="skolem">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure REAL<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> extract_real <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span>
                         <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">(</span>lift_RealVal safe_ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span>extract_real <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="skolem">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> space_M<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="skolem">M</span> <span class="main">=</span> space <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_RealVal exp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>
            <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealVal <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
               <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">_</span> <span class="main">_</span> <span class="var">?f'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> dens'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> distr_lift_RealVal<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">f</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">&gt;</span></span> <span class="main"><span class="main">0</span></span> <span class="keyword1"><span class="keyword1">then</span></span> <span class="bound"><span class="bound">f</span></span> <span class="main"><span class="main">(</span></span>ln <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span> ennreal <span class="main"><span class="main">(</span></span>inverse <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">0</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subprob_density_distr_real_exp <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> has_subprob_density_imp_has_density<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def lift_RealVal_def extract_real_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem Exp<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">...</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_inv <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> hd_inv.prems <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_inv.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_inv.prems hd_inv.hyps t1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> hd_inv <span class="keyword2"><span class="keyword">and</span></span> t1 <span class="keyword2"><span class="keyword">and</span></span> t2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">REAL</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t2 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lift_RealVal inverse <span class="main">∈</span> measurable <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword1"><span class="command">have</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="skolem">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure REAL<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_parametrized_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">(</span>op_sem Inverse <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span>extract_real <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extract_real <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t2<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="skolem">M</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> space_M<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="skolem">M</span> <span class="main">=</span> space <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>lift_RealVal inverse<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>
            <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealVal <span class="main">(</span>inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∘</span> extract_real<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">_</span> <span class="main">_</span> <span class="var">?f'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> dens'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> distr_lift_RealVal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subprob_density_distr_real_inverse <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> has_subprob_density_imp_has_density
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> inverse_mult_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def lift_RealVal_def extract_real_def power2_eq_square <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>op_sem Inverse<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">...</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_addc <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">e'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_addc.prems <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> INTEG"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type Add <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_addc.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_addc.prems t1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">_</span> <span class="var">?N</span> <span class="main">_</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_parametrized_subprob_density_def has_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI ballI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t2 t_disj hd_addc.prems hd_addc.hyps
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> addc_density_measurable has_parametrized_subprob_densityD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"extract_int <span class="main">(</span>expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?v2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> Me<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span>
                   measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t1 hd_addc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_expr_sem<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> hd_addc.prems hd_addc.hyps ρ <span class="keyword1"><span class="command">have</span></span> vt_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_expr_sem_rf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> space_e<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> type_universe <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> space_bind_measurable<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_dens_ctxt_measure_eq<span class="main">)</span>
         <span class="main">(</span><span class="operator">rule</span> Me<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> hd_addc.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="var">?N</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_bind subprob_space_dens<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">subst</span> measurable_dens_ctxt_measure_eq<span class="main">)</span>
         <span class="main">(</span><span class="operator">rule</span> measurable_expr_sem<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                          <span class="main">(</span>lift_RealIntVal <span class="main">(</span><span class="main">(+)</span> <span class="var">?v1</span><span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="var">?v2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_disj
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>lift_RealVal <span class="main">(</span><span class="main">(+)</span> <span class="var">?v2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealVal <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="var">?v2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real"</span></span>
      <span class="keyword1"><span class="command">from</span></span> dens' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N''</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_lift_RealVal<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distr_plus_real <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_density_imp_has_density<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N''</span> <span class="main">=</span> <span class="var">?N'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealVal_def lift_RealIntVal_def extract_real_def vt_e' space_e t
                 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f'</span> <span class="main">=</span> has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vt_e' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_cong<span class="main">)</span>
                        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal_def t extract_real_def space_embed_measure
                          lift_RealIntVal2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> INTEG"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>lift_IntVal <span class="main">(</span><span class="main">(+)</span> <span class="var">?v1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>IntVal <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="var">?v1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_int"</span></span>
      <span class="keyword1"><span class="command">from</span></span> dens' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N''</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_lift_IntVal<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distr_plus_ring_count_space <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_density_imp_has_density<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N''</span> <span class="main">=</span> <span class="var">?N'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_IntVal_def lift_RealIntVal_def extract_real_def vt_e' space_e t
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f'</span> <span class="main">=</span> has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vt_e' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_cong<span class="main">)</span>
                        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal_def t extract_int_def space_embed_measure
                          lift_RealIntVal2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N'</span> <span class="main">=</span> distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                          <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> op_sem Add <span class="main">&lt;|</span><span class="bound">w</span><span class="main">,</span> expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e'</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_disj vt_e'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal_def
            lift_RealIntVal2_def space_e extract_real_def extract_int_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?N</span> <span class="skolem">ρ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hd_addc.prems hd_addc.hyps t_disj ρ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bin_op_randomfree_restructure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1 t2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="var">?N</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_multc <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_multc.prems hd_multc.hyps
    <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="skolem">c</span> <span class="main">=</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE expr_typing_valE expr_typing_pairE<span class="main"><span class="keyword3">,</span></span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type Mult <span class="main">(</span>PRODUCT REAL REAL<span class="main">)</span> <span class="main">=</span> Some REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_multc.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_multc.prems t1 t<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">_</span> <span class="var">?N</span> <span class="main">_</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> has_parametrized_subprob_density_def has_subprob_density_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI ballI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?MR</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?MP</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> M_mult<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>op_sem Mult<span class="main">)</span> <span class="main">∈</span> measurable <span class="var">?MP</span> <span class="var">?MR</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_op_sem t<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span> <span class="main">(</span><span class="operator">insert</span> t2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t val_type_eq_REAL lift_RealVal_def<span class="main">)</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def has_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> Me<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span>
                   measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="skolem">V</span> <span class="main">∪</span> <span class="skolem">V'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure REAL<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t1 hd_multc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_expr_sem<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span> space_e<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> range RealVal"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> space_bind_measurable<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_dens_ctxt_measure_eq<span class="main">)</span>
         <span class="main">(</span><span class="operator">rule</span> Me<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t space_embed_measure type_universe_REAL<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> hd_multc.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_space <span class="main">(</span><span class="var">?N</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_space_bind subprob_space_dens<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">subst</span> measurable_dens_ctxt_measure_eq<span class="main">)</span>
         <span class="main">(</span><span class="operator">rule</span> measurable_expr_sem<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                          <span class="main">(</span>lift_RealVal <span class="main">(</span><span class="main">(*)</span> <span class="main">(</span>extract_real <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> extract_real <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>inverse <span class="main">(</span>abs <span class="main">(</span>extract_real <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealVal <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> extract_real <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                    inverse <span class="main">(</span>abs <span class="main">(</span>extract_real <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> extract_real"</span></span>
    <span class="keyword1"><span class="command">from</span></span> hd_multc.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extract_real_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dens' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="var">?f'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_lift_RealVal<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?g</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distr_mult_real <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_subprob_density_imp_has_density<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="var">?f'</span> <span class="main">=</span>
                    has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> hd_multc.hyps
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_cong<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealVal_def t extract_real_def space_embed_measure
                      lift_RealIntVal2_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="var">?N'</span> <span class="main">(</span>stock_measure REAL<span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N'</span> <span class="main">=</span> distr <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                          <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> op_sem Mult <span class="main">&lt;|</span><span class="bound">w</span><span class="main">,</span> expr_sem_rf <span class="skolem">ρ</span> <span class="main">(</span>Val <span class="skolem">c</span><span class="main">)</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_multc.hyps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealVal_def lift_RealIntVal2_def space_e extract_real_def
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?N</span> <span class="skolem">ρ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hd_multc.prems hd_multc.hyps ρ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bin_op_randomfree_restructure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> expr_typing.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span><span class="var">?N</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hd_add <span class="skolem">V</span> <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">δ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> hd_add.prems hd_add.hyps
    <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> PRODUCT <span class="skolem">t</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type Add <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          t_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> INTEG"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE expr_typing_valE expr_typing_pairE<span class="main"><span class="keyword3">,</span></span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"PRODUCT <span class="skolem">t</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span><span class="skolem">V'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="var">?tp</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_add.IH<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> hd_add.prems t1 t2 t_disj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> hd_add.prems hd_add.hyps t1 t2 t_disj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">_</span> <span class="var">?N</span> <span class="main">_</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_op<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> sigma_finite_measure.borel_measurable_nn_integral<span class="main">[</span><span class="operator">OF</span> sigma_finite_stock_measure<span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"op_type Minus <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_disj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> measurable_op_sem<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> t2<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">ρ</span>  <span class="main">&lt;|</span><span class="bound">x</span> <span class="main">,</span> op_sem Add <span class="main">&lt;|</span><span class="bound">z</span><span class="main">,</span> op_sem Minus <span class="bound">x</span><span class="main">|&gt;</span><span class="main">|&gt;</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f'</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">⟷</span>
                    case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_pair_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="skolem">V'</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> Mf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_subprob_densityD<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="skolem">V</span><span class="main">,</span> <span class="skolem">V'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Add<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> t_disj<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealPairVal <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">∘</span> extract_real"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Add<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dens'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t op_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_lift_RealPairVal<span class="main">)</span>
            <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> borel_prod<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> has_subprob_density_imp_has_density
                           distr_convolution_real<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f''</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>RealPairVal <span class="main">(</span><span class="bound">x</span><span class="main">,</span> extract_real <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?f''</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t space_embed_measure extract_real_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> val_type <span class="bound">z</span> <span class="main">=</span> REAL <span class="main">⟹</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span>  <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> op_sem Add <span class="main">&lt;|</span><span class="bound">z</span><span class="main">,</span> op_sem Minus <span class="bound">x</span><span class="main">|&gt;</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Mf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> measurable_compose_rev<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Add<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f''</span> <span class="main">⟷</span>
              has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Add<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t space_embed_measure <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> op_sem.simps<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_RealVal RealPairVal_def lift_RealIntVal2_def lift_RealIntVal_def val_type_eq_REAL<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> INTEG"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>IntPairVal <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">∘</span> extract_int"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Add<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dens'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t op_sem.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> distr_lift_IntPairVal<span class="main">)</span>
            <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_subprob_density_imp_has_density
                           distr_convolution_ring_count_space<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f''</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>IntPairVal <span class="main">(</span><span class="bound">x</span><span class="main">,</span> extract_int <span class="bound">z</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?f''</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t space_embed_measure extract_int_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Add<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f''</span> <span class="main">⟷</span>
              has_density <span class="main">(</span>distr <span class="skolem">M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>op_sem Add<span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_density_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t space_embed_measure <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> op_sem.simps<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  nn_integral_IntVal IntPairVal_def val_type_eq_INTEG
                          lift_RealIntVal2_def lift_RealIntVal_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Compiler_Pred-hd_cong"><span class="command">lemma</span></span> hd_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">ρ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">V'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> AE_I2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> dens <span class="main">=</span> expr_has_density_sound_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> dens' <span class="main">=</span> has_parametrized_subprob_densityD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> dens'<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"case_prod <span class="free"><span class="free"><span class="free">f</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_pair_measure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Compiler_Pred-prob_space_empty_dens_ctxt"><span class="command">lemma</span></span> prob_space_empty_dens_ctxt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"prob_space <span class="main">(</span>dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> density_context_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def
                   emeasure_distr emeasure_density PiM_empty <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prob_spaceI<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler_Pred-branch_prob_empty_ctxt"><span class="command">lemma</span></span> branch_prob_empty_ctxt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"branch_prob <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> branch_prob_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prob_space.emeasure_space_1<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1" id="PDF_Compiler_Pred-expr_has_density_sound"><span class="command">lemma</span></span> expr_has_density_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density_context <span class="main">{}</span> <span class="main">{}</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> density_context_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_measure_def state_measure'_def state_measure_def
                   emeasure_distr emeasure_density PiM_empty <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subprob_spaceI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> expr_has_density_sound_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">{}</span> <span class="free">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state_measure <span class="main">{}</span> <span class="free">Γ</span> <span class="main">=</span> count_space <span class="main">{</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def PiM_empty emeasure_density<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span><span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>
                                 <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">{}</span> <span class="free">Γ</span><span class="main">)</span>
                                                        <span class="main">(</span>subprob_algebra <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_expr_sem<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> expr_sem <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dens_ctxt_measure_empty_bind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def PiM_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> expr_sem <span class="free">σ</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_eq_on_vars<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PDF_Target_Semantics">
<div class="head">
<h1>Theory PDF_Target_Semantics</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Target_Semantics.thy
  Authors: Manuel Eberl

  The semantics of the target language.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Target Language Syntax and Semantics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Target_Semantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PDF_Semantics.html">PDF_Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> cexpr <span class="main">=</span>
    CVar <span class="quoted">vname</span>
  <span class="main">|</span> CVal <span class="quoted">val</span>
  <span class="main">|</span> CPair <span class="quoted">cexpr</span> <span class="quoted">cexpr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">&lt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="main">|</span> COperator <span class="quoted">pdf_operator</span> <span class="quoted">cexpr</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 999<span class="main">)</span>
  <span class="main">|</span> CIf <span class="quoted">cexpr</span> <span class="quoted">cexpr</span> <span class="quoted">cexpr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">ELSE</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="main">|</span> CIntegral <span class="quoted">cexpr</span> <span class="quoted">pdf_type</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∂</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_"</span> <span class="main">[</span>61<span class="main">]</span> 110<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">cexpr_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cexpr <span class="main">⇒</span> cexpr<span class="main">)</span> <span class="main">⇒</span> cexpr"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_fun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Add</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Add</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> Add <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Minus</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> _"</span> <span class="main">[</span>81<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Minus</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> Minus <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Sub</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Sub</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span><span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Mult</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Mult</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> Mult <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inverse<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>Inverse <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Div</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">'/<span class="hidden">⇩</span><sub>c</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Div</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> inverse<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fact<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> Fact <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sqrt<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> Sqrt <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">exp<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> Exp <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ln<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> Ln <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fst<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> Fst <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">snd<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> Snd <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Pow</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Pow</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> Pow <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_And</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span>"</span> 35<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_And</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> And <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Or</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∨<span class="hidden">⇩</span><sub>c</sub></span>"</span> 30<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Or</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> Or <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Not</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">¬<span class="hidden">⇩</span><sub>c</sub></span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Not</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> Not <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Equals</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Equals</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> Equals <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_Less</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_Less</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> Less <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_LessEq</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_LessEq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">∨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cexpr_RealCast</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span>"</span> <span class="main">[</span>0<span class="main">]</span> 90<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_RealCast</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> Cast REAL <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CReal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CReal</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> CVal <span class="main">(</span>RealVal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CInt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CInt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> CVal <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">π<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">π<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">≡</span> Pi <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>CVal UnitVal<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> cexpr <span class="main">::</span> <span class="quoted">expr</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">free_vars_cexpr</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cexpr <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">free_vars_cexpr</span> <span class="main">(</span>CVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_cexpr</span> <span class="main">(</span>CVal <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_cexpr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_cexpr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_cexpr</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">free_vars_cexpr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">free_vars_cexpr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_cexpr</span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
       <span class="free">free_vars_cexpr</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∪</span> <span class="free">free_vars_cexpr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">free_vars_cexpr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free_vars_cexpr</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">-`</span> <span class="free">free_vars_cexpr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">cexpr_typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> cexpr <span class="main">⇒</span> pdf_type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span>_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span><span class="keyword3">/ </span><span class="keyword3">(</span>_ <span class="keyword1">:</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  cet_val<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main"><span class="free">:</span></span> val_type <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> cet_var<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> CVar <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> cet_pair<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="main"><span class="free">:</span></span> PRODUCT <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> cet_op<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> op_type <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> cet_if<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="free">:</span></span> BOOL <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
                   <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> cet_int<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> REAL <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> REAL"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cet_val'"><span class="command">lemma</span></span> cet_val'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> val_type <span class="free">v</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> CVal <span class="free">v</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_val<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_var'"><span class="command">lemma</span></span> cet_var'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">Γ</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="free">x</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_var<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_not"><span class="command">lemma</span></span> cet_not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> BOOL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">¬<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"BOOL"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_and"><span class="command">lemma</span></span> cet_and<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> BOOL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> BOOL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">∨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT BOOL BOOL"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cet_minus_real"><span class="command">lemma</span></span> cet_minus_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span><span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> inverse<span class="hidden">⇩</span><sub>c</sub> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> sqrt<span class="hidden">⇩</span><sub>c</sub> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> exp<span class="hidden">⇩</span><sub>c</sub> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_ln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> ln<span class="hidden">⇩</span><sub>c</sub> <span class="free">e</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"REAL"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cet_pow_real"><span class="command">lemma</span></span> cet_pow_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT REAL INTEG"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_add_real"><span class="command">lemma</span></span> cet_add_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_mult_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_less_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT REAL REAL"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1" id="PDF_Target_Semantics-cet_eq"><span class="command">lemma</span></span> cet_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT <span class="free"><span class="free"><span class="free">t</span></span></span> <span class="free"><span class="free"><span class="free">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cet_less_eq_real"><span class="command">lemma</span></span> cet_less_eq_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_less_real cet_or cet_eq<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_minus_int"><span class="command">lemma</span></span> cet_minus_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span><span class="free">e</span> <span class="main">:</span> INTEG"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"INTEG"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cet_add_int"><span class="command">lemma</span></span> cet_add_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_mult_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_less_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT INTEG INTEG"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cet_less_eq_int"><span class="command">lemma</span></span> cet_less_eq_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_less_int cet_or cet_eq<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_sub_int"><span class="command">lemma</span></span> cet_sub_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> INTEG"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_minus_int cet_add_int<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_fst"><span class="command">lemma</span></span> cet_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> PRODUCT <span class="free">t</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cet_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> PRODUCT <span class="free">t</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free">e</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> cet_op<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cet_cast_real"><span class="command">lemma</span></span> cet_cast_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> BOOL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="free">e</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">BOOL</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_cast_real_int"><span class="command">lemma</span></span> cet_cast_real_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> INTEG <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="free">e</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">INTEG</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_sub_real"><span class="command">lemma</span></span> cet_sub_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_minus_real cet_add_real<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cet_pi"><span class="command">lemma</span></span> cet_pi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> π<span class="hidden">⇩</span><sub>c</sub> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cet_op<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_val<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> cet_op_intros <span class="main">=</span>
  cet_minus_real cet_exp cet_sqrt cet_ln cet_inverse cet_pow_real cet_pi
  cet_cast_real cet_add_real cet_mult_real cet_less_real
  cet_not cet_and cet_or

<span class="keyword1"><span class="command">inductive_cases</span></span> cexpr_typing_valE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> CVal <span class="free">v</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> cexpr_typing_varE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="free">x</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> cexpr_typing_pairE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span><span class="free">e1</span><span class="main">,</span> <span class="free">e2</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> cexpr_typing_opE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">oper</span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> cexpr_typing_ifE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">e1</span> <span class="keyword1">ELSE</span> <span class="free">e2</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> cexpr_typing_intE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">∂</span><span class="free">t</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cexpr_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> cexpr <span class="main">⇒</span> pdf_type option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_type</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>val_type <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>CVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
                                <span class="main">(</span>Some <span class="bound">t1</span><span class="main">,</span> Some <span class="bound">t2</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>PRODUCT <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>
                              <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
                                 Some <span class="bound">t</span> <span class="main">⇒</span> op_type <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="bound">t</span>
                               <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
                              <span class="main">(</span><span class="keyword1">if</span> <span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> Some BOOL <span class="keyword1">then</span>
                                 <span class="keyword1">case</span> <span class="main">(</span><span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
                                   <span class="main">(</span>Some <span class="bound">t</span><span class="main">,</span> Some <span class="bound">t'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">t'</span> <span class="keyword1">then</span> Some <span class="bound">t</span> <span class="keyword1">else</span> None
                                 <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
                               <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">cexpr_type</span> <span class="main">(</span>case_nat <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Some REAL <span class="keyword1">then</span> Some REAL <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_type_Some_iff"><span class="command">lemma</span></span> cexpr_type_Some_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"cexpr_type <span class="free">Γ</span> <span class="free">e</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cexpr_typing.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> cexpr_typing_code<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span> <span class="main">=</span> cexpr_type_Some_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_cong'"><span class="command">lemma</span></span> cexpr_typing_cong'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> free_vars <span class="free">e</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cexpr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cet_int <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">Γ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> free_vars <span class="skolem">e</span> <span class="main">⟹</span> case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="bound">x</span> <span class="main">=</span> case_nat <span class="skolem">t</span> <span class="skolem">Γ'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cet_int.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_cong"><span class="command">lemma</span></span> cexpr_typing_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> free_vars <span class="free">e</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> cexpr_typing_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cexpr_sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> cexpr <span class="main">⇒</span> val"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>CVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">=</span> <span class="main">&lt;|</span><span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">|&gt;</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> op_sem <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">(</span><span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> TRUE <span class="keyword1">then</span> <span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">else</span> <span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_sem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> RealVal <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span><span class="free">cexpr_sem</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∂</span><span class="main">(</span>stock_measure <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cexpr_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cexpr <span class="main">⇒</span> cexpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_equiv</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> cexpr_sem <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> cexpr_sem <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_equiv_commute"><span class="command">lemma</span></span> cexpr_equiv_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"cexpr_equiv <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟷</span> cexpr_equiv <span class="free">e2</span> <span class="free">e1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_equiv_def<span class="main">)</span>


<span class="keyword1" id="PDF_Target_Semantics-val_type_cexpr_sem"><span class="command">lemma</span></span> val_type_cexpr_sem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cexpr_typing.induct<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> state_measure_var_type op_sem_val_type<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_eq_on_vars"><span class="command">lemma</span></span> cexpr_sem_eq_on_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> free_vars <span class="free">e</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">σ'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="free">e</span> <span class="main">=</span> cexpr_sem <span class="free">σ'</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CPair <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> CPair.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> CPair.IH<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>COperator <span class="skolem">oper</span> <span class="skolem">e</span> <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> COperator.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> COperator.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="skolem">σ'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIf <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> CIf.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CIf.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> RealVal <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> CIntegral.prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> cexpr_sem <span class="main">(</span>case_nat <span class="bound">v</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> cexpr_sem <span class="main">(</span>case_nat <span class="bound">v</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext CIntegral.IH<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RealVal <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> cexpr_sem <span class="skolem">σ'</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_cexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cexpr <span class="main">⇒</span> state <span class="main">⇒</span> val <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_cexpr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-measurable_cexpr_sem"><span class="command">lemma</span></span> measurable_cexpr_sem<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> cexpr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cexpr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cet_op <span class="skolem">oper</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> measurable_op_sem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cet_int <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">x</span><span class="main">∈</span><span class="skolem">V</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="skolem">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"embed_measure lborel RealVal"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> cexpr_sem <span class="bound">a</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="skolem">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> REAL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cet_int.prems subset_shift_var_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_int.IH<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def inj_PairVal<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-measurable_eval_cexpr"><span class="command">lemma</span></span> measurable_eval_cexpr<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> shift_var_set <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="main">(</span>eval_cexpr <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> measurable_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_Add"><span class="command">lemma</span></span> cexpr_sem_Add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e1</span><span class="main">)</span> <span class="main">+</span> extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal2_def extract_real_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_Mult"><span class="command">lemma</span></span> cexpr_sem_Mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e1</span><span class="main">)</span> <span class="main">*</span> extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_RealIntVal2_def extract_real_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General functions on Expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Transform variable names in an expression.
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">map_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vname <span class="main">⇒</span> vname<span class="main">)</span> <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>CVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> CVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">map_vars</span> <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_map_vars"><span class="command">lemma</span></span> free_vars_map_vars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>map_vars <span class="free">f</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> free_vars <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> CIntegral <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_map_vars"><span class="command">lemma</span></span> cexpr_typing_map_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">∘</span> <span class="free">f</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> map_vars <span class="free">f</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">∘</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cexpr_typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cet_int <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="main">∘</span> <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cet_int<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_map_vars"><span class="command">lemma</span></span> cexpr_sem_map_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span>map_vars <span class="free">f</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> cexpr_sem <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">σ</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span>
                 cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">σ</span> <span class="main">∘</span> case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CIntegral.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">x</span> <span class="skolem">σ</span> <span class="main">∘</span> case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span>
                      cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> <span class="main">(</span>vname <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> vname <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_var</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-insert_var_0"><span class="command">lemma</span></span> insert_var_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert_var <span class="main">0</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> case_nat <span class="free">x</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_var_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Substitutes expression e for variable x in e'.
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cexpr_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>CVar <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> insert_var <span class="free"><span class="bound"><span class="entity">x</span></span></span> CVar <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">cexpr_subst</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_cexpr_subst_aux"><span class="command">lemma</span></span> cexpr_sem_cexpr_subst_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span>cexpr_subst <span class="free">x</span> <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> cexpr_sem <span class="main">(</span>insert_var <span class="free">x</span> <span class="free">σ</span> <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="free">e'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e'</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> insert_var <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span>
                    case_nat <span class="bound">y</span> <span class="main">(</span>insert_var <span class="skolem">x</span> <span class="skolem">σ</span> <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_var_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def A cexpr_sem_map_vars CIntegral.IH<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_var_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   This corresponds to a Let-binding; the variable with index 0 is substituted
   with the given expression.
›</span></span>
<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_cexpr_subst"><span class="command">lemma</span></span> cexpr_sem_cexpr_subst<span class="main">:</span>
    <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span>cexpr_subst <span class="main">0</span> <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cexpr_sem_cexpr_subst_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_subst_aux"><span class="command">lemma</span></span> cexpr_typing_subst_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_var <span class="free">x</span> <span class="free">Γ</span> <span class="free">t</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst <span class="free">x</span> <span class="free">e</span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> CVar
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_var_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> COperator
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e'</span> <span class="skolem">t''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> CIntegral.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t''</span> <span class="main">(</span>insert_var <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> CIntegral.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t''</span> <span class="main">(</span>insert_var <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> insert_var <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t''</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_var_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_var <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t''</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="free">t</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CIntegral.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t''</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> map_vars Suc <span class="skolem">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_map_vars<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t''</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="skolem">e</span><span class="main">)</span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CIntegral.IH<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cet_int <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_subst"><span class="command">lemma</span></span> cexpr_typing_subst<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst <span class="main">0</span> <span class="free">e</span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cexpr_typing_subst_aux assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="PDF_Target_Semantics-free_vars_cexpr_subst_aux"><span class="command">lemma</span></span> free_vars_cexpr_subst_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_subst <span class="free">x</span> <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">≥</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> free_vars <span class="free">e'</span> <span class="main">∪</span> free_vars <span class="free">e</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">_</span> <span class="main">⊆</span> <span class="var">?f</span> <span class="free">x</span> <span class="main">-`</span> <span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CVar <span class="skolem">y</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_var_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CPair <span class="skolem">e'1</span> <span class="skolem">e'2</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> CPair.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">e</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>COperator _ _ <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> COperator.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIf <span class="skolem">b</span> <span class="skolem">e'1</span> <span class="skolem">e'2</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> CIf.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">e</span></span></span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e'</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_subst <span class="skolem">x</span> <span class="skolem">e</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
          Suc <span class="main">-`</span> <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="main">-`</span> free_vars <span class="skolem">e'</span><span class="main">)</span> <span class="main">∪</span>
          Suc <span class="main">-`</span> <span class="main">(</span>free_vars <span class="main">(</span>map_vars Suc <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cexpr_subst.simps free_vars_cexpr.simps
                   vimage_mono CIntegral.IH vimage_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> free_vars <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_vimage_image_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?f</span> <span class="skolem">x</span> <span class="main">-`</span> free_vars <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_cexpr_subst"><span class="command">lemma</span></span> free_vars_cexpr_subst<span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_subst <span class="main">0</span> <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> Suc <span class="main">-`</span> free_vars <span class="free">e'</span> <span class="main">∪</span> free_vars <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_subst_aux<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>



<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cexpr_comp_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_comp_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>CVar <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span> CVar <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_comp_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">cexpr_comp_aux</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_cexpr_comp_aux"><span class="command">lemma</span></span> cexpr_sem_cexpr_comp_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span>cexpr_comp_aux <span class="free">x</span> <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> cexpr_sem <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> cexpr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="free">e'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e'</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">(</span>Suc <span class="skolem">x</span> <span class="main">:=</span> cexpr_sem <span class="main">(</span>case_nat <span class="bound">y</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 case_nat <span class="bound">y</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> cexpr_sem <span class="skolem">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integral_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CIntegral.IH <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_var_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cexpr_comp</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_comp</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> cexpr_comp_aux <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_cexpr_comp_aux"><span class="command">lemma</span></span> cexpr_typing_cexpr_comp_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">t1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> cexpr_comp_aux <span class="free">x</span> <span class="free">e</span> <span class="free">e'</span> <span class="main">:</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> COperator
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> cexpr_typing_opE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> CPair
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> cexpr_typing_pairE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e'</span> <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> CIntegral.prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> CIntegral.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">t1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> cexpr_typing_intE<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">(</span>Suc <span class="skolem">x</span> <span class="main">:=</span> <span class="free">t1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> cexpr_comp_aux <span class="skolem">x</span> <span class="skolem">e</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros CIntegral.IH cexpr_typing_map_vars
             <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def CIntegral.prems<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_cexpr_comp"><span class="command">lemma</span></span> cexpr_typing_cexpr_comp<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t1</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">g</span> <span class="main">:</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t2</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> <span class="free">t3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t1</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">g</span> <span class="main">:</span> <span class="free">t3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> cexpr_comp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cexpr_typing_cexpr_comp_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat <span class="free">t1</span> <span class="free">Γ</span><span class="main">)</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="free">t2</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat <span class="free">t1</span> <span class="free">Γ</span><span class="main">)</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="free">t2</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> <span class="free">t3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>


<span class="keyword1" id="PDF_Target_Semantics-free_vars_cexpr_comp_aux"><span class="command">lemma</span></span> free_vars_cexpr_comp_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_comp_aux <span class="free">x</span> <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>free_vars <span class="free">e'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> free_vars <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIntegral <span class="skolem">e'</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> CIntegral.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"map_vars Suc <span class="skolem">e</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_comp_aux <span class="skolem">x</span> <span class="skolem">e</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           Suc <span class="main">-`</span> free_vars <span class="main">(</span>cexpr_comp_aux <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="skolem">e</span><span class="main">)</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> Suc <span class="main">-`</span> <span class="main">(</span>free_vars <span class="skolem">e'</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> free_vars <span class="main">(</span>map_vars Suc <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vimage_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> CIntegral.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> free_vars <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">e'</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> free_vars <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_Diff vimage_image_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_cexpr_comp"><span class="command">lemma</span></span> free_vars_cexpr_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_comp <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>free_vars <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> free_vars <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_vars_cexpr_comp_aux cexpr_comp_def<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_cexpr_comp'"><span class="command">lemma</span></span> free_vars_cexpr_comp'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_comp <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> free_vars <span class="free">e</span> <span class="main">∪</span> free_vars <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> free_vars_cexpr_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_cexpr_comp"><span class="command">lemma</span></span> cexpr_sem_cexpr_comp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> cexpr_sem <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> cexpr_sem <span class="free">σ</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cexpr_comp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_sem_cexpr_comp_aux<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-eval_cexpr_comp"><span class="command">lemma</span></span> eval_cexpr_comp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval_cexpr <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">g</span><span class="main">)</span> <span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> eval_cexpr <span class="free">f</span> <span class="free">σ</span> <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="free">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat <span class="free">x</span> <span class="free">σ</span><span class="main">)</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> cexpr_sem <span class="main">(</span>case_nat <span class="free">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="free">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_cexpr_def cexpr_sem_cexpr_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cexpr_subst_val_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> cexpr <span class="main">⇒</span> val <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst_val_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>CVar <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> insert_var <span class="free"><span class="bound"><span class="entity">x</span></span></span> CVar <span class="main">(</span>CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">THEN</span> <span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">ELSE</span> <span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst_val_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">cexpr_subst_val_aux</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_subst_val_aux_eq_cexpr_subst"><span class="command">lemma</span></span> cexpr_subst_val_aux_eq_cexpr_subst<span class="main">:</span>
    <span class="quoted"><span class="quoted">"cexpr_subst_val_aux <span class="free">x</span> <span class="free">e</span> <span class="free">v</span> <span class="main">=</span> cexpr_subst <span class="free">x</span> <span class="main">(</span>CVal <span class="free">v</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cexpr_subst_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cexpr <span class="main">⇒</span> val <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cexpr_subst_val</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> cexpr_subst_val_aux <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_cexpr_subst_val"><span class="command">lemma</span></span> cexpr_sem_cexpr_subst_val<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span>cexpr_subst_val <span class="free">e</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> cexpr_sem <span class="main">(</span>case_nat <span class="free">v</span> <span class="free">σ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_subst_val_def cexpr_subst_val_aux_eq_cexpr_subst cexpr_sem_cexpr_subst<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_subst_val"><span class="command">lemma</span></span> cexpr_typing_subst_val<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t'</span> <span class="main">⟹</span> val_type <span class="free">v</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">e</span> <span class="free">v</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_subst_val_def cexpr_subst_val_aux_eq_cexpr_subst <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_val'<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_cexpr_subst_val_aux"><span class="command">lemma</span></span> free_vars_cexpr_subst_val_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_subst_val_aux <span class="free">x</span> <span class="free">e</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">≥</span> <span class="free">x</span> <span class="keyword1">then</span> Suc <span class="bound">y</span> <span class="keyword1">else</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-`</span> free_vars <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_var_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_cexpr_subst_val"><span class="command">lemma</span></span> free_vars_cexpr_subst_val<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>cexpr_subst_val <span class="free">e</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">-`</span> free_vars <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_subst_val_def free_vars_cexpr_subst_val_aux<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nonnegative expressions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nonneg_cexpr</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexprI"><span class="command">lemma</span></span> nonneg_cexprI<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nonneg_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexprD"><span class="command">lemma</span></span> nonneg_cexprD<span class="main">:</span>
    <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span> extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nonneg_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_map_vars"><span class="command">lemma</span></span> nonneg_cexpr_map_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span>map_vars <span class="free">f</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> cexpr_sem_map_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_subset"><span class="command">lemma</span></span> nonneg_cexpr_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">V'</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V'</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">σ</span> <span class="free">V</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM restrict_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nonneg_cexprD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>restrict <span class="skolem">σ</span> <span class="free">V</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="main">(</span>restrict <span class="skolem">σ</span> <span class="free">V</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> cexpr_sem <span class="skolem">σ</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_sem_eq_on_vars<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_Mult"><span class="command">lemma</span></span> nonneg_cexpr_Mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N2<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="free">e1</span><span class="main">)</span> <span class="main">*</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ N1 N2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_nonneg_nonneg nonneg_cexprD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_indicator"><span class="command">lemma</span></span> nonneg_indicator<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> BOOL"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">⟨</span><span class="free">e</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>cexpr_sem <span class="skolem">ρ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> BOOL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_type_cexpr_sem<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">ρ</span> <span class="main">(</span><span class="main">⟨</span><span class="free">e</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extract_real_def bool_to_real_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_comp_aux"><span class="command">lemma</span></span> nonneg_cexpr_comp_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">t1</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">t1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> <span class="free">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">f</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span>cexpr_comp_aux <span class="free">x</span> <span class="free">f</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span>cexpr_comp_aux <span class="free">x</span> <span class="free">f</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> cexpr_sem <span class="skolem">σ</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_sem_cexpr_comp_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> t1 vars σ<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="skolem">σ</span> <span class="free">f</span> <span class="main">∈</span> type_universe <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> σ x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> cexpr_sem <span class="skolem">σ</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">t1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> cexpr_sem <span class="skolem">σ</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span>cexpr_comp_aux <span class="free">x</span> <span class="free">f</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_comp"><span class="command">lemma</span></span> nonneg_cexpr_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t2</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t1</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">f</span> <span class="main">⊆</span> shift_var_set <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t1</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">e</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t1</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="free">e</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> cexpr_sem <span class="skolem">σ</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_sem_cexpr_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> σ<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="skolem">σ</span> <span class="free">f</span> <span class="main">∈</span> type_universe <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> σ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> cexpr_sem <span class="skolem">σ</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t2</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> cexpr_sem <span class="skolem">σ</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="free">e</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_subst_val"><span class="command">lemma</span></span> nonneg_cexpr_subst_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"val_type <span class="free">v</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span>cexpr_subst_val <span class="free">e</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span>cexpr_subst_val <span class="free">e</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_int"><span class="command">lemma</span></span> nonneg_cexpr_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">∂</span><span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">∂</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="skolem">σ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> σ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_nonneg_AE AE_I2 nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">∂</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Subprobability density expressions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subprob_cexpr</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">V'</span></span></span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-subprob_cexprI"><span class="command">lemma</span></span> subprob_cexprI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
                 <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> subprob_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Semantics-subprob_cexprD"><span class="command">lemma</span></span> subprob_cexprD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span><span class="main">.</span> <span class="bound">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
               <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> subprob_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Semantics-subprob_indicator"><span class="command">lemma</span></span> subprob_indicator<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subprob<span class="main">:</span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">e1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> BOOL"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vars1<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vars2<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> t2 <span class="keyword1"><span class="command">have</span></span> t2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cet_op<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> vars2 <span class="keyword1"><span class="command">have</span></span> vars2'<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eval</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">e</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="bound">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="bound">σ</span> <span class="free">e1</span> <span class="main">*</span> <span class="var">?eval</span> <span class="bound">σ</span> <span class="main">(</span><span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1 t2' merge_in_state_measure<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ ρ<span class="main"><span class="main"><span class="main">]</span></span></span> vars1 vars2'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> BOOL"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_cexpr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t2 vars2<span class="main"><span class="main">]</span></span> merge_in_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eval</span> <span class="skolem">σ</span> <span class="main">(</span><span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extract_real_def bool_to_real_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eval</span> <span class="skolem">σ</span> <span class="free">e1</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonneg ρ σ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprD merge_in_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eval</span> <span class="skolem">σ</span> <span class="free">e1</span> <span class="main">*</span> <span class="var">?eval</span> <span class="skolem">σ</span> <span class="main">(</span><span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="var">?eval</span> <span class="skolem">σ</span> <span class="free">e1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_le_one_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="bound">σ</span> <span class="free">e1</span> <span class="main">*</span> <span class="var">?eval</span> <span class="bound">σ</span> <span class="main">(</span><span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≤</span>
             <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="bound">σ</span> <span class="free">e1</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_mono<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> subprob <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_cexprD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="bound">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="free">e2</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>  <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-measurable_cexpr_sem'"><span class="command">lemma</span></span> measurable_cexpr_sem'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_extract_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_cexpr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> e<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ρ<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_merge<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Target_Semantics-measurable_fun_upd_state_measure"><span class="command">lemma</span></span> measurable_fun_upd_state_measure<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>
                                          <span class="main">(</span>state_measure <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="PDF_Target_Semantics-integrable_cexpr_projection"><span class="command">lemma</span></span> integrable_cexpr_projection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∩</span> <span class="free">V'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> insert <span class="free">v</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>state_measure <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">_</span> <span class="var">?f'</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">v</span><span class="main">)</span><span class="main">.</span>
           integrable <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="main">(</span>insert <span class="free">v</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> integrable <span class="var">?M</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> real_integrable_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> AE_conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">∈</span> borel_measurable <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ e disjoint
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> AE_I2 measurable_cexpr_sem'<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PiE_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="var">?N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"merge <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> merge <span class="free">V</span> <span class="main">(</span>insert <span class="free">v</span> <span class="free">V'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> disjoint <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f''</span> <span class="skolem">x</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">x</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> f''_eq_f <span class="main">=</span> this

  <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> product_sigma_finite_def<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"state_measure <span class="free">V</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sigma_finite_state_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> int <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f'</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_integrable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f'</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f''</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span> <span class="main">∂</span><span class="var">?N</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fin disjoint e ρ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> product_nn_integral_insert_rev<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span> measurable_cexpr_sem'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> state_measure_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f''</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> e disjoint
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_PInf_AE<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_split_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> borel_measurable_nn_integral measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span>
                   measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_cexpr_sem'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ρ<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="var">?N</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f''</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f''_eq_f<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> AE_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> int <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f'</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_integrable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f'</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>insert <span class="free">v</span> <span class="free">V</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f''</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span> <span class="main">∂</span><span class="var">?N</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fin disjoint e ρ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> product_nn_integral_insert_rev<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span> borel_measurable_uminus
                     measurable_cexpr_sem'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> state_measure_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f''</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> e disjoint
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_PInf_AE<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_split_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> borel_measurable_nn_integral measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span>
                   measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_cexpr_sem'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ρ<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> borel_measurable_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="var">?N</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f''</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f''_eq_f<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> AE_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?N</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="main">-</span><span class="var">?f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cdens_ctxt_invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname list <span class="main">⇒</span> vname list <span class="main">⇒</span> tyenv <span class="main">⇒</span> cexpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cdens_ctxt_invar</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≡</span>
       distinct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">)</span> <span class="main">∧</span>
       free_vars <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">⊆</span> set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">)</span> <span class="main">∧</span>
       <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">:</span> REAL <span class="main">∧</span>
       nonneg_cexpr <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">∪</span> set <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">∧</span>
       subprob_cexpr <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cdens_ctxt_invarI"><span class="command">lemma</span></span> cdens_ctxt_invarI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>distinct <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span><span class="main">;</span> free_vars <span class="free">δ</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span><span class="main">;</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">δ</span> <span class="main">:</span> REAL<span class="main">;</span>
    nonneg_cexpr <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span><span class="main">;</span>
    subprob_cexpr <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span> <span class="main">⟧</span> <span class="main">⟹</span>
      cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cdens_ctxt_invar_def<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cdens_ctxt_invarD"><span class="command">lemma</span></span> cdens_ctxt_invarD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">δ</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">δ</span> <span class="main">:</span> REAL"</span></span>
        <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cdens_ctxt_invar_def<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cdens_ctxt_invar_empty"><span class="command">lemma</span></span> cdens_ctxt_invar_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="main">[]</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">(</span>CReal <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cdens_ctxt_invarI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> extract_real_def state_measure_def PiM_empty
           <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprI subprob_cexprI<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cdens_ctxt_invar_imp_integrable"><span class="command">lemma</span></span> cdens_ctxt_invar_imp_integrable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"integrable <span class="var">?M</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> integrable_iff_bounded
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_extract_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_cexpr_sem<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> invar<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> state_measure_def set_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_merge<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_Pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_measure_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="var">?M</span> <span class="main">⟹</span> <span class="var">?f</span> <span class="bound">σ</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹nonneg_cexpr <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexprD<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> merge_in_state_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹subprob_cexpr <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ρ
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>norm <span class="main">(</span><span class="var">?f</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subprob_cexpr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_top<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> top_unique <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Randomfree expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Translates an expression with no occurrences of Random or Fail into an
  equivalent target language expression.
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">expr_rf_to_cexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> CVar <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">&gt;</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
      cexpr_subst <span class="main">0</span> <span class="main">(</span><span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">expr_rf_to_cexpr</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">(</span>Random <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">expr_rf_to_cexpr</span> <span class="main">(</span>Fail <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_expr_rf_to_cexpr"><span class="command">lemma</span></span> cexpr_sem_expr_rf_to_cexpr<span class="main">:</span>
     <span class="quoted"><span class="quoted">"randomfree <span class="free">e</span> <span class="main">⟹</span> cexpr_sem <span class="free">σ</span> <span class="main">(</span>expr_rf_to_cexpr <span class="free">e</span><span class="main">)</span> <span class="main">=</span> expr_sem_rf <span class="free">σ</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_cexpr_subst<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_expr_rf_to_cexpr"><span class="command">lemma</span></span> cexpr_typing_expr_rf_to_cexpr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"randomfree <span class="free">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> expr_rf_to_cexpr <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_typing.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_expr_rf_to_cexpr"><span class="command">lemma</span></span> free_vars_expr_rf_to_cexpr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"randomfree <span class="free">e</span> <span class="main">⟹</span> free_vars <span class="main">(</span>expr_rf_to_cexpr <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> free_vars <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LetVar <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> free_vars_cexpr.simps expr_rf_to_cexpr.simps<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_subst<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Builtin density expressions›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">dist_dens_cexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pdf_dist <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_dens_cexpr</span> Bernoulli <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">0</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">1</span> <span class="keyword1">THEN</span>
                                       <span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">ELSE</span> CReal <span class="main">1</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
                                    <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens_cexpr</span> UniformInt <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">THEN</span>
                                         inverse<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span><span class="main">⟨</span>snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> CInt <span class="main">1</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens_cexpr</span> UniformReal <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">THEN</span>
                                         inverse<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens_cexpr</span> Gaussian <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">0</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">THEN</span>
                                     exp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span><span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> fst<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span>CInt <span class="numeral">2</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>CReal <span class="numeral">2</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span>CInt <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>c</sub></span>
                                         sqrt<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>CReal <span class="numeral">2</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> π<span class="hidden">⇩</span><sub>c</sub> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> snd<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span> CInt <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dist_dens_cexpr</span> Poisson <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">0</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>c</sub></span> CInt <span class="main">0</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">THEN</span>
                                    <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">/<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span>fact<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> exp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span><span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_dist_dens_cexpr"><span class="command">lemma</span></span> free_vars_dist_dens_cexpr<span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>dist_dens_cexpr <span class="free">dst</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">⊆</span> free_vars <span class="free">e1</span> <span class="main">∪</span> free_vars <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dist_dens_cexpr_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">dst</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_dist_dens_cexpr"><span class="command">lemma</span></span> cexpr_typing_dist_dens_cexpr<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> dist_param_type <span class="free">dst</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> dist_result_type <span class="free">dst</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> dist_dens_cexpr <span class="free">dst</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dist_dens_cexpr_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">dst</span></span><span class="main">)</span>
  <span class="comment1">(* Bernoulli *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cet_op_intros cet_if cet_val' cet_var' cet_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="comment1">(* Uniform int *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cet_if cet_and cet_or cet_less_int cet_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> cet_fst cet_snd <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cet_inverse<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">INTEG</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cet_add_int cet_minus_int<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_val' cet_fst cet_snd<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>5<span class="main"><span class="keyword3">]</span></span>
  <span class="comment1">(* Uniform real *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cet_if cet_op_intros cet_eq cet_fst cet_snd<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_val'<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="comment1">(* Poisson *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cet_if cet_and<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_less_real<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_val'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cet_less_eq_int<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_val'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cet_mult_real cet_pow_real cet_inverse cet_cast_real_int cet_exp cet_minus_real
               cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> oper <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">Fact</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">INTEG</span></span><span class="main"><span class="main">]</span></span> cet_var'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_val'<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="comment1">(* Gaussian *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cet_if cet_op_intros cet_val'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_fst cet_snd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="PDF_Target_Semantics-val_type_eq_BOOL"><span class="command">lemma</span></span> val_type_eq_BOOL<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> BOOL <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> BoolVal<span class="main">`</span>UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Target_Semantics-val_type_eq_INTEG"><span class="command">lemma</span></span> val_type_eq_INTEG<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> INTEG <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> IntVal<span class="main">`</span>UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Target_Semantics-val_type_eq_PRODUCT"><span class="command">lemma</span></span> val_type_eq_PRODUCT<span class="main">:</span> <span class="quoted"><span class="quoted">"val_type <span class="free">x</span> <span class="main">=</span> PRODUCT <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> val_type <span class="bound">a</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">∧</span> val_type <span class="bound">b</span> <span class="main">=</span> <span class="free">t2</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="main">&lt;|</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span> <span class="main">|&gt;</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_dist_dens_cexpr_nonneg"><span class="command">lemma</span></span> cexpr_sem_dist_dens_cexpr_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> dist_param_type <span class="free">dst</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> dist_result_type <span class="free">dst</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span>dist_dens_cexpr <span class="free">dst</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           dist_dens <span class="free">dst</span> <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span>dist_dens_cexpr <span class="free">dst</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> val_type_cexpr_sem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="free">e1</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span>dist_param_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="free">e2</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span>dist_result_type <span class="free">dst</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_universe_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dist_dens_cexpr_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">dst</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
            lift_Comp_def lift_RealVal_def lift_RealIntVal_def lift_RealIntVal2_def
            bernoulli_density_def val_type_eq_REAL val_type_eq_BOOL val_type_eq_PRODUCT val_type_eq_INTEG
            uniform_int_density_def uniform_real_density_def
            lift_IntVal_def poisson_density'_def one_ennreal_def
            <span class="dynamic"><span class="dynamic">field_simps</span></span> gaussian_density_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_dist_dens_cexpr"><span class="command">lemma</span></span> cexpr_sem_dist_dens_cexpr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> dist_param_type <span class="free">dst</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> dist_result_type <span class="free">dst</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span>dist_dens_cexpr <span class="free">dst</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           dist_dens <span class="free">dst</span> <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cexpr_sem_dist_dens_cexpr_nonneg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_dist_dens_cexpr"><span class="command">lemma</span></span> nonneg_dist_dens_cexpr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> dist_param_type <span class="free">dst</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> dist_result_type <span class="free">dst</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span>dist_dens_cexpr <span class="free">dst</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> cexpr_sem_dist_dens_cexpr_nonneg<span class="main">[</span><span class="operator">OF</span> assms this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span>dist_dens_cexpr <span class="free">dst</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Integral expressions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">integrate_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> vname <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">integrate_var</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="bound">w</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">w</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∂</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">integrate_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> vname list <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">integrate_vars</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> foldr <span class="main">(</span>integrate_var <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_integrate_var"><span class="command">lemma</span></span> cexpr_sem_integrate_var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span>integrate_var <span class="free">Γ</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>
    RealVal <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">w</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="free">σ</span> <span class="main">(</span>integrate_var <span class="free">Γ</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>
          RealVal <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span> <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def integrate_var_def cexpr_sem_map_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> case_nat <span class="bound">x</span> <span class="free">σ</span> <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_integrate_var'"><span class="command">lemma</span></span> cexpr_sem_integrate_var'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span>integrate_var <span class="free">Γ</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_integrate_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_integrate_var"><span class="command">lemma</span></span> cexpr_typing_integrate_var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> integrate_var <span class="free">Γ</span> <span class="free">v</span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> integrate_var_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_typing.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cexpr_typing_map_vars<span class="main">)</span>
     <span class="main">(</span><span class="operator">erule</span> cexpr_typing_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_typing_integrate_vars"><span class="command">lemma</span></span> cexpr_typing_integrate_vars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> integrate_vars <span class="free">Γ</span> <span class="free">vs</span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrate_vars_def<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_integrate_var"><span class="command">lemma</span></span> free_vars_integrate_var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>integrate_var <span class="free">Γ</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> free_vars <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> integrate_var_def<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Semantics-free_vars_integrate_vars"><span class="command">lemma</span></span> free_vars_integrate_vars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="free">vs</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> free_vars <span class="free">e</span> <span class="main">-</span> set <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> integrate_vars_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> product_sigma_finite<span class="main">)</span> product_integral_insert'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">LINT</span> <span class="bound">y</span><span class="main">|</span><span class="free">M</span> <span class="free">i</span><span class="main">.</span> <span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">I</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pair_sigma_finite <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">I</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sigma_finite assms pair_sigma_finite_def sigma_finite_measures<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> Mi<span class="main">:</span> sigma_finite_measure <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sigma_finite_measures<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span><span class="free">M</span> <span class="free">i</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">I</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">y</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_integrable_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> nn_integral_snd<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> product_nn_integral_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
           <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span> borel_measurable_uminus<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">I</span> <span class="free">M</span><span class="main">.</span> <span class="keyword1">LINT</span> <span class="bound">y</span><span class="main">|</span><span class="free">M</span> <span class="free">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> product_integral_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> int <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">LINT</span> <span class="bound">y</span><span class="main">|</span><span class="free">M</span> <span class="free">i</span><span class="main">.</span> <span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">I</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Fubini_integral<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_integrate_vars"><span class="command">lemma</span></span> cexpr_sem_integrate_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">vs</span> <span class="main">∩</span> <span class="free">V'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> set <span class="free">vs</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="free">ρ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="free">vs</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">∫</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">V'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">V'</span> <span class="keyword1">then</span> <span class="skolem">ρ</span> <span class="bound">v</span> <span class="keyword1">else</span> undefined<span class="main">)</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> integrate_vars_def state_measure_def merge_def PiM_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">ρ</span> <span class="skolem">V'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> product_sigma_finite_def<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"state_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sigma_finite_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ρ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>insert <span class="skolem">v</span> <span class="skolem">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">ρ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="skolem">vs</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrate_vars_def cexpr_sem_integrate_var extract_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>state_measure <span class="main">(</span>insert <span class="skolem">v</span> <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>insert <span class="skolem">v</span> <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">.</span>
                extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="skolem">vs</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  <span class="main">∫</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">v</span> <span class="skolem">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>
                      <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AE_I2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> integrable_cexpr_projection<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ _ _ int<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> Cons.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>7<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Cons.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ρ'<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Cons.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">∫</span><span class="bound">x</span><span class="main">.</span> <span class="main">∫</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">v</span> <span class="skolem">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>
                  <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong_AE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
                measurable_fun_upd_state_measure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V'</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_extract_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_cexpr_sem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> borel_measurable_lebesgue_integral<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_extract_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_cexpr_sem<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>  <span class="quoted"><span class="quoted"><span class="quoted">"set <span class="skolem"><span class="skolem">vs</span></span> <span class="main"><span class="main">∪</span></span> insert <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">V'</span></span>"</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> state_measure_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_merge<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">v</span> <span class="skolem">V'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>set <span class="main">(</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> <span class="main">∫</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="main">(</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>
                  <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">∫</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="main">(</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>
                  <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="main">(</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> product_integral_insert'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_integrate_vars'"><span class="command">lemma</span></span> cexpr_sem_integrate_vars'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">vs</span> <span class="main">∩</span> <span class="free">V'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> set <span class="free">vs</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="free">ρ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="free">vs</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="free">ρ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="free">vs</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">∫</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_sem_integrate_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">...</span> <span class="main">=</span>
      <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_eq_integral<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> AE_I2<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprD merge_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_sem_integrate_vars"><span class="command">lemma</span></span> nonneg_cexpr_sem_integrate_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">vs</span> <span class="main">∩</span> <span class="free">V'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> set <span class="free">vs</span> <span class="main">∪</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="free">ρ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="free">vs</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">V'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">V'</span> <span class="keyword1">then</span> <span class="skolem">ρ</span> <span class="bound">v</span> <span class="keyword1">else</span> undefined<span class="main">)</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> integrate_vars_def state_measure_def merge_def PiM_empty nonneg_cexprD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">ρ</span> <span class="skolem">V'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ρ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>insert <span class="skolem">v</span> <span class="skolem">V'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">ρ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="skolem">vs</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrate_vars_def cexpr_sem_integrate_var extract_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integral_nonneg_AE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AE_I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> Cons.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">ρ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-nonneg_cexpr_sem_integrate_vars'"><span class="command">lemma</span></span> nonneg_cexpr_sem_integrate_vars'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">vs</span> <span class="main">⟹</span> set <span class="free">vs</span> <span class="main">∩</span> <span class="free">V'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> nonneg_cexpr <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> <span class="free">V'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span>
    free_vars <span class="free">e</span> <span class="main">⊆</span> set <span class="free">vs</span> <span class="main">∪</span> <span class="free">V'</span> <span class="main">⟹</span> nonneg_cexpr <span class="free">V'</span> <span class="free">Γ</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="free">vs</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexpr_sem_integrate_vars<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> V'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">V'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Target_Semantics-cexpr_sem_integral_nonneg"><span class="command">lemma</span></span> cexpr_sem_integral_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> shift_var_set <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">∂</span><span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_extract_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_case_nat' measurable_cexpr_sem<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_ident_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_const<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t vars<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> finite <span class="keyword2"><span class="keyword">and</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrableI_nonneg nonneg_cexprD case_nat_in_state_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="free">σ</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">∂</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">∫</span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_eq_integral<span class="main"><span class="main">[</span></span><span class="operator">OF</span> int AE_I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonneg<span class="main"><span class="main">]</span></span> case_nat_in_state_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Semantics-has_parametrized_subprob_density_cexpr_sem_integral"><span class="command">lemma</span></span> has_parametrized_subprob_density_cexpr_sem_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>
                   <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="free">f</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="free">V'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t'</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tf<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t'</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> varsf<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">f</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>shift_var_set <span class="free">V'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="free">t</span><span class="main">.</span>
          <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="free">f</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">∂</span><span class="free">t'</span><span class="main">)</span> <span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AE_I2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> sigma_finite_measure <span class="quoted"><span class="quoted">"stock_measure <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="free">f</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> has_parametrized_subprob_density_integral<span class="main">[</span><span class="operator">OF</span> dens ρ<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def top_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="free">t</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ tf varsf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_PInf_AE<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonneg'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> stock_measure <span class="free">t'</span><span class="main">.</span> eval_cexpr <span class="free">f</span> <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="free">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def <span class="keyword1"><span class="command">using</span></span> ρ x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> AE_I2 nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonneg<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> case_nat_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="free">f</span> <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="free">ρ</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x ρ tf varsf finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrableI_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> top_unique less_top<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">x</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">∂</span><span class="free">t'</span><span class="main">)</span> <span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonneg'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def nn_integral_eq_integral eval_cexpr_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PDF_Target_Density_Contexts">
<div class="head">
<h1>Theory PDF_Target_Density_Contexts</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Target_Density_Contexts.thy
  Authors: Manuel Eberl

  Concrete density contexts and operations on them as expressions in the
  target language
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete Density Contexts›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Target_Density_Contexts
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PDF_Density_Contexts.html">PDF_Density_Contexts</a> <a href="PDF_Target_Semantics.html">PDF_Target_Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> cdens_ctxt <span class="main">=</span> <span class="quoted"><span class="quoted">"vname list <span class="main">×</span> vname list <span class="main">×</span> tyenv <span class="main">×</span> cexpr"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dens_ctxt_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdens_ctxt <span class="main">⇒</span> dens_ctxt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dens_ctxt_α</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">vs</span><span class="main">,</span><span class="bound">vs'</span><span class="main">,</span><span class="bound">Γ</span><span class="main">,</span><span class="bound">δ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>set <span class="bound">vs</span><span class="main">,</span> set <span class="bound">vs'</span><span class="main">,</span> <span class="bound">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="bound">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shift_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift_vars</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">#</span> map Suc <span class="free"><span class="bound"><span class="entity">vs</span></span></span>"</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-set_shift_vars"><span class="command">lemma</span></span> set_shift_vars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>shift_vars <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> shift_var_set <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> shift_vars_def shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_density_expr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdens_ctxt <span class="main">⇒</span> pdf_type <span class="main">⇒</span> cexpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_density_expr</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">vs</span><span class="main">,</span><span class="bound">vs'</span><span class="main">,</span><span class="bound">Γ</span><span class="main">,</span><span class="bound">δ</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span>
    case_nat <span class="bound">t</span> <span class="bound">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">e</span> <span class="main">:</span> REAL <span class="main">∧</span>
    free_vars <span class="bound">e</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="bound">vs'</span><span class="main">)</span> <span class="main">∧</span>
    nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="bound">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="bound">t</span> <span class="bound">Γ</span><span class="main">)</span> <span class="bound">e</span>"</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-is_density_exprI"><span class="command">lemma</span></span> is_density_exprI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL <span class="main">⟹</span>
    free_vars <span class="free">e</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">⟹</span>
    nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span> <span class="main">⟹</span>
    is_density_expr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span> <span class="free">t</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_density_expr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Density_Contexts-is_density_exprD"><span class="command">lemma</span></span> is_density_exprD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span> <span class="free">t</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> is_density_exprD_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_density_expr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>


<span class="keyword1" id="PDF_Target_Density_Contexts-density_context_α"><span class="command">lemma</span></span> density_context_α<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_context <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> density_context_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI ballI conjI impI subprob_spaceI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_extract_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> cdens_ctxt_invarD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">,</span> set <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">∈</span> measurable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>
                <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_measure_def state_measure'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_density nn_integral_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subprob_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cdens_ctxt_invarD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonneg_cexpr_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expressions for density context operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">marg_dens_cexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> vname list <span class="main">⇒</span> vname <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">marg_dens_cexpr</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
      map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>integrate_vars <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-free_vars_marg_dens_cexpr"><span class="command">lemma</span></span> free_vars_marg_dens_cexpr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>marg_dens_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>marg_dens_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>free_vars <span class="free">δ</span> <span class="main">-</span> set <span class="free">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> marg_dens_cexpr_def shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-cexpr_typing_marg_dens_cexpr"><span class="command">lemma</span></span> cexpr_typing_marg_dens_cexpr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">δ</span> <span class="main">:</span> REAL <span class="main">⟹</span> case_nat <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> marg_dens_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">δ</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> marg_dens_cexpr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_typing_map_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cexpr_typing_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> cexpr_typing_integrate_vars<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Density_Contexts-cexpr_sem_marg_dens"><span class="command">lemma</span></span> cexpr_sem_marg_dens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">v</span> <span class="keyword1">in</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">.</span>
           ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">v</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>marg_dens_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               marg_dens <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">ρ</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> cdens_ctxt_invar_imp_integrable<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ρ<span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> insert_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> set <span class="free">vs</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">≠</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> set <span class="free">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> integrable<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">v</span> <span class="keyword1">in</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">.</span>
          integrable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar x ρ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_cexpr_projection<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> integrable<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AE_I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> integrable<span class="main">:</span>
      <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword2"><span class="keyword">and</span></span> ρ <span class="keyword1"><span class="command">have</span></span> ρ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="main">(</span>case_nat <span class="skolem">v</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>marg_dens_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span>
            cexpr_sem <span class="main">(</span>case_nat <span class="skolem">v</span> <span class="free">ρ</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="free">vs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">]</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> marg_dens_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> free_vars <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="free">vs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">]</span> <span class="free">δ</span><span class="main">)</span>
                  <span class="main">⟹</span> <span class="main">(</span>case_nat <span class="skolem">v</span> <span class="free">ρ</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> cexpr_sem <span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="free">vs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">]</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_sem_eq_on_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> set <span class="free">vs</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">≠</span> <span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="free">vs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">]</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span>
                     <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ' invar integrable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_integrate_vars'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?vs</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span>
                     <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
                 marg_dens <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">ρ</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> marg_dens_def dens_ctxt_α_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">v</span> <span class="main">|</span> Suc <span class="bound">a</span> <span class="main">⇒</span> <span class="free">ρ</span> <span class="bound">a</span><span class="main">)</span>
                                               <span class="main">(</span>marg_dens_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                    marg_dens <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">ρ</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-nonneg_cexpr_sem_marg_dens"><span class="command">lemma</span></span> nonneg_cexpr_sem_marg_dens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="free">v</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>marg_dens_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="free">v</span> <span class="free">ρ</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">y</span><span class="main">)</span>
                        <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def space_PiM o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> set <span class="free">vs</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">≠</span> <span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms invar <span class="keyword1"><span class="command">unfolding</span></span> marg_dens_cexpr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_map_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> nonneg_cexpr_sem_integrate_vars<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">#</span></span></span><span class="free"><span class="free"><span class="free">vs'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">marg_dens2_cexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> vname list <span class="main">⇒</span> vname <span class="main">⇒</span> vname <span class="main">⇒</span> cexpr <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">marg_dens2_cexpr</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
     <span class="main">(</span>cexpr_comp_aux <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>fst<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>cexpr_comp_aux <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>snd<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>map_vars Suc <span class="main">(</span>integrate_vars <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="PDF_Target_Density_Contexts-free_vars_marg_dens2_cexpr"><span class="command">lemma</span></span> free_vars_marg_dens2_cexpr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⊆</span>
            shift_var_set <span class="main">(</span>free_vars <span class="free">δ</span> <span class="main">-</span> set <span class="free">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> marg_dens2_cexpr_def <span class="keyword1"><span class="command">using</span></span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp_aux<span class="main"><span class="main">]</span></span> Un_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Diff_subset_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp_aux<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-cexpr_typing_marg_dens2_cexpr"><span class="command">lemma</span></span> cexpr_typing_marg_dens2_cexpr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">δ</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span> <span class="main">:</span> REAL"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">:=</span> <span class="free">Γ</span> <span class="free">x</span><span class="main">,</span> Suc <span class="free">y</span> <span class="main">:=</span> <span class="free">Γ</span> <span class="free">y</span><span class="main">)</span> <span class="main">∘</span> Suc <span class="main">=</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> marg_dens2_cexpr_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_typing_cexpr_comp_aux<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="free"><span class="free">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_typing_cexpr_comp_aux<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_typing_map_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cexpr_typing_integrate_vars<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cet_op<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_op<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-cexpr_sem_marg_dens2"><span class="command">lemma</span></span> cexpr_sem_marg_dens2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">z</span> <span class="keyword1">in</span> stock_measure <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
           ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">z</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               marg_dens2 <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="bound">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> product_sigma_finite <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> product_sigma_finite_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">interpret</span></span> sf_PiM<span class="main">:</span> sigma_finite_measure <span class="quoted"><span class="quoted">"PiM <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sigma_finite<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms invar
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cexpr_sem'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> x y <span class="keyword1"><span class="command">have</span></span> insert_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x y <span class="keyword1"><span class="command">have</span></span> insert_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">y</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> meas_upd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">σ</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
      measurable <span class="main">(</span>PiM <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>PiM <span class="main">(</span>insert <span class="free">y</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> measurable_add_dim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_eq'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> meas_upd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="main">(</span>fst <span class="bound">xa</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="main">(</span>fst <span class="bound">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">∈</span> measurable <span class="main">(</span><span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span>
                           Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> insert_eq'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_add_dim<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> x y <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">vs</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="var">?vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ'</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span>merge <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">σ</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>state_measure <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> meas insert_eq <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> product_nn_integral_fold<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span> <span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span>merge <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">σ</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span>
                       merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">σ'</span> <span class="free">x</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="bound">σ'</span> <span class="free">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ'</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">σ'</span> <span class="free">x</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="bound">σ'</span> <span class="free">y</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span>state_measure <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">z</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="bound">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="bound">z</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">∂</span><span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> meas_upd2 ρ invar <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> product_nn_integral_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">intro</span> sf_PiM.borel_measurable_nn_integral<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_split_conv state_measure_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span>
            measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_cexpr_sem'<span class="main"><span class="main">]</span></span> measurable_Pair <span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cdens_ctxt_invar_imp_integrable<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ρ<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> real_integrable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">z</span> <span class="keyword1">in</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">.</span>
           <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="bound">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="bound">z</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">z</span> <span class="keyword1">in</span> <span class="main">_</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> meas_upd2 ρ invar <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_PInf_AE sf_PiM.borel_measurable_nn_integral<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_cexpr_sem'<span class="main"><span class="main">]</span></span>
             measurable_Pair <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_split_conv state_measure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">z</span> <span class="keyword1">in</span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">.</span>
          ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>case_prod PairVal <span class="bound">z</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               marg_dens2 <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="main">(</span>case_prod PairVal <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AE_I2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span>
                 merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x y
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?g</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> ρ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z ρ <span class="keyword1"><span class="command">unfolding</span></span> state_measure_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM space_pair_measure <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="var">?M</span> <span class="var">?g</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> integrableI_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AE_I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">∈</span> borel_measurable <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invar ρ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cexpr_sem'<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span><span class="var">?g</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> top_unique less_top<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> x y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?vs</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="skolem">σ</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> merge_in_state_measure<span class="main">[</span><span class="operator">OF</span> σ ρ'<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invar<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> x y <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="var">?vs</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="main">[</span><span class="bound">z</span><span class="main">←</span><span class="free">vs</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">y</span><span class="main">]</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> B<span class="main">)</span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>case_prod PairVal <span class="skolem">z</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="main">(</span>case_nat <span class="main">&lt;|</span>fst <span class="skolem">z</span><span class="main">,</span> snd <span class="skolem">z</span><span class="main">|&gt;</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> Suc <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span> <span class="main">∘</span> Suc<span class="main">)</span>
                               <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="var">?vs</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> marg_dens2_cexpr_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_sem_cexpr_comp_aux cexpr_sem_map_vars <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>case_nat <span class="main">&lt;|</span>fst <span class="skolem">z</span><span class="main">,</span> snd <span class="skolem">z</span><span class="main">|&gt;</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> Suc <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> Suc <span class="main">=</span>
                   <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ρ1</span> <span class="main">=</span> <span class="var">?ρ2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>integrate_vars <span class="free">Γ</span> <span class="main">[</span><span class="bound">z</span><span class="main">←</span><span class="free">vs</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">y</span><span class="main">]</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">xa</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> invar assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_sem_integrate_vars'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ρ' _ _ nonneg integrable<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?vs</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">xa</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="var">?vs</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="skolem">z</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="var">?M</span><span class="main">)</span> <span class="main">=</span>
                 marg_dens2 <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="main">(</span>case_prod PairVal <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> marg_dens2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>case_prod PairVal <span class="skolem">z</span><span class="main">)</span> <span class="free">ρ</span><span class="main">)</span>
                                            <span class="main">(</span>marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                      marg_dens2 <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="free">ρ</span> <span class="main">(</span>case_prod PairVal <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> stock_measure.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> AE_embed_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_PairVal<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-nonneg_cexpr_sem_marg_dens2"><span class="command">lemma</span></span> nonneg_cexpr_sem_marg_dens2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> type_universe <span class="main">(</span>PRODUCT <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="free">v</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>marg_dens2_cexpr <span class="free">Γ</span> <span class="free">vs</span> <span class="free">x</span> <span class="free">y</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> v <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">&lt;|</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">|&gt;</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> type_universe <span class="main">(</span><span class="free">Γ</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> val_type_eq_PRODUCT<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>case_nat <span class="free">v</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">:=</span> fst <span class="main">(</span>extract_pair <span class="free">v</span><span class="main">)</span><span class="main">,</span> Suc <span class="free">y</span> <span class="main">:=</span> snd <span class="main">(</span>extract_pair <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> Suc <span class="main">=</span>
               <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="main">(</span>extract_pair <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="main">(</span>extract_pair <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fst <span class="main">(</span>extract_pair <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> snd <span class="main">(</span>extract_pair <span class="free">v</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x y v' ρ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_state_measure <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?vs</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">vs'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> invar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="var">?vs</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">vs'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms invar<span class="main">(</span>1-3<span class="main">)</span> A <span class="keyword1"><span class="command">unfolding</span></span> marg_dens2_cexpr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_cexpr_comp_aux cexpr_sem_map_vars <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_sem_integrate_vars<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">branch_prob_cexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdens_ctxt <span class="main">⇒</span> cexpr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">branch_prob_cexpr</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">vs</span><span class="main">,</span> <span class="bound">vs'</span><span class="main">,</span> <span class="bound">Γ</span><span class="main">,</span> <span class="bound">δ</span><span class="main">)</span><span class="main">.</span> integrate_vars <span class="bound">Γ</span> <span class="bound">vs</span> <span class="bound">δ</span>"</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-free_vars_branch_prob_cexpr"><span class="command">lemma</span></span> free_vars_branch_prob_cexpr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> free_vars <span class="free">δ</span> <span class="main">-</span> set <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> branch_prob_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PDF_Target_Density_Contexts-cexpr_typing_branch_prob_cexpr"><span class="command">lemma</span></span> cexpr_typing_branch_prob_cexpr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">δ</span> <span class="main">:</span> REAL <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> branch_prob_cexpr <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> branch_prob_cexpr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cexpr_typing_integrate_vars<span class="main">)</span>

<span class="keyword1" id="PDF_Target_Density_Contexts-cexpr_sem_branch_prob"><span class="command">lemma</span></span> cexpr_sem_branch_prob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="free">ρ</span> <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             branch_prob <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="quoted">"set <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">vs'</span>"</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> density_context_α<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="free">ρ</span> <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span>
                   <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> invar <span class="keyword1"><span class="command">unfolding</span></span> branch_prob_cexpr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> cexpr_sem_integrate_vars'<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cdens_ctxt_invar_imp_integrable assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> branch_prob <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case branch_prob_altdef<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">ρ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Target_Density_Contexts-subprob_imp_subprob_cexpr"><span class="command">lemma</span></span> subprob_imp_subprob_cexpr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"density_context <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="free">V</span> <span class="free">V'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_cexprI<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V'</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dens_ctxt_measure <span class="main">(</span><span class="free">V</span><span class="main">,</span> <span class="free">V'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="free">V</span> <span class="free">V'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span>
                   branch_prob <span class="main">(</span><span class="free">V</span><span class="main">,</span> <span class="free">V'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> branch_prob_altdef<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> emeasure <span class="var">?M</span> <span class="main">(</span>space <span class="var">?M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> branch_prob_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subprob_space.emeasure_space_le_1<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subprob_space_dens ρ<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PDF_Compiler">
<div class="head">
<h1>Theory PDF_Compiler</h1>
</div>
<pre class="source"><span class="comment1">(*
  Theory: PDF_Compiler.thy
  Authors: Manuel Eberl

  The concrete compiler that compiles a PDF expression into a target language expression
  that describes a density function on the corresponding measure space.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete PDF Compiler›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PDF_Compiler
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PDF_Compiler_Pred.html">PDF_Compiler_Pred</a> <a href="PDF_Target_Density_Contexts.html">PDF_Target_Density_Contexts</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">expr_has_density_cexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdens_ctxt <span class="main">⇒</span> expr <span class="main">⇒</span> cexpr <span class="main">⇒</span> bool"</span></span>
      <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span>_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span><span class="keyword3">/ </span><span class="keyword3">(</span>_ <span class="keyword1">⇒</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">(*  edc_equiv:  "cexpr_equiv f1 f2 ⟹ Γ ⊢ e : t ⟹ is_density_expr (vs,vs',Γ,δ) t f2 ⟹
                       (vs, vs', Γ, δ)  ⊢<span class="hidden">⇩</span><sub>c</sub> e ⇒ f1 ⟹ (vs, vs', Γ, δ)  ⊢<span class="hidden">⇩</span><sub>c</sub> e ⇒ f2"*)</span>
  edc_val<span class="main">:</span>     <span class="quoted"><span class="quoted">"countable_type <span class="main">(</span>val_type <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span>
                  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span>  <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Val <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">⇒</span></span>
                      map_vars Suc <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span>CVar <span class="main">0</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> CVal <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> edc_var<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⇒</span></span> marg_dens_cexpr <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span>"</span></span>
<span class="main">|</span> edc_pair<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="main">&lt;</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">&gt;</span> <span class="main"><span class="free">⇒</span></span> marg_dens2_cexpr <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span>"</span></span>
<span class="main">|</span> edc_fail<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Fail <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇒</span></span> CReal <span class="main">0</span>"</span></span>
<span class="main">|</span> edc_let<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                  <span class="main">(</span>shift_vars <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> map Suc <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> the <span class="main">(</span>expr_type <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span>
                         map_vars Suc <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span>
                    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">⇒</span></span> map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>
<span class="main">|</span> edc_rand<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Random <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                    <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span>
                           dist_dens_cexpr <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span> <span class="main">(</span>CVar <span class="main">1</span><span class="main">)</span> <span class="main">∂</span>dist_param_type <span class="free"><span class="bound"><span class="entity">dst</span></span></span>"</span></span>
<span class="main">|</span> edc_rand_det<span class="main">:</span> <span class="quoted"><span class="quoted">"randomfree <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span> free_vars <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">vs'</span></span></span> <span class="main">⟹</span>
                   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Random <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                     map_vars Suc <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span>
                     dist_dens_cexpr <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">(</span>map_vars Suc <span class="main">(</span>expr_rf_to_cexpr <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> edc_if_det<span class="main">:</span>   <span class="quoted"><span class="quoted">"randomfree <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span>
                 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span>expr_rf_to_cexpr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">⟹</span>
                 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="keyword1">¬<span class="hidden">⇩</span><sub>c</sub></span> expr_rf_to_cexpr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">⟹</span>
                 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span>"</span></span>
<span class="main">|</span> edc_if<span class="main">:</span>       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free"><span class="bound"><span class="entity">f</span></span></span> TRUE<span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free"><span class="bound"><span class="entity">f</span></span></span> FALSE<span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span>"</span></span>
<span class="main">|</span> edc_op_discr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span>
                   op_type <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> countable_type <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span>
                      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                          <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">1</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span>  map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> edc_fst<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">:</span> PRODUCT <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Fst <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                        <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span>CVar <span class="main">1</span><span class="main">,</span> CVar <span class="main">0</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> edc_snd<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">:</span> PRODUCT <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Snd <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                        <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span>CVar <span class="main">0</span><span class="main">,</span> CVar <span class="main">1</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> edc_neg<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Minus <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="main">|</span> edc_addc<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> randomfree <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">⟹</span> free_vars <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">vs'</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Add <span class="main">$$</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">&gt;</span> <span class="main"><span class="free">⇒</span></span>
                         <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> map_vars Suc <span class="main">(</span>expr_rf_to_cexpr <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> edc_multc<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Mult <span class="main">$$</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Val <span class="main">(</span>RealVal <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">&gt;</span> <span class="main"><span class="free">⇒</span></span>
                         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">(</span>inverse <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">(</span>inverse <span class="main">(</span>abs <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> edc_add<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">:</span> PRODUCT <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span>
                      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Add <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                       <span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="main">&lt;</span><span class="bound">x</span><span class="main">,</span> CVar <span class="main">1</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">x</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span><span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> edc_inv<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Inverse <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> inverse<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>inverse<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span> CInt <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> edc_exp<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub></span></span> Exp <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span>
                         <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">0</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">x</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> ln<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> inverse<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span> <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">expr_has_density_cexpr</span></span> <span class="keyword1"><span class="command">.</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>

<span class="keyword1" id="PDF_Compiler-cdens_ctxt_invar_insert"><span class="command">lemma</span></span> cdens_ctxt_invar_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="free">t'</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="main">(</span>shift_vars <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>map Suc <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="free">t'</span> <span class="main">⋅</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cdens_ctxt_invarI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t'</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> map_vars Suc <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> invar wf1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT REAL REAL"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros cexpr_typing_map_vars <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_density_exprD<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shift_var_set <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?vs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="main">`</span> set <span class="free">vs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?Γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="free">t'</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert_dens <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> density_context <span class="quoted"><span class="quoted">"set <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">vs'</span>"</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> density_context_α<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"density_context <span class="main">{}</span> <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> density_context_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span>stock_measure <span class="free">t'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hd free_vars <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ t dc<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def dens_ctxt_α_def <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extract_real_def one_ennreal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> density_context.density_context_insert<span class="main">[</span><span class="operator">OF</span> density_context_α<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density_context <span class="var">?vs</span> <span class="var">?vs'</span> <span class="var">?Γ</span> <span class="var">?δ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"density_context <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t'</span> <span class="free">Γ</span><span class="main">)</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="main">(</span>map_vars Suc <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> density_context_equiv<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"density_context <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t'</span> <span class="free">Γ</span><span class="main">)</span> <span class="var">?δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="main">(</span>map_vars Suc <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span><span class="var">?vs</span> <span class="main">∪</span> <span class="var">?vs'</span><span class="main">)</span> <span class="var">?Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_extract_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_cexpr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> invar is_density_exprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span><span class="var">?vs</span> <span class="main">∪</span> <span class="var">?vs'</span><span class="main">)</span> <span class="var">?Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> σ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert_dens <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span>
                   ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span>map_vars Suc <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> insert_dens_def <span class="keyword1"><span class="command">using</span></span> invar is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonneg_cexprD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_remove_var<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">t'</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Γ</span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?vs</span></span> <span class="main"><span class="main">∪</span></span> <span class="var"><span class="var">?vs'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing_map_vars ennreal_mult'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def shift_var_set_def eval_cexpr_def
                        cexpr_sem_map_vars remove_var_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> subprob_imp_subprob_cexpr<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="main">(</span>set <span class="main">(</span>shift_vars <span class="free">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>map Suc <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t'</span> <span class="free">Γ</span><span class="main">)</span>
                        <span class="main">(</span>map_vars Suc <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">-`</span> shift_var_set <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="main">=</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t'</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf1<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="main">(</span>shift_vars <span class="free">vs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>map Suc <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t'</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_Mult<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing_map_vars nonneg_cexpr_map_vars
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def shift_var_set_def image_Un<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> invar is_density_exprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_vars_def shift_var_set_def distinct_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing_map_vars<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler-cdens_ctxt_invar_insert_bool"><span class="command">lemma</span></span> cdens_ctxt_invar_insert_bool<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">b</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> BOOL <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">b</span> <span class="main">:</span> BOOL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">b</span> <span class="main">⊆</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="main">(</span><span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cdens_ctxt_invarI nonneg_cexpr_Mult nonneg_cexpr_subst_val<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> invar' <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> invar<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> wf' <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> invar' wf'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT REAL REAL"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair cexpr_typing_subst_val<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span><span class="main">{}</span><span class="main">,</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="var">?M</span>
                 <span class="main">(</span>stock_measure BOOL<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">σ</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> density_context_α<span class="main">[</span><span class="operator">OF</span> invar<span class="main">]</span> t vars dens <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_aux density_context.density_context_empty<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extract_real_def one_ennreal_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat BOOL <span class="free">Γ</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">(</span><span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_cexprI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eval</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span> <span class="bound">σ</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?eval</span> <span class="main">(</span><span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span>
                  <span class="var">?eval</span> <span class="free">δ</span> <span class="skolem">σ</span> <span class="main">*</span> <span class="var">?eval</span> <span class="main">(</span>cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf' invar' σ ρ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> V <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free"><span class="free">vs</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set <span class="free"><span class="free"><span class="free">vs'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_in_state_measure <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eval</span> <span class="free">δ</span> <span class="skolem">σ</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ ρ invar'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nonneg_cexprD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_in_state_measure<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eval</span> <span class="main">(</span>cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ ρ nonneg
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprD nonneg_cexpr_subst_val<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_in_state_measure<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span><span class="var">?eval</span> <span class="main">(</span>cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span>
                          ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="main">(</span>merge <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">vs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
                          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_cexpr_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span><span class="var">?eval</span> <span class="main">(</span>cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> σ ρ dens' <span class="keyword1"><span class="command">unfolding</span></span> has_parametrized_subprob_density_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> B<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> subprob_count_space_density_le_1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_in_state_measure <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eval</span> <span class="main">(</span><span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">≤</span> <span class="var">?eval</span> <span class="free">δ</span> <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> mult_right_le_one_le<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="main">(</span><span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≤</span>
              <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="free">δ</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_mono<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_leI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invar' ρ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subprob_cexprD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">σ</span><span class="main">.</span> <span class="var">?eval</span> <span class="main">(</span><span class="free">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="free">f</span> <span class="main">(</span>BoolVal <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">∂</span>state_measure <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cdens_ctxt_invarD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invar<span class="main"><span class="main">]</span></span> is_density_exprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler-space_state_measureD_shift"><span class="command">lemma</span></span> space_state_measureD_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">x</span> <span class="bound">σ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> type_universe <span class="free">t</span> <span class="main">∧</span> <span class="bound">σ'</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">=</span> case_nat <span class="bound">x</span> <span class="bound">σ'</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">σ</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">σ</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> Suc"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff PiE_iff space_state_measure extensional_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler-space_state_measure_shift_iff"><span class="command">lemma</span></span> space_state_measure_shift_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">σ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> type_universe <span class="free">t</span> <span class="main">∧</span> <span class="bound">σ'</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">=</span> case_nat <span class="bound">x</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> space_state_measureD_shift<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler-nonneg_cexprI_shift"><span class="command">lemma</span></span> nonneg_cexprI_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> type_universe <span class="free">t</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprI assms <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> space_state_measureD_shift<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler-nonneg_cexpr_shift_iff"><span class="command">lemma</span></span> nonneg_cexpr_shift_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars o_def nonneg_cexpr_def space_state_measure_shift_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">SOME</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> type_universe <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">σ</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> type_universe_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ex_in_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> case_nat_in_state_measure <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Compiler-case_nat_case_nat"><span class="command">lemma</span></span> case_nat_case_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="free">x</span> <span class="free">n</span> <span class="main">(</span>case_nat <span class="free">y</span> <span class="free">m</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="main">(</span>case_nat <span class="free">x</span> <span class="free">n</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i'</span><span class="main">.</span> case_nat <span class="free">x</span> <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nat.case_distrib<span class="main">)</span>

<span class="keyword1" id="PDF_Compiler-nonneg_cexpr_shift_iff2"><span class="command">lemma</span></span> nonneg_cexpr_shift_iff2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>case_nat <span class="free">t1</span> <span class="main">(</span>case_nat <span class="free">t2</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span>
    nonneg_cexpr <span class="main">(</span>shift_var_set <span class="free">V</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="free">t1</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars o_def nonneg_cexpr_def space_state_measure_shift_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x σ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">(</span></span>case_nat <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">SOME</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> type_universe <span class="free"><span class="free">t2</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">σ</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> type_universe_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ex_in_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_nat_case_nat <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nat.case_cong
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> case_nat_in_state_measure  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI_ex someI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x1 x2 σ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_state_measure_shift_iff fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x1</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PDF_Compiler-nonneg_cexpr_Add"><span class="command">lemma</span></span> nonneg_cexpr_Add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e1</span> <span class="main">:</span> REAL"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span> <span class="main">:</span> REAL"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e2</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N2<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="free">V</span> <span class="free">Γ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexprI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="free">e1</span><span class="main">)</span> <span class="main">+</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Add<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ N1 N2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_nonneg_nonneg nonneg_cexprD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="free">e1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e2</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PDF_Compiler-expr_has_density_cexpr_sound_aux"><span class="command">lemma</span></span> expr_has_density_cexpr_sound_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="free">vs</span> <span class="free">vs'</span> <span class="free">Γ</span> <span class="free">δ</span>"</span></span>
          <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">⊆</span> set <span class="free">vs</span> <span class="main">∪</span> set <span class="free">vs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> eval_cexpr <span class="free">f</span> <span class="main">∧</span> is_density_expr <span class="main">(</span><span class="free">vs</span><span class="main">,</span><span class="free">vs'</span><span class="main">,</span><span class="free">Γ</span><span class="main">,</span><span class="free">δ</span><span class="main">)</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expr_has_density_cexpr.induct<span class="main"><span class="main">[</span></span><span class="operator">split_format</span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="comment1">(*  case (edc_equiv f1 f2 Γ e t vs vs' δ t')
  hence [simp]: "t' = t" by (auto intro!: expr_typing_unique)
  from edc_equiv have "(λρ x. ennreal (eval_cexpr f1 ρ x)) = (λρ x. ennreal (eval_cexpr f2 ρ x))"
    unfolding cexpr_equiv_def eval_cexpr_def by (intro ext) auto
  with edc_equiv show ?case unfolding dens_ctxt_α_def by auto

next*)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_val <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> edc_val.prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> val_type <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_val.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vars Suc <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>CVar <span class="main">0</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> CVal <span class="skolem">v</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ctype1<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e1</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ctype2<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> invar
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros cexpr_typing_map_vars <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> type_universe <span class="main">(</span>val_type <span class="skolem">v</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="main">(</span>val_type <span class="skolem">v</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> case_nat_in_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
             ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span>
                 <span class="main">(</span>map_vars Suc <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
             ennreal <span class="main">(</span>extract_real <span class="main">(</span>RealVal <span class="main">(</span>bool_to_real <span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">*</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bool_to_real_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">Γ</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"shift_var_set <span class="main"><span class="main">(</span></span>set <span class="skolem"><span class="skolem">vs'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> invar ctype1 ctype2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> branch_prob <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span><span class="skolem">vs'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_map_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> cexpr_sem_branch_prob<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def ρ edc_val.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> indicator <span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def bool_to_real_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
                     branch_prob <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span><span class="skolem">vs'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="main">*</span> indicator <span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> e <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="main">(</span>val_type <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_eval_cexpr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ctype invar<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">-`</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">vs'</span>"</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="main">(</span>val_type <span class="skolem">v</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">∘</span> Suc <span class="main">=</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span>
      <span class="main">(</span>map_vars Suc <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span>CVar <span class="main">0</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> CVal <span class="skolem">v</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar ctype1 ctype2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_Mult nonneg_indicator nonneg_cexpr_map_vars
                          cexpr_typing.intros nonneg_cexpr_sem_integrate_vars'
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> branch_prob_cexpr_def *<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_val et_val AE_I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> edc_val<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e dens_ctxt_α_def meas<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> is_density_exprI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ctype
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> invar nn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_var <span class="skolem">x</span> <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_var.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> invar <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_var edc_var.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> edc_var.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_vars_marg_dens_cexpr<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> free_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> edc_var.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_vars_marg_dens_cexpr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span>marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">ρ</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_eval_cexpr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ctype free_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t</span><span class="main">.</span>
             marg_dens <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="bound">y</span> <span class="main">=</span>
                  ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span>marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> edc_var <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> eq_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> cexpr_sem_marg_dens<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t</span><span class="main">.</span>
            marg_dens <span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="bound">y</span> <span class="main">=</span>
                 ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span>marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> edc_var.prems edc_var.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_sem_marg_dens<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>marg_dens_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI_shift nonneg_cexpr_sem_marg_dens<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edc_var.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">vs</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_pair <span class="skolem">x</span> <span class="skolem">vs</span> <span class="skolem">y</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> PRODUCT <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_pair.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> invar <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> marg_dens2_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">δ</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> edc_pair.prems <span class="keyword1"><span class="command">have</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>marg_dens2_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> free_vars_marg_dens2_cexpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_pair edc_pair.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">z</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t</span><span class="main">.</span>
              marg_dens2 <span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ρ</span> <span class="bound">z</span> <span class="main">=</span>
                ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span>marg_dens2_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cexpr_sem_marg_dens2<span class="main">[</span><span class="operator">OF</span> edc_pair.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> edc_pair.hyps ρ<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> eq_commute<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>marg_dens2_cexpr <span class="skolem">Γ</span> <span class="skolem">vs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI_shift nonneg_cexpr_sem_marg_dens2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edc_pair.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">vs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span><span class="main">∈</span>set <span class="skolem">vs</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_pair invar ctype vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_fail <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">0</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> val_type.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> cexpr_typing.intros<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def eval_cexpr_def extract_real_def
                            zero_ennreal_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hd_fail
                      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_density_exprI nonneg_cexprI<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_let <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">δ</span> <span class="skolem">e'</span> <span class="skolem">g</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_let.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> t1 <span class="keyword1"><span class="command">have</span></span> t1'<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dens1<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span>  <span class="skolem">e</span> <span class="main">⇒</span>
                   <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="skolem">t'</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_let.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t1<span class="main">]</span> edc_let.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cdens_ctxt_invar_empty<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> invf<span class="main">:</span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="main">(</span>shift_vars <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>map Suc <span class="skolem">vs'</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>map_vars Suc <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_let.prems edc_let.hyps dens1 wf1 invar
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cdens_ctxt_invar_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ t1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shift_vars <span class="skolem">vs</span><span class="main">,</span> map Suc <span class="skolem">vs'</span><span class="main">,</span> case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">,</span> map_vars Suc <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>shift_vars <span class="skolem">vs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>map Suc <span class="skolem">vs'</span><span class="main">)</span> <span class="main">=</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_var_set_def image_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span>shift_vars <span class="skolem">vs</span><span class="main">,</span> map Suc <span class="skolem">vs'</span><span class="main">,</span> case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">,</span> map_vars Suc <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span>
            <span class="skolem">e'</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        is_density_expr <span class="main">(</span>shift_vars <span class="skolem">vs</span><span class="main">,</span> map Suc <span class="skolem">vs'</span><span class="main">,</span> case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">,</span> map_vars Suc <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invf t2 edc_let.prems subset_shift_var_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t1'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> edc_let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> dens2<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="var">?𝒴</span>  <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e'</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span>shift_vars <span class="skolem">vs</span><span class="main">,</span> map Suc <span class="skolem">vs'</span><span class="main">,</span> case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">,</span> map_vars Suc <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> cexpr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">=</span>
                   cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="main">(</span>case_nat undefined <span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">ρ</span>
    <span class="keyword1"><span class="command">using</span></span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_sem_eq_on_vars<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> case_nat <span class="main">(</span><span class="bound">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span><span class="main">,</span> Suc <span class="main">`</span> set <span class="skolem">vs'</span><span class="main">,</span> case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">,</span>
           insert_dens <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e'</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">aa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g</span> <span class="bound">a</span> <span class="bound">aa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case set_shift_vars set_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> hd_dens_ctxt_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> invar is_density_exprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert_dens_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonneg_cexprD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_remove_var<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_var_set_def image_Un<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">Γ</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing_map_vars <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def shift_var_set_def image_Un
             cexpr_sem_map_vars insert_dens_def eval_cexpr_def remove_var_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="keyword1">LET</span> <span class="skolem">e</span> <span class="keyword1">IN</span> <span class="skolem">e'</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g</span> <span class="main">(</span>case_nat undefined <span class="bound">ρ</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> hd_let<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">xa</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> ennreal <span class="main"><span class="main"><span class="main">(</span></span></span>eval_cexpr <span class="skolem"><span class="skolem"><span class="skolem">f</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">xa</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> dens1 dens2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def extract_real_def one_ennreal_def t1'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="keyword1">LET</span> <span class="skolem">e</span> <span class="keyword1">IN</span> <span class="skolem">e'</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span>map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> hd_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ edc_let.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_cexpr <span class="main">(</span>map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span>
            extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> cexpr_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ρ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g</span> <span class="main">(</span>case_nat undefined <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
                      ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span>map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_cexpr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> density_context_α<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edc_let.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> is_density_exprI<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> wf <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">:</span> REAL"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_typing_map_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cexpr_typing_cong'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">insert</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span>
                         <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>map_vars <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprI_shift<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars cexpr_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_state_measure PiE_iff extensional_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_rand <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">dst</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> dist_param_type <span class="skolem">dst</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_rand.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> edc_rand <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> dist_result_type <span class="skolem">dst</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edc_rand t1 t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">have</span></span> tf<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> varsf<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="skolem">f</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_density_expr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span><span class="skolem">vs'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                   <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens t1 edc_rand.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def expr_has_density_sound_aux density_context_α<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?shift</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vars <span class="var">?shift</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dist_dens_cexpr <span class="skolem">dst</span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span> <span class="main">(</span>CVar <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">Γ</span><span class="main">.</span> case_nat <span class="bound">t</span> <span class="main">(</span>case_nat <span class="bound">t'</span> <span class="bound">Γ</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?shift</span> <span class="main">=</span> case_nat <span class="bound">t</span> <span class="bound">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> te1<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e1</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> tf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros cexpr_typing_dist_dens_cexpr cet_var'
        cexpr_typing_map_vars <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def t2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> te2<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_dist_dens_cexpr cet_var'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def t2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> te<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> te1 te2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_int cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT REAL REAL"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t2 t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?e1</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> varsf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nonneg_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span>  <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="var">?e1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprI wf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> nonneg_cexprD<span class="main"><span class="main">]</span></span> case_nat_in_state_measure
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> space_state_measureD_shift <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?e2</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_dist_dens_cexpr<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nonneg_e2<span class="main">:</span>  <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span>case_nat <span class="skolem">t</span>  <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="var">?e2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_dist_dens_cexpr cet_var'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t2 t_def shift_var_set_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span> dist_dens <span class="skolem">dst</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">∂</span>stock_measure <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span><span class="skolem">vs'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Random <span class="skolem">dst</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Random <span class="skolem">dst</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case t_def hd_rand<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> apply_dist_to_dens_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens''<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_rand.prems invar
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> expr_has_density_sound_aux<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> type_universe <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> type_universe <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ρ''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">y</span> <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?Γ''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> ρ''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ρ''</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?Γ''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ x y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> case_nat_in_state_measure<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="var">?ρ''</span> <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                extract_real <span class="main">(</span>cexpr_sem <span class="var">?ρ''</span> <span class="var">?e1</span><span class="main">)</span> <span class="main">*</span> extract_real <span class="main">(</span>cexpr_sem <span class="var">?ρ''</span> <span class="var">?e2</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> te1 te2 ρ'' vars_e1 vars_e2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonneg_e1 nonneg_e2 ρ''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_nonneg_nonneg <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nonneg_cexprD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="var">?ρ''</span> <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">note</span></span> A
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_cexpr <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="skolem">y</span> <span class="main">*</span> dist_dens <span class="skolem">dst</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="main">=</span> extract_real <span class="main">(</span>cexpr_sem <span class="var">?ρ''</span> <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ρ''
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult''<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> nonneg_e2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonneg_cexprD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_dist_dens_cexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Γ''</span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?V''</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_map_vars eval_cexpr_def t2 t_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_var'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">note</span></span> this B
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> e1e2 <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t'</span><span class="main">.</span>
            apply_dist_to_dens <span class="skolem">dst</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="bound">x</span> <span class="main">=</span> eval_cexpr <span class="var">?e</span> <span class="skolem">ρ</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AE_I2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> has_parametrized_subprob_density_integral<span class="main">[</span><span class="operator">OF</span> dens'' ρ<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="skolem">ρ</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t'</span><span class="main">.</span> <span class="var">?f</span> <span class="skolem">ρ</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> has_parametrized_subprob_densityD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dens''<span class="main">]</span> ρ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_PInf_AE <span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ρ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">x</span> <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> ρ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ρ'</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ρ x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> case_nat_in_state_measure<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span> dist_dens <span class="skolem">dst</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">y</span> <span class="var">?ρ'</span><span class="main">)</span> <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ρ x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e1e2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> finite <span class="keyword1"><span class="command">have</span></span> finite'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_top<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?e</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ρ' te te1 te2 vars_e1 vars_e2 nonneg_e1 nonneg_e2
        <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_integral_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite'<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def t2 t_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_Mult<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"apply_dist_to_dens <span class="skolem">dst</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span>
                        ennreal <span class="main">(</span>eval_cexpr <span class="var">?e</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> apply_dist_to_dens_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> AE_eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?e</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> measurable_eval_cexpr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> te<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> vars_e1 vars_e2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_rand edc_rand.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dens <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span>
                        <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_int nonneg_cexpr_Mult nonneg_dist_dens_cexpr te1 te2 vars_e1 vars_e2 nonneg_e1<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def t2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_var'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span>
     <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span> <span class="main">∂</span>dist_param_type <span class="skolem">dst</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> AE_eq meas te vars_e1 vars_e2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def t2 shift_var_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_rand_det <span class="skolem">e</span> <span class="skolem">vs'</span> <span class="skolem">vs</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">dst</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> dist_param_type <span class="skolem">dst</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_rand_det.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> edc_rand_det <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> dist_result_type <span class="skolem">dst</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vars Suc <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dist_dens_cexpr <span class="skolem">dst</span> <span class="main">(</span>map_vars Suc <span class="main">(</span>expr_rf_to_cexpr <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ctype1<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e1</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing_map_vars <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars2'<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span>map_vars Suc <span class="main">(</span>expr_rf_to_cexpr <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def <span class="keyword1"><span class="command">using</span></span> free_vars_expr_rf_to_cexpr edc_rand_det.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> vars2<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?e2</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>free_vars <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_var_set_def <span class="keyword1"><span class="command">using</span></span> free_vars_expr_rf_to_cexpr edc_rand_det.hyps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_dist_dens_cexpr<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ctype2<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> t1 edc_rand_det.hyps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_dist_dens_cexpr cexpr_typing_map_vars<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def t_def t2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_var'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> nonneg_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?e2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t1 <span class="quoted"><span class="quoted">‹randomfree <span class="skolem">e</span>›</span></span> free_vars_expr_rf_to_cexpr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> edc_rand_det.hyps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_dist_dens_cexpr cexpr_typing_map_vars<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def t_def t2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_var'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> nonneg_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?e1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> branch_prob_cexpr_def nonneg_cexpr_shift_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_sem_integrate_vars'<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> type_universe <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> ρ'<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> case_nat_in_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_cexpr <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span>
             ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span>
                 <span class="main">(</span>map_vars Suc <span class="main">(</span>branch_prob_cexpr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
             ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="var">?e2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">*</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> invar
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonneg_e2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">Γ</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"shift_var_set <span class="main"><span class="main">(</span></span>set <span class="skolem"><span class="skolem">vs'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> invar ctype1 vars2 ctype2 edc_rand_det.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> branch_prob <span class="main">(</span>dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span><span class="skolem">vs'</span><span class="main">,</span><span class="skolem">Γ</span><span class="main">,</span><span class="skolem">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?c</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_map_vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> cexpr_sem_branch_prob<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def ρ edc_rand_det.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> dist_dens <span class="skolem">dst</span> <span class="main">(</span>expr_sem_rf <span class="skolem">ρ</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?d</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> t1 edc_rand_det.hyps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_dist_dens_cexpr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="skolem"><span class="skolem"><span class="skolem">t'</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Γ</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ρ' vars2'<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing_map_vars cet_var'
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def t_def t2 cexpr_sem_map_vars cexpr_sem_expr_rf_to_cexpr<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="var">?c</span> <span class="main">*</span> <span class="var">?d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ρ</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                <span class="main">∈</span> borel_measurable <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ctype1 ctype2 vars2 invar edc_rand_det.hyps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_split_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> measurable_split_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> measurable_eval_cexpr<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ctype1 ctype2 vars2 invar edc_rand_det.hyps
    <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> is_density_exprI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="var">?e1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?e2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> invar<span class="main">(</span>2<span class="main">)</span>
        order_trans<span class="main">[</span><span class="operator">OF</span> free_vars_expr_rf_to_cexpr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹randomfree <span class="skolem">e</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹free_vars <span class="skolem">e</span> <span class="main">⊆</span> set <span class="skolem">vs'</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_Mult ctype1 ctype2 nonneg_e2 nonneg_e1
          free_vars_dist_dens_cexpr<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> edc_rand_det.prems edc_rand_det.hyps meas wf A
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_rand_det<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edc_rand_det.hyps<span class="main"><span class="main">]</span></span> edc_rand_det.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> AE_I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_if_det <span class="skolem">b</span> <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e1</span> <span class="skolem">f1</span> <span class="skolem">e2</span> <span class="skolem">f2</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> tb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">b</span> <span class="main">:</span> BOOL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> edc_if_det <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"randomfree <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="skolem">b</span> <span class="main">⊆</span> set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_if_det.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ind1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>expr_rf_to_cexpr <span class="skolem">b</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ind2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">¬<span class="hidden">⇩</span><sub>c</sub></span> expr_rf_to_cexpr <span class="skolem">b</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tind1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tind2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_if_det.hyps tb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tδ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tδ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar<span class="main">(</span>3<span class="main">)</span> edc_if_det.hyps tb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nonneg_ind1<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="var">?ind1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       nonneg_ind2<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="var">?ind2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tind1 tind2 edc_if_det.hyps tb
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_expr_rf_to_cexpr bool_to_real_def extract_real_def
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> val_type_expr_sem_rf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tb b<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> BOOL_E <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> subprob1<span class="main">:</span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       subprob2<span class="main">:</span> <span class="quoted"><span class="quoted">"subprob_cexpr <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar tb edc_if_det.hyps edc_if_det.prems free_vars_expr_rf_to_cexpr<span class="main">[</span><span class="operator">OF</span> edc_if_det.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subprob_indicator cet_op<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars1<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       vars2<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar edc_if_det.hyps edc_if_det.prems free_vars_expr_rf_to_cexpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar edc_if_det.hyps edc_if_det.prems tind1 tδ1  subprob1 nonneg_ind1 vars1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cdens_ctxt_invarI nonneg_cexpr_Mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar edc_if_det.hyps edc_if_det.prems tind2 tδ2  subprob2 nonneg_ind2 vars2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cdens_ctxt_invarI nonneg_cexpr_Mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dens1<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e1</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="skolem">f1</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       wf1<span class="main">:</span>   <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">f1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_if_det.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t1 inv1<span class="main">]</span> edc_if_det.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dens2<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e2</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="skolem">f2</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       wf2<span class="main">:</span>   <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">f2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_if_det.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t2 inv2<span class="main">]</span> edc_if_det.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_if_det<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> if_dens_det <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> True<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e1</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="skolem">f1</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hd_dens_ctxt_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="var">?δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e1</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f1</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dens1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">*</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="var">?ind1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invar vars1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invar<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tind1 σ<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="var">?ind1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">b</span> <span class="main">=</span> TRUE <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> edc_if_det.hyps val_type_expr_sem_rf<span class="main">[</span><span class="operator">OF</span> tb b σ<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_expr_rf_to_cexpr extract_real_def bool_to_real_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> BOOL_E<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?δ</span> <span class="skolem">σ</span> <span class="main">=</span> if_dens_det <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> True <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_dens_det_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> if_dens_det <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">x</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> False<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e2</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="skolem">f2</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hd_dens_ctxt_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="var">?δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e2</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f2</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dens2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?ind2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">*</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="var">?ind2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invar vars1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invar<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tind2 σ<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="var">?ind2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> expr_sem_rf <span class="skolem">σ</span> <span class="skolem">b</span> <span class="main">=</span> FALSE <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> edc_if_det.hyps val_type_expr_sem_rf<span class="main">[</span><span class="operator">OF</span> tb b σ<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_expr_rf_to_cexpr extract_real_def bool_to_real_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> BOOL_E<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?δ</span> <span class="skolem">σ</span> <span class="main">=</span> if_dens_det <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> False <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_dens_det_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_cexpr <span class="main">(</span><span class="skolem">f1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> eval_cexpr <span class="skolem">f1</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">+</span> eval_cexpr <span class="skolem">f2</span> <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf1 wf2 <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def is_density_expr_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Add<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Γ</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> V <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"shift_var_set <span class="main"><span class="main"><span class="main">(</span></span></span>set <span class="skolem"><span class="skolem"><span class="skolem">vs'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> eval_cexpr <span class="skolem">f1</span> <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> eval_cexpr <span class="skolem">f2</span> <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
      <span class="keyword1"><span class="command">using</span></span> ρ x wf1<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">,</span> <span class="operator">THEN</span> nonneg_cexprD<span class="main">]</span> wf2<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">,</span> <span class="operator">THEN</span> nonneg_cexprD<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> space_state_measure_shift_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f1</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f2</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="skolem">f1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf1 wf2
      <span class="keyword1"><span class="command">using</span></span> wf1<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">]</span> wf2<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_density_expr_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"PRODUCT REAL REAL"</span></span><span class="main"><span class="main">]</span></span> cet_pair nonneg_cexpr_Add<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_if_det.prems edc_if_det.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_if <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">δ</span> <span class="skolem">e1</span> <span class="skolem">g1</span> <span class="skolem">e2</span> <span class="skolem">g2</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> tb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">b</span> <span class="main">:</span> BOOL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_if.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> densb<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">b</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">b</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wfb<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> BOOL <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_if.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> tb<span class="main">]</span> edc_if.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cdens_ctxt_invar_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="skolem">f</span> TRUE<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"cdens_ctxt_invar <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> cexpr_subst_val <span class="skolem">f</span> FALSE<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tb densb wfb edc_if.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cdens_ctxt_invar_insert_bool<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cexpr_subst_val <span class="skolem">f</span> TRUE"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?δ2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cexpr_subst_val <span class="skolem">f</span> FALSE"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tδ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ1</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tδ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ2</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wfb<span class="main">]</span> invar
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"PRODUCT REAL REAL"</span></span><span class="main"><span class="main">]</span></span> cet_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars1<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       vars2<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ2</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar is_density_exprD<span class="main">[</span><span class="operator">OF</span> wfb<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dens1<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e1</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g1</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ1</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">g1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       dens2<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ2</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e2</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g2</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ2</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">g2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_if.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t1 inv1<span class="main">]</span> edc_if.IH<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t2 inv2<span class="main">]</span> edc_if.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> f_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>BoolVal <span class="skolem">b</span><span class="main">)</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">σ</span>
    <span class="keyword1"><span class="command">using</span></span> wfb<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexprD<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_if<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> if_dens <span class="var">?δ'</span> <span class="var">?f</span> True<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e1</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="skolem">g1</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hd_dens_ctxt_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="var">?δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e1</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g1</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dens1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">*</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="var">?δ1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> invar vars1 is_density_exprD<span class="main">[</span><span class="operator">OF</span> wfb<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invar<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> _ σ<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> if_dens <span class="var">?δ'</span> <span class="var">?f</span> True <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> if_dens_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_cexpr_def ennreal_mult'' σ<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?δ</span> <span class="skolem">σ</span> <span class="main">=</span> if_dens <span class="var">?δ'</span> <span class="var">?f</span> True <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_dens_det_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> if_dens <span class="var">?δ'</span> <span class="var">?f</span> False<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e2</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="skolem">g2</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hd_dens_ctxt_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="var">?δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e2</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g2</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dens2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">δ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?δ2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">*</span> extract_real <span class="main">(</span>cexpr_sem <span class="skolem">σ</span> <span class="var">?δ2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> invar vars1 is_density_exprD<span class="main">[</span><span class="operator">OF</span> wfb<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invar<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> _ σ<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> if_dens <span class="var">?δ'</span> <span class="var">?f</span> False <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> if_dens_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_cexpr_def ennreal_mult'' σ<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?δ</span> <span class="skolem">σ</span> <span class="main">=</span> if_dens <span class="var">?δ'</span> <span class="var">?f</span> False <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_dens_det_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_cexpr <span class="main">(</span><span class="skolem">g1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">g2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> eval_cexpr <span class="skolem">g1</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">+</span> eval_cexpr <span class="skolem">g2</span> <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf1 wf2 <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def is_density_expr_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Add<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"case_nat <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Γ</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> V <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"shift_var_set <span class="main"><span class="main"><span class="main">(</span></span></span>set <span class="skolem"><span class="skolem"><span class="skolem">vs'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> eval_cexpr <span class="skolem">g1</span> <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> eval_cexpr <span class="skolem">g2</span> <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
      <span class="keyword1"><span class="command">using</span></span> ρ x wf1<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">,</span> <span class="operator">THEN</span> nonneg_cexprD<span class="main">]</span> wf2<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">,</span> <span class="operator">THEN</span> nonneg_cexprD<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> space_state_measure_shift_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g1</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">g2</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="skolem">g1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">g2</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">g1</span> <span class="keyword1">+<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">g2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf1 wf2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_density_expr_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"PRODUCT REAL REAL"</span></span><span class="main"><span class="main">]</span></span> cet_pair nonneg_cexpr_Add<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">,</span> set <span class="skolem">vs</span> <span class="main">∪</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">b</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> densb <span class="keyword1"><span class="command">unfolding</span></span> dens_ctxt_α_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def one_ennreal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_if.prems edc_if.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_op_discr <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">oper</span> <span class="skolem">t'</span> <span class="skolem">t''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">(</span><span class="skolem">oper</span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">1</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr'</span> <span class="main">∂</span><span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?shift</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> edc_op_discr.prems<span class="main">(</span>1<span class="main">)</span> edc_op_discr.hyps
    <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> edc_op_discr.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> edc_op_discr.hyps <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_typing_unique<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> et_op<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword2"><span class="keyword">and</span></span> edc_op_discr.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> the_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> the_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">oper</span> <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> edc_op_discr.prems edc_op_discr.IH<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> wf' <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ctype'''<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="skolem">oper</span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">1</span> <span class="main">:</span> BOOL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       ctype''<span class="main">:</span>  <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟨</span><span class="main">(</span><span class="skolem">oper</span> <span class="keyword1">$$<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">1</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       ctype'<span class="main">:</span>   <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr'</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> wf' edc_op_discr.hyps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> cet_op_intros cexpr_typing_map_vars cet_var' cet_pair cet_eq<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_op cet_var'<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> ctype' <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cet_int<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars'<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr'</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="var">?𝒴</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                              <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="var">?expr'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf' vars' ctype''' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ctype''<span class="main"><span class="main">]</span></span> cexpr_typing_map_vars
                                       nonneg_cexpr_map_vars nonneg_indicator<span class="main">)</span>
                                <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nonneg_cexprD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extract_real_def bool_to_real_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="var">?𝒴</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span><span class="skolem">oper</span> <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> op_sem <span class="skolem">oper</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">oper</span> <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens t edc_op_discr.hyps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> the_t1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> hd_op_discr<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def the_t1 expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">oper</span> <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="var">?expr'</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hd_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _  nn_integral_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="bound">M</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">ρ</span> <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">y</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">y</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> wf' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_cexpr_sem<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr'</span> <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def extract_real_def lift_RealIntVal2_def
            bool_to_real_def cexpr_sem_map_vars <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> REAL_E<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_op_discr.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>
                     <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="var">?expr'</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_op_discr.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_aux density_context_α<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dens</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="var">?expr'</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t'</span><span class="main">.</span> <span class="var">?dens</span> <span class="bound">x</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AE_I2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> has_parametrized_subprob_density_integral<span class="main">[</span><span class="operator">OF</span> dens' ρ<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
           has_parametrized_subprob_densityD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dens'<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ρ
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t'</span><span class="main">.</span> <span class="var">?dens</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_PInf_AE<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?dens</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dens</span> <span class="skolem">x</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ρ vars' ctype' ctype' nonneg <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_integral_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_map_vars <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_top<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t''</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr'</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_int<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> vars ctype edc_op_discr.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_fst <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t''</span> <span class="skolem">t'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> expr_typing_unique et_op<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> edc_fst.hyps <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="main">(</span>Snd <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?shift</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> case_nat <span class="bound">t</span> <span class="main">(</span>case_nat <span class="bound">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">∘</span> case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="bound">t</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_fst.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edc_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span>
                    <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_density_exprD_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> wf' <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vars <span class="var">?shift</span> <span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span>CVar <span class="main">1</span><span class="main">,</span> CVar <span class="main">0</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t'</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span>
     <span class="keyword1"><span class="command">using</span></span> wf' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros cexpr_typing_map_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> free_vars_cexpr_comp wf'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subset_shift_var_set<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span>
                    <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Fst <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">ρ</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>case_nat <span class="bound">x</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">&lt;|</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?shift</span> <span class="main">=</span> case_nat <span class="main">&lt;|</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">|&gt;</span> <span class="bound">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Fst <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">(</span><span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">_</span> <span class="main">⇒</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dens <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> hd_fst<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Fst <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="var">?expr</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">_</span> <span class="main">⇒</span> <span class="var">?f</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> density_context_α<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> edc_fst.prems A<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def cexpr_sem_cexpr_comp cexpr_sem_map_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens''<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_fst.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_aux density_context_α<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">V</span><span class="main">.</span> <span class="var">?shift</span> <span class="main">-`</span> shift_var_set <span class="main">(</span>shift_var_set <span class="bound">V</span><span class="main">)</span> <span class="main">=</span> shift_var_set <span class="bound">V</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nonneg'<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="var">?expr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_comp nonneg_cexpr_map_vars nonneg cexpr_typing.intros cet_var'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t</span><span class="main">.</span> <span class="var">?f</span> <span class="skolem">ρ</span> <span class="bound">x</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">∂</span><span class="skolem">t'</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ctype vars edc_fst.hyps nonneg'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_density_cexpr_sem_integral<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens''<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span>
     <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>map_vars <span class="main">(</span>case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span>CVar <span class="main">1</span><span class="main">,</span> CVar <span class="main">0</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="main">∂</span><span class="skolem">t'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> nonneg' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_int<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_fst.prems ctype vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_split_conv
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_int measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span>
               measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_eval_cexpr<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_snd <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">t''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> expr_typing_unique et_op<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> edc_snd.hyps <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>expr_type <span class="skolem">Γ</span> <span class="main">(</span>Fst <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?shift</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> case_nat <span class="bound">t</span> <span class="main">(</span>case_nat <span class="bound">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">∘</span> case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="bound">t</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_snd.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edc_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span>
                    <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_density_exprD_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> wf' <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vars <span class="var">?shift</span> <span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span>CVar <span class="main">0</span><span class="main">,</span> CVar <span class="main">1</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span>
     <span class="keyword1"><span class="command">using</span></span> wf' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cexpr_typing.intros cexpr_typing_map_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> free_vars_cexpr_comp wf'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subset_shift_var_set<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ρ</span>
                    <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Snd <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">ρ</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>case_nat <span class="bound">y</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">&lt;|</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?shift</span> <span class="main">=</span> case_nat <span class="main">&lt;|</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">|&gt;</span> <span class="bound">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Snd <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">(</span><span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">_</span> <span class="main">⇒</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dens <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> t'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> hd_snd<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Snd <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> eval_cexpr <span class="var">?expr</span> <span class="main">(</span>case_nat <span class="bound">y</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">_</span> <span class="main">⇒</span> <span class="var">?f</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> density_context_α<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> edc_snd.prems A<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def cexpr_sem_cexpr_comp cexpr_sem_map_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens''<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?M</span> <span class="main">(</span>stock_measure <span class="skolem">t'</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_snd.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_aux density_context_α<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">V</span><span class="main">.</span> <span class="var">?shift</span> <span class="main">-`</span> shift_var_set <span class="main">(</span>shift_var_set <span class="bound">V</span><span class="main">)</span> <span class="main">=</span> shift_var_set <span class="bound">V</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nonneg'<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="var">?expr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_comp nonneg_cexpr_map_vars nonneg cexpr_typing.intros cet_var'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI is_density_exprI <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t'</span><span class="main">.</span> <span class="var">?f</span> <span class="skolem">ρ</span> <span class="bound">x</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ctype vars edc_snd.hyps nonneg'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_parametrized_subprob_density_cexpr_sem_integral<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens''<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t''</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">∂</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nonneg' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_int<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_snd.prems ctype vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measurable_split_conv
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_int measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ measurable_ennreal<span class="main"><span class="main">]</span></span>
               measurable_Pair_compose_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_eval_cexpr<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_neg <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> edc_neg.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> edc_neg.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> INTEG"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> edc_neg.prems edc_neg.IH<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Minus <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">σ</span> <span class="main">(</span>op_sem Minus <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dens <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> hd_neg<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">σ</span> <span class="main">(</span>op_sem Minus <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span><span class="main">)</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Minus <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span><span class="main">)</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> is_density_exprI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t_disj <span class="keyword1"><span class="command">have</span></span> t_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> is_density_exprD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_cexpr_comp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_density_exprD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf<span class="main">[</span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main">]</span> t_disj
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_comp<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_var' cet_minus_real cet_minus_int<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_addc <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">e'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> map_vars Suc <span class="main">(</span>expr_rf_to_cexpr <span class="skolem">e'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> edc_addc.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type Add <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE expr_typing_pairE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> edc_addc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> INTEG"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t3'<span class="main">:</span> <span class="quoted"><span class="quoted">"op_type Minus <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> edc_addc.prems edc_addc.IH<span class="main">[</span><span class="operator">OF</span> t1<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> t1 t2 t3 t3' edc_addc.hyps edc_addc.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_cexpr_comp cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> cet_var'<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_pair cexpr_typing_map_vars cet_var' cet_op <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_density_exprD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edc_addc.prems edc_addc.hyps
    <span class="keyword1"><span class="command">using</span></span> free_vars_expr_rf_to_cexpr is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp subset_shift_var_set<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> cet_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_addc.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> expr_typing.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Add <span class="main">$$</span> <span class="main">&lt;</span><span class="skolem">e</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">&gt;</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">σ</span> <span class="main">(</span>op_sem Add <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> expr_sem_rf <span class="bound">σ</span> <span class="main">(</span>Minus <span class="main">$$</span> <span class="skolem">e'</span><span class="main">)</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">_</span> <span class="main">⇒</span> <span class="var">?f</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> dens edc_addc.hyps
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> hd_addc<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edc_addc.hyps
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_comp cexpr_sem_map_vars o_def cexpr_sem_expr_rf_to_cexpr<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Add <span class="main">$$</span> <span class="main">&lt;</span><span class="skolem">e</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">&gt;</span> <span class="main">⇒</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="var">?expr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ctype vars
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> is_density_exprI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?expr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_disj edc_addc.hyps edc_addc.prems cet_e' free_vars_expr_rf_to_cexpr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_add_int cet_add_real cet_minus_int cet_minus_real cet_var' cexpr_typing_map_vars
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_multc <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">(</span>inverse <span class="main">(</span>abs <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> edc_multc.prems<span class="main">(</span>1<span class="main">)</span> edc_multc.hyps <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> REAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE expr_typing_pairE<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> edc_multc.prems edc_multc.IH<span class="main">[</span><span class="operator">OF</span> t1<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> REAL <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> ctype'<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t1 edc_multc.hyps edc_multc.prems is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_cexpr_comp<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_pair cexpr_typing_map_vars cet_var' cet_val' cet_op_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_op_intros cet_pair cet_val'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars'<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_multc.prems edc_multc.hyps free_vars_expr_rf_to_cexpr is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp subset_shift_var_set<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Mult <span class="main">$$</span> <span class="main">&lt;</span><span class="skolem">e</span><span class="main">,</span> Val <span class="main">(</span>RealVal <span class="skolem">c</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">σ</span> <span class="main">(</span>op_sem Mult <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> op_sem Inverse <span class="main">(</span>RealVal <span class="skolem">c</span><span class="main">)</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                       ennreal <span class="main">(</span>inverse <span class="main">(</span>abs <span class="main">(</span>extract_real <span class="main">(</span>RealVal <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">_</span> <span class="main">⇒</span> <span class="var">?f</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> dens edc_multc.hyps
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> hd_multc<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Mult <span class="main">$$</span> <span class="main">&lt;</span><span class="skolem">e</span><span class="main">,</span> Val <span class="main">(</span>RealVal <span class="skolem">c</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">⇒</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> hd_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span>
               extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">¦</span><span class="skolem">c</span><span class="main">¦</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">*</span> <span class="var">?b</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_Mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ctype' cet_val' _ vars'<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extract_real_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stock_measure.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> eval_cexpr <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>op_sem Mult <span class="main">&lt;|</span><span class="skolem">x</span><span class="main">,</span> op_sem Inverse <span class="main">(</span>RealVal <span class="skolem">c</span><span class="main">)</span><span class="main">|&gt;</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cexpr_sem_cexpr_comp eval_cexpr_def lift_RealVal_def lift_RealIntVal2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>op_sem Mult <span class="main">&lt;|</span><span class="skolem">x</span><span class="main">,</span> op_sem Inverse <span class="main">(</span>RealVal <span class="skolem">c</span><span class="main">)</span><span class="main">|&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                      ennreal <span class="main">(</span>inverse <span class="main">¦</span>extract_real <span class="main">(</span>RealVal <span class="skolem">c</span><span class="main">)</span><span class="main">¦</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_real_def ennreal_mult''<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_multc.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="var">?expr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ctype vars
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> is_density_exprI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?expr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> vars vars'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> nonneg_cexpr_Mult ctype'<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprI cet_var' cet_val' cet_op_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_add <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> PRODUCT <span class="skolem">t</span> <span class="skolem">t</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_add.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> edc_add.prems <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"op_type Add <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> expr_typing_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> INTEG <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        wf<span class="main">:</span>  <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> wf' <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒴</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">vs</span><span class="main">,</span> set <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> ennreal <span class="main">(</span>extract_real <span class="main">(</span>cexpr_sem <span class="bound">ρ</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="var">?𝒴</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="main">(</span>PRODUCT <span class="skolem">t</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_density_exprD_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?shift</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vars <span class="var">?shift</span> <span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="main">&lt;</span><span class="bound">x</span><span class="main">,</span> CVar <span class="main">1</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">x</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∫<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr'</span> <span class="main">∂</span><span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">Γ</span><span class="main">.</span> case_nat <span class="bound">t</span> <span class="main">(</span>case_nat <span class="bound">t'</span> <span class="bound">Γ</span><span class="main">)</span> <span class="main">∘</span> case_nat <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> case_nat <span class="bound">t</span> <span class="bound">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ctype''<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">&lt;</span>CVar <span class="main">0</span><span class="main">,</span> CVar <span class="main">1</span> <span class="keyword1">-<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">:</span> PRODUCT <span class="skolem">t</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cet_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cet_var'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cet_pair<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> t_disj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_var' cet_op<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ctype'<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr'</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">using</span></span> wf'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_cexpr_comp cexpr_typing_map_vars<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cet_int<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars'<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr'</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> dens_ctxt_measure <span class="var">?𝒴</span> <span class="bound">ρ</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> expr_sem <span class="bound">σ</span> <span class="main">(</span>Add <span class="main">$$</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="main">&lt;|</span><span class="bound">y</span><span class="main">,</span> op_sem Add <span class="main">&lt;|</span><span class="bound">x</span><span class="main">,</span> op_sem Minus <span class="bound">y</span><span class="main">|&gt;</span><span class="main">|&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Add <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">ρ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="main">(</span>val_type <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dens
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> hd_add<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?𝒴</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> Add <span class="main">$$</span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="var">?expr'</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_cong<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> edc_add.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α nn_integral_cong
                                             <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def cexpr_sem_cexpr_comp cexpr_sem_map_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_parametrized_subprob_density <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?M</span> <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>
                     <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="var">?expr'</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="bound">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> edc_add.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound_aux density_context_α<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dens<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dens</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> eval_cexpr <span class="var">?expr'</span> <span class="main">(</span>case_nat <span class="bound">x</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∂</span>stock_measure <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t</span><span class="main">.</span> <span class="var">?dens</span> <span class="bound">x</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AE_I2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> has_parametrized_subprob_density_integral<span class="main">[</span><span class="operator">OF</span> dens' ρ<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
           has_parametrized_subprob_densityD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dens'<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ρ
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> stock_measure <span class="skolem">t</span><span class="main">.</span> <span class="var">?dens</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_PInf_AE<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?dens</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dens</span> <span class="skolem">x</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ρ vars' ctype' ctype'' nonneg <span class="keyword1"><span class="command">unfolding</span></span> eval_cexpr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cexpr_sem_integral_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexpr_comp nonneg_cexpr_map_vars <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_top<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t'</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?expr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ctype'' nonneg
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_int nonneg_cexpr_comp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PRODUCT <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> nonneg_cexpr_map_vars<span class="main">)</span>
         <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> vars ctype edc_add.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_inv <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_inv.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> inverse<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>inverse<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span> CInt <span class="numeral">2</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> REAL <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edc_inv t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> wf' <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> wf' <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat REAL <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_op_intros cexpr_typing_cexpr_comp cet_var' cet_val'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf' <span class="keyword1"><span class="command">have</span></span> vars'<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> inverse<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> free_vars_cexpr_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_inv<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> RealVal <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> val_type_eq_REAL<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword2"><span class="keyword">and</span></span> wf' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>RealVal <span class="main">(</span>inverse <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> REAL"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_cexpr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ case_nat_in_state_measure <span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_universe_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>op_sem Inverse <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="main">(</span>inverse <span class="main">(</span>extract_real <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span>
            ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def lift_RealVal_def lift_RealIntVal2_def ennreal_mult''
                     extract_real_def cexpr_sem_cexpr_comp <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> REAL_E<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat REAL <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>inverse<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>c</sub></span> CInt <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_state_measure_shift_iff val_type_eq_REAL lift_RealVal_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?expr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexpr_Mult nonneg_cexpr_comp vars'<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_op_intros cexpr_typing_cexpr_comp cet_var' cet_val'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_inv.prems ctype vars dens<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>edc_exp <span class="skolem">vs</span> <span class="skolem">vs'</span> <span class="skolem">Γ</span> <span class="skolem">δ</span> <span class="skolem">e</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> expr_typing_opE<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pdf_type.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> invar <span class="main">=</span> cdens_ctxt_invarD<span class="main">[</span><span class="operator">OF</span> edc_exp.prems<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">0</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">x</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> ln<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>c</sub></span> inverse<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span> <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="skolem">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="skolem">vs</span><span class="main">,</span> <span class="skolem">vs'</span><span class="main">,</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> REAL <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edc_exp t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> wf' <span class="main">=</span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> wf' <span class="keyword1"><span class="command">have</span></span> ctype<span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat REAL <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?expr</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cet_if cet_op_intros cet_var' cet_val' cexpr_typing_cexpr_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="keyword1">λ<span class="hidden">⇩</span><sub>c</sub></span><span class="bound">x</span><span class="main">.</span> ln<span class="hidden">⇩</span><sub>c</sub> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> free_vars_cexpr_comp<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="var">?expr</span> <span class="main">⊆</span> shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> free_vars_cexpr_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI is_density_exprI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def prod.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> hd_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_exp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>stock_measure REAL<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> RealVal <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> val_type_eq_REAL<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ρ <span class="keyword2"><span class="keyword">and</span></span> wf' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>RealVal <span class="main">(</span>ln <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> REAL"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_cexpr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ case_nat_in_state_measure <span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_universe_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> type_universe_type<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> extract_real <span class="skolem">x</span> <span class="keyword1">then</span> ennreal <span class="main">(</span>eval_cexpr <span class="skolem">f</span> <span class="skolem">ρ</span> <span class="main">(</span>lift_RealVal safe_ln <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
              ennreal <span class="main">(</span>inverse <span class="main">(</span>extract_real <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>eval_cexpr <span class="var">?expr</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_cexpr_def lift_RealVal_def lift_RealIntVal2_def lift_Comp_def ennreal_mult''
                     extract_real_def cexpr_sem_cexpr_comp <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> REAL_E<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonneg_cexpr <span class="main">(</span>shift_var_set <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_nat <span class="skolem">t</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="var">?expr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_cexprI_shift<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">σ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> type_universe <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> space <span class="main">(</span>state_measure <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> RealVal <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> val_type_eq_REAL<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> σ nonneg_cexprD<span class="main">[</span><span class="operator">OF</span> is_density_exprD_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"case_nat <span class="main">(</span>RealVal <span class="main">(</span>ln <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_type <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="main">(</span>RealVal <span class="main">(</span>ln <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> REAL"</span></span>
        <span class="keyword1"><span class="command">using</span></span> σ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> val_type_cexpr_sem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf'<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> case_nat_in_state_measure<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> extract_real
                 <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">x</span> <span class="skolem">σ</span><span class="main">)</span>
                   <span class="main">(</span><span class="keyword1">IF<span class="hidden">⇩</span><sub>c</sub></span> CReal <span class="main">0</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> ln<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>CVar <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>c</sub></span> CVar <span class="main">0</span> <span class="keyword1">ELSE</span> CReal <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_Comp_def lift_RealVal_eq cexpr_sem_cexpr_comp val_type_eq_REAL
                       case_nat_in_state_measure lift_RealIntVal2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> edc_exp.prems ctype vars dens<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> density_context_α <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="PDF_Compiler-expr_has_density_cexpr_sound"><span class="command">lemma</span></span> expr_has_density_cexpr_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>type_universe <span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> REAL"</span></span>
        <span class="quoted"><span class="quoted">"free_vars <span class="free">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          is_density_expr <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_cexpr_sound_aux assms cdens_ctxt_invarI nonneg_cexprI subprob_cexprI<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_measure_def PiM_empty cexpr_type_Some_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> extract_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dens<span class="main">:</span> <span class="quoted"><span class="quoted">"dens_ctxt_α <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>d</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="bound">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_density_expr <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_subprob_density <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> dens assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_has_density_sound<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dens_ctxt_α_def extract_real_def one_ennreal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_sem_eq_on_vars<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> has_subprob_density <span class="main">(</span>expr_sem <span class="free">σ</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_subprob_density_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_cexpr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> is_density_exprD<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> vars<span class="main">:</span> <span class="quoted"><span class="quoted">"free_vars <span class="free">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_var_set_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>type_universe <span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="bound">x</span> <span class="free">σ</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> type_universe <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">v</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonneg_cexprD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> is_density_exprD_nonneg<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> case_nat_in_state_measure<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_state_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cexpr_sem <span class="main">(</span>case_nat <span class="skolem">v</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> cexpr_sem <span class="main">(</span>case_nat <span class="skolem">v</span> <span class="free">σ</span><span class="main">)</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹free_vars <span class="free">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_sem_eq_on_vars<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> extract_real <span class="main">(</span>cexpr_sem <span class="main">(</span>case_nat <span class="skolem">v</span> <span class="free">σ</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> REAL"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cexpr_typing_cong'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_density_exprD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> vars<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">expr_compiles_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> pdf_type <span class="main">⇒</span> cexpr <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">:</span> _ <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> _"</span> <span class="main">[</span>10<span class="main">,</span>0<span class="main">,</span>10<span class="main">]</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">e</span> <span class="entity">t</span> <span class="entity">f</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIT<span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="main">⟹</span> free_vars <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIT<span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f</span> <span class="main">⟹</span>
      <span class="free">e</span> <span class="main"><span class="free">:</span></span> <span class="free">t</span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free">f</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">expr_compiles_to</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="PDF_Compiler-expr_compiles_to_sound"><span class="command">lemma</span></span> expr_compiles_to_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">:</span> <span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"expr_sem <span class="free">σ</span> <span class="free">e</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="free">σ'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>type_universe <span class="free">t</span><span class="main">.</span> eval_cexpr <span class="free">f</span> <span class="free">σ'</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> REAL"</span></span>
         <span class="quoted"><span class="quoted">"free_vars <span class="free">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIT"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="var">?Γ</span><span class="main">,</span> CReal <span class="main">1</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"free_vars <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_compiles_to.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="free">σ</span> <span class="free">e</span> <span class="main">=</span> expr_sem <span class="free">σ'</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> expr_sem_eq_on_vars<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> expr_has_density_cexpr_sound<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"expr_sem <span class="free">σ</span> <span class="free">e</span> <span class="main">=</span> density <span class="main">(</span>stock_measure <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>eval_cexpr <span class="free">f</span> <span class="free">σ'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>type_universe <span class="free">t</span><span class="main">.</span> eval_cexpr <span class="free">f</span> <span class="free">σ'</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="main">:</span> REAL"</span></span>
         <span class="quoted"><span class="quoted">"free_vars <span class="free">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> has_subprob_density_def has_density_def eval_cexpr_def
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nonneg_cexprD case_nat_in_state_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIT<span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr_compiles_to.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> expr_typing_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> expr_compiles_to.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tests›</span></span>

<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> Val <span class="main">(</span>IntVal <span class="numeral">42</span><span class="main">)</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> Minus <span class="main">$$</span> <span class="main">(</span>Val <span class="main">(</span>IntVal <span class="numeral">42</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> Fst <span class="main">$$</span> <span class="main">(</span>Val <span class="main">&lt;|</span>IntVal <span class="numeral">13</span><span class="main">,</span> IntVal <span class="numeral">37</span><span class="main">|&gt;</span><span class="main">)</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> Random Bernoulli <span class="main">(</span>Val <span class="main">(</span>RealVal <span class="numeral">0.5</span><span class="main">)</span><span class="main">)</span>  <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> Add <span class="main">$$</span> <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="numeral">37</span><span class="main">)</span><span class="main">,</span> Minus <span class="main">$$</span> <span class="main">(</span>Val <span class="main">(</span>IntVal <span class="numeral">13</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">LET</span> Val <span class="main">(</span>IntVal <span class="numeral">13</span><span class="main">)</span> <span class="keyword1">IN</span> <span class="keyword1">LET</span> Minus <span class="main">$$</span> <span class="main">(</span>Val <span class="main">(</span>IntVal <span class="numeral">37</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">IN</span>
                          Add <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">0</span><span class="main">,</span> Var <span class="main">1</span><span class="main">&gt;</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">IF</span> Random Bernoulli <span class="main">(</span>Val <span class="main">(</span>RealVal <span class="numeral">0.5</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span>
                        Random Bernoulli <span class="main">(</span>Val <span class="main">(</span>RealVal <span class="numeral">0.25</span><span class="main">)</span><span class="main">)</span>
                      <span class="keyword1">ELSE</span>
                        Random Bernoulli <span class="main">(</span>Val <span class="main">(</span>RealVal <span class="numeral">0.75</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">LET</span> Random Bernoulli <span class="main">(</span>Val <span class="main">(</span>RealVal <span class="numeral">0.5</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">IN</span>
                        <span class="keyword1">IF</span> Var <span class="main">0</span> <span class="keyword1">THEN</span>
                          Random Bernoulli <span class="main">(</span>Val <span class="main">(</span>RealVal <span class="numeral">0.25</span><span class="main">)</span><span class="main">)</span>
                        <span class="keyword1">ELSE</span>
                          Random Bernoulli <span class="main">(</span>Val <span class="main">(</span>RealVal <span class="numeral">0.75</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">LET</span> Random Gaussian <span class="main">&lt;</span>Val <span class="main">(</span>RealVal <span class="main">0</span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>RealVal <span class="main">1</span><span class="main">)</span><span class="main">&gt;</span> <span class="keyword1">IN</span>
                        <span class="keyword1">LET</span> Random Gaussian <span class="main">&lt;</span>Val <span class="main">(</span>RealVal <span class="main">0</span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>RealVal <span class="main">1</span><span class="main">)</span><span class="main">&gt;</span> <span class="keyword1">IN</span>
                          Add <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">0</span><span class="main">,</span> Var <span class="main">1</span><span class="main">&gt;</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">LET</span> Random UniformInt <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="main">1</span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">6</span><span class="main">)</span><span class="main">&gt;</span> <span class="keyword1">IN</span>
                        <span class="keyword1">LET</span> Random UniformInt <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="main">1</span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">6</span><span class="main">)</span><span class="main">&gt;</span> <span class="keyword1">IN</span>
                          Add <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">0</span><span class="main">,</span> Var <span class="main">1</span><span class="main">&gt;</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>


<span class="comment1">(* Example from the paper by Bhat et.al. *)</span>

<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">LET</span> Random UniformReal <span class="main">&lt;</span>Val <span class="main">(</span>RealVal <span class="main">0</span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>RealVal <span class="main">1</span><span class="main">)</span><span class="main">&gt;</span> <span class="keyword1">IN</span>
                        <span class="keyword1">LET</span> Random Bernoulli <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span> <span class="keyword1">IN</span>
                          <span class="keyword1">IF</span> Var <span class="main">0</span> <span class="keyword1">THEN</span> Add <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">1</span><span class="main">,</span> Val <span class="main">(</span>RealVal <span class="main">1</span><span class="main">)</span><span class="main">&gt;</span> <span class="keyword1">ELSE</span> Var <span class="main">1</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="comment1">(* Simplification of constant expression yields:
  ∫b. (IF 0 ≤ x - 1 ∧ x - 1 ≤ 1 THEN 1 ELSE 0) *
      (IF 0 ≤ x - 1 ∧ x - 1 ≤ 1 THEN IF b THEN x - 1 ELSE 1 - (x - 1) ELSE 0) * ⟨b⟩ +
  ∫b. (IF 0 ≤ x ∧ x ≤ 1 THEN 1 ELSE 0) *
      (IF 0 ≤ x ∧ x ≤ 1 THEN IF b THEN x ELSE 1 - x ELSE 0) * ⟨¬b⟩
*)</span>

<span class="comment1">(* Further simplification yields:
   (∫b. ⟨0 ≤ x-1 ≤ 1⟩ * (IF b THEN x-1 ELSE 2-x) * ⟨b⟩) +
   (∫b. ⟨0 ≤ x ≤ 1⟩ * (IF b THEN x ELSE 1-x) * ⟨¬b⟩)
*)</span>

<span class="comment1">(* Further simplification yields:
  ⟨1 ≤ x ≤ 2⟩*(x-1) + ⟨0 ≤ x ≤ 1⟩*(1-x)
*)</span>

<span class="comment1">(* Mathematica input:
   Piecewise[{{x-1, 1 &lt;= x &amp;&amp; x &lt;= 2}, {1-x, 0 &lt;= x &amp;&amp; x &lt;= 1}}]
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cthulhu</span> <span class="free"><span class="bound"><span class="entity">skill</span></span></span> <span class="main">≡</span>
  <span class="keyword1">LET</span> Random UniformInt <span class="main">(</span>Val <span class="main">&lt;|</span>IntVal <span class="main">1</span><span class="main">,</span> IntVal <span class="numeral">100</span><span class="main">|&gt;</span><span class="main">)</span>
   <span class="keyword1">IN</span> <span class="keyword1">IF</span> Less <span class="main">$$</span> <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">,</span> Var <span class="main">0</span><span class="main">&gt;</span> <span class="keyword1">THEN</span>
        Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span>
      <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> Or <span class="main">$$</span> <span class="main">&lt;</span>Less <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">0</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">6</span><span class="main">)</span><span class="main">&gt;</span><span class="main">,</span>
                     Less <span class="main">$$</span> <span class="main">&lt;</span>Mult <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">0</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">5</span><span class="main">)</span><span class="main">&gt;</span><span class="main">,</span>
                                  Add <span class="main">$$</span> <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="main">1</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">&gt;</span> <span class="main">&gt;</span> <span class="keyword1">THEN</span>
        Add <span class="main">$$</span> <span class="main">&lt;</span><span class="keyword1">IF</span> Less <span class="main">$$</span> <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">,</span>
                            Random UniformInt <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="main">1</span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">100</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">&gt;</span> <span class="keyword1">THEN</span>
                  Random UniformInt <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="main">1</span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">10</span><span class="main">)</span><span class="main">&gt;</span>
                <span class="keyword1">ELSE</span>
                  Val <span class="main">(</span>IntVal <span class="main">0</span><span class="main">)</span><span class="main">,</span>
          Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">&gt;</span>
      <span class="keyword1">ELSE</span> Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cthulhu'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">skill</span></span></span> <span class="main">::</span> int<span class="main">)</span> <span class="main">=</span>
<span class="keyword1">LET</span> Random UniformInt <span class="main">(</span>Val <span class="main">&lt;|</span>IntVal <span class="main">1</span><span class="main">,</span> IntVal <span class="numeral">100</span><span class="main">|&gt;</span><span class="main">)</span>
   <span class="keyword1">IN</span> <span class="keyword1">IF</span> Less <span class="main">$$</span> <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">,</span> Var <span class="main">0</span><span class="main">&gt;</span> <span class="keyword1">THEN</span>
        Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span>
      <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> Or <span class="main">$$</span> <span class="main">&lt;</span>Less <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">0</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">6</span><span class="main">)</span><span class="main">&gt;</span><span class="main">,</span>
                     Less <span class="main">$$</span> <span class="main">&lt;</span>Mult <span class="main">$$</span> <span class="main">&lt;</span>Var <span class="main">0</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="numeral">5</span><span class="main">)</span><span class="main">&gt;</span><span class="main">,</span>
                                  Add <span class="main">$$</span> <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">,</span> Val <span class="main">(</span>IntVal <span class="main">1</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">&gt;</span> <span class="main">&gt;</span> <span class="keyword1">THEN</span>
        <span class="keyword1">LET</span> Random UniformInt <span class="main">(</span>Val <span class="main">&lt;|</span>IntVal <span class="main">1</span><span class="main">,</span> IntVal <span class="numeral">100</span><span class="main">|&gt;</span><span class="main">)</span>
        <span class="keyword1">IN</span>  Add <span class="main">$$</span> <span class="main">&lt;</span><span class="keyword1">IF</span> Less <span class="main">$$</span> <span class="main">&lt;</span>Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">,</span> Var <span class="main">1</span> <span class="main">&gt;</span> <span class="keyword1">THEN</span>
                      Random UniformInt <span class="main">(</span>Val <span class="main">&lt;|</span>IntVal <span class="main">1</span><span class="main">,</span> IntVal <span class="numeral">10</span><span class="main">|&gt;</span><span class="main">)</span>
                    <span class="keyword1">ELSE</span>
                      Val <span class="main">(</span>IntVal <span class="main">0</span><span class="main">)</span><span class="main">,</span>
              Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span><span class="main">&gt;</span>
      <span class="keyword1">ELSE</span> Val <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">skill</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> cthulhu' <span class="numeral">42</span> <span class="main">:</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>