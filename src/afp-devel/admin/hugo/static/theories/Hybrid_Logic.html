<div id="Hybrid_Logic">
<div class="head">
<h1>Theory Hybrid_Logic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Hybrid_Logic <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Countable.html">HOL-Library.Countable</a>"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm
  <span class="main">=</span> Pro <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="main">|</span> Nom <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="main">|</span> Neg <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="main">(</span><span class="quoted">‹<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>¬</b></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _›</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span>
  <span class="main">|</span> Dis <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>∨</b></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>›</span> 30<span class="main">)</span>
  <span class="main">|</span> Dia <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="main">(</span><span class="quoted">‹<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>◇</b></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _›</span> 10<span class="main">)</span>
  <span class="main">|</span> Sat <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="main">(</span><span class="quoted">‹<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>@</b></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _ _›</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can give other connectives as abbreviations.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Top</span> <span class="main">(</span><span class="quoted">‹<span class="keyword1"><span class="hidden">❙</span><b>⊤</b></span>›</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="main"><span class="free"><span class="hidden">❙</span><b>⊤</b></span></span> <span class="main">≡</span> <span class="main">(</span>undefined <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> undefined<span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Con</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">‹<span class="keyword1"><span class="hidden">❙</span><b>∧</b></span>›</span> 35<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∧</b></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Imp</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">‹<span class="keyword1"><span class="hidden">❙</span><b>⟶</b></span>›</span> 25<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⟶</b></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Box</span> <span class="main">(</span><span class="quoted">‹<span class="keyword1"><span class="hidden">❙</span><b>□</b></span> _›</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="main"><span class="free"><span class="hidden">❙</span><b>□</b></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nominals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">nominals</span> <span class="main">(</span>Pro <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">nominals</span> <span class="main">(</span>Nom <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">nominals</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nominals</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">nominals</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nominals</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free">nominals</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">nominals</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nominals</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">nominals</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">nominals</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> fm›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">sub</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Pro <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Pro <span class="free"><span class="bound"><span class="entity">x</span></span></span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Nom <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> Nom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sub_nominals<span class="main">:</span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span>sub <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> nominals <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub id <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_upd_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> nominals <span class="free">p</span> <span class="main">⟹</span> sub <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> sub <span class="free">f</span> <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Type variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'w›</span></span></span></span> stands for the set of worlds and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a›</span></span></span></span> for the set of propositional symbols.
  The accessibility relation is given by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>R›</span></span></span></span> and the valuation by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>.
  The mapping from nominals to worlds is an extra argument <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> to the semantics.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> model <span class="main">=</span>
  Model <span class="main">(</span><span class="free"><span class="entity">R</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'w</span> set›</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">V</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool›</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">semantics</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> model <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'w</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'w</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> bool›</span></span>
  <span class="main">(</span><span class="quoted">‹_<span class="keyword1">,</span> _<span class="keyword1">,</span> _ <span class="keyword1">⊨</span> _›</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> Pro <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> V <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> Nom <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="bound">v</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>⊤</b></span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> semantics_fresh<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> nominals <span class="free">p</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">p</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">is_named</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> model <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">is_named</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> V <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">w</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">reflexive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> model <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">reflexive</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">w</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">irreflexive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> model <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">irreflexive</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∉</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">w</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">symmetric</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> model <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">symmetric</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">v</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">w</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">asymmetric</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> model <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">asymmetric</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">w</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">w</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">transitive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> model <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">transitive</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">v</span> <span class="bound">w</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">v</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">universal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> model <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">universal</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> R <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">w</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‹irreflexive <span class="free">M</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹irreflexive <span class="free">M</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="free">i</span> <span class="main">∉</span> R <span class="free">M</span> <span class="main">(</span><span class="free">g</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">g</span> <span class="free">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">g</span> <span class="free">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can automatically show some characterizations of frames by pure axioms.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‹irreflexive <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="bound">w</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‹asymmetric <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="bound">w</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>□</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‹universal <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="bound">w</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tableau›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A block is defined as a list of formulas paired with an opening nominal.
  The opening nominal is not necessarily in the list.
  A branch is a list of blocks.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list <span class="main">×</span> <span class="tfree">'b</span>›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block list›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">member_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">∈.</span> _›</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">∈.</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>on›</span></span></span></span> presents the opening nominal as appearing on the block.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">on</span> _›</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈.</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Nom <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_Ballon"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="quoted">‹<span class="keyword3">(3</span><span class="keyword1">∀</span><span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">on</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>›</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_Bexon"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="quoted">‹<span class="keyword3">(3</span><span class="keyword1">∃</span><span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">on</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>›</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">∀</span><span class="free">p</span> <span class="keyword1">on</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∀</span><span class="free">p</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">on</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">P</span>"</span>
  <span class="quoted">"<span class="main">∃</span><span class="free">p</span> <span class="keyword1">on</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∃</span><span class="free">p</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">on</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">P</span>"</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">list_nominals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list <span class="main">⇒</span> <span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">list_nominals</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> nominals <span class="bound">p</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">block_nominals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> <span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">block_nominals</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span> <span class="main">∪</span> list_nominals <span class="free"><span class="bound"><span class="entity">ps</span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">branch_nominals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">branch_nominals</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">block</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">.</span> block_nominals <span class="bound">block</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">at_in_branch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">at_in_branch</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∈.</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">notation</span></span> at_in_branch <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">at</span> _ <span class="keyword1">in</span> _›</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">new</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">new</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">witnessed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">witnessed</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A branch has a closing tableau iff it is contained in the following inductively defined set.
  In that case I call the branch closeable.
  The first argument on the left of the turnstile, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>, is a fixed set of nominals restricting Nom.
  This set rules out the copying of nominals and accessibility formulas introduced by DiaP.
  The second argument is "potential", used to restrict the GoTo rule.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">STA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="quoted">‹_<span class="keyword1">,</span> _ <span class="keyword1">⊢</span> _›</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    Close<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> Neg<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     new <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> DisP<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     new <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span> new <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span> <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> DisN<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">∨</span> new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> DiaP<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Nom <span class="bound">a</span> <span class="main">⟹</span> <span class="main">¬</span> witnessed <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> DiaN<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> SatP<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     new <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> SatN<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> GoTo<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> branch_nominals <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>
  <span class="main">|</span> Nom<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span> Nom <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Nom <span class="bound">i</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span>
     new <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
     <span class="free">A</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">STA_ex_potential</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> bool›</span></span> <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">⊢</span> _›</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="bound">n</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> STA.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> STA.intros<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A verified derivation in the calculus.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≡</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="main">(</span>Nom <span class="free">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> branch_nominals <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span>  <span class="free">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="free">i</span><span class="main">)</span> <span class="free">i</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="main">(</span>Nom <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="free">i</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> that SatN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Close list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Soundness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>-block is satisfied by a model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> and assignment <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> if all formulas on the block
    are true under <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> at the world <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g i›</span></span></span></span>
  A branch is satisfied by a model and assignment if all blocks on it are.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">block_sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> model <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'w</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> bool›</span></span>
  <span class="main">(</span><span class="quoted">‹_<span class="keyword1">,</span> _ <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> _›</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>B</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⊨</span> <span class="bound">p</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">branch_sat</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'w</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> model <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'w</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> bool›</span></span>
  <span class="main">(</span><span class="quoted">‹_<span class="keyword1">,</span> _ <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> _›</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>Θ</sub></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">branch</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> block_nominals<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="free">block</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> nominals <span class="free">p</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> block_nominals <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> block_sat_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">block</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> block_nominals <span class="free">block</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">ps</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">.</span> <span class="free">i</span> <span class="main">∉</span> nominals <span class="bound">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> block_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="bound">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pair semantics_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> block_sat.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> branch_sat_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">using</span></span> block_sat_fresh <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a branch has a derivation then it cannot be satisfied.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> soundness'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="free">branch</span> <span class="main">⟹</span> False›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> STA.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Close <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisP <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="skolem">q</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>1<span class="main">,</span> 8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>5<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisN <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaP <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> nominals <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> R <span class="free">M</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">a</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> nominals <span class="skolem">p</span>›</span></span> semantics_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> R <span class="free">M</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">a</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">,</span> 7<span class="main">)</span> branch_sat_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="bound">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> * semantics_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaN <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>1-2<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatP <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatN <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GoTo <span class="skolem">i</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">a</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">b</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">b</span> <span class="main">⊨</span> Nom <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1-2<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> block_sat<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="keyword1">on</span> <span class="free">block</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> branch_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">branch</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">p</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>Θ</sub></span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms block_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">block</span> <span class="main">∈</span> set <span class="free">branch</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">p</span></span> <span class="keyword1">on</span> <span class="bound">block</span><span class="main">.</span> <span class="main">¬</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">p</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms soundness' branch_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">[]</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> soundness <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">theorem</span></span> soundness_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> nominals <span class="free">p</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">g</span> <span class="free">i</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">g</span>
    <span class="keyword1"><span class="command">using</span></span> soundness <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">w</span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">g</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> semantics_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹No Detours›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We only need to spend initial potential when we apply GoTo twice in a row.
  Otherwise another rule will have been applied in-between that justifies the GoTo.
  Therefore, by filtering out detours we can close any closeable branch starting from
    a single unit of potential.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nonempty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">nonempty</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="free">left</span> <span class="main">@</span> <span class="free">right</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="free">left</span> <span class="main">@</span> <span class="free">right</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">≠</span> Nom <span class="free">a</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">left</span><span class="main">)</span> <span class="main">@</span> <span class="free">right</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>filter nonempty <span class="free">left</span> <span class="main">@</span> <span class="free">right</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Nil GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">left</span> <span class="main">@</span> <span class="free">right</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="free">left</span> <span class="main">@</span> <span class="free">right</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">‹<span class="free">left</span> <span class="main">@</span> <span class="free">right</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">left</span></span> <span class="quoted"><span class="free">right</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> STA.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Close <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in</span> filter nonempty <span class="skolem">left</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in</span> filter nonempty <span class="skolem">left</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>1-2<span class="main">)</span> STA.Neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil Neg<span class="main">(</span>5<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">left'</span>›</span></span><span class="main">]</span> Neg<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons Neg<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons Neg<span class="main">(</span>2<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> STA.Neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * nonempty_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons Neg<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisP <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>5<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>1-3<span class="main">)</span> STA.DisP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil DisP<span class="main">(</span>8<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>5<span class="main">,</span> 7<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">left'</span></span>›</span></span></span><span class="main">]</span> DisP<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DisP<span class="main">(</span>1<span class="main">,</span> 8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹new <span class="skolem">q</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DisP<span class="main">(</span>2-3<span class="main">,</span> 8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> STA.DisP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * nonempty_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DisP<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisN <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>1-2<span class="main">)</span> STA.DisN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil DisN<span class="main">(</span>5<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">left'</span>›</span></span><span class="main">]</span> DisN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DisN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DisN<span class="main">(</span>2<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> STA.DisN <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * nonempty_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DisN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaP <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1-4<span class="main">)</span> STA.DiaP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil DiaP<span class="main">(</span>7<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">left'</span>›</span></span><span class="main">]</span> DiaP<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaP<span class="main">(</span>1<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaP<span class="main">(</span>2<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> witnessed <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaP<span class="main">(</span>4<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> witnessed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>3<span class="main">)</span> STA.DiaP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * nonempty_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaP<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaN <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>1-3<span class="main">)</span> STA.DiaN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil DiaN<span class="main">(</span>6<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">left'</span>›</span></span><span class="main">]</span> DiaN<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaN<span class="main">(</span>1<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaN<span class="main">(</span>2<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaN<span class="main">(</span>3<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> STA.DiaN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * nonempty_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons DiaN<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatP <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>1-2<span class="main">)</span> STA.SatP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil SatP<span class="main">(</span>5<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">left'</span>›</span></span><span class="main">]</span> SatP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons SatP<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons SatP<span class="main">(</span>2<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> STA.SatP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * Nil GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Cons
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons SatP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatN <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>1-2<span class="main">)</span> STA.SatN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil SatN<span class="main">(</span>5<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">left'</span>›</span></span><span class="main">]</span> SatN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons SatN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons SatN<span class="main">(</span>2<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> STA.SatN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * Nil GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Cons
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons SatN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GoTo <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">a</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">left</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1-4<span class="main">)</span> STA.Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil Nom<span class="main">(</span>7<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">left'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">left'</span>›</span></span><span class="main">]</span> Nom<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons Nom<span class="main">(</span>1-2<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="main">(</span><span class="operator">metis</span> empty_iff empty_set<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons Nom<span class="main">(</span>4<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>3<span class="main">)</span> STA.Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> filter nonempty <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">left'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">right</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>filter nonempty <span class="skolem">left'</span> <span class="main">@</span> <span class="skolem">right</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * Nil GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Cons
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons Nom<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> STA_potential<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">,</span> Suc <span class="free">m</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> STA_nonempty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> left<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> STA_one<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">,</span> <span class="main">1</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> STA_potential <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Free GoTo›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The above result allows us to prove a version of GoTo that works "for free."›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> GoTo'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> branch_nominals <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms GoTo STA_potential <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Indexed Mapping›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section contains some machinery for showing admissible rules.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Indexing›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We use pairs of natural numbers to index into the branch.
  The first component specifies the block and the second specifies the formula on that block.
  We index from the back to ensure that indices are stable
    under the addition of new formulas and blocks.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rev_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> option›</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">‹<span class="keyword1">!.</span>›</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main"><span class="free">!.</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> None›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main"><span class="free">!.</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">!.</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_last<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">!.</span> <span class="main">0</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> last <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_zero<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!.</span> <span class="main">0</span> <span class="main">=</span> Some <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!.</span> Suc <span class="free">v</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">y</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!.</span> Suc <span class="free">v</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="bound">x</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">y</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="free">y</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rev_nth_snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="free">y</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_append<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">y</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev_nth_Cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">@</span> <span class="free">xs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_mem<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">block</span> <span class="main">∈.</span> <span class="free">branch</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">branch</span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="free">block</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="free">block</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">branch</span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">block'</span> <span class="skolem">branch</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">block</span> <span class="main">=</span> <span class="skolem">block'</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">branch</span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="free">block</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> rev_nth_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">branch</span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">block</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">block'</span> <span class="skolem">branch</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_on<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">ps</span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth_mem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_Some<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">&lt;</span> length <span class="free">xs</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> rev_nth_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> index_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">qs</span> <span class="main">!.</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">q</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">qs'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">qs'</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">qs'</span> <span class="main">!.</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">q</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">qs</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">qs</span> <span class="main">!.</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">qs</span><span class="main">)</span> <span class="main">!.</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">q</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> rev_nth_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mapping›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mapi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">mapi</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">mapi</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">mapi</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mapi_block</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">mapi_block</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mapi <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapi_branch</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">mapi_branch</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> mapi <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> mapi_block <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mapper</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm<span class="main">)</span> <span class="main">⇒</span>
   <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">mapper</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_block_add_oob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">ps</span> <span class="main">≤</span> <span class="free">v'</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‹mapi_block <span class="main">(</span>mapper <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">xs</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
     mapi_block <span class="main">(</span>mapper <span class="free">f</span> <span class="free">xs</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_branch_add_oob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">branch</span> <span class="main">≤</span> <span class="free">v</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‹mapi_branch <span class="main">(</span>mapper <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">branch</span> <span class="main">=</span>
     mapi_branch <span class="main">(</span>mapper <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_branch_head_add_oob<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹mapi_branch <span class="main">(</span>mapper <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> length <span class="free">ps</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span>
   mapi_branch <span class="main">(</span>mapper <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> mapi_branch_add_oob<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">branch</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def
  <span class="keyword1"><span class="command">using</span></span> mapi_block_add_oob<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_branch_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>mapi <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_mapi_branch<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> mapi_block.simps option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_nth_mapi_block<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps</span> <span class="main">!.</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">v'</span> <span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="free">f</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> option.sel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹mapi <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mapi <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">v</span> <span class="main">+</span> length <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> mapi <span class="free">f</span> <span class="free">ys</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_block_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹mapi_block <span class="main">(</span>mapper <span class="free">f</span> <span class="main">{}</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_branch_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹mapi_branch <span class="main">(</span>mapper <span class="free">f</span> <span class="main">{}</span><span class="main">)</span> <span class="free">branch</span> <span class="main">=</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> mapi_block_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_mapi<span class="main">:</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>mapi <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mapi_rev_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">x</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹mapi <span class="free">f</span> <span class="free">xs</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">f</span> <span class="free">v</span> <span class="free">x</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹mapi <span class="free">f</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">#</span> mapi <span class="free">f</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> length <span class="skolem">xs</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹mapi <span class="free">f</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">f</span> <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_mapi * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_nth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * Cons length_mapi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_nth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Duplicate Formulas›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Removable indices›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">‹<span class="free">proj</span> <span class="main">≡</span> Equiv_Relations.proj›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list <span class="main">⇒</span> nat set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">all_is</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">p</span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">is_at</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ps</span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">p</span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This definition is slightly complicated by the inability to index the opening nominal.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_elsewhere</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">is_elsewhere</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">w</span> <span class="bound">w'</span> <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">w'</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Nom <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∨</span> <span class="bound">ps</span> <span class="main">!.</span> <span class="bound">w'</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Dup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">Dup</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span>
    is_at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="bound">v</span> <span class="bound">v'</span> <span class="main">∧</span> is_elsewhere <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_all_is<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹all_is <span class="free">p</span> <span class="free">ps</span> <span class="main">(</span>proj <span class="free">xs</span> <span class="free">v</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_at_def all_is_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_branch<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span> <span class="main">⟹</span> Dup <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="free">extra</span> <span class="main">@</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_at_def is_elsewhere_def <span class="keyword1"><span class="command">using</span></span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_block<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Dup_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">v'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹is_at <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">v'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms rev_nth_append <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">v'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span> <span class="main">∨</span> <span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_elsewhere_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">qs</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">qs</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span> <span class="main">∨</span> <span class="bound">qs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="free">p</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹is_elsewhere <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_elsewhere_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">only_touches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">only_touches</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">ps</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="bound">a</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_touches<span class="main">:</span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span> <span class="main">⟹</span> only_touches <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_at_def only_touches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> only_touches_opening<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹only_touches <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="free">a</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> only_touches_def is_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_head<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟹</span> Dup <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> Dup_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_head_oob'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> <span class="free">k</span> <span class="main">+</span> length <span class="free">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms rev_nth_Some <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_head_oob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> length <span class="free">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Dup_head_oob'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Omitting formulas›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">omit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹nat set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">omit</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">omit</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free">omit</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free">omit</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">omit_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹nat set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">omit_block</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>omit <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">omit_branch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">omit_branch</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">≡</span> mapi <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> omit_block <span class="main">(</span>proj <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omit_mem<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">ps</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈.</span> omit <span class="free">xs</span> <span class="free">ps</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">q</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">=</span> length <span class="skolem">ps</span>›</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹omit <span class="main">{}</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_block_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹omit_block <span class="main">{}</span> <span class="free">block</span> <span class="main">=</span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> omit_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_branch_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹omit_branch <span class="main">{}</span> <span class="free">branch</span> <span class="main">=</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">using</span></span> omit_block_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omit_branch_mem_diff_opening<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹only_touches <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">a</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="free">xs</span> <span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapi_rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹proj <span class="free">xs</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> v only_touches_opening <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ps</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_omit_branch_mem_same_opening<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="free">xs</span> <span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapi_rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">consider</span></span>
    <span class="skolem">v'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span> <span class="main">|</span>
    <span class="skolem">v'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps v rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">v'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span> <span class="main">∨</span> <span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_elsewhere_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="free">xs</span> <span class="free">branch</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapi_rev_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> omit_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * omit_mem <span class="keyword1"><span class="command">unfolding</span></span> proj_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_singleton_iff on.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omit_del<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈.</span> <span class="free">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∉</span> set <span class="main">(</span>omit <span class="free">xs</span> <span class="free">ps</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">ps</span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms omit_mem rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_all_is<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹all_is <span class="free">p</span> <span class="free">ps</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">∈.</span> <span class="free">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">∉</span> set <span class="main">(</span>omit <span class="free">xs</span> <span class="free">ps</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms omit_del <span class="keyword1"><span class="command">unfolding</span></span> all_is_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_is_branch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">all_is_branch</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="bound">v</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟶</span> is_at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="bound">v</span> <span class="bound">v'</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_is_branch<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹all_is_branch <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">branch</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> all_is <span class="free">p</span> <span class="free">ps</span> <span class="main">(</span>proj <span class="free">xs</span> <span class="free">v</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_is_branch_def is_at_def all_is_def proj_def <span class="keyword1"><span class="command">using</span></span> rev_nth_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_all_is_branch<span class="main">:</span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span> <span class="main">⟹</span> all_is_branch <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_is_branch_def Dup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_branch_mem_diff_formula<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹all_is_branch <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="free">xs</span> <span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapi_rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹all_is <span class="free">p</span> <span class="skolem">ps</span> <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> v all_is_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="keyword1">on</span> <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps assms<span class="main">(</span>3<span class="main">)</span> omit_all_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_omit_branch_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms omit_branch_mem_diff_opening Dup_touches Dup_omit_branch_mem_same_opening
    omit_branch_mem_diff_formula Dup_all_is_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_set<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span>omit <span class="free">xs</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> on_omit<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span>omit <span class="free">xs</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> omit_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> all_is_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹all_is <span class="free">p</span> <span class="free">ps</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>omit <span class="free">xs</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms omit_all_is omit_set <span class="keyword1"><span class="command">unfolding</span></span> all_is_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> all_is_list_nominals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹all_is <span class="free">p</span> <span class="free">ps</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> list_nominals <span class="main">(</span>omit <span class="free">xs</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> nominals <span class="free">p</span> <span class="main">∪</span> list_nominals <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms all_is_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> all_is_block_nominals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹all_is <span class="free">p</span> <span class="free">ps</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span>omit <span class="free">xs</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_is_list_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> all_is_branch_nominals'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹all_is_branch <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span>
     nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span><span class="main">.</span> <span class="bound">v</span> <span class="main">&lt;</span> length <span class="free">branch</span> <span class="main">⟶</span> is_at <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="bound">v</span> <span class="bound">v'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> all_is_branch_def is_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">block</span> <span class="skolem">branch</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">block</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">ps</span> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span><span class="main">.</span> <span class="bound">v</span> <span class="main">&lt;</span> length <span class="skolem">branch</span> <span class="main">⟶</span> is_at <span class="free">p</span> <span class="free">i</span> <span class="skolem">branch</span> <span class="bound">v</span> <span class="bound">v'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> rev_nth_Cons <span class="keyword1"><span class="command">unfolding</span></span> is_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">=</span>
         nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span>
          branch_nominals <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹all_is <span class="free">p</span> <span class="skolem">ps</span> <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> Pair <span class="keyword1"><span class="command">unfolding</span></span> proj_def all_is_def is_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
         nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> all_is_block_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span>omit_block <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          nominals <span class="free">p</span> <span class="main">∪</span> block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∪</span> branch_nominals <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> Pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Dup_branch_nominals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span> branch_nominals <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_branch_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span> <span class="main">∨</span> <span class="skolem">ps</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Dup_def is_elsewhere_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_mem rev_nth_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">⊆</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> block_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">⊆</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> block_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span>
     nominals <span class="free">p</span> <span class="main">∪</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms all_is_branch_nominals' Dup_all_is_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omit_branch_mem_dual<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹omit_branch <span class="free">xs</span> <span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_mem <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">using</span></span> length_mapi <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_bounded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="free">xs</span> <span class="free">branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span>omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapi_rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps</span> <span class="main">=</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps omit_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps</span> <span class="main">=</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ps'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> witnessed_omit_branch<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹witnessed <span class="free">p</span> <span class="free">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹witnessed <span class="free">p</span> <span class="free">a</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> witnessed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_branch_mem_dual <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> qs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_branch_mem_dual <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> witnessed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_omit_branch<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹new <span class="free">p</span> <span class="free">a</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹new <span class="free">p</span> <span class="free">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms omit_branch_mem_dual <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_oob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">ps</span> <span class="main">≤</span> <span class="free">v</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹omit <span class="main">(</span><span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">∪</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> omit <span class="free">xs</span> <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> omit_branch_oob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">branch</span> <span class="main">≤</span> <span class="free">v</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span> <span class="main">=</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">block</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">xs</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">block</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">ps</span> <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹omit_branch <span class="var">?xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>omit <span class="main">(</span>proj <span class="var">?xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹proj <span class="var">?xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span> <span class="main">=</span> proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_Dup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">q</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Close <span class="skolem">p</span> <span class="skolem">i'</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i'</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i'</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>4-<span class="main">)</span> Dup_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>5<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>2<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.Neg<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisP <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>4-<span class="main">)</span> Dup_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>8<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>1<span class="main">,</span> 8<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>2<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">q</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>3<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.DisP<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisN <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>4-<span class="main">)</span> Dup_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>5<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>5<span class="main">)</span> Dup_head_oob' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
      omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
     new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>2<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.DisN<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaP <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>4-<span class="main">)</span> Dup_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>7<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> <span class="main">1</span><span class="main">+</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>7<span class="main">)</span> Dup_head_oob' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
      omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1<span class="main">,</span> 7<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">,</span> 7<span class="main">)</span> Dup_branch_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> witnessed <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>4<span class="main">)</span> witnessed_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.DiaP<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaN <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>4-<span class="main">)</span> Dup_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>6<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
      omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>1<span class="main">,</span> 6<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>2<span class="main">,</span> 6<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>3<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.DiaN<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatP <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>4-<span class="main">)</span> Dup_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>5<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>2<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.SatP<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatN <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>4-<span class="main">)</span> Dup_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>2<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.SatN<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GoTo <span class="skolem">i</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Dup_branch<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> Dup_branch_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> STA.GoTo<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">a</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>4-<span class="main">)</span> Dup_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> Dup_head_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> omit <span class="main">(</span>proj <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="free">xs</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1<span class="main">,</span> 7<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">,</span> 7<span class="main">)</span> Dup_omit_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span>omit_branch <span class="free">xs</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>4<span class="main">)</span> new_omit_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omit_branch_def STA.Nom<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Dup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> new <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> length <span class="free">ps</span><span class="main">)</span><span class="main">}</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_at <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span> <span class="main">(</span>length <span class="free">ps</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Dup <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="var">?xs</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> Nom <span class="free">a</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> length <span class="free">branch</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_elsewhere <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="var">?xs</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_elsewhere_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> rev_nth_Some
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Pair_inject less_le singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Dup_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> false<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">ps</span> <span class="main">=</span> <span class="skolem">qs</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>2<span class="main">)</span> false rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> True rev_nth_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">!.</span> length <span class="free">branch</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?xs</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> True w' rev_nth_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_elsewhere <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="var">?xs</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_elsewhere_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Dup_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>1<span class="main">)</span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>2<span class="main">)</span> false rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?xs</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> rev_nth_Some w <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹is_elsewhere <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="var">?xs</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_elsewhere_def <span class="keyword1"><span class="command">using</span></span> rev_nth_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Dup_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> omit_branch <span class="var">?xs</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> STA_Dup <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span>omit <span class="main">(</span>proj <span class="var">?xs</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> omit_branch <span class="var">?xs</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> omit_branch_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="var">?xs</span> <span class="free">branch</span> <span class="main">=</span> omit_branch <span class="main">{}</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_branch_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit_branch <span class="var">?xs</span> <span class="free">branch</span> <span class="main">=</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_branch_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹proj <span class="var">?xs</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>length <span class="free">ps</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit <span class="main">(</span>proj <span class="var">?xs</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> omit <span class="main">{}</span> <span class="free">ps</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_oob <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹omit <span class="main">(</span>proj <span class="var">?xs</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ps</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> omit_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unrestricted rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_add<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> STA_le<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> STA_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Neg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Neg Dup STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> DisP'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹new <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">∧</span> new <span class="free">q</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span>  Suc <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> DisP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Dup <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DisP''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> max <span class="free">n</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> STA_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DisP' max.absorb2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> STA_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DisP' max.absorb1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DisN'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">q</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="main">∨</span> new <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms DisN STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Dup
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> new_def on.simps set_ConsD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DiaP'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">¬</span> witnessed <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms DiaP STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> DiaN'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms DiaN Dup STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> SatP'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms SatP Dup STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> SatN'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms SatN Dup STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> Nom'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹Nom <span class="free">a</span> <span class="keyword1">at</span> <span class="free">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">i</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹new <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Dup <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_nominals<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>nominals <span class="free">p</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_block_nominals<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>block_nominals <span class="free">block</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_nominals <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_branch_nominals<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>branch_nominals <span class="free">branch</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_block_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sub_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> fm list›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">sub_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≡</span> map <span class="main">(</span>sub <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sub_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> block›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">sub_block</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sub_list <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sub_branch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> branch›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">sub_branch</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">blocks</span></span></span> <span class="main">≡</span> map <span class="main">(</span>sub_block <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">blocks</span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sub_block_mem<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">on</span> <span class="free">block</span> <span class="main">⟹</span> sub <span class="free">f</span> <span class="free">p</span> <span class="keyword1">on</span> sub_block <span class="free">f</span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_branch_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>sub_list <span class="free">f</span> <span class="free">ps</span><span class="main">,</span> <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈.</span> sub_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">using</span></span> assms image_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_block_nominals<span class="main">:</span> <span class="quoted"><span class="quoted">‹block_nominals <span class="main">(</span>sub_block <span class="free">f</span> <span class="free">block</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> block_nominals <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sub_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_branch_nominals<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>sub_branch <span class="free">f</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> branch_nominals <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def sub_branch_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sub_block_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_list_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_list id <span class="free">ps</span> <span class="main">=</span> <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> sub_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_block_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_block id <span class="free">block</span> <span class="main">=</span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> sub_list_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_branch_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_branch id <span class="free">branch</span> <span class="main">=</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">using</span></span> sub_block_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_block_upd_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> block_nominals <span class="free">block</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹sub_block <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">block</span> <span class="main">=</span> sub_block <span class="free">f</span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_upd_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_branch_upd_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹sub_branch <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">branch</span> <span class="main">=</span> sub_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def sub_branch_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sub_block_upd_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_comp<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub <span class="free">f</span> <span class="main">(</span>sub <span class="free">g</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> sub <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_list_comp<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_list <span class="free">f</span> <span class="main">(</span>sub_list <span class="free">g</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> sub_list <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> sub_comp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_block_comp<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_block <span class="free">f</span> <span class="main">(</span>sub_block <span class="free">g</span> <span class="free">block</span><span class="main">)</span> <span class="main">=</span> sub_block <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> sub_list_comp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_branch_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹sub_branch <span class="free">f</span> <span class="main">(</span>sub_branch <span class="free">g</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span> sub_branch <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">using</span></span> sub_block_comp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_id<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>id<span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>id<span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> id›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> at_in_sub_branch<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹sub <span class="free">f</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="free">f</span> <span class="free">i</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="free">f</span> <span class="free">ps</span><span class="main">,</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sub_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_still_allowed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">i</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹sub <span class="free">f</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span> <span class="main">∨</span> sub <span class="free">f</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹sub <span class="free">f</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> Nom <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹sub <span class="free">f</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dia <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If a branch has a closing tableau then so does any branch obtained by renaming nominals
    as long as the substitution leaves some nominals free.
  This is always the case for substitutions that do not change the type of nominals.
  Since some formulas on the renamed branch may no longer be new, they do not contribute any
    potential and so we existentially quantify over the potential needed to close the new branch.
  We assume that the set of allowed nominals <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> is finite such that we can obtain a free nominal.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_sub'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="main">(</span><span class="bound">f</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">A</span><span class="main">.</span> finite <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∉</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="bound">f</span> <span class="main">`</span> <span class="bound">A</span>›</span></span>
    <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> STA.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Close <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="keyword1">in</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>1<span class="main">)</span> sub_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="keyword1">in</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>2<span class="main">)</span> sub_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisP <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">q</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> sub <span class="skolem">f</span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisN <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> sub <span class="skolem">f</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> sub <span class="skolem">f</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>3-4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaP <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹witnessed <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>sub_branch <span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      rs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ts<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def witnessed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rs <span class="keyword1"><span class="command">have</span></span> rs'<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?branch</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">=</span> sub_branch <span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> sub_branch_upd_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_list <span class="var">?f</span> <span class="skolem">ps</span> <span class="main">=</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?branch</span> <span class="main">=</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub <span class="var">?f</span> <span class="skolem">p</span> <span class="main">=</span> sub <span class="skolem">f</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1-2<span class="main">)</span> sub_upd_fresh <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>sub <span class="var">?f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="main">(</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> p ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Dup new_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Dup new_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_branch_nominals<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> <span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">j</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?branch</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">=</span> sub_branch <span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> sub_branch_upd_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_list <span class="var">?f</span> <span class="skolem">ps</span> <span class="main">=</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?branch</span> <span class="main">=</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub <span class="var">?f</span> <span class="skolem">p</span> <span class="main">=</span> sub <span class="skolem">f</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1-2<span class="main">)</span> sub_upd_fresh <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> witnessed <span class="main">(</span>sub <span class="var">?f</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> False ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> witnessed <span class="main">(</span>sub <span class="var">?f</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>sub <span class="var">?f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="main">(</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sub <span class="var">?f</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="var">?f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> sub <span class="var">?f</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="var">?f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> sub <span class="var">?f</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span>branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">i</span> <span class="main">∉</span> branch_nominals <span class="main">(</span><span class="main">(</span>sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ** sub_branch_nominals <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_same list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> sub_block.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> w DiaP' <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> <span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff fun_upd_same<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> *** <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaN <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span> 5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>2<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatP <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatN <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GoTo <span class="skolem">i</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>sub_branch <span class="skolem">f</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>1<span class="main">)</span> sub_branch_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">a</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main">#</span> sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">f</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">)</span> at_in_sub_branch <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">i</span> <span class="main">∨</span> sub <span class="skolem">f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>3<span class="main">)</span> sub_still_allowed <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="skolem">f</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="skolem">f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_fresh_gt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">g</span> <span class="main">::</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">.</span> surj <span class="bound">g</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>›</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹surj <span class="skolem">g</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I UNIV_eq_I card_image_le card_seteq finite_imageI image_comp subsetI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> STA_sub_gt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">g</span> <span class="main">::</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">.</span> surj <span class="bound">g</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> branch_nominals <span class="free">branch</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ex_fresh_gt STA_sub' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> STA_sub_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'c</span> set<span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> branch_nominals <span class="free">branch</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="skolem">f</span> <span class="main">`</span> <span class="skolem">A</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ex_new_if_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> STA_sub' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> STA_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="skolem">f</span> <span class="main">`</span> <span class="skolem">A</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image_le card_seteq finite_imageI subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms STA_sub' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unrestricted <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(<span class="hidden">❙</span><b>◇</b>)›</span></span></span></span> rule›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DiaP''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span>
    <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹witnessed <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    rs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ts<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> witnessed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rs'<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹id<span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4-5<span class="main">)</span> STA_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="main">(</span>sub <span class="var">?f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> sub_list <span class="var">?f</span> <span class="free">ps</span><span class="main">,</span> <span class="var">?f</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span>
      sub_branch <span class="var">?f</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> nominals <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> list_nominals <span class="free">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sub <span class="var">?f</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_id sub_upd_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sub_list <span class="var">?f</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ps</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> list_nominals <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI sub_id sub_upd_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="free">branch</span> <span class="main">=</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_branch_id sub_branch_upd_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="free">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Dup new_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Dup new_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms DiaP' STA_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Structural Properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> block_nominals_branch<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">block</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹block_nominals <span class="free">block</span> <span class="main">⊆</span> branch_nominals <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_block_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">block</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹sub_block <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">block</span> <span class="main">=</span> sub_block <span class="free">f</span> <span class="free">block</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms block_nominals_branch sub_block_upd_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> list_down_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Start Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">y</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If the last block on a branch has opening nominal <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> and the last formulas on that block
   occur on another block alongside nominal <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span>, then we can drop those formulas.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_drop_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">ps</span> <span class="main">⊆</span> set <span class="free">qs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span> <span class="main">@</span> <span class="free">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_down_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Start
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Dup new_def list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can drop a block if it is subsumed by another block.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_drop_block<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹set <span class="free">ps</span> <span class="main">⊆</span> set <span class="free">ps'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">block</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">block</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">qs</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2-4<span class="main">)</span> STA_drop_prefix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> Pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> GoTo<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Pair Dup <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_drop_block'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms STA_drop_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_branch_image<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span>sub_branch <span class="free">f</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span> sub_block <span class="free">f</span> <span class="main">`</span> set <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_block_repl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∉</span> block_nominals <span class="free">block</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> block_nominals <span class="main">(</span>sub_block <span class="main">(</span>id<span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">block</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff sub_block_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_branch_repl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> branch_nominals <span class="main">(</span>sub_branch <span class="main">(</span>id<span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff sub_branch_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a finite set of blocks has a closing tableau then so does any finite superset.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_struct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">branch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">branch</span> <span class="main">⊆</span> set <span class="free">branch'</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="free">branch'</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">branch'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> STA.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Close <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisP <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>5<span class="main">,</span> 7-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>1<span class="main">,</span> 8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisN <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaP <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="skolem">branch'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_branch_nominals<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ex_new_if_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹id<span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?branch'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="skolem">branch'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> branch'<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="var">?branch'</span> <span class="main">=</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub_branch_comp sub_branch_id swap_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> branch<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> j' sub_branch_id sub_branch_upd_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹set <span class="main">(</span>sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="var">?branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>7<span class="main">)</span> sub_branch_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">⊆</span> set <span class="var">?branch'</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> branch_nominals <span class="var">?branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> j sub_branch_repl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>6<span class="main">)</span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_mono list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_subset_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1<span class="main">,</span> 7<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> set_subset_Cons subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf DiaP<span class="main">(</span>2-3<span class="main">)</span> fin i DiaP'' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_sub fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>›</span></span> branch' branch <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">branch'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaN <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>5-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>1-2<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatP <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatN <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GoTo <span class="skolem">i</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> branch_nominals <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>2<span class="main">)</span> STA.GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">a</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>3<span class="main">)</span> Nom' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">branch'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_drop_block' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If a branch has a closing tableau then we can replace the formulas of the last block
  on that branch with any finite superset and still obtain a closing tableau.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_struct_block<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">branch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">ps</span> <span class="main">⊆</span> set <span class="free">ps'</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">ps'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> STA.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Close <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">ts</span> <span class="skolem">ts'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ts'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ts'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisP <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">ps</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>5<span class="main">,</span> 7-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisN <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">ps</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaP <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin finite_branch_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ex_new_if_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP.prems <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹id<span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹sub_list <span class="var">?f</span> <span class="skolem">ps'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> ps'<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_list <span class="var">?f</span> <span class="var">?ps'</span> <span class="main">=</span> <span class="skolem">ps'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub_list_comp sub_list_id swap_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_block <span class="var">?f</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> j' sub_block_id sub_block_upd_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span>sub_list <span class="var">?f</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>sub_list <span class="var">?f</span> <span class="skolem">ps'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ps</span> <span class="main">⊆</span> set <span class="skolem">ps'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ps</span> <span class="main">⊆</span> set <span class="var">?ps'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> branch<span class="main">:</span> <span class="quoted"><span class="quoted">‹sub_branch <span class="var">?f</span> <span class="free">branch</span> <span class="main">=</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub_branch_id sub_branch_upd_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≠</span> <span class="free">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP j <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="var">?ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub_block_repl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> block<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="var">?ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> * DiaP<span class="main">(</span>6<span class="main">)</span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="var">?ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="var">?ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="var">?ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>3<span class="main">)</span> fin DiaP'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊢</span> sub_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="var">?ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_sub fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>sub_list <span class="var">?f</span> <span class="var">?ps'</span><span class="main">,</span> <span class="var">?f</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> sub_branch <span class="var">?f</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub_branch_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>›</span></span> ps' branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaN <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>5-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatP <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatN <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GoTo <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">_</span> <span class="main">#</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> Suc <span class="skolem">m</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> STA_drop_block<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>3<span class="main">)</span> Nom' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bridge›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>descendants k i branch›</span></span></span></span> relation on sets of indices.
  The sets are built on the index of a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>◇</b> Nom k›</span></span></span></span> on an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>-block in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>branch›</span></span></span></span> and can be extended
    by indices of formula occurrences that can be thought of as descending from
    that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>◇</b> Nom k›</span></span></span></span> by application of either the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(<span class="hidden">❙</span><b>¬</b> <span class="hidden">❙</span><b>◇</b>)›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Nom›</span></span></span></span> rule.

  We show that if we have nominals <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> on the same block in a closeable branch,
  then the branch obtained by the following transformation is also closeable:
  For every index <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, if the formula at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>◇</b> Nom k›</span></span></span></span>, replace it by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>◇</b> Nom j›</span></span></span></span> and
    if it is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>¬</b> (<span class="hidden">❙</span><b>@</b> k p)›</span></span></span></span> replace it by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>¬</b> (<span class="hidden">❙</span><b>@</b> j p)›</span></span></span></span>.
  There are no other cases.

  From this transformation we can show admissibility of the Bridge rule under the assumption
    that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> is an allowed nominal.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Replacing›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bridge'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">bridge'</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">k'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">k'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">k'</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">k'</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">k'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">k'</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bridge</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">bridge</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> mapper <span class="main">(</span>bridge' <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bridge_on_Nom<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹Nom <span class="free">i</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> Nom <span class="free">i</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bridge'_nominals<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span>bridge' <span class="free">k</span> <span class="free">j</span> <span class="free">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span> <span class="main">=</span> nominals <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dia <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bridge_nominals<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="free">v'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span> <span class="main">=</span> nominals <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="free">v'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> nominals <span class="main">(</span>bridge' <span class="free">k</span> <span class="free">j</span> <span class="free">p</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bridge'_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bridge_block_nominals<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹block_nominals <span class="main">(</span>mapi_block <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span> <span class="main">=</span>
   block_nominals <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span> <span class="main">⟷</span>
    <span class="main">(</span>nominals <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="main">(</span>length <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
    <span class="main">(</span>block_nominals <span class="main">(</span>mapi_block <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>nominals <span class="skolem">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">⟷</span>
    <span class="main">(</span>nominals <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="main">(</span>length <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
    <span class="main">(</span>block_nominals <span class="main">(</span>mapi_block <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>nominals <span class="skolem">p</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>block_nominals <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="main">(</span>length <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span> <span class="main">=</span> nominals <span class="skolem">p</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> bridge_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> Cons
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bridge_branch_nominals<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span> <span class="main">=</span>
   branch_nominals <span class="free">branch</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">branch</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def mapi_branch_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">block</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?case</span> <span class="main">⟷</span>
    <span class="main">(</span>block_nominals <span class="main">(</span>mapi_block <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">block</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
    <span class="main">(</span>branch_nominals <span class="main">(</span>mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>block_nominals <span class="skolem">block</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>branch_nominals <span class="skolem">branch</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">⟷</span>
    <span class="main">(</span>block_nominals <span class="main">(</span>mapi_block <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">block</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
    <span class="main">(</span>branch_nominals <span class="main">(</span>mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>block_nominals <span class="skolem">block</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>branch_nominals <span class="skolem">branch</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹block_nominals <span class="main">(</span>mapi_block <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">block</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span> <span class="main">=</span>
     block_nominals <span class="skolem">block</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> bridge_block_nominals<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹fst <span class="skolem">block</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹snd <span class="skolem">block</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> at_in_mapi_branch<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> Nom <span class="free">a</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="bound">v'</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> mapi_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mapi_branch_mem rev_nth_mapi_block rev_nth_on<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nom_at_in_bridge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">≡</span> bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">i</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">i</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in</span> mapi_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">i</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="free">f</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> mapi_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">i</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nominals_mapi_branch_bridge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span> branch_nominals <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nom_at_in_bridge <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>mapi_branch <span class="var">?f</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>mapi_branch <span class="var">?f</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>mapi_branch <span class="var">?f</span> <span class="free">branch</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span> <span class="main">=</span> branch_nominals <span class="free">branch</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> bridge_branch_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bridge_proper_dia<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">p</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bridge_compl_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="free">v'</span> <span class="free">w</span> <span class="free">w'</span> <span class="free">p</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">≡</span> bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">v</span> <span class="free">v'</span> <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q'</span> <span class="main">≡</span> bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span> <span class="free">w</span> <span class="free">w'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="free">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def q'_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dia <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def q'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def q'_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Descendants›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">descendants</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> branch <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Initial<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">descendants</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">}</span>›</span></span>
<span class="main">|</span> Derived<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">descendants</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">descendants</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>›</span></span>
<span class="main">|</span> Copied<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span>
    <span class="free">descendants</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">!.</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span>
    Nom <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">⟹</span>
    <span class="free">descendants</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_initial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ps</span><span class="main">.</span>
    <span class="free">branch</span> <span class="main">!.</span> <span class="bound">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ps</span> <span class="main">!.</span> <span class="bound">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> descendants.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_bounds_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">&lt;</span> length <span class="free">branch</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms rev_nth_Some
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> descendants.induct<span class="main">)</span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_bounds_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v'</span> <span class="main">&lt;</span> length <span class="free">ps</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> descendants.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_nth_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_branch<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span> <span class="main">⟹</span> descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="free">extra</span> <span class="main">@</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> descendants.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Initial <span class="skolem">branch</span> <span class="skolem">v</span> <span class="skolem">qs</span> <span class="skolem">i</span> <span class="skolem">v'</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_append descendants.Initial <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Derived <span class="skolem">branch</span> <span class="skolem">v</span> <span class="skolem">qs</span> <span class="skolem">a</span> <span class="skolem">v'</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">extra</span> <span class="main">@</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">extra</span> <span class="main">@</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Derived<span class="main">(</span>2<span class="main">,</span> 4-5<span class="main">,</span> 7<span class="main">)</span> descendants.Derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Copied <span class="skolem">branch</span> <span class="skolem">v</span> <span class="skolem">qs</span> <span class="skolem">a</span> <span class="skolem">v'</span> <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="skolem">rs</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">extra</span> <span class="main">@</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">extra</span> <span class="main">@</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">extra</span> <span class="main">@</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>2-4<span class="main">,</span> 5-7<span class="main">)</span> descendants.Copied <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_block<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> descendants.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Initial <span class="skolem">v</span> <span class="skolem">qs</span> <span class="skolem">i</span> <span class="skolem">v'</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Initial<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">k</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Initial<span class="main">(</span>2<span class="main">)</span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> descendants.Initial <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Derived <span class="skolem">v</span> <span class="skolem">qs</span> <span class="skolem">a'</span> <span class="skolem">v'</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derived<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derived<span class="main">(</span>2<span class="main">)</span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">k</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derived<span class="main">(</span>7<span class="main">)</span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Derived<span class="main">(</span>4-5<span class="main">)</span> descendants.Derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Copied <span class="skolem">v</span> <span class="skolem">qs</span> <span class="skolem">a'</span> <span class="skolem">v'</span> <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="skolem">rs</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>2<span class="main">)</span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>7<span class="main">)</span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>7<span class="main">)</span> rev_nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a'</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Copied<span class="main">(</span>4-5<span class="main">)</span> descendants.Copied<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps'</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_no_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms descendants_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_types<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">xs</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">branch</span> <span class="main">!.</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps</span> <span class="main">!.</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">p</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_oob_head'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> <span class="free">m</span> <span class="main">+</span> length <span class="free">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms descendants_bounds_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> descendants_oob_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> length <span class="free">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms descendants_oob_head'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We induct over an arbitrary set of indices.
  That way, we can determine in each case whether the extension gets replaced or not
    by manipulating the set before applying the induction hypothesis.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_bridge'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="free">n</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
    <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">branch</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> STA.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Close <span class="skolem">p</span> <span class="skolem">i'</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?branch</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈.</span> <span class="var">?branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs mapi_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈.</span> <span class="var">?branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs mapi_branch_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="var">?branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Close<span class="main">(</span>4<span class="main">)</span> nom_at_in_bridge <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs bridge_on_Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>2<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> v w STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs rev_nth_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qs'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">!.</span> <span class="skolem">w'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs rev_nth_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rs'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="main">(</span>dia<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="main">|</span>
      <span class="main">(</span>satn<span class="main">)</span><span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="main">|</span>
      <span class="main">(</span>sat<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="main">|</span>
      <span class="main">(</span>old<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> bridge_compl_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> dia
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> q qs' q' rs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> branch_nominals <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DiaN'<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="free">k</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that SatN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="free">k</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="free">k</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="free">k</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="main">(</span>Nom <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> satn
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> q qs' q' rs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> branch_nominals <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Neg'<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that SatN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that SatP' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' fm.distinct<span class="main"><span class="main">(</span></span>21<span class="main"><span class="main">)</span></span> fm.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">at</span> <span class="free">k</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">k</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sat
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> q qs' q' rs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">)</span> w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> SatN'<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that SatP' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' fm.distinct<span class="main"><span class="main">(</span></span>21<span class="main"><span class="main">)</span></span> fm.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">at</span> <span class="free">k</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">k</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">r</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="var">?branch</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> STA.Close <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> old
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> q qs' q' rs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> v w STA.Close<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">l</span> <span class="skolem">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>5<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>5<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>1<span class="main">)</span> at_in_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisP <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">l</span> <span class="skolem">l'</span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>8<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>5-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>8<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP<span class="main">(</span>1<span class="main">)</span> at_in_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisP'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DisN <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">l</span> <span class="skolem">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>5<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>5<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>5<span class="main">)</span> descendants_oob_head' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN<span class="main">(</span>1<span class="main">)</span> at_in_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DisN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaP <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i'</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">l</span> <span class="skolem">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>3<span class="main">)</span> bridge_proper_dia <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>8-<span class="main">)</span> nominals_mapi_branch_bridge<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i'<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">k</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">,</span> 8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>2<span class="main">,</span> 8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>7<span class="main">)</span> descendants_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
      mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaP<span class="main">(</span>1<span class="main">)</span> at_in_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> i' DiaP<span class="main">(</span>3<span class="main">)</span> fin DiaP'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DiaN <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">i'</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="skolem">l</span> <span class="skolem">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="skolem">l</span> <span class="skolem">l'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>1<span class="main">)</span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>2<span class="main">)</span> rev_nth_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">xs</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">k</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>6<span class="main">)</span> v v' descendants_types <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="var">?xs</span>›</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?branch</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs'</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">rs'</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v v' index_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>6<span class="main">)</span> descendants_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?branch</span> <span class="main">!.</span> length <span class="skolem">branch</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">!.</span> length <span class="skolem">ps</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="var">?xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">k</span>›</span></span> Derived<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">k</span>›</span></span> DiaN<span class="main">(</span>5-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
        mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="var">?xs</span><span class="main">)</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>1<span class="main">)</span> at_in_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> p<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="var">?xs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v rev_nth_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span>
        set <span class="main">(</span><span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v' rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DiaN'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
        mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> mapi_branch_head_add_oob<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">branch</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>6<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>5-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>6<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
        mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> DiaN<span class="main">(</span>1<span class="main">)</span> at_in_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> p<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="skolem">xs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v rev_nth_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span>
        set <span class="main">(</span><span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v' rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DiaN'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatP <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">l</span> <span class="skolem">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>5<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>5<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP<span class="main">(</span>1<span class="main">)</span> at_in_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatP' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SatN <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>1<span class="main">)</span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>2<span class="main">)</span> rev_nth_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">xs</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="free">k</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> v v' descendants_types <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?branch</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="var">?branch</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">rs'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">rs'</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v v' <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="free">k</span>›</span></span> index_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="var">?branch</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="var">?branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="free">k</span>›</span></span> SatN<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">⊆</span>
        set <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>6<span class="main">)</span> nom_at_in_bridge <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v rev_nth_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v' <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="free">k</span>›</span></span> rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> satn<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> that GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> satn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> that SatN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> that SatN' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">⊆</span>
        set <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> that inf fin STA_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' fm.distinct<span class="main"><span class="main">(</span></span>21<span class="main"><span class="main">)</span></span> fm.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> SatN<span class="main">(</span>5<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v rev_nth_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span>
        set <span class="main">(</span><span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> v' rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> SatN'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GoTo <span class="skolem">i'</span> <span class="skolem">n</span> <span class="skolem">ps</span> <span class="skolem">a</span> <span class="skolem">branch</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>4<span class="main">)</span> descendants_branch<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>3<span class="main">,</span> 5-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>5-<span class="main">)</span> nominals_mapi_branch_bridge<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> GoTo<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA.GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">ps</span> <span class="skolem">a</span> <span class="skolem">branch</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">j</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> descendants_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">p</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1<span class="main">)</span> True nom_at_in_bridge <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">)</span> True nom_at_in_bridge <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' Nom.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>1<span class="main">)</span> rev_nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>2<span class="main">)</span> False rev_nth_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">xs</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="var">?xs</span>›</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge' <span class="free">k</span> <span class="free">j</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="var">?p</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>dia<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span>›</span></span> <span class="main">|</span> <span class="main">(</span>satn<span class="main">)</span> <span class="skolem">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">k</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="main">|</span> <span class="main">(</span>old<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="var">?p</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> True descendants_types v v'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?p</span> <span class="main">=</span> Nom <span class="bound">i</span> <span class="main">∨</span> <span class="var">?p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">qs'</span> <span class="main">!.</span> <span class="skolem">v'</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> v v' index_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> descendants_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">p</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="main">!.</span> length <span class="skolem">branch</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">!.</span> length <span class="skolem">ps</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="var">?xs</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> True Copied <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="var">?p</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> v rev_nth_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
          mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> v v' rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?p</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">)</span> nom_at_in_bridge <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' Nom<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
          mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> mapi_branch_head_add_oob<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">branch</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹bridge <span class="free">k</span> <span class="free">j</span> <span class="skolem">xs</span>›</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> descendants_no_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>6-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>length <span class="skolem">branch</span><span class="main">,</span> length <span class="skolem">ps</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">xs</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>7<span class="main">)</span> descendants_oob_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> v rev_nth_mapi_branch <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span>
          mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> v v' rev_nth_mapi_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> mapi_branch <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">branch</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nom<span class="main">(</span>2<span class="main">)</span> nom_at_in_bridge <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span>mapi <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>length <span class="skolem">branch</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="var">?f</span> <span class="skolem">branch</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' Nom<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> STA_bridge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="free">branch</span> <span class="free">xs</span>›</span></span>
    <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 5-6<span class="main">)</span> inf STA_struct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> descendants_branch<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_bridge' inf assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹branch_nominals <span class="main">(</span>mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span><span class="main">)</span> <span class="main">=</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> nominals_mapi_branch_bridge assms<span class="main">(</span>4-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> branch_nominals <span class="main">(</span>mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derivation›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Bridge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> length <span class="free">ps</span><span class="main">)</span><span class="main">}</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹descendants <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span> <span class="var">?xs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Initial <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">k</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_bridge inf fin assms<span class="main">(</span>3<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span> <span class="main">#</span> mapi <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span>
      mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="var">?xs</span><span class="main">)</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapi_branch_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="main">{</span><span class="main">(</span>length <span class="free">branch</span><span class="main">,</span> length <span class="free">ps</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="free">branch</span> <span class="main">=</span>
      mapi_branch <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="main">{}</span><span class="main">)</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> mapi_branch_add_oob<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">{}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹mapi <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span>
    mapi <span class="main">(</span>bridge <span class="free">k</span> <span class="free">j</span> <span class="main">{}</span> <span class="main">(</span>length <span class="free">branch</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> mapi_block_add_oob<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">{}</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">branch</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> mapi_block_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span><span class="main">]</span> mapi_branch_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">branch</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Dup assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> new_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Completeness›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hintikka›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">at_in_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">at_in_set</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">notation</span></span> at_in_set <span class="main">(</span><span class="quoted">‹_ <span class="keyword1">at</span> _ <span class="keyword1">in''</span> _›</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A set of blocks is Hintikka if it satisfies the following requirements.
  Intuitively, if it corresponds to an exhausted open branch
    with respect to the fixed set of allowed nominals <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>.
  For example, we only require symmetry, "if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> occurs at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> occurs at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>" if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i ∈ A›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Hintikka <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span> <span class="keyword2"><span class="keyword">assumes</span></span>
    ProP<span class="main">:</span> <span class="quoted"><span class="quoted">‹Nom <span class="free">j</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> Pro <span class="free">x</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Pro <span class="free">x</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    NomP<span class="main">:</span> <span class="quoted"><span class="quoted">‹Nom <span class="free">a</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="free">a</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    NegN<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    DisP<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">q</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    DisN<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="free">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    DiaP<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">j</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    DiaN<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="free">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">j</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    SatP<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    SatN<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    GoTo<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> nominals <span class="free">p</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="bound">a</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Nom<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">a</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span>
      <span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> Nom <span class="free">j</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="free">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Two nominals <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> are equivalent in respect to a Hintikka set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>H›</span></span></span></span> if
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>H›</span></span></span></span> contains an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>-block with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> on it.
  This is an equivalence relation on the names in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>H›</span></span></span></span> intersected with the allowed nominals <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hequiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">hequiv</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> Nom <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hequiv_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">hequiv_rel</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> hequiv <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">names</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">names</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">i</span> <span class="main">|</span><span class="bound">ps</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_refl<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> names <span class="free">H</span> <span class="main">⟹</span> hequiv <span class="free">H</span> <span class="free">i</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hequiv_def names_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_refl'<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> hequiv <span class="free">H</span> <span class="free">i</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> hequiv_refl <span class="keyword1"><span class="command">unfolding</span></span> names_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_sym'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">i</span> <span class="free">j</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">j</span> <span class="free">i</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> Nom <span class="skolem">i</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟶</span> Nom <span class="skolem">j</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟶</span> Nom <span class="skolem">i</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> hequiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_sym<span class="main">:</span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> hequiv <span class="free">H</span> <span class="free">i</span> <span class="free">j</span> <span class="main">⟷</span> hequiv <span class="free">H</span> <span class="free">j</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> hequiv_sym'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">i</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">j</span> <span class="free">k</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">i</span> <span class="free">k</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">j</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">,</span></span> 4<span class="main"><span class="main">)</span></span> hequiv_sym'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> Nom <span class="skolem">k</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟶</span> Nom <span class="skolem">i</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟶</span> Nom <span class="skolem">k</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">k</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> hequiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_names<span class="main">:</span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> names <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hequiv_def names_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_names_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹hequiv_rel <span class="free">A</span> <span class="free">H</span> <span class="main">⊆</span> names <span class="free">H</span> <span class="main">×</span> names <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms hequiv_names hequiv_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_refl_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹refl_on <span class="main">(</span>names <span class="free">H</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">using</span></span> assms hequiv_refl hequiv_names_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_sym_rel<span class="main">:</span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span> <span class="main">⟹</span> sym <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">using</span></span> hequiv_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_trans_rel<span class="main">:</span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">B</span> <span class="free">A</span> <span class="main">⟹</span> trans <span class="main">(</span>hequiv_rel <span class="free">B</span> <span class="free">A</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">using</span></span> hequiv_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_rel<span class="main">:</span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span> <span class="main">⟹</span> equiv <span class="main">(</span>names <span class="free">H</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> hequiv_refl_rel hequiv_sym_rel hequiv_trans_rel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equivI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nominal_in_names<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">block</span> <span class="main">∈</span> <span class="free">H</span><span class="main">.</span> <span class="free">i</span> <span class="main">∈</span> block_nominals <span class="bound">block</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> names <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Hintikka.GoTo <span class="keyword1"><span class="command">unfolding</span></span> names_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Named model›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a Hintikka set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>H›</span></span></span></span>, a formula <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> on a block in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>H›</span></span></span></span> and a set of allowed nominals <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>
    which contains all "root-like" nominals in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> we construct a model that satisfies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>.

  The worlds of our model are sets of equivalent nominals and
    nominals are assigned to the equivalence class of an equivalent allowed nominal.
  This definition resembles the "ur-father" notion.

  From a world <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>is›</span></span></span></span>, we can reach a world <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> iff there is an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i ∈ is›</span></span></span></span> and a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j ∈ js›</span></span></span></span> s.t.
    there is an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>-block in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>H›</span></span></span></span> with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>◇</b> Nom j›</span></span></span></span> on it.

  A propositional symbol <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is true in a world <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>is›</span></span></span></span> if there exists an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i ∈ is›</span></span></span></span> s.t.
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> occurs on an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>-block in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>H›</span></span></span></span>.
 ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">assign</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> Nom <span class="bound">a</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span>
    <span class="keyword1">then</span> proj <span class="main">(</span>hequiv_rel <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> Nom <span class="bound">a</span> <span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">reach</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">≡</span> <span class="main">{</span>assign <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="bound">i</span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">val</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">.</span> Pro <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">at</span> <span class="bound">i</span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_assignment<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="var">?b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex True <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="var">?b</span> <span class="var">?b</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms block_nominals nominal_in_names hequiv_refl
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> nominals.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> singletonI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ur_closure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">a</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="bound">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="var">?b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex True <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="var">?b</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Hintikka.Nom<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="var">?b</span> <span class="skolem">a</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">using</span></span> that assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> hequiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Hintikka.Nom<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="var">?b</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ur_closure'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> Nom <span class="bound">a</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">at</span> <span class="bound">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ex_assignment <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ur_closure<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_hequiv_rel<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_proj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span>
    <span class="quoted"><span class="quoted">‹Nom <span class="free">a</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">b</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹equiv <span class="main">(</span>names <span class="free">H</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> hequiv_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> names <span class="free">H</span> <span class="main">∩</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-5<span class="main">)</span> nominal_in_names <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">b</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">,</span> 4-5<span class="main">)</span> Hintikka.Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="free">a</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hequiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proj_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hequiv_proj_opening<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">a</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> hequiv_proj assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> assign_proj_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">i</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">i</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">a</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">a</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> someI_ex <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="var">?a</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="var">?a</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def
    <span class="keyword1"><span class="command">using</span></span> hequiv_proj * assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> assign_named<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">a</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> names <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">meson</span> hequiv_names hequiv_sym'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assign_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">a</span> <span class="main">=</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="var">?b</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex True <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="var">?b</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="free">a</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms assign_named <span class="keyword1"><span class="command">unfolding</span></span> names_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">a</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="free">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms assign_proj_refl mem_hequiv_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">meson</span> hequiv_sym' hequiv_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">=</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> assign_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹Pro <span class="free">x</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Pro <span class="free">x</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> names <span class="free">H</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">using</span></span> assms Hintikka.ProP ur_closure <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Hintikka_model<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">H</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> nominals <span class="free">p</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span>
        Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">⟹</span> nominals <span class="free">p</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span>
      <span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="free">i</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pro <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹Pro <span class="skolem">x</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> Pro <span class="skolem">x</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ur_closure' <span class="keyword1"><span class="command">unfolding</span></span> val_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pro <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Pro <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">∧</span> Pro <span class="skolem">x</span> <span class="keyword1">at</span> <span class="bound">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assign_val <span class="keyword1"><span class="command">unfolding</span></span> names_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> val <span class="free">H</span> <span class="main">(</span>assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_def val_def hequiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> Pro <span class="skolem">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span>Nom <span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">b</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> someI_ex <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="var">?b</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="var">?b</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="var">?b</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> hequiv_proj assms<span class="main">(</span>1<span class="main">)</span> b * <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.Nom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="bound">c</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> someI_ex <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?c</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> Nom <span class="var">?c</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span> <span class="main">=</span> proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="var">?c</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹proj <span class="main">(</span>hequiv_rel <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> hequiv_proj_opening assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">=</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> Nom <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nom <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span>Nom <span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="skolem">a</span> <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> hequiv_refl * nominal_in_names assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ur_closure' assms<span class="main">(</span>1<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.NomP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span><span class="main">.</span> Nom <span class="skolem">a</span> <span class="keyword1">at</span> <span class="bound">b</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹hequiv <span class="free">H</span> <span class="skolem">a</span> <span class="skolem">a</span>›</span></span> ur_closure <span class="keyword1"><span class="command">unfolding</span></span> hequiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span> <span class="main">≠</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> Nom <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.NegN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dis <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.DisP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dis <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.DisN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dia <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">j</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> Nom <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ur_closure' assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ur_closure assms<span class="main">(</span>1<span class="main">)</span> a<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">j</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">H</span> <span class="main">(</span>assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> j<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ur_closure' assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> False assms <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Hintikka.DiaP<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">from</span></span> j<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.SatP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">j</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Dia p *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">j</span> <span class="main">∈</span> reach <span class="free">A</span> <span class="free">H</span> <span class="main">(</span>assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>1<span class="main">)</span> j<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dia <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ur_closure' assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> ur_closure <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">b</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.DiaN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Hintikka.SatN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">j</span> <span class="main">⊨</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Dia *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">a</span> <span class="main">=</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> a assign_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sat <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="bound">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> that assms<span class="main">(</span>1<span class="main">)</span> Hintikka.SatP <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sat <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="bound">a</span> <span class="keyword1">in'</span> <span class="free">H</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> that assms<span class="main">(</span>1<span class="main">)</span> Hintikka.SatN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="free">A</span> <span class="free">H</span><span class="main">)</span> <span class="main">(</span>val <span class="free">H</span><span class="main">)</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span><span class="main">,</span> assign <span class="free">A</span> <span class="free">H</span> <span class="skolem">i</span> <span class="main">⊨</span> <span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lindenbaum-Henkin›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A set of blocks is consistent if no finite subset can be derived.
  Given a consistent set of blocks we are going to extend it to be
    saturated and maximally consistent and show that is then Hintikka.
  All definitions are with respect to the set of allowed nominals.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">consistent</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">∄</span><span class="bound">S'</span><span class="main">.</span> set <span class="bound">S'</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊢</span> <span class="bound">S'</span>›</span></span>

<span class="keyword1"><span class="command">instance</span></span> fm <span class="main">::</span> <span class="main">(</span><span class="quoted">countable</span><span class="main">,</span> <span class="quoted">countable</span><span class="main">)</span> <span class="quoted">countable</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">countable_datatype</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proper_dia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm option›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">proper_dia</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="bound">p</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> Nom <span class="bound">a</span> <span class="keyword1">then</span> Some <span class="bound">p</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proper_dia<span class="main">:</span> <span class="quoted"><span class="quoted">‹proper_dia <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="free">q</span> <span class="main">=</span> Nom <span class="bound">a</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> proper_dia_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> option.discI option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function witnesses each <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>◇</b> p›</span></span></span></span> in a fresh world.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">witness_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fm list›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">witness_list</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">witness_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">used</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> proper_dia <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="free">witness_list</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">used</span></span></span>
    <span class="main">|</span> Some <span class="bound">q</span> <span class="main">⇒</span>
        <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">used</span></span></span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">i</span> <span class="bound">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">witness_list</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">used</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">witness</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">witness</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">used</span></span></span> <span class="main">=</span> <span class="main">(</span>witness_list <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">used</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> witness_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹proper_dia <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> witness_list <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="free">used</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free">used</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">i</span> <span class="free">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">#</span> witness_list <span class="free">ps</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="free">used</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">extend</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>›</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">‹<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> consistent <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
     <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">used</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">block</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> block_nominals <span class="bound">block</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> witness <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">used</span><span class="main">}</span> <span class="main">∪</span> <span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Extend</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">Extend</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> extend <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extend_chain<span class="main">:</span> <span class="quoted"><span class="quoted">‹extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span> <span class="main">⊆</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extend_mem<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">⊆</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_mem<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">⊆</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Extend_def <span class="keyword1"><span class="command">using</span></span> extend_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Consistency›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹set <span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈.</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">B</span><span class="main">.</span> set <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> set <span class="free">A</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> set <span class="bound">B</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb mk_disjoint_insert set_removeAll<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_drop_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cons<span class="main">:</span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">S'</span><span class="main">.</span> set <span class="bound">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">⊢</span> <span class="bound">S'</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">#</span> <span class="free">ps</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> cons <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_drop_block<span class="main">:</span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="free">block</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> consistent <span class="free">A</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> inconsistent_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> consistent <span class="free">A</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="main">¬</span> consistent <span class="free">A</span> <span class="free">S'</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_nominals_set<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="main">⋃</span><span class="bound">block</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> block_nominals <span class="bound">block</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_block_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> witness_list_used<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">used</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> list_nominals <span class="free">ps</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> list_nominals <span class="main">(</span>witness_list <span class="free">ps</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="free">used</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">used</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹proper_dia <span class="skolem">p</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">used</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf ex_new_if_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">∉</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> someI_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?j</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?j</span><span class="main">)</span> <span class="main">#</span> witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="main">{</span><span class="var">?j</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some witness_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹list_nominals <span class="main">(</span>witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{</span><span class="var">?j</span><span class="main">}</span> <span class="main">∪</span> nominals <span class="skolem">q</span> <span class="main">∪</span> list_nominals <span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="main">{</span><span class="var">?j</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">{</span><span class="var">?j</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">used</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> list_nominals <span class="skolem">ps</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> list_nominals <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> list_nominals <span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="var">?j</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="var">?j</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="var">?j</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="var">?j</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> list_nominals <span class="main">(</span>witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">∈</span> nominals <span class="skolem">q</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> nominals <span class="skolem">q</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> Some proper_dia <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> witness_used<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‹finite <span class="free">used</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> block_nominals <span class="free">block</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> block_nominals <span class="main">(</span>witness <span class="free">block</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="free">used</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms witness_list_used <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_witness_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">used</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">used</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span>witness_list <span class="free">ps</span> <span class="free">used</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">used</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">(</span>witness_list <span class="main">[]</span> <span class="skolem">used</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{}</span> <span class="main">∩</span> <span class="skolem">used</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4-5<span class="main">)</span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf fin consistent_drop_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">extra</span> <span class="main">∪</span> <span class="skolem">used</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">extra</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">used</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="skolem">extra</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">extra</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">extra</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹finite <span class="skolem">used</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> cons<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="skolem">extra</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">extra</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">extra</span>
    <span class="keyword1"><span class="command">using</span></span> that Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹proper_dia <span class="skolem">p</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span> witness_list <span class="skolem">ps</span> <span class="skolem">used</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="skolem">used</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">{}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="skolem">used</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> consistent_drop_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> block<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="skolem">used</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="skolem">used</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_new_if_finite inf <span class="quoted"><span class="quoted">‹finite <span class="skolem">used</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> someI_ex <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> <span class="skolem">used</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> <span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tail</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="var">?i</span><span class="main">}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> consistent_drop_block<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> block<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some witness_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> consistent_def
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">S'</span><span class="main">.</span> set <span class="bound">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">⊢</span> <span class="bound">S'</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span>
        <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
        <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> inf <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span>
        set <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> <span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> inf <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> STA_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> inf <span class="quoted"><span class="quoted">‹finite <span class="skolem">used</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span> witness_used <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> branch_nominals <span class="skolem">S''</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">using</span></span> i S' S'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> block_nominals <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∪</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">∉</span> <span class="skolem">used</span>›</span></span> Cons.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Some proper_dia <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈.</span> <span class="main">(</span><span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">q</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Some proper_dia <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="var">?tail</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> ** <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> DiaP'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">S</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> S' S'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_Un_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">block</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span>witness <span class="free">block</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms consistent_witness_list <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">block</span></span><span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span>extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span>extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?used</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">block</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">.</span> block_nominals <span class="bound">block</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">,</span> witness <span class="main">(</span><span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="var">?used</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>›</span></span> finite_nominals_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span>witness <span class="main">(</span><span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="var">?used</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf fin consistent_witness <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_nominals_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_block_nominals<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_extend'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span>extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> consistent_extend finite_nominals_extend<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> UN_finite_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">m</span> <span class="main">::</span> nat<span class="main">.</span> <span class="free">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">≤</span> <span class="bound">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">≤</span> <span class="skolem">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">m'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">≤</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> extend_bound<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">≤</span> <span class="free">m</span><span class="main">.</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">m</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋃</span> <span class="main">(</span>extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{..</span>Suc <span class="skolem">m</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{..</span><span class="skolem">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> atMost_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">m</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">=</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> extend_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_Extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
    <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span>Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Extend_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> consistent <span class="free">A</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>range <span class="main">(</span>extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span>
    <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>set <span class="skolem">S'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">≤</span> <span class="skolem">m</span><span class="main">.</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> UN_finite_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">m</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> extend_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span>extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">m</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms consistent_extend' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Maximality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A set of blocks is maximally consistent if any proper extension makes it inconsistent.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maximal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">maximal</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> consistent <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">block</span><span class="main">.</span> <span class="bound">block</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> <span class="main">¬</span> consistent <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="main">{</span><span class="bound">block</span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extend_not_mem<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">n</span> <span class="main">∉</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_left extend.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insertI1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> maximal_Extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
    <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹surj <span class="free">f</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="main">(</span>Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> maximal <span class="free">A</span> <span class="main">(</span>Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">block</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">block</span> <span class="main">∉</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="skolem">block</span><span class="main">}</span> <span class="main">∪</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> maximal_def <span class="keyword1"><span class="command">using</span></span> assms consistent_Extend <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">block</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹surj <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">block</span> <span class="main">∉</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">block</span> <span class="main">∉</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span> extend_chain <span class="keyword1"><span class="command">unfolding</span></span> Extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="skolem">block</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> n extend_not_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">block</span> <span class="main">∉</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">block</span> <span class="main">∉</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span> extend_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">block</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">block</span><span class="main">}</span> <span class="main">∪</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="skolem">block</span><span class="main">}</span> <span class="main">∪</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> inconsistent_weaken <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="skolem">block</span><span class="main">}</span> <span class="main">∪</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Saturation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A set of blocks is saturated if every <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">❙</span><b>◇</b> p›</span></span></span></span> is witnessed.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">saturated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set <span class="main">⇒</span> bool›</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">saturated</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="bound">i</span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">j</span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="bound">i</span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="bound">i</span> <span class="keyword1">in'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> witness_list_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">extra</span><span class="main">.</span> witness_list <span class="main">(</span><span class="free">ps</span> <span class="main">@</span> <span class="free">qs</span><span class="main">)</span> <span class="free">used</span> <span class="main">=</span> witness_list <span class="free">ps</span> <span class="free">used</span> <span class="main">@</span> witness_list <span class="free">qs</span> <span class="main">(</span><span class="bound">extra</span> <span class="main">∪</span> <span class="free">used</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">used</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_absorb append_self_conv2 witness_list.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> proper_dia <span class="skolem">p</span> <span class="main">=</span> Some <span class="bound">q</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="skolem">used</span>›</span></span>
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">‹proper_dia <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">q</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">@</span> <span class="free">qs</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">@</span> <span class="free">qs</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹witness_list <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">@</span> <span class="free">qs</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span>
       witness_list <span class="main">(</span><span class="skolem">ps</span> <span class="main">@</span> <span class="free">qs</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> witness_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">extra</span><span class="main">.</span> witness_list <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">@</span> <span class="free">qs</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span>
        witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span> <span class="main">@</span> witness_list <span class="free">qs</span> <span class="main">(</span><span class="bound">extra</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="var">?i</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="var">?i</span><span class="main">)</span> <span class="main">#</span> witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span> <span class="main">=</span>
        witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">used</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> q witness_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">extra</span><span class="main">.</span> witness_list <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">@</span> <span class="free">qs</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span>
        witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">@</span> witness_list <span class="free">qs</span> <span class="main">(</span><span class="bound">extra</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">extra</span><span class="main">.</span> witness_list <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">@</span> <span class="free">qs</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span>
        witness_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">@</span> witness_list <span class="free">qs</span> <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span> <span class="main">∪</span> <span class="bound">extra</span><span class="main">)</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_witness_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈.</span> <span class="free">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹proper_dia <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">i</span> <span class="free">q</span><span class="main">,</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span>witness_list <span class="free">ps</span> <span class="free">used</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈.</span> <span class="free">ps</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">used</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> witness_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">i</span> <span class="free">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">)</span> <span class="main">#</span>
        witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹proper_dia <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span>›</span></span> witness_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">i</span> <span class="free">q</span><span class="main">,</span> <span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="skolem">extra</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">extra</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">extra</span><span class="main">.</span> witness_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">used</span> <span class="main">=</span>
        witness_list <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="skolem">used</span> <span class="main">@</span> witness_list <span class="skolem">ps</span> <span class="main">(</span><span class="bound">extra</span> <span class="main">∪</span> <span class="skolem">used</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> witness_list_append<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">_</span><span class="main">]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> saturated_Extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹surj <span class="free">f</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹saturated <span class="main">(</span>Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> saturated_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="skolem">i</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹surj <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?used</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">block</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span><span class="main">.</span> block_nominals <span class="bound">block</span><span class="main">)</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span> <span class="main">⊆</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span>Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms consistent_Extend <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span> inconsistent_weaken <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="skolem">n</span><span class="main">,</span> witness <span class="main">(</span><span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="var">?used</span><span class="main">}</span> <span class="main">∪</span> extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹witness <span class="main">(</span><span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="var">?used</span> <span class="main">∈</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="var">?used</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">ps</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹proper_dia <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proper_dia_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span>
      <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="var">?used</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">j</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span>witness_list <span class="skolem">ps</span> <span class="var">?used</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_witness_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">qs</span><span class="main">.</span> <span class="main">(</span><span class="bound">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="bound">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">rs</span><span class="main">.</span> <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> Extend <span class="free">A</span> <span class="free">S</span> <span class="free">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">j</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Smullyan-Fitting›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Hintikka_Extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> block set›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹saturated <span class="free">S</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="free">A</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Hintikka_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">ps</span> <span class="skolem">qs</span> <span class="skolem">rs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">j</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹Pro <span class="skolem">x</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Pro <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Pro <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>2<span class="main">)</span> Close
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps set_subset_Cons subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> ps<span class="main">(</span>2<span class="main">)</span> rs<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' fm.distinct<span class="main"><span class="main">(</span></span>21<span class="main"><span class="main">)</span></span> fm.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_subset_Cons subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">ps</span> <span class="skolem">qs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">a</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> Nom <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">A</span> <span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> ps<span class="main">(</span>2<span class="main">)</span> qs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Close list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_subset_Cons subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">assume</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Neg' list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">i</span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">assume</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Sp'</span></span> <span class="skolem"><span class="skolem">np</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">np</span> <span class="main">⊢</span> <span class="skolem">Sp'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> Sp'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">Sp'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">Sp'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Sp''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Sp''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sp''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">Sp'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">Sp''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sp''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">np</span> <span class="main">⊢</span> <span class="skolem">Sp'</span>›</span></span> inf fin STA_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Sq'</span></span> <span class="skolem"><span class="skolem">nq</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">nq</span> <span class="main">⊢</span> <span class="skolem">Sq'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> Sq'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">Sq'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">Sq'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Sq''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Sq''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sq''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">Sq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">Sq''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sq''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">nq</span> <span class="main">⊢</span> <span class="skolem">Sq'</span>›</span></span> inf fin STA_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S''</span> <span class="main">=</span> set <span class="skolem">Sp''</span> <span class="main">∪</span> set <span class="skolem">Sq''</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> set_union<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sp''</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sq''</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sp''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Sq''</span>›</span></span> inf fin STA_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DisP'' list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps Sp' Sp'' Sq' Sq'' S'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">i</span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">assume</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> insert_is_Un insert_subset list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> on.simps
          set_subset_Cons subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DisN' list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">i</span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">assume</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="skolem">p</span> <span class="main"><span class="hidden">❙</span><b>∨</b></span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> insert_is_Un insert_subset list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> on.simps
          set_subset_Cons subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">q</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DisN' list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">j</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="bound">j</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹saturated <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> saturated_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">ps</span> <span class="skolem">qs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">j</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main">_</span><span class="main">]</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps<span class="main">(</span>2<span class="main">)</span> qs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DiaN' list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_subset_Cons subset_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps qs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">ps</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SatP' insert_iff list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">ps</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>@</b></span> <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">i</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">_</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SatN' insert_iff list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">ps</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> nominals <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">qs</span><span class="main">.</span> <span class="main">(</span><span class="bound">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">qs</span><span class="main">.</span> <span class="main">(</span><span class="bound">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> i ps <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">ps</span> <span class="skolem">qs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    p<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> Nom <span class="bound">a</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>◇</b></span> Nom <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ps<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    qs<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹Nom <span class="skolem">j</span> <span class="keyword1">on</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">at</span> <span class="skolem">j</span> <span class="keyword1">in'</span> <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">rs</span><span class="main">.</span> <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="keyword1">on</span> <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈.</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maximal_def consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> on.simps subset_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span>
      <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">S'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf fin STA_struct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> branch'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main">_</span><span class="main">]</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">⊢</span> <span class="skolem">S'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps<span class="main">(</span>2<span class="main">)</span> qs<span class="main">(</span>2<span class="main">)</span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Nom' in_mono list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_subset_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> branch_nominals <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> branch_nominals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> GoTo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">S''</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> S' S'' ps qs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="free">A</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Result›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> completeness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> countable<span class="main">,</span> <span class="tfree">'b</span> <span class="main">::</span> countable<span class="main">)</span> fm›</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">M</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span> set<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> model<span class="main">)</span> <span class="bound">g</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">M</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span><span class="main">,</span> <span class="main">1</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?A</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?A</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_nominals <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹consistent <span class="var">?A</span> <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">using</span></span> STA_struct inf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_set list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹Extend <span class="var">?A</span> <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span> from_nat›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>block_nominals <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_nominals_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹consistent <span class="var">?A</span> <span class="var">?S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> consistent_Extend inf * fin <span class="quoted"><span class="quoted">‹finite <span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹maximal <span class="var">?A</span> <span class="var">?S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> maximal_Extend inf * fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹saturated <span class="var">?S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> saturated_Extend inf * fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹Hintikka <span class="var">?A</span> <span class="var">?S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Hintikka_Extend inf <span class="quoted"><span class="quoted">‹finite <span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Extend_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Model <span class="main">(</span>reach <span class="var">?A</span> <span class="var">?S</span><span class="main">)</span> <span class="main">(</span>val <span class="var">?S</span><span class="main">)</span><span class="main">,</span> assign <span class="var">?A</span> <span class="var">?S</span><span class="main">,</span> assign <span class="var">?A</span> <span class="var">?S</span> <span class="free">i</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Hintikka_model<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> STA_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We arbitrarily fix nominal and propositional symbols to be natural numbers
  (any countably infinite type suffices) and
  define validity as truth in all models with sets of natural numbers as worlds.
  We show below that this implies validity for any type of worlds.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">‹<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">M</span> <span class="main">::</span> <span class="main">(</span>nat set<span class="main">,</span> nat<span class="main">)</span> model<span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">M</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A formula is valid iff its negation has a closing tableau from a fresh world.
  We can assume a single unit of potential and take the allowed nominals to be the root nominals.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> main<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> nominals <span class="free">p</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹valid <span class="free">p</span> <span class="main">⟷</span> nominals <span class="free">p</span><span class="main">,</span> <span class="main">1</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹valid <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span><span class="main">,</span> <span class="main">1</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> completeness <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹nominals <span class="free">p</span><span class="main">,</span> <span class="main">1</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹valid <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms soundness_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The restricted validity implies validity in general.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> valid_semantics<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹valid <span class="free">p</span> <span class="main">⟶</span> <span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‹valid <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> nominals <span class="free">p</span> <span class="main">⟹</span> nominals <span class="free">p</span> <span class="main">⊢</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main"><span class="hidden">❙</span><b>¬</b></span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> main <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> nominals <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_nominals ex_new_if_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> soundness_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>