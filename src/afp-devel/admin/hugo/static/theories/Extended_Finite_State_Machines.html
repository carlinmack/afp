<div id="Trilean">
<div class="head">
<h1>Theory Trilean</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this chapter, we introduce the preliminaries, including a three-valued logic, variables,
arithmetic expressions and guard expressions.›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Three-Valued Logic›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Because our EFSMs are dynamically typed, we cannot rely on conventional Boolean logic when
evaluating expressions. For example, we may end up in the situation where we need to evaluate
the guard $r_1 &gt; 5$. This is fine if $r_1$ holds a numeric value, but if $r_1$ evaluates to a
string, this causes problems. We cannot simply evaluate to \emph{false} because then the negation
would evaluate to \emph{true.} Instead, we need a three-valued logic such that we can meaningfully
evaluate nonsensical guards.

The \texttt{trilean} datatype is used to implement three-valued Bochvar logic
\cite{bochvar1981}. Here we prove that the logic is an idempotent semiring, define a partial order,
and prove some other useful lemmas.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Trilean
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> trilean <span class="main">=</span> true <span class="main">|</span> false <span class="main">|</span> invalid

<span class="keyword1"><span class="command">instantiation</span></span> trilean <span class="main">::</span> <span class="quoted">semiring</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">times_trilean</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trilean <span class="main">⇒</span> trilean <span class="main">⇒</span> trilean"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">times_trilean</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> invalid <span class="main">=</span> invalid"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">times_trilean</span> invalid <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> invalid"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">times_trilean</span> true true <span class="main">=</span> true"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">times_trilean</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> false <span class="main">=</span> false"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">times_trilean</span> false <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> false"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">plus_trilean</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trilean <span class="main">⇒</span> trilean <span class="main">⇒</span> trilean"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_trilean</span> invalid <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> invalid"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_trilean</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> invalid <span class="main">=</span> invalid"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_trilean</span> true <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> true"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_trilean</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> true <span class="main">=</span> true"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_trilean</span> false false <span class="main">=</span> false"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">maybe_and</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trilean <span class="main">⇒</span> trilean <span class="main">⇒</span> trilean"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∧?</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maybe_and</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">maybe_or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trilean <span class="main">⇒</span> trilean <span class="main">⇒</span> trilean"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∨?</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maybe_or</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Trilean-plus_trilean_assoc"><span class="command">lemma</span></span> plus_trilean_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∨?</span> <span class="free">b</span> <span class="main">∨?</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∨?</span> <span class="main">(</span><span class="free">b</span> <span class="main">∨?</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span>  <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> plus_trilean.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">uu</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_1"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_2"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_1"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_trilean.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_2"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_trilean.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_trilean.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trilean-plus_trilean_commutative"><span class="command">lemma</span></span> plus_trilean_commutative<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∨?</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨?</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> plus_trilean.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">uu</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Trilean-times_trilean_commutative"><span class="command">lemma</span></span> times_trilean_commutative<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∧?</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧?</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> times_trilean.simps trilean.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>

<span class="keyword1" id="Trilean-times_trilean_assoc"><span class="command">lemma</span></span> times_trilean_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∧?</span> <span class="free">b</span> <span class="main">∧?</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧?</span> <span class="main">(</span><span class="free">b</span> <span class="main">∧?</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span>  <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> plus_trilean.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">uu</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean_commutative<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_1"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean_commutative<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_2"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean_commutative<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_1"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_2"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trilean-trilean_distributivity_1"><span class="command">lemma</span></span> trilean_distributivity_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">∨?</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧?</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧?</span> <span class="free">c</span> <span class="main">∨?</span> <span class="free">b</span> <span class="main">∧?</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> times_trilean.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">uu</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_trilean_commutative times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean_commutative<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_1"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean_commutative<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_2"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean_commutative<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"4_1"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"4_2"</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> trilean.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_trilean_assoc<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_trilean_commutative<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_trilean_assoc<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trilean_distributivity_1<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> times_trilean_commutative trilean_distributivity_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Trilean-maybe_or_idempotent"><span class="command">lemma</span></span> maybe_or_idempotent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∨?</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Trilean-maybe_and_idempotent"><span class="command">lemma</span></span> maybe_and_idempotent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∧?</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instantiation</span></span> trilean <span class="main">::</span> <span class="quoted">ord</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_trilean</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trilean <span class="main">⇒</span> trilean <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_trilean</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_trilean</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trilean <span class="main">⇒</span> trilean <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_trilean</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> less_trilean_def less_eq_trilean_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> trilean <span class="main">::</span> <span class="quoted">uminus</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">maybe_not</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trilean <span class="main">⇒</span> trilean"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">¬?</span> _"</span> <span class="main">[</span>60<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">¬?</span></span> true <span class="main">=</span> false"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">¬?</span></span> false <span class="main">=</span> true"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">¬?</span></span> invalid <span class="main">=</span> invalid"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Trilean-maybe_and_one"><span class="command">lemma</span></span> maybe_and_one<span class="main">:</span> <span class="quoted"><span class="quoted">"true <span class="main">∧?</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Trilean-maybe_or_zero"><span class="command">lemma</span></span> maybe_or_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"false <span class="main">∨?</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Trilean-maybe_double_negation"><span class="command">lemma</span></span> maybe_double_negation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬?</span> <span class="main">¬?</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Trilean-maybe_negate_true"><span class="command">lemma</span></span> maybe_negate_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬?</span> <span class="free">x</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> false<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Trilean-maybe_negate_false"><span class="command">lemma</span></span> maybe_negate_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬?</span> <span class="free">x</span> <span class="main">=</span> false<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Trilean-maybe_and_true"><span class="command">lemma</span></span> maybe_and_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∧?</span> <span class="free">y</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> true <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> times_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_and_not_true"><span class="command">lemma</span></span> maybe_and_not_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∧?</span> <span class="free">y</span> <span class="main">≠</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> true <span class="main">∨</span> <span class="free">y</span> <span class="main">≠</span> true<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_and_true<span class="main">)</span>

<span class="keyword1" id="Trilean-negate_valid"><span class="command">lemma</span></span> negate_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬?</span> <span class="free">x</span> <span class="main">≠</span> invalid<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_double_negation maybe_not.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Trilean-maybe_and_valid"><span class="command">lemma</span></span> maybe_and_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∧?</span> <span class="free">y</span> <span class="main">≠</span> invalid <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> invalid <span class="main">∧</span> <span class="free">y</span> <span class="main">≠</span> invalid"</span></span>
  <span class="keyword1"><span class="command">using</span></span> times_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_or_valid"><span class="command">lemma</span></span> maybe_or_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∨?</span> <span class="free">y</span> <span class="main">≠</span> invalid <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> invalid <span class="main">∧</span> <span class="free">y</span> <span class="main">≠</span> invalid"</span></span>
  <span class="keyword1"><span class="command">using</span></span> plus_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_or_false"><span class="command">lemma</span></span> maybe_or_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∨?</span> <span class="free">y</span> <span class="main">=</span> false<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> false <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> false<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> plus_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_or_true"><span class="command">lemma</span></span> maybe_or_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∨?</span> <span class="free">y</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">=</span> true <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> invalid <span class="main">∧</span> <span class="free">y</span> <span class="main">≠</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> plus_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_not_invalid"><span class="command">lemma</span></span> maybe_not_invalid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬?</span> <span class="free">x</span> <span class="main">=</span> invalid<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_double_negation maybe_not.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Trilean-maybe_or_invalid"><span class="command">lemma</span></span> maybe_or_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∨?</span> <span class="free">y</span> <span class="main">=</span> invalid<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> invalid <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> plus_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_and_invalid"><span class="command">lemma</span></span> maybe_and_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∧?</span> <span class="free">y</span> <span class="main">=</span> invalid<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> invalid <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> times_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_and_false"><span class="command">lemma</span></span> maybe_and_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∧?</span> <span class="free">y</span> <span class="main">=</span> false<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">=</span> false <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> false<span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> invalid <span class="main">∧</span> <span class="free">y</span> <span class="main">≠</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> times_trilean.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-invalid_maybe_and"><span class="command">lemma</span></span> invalid_maybe_and<span class="main">:</span> <span class="quoted"><span class="quoted">"invalid <span class="main">∧?</span> <span class="free">x</span> <span class="main">=</span> invalid"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maybe_and_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Trilean-maybe_not_eq"><span class="command">lemma</span></span> maybe_not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬?</span> <span class="free">x</span> <span class="main">=</span> <span class="main">¬?</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_double_negation<span class="main">)</span>

<span class="keyword1" id="Trilean-de_morgans_1"><span class="command">lemma</span></span> de_morgans_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬?</span> <span class="main">(</span><span class="free">a</span> <span class="main">∨?</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬?</span><span class="free">a</span><span class="main">)</span> <span class="main">∧?</span> <span class="main">(</span><span class="main">¬?</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.commute invalid_maybe_and maybe_and_idempotent maybe_and_one maybe_not.elims maybe_not.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> maybe_not.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> maybe_not_invalid maybe_or_zero plus_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> times_trilean.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> times_trilean_commutative trilean.exhaust trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Trilean-de_morgans_2"><span class="command">lemma</span></span> de_morgans_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬?</span> <span class="main">(</span><span class="free">a</span> <span class="main">∧?</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬?</span><span class="free">a</span><span class="main">)</span> <span class="main">∨?</span> <span class="main">(</span><span class="main">¬?</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> de_morgans_1 maybe_double_negation<span class="main">)</span>

<span class="keyword1" id="Trilean-not_true"><span class="command">lemma</span></span> not_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">≠</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> false <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> maybe_not.cases trilean.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> trilean.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Trilean-pull_negation"><span class="command">lemma</span></span> pull_negation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">¬?</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬?</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maybe_double_negation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Trilean-comp_fun_commute_maybe_or"><span class="command">lemma</span></span> comp_fun_commute_maybe_or<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute maybe_or"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.left_commute<span class="main">)</span>

<span class="keyword1" id="Trilean-comp_fun_commute_maybe_and"><span class="command">lemma</span></span> comp_fun_commute_maybe_and<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute maybe_and"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_commute de_morgans_2 maybe_not_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Value">
<div class="head">
<h1>Theory Value</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Values›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Our EFSM implementation can currently handle integers and strings. Here we define a sum type
which combines these. We also define an arithmetic in terms of values such that EFSMs do not need
to be strongly typed.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Value
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Trilean.html">Trilean</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{valuetype}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"value"</span> <span class="main">=</span> Num <span class="quoted">int</span> <span class="main">|</span> Str <span class="quoted">String.literal</span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_Num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_Num</span> <span class="main">(</span>Num <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_Num</span> <span class="main">(</span>Str <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{maybeIntArith}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">maybe_arith_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> int <span class="main">⇒</span> int<span class="main">)</span> <span class="main">⇒</span> value option <span class="main">⇒</span> value option <span class="main">⇒</span> value option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maybe_arith_int</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">maybe_arith_int</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="Value-maybe_arith_int_not_None"><span class="command">lemma</span></span> maybe_arith_int_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maybe_arith_int <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> None <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maybe_arith_int.elims maybe_arith_int.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Value-maybe_arith_int_Some"><span class="command">lemma</span></span> maybe_arith_int_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maybe_arith_int <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">n</span> <span class="bound">n'</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maybe_arith_int.elims maybe_arith_int.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Value-maybe_arith_int_None"><span class="command">lemma</span></span> maybe_arith_int_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>maybe_arith_int <span class="free">f</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∄</span><span class="bound">n</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">a1</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">a2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maybe_arith_int_not_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Value-maybe_arith_int_Not_Num"><span class="command">lemma</span></span> maybe_arith_int_Not_Num<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> maybe_arith_int <span class="free">f</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">≠</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>maybe_arith_int <span class="free">f</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_arith_int.elims option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Value-maybe_arith_int_never_string"><span class="command">lemma</span></span> maybe_arith_int_never_string<span class="main">:</span> <span class="quoted"><span class="quoted">"maybe_arith_int <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> Some <span class="main">(</span>Str <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maybe_arith_int.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">value_plus</span> <span class="main">=</span> maybe_arith_int <span class="main">(+)</span>"</span></span>

<span class="keyword1" id="Value-value_plus_never_string"><span class="command">lemma</span></span> value_plus_never_string<span class="main">:</span> <span class="quoted"><span class="quoted">"value_plus <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> Some <span class="main">(</span>Str <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_plus_def maybe_arith_int_never_string<span class="main">)</span>

<span class="keyword1" id="Value-value_plus_symmetry"><span class="command">lemma</span></span> value_plus_symmetry<span class="main">:</span> <span class="quoted"><span class="quoted">"value_plus <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> value_plus <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> maybe_arith_int.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_plus_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">value_minus</span> <span class="main">=</span> maybe_arith_int <span class="main">(-)</span>"</span></span>

<span class="keyword1" id="Value-value_minus_never_string"><span class="command">lemma</span></span> value_minus_never_string<span class="main">:</span> <span class="quoted"><span class="quoted">"value_minus <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> Some <span class="main">(</span>Str <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_arith_int_never_string value_minus_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">value_times</span> <span class="main">=</span> maybe_arith_int <span class="main">(*)</span>"</span></span>

<span class="keyword1" id="Value-value_times_never_string"><span class="command">lemma</span></span> value_times_never_string<span class="main">:</span> <span class="quoted"><span class="quoted">"value_times <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> Some <span class="main">(</span>Str <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_arith_int_never_string value_times_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">MaybeBoolInt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> int <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> value option <span class="main">⇒</span> value option <span class="main">⇒</span> trilean"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">MaybeBoolInt</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> true <span class="keyword1">else</span> false<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">MaybeBoolInt</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> invalid"</span></span>

<span class="keyword1" id="Value-MaybeBoolInt_not_num_1"><span class="command">lemma</span></span> MaybeBoolInt_not_num_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="main">≠</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> MaybeBoolInt <span class="free">f</span> <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> invalid"</span></span>
  <span class="keyword1"><span class="command">using</span></span> MaybeBoolInt.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">value_gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value option <span class="main">⇒</span> value option <span class="main">⇒</span> trilean"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">value_gt</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> MaybeBoolInt <span class="main">(&gt;)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">value_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value option <span class="main">⇒</span> value option <span class="main">⇒</span> trilean"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">value_eq</span> None <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> invalid"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value_eq</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> None <span class="main">=</span> invalid"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value_eq</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> true <span class="keyword1">else</span> false<span class="main">)</span>"</span></span>

<span class="keyword1" id="Value-value_eq_true"><span class="command">lemma</span></span> value_eq_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>value_eq <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Value-value_eq_false"><span class="command">lemma</span></span> value_eq_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>value_eq <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> false<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Value-value_gt_true_Some"><span class="command">lemma</span></span> value_gt_true_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"value_gt <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> true <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> value_gt_def<span class="main">)</span>

<span class="keyword1" id="Value-value_gt_true"><span class="command">lemma</span></span> value_gt_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>value_gt <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> value_gt_true_Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> value_gt_true_Some <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa bb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aa</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">bb</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> value_gt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Value-value_gt_false_Some"><span class="command">lemma</span></span> value_gt_false_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"value_gt <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> false <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> value_gt_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="VName">
<div class="head">
<h1>Theory VName</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Variables›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Variables can either be inputs or registers. Here we define the \texttt{vname} datatype which
allows us to write expressions in terms of variables and case match during evaluation. We also make
the \texttt{vname} datatype a member of linorder such that we can establish a linear order on
arithmetic expressions, guards, and subsequently transitions.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> VName
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{vnametype}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> vname <span class="main">=</span> I <span class="quoted">nat</span> <span class="main">|</span> R <span class="quoted">nat</span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> vname <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{vnameorder}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_vname</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> vname <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_vname</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> vname <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_vname</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> less_eq_vname_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> dual_order.asym less_eq_vname_def less_vname.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_vname.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_vname.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> vname.exhaust<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y z
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_vname.induct<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_vname_def less_vname.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_vname.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> vname.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_vname_def less_trans less_vname.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_vname.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> vname.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less_trans less_eq_vname_def less_imp_le_nat less_vname.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_vname.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> vname.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.asym less_eq_vname_def less_vname.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_vname.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_vname.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_vname.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Value_Lexorder">
<div class="head">
<h1>Theory Value_Lexorder</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Value Lexorder›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory defines a lexicographical ordering on values such that we can build orderings for
arithmetic expressions and guards. Here, numbers are defined as less than strings, else the natural
ordering on the respective datatypes is used.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Value_Lexorder
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Value.html">Value</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"value"</span> <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{valueorder}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_value</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Str <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Str <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Str <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Str <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_value</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_value</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> less_eq_value_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> less_imp_not_less less_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_value.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_value.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y z
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_value.induct<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_value_def less_value.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_value.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> value.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans less_eq_value_def less_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_value.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> value.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_value_def less_imp_not_less less_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_value.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_value.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_value.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AExp">
<div class="head">
<h1>Theory AExp</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Arithmetic Expressions›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
This theory defines a language of arithmetic expressions over variables and literal values. Here,
values are limited to integers and strings. Variables may be either inputs or registers. We also
limit ourselves to a simple arithmetic of addition, subtraction, and multiplication as a proof of
concept.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> AExp
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Value_Lexorder.html">Value_Lexorder</a> <a href="VName.html">VName</a> <a href="../FinFun/FinFun.html">FinFun.FinFun</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Option_ord.html">HOL-Library.Option_ord</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> One_nat_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">unbundle</span></span> finfun_syntax

<span class="keyword1"><span class="command">type_synonym</span></span> registers <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="keyword1">⇒f</span> value option"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> datastate <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> value option"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{aexptype}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> aexp <span class="main">=</span> L <span class="quoted"><span class="quoted">"value"</span></span> <span class="main">|</span> V <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Plus <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="main">|</span> Minus <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="main">|</span> Times <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lit</span> <span class="main">(</span>L <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lit</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="AExp-aexp_induct_separate_V_cases"><span class="command">lemma</span></span> aexp_induct_separate_V_cases  <span class="main">[</span><span class="operator">case_names</span> L I R Plus Minus Times<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>L <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>V <span class="main">(</span>R <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">x1a</span> <span class="bound">x2a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x1a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x2a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Plus <span class="bound">x1a</span> <span class="bound">x2a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">x1a</span> <span class="bound">x2a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x1a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x2a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Minus <span class="bound">x1a</span> <span class="bound">x2a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">x1a</span> <span class="bound">x2a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x1a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x2a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Times <span class="bound">x1a</span> <span class="bound">x2a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aexp.induct vname.exhaust<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> datastate <span class="main">⇒</span> value option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> value_plus <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> value_minus <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> value_times <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="AExp-aval_plus_symmetry"><span class="command">lemma</span></span> aval_plus_symmetry<span class="main">:</span> <span class="quoted"><span class="quoted">"aval <span class="main">(</span>Plus <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> aval <span class="main">(</span>Plus <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_plus_symmetry<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A little syntax magic to write larger states compactly:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">null_state</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;&gt;</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">null_state</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">K$</span> bot<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> finfun_update <span class="main">(</span><span class="quoted">"_<span class="keyword1">'(</span>_ <span class="keyword1">$:=</span> _<span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword1"><span class="command">nonterminal</span></span> fupdbinds <span class="keyword2"><span class="keyword">and</span></span> fupdbind

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_fupdbind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> fupdbind"</span></span>             <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">$:=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span><span class="main">)</span>
  <span class="quoted">""</span>         <span class="main">::</span> <span class="quoted"><span class="quoted">"fupdbind <span class="main">⇒</span> fupdbinds"</span></span>             <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
  <span class="quoted">"_fupdbinds"</span><span class="main">::</span> <span class="quoted"><span class="quoted">"fupdbind <span class="main">⇒</span> fupdbinds <span class="main">⇒</span> fupdbinds"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span><span class="keyword3">/ </span>_"</span><span class="main">)</span>
  <span class="quoted">"_fUpdate"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> fupdbinds <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>            <span class="main">(</span><span class="quoted">"_<span class="keyword3">/</span><span class="keyword1">'(</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">]</span> 900<span class="main">)</span>
  <span class="quoted">"_State"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fupdbinds <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_fUpdate <span class="free">f</span> <span class="main">(</span>_fupdbinds <span class="free">b</span> <span class="free">bs</span><span class="main">)</span>"</span> <span class="main">⇌</span> <span class="quoted">"_fUpdate <span class="main">(</span>_fUpdate <span class="free">f</span> <span class="free">b</span><span class="main">)</span> <span class="free">bs</span>"</span>
  <span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">$:=</span><span class="free">y</span><span class="main">)</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> finfun_update <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span>
  <span class="quoted">"_State <span class="free">ms</span>"</span> <span class="main">==</span> <span class="quoted">"_fUpdate <span class="main">&lt;&gt;</span> <span class="free">ms</span>"</span>
  <span class="quoted">"_State <span class="main">(</span>_updbinds <span class="free">b</span> <span class="free">bs</span><span class="main">)</span>"</span> <span class="main">&lt;=</span> <span class="quoted">"_fUpdate <span class="main">(</span>_State <span class="free">b</span><span class="main">)</span> <span class="free">bs</span>"</span>

<span class="keyword1" id="AExp-empty_None"><span class="command">lemma</span></span> empty_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;&gt;</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> null_state_def bot_option_def<span class="main">)</span>

<span class="keyword1" id="AExp-apply_empty_None"><span class="command">lemma</span></span> apply_empty_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;&gt;</span> <span class="main">$</span> <span class="free">x2</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> null_state_def bot_option_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">input2state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> registers"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input2state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">k</span> <span class="main">$:=</span> Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>enumerate <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">K$</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">input2state_prim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> nat <span class="main">⇒</span> registers"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input2state_prim</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">input2state_prim</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">input2state_prim</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">$:=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="AExp-input2state_append"><span class="command">lemma</span></span> input2state_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input2state <span class="main">(</span><span class="free">i</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>input2state <span class="free">i</span><span class="main">)</span><span class="main">(</span>length <span class="free">i</span> <span class="main">$:=</span> Some <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_finfun_All_ext finfun_All_def finfun_All_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_def enumerate_eq_zip<span class="main">)</span>

<span class="keyword1" id="AExp-input2state_out_of_bounds"><span class="command">lemma</span></span> input2state_out_of_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> length <span class="free">ia</span> <span class="main">⟹</span> input2state <span class="free">ia</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ia</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_def enumerate_eq_zip<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp-input2state_within_bounds"><span class="command">lemma</span></span> input2state_within_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input2state <span class="free">i</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> input2state_out_of_bounds not_le_imp_less option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AExp-input2state_empty"><span class="command">lemma</span></span> input2state_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"input2state <span class="main">[]</span> <span class="main">$</span> <span class="free">x1</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_out_of_bounds<span class="main">)</span>

<span class="keyword1" id="AExp-input2state_nth"><span class="command">lemma</span></span> input2state_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ia</span> <span class="main">⟹</span> input2state <span class="free">ia</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ia</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ia</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ia</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_def enumerate_eq_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp-input2state_some"><span class="command">lemma</span></span> input2state_some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ia</span> <span class="main">⟹</span>
   <span class="free">ia</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span>
   input2state <span class="free">ia</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_nth<span class="main">)</span>

<span class="keyword1" id="AExp-input2state_take"><span class="command">lemma</span></span> input2state_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">&lt;</span> <span class="free">A</span> <span class="main">⟹</span>
   <span class="free">A</span> <span class="main">≤</span> length <span class="free">i</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">=</span> vname.I <span class="free">x1</span> <span class="main">⟹</span>
   input2state <span class="free">i</span> <span class="main">$</span> <span class="free">x1</span> <span class="main">=</span> input2state <span class="main">(</span>take <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">$</span> <span class="free">x1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp-input2state_not_None"><span class="command">lemma</span></span> input2state_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>input2state <span class="free">i</span> <span class="main">$</span> <span class="free">x</span> <span class="main">≠</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> length <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> input2state_within_bounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="AExp-input2state_Some"><span class="command">lemma</span></span> input2state_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> input2state <span class="free">i</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> length <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> input2state_within_bounds <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_nth<span class="main">)</span>

<span class="keyword1" id="AExp-input2state_cons"><span class="command">lemma</span></span> input2state_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span>
   <span class="free">x1</span> <span class="main">&lt;</span> length <span class="free">ia</span> <span class="main">⟹</span>
   input2state <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">ia</span><span class="main">)</span> <span class="main">$</span> <span class="free">x1</span> <span class="main">=</span> input2state <span class="free">ia</span> <span class="main">$</span> <span class="main">(</span><span class="free">x1</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_nth<span class="main">)</span>

<span class="keyword1" id="AExp-input2state_cons_shift"><span class="command">lemma</span></span> input2state_cons_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input2state <span class="free">i</span> <span class="main">$</span> <span class="free">x1</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> input2state <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">i</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span>Suc <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> input2state_within_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="free">x1</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> input2state_cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">x1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finfun_upd_apply input2state_append input2state_nth length_Cons length_append_singleton lessI list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_tl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp-input2state_exists"><span class="command">lemma</span></span> input2state_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> input2state <span class="bound">i</span> <span class="main">$</span> <span class="free">x1</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span><span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_cons_shift<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">repeat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">repeat</span> <span class="main">0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">repeat</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">repeat</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="AExp-length_repeat"><span class="command">lemma</span></span> length_repeat<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp-length_append_repeat"><span class="command">lemma</span></span> length_append_repeat<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">i</span><span class="main">@</span><span class="main">(</span>repeat <span class="free">a</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> length <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AExp-length_input2state_repeat"><span class="command">lemma</span></span> length_input2state_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input2state <span class="free">i</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">i</span> <span class="main">@</span> repeat <span class="free">y</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> append_eq_append_conv input2state_within_bounds length_append length_repeat list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> neqE not_add_less2 zero_order<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AExp-input2state_double_exists"><span class="command">lemma</span></span> input2state_double_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> input2state <span class="bound">i</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">∧</span> input2state <span class="bound">i</span> <span class="main">$</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> input2state_exists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="improper">i</span> <span class="free">y</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> input2state_within_bounds input2state_nth input2state_out_of_bounds le_trans length_list_update not_le_imp_less nth_list_update_eq nth_list_update_neq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="main">(</span><span class="improper">i</span><span class="main">@</span><span class="main">(</span>repeat <span class="free">y</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_input2state_repeat input2state_nth input2state_out_of_bounds le_trans length_append_repeat length_list_update not_le_imp_less nth_append nth_list_update_eq nth_list_update_neq option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AExp-input2state_double_exists_2"><span class="command">lemma</span></span> input2state_double_exists_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> input2state <span class="bound">i</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">∧</span> input2state <span class="bound">i</span> <span class="main">$</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">a'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> input2state_exists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="improper">i</span> <span class="free">y</span> <span class="free">a'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> input2state_within_bounds input2state_nth input2state_out_of_bounds le_trans length_list_update not_le_imp_less nth_list_update_eq nth_list_update_neq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="main">(</span><span class="improper">i</span><span class="main">@</span><span class="main">(</span>repeat <span class="free">y</span> <span class="free">a'</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="free">a'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> input2state_nth input2state_within_bounds le_trans length_append_repeat length_list_update linorder_not_le nth_append nth_list_update_neq order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> input2state_nth length_append length_input2state_repeat length_list_update length_repeat nth_list_update_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">join_ir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> registers <span class="main">⇒</span> vname datastate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join_ir</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
    R <span class="bound">n</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">$</span> <span class="bound">n</span> <span class="main">|</span>
    I <span class="bound">n</span> <span class="main">⇒</span> <span class="main">(</span>input2state <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> datastate <span class="main">=</span> join_ir_def input2state_def

<span class="keyword1" id="AExp-join_ir_empty"><span class="command">lemma</span></span> join_ir_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">[]</span> <span class="main">&lt;&gt;</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_None<span class="main">)</span>

<span class="keyword1" id="AExp-join_ir_R"><span class="command">lemma</span></span> join_ir_R <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>R <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">$</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>

<span class="keyword1" id="AExp-join_ir_double_exists"><span class="command">lemma</span></span> join_ir_double_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> join_ir <span class="bound">i</span> <span class="bound">r</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">∧</span> join_ir <span class="bound">i</span> <span class="bound">r</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">x1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_double_exists input2state_exists<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> input2state_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>R <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> input2state_exists <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">using</span></span> input2state_double_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp-join_ir_double_exists_2"><span class="command">lemma</span></span> join_ir_double_exists_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">v'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> join_ir <span class="bound">i</span> <span class="bound">r</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">∧</span> join_ir <span class="bound">i</span> <span class="bound">r</span> <span class="free">v'</span> <span class="main">=</span> Some <span class="free">a'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">x1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I input2state_exists 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def input2state_double_exists_2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>R <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> R input2state_exists <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="skolem">x2</span> <span class="main">$:=</span> Some <span class="free">a</span><span class="main">,</span><span class="improper">x2a</span> <span class="main">$:=</span> Some <span class="free">a'</span><span class="main">&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp-exists_join_ir_ext"><span class="command">lemma</span></span> exists_join_ir_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> join_ir <span class="bound">i</span> <span class="bound">r</span> <span class="free">v</span> <span class="main">=</span> <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_out_of_bounds<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">&lt;&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_exists<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="improper">x2</span> <span class="main">$:=</span> Some <span class="improper">a</span><span class="main">&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="AExp-join_ir_nth"><span class="command">lemma</span></span> join_ir_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">is</span> <span class="main">⟹</span> join_ir <span class="free">is</span> <span class="free">r</span> <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">is</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def input2state_nth<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aexp_constrains</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_constrains</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_constrains</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_constrains</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free">aexp_constrains</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="free">aexp_constrains</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_constrains</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free">aexp_constrains</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="free">aexp_constrains</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_constrains</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free">aexp_constrains</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="free">aexp_constrains</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aexp_same_structure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_same_structure</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_same_structure</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_same_structure</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">aexp_same_structure</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="main">∧</span> <span class="free">aexp_same_structure</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_same_structure</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">aexp_same_structure</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="main">∧</span> <span class="free">aexp_same_structure</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp_same_structure</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_aexp_inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_inputs</span> <span class="main">(</span>L <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_inputs</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_inputs</span> <span class="main">(</span>V <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_inputs</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_inputs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_inputs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_inputs</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_inputs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_inputs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_inputs</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_inputs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_inputs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span>

<span class="keyword1" id="AExp-enumerate_aexp_inputs_list"><span class="command">lemma</span></span> enumerate_aexp_inputs_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> enumerate_aexp_inputs <span class="free">a</span> <span class="main">=</span> set <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>L <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> empty_set enumerate_aexp_inputs.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enumerate_aexp_inputs.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enumerate_aexp_inputs.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enumerate_aexp_inputs.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>L <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>V <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>V <span class="main">(</span>I <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span>

<span class="keyword1" id="AExp-finite_enumerate_regs"><span class="command">lemma</span></span> finite_enumerate_regs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>enumerate_regs <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp-no_variables_aval"><span class="command">lemma</span></span> no_variables_aval<span class="main">:</span> <span class="quoted"><span class="quoted">"enumerate_aexp_inputs <span class="free">a</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   enumerate_regs <span class="free">a</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   aval <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> aval <span class="free">a</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp-enumerate_aexp_inputs_not_empty"><span class="command">lemma</span></span> enumerate_aexp_inputs_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>enumerate_aexp_inputs <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> enumerate_aexp_inputs <span class="free">a</span> <span class="main">=</span> set <span class="main">(</span><span class="bound">b</span><span class="main">#</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> enumerate_aexp_inputs_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="AExp-aval_ir_take"><span class="command">lemma</span></span> aval_ir_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> length <span class="free">i</span> <span class="main">⟹</span>
  enumerate_regs <span class="free">a</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
  enumerate_aexp_inputs <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
  Max <span class="main">(</span>enumerate_aexp_inputs <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">A</span> <span class="main">⟹</span>
  aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="main">(</span>take <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">ra</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>L <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def input2state_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> enumerate_aexp_inputs_not_empty<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Plus <span class="skolem">a1</span> <span class="skolem">a2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> neq_Nil_conv List.linorder_class.Max.set_eq_fold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"fold max <span class="improper">c</span> <span class="improper">b</span> <span class="main">≤</span> length <span class="free">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union Plus.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> enumerate_aexp_inputs.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> enumerate_aexp_inputs_not_empty max_less_iff_conj no_variables_aval sup_bot.left_neutral sup_bot.right_neutral<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> enumerate_aexp_inputs_not_empty<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Minus <span class="skolem">a1</span> <span class="skolem">a2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> neq_Nil_conv List.linorder_class.Max.set_eq_fold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"fold max <span class="improper">c</span> <span class="improper">b</span> <span class="main">≤</span> length <span class="free">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union Minus.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> enumerate_aexp_inputs.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> enumerate_aexp_inputs_not_empty max_less_iff_conj no_variables_aval sup_bot.left_neutral sup_bot.right_neutral<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> enumerate_aexp_inputs_not_empty<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Times <span class="skolem">a1</span> <span class="skolem">a2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> neq_Nil_conv List.linorder_class.Max.set_eq_fold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"fold max <span class="improper">c</span> <span class="improper">b</span> <span class="main">≤</span> length <span class="free">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union Times.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> enumerate_aexp_inputs.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> enumerate_aexp_inputs_not_empty max_less_iff_conj no_variables_aval sup_bot.left_neutral sup_bot.right_neutral<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_input</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">inputs</span> <span class="main">=</span> <span class="main">(</span>enumerate_aexp_inputs <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">inputs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max <span class="bound">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_reg</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">regs</span> <span class="main">=</span> <span class="main">(</span>enumerate_regs <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">regs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max <span class="bound">regs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="AExp-max_reg_V_I"><span class="command">lemma</span></span> max_reg_V_I<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>V <span class="main">(</span>I <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def<span class="main">)</span>

<span class="keyword1" id="AExp-max_reg_V_R"><span class="command">lemma</span></span> max_reg_V_R<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>V <span class="main">(</span>R <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> max_reg_V <span class="main">=</span> max_reg_V_I max_reg_V_R

<span class="keyword1" id="AExp-max_reg_Plus"><span class="command">lemma</span></span> max_reg_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>Plus <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_reg <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>max_reg <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.union bot_option_def finite_enumerate_regs max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="AExp-max_reg_Minus"><span class="command">lemma</span></span> max_reg_Minus<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>Minus <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_reg <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>max_reg <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.union bot_option_def finite_enumerate_regs max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="AExp-max_reg_Times"><span class="command">lemma</span></span> max_reg_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>Times <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_reg <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>max_reg <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.union bot_option_def finite_enumerate_regs max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="AExp-no_reg_aval_swap_regs"><span class="command">lemma</span></span> no_reg_aval_swap_regs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_reg <span class="free">a</span> <span class="main">=</span> None <span class="main">⟹</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def max_reg_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> max.absorb2 max.cobounded2 max_reg_Plus sup_None_2 sup_max<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> max.cobounded2 max_def_raw max_reg_Minus sup_None_2 sup_max<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bot <span class="main">=</span> max_reg <span class="skolem">a2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Times.prems bot_option_def max.left_commute max_bot2 max_def_raw max_reg_Times<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Times.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Times.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Times.prems aval.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> bot_option_def max_bot2 max_reg_Times<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AExp-aval_reg_some_superset"><span class="command">lemma</span></span> aval_reg_some_superset<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="bound">a</span>  <span class="main">≠</span> None<span class="main">)</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">⟹</span>
 aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span>
 aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r'</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">x1a</span> <span class="skolem">x2a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_arith_int_not_None option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> value_plus_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minus <span class="skolem">x1a</span> <span class="skolem">x2a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_arith_int_not_None option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> value_minus_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">x1a</span> <span class="skolem">x2a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_arith_int_not_None option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> value_times_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AExp-aval_reg_none_superset"><span class="command">lemma</span></span> aval_reg_none_superset<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="bound">a</span>  <span class="main">≠</span> None<span class="main">)</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">⟹</span>
 aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r'</span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span>
 aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> maybe_arith_int_None Plus.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> aval_reg_some_superset value_plus_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minus <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> maybe_arith_int_None Minus.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> aval_reg_some_superset value_minus_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> maybe_arith_int_None Times.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> aval_reg_some_superset value_times_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AExp-enumerate_regs_empty_reg_unconstrained"><span class="command">lemma</span></span> enumerate_regs_empty_reg_unconstrained<span class="main">:</span>
  <span class="quoted"><span class="quoted">"enumerate_regs <span class="free">a</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>R <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp-enumerate_aexp_inputs_empty_input_unconstrained"><span class="command">lemma</span></span> enumerate_aexp_inputs_empty_input_unconstrained<span class="main">:</span>
  <span class="quoted"><span class="quoted">"enumerate_aexp_inputs <span class="free">a</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp-input_unconstrained_aval_input_swap"><span class="command">lemma</span></span> input_unconstrained_aval_input_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i'</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join_ir_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp-input_unconstrained_aval_register_swap"><span class="command">lemma</span></span> input_unconstrained_aval_register_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>R <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join_ir_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp-unconstrained_variable_swap_aval"><span class="command">lemma</span></span> unconstrained_variable_swap_aval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>R <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   aval <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> aval <span class="free">a</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp-max_input_I"><span class="command">lemma</span></span> max_input_I<span class="main">:</span> <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_def<span class="main">)</span>

<span class="keyword1" id="AExp-max_input_Plus"><span class="command">lemma</span></span> max_input_Plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>Plus <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_input <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>max_input <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_def Let_def max.commute max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union enumerate_aexp_inputs_list sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="AExp-max_input_Minus"><span class="command">lemma</span></span> max_input_Minus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>Minus <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_input <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>max_input <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_def Let_def max.commute max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union enumerate_aexp_inputs_list sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="AExp-max_input_Times"><span class="command">lemma</span></span> max_input_Times<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>Times <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_input <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>max_input <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_def Let_def max.commute max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union enumerate_aexp_inputs_list sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="AExp-aval_take"><span class="command">lemma</span></span> aval_take<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input <span class="free">x</span> <span class="main">&lt;</span> Some <span class="free">a</span> <span class="main">⟹</span>
   aval <span class="free">x</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">x</span> <span class="main">(</span>join_ir <span class="main">(</span>take <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> input2state_take join_ir_def le_cases less_option_Some max_input_I take_all vname.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>R <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">x1a</span> <span class="skolem">x2a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_Plus<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minus <span class="skolem">x1a</span> <span class="skolem">x2a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_Minus<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">x1a</span> <span class="skolem">x2a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_Times<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AExp-aval_no_reg_swap_regs"><span class="command">lemma</span></span> aval_no_reg_swap_regs<span class="main">:</span> <span class="quoted"><span class="quoted">"max_input <span class="free">x</span> <span class="main">&lt;</span> Some <span class="free">a</span> <span class="main">⟹</span>
   max_reg <span class="free">x</span> <span class="main">=</span> None <span class="main">⟹</span>
   aval <span class="free">x</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">ra</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">x</span> <span class="main">(</span>join_ir <span class="main">(</span>take <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> aval_take enumerate_regs.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> enumerate_regs_empty_reg_unconstrained input_unconstrained_aval_register_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aval_take no_reg_aval_swap_regs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minus <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aval_take no_reg_aval_swap_regs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aval_take no_reg_aval_swap_regs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_aexp_strings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> String.literal set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_strings</span> <span class="main">(</span>L <span class="main">(</span>Str <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_strings</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_strings</span> <span class="main">(</span>V <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_strings</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_strings</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_strings</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_strings</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_strings</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_strings</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_strings</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_strings</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_strings</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_aexp_ints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_ints</span> <span class="main">(</span>L <span class="main">(</span>Str <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_ints</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_ints</span> <span class="main">(</span>V <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_ints</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_ints</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_ints</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_ints</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_ints</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_ints</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_aexp_ints</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_aexp_ints</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_aexp_ints</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_vars</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>image I <span class="main">(</span>enumerate_aexp_inputs <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>image R <span class="main">(</span>enumerate_regs <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rename_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> vname aexp <span class="main">⇒</span> vname aexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>V <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>V <span class="main">(</span>R <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Minus <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_upto_rename</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> vname aexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_upto_rename</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span> <span class="main">∧</span> rename_regs <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AExp_Lexorder">
<div class="head">
<h1>Theory AExp_Lexorder</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹AExp Lexorder›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory defines a lexicographical ordering on arithmetic expressions such that we can build
orderings for guards and, subsequently, transitions. We make use of the previously established
orderings on variable names and values.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> AExp_Lexorder
<span class="keyword2"><span class="keyword">imports</span></span> <a href="AExp.html">AExp</a> <a href="Value_Lexorder.html">Value_Lexorder</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{height}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">height</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> nat"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> aexp <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">less_aexp_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> bool"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">less_aexp_aux</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">less_aexp_aux</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span><span class="free">less_aexp_aux</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">less_aexp_aux</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span><span class="free">less_aexp_aux</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">less_aexp_aux</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp_aux</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_aexp</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_aexp</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">h1</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">;</span>
      <span class="bound">h2</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">a2</span></span></span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">h1</span> <span class="main">=</span> <span class="bound">h2</span> <span class="keyword1">then</span>
      less_aexp_aux <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>
    <span class="keyword1">else</span>
      <span class="bound">h1</span> <span class="main">&lt;</span> <span class="bound">h2</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_aexp</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">less_eq_aexp</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> less_aexp_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="AExp_Lexorder-less_aexp_aux_antisym"><span class="command">lemma</span></span> less_aexp_aux_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"less_aexp_aux <span class="free">x</span>  <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span>less_aexp_aux <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_aexp_aux.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp_Lexorder-less_aexp_antisym"><span class="command">lemma</span></span> less_aexp_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span> aexp<span class="main">)</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="free">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> less_aexp_aux_antisym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AExp_Lexorder-less_aexp_aux_trans"><span class="command">lemma</span></span> less_aexp_aux_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"less_aexp_aux <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> less_aexp_aux <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> less_aexp_aux <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_aexp_aux.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_1"</span> <span class="skolem">l1</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_2"</span> <span class="skolem">l1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_3"</span> <span class="skolem">l1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_4"</span> <span class="skolem">l1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v1</span> <span class="skolem">l1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">v1</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_1"</span> <span class="skolem">v1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_2"</span> <span class="skolem">v1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_3"</span> <span class="skolem">v1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"9_1"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"9_2"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_1"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_2"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_3"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_1"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_2"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_3"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_4"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AExp_Lexorder-less_aexp_trans"><span class="command">lemma</span></span> less_aexp_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span> aexp<span class="main">)</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> AExp_Lexorder.less_aexp_aux_trans dual_order.asym<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_aexp_antisym less_eq_aexp_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_aexp_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_aexp_trans less_eq_aexp_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> less_eq_aexp_def <span class="keyword1"><span class="command">using</span></span> less_aexp_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> less_eq_aexp_def <span class="keyword1"><span class="command">using</span></span> less_aexp_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="AExp_Lexorder-smaller_height"><span class="command">lemma</span></span> smaller_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="free">a1</span> <span class="main">&lt;</span> height <span class="free">a2</span> <span class="main">⟹</span> <span class="free">a1</span> <span class="main">&lt;</span> <span class="free">a2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="GExp">
<div class="head">
<h1>Theory GExp</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Guards Expressions›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
This theory defines the guard language of EFSMs which can be translated directly to and from
contexts. Boolean values true and false respectively represent the guards which are always and never
satisfied. Guards may test for (in)equivalence of two arithmetic expressions or be connected using
\textsc{nor} logic into compound expressions. The use of \textsc{nor} logic reduces the number of
subgoals when inducting over guard expressions.

We also define syntax hacks for the relations less than, less than or equal to, greater than or
equal to, and not equal to as well as the expression of logical conjunction, disjunction, and
negation in terms of nor logic.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> GExp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="AExp.html">AExp</a> <a href="Trilean.html">Trilean</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{gexptype}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> gexp <span class="main">=</span> Bc <span class="quoted">bool</span> <span class="main">|</span> Eq <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="main">|</span> Gt <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp"</span></span> <span class="main">|</span> In <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"value list"</span></span> <span class="main">|</span>  Nor <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> datastate <span class="main">⇒</span> trilean"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gval</span> <span class="main">(</span>Bc True<span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> true"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gval</span> <span class="main">(</span>Bc False<span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> false"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gval</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> value_gt <span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gval</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> value_eq <span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gval</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> invalid <span class="main">|</span> Some <span class="bound">vv</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">vv</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> true <span class="keyword1">else</span> false<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gval</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">¬?</span> <span class="main">(</span><span class="main">(</span><span class="free">gval</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∨?</span> <span class="main">(</span><span class="free">gval</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{connectives}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gNot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gNot</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> Nor <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gOr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="comment1">(*infix "∨" 60*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gOr</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="main">≡</span> Nor <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gAnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="comment1">(*infix "∧" 60*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gAnd</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="main">≡</span> Nor <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gImplies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gImplies</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> gOr <span class="main">(</span>gNot <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Lt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="comment1">(*infix "&lt;" 60*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Lt</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> Gt <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="comment1">(*infix "≤" 60*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Le</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="main">≡</span> gNot <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="comment1">(*infix "≥" 60*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ge</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="main">≡</span> gNot <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ne</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="comment1">(*infix "≠" 60*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ne</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="main">≡</span> gNot <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="GExp-gval_Lt"><span class="command">lemma</span></span> gval_Lt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>Lt <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> value_gt <span class="main">(</span>aval <span class="free">a2</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>aval <span class="free">a1</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Lt_def<span class="main">)</span>

<span class="keyword1" id="GExp-gval_Le"><span class="command">lemma</span></span> gval_Le <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>Le <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">¬?</span> <span class="main">(</span>value_gt <span class="main">(</span>aval <span class="free">a1</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>aval <span class="free">a2</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Le_def value_gt_def gNot_def maybe_or_idempotent<span class="main">)</span>

<span class="keyword1" id="GExp-gval_Ge"><span class="command">lemma</span></span> gval_Ge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>Ge <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">¬?</span> <span class="main">(</span>value_gt <span class="main">(</span>aval <span class="free">a2</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>aval <span class="free">a1</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ge_def value_gt_def gNot_def maybe_or_idempotent<span class="main">)</span>

<span class="keyword1" id="GExp-gval_Ne"><span class="command">lemma</span></span> gval_Ne <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>Ne <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">¬?</span> <span class="main">(</span>value_eq <span class="main">(</span>aval <span class="free">a1</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>aval <span class="free">a2</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ne_def value_gt_def gNot_def maybe_or_idempotent<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> connectives <span class="main">=</span> gAnd_def gOr_def gNot_def Lt_def Le_def Ge_def Ne_def

<span class="keyword1" id="GExp-gval_gOr"><span class="command">lemma</span></span> gval_gOr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>gOr <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>gval <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">∨?</span> <span class="main">(</span>gval <span class="free">y</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_double_negation maybe_or_idempotent gOr_def<span class="main">)</span>

<span class="keyword1" id="GExp-gval_gNot"><span class="command">lemma</span></span> gval_gNot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>gNot <span class="free">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">¬?</span> <span class="main">(</span>gval <span class="free">x</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_or_idempotent gNot_def<span class="main">)</span>

<span class="keyword1" id="GExp-gval_gAnd"><span class="command">lemma</span></span> gval_gAnd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>gAnd <span class="free">g1</span> <span class="free">g2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>gval <span class="free">g1</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧?</span> <span class="main">(</span>gval <span class="free">g2</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> de_morgans_1 maybe_double_negation maybe_or_idempotent gAnd_def<span class="main">)</span>

<span class="keyword1" id="GExp-gAnd_commute"><span class="command">lemma</span></span> gAnd_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>gAnd <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>gAnd <span class="free">b</span> <span class="free">a</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_trilean_commutative<span class="main">)</span>

<span class="keyword1" id="GExp-gOr_commute"><span class="command">lemma</span></span> gOr_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>gOr <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>gOr <span class="free">b</span> <span class="free">a</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_trilean_commutative gOr_def<span class="main">)</span>

<span class="keyword1" id="GExp-gval_gAnd_True"><span class="command">lemma</span></span> gval_gAnd_True<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>gAnd <span class="free">g1</span> <span class="free">g2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>gval <span class="free">g1</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">∧</span> gval <span class="free">g2</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_and_true<span class="main">)</span>

<span class="keyword1" id="GExp-nor_equiv"><span class="command">lemma</span></span> nor_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>gNot <span class="main">(</span>gOr <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>Nor <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfiable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfiable</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> gval <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">satisfiable_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> satisfiable <span class="main">(</span>fold gAnd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-unsatisfiable_false"><span class="command">lemma</span></span> unsatisfiable_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>Bc False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfiable_def<span class="main">)</span>

<span class="keyword1" id="GExp-satisfiable_true"><span class="command">lemma</span></span> satisfiable_true<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Bc True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfiable_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> gval <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-valid_true"><span class="command">lemma</span></span> valid_true<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>Bc True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gexp_constrains</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> aexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_constrains</span> <span class="main">(</span>Bc <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_constrains</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>aexp_constrains <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∨</span> aexp_constrains <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_constrains</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>aexp_constrains <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∨</span> aexp_constrains <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_constrains</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">gexp_constrains</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∨</span> <span class="free">gexp_constrains</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_constrains</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> aexp_constrains <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">contains_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">contains_bool</span> <span class="main">(</span>Bc <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">contains_bool</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">contains_bool</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="main">∨</span> <span class="free">contains_bool</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">contains_bool</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gexp_same_structure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_same_structure</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_same_structure</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>aexp_same_structure <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="main">∧</span> aexp_same_structure <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_same_structure</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>aexp_same_structure <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1'</span></span></span> <span class="main">∧</span> aexp_same_structure <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_same_structure</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1'</span></span></span> <span class="free"><span class="bound"><span class="entity">g2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gexp_same_structure</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g1'</span></span></span> <span class="main">∧</span> <span class="free">gexp_same_structure</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">g2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_same_structure</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp_same_structure</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="GExp-gval_foldr_true"><span class="command">lemma</span></span> gval_foldr_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>foldr gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> foldr.simps comp_def gval_gAnd maybe_and_true<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_gexp_inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_inputs</span> <span class="main">(</span>Bc <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_inputs</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> enumerate_aexp_inputs <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> enumerate_aexp_inputs <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_inputs</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> enumerate_aexp_inputs <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> enumerate_aexp_inputs <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_inputs</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> enumerate_aexp_inputs <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_inputs</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_gexp_inputs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_gexp_inputs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span>

<span class="keyword1" id="GExp-enumerate_gexp_inputs_list"><span class="command">lemma</span></span> enumerate_gexp_inputs_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> enumerate_gexp_inputs <span class="free">g</span> <span class="main">=</span> set <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enumerate_aexp_inputs_list enumerate_gexp_inputs.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Gt <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enumerate_aexp_inputs_list enumerate_gexp_inputs.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>In <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enumerate_aexp_inputs_list<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nor <span class="skolem">g1</span> <span class="skolem">g2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enumerate_gexp_inputs.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_input</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">inputs</span> <span class="main">=</span> <span class="main">(</span>enumerate_gexp_inputs <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">inputs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max <span class="bound">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_input_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_input_list</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> fold max <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> max_input <span class="bound">g</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1" id="GExp-max_input_list_cons"><span class="command">lemma</span></span> max_input_list_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input_list <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_input <span class="free">a</span><span class="main">)</span> <span class="main">(</span>max_input_list <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"max_input <span class="free">a</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def_raw<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> List.finite_set Max.insert Max.set_eq_fold fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> max.assoc set_empty<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>Bc <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> AExp.enumerate_regs <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> AExp.enumerate_regs <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> AExp.enumerate_regs <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> AExp.enumerate_regs <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> AExp.enumerate_regs <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∪</span> <span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span>"</span></span>

<span class="keyword1" id="GExp-finite_enumerate_regs"><span class="command">lemma</span></span> finite_enumerate_regs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>enumerate_regs <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> AExp.finite_enumerate_regs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">g</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_reg</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">regs</span> <span class="main">=</span> <span class="main">(</span>enumerate_regs <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">regs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max <span class="bound">regs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-max_reg_gNot"><span class="command">lemma</span></span> max_reg_gNot<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>gNot <span class="free">x</span><span class="main">)</span> <span class="main">=</span> max_reg <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def gNot_def<span class="main">)</span>

<span class="keyword1" id="GExp-max_reg_Eq"><span class="command">lemma</span></span> max_reg_Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>Eq <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>AExp.max_reg <span class="free">a</span><span class="main">)</span> <span class="main">(</span>AExp.max_reg <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def AExp.max_reg_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> AExp.finite_enumerate_regs Max.union bot_option_def max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="GExp-max_reg_Gt"><span class="command">lemma</span></span> max_reg_Gt<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>Gt <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>AExp.max_reg <span class="free">a</span><span class="main">)</span> <span class="main">(</span>AExp.max_reg <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def AExp.max_reg_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> AExp.finite_enumerate_regs Max.union bot_option_def max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="GExp-max_reg_Nor"><span class="command">lemma</span></span> max_reg_Nor<span class="main">:</span> <span class="quoted"><span class="quoted">"max_reg <span class="main">(</span>Nor <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_reg <span class="free">a</span><span class="main">)</span> <span class="main">(</span>max_reg <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_def AExp.max_reg_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> GExp.finite_enumerate_regs Max.union bot_option_def max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="GExp-gval_In_cons"><span class="command">lemma</span></span> gval_In_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>In <span class="free">v</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>gval <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">∨?</span> gval <span class="main">(</span>In <span class="free">v</span> <span class="free">as</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="GExp-possible_to_be_in"><span class="command">lemma</span></span> possible_to_be_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> satisfiable <span class="main">(</span>In <span class="free">v</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> join_ir <span class="bound">i</span> <span class="bound">r</span> <span class="free">v</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> set <span class="free">s</span> <span class="main">⟹</span>
             <span class="main">∃</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> join_ir <span class="bound">i</span> <span class="bound">r</span> <span class="free">v</span> <span class="keyword1">of</span> None <span class="main">⇒</span> false <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="free">s</span> <span class="keyword1">then</span> true <span class="keyword1">else</span> false<span class="main">)</span> <span class="main">=</span> true"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfiable_def gval_In_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">i</span><span class="main">::</span>value list<span class="main">)</span><span class="main">.</span> length <span class="bound">i</span> <span class="main">&gt;</span> <span class="improper">x1</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">!</span> <span class="improper">x1</span> <span class="main">=</span> <span class="improper">a</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> gt_ex length_list_update length_repeat nth_list_update_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">$</span> <span class="improper">x2</span> <span class="main">=</span> Some <span class="improper">a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join_ir_R join_ir_double_exists<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_reg_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_reg_list</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span>fold max <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> max_reg <span class="bound">g</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-max_reg_list_cons"><span class="command">lemma</span></span> max_reg_list_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_reg_list <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_reg <span class="free">a</span><span class="main">)</span> <span class="main">(</span>max_reg_list <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> List.finite_set Max.insert Max.set_eq_fold fold.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> id_apply list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> max.assoc set_empty<span class="main">)</span>

<span class="keyword1" id="GExp-max_reg_list_append_singleton"><span class="command">lemma</span></span> max_reg_list_append_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_reg_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_reg_list <span class="free">as</span><span class="main">)</span> <span class="main">(</span>max_reg_list <span class="main">[</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_reg_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max.commute sup_None_2 sup_max<span class="main">)</span>

<span class="keyword1" id="GExp-max_reg_list_append"><span class="command">lemma</span></span> max_reg_list_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_reg_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_reg_list <span class="free">as</span><span class="main">)</span> <span class="main">(</span>max_reg_list <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> max_reg_list_def sup_None_2 sup_max<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc max.assoc max_reg_list_append_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_guards</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> vname datastate <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_guards</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">g</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-apply_guards_singleton"><span class="command">lemma</span></span> apply_guards_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>apply_guards <span class="main">[</span><span class="free">g</span><span class="main">]</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gval <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>

<span class="keyword1" id="GExp-apply_guards_empty"><span class="command">lemma</span></span> apply_guards_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_guards <span class="main">[]</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>

<span class="keyword1" id="GExp-apply_guards_cons"><span class="command">lemma</span></span> apply_guards_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_guards <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span>gval <span class="free">a</span> <span class="free">c</span> <span class="main">=</span> true <span class="main">∧</span> apply_guards <span class="free">G</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>

<span class="keyword1" id="GExp-apply_guards_double_cons"><span class="command">lemma</span></span> apply_guards_double_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_guards <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">x</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>gval <span class="main">(</span>gAnd <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true <span class="main">∧</span> apply_guards <span class="free">G</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_guards_cons gval_gAnd_True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-apply_guards_append"><span class="command">lemma</span></span> apply_guards_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_guards <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">a'</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>apply_guards <span class="free">a</span> <span class="free">s</span> <span class="main">∧</span> apply_guards <span class="free">a'</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_guards_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-apply_guards_foldr"><span class="command">lemma</span></span> apply_guards_foldr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_guards <span class="free">G</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>gval <span class="main">(</span>foldr gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apply_guards_cons foldr.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gval_gAnd_True o_apply<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GExp-rev_apply_guards"><span class="command">lemma</span></span> rev_apply_guards<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_guards <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> apply_guards <span class="free">G</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>

<span class="keyword1" id="GExp-apply_guards_fold"><span class="command">lemma</span></span> apply_guards_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_guards <span class="free">G</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev_apply_guards<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldr_conv_fold apply_guards_foldr<span class="main">)</span>

<span class="keyword1" id="GExp-fold_apply_guards"><span class="command">lemma</span></span> fold_apply_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> apply_guards <span class="free">G</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_fold<span class="main">)</span>

<span class="keyword1" id="GExp-foldr_apply_guards"><span class="command">lemma</span></span> foldr_apply_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>foldr gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> apply_guards <span class="free">G</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_foldr<span class="main">)</span>

<span class="keyword1" id="GExp-apply_guards_subset"><span class="command">lemma</span></span> apply_guards_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">g'</span> <span class="main">⊆</span> set <span class="free">g</span> <span class="main">⟹</span> apply_guards <span class="free">g</span> <span class="free">c</span> <span class="main">⟶</span> apply_guards <span class="free">g'</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">g</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> apply_guards_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-apply_guards_subset_append"><span class="command">lemma</span></span> apply_guards_subset_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">⊆</span> set <span class="free">G'</span> <span class="main">⟹</span> apply_guards <span class="main">(</span><span class="free">G</span> <span class="main">@</span> <span class="free">G'</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> apply_guards <span class="main">(</span><span class="free">G'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_guards_append apply_guards_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-apply_guards_rearrange"><span class="command">lemma</span></span> apply_guards_rearrange<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">⟹</span> apply_guards <span class="free">G</span> <span class="free">s</span> <span class="main">=</span> apply_guards <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">G</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_guards_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-apply_guards_condense"><span class="command">lemma</span></span> apply_guards_condense<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> apply_guards <span class="free">G</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apply_guards_fold <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-apply_guards_false_condense"><span class="command">lemma</span></span> apply_guards_false_condense<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span>apply_guards <span class="free">G</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> false<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldr_apply_guards gval.simps<span class="main">(</span>2<span class="main">)</span> not_true <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-max_input_Bc"><span class="command">lemma</span></span> max_input_Bc<span class="main">:</span> <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>Bc <span class="free">x</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_def<span class="main">)</span>

<span class="keyword1" id="GExp-max_input_Eq"><span class="command">lemma</span></span> max_input_Eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>Eq <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>AExp.max_input <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>AExp.max_input <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AExp.max_input_def max_input_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union bot_option_def enumerate_aexp_inputs_not_empty max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="GExp-max_input_Gt"><span class="command">lemma</span></span> max_input_Gt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>Gt <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>AExp.max_input <span class="free">a1</span><span class="main">)</span> <span class="main">(</span>AExp.max_input <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AExp.max_input_def max_input_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union bot_option_def enumerate_aexp_inputs_not_empty max_bot2 sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="GExp-gexp_max_input_Nor"><span class="command">lemma</span></span> gexp_max_input_Nor<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>Nor <span class="free">g1</span> <span class="free">g2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_input <span class="free">g1</span><span class="main">)</span> <span class="main">(</span>max_input <span class="free">g2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AExp.max_input_def max_input_def Let_def max_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Max.union enumerate_gexp_inputs_list less_eq_option_Some_None max_def sup_Some sup_max<span class="main">)</span>

<span class="keyword1" id="GExp-gexp_max_input_In"><span class="command">lemma</span></span> gexp_max_input_In<span class="main">:</span> <span class="quoted"><span class="quoted">"max_input <span class="main">(</span>In <span class="free">v</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> AExp.max_input <span class="main">(</span>V <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AExp.max_input_def GExp.max_input_def<span class="main">)</span>

<span class="keyword1" id="GExp-gval_foldr_gOr_invalid"><span class="command">lemma</span></span> gval_foldr_gOr_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> invalid<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">g'</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> gval <span class="bound">g'</span> <span class="free">s</span> <span class="main">=</span> invalid<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> gval_gOr maybe_or_invalid<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-gval_foldr_gOr_true"><span class="command">lemma</span></span> gval_foldr_gOr_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">g'</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> gval <span class="bound">g'</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g'</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> gval <span class="bound">g'</span> <span class="free">s</span> <span class="main">≠</span> invalid<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_or_true<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> gval_foldr_gOr_invalid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-gval_foldr_gOr_false"><span class="command">lemma</span></span> gval_foldr_gOr_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> false<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g'</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> gval <span class="bound">g'</span> <span class="free">s</span> <span class="main">=</span> false<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_or_false<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-gval_fold_gOr_rev"><span class="command">lemma</span></span> gval_fold_gOr_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_foldr_gOr_true<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_foldr_gOr_false<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_foldr_gOr_invalid<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_gOr_foldr"><span class="command">lemma</span></span> gval_fold_gOr_foldr<span class="main">:</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>foldr gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldr_conv_fold gval_fold_gOr_rev<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_gOr"><span class="command">lemma</span></span> gval_fold_gOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>gval <span class="free">a</span> <span class="free">s</span> <span class="main">∨?</span> gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gval_fold_gOr_foldr foldr.simps comp_def gval_gOr<span class="main">)</span>

<span class="keyword1" id="GExp-gval_In_fold"><span class="command">lemma</span></span> gval_In_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>In <span class="free">v</span> <span class="free">l</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="free">v</span> <span class="main">=</span> None <span class="keyword1">then</span> invalid <span class="keyword1">else</span> gval <span class="main">(</span>fold gOr <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>Bc False<span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gval_In_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_gOr <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fold.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_In</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> value list <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fold_In</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> Bc False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">fold_In</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> gOr <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">fold_In</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-gval_fold_In"><span class="command">lemma</span></span> gval_fold_In<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> gval <span class="main">(</span>In <span class="free">v</span> <span class="free">l</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold_In <span class="free">v</span> <span class="free">l</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fold_In.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-fold_maybe_or_invalid_base"><span class="command">lemma</span></span> fold_maybe_or_invalid_base<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="free">l</span> invalid <span class="main">=</span> invalid"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> maybe_or_valid<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-fold_maybe_or_true_base_never_false"><span class="command">lemma</span></span> fold_maybe_or_true_base_never_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="free">l</span> true <span class="main">≠</span> false"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fold_maybe_or_invalid_base fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> maybe_not.cases maybe_or_valid plus_trilean.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> plus_trilean.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-fold_true_fold_false_not_invalid"><span class="command">lemma</span></span> fold_true_fold_false_not_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="free">l</span> true <span class="main">=</span> true <span class="main">⟹</span>
   fold <span class="main">(∨?)</span> <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span> false <span class="main">≠</span> invalid"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fold_maybe_or_invalid_base maybe_or_invalid maybe_or_true<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-fold_true_invalid_fold_rev_false_invalid"><span class="command">lemma</span></span> fold_true_invalid_fold_rev_false_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="free">l</span> true <span class="main">=</span> invalid <span class="main">⟹</span>
   fold <span class="main">(∨?)</span> <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span> false <span class="main">=</span> invalid"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> maybe_or_true maybe_or_valid<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-fold_maybe_or_rev"><span class="command">lemma</span></span> fold_maybe_or_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="free">l</span> <span class="free">b</span> <span class="main">=</span> fold <span class="main">(∨?)</span> <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> plus_trilean.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">uu</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_maybe_or_invalid_base<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_1"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_maybe_or_invalid_base<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_2"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_maybe_or_invalid_base<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_1"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc fold_maybe_or_true_base_never_false maybe_not.cases maybe_or_idempotent maybe_or_true<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_2"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="skolem">l</span> true"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">true</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="main">(</span>rev <span class="skolem">l</span><span class="main">)</span> false"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_true_fold_false_not_invalid<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_maybe_or_true_base_never_false<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_true_invalid_fold_rev_false_invalid<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_or_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 5
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_or_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-fold_maybe_or_cons"><span class="command">lemma</span></span> fold_maybe_or_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(∨?)</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∨?</span> <span class="main">(</span>fold <span class="main">(∨?)</span> <span class="free">l</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fold_maybe_or_rev foldr.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> foldr_conv_fold o_apply<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_gOr_map"><span class="command">lemma</span></span> gval_fold_gOr_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="free">l</span> <span class="main">(</span>Bc False<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> fold <span class="main">(∨?)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>false<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fold_maybe_or_cons gval_fold_gOr list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-gval_unfold_first"><span class="command">lemma</span></span> gval_unfold_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
       gval <span class="main">(</span>fold gOr <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">#</span><span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Bc False<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gOr_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">va</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span> <span class="main">(</span>gOr <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Bc False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold gOr <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">va</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">#</span> <span class="skolem">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Bc False<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gOr <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">va</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold gOr <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="skolem">a</span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">va</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span> <span class="main">(</span>gOr <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Bc False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Cons.hyps gval_fold_gOr list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GExp-fold_Eq_true"><span class="command">lemma</span></span> fold_Eq_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> fold <span class="main">(∨?)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> true <span class="keyword1">else</span> false<span class="main">)</span> <span class="free">vs</span><span class="main">)</span> true <span class="main">=</span> true"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="GExp-x_in_set_fold_eq"><span class="command">lemma</span></span> x_in_set_fold_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">ll</span> <span class="main">⟹</span>
   fold <span class="main">(∨?)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">xa</span> <span class="keyword1">then</span> true <span class="keyword1">else</span> false<span class="main">)</span> <span class="free">ll</span><span class="main">)</span> false <span class="main">=</span> true"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ll</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ll</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_Eq_true<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-x_not_in_set_fold_eq"><span class="command">lemma</span></span> x_not_in_set_fold_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span> <span class="main">∉</span> Some <span class="main">`</span> set <span class="free">ll</span> <span class="main">⟹</span>
   false <span class="main">=</span> fold <span class="main">(∨?)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="free">v</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="keyword1">then</span> true <span class="keyword1">else</span> false<span class="main">)</span> <span class="free">ll</span><span class="main">)</span> false"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ll</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="GExp-gval_take"><span class="command">lemma</span></span> gval_take<span class="main">:</span> <span class="quoted"><span class="quoted">"max_input <span class="free">g</span> <span class="main">&lt;</span> Some <span class="free">a</span> <span class="main">⟹</span>
   gval <span class="free">g</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> gval <span class="free">g</span> <span class="main">(</span>join_ir <span class="main">(</span>take <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> gval.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aval_take gval.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> max_input_Eq max_less_iff_conj<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Gt <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aval_take gval.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> max_input_Gt max_less_iff_conj<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nor <span class="skolem">g1</span> <span class="skolem">g2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_not_eq gexp_max_input_Nor<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>In <span class="skolem">v</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gexp_max_input_In<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> aval_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GExp-gval_fold_gAnd_append_singleton"><span class="command">lemma</span></span> gval_fold_gAnd_append_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">G</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold gAnd <span class="free">a</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧?</span> gval <span class="free">G</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> times_trilean_commutative <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-gval_fold_rev_true"><span class="command">lemma</span></span> gval_fold_rev_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> foldr_conv_fold gval_foldr_true rev_rev_ident set_rev<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_not_invalid_all_valid_contra"><span class="command">lemma</span></span> gval_fold_not_invalid_all_valid_contra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> invalid <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> invalid"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gval_fold_gAnd_append_singleton<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> maybe_and_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-gval_fold_not_invalid_all_valid"><span class="command">lemma</span></span> gval_fold_not_invalid_all_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">≠</span> invalid <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">≠</span> invalid"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gval_fold_not_invalid_all_valid_contra <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-all_gval_not_false"><span class="command">lemma</span></span> all_gval_not_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">≠</span> false<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trilean.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="GExp-must_have_one_false_contra"><span class="command">lemma</span></span> must_have_one_false_contra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">≠</span> false <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">≠</span> false"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_gval_not_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> foldr_conv_fold gval_fold_rev_true gval_foldr_true not_true<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_not_invalid_all_valid_contra<span class="main">)</span>

<span class="keyword1" id="GExp-must_have_one_false"><span class="command">lemma</span></span> must_have_one_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> false <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> false"</span></span>
  <span class="keyword1"><span class="command">using</span></span> must_have_one_false_contra <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-all_valid_fold"><span class="command">lemma</span></span> all_valid_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">≠</span> invalid <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">≠</span> invalid"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_and_invalid<span class="main">)</span>

<span class="keyword1" id="GExp-one_false_all_valid_false"><span class="command">lemma</span></span> one_false_all_valid_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> false <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">≠</span> invalid <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> false"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> all_valid_fold foldr_conv_fold gval_foldr_true not_true rev_rev_ident set_rev<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_rev_false"><span class="command">lemma</span></span> gval_fold_rev_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> false <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> false"</span></span>
  <span class="keyword1"><span class="command">using</span></span> must_have_one_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">G</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        gval_fold_not_invalid_all_valid<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">G</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_false_all_valid_false<span class="main">)</span>

<span class="keyword1" id="GExp-fold_invalid_means_one_invalid"><span class="command">lemma</span></span> fold_invalid_means_one_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> invalid <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gval <span class="bound">g</span> <span class="free">s</span> <span class="main">=</span> invalid"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_valid_fold <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="GExp-gval_fold_rev_invalid"><span class="command">lemma</span></span> gval_fold_rev_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> invalid <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> invalid"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fold_invalid_means_one_invalid<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">G</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_not_invalid_all_valid_contra<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_rev_equiv_fold"><span class="command">lemma</span></span> gval_fold_rev_equiv_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>  gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_rev_true<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_rev_false<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_rev_invalid<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_equiv_fold_rev"><span class="command">lemma</span></span> gval_fold_equiv_fold_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_rev_equiv_fold<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_equiv_gval_foldr"><span class="command">lemma</span></span> gval_fold_equiv_gval_foldr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>foldr gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="free">G</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gval_fold_equiv_fold_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldr_conv_fold<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GExp-gval_foldr_equiv_gval_fold"><span class="command">lemma</span></span> gval_foldr_equiv_gval_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>foldr gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gval_fold_equiv_gval_foldr<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_cons"><span class="command">lemma</span></span> gval_fold_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>fold gAnd <span class="main">(</span><span class="free">g</span> <span class="main">#</span> <span class="free">gs</span><span class="main">)</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="free">g</span> <span class="free">s</span> <span class="main">∧?</span> gval <span class="main">(</span>fold gAnd <span class="free">gs</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_fold gval_fold_equiv_gval_foldr<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> foldr.simps comp_def gval_gAnd<span class="main">)</span>

<span class="keyword1" id="GExp-gval_fold_take"><span class="command">lemma</span></span> gval_fold_take<span class="main">:</span> <span class="quoted"><span class="quoted">"max_input_list <span class="free">G</span> <span class="main">&lt;</span> Some <span class="free">a</span> <span class="main">⟹</span>
   <span class="free">a</span> <span class="main">≤</span> length <span class="free">i</span> <span class="main">⟹</span>
   max_input_list <span class="free">G</span> <span class="main">≤</span> Some <span class="main">(</span>length <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span>
   gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>take <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">g</span> <span class="skolem">gs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gval_fold_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_input_list_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> gval_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">padding</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">padding</span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">padding</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">padding</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_or_pad</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">take_or_pad</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">@</span><span class="main">(</span>padding <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">-</span>length <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-length_padding"><span class="command">lemma</span></span> length_padding<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>padding <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="GExp-length_take_or_pad"><span class="command">lemma</span></span> length_take_or_pad<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take_or_pad <span class="free">a</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_or_pad_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_or_pad_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_padding<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_gexp_strings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> String.literal set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_strings</span> <span class="main">(</span>Bc <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_strings</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> enumerate_aexp_strings <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> enumerate_aexp_strings <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_strings</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> enumerate_aexp_strings <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> enumerate_aexp_strings <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_strings</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">acc</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Num <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">acc</span> <span class="main">|</span> Str <span class="bound">s</span> <span class="main">⇒</span> insert <span class="bound">s</span> <span class="bound">acc</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_strings</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_gexp_strings</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_gexp_strings</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumerate_gexp_ints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_ints</span> <span class="main">(</span>Bc <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_ints</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> enumerate_aexp_ints <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> enumerate_aexp_ints <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_ints</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> enumerate_aexp_ints <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">∪</span> enumerate_aexp_ints <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_ints</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">acc</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Str <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">acc</span> <span class="main">|</span> Num <span class="bound">n</span> <span class="main">⇒</span> insert <span class="bound">n</span> <span class="bound">acc</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_gexp_ints</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">enumerate_gexp_ints</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="main">∪</span> <span class="free">enumerate_gexp_ints</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restricted_once</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> gexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">restricted_once</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">not_restricted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> gexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">not_restricted</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-restricted_once_cons"><span class="command">lemma</span></span> restricted_once_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"restricted_once <span class="free">v</span> <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">gs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>gexp_constrains <span class="free">g</span> <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> not_restricted <span class="free">v</span> <span class="free">gs</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="main">¬</span> gexp_constrains <span class="free">g</span> <span class="main">(</span>V <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> restricted_once <span class="free">v</span> <span class="free">gs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restricted_once_def not_restricted_def<span class="main">)</span>

<span class="keyword1" id="GExp-not_restricted_cons"><span class="command">lemma</span></span> not_restricted_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"not_restricted <span class="free">v</span> <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">gs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">¬</span> gexp_constrains <span class="free">g</span> <span class="main">(</span>V <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> not_restricted <span class="free">v</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_restricted_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> vname list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_vars</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span><span class="main">(</span>image R <span class="main">(</span>enumerate_regs <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>image I <span class="main">(</span>enumerate_gexp_inputs <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rename_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> vname gexp <span class="main">⇒</span> vname gexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Bc <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> Eq <span class="main">(</span>AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span> <span class="main">(</span>AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> Gt <span class="main">(</span>AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span> <span class="main">(</span>AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>In <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> In <span class="main">(</span>R <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">=</span> Nor <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_upto_rename</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> vname gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_upto_rename</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span> <span class="main">∧</span> rename_regs <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp-gval_reg_some_superset"><span class="command">lemma</span></span> gval_reg_some_superset<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="bound">a</span>  <span class="main">≠</span> None<span class="main">)</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">≠</span> invalid <span class="main">⟹</span>
 gval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span>
 gval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r'</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bc <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> value_eq_true<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x1a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x2</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aval_reg_some_superset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> value_eq_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x1a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x2</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aval_reg_some_superset<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Gt <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> value_gt_true_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x1a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x2</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aval_reg_some_superset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> value_gt_false_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x1a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"aval <span class="skolem">x2</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aval_reg_some_superset<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>In <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">r</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">r'</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> aval_reg_some_superset In.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> aval_reg_some_superset In.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.inject<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nor <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_negate_true maybe_or_false<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maybe_negate_false maybe_or_true<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GExp-apply_guards_reg_some_superset"><span class="command">lemma</span></span> apply_guards_reg_some_superset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="bound">a</span>  <span class="main">≠</span> None<span class="main">)</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> gval_reg_some_superset
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="GExp_Lexorder">
<div class="head">
<h1>Theory GExp_Lexorder</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹GExp Lexorder›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory defines a lexicographical ordering on guard expressions such that we can build
orderings for transitions. We make use of the previously established orderings on arithmetic
expressions.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
GExp_Lexorder
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="GExp.html">GExp</a>"</span>
  <span class="quoted">"<a href="AExp_Lexorder.html">AExp_Lexorder</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/List_Lexorder.html">HOL-Library.List_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">height</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Bc <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span>AExp_Lexorder.height <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span> <span class="main">(</span>AExp_Lexorder.height <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span>AExp_Lexorder.height <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span> <span class="main">(</span>AExp_Lexorder.height <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> gexp <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">less_gexp_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b1</span></span></span><span class="main">)</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b1</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="free"><span class="bound"><span class="entity">vc</span></span></span><span class="main">)</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="free"><span class="bound"><span class="entity">vc</span></span></span><span class="main">)</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">vc</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="free"><span class="bound"><span class="entity">vc</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1'</span></span></span> <span class="free"><span class="bound"><span class="entity">g2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">less_gexp_aux</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g1'</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g1'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">less_gexp_aux</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">g2'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp_aux</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_gexp</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_gexp</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">h1</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">;</span>
      <span class="bound">h2</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">a2</span></span></span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">h1</span> <span class="main">=</span> <span class="bound">h2</span> <span class="keyword1">then</span>
      less_gexp_aux <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>
    <span class="keyword1">else</span>
      <span class="bound">h1</span> <span class="main">&lt;</span> <span class="bound">h2</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> less_gexp_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_gexp</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_gexp</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="GExp_Lexorder-less_gexp_aux_antisym"><span class="command">lemma</span></span> less_gexp_aux_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"less_gexp_aux <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span>less_gexp_aux <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_gexp_aux.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b1</span> <span class="skolem">b2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_1"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_2"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_3"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_4"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">b2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_gexp_aux.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> less_imp_not_less less_linear<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_1"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_2"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_3"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">b2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_gexp_aux.simps<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> less_imp_not_less less_linear<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"9_1"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"9_2"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_1"</span> <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_2"</span> <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_3"</span> <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">g1'</span> <span class="skolem">g2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_1"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_2"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_3"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_4"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GExp_Lexorder-less_gexp_antisym"><span class="command">lemma</span></span> less_gexp_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span> gexp<span class="main">)</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="free">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> less_gexp_aux_antisym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="GExp_Lexorder-less_gexp_aux_trans"><span class="command">lemma</span></span> less_gexp_aux_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"less_gexp_aux <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> less_gexp_aux <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> less_gexp_aux <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_gexp_aux.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b1</span> <span class="skolem">b2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_1"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_2"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_3"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_4"</span> <span class="skolem">b1</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">b2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans less_gexp_aux.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_1"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_2"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_3"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">b2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans less_gexp_aux.simps<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"9_1"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"9_2"</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_1"</span> <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_2"</span> <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"12_3"</span> <span class="skolem">vb</span> <span class="skolem">vc</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">g1'</span> <span class="skolem">g2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_1"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_2"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_3"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"14_4"</span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">v</span> <span class="skolem">va</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GExp_Lexorder-less_gexp_trans"><span class="command">lemma</span></span> less_gexp_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span> gexp<span class="main">)</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dual_order.strict_trans less_gexp_aux_trans less_imp_not_less<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_gexp_antisym less_eq_gexp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_gexp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_gexp_def less_gexp_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_gexp_def <span class="keyword1"><span class="command">using</span></span> less_gexp_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_gexp_def <span class="keyword1"><span class="command">using</span></span> less_gexp_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FSet_Utils">
<div class="head">
<h1>Theory FSet_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹FSet Utilities›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory provides various additional lemmas, definitions, and syntax over the fset data type.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> FSet_Utils
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  <span class="quoted">"FSet.fempty"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∅</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted">"FSet.fmember"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∈</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_fBall"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">ALL</span> <span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">:</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_fBex"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">EX</span> <span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">:</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_fBex1"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">EX!</span> <span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">:</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="quoted">"_fBall"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">!</span> <span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">:</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_fBex"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">?</span> <span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">:</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_fBex1"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">?!</span> <span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">:</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_fBall"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span><span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">|∈|</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_fBex"</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span><span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">|∈|</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_fBnex"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∄</span><span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">|∈|</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_fBex1"</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃!</span><span class="keyword3">(</span>_<span class="keyword3">/</span><span class="keyword1">|∈|</span>_<span class="keyword3">)</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">|∈|</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> fBall <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">|∈|</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> fBex  <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">∄</span><span class="free">x</span><span class="main">|∈|</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> fBall <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">∃!</span><span class="free">x</span><span class="main">|∈|</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∃!</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">P</span>"</span>

<span class="keyword1" id="FSet_Utils-fset_of_list_remdups"><span class="command">lemma</span></span> fset_of_list_remdups <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset_of_list <span class="main">(</span>remdups <span class="free">l</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finsert_absorb fset_of_list_elem<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fSum</span> <span class="main">≡</span> fsum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FSet_Utils-fset_both_sides"><span class="command">lemma</span></span> fset_both_sides<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Abs_fset <span class="free">s</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="main">(</span>Abs_fset <span class="free">s</span><span class="main">)</span> <span class="main">=</span> fset <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_inject<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-Abs_ffilter"><span class="command">lemma</span></span> Abs_ffilter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ffilter <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="main">(</span>fset <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">e</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_def fset_both_sides Abs_fset_inverse Set.filter_def<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-size_ffilter_card"><span class="command">lemma</span></span> size_ffilter_card<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>ffilter <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="main">(</span>fset <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">e</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_def fset_both_sides Abs_fset_inverse Set.filter_def<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-ffilter_empty"><span class="command">lemma</span></span> ffilter_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ffilter <span class="free">f</span> <span class="main">{||}</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-ffilter_finsert"><span class="command">lemma</span></span> ffilter_finsert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffilter <span class="free">f</span> <span class="main">(</span>finsert <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="free">a</span> <span class="keyword1">then</span> finsert <span class="free">a</span> <span class="main">(</span>ffilter <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>ffilter <span class="free">f</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_def fset_both_sides Abs_fset_inverse<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_def fset_both_sides Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fset_equiv"><span class="command">lemma</span></span> fset_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">f1</span> <span class="main">=</span> fset <span class="free">f2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_inject<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-finsert_equiv"><span class="command">lemma</span></span> finsert_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finsert <span class="free">e</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert <span class="free">e</span> <span class="main">(</span>fset <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free">f'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finsert_def fset_both_sides Abs_fset_inverse<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-filter_elements"><span class="command">lemma</span></span> filter_elements<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> Abs_fset <span class="main">(</span>Set.filter <span class="free">f</span> <span class="main">(</span>fset <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>Set.filter <span class="free">f</span> <span class="main">(</span>fset <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ffilter.rep_eq fset_inverse notin_fset<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-sorted_list_of_fempty"><span class="command">lemma</span></span> sorted_list_of_fempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_list_of_fset <span class="main">{||}</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_fset_def<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fmember_implies_member"><span class="command">lemma</span></span> fmember_implies_member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">|∈|</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> fset <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember_def<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fold_union_ffUnion"><span class="command">lemma</span></span> fold_union_ffUnion<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(|∪|)</span> <span class="free">l</span> <span class="main">{||}</span> <span class="main">=</span> ffUnion <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="FSet_Utils-filter_filter"><span class="command">lemma</span></span> filter_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffilter <span class="free">P</span> <span class="main">(</span>ffilter <span class="free">Q</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fsubset_strict"><span class="command">lemma</span></span> fsubset_strict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">|⊂|</span> <span class="free">x1</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">|∈|</span> <span class="free">x1</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">|∉|</span> <span class="free">x2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fsubset"><span class="command">lemma</span></span> fsubset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">|⊂|</span> <span class="free">x1</span> <span class="main">⟹</span> <span class="main">∄</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">|∈|</span> <span class="free">x2</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">|∉|</span> <span class="free">x1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-size_fsubset_elem"><span class="command">lemma</span></span> size_fsubset_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">|∈|</span> <span class="free">x1</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">|∉|</span> <span class="free">x2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">|∈|</span> <span class="free">x2</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">|∉|</span> <span class="free">x1</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="free">x2</span> <span class="main">&lt;</span> size <span class="free">x1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_seteq finite_fset linorder_not_le subsetI<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-size_fsubset"><span class="command">lemma</span></span> size_fsubset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">|⊂|</span> <span class="free">x1</span> <span class="main">⟹</span> size <span class="free">x2</span> <span class="main">&lt;</span> size <span class="free">x1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fsubset fsubset_strict size_fsubset_elem<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fremove</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'a</span> fset"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fremove</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">|}</span>"</span></span>

<span class="keyword1" id="FSet_Utils-arg_cong_ffilter"><span class="command">lemma</span></span> arg_cong_ffilter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">|∈|</span> <span class="free">f</span><span class="main">.</span> <span class="free">p</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">p'</span> <span class="bound">e</span> <span class="main">⟹</span> ffilter <span class="free">p</span> <span class="free">f</span> <span class="main">=</span> ffilter <span class="free">p'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-ffilter_singleton"><span class="command">lemma</span></span> ffilter_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">e</span> <span class="main">⟹</span> ffilter <span class="free">f</span> <span class="main">{|</span><span class="free">e</span><span class="main">|}</span> <span class="main">=</span> <span class="main">{|</span><span class="free">e</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_def fset_both_sides Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fset_eq_alt"><span class="command">lemma</span></span> fset_eq_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">|⊆|</span> <span class="free">y</span> <span class="main">∧</span> size <span class="free">x</span> <span class="main">=</span> size <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_least_iff le_less size_fsubset<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-ffold_empty"><span class="command">lemma</span></span> ffold_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ffold <span class="free">f</span> <span class="free">b</span> <span class="main">{||}</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffold_def<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-sorted_list_of_fset_sort"><span class="command">lemma</span></span> sorted_list_of_fset_sort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_list_of_fset <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span>remdups <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list.rep_eq sorted_list_of_fset.rep_eq sorted_list_of_set_sort_remdups<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fMin_Min"><span class="command">lemma</span></span> fMin_Min<span class="main">:</span> <span class="quoted"><span class="quoted">"fMin <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fMin.F.rep_eq fset_of_list.rep_eq<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-sorted_hd_Min"><span class="command">lemma</span></span> sorted_hd_Min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="free">l</span> <span class="main">⟹</span>
   <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   hd <span class="free">l</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set Min_eqI eq_iff hd_Cons_tl insertE list.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> sorted.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="FSet_Utils-hd_sort_Min"><span class="command">lemma</span></span> hd_sort_Min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> hd <span class="main">(</span>sort <span class="free">l</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sorted_hd_Min set_empty set_sort sorted_sort<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-hd_sort_remdups"><span class="command">lemma</span></span> hd_sort_remdups<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>sort <span class="main">(</span>remdups <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>sort <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_sort_Min remdups_eq_nil_iff set_remdups<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-exists_fset_of_list"><span class="command">lemma</span></span> exists_fset_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> fset_of_list <span class="bound">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_fset_of_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="FSet_Utils-hd_sorted_list_of_fset"><span class="command">lemma</span></span> hd_sorted_list_of_fset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">⟹</span> hd <span class="main">(</span>sorted_list_of_fset <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fMin <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> exists_fset_of_list<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_fset_sort fMin_Min hd_sort_remdups<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fset_of_list_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd_sort_Min<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fminus_filter_singleton"><span class="command">lemma</span></span> fminus_filter_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fset_of_list <span class="free">l</span> <span class="main">|-|</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span> <span class="main">=</span> fset_of_list <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-card_minus_fMin"><span class="command">lemma</span></span> card_minus_fMin<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">⟹</span> card <span class="main">(</span>fset <span class="free">s</span> <span class="main">-</span> <span class="main">{</span>fMin <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>fset <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min_in bot_fset.rep_eq card_Diff1_less fMin.F.rep_eq finite_fset fset_equiv<span class="main">)</span>

<span class="comment1">(* Provides a deterministic way to fold fsets similar to List.fold that works with the code generator *)</span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">ffold_ord</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ffold_ord</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span>
      <span class="free"><span class="bound"><span class="entity">b</span></span></span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span>
        <span class="bound">h</span> <span class="main">=</span> fMin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
        <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="main">{|</span><span class="bound">h</span><span class="main">|}</span>
      <span class="keyword1">in</span>
        <span class="free">ffold_ord</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">h</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">ab</span><span class="main">)</span><span class="main">.</span> size <span class="bound">s</span><span class="main">]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_minus_fMin<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-sorted_list_of_fset_Cons"><span class="command">lemma</span></span> sorted_list_of_fset_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>finsert <span class="free">s</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">h</span><span class="main">#</span><span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_fset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"insort <span class="free">s</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fset <span class="free">ss</span> <span class="main">-</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="FSet_Utils-list_eq_hd_tl"><span class="command">lemma</span></span> list_eq_hd_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   hd <span class="free">l</span> <span class="main">=</span> <span class="free">h</span> <span class="main">⟹</span>
   tl <span class="free">l</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span>
   <span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fset_of_list_sort"><span class="command">lemma</span></span> fset_of_list_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"fset_of_list <span class="free">l</span> <span class="main">=</span> fset_of_list <span class="main">(</span>sort <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list.abs_eq<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-exists_sorted_distinct_fset_of_list"><span class="command">lemma</span></span> exists_sorted_distinct_fset_of_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> sorted <span class="bound">l</span> <span class="main">∧</span> distinct <span class="bound">l</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> fset_of_list <span class="bound">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_sorted_list_of_set sorted_list_of_fset.rep_eq sorted_list_of_fset_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sorted_sorted_list_of_set<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fset_of_list_empty"><span class="command">lemma</span></span> fset_of_list_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fset_of_list <span class="free">l</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fset_of_list.rep_eq fset_of_list_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_empty<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-ffold_ord_cons"><span class="command">lemma</span></span> ffold_ord_cons<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ffold_ord <span class="free">f</span> <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> ffold_ord <span class="free">f</span> <span class="main">(</span>fset_of_list <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">h</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h_is_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> fMin <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sorted fMin_Min list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sorted_hd_Min<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> remove_min<span class="main">:</span> <span class="quoted"><span class="quoted">"fset_of_list <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{|</span><span class="free">h</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct fset_of_list_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ffold_ord.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h_is_min remove_min fset_of_list_empty list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FSet_Utils-sorted_distinct_ffold_ord"><span class="command">lemma</span></span> sorted_distinct_ffold_ord<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ffold_ord <span class="free">f</span> <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> fold <span class="free">f</span> <span class="free">l</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ffold_ord_cons fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sorted.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="FSet_Utils-ffold_ord_fold_sorted"><span class="command">lemma</span></span> ffold_ord_fold_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"ffold_ord <span class="free">f</span> <span class="free">s</span> <span class="free">b</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>sorted_list_of_fset <span class="free">s</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_sorted_distinct_fset_of_list sorted_distinct_ffold_ord distinct_remdups_id sorted_list_of_fset_sort sorted_sort_id<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> fprod  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'b</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> fset "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">|×|</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> fset <span class="bound">a</span> <span class="main">×</span> fset <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lift_definition</span></span> fis_singleton <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> is_singleton <span class="main">(</span>fset <span class="bound">A</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FSet_Utils-fprod_empty_l"><span class="command">lemma</span></span> fprod_empty_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{||}</span> <span class="main">|×|</span> <span class="free">a</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bot_fset_def fprod.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="FSet_Utils-fprod_empty_r"><span class="command">lemma</span></span> fprod_empty_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">|×|</span> <span class="main">{||}</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fprod_def bot_fset_def Abs_fset_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fprod_empty <span class="main">=</span> fprod_empty_l fprod_empty_r

<span class="keyword1" id="FSet_Utils-fprod_finsert"><span class="command">lemma</span></span> fprod_finsert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finsert <span class="free">a</span> <span class="free">as</span><span class="main">)</span> <span class="main">|×|</span> <span class="main">(</span>finsert <span class="free">b</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span>
   finsert <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">bs</span> <span class="main">|∪|</span> fimage <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span> <span class="main">|∪|</span> <span class="main">(</span><span class="free">as</span> <span class="main">|×|</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fprod_def fset_both_sides Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fprod_member"><span class="command">lemma</span></span> fprod_member<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">xs</span> <span class="main">⟹</span>
   <span class="free">y</span> <span class="main">|∈|</span> <span class="free">ys</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">xs</span> <span class="main">|×|</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember_def fprod_def Abs_fset_inverse<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fprod_subseteq"><span class="command">lemma</span></span> fprod_subseteq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|⊆|</span> <span class="free">x'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">|⊆|</span> <span class="free">y'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">|×|</span> <span class="free">y</span> <span class="main">|⊆|</span> <span class="free">x'</span> <span class="main">|×|</span> <span class="free">y'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fprod_def less_eq_fset_def Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fimage_fprod"><span class="command">lemma</span></span> fimage_fprod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">|×|</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">|∈|</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span><span class="free">A</span> <span class="main">|×|</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="FSet_Utils-fprod_singletons"><span class="command">lemma</span></span> fprod_singletons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{|</span><span class="free">a</span><span class="main">|}</span> <span class="main">|×|</span> <span class="main">{|</span><span class="free">b</span><span class="main">|}</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fprod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fset_inverse fset_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fset_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fprod_equiv"><span class="command">lemma</span></span> fprod_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fset <span class="main">(</span><span class="free">f</span> <span class="main">|×|</span> <span class="free">f'</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>fset <span class="free">f</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>fset <span class="free">f'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fprod_def Abs_fset_inverse<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fis_singleton_alt"><span class="command">lemma</span></span> fis_singleton_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"fis_singleton <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">e</span><span class="main">|}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fis_singleton.rep_eq fset_inverse fset_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fset_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_singleton_def<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-singleton_singleton"><span class="command">lemma</span></span> singleton_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fis_singleton <span class="main">{|</span><span class="free">a</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fis_singleton_def<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-not_singleton_empty"><span class="command">lemma</span></span> not_singleton_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fis_singleton <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fis_singleton_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_singleton_altdef<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fis_singleton_fthe_elem"><span class="command">lemma</span></span> fis_singleton_fthe_elem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fis_singleton <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{|</span>fthe_elem <span class="free">A</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fis_singleton_alt fthe_felem_eq<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fBall_ffilter"><span class="command">lemma</span></span> fBall_ffilter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span> ffilter <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-fBall_ffilter2"><span class="command">lemma</span></span> fBall_ffilter2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span>
   ffilter <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-size_fset_of_list"><span class="command">lemma</span></span> size_fset_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>remdups <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list.rep_eq insert_absorb<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-size_fsingleton"><span class="command">lemma</span></span> size_fsingleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>size <span class="free">f</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">e</span><span class="main">|}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> exists_fset_of_list<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> size_fset_of_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list_def fset_both_sides Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.card_set One_nat_def card.insert card_1_singletonE card.empty empty_iff finite.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="FSet_Utils-ffilter_mono"><span class="command">lemma</span></span> ffilter_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ffilter <span class="free">X</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">xs</span><span class="main">.</span> <span class="free">X</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Y</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">(</span>ffilter <span class="free">Y</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-size_fimage"><span class="command">lemma</span></span> size_fimage<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>fimage <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> size <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-size_ffilter"><span class="command">lemma</span></span> size_ffilter<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>ffilter <span class="free">P</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> size <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ffilter_finsert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>

<span class="keyword1" id="FSet_Utils-fimage_size_le"><span class="command">lemma</span></span> fimage_size_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">s</span><span class="main">.</span> size <span class="bound">s</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> size <span class="main">(</span>fimage <span class="bound">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_trans size_fimage <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="FSet_Utils-ffilter_size_le"><span class="command">lemma</span></span> ffilter_size_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">s</span><span class="main">.</span> size <span class="bound">s</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> size <span class="main">(</span>ffilter <span class="bound">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dual_order.trans size_ffilter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="FSet_Utils-set_membership_eq"><span class="command">lemma</span></span> set_membership_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Set.member <span class="bound">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Set.member <span class="bound">x</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> equalityI subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> ffilter_eq_iff <span class="main">=</span> Abs_ffilter set_membership_eq fun_eq_iff

<span class="keyword1" id="FSet_Utils-size_le_1"><span class="command">lemma</span></span> size_le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">f</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">e</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> bot.not_eq_extremum gr_implies_not0 le_neq_implies_less less_one size_fsingleton size_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FSet_Utils-size_gt_1"><span class="command">lemma</span></span> size_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> size <span class="free">f</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">f'</span><span class="main">.</span> <span class="bound">e1</span> <span class="main">≠</span> <span class="bound">e2</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> finsert <span class="bound">e1</span> <span class="main">(</span>finsert <span class="bound">e2</span> <span class="bound">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finsertCI leD not_le_imp_less size_le_1<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Transition">
<div class="head">
<h1>Theory Transition</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Models›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this chapter, we present our formalisation of EFSMs from \cite{foster2018}. We first
define transitions, before defining EFSMs as finite sets of transitions between states. Finally,
we provide a framework of function definitions and key lemmas such that LTL properties over EFSMs
can be more easily specified and proven.›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Transitions›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define the transitions which make up EFSMs. As per \cite{foster2018}, each transition
has a label and an arity and, optionally, guards, outputs, and updates. To implement this, we use
the record type such that each component of the transition can be accessed.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition
<span class="keyword2"><span class="keyword">imports</span></span> <a href="GExp.html">GExp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> label <span class="main">=</span> <span class="quoted">String.literal</span>
<span class="keyword1"><span class="command">type_synonym</span></span> arity <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> guard <span class="main">=</span> <span class="quoted"><span class="quoted">"vname gexp"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> inputs <span class="main">=</span> <span class="quoted"><span class="quoted">"value list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> outputs <span class="main">=</span> <span class="quoted"><span class="quoted">"value option list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> output_function <span class="main">=</span> <span class="quoted"><span class="quoted">"vname aexp"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> update_function <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> vname aexp"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{transitiontype}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">record</span></span> transition <span class="main">=</span>
  Label <span class="main">::</span> <span class="quoted">String.literal</span>
  Arity <span class="main">::</span> <span class="quoted">nat</span>
  Guards <span class="main">::</span> <span class="quoted"><span class="quoted">"guard list"</span></span>
  Outputs <span class="main">::</span> <span class="quoted"><span class="quoted">"output_function list"</span></span>
  Updates <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">same_structure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">same_structure</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
    Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
    length <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_inputs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map enumerate_gexp_inputs <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map enumerate_aexp_inputs <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> enumerate_aexp_inputs <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_input</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> enumerate_inputs <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max <span class="main">(</span>enumerate_inputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">total_max_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total_max_input</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> max_input <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_regs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map GExp.enumerate_regs <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                      <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map AExp.enumerate_regs <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                      <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> AExp.enumerate_regs <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                      <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> AExp.enumerate_regs <span class="main">(</span>V <span class="main">(</span>R <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_reg</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> enumerate_regs <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max <span class="main">(</span>enumerate_regs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">total_max_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total_max_reg</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> max_reg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_ints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_ints</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map enumerate_gexp_ints <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                      <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map enumerate_aexp_ints <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                      <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> enumerate_aexp_ints <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                      <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> enumerate_aexp_ints <span class="main">(</span>V <span class="main">(</span>R <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_transition</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> enumerate_inputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">can_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> inputs <span class="main">⇒</span> registers <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">can_take</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∧</span> apply_guards <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transition-can_take_empty"><span class="command">lemma</span></span> can_take_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span> can_take <span class="free">a</span> <span class="main">[]</span> <span class="free">i</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_def<span class="main">)</span>

<span class="keyword1" id="Transition-can_take_subset_append"><span class="command">lemma</span></span> can_take_subset_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"can_take <span class="free">a</span> <span class="main">(</span>Guards <span class="free">t</span> <span class="main">@</span> Guards <span class="free">t'</span><span class="main">)</span> <span class="free">i</span> <span class="free">c</span> <span class="main">=</span> can_take <span class="free">a</span> <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span> <span class="free">i</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_subset_append can_take_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">can_take_transition</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> can_take <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> can_take <span class="main">=</span> can_take_def can_take_transition_def

<span class="keyword1" id="Transition-can_take_transition_empty_guard"><span class="command">lemma</span></span> can_take_transition_empty_guard<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Guards <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t</span> <span class="bound">i</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def Ex_list_of_length<span class="main">)</span>

<span class="keyword1" id="Transition-can_take_subset"><span class="command">lemma</span></span> can_take_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> Arity <span class="free">t</span> <span class="main">⟹</span>
   Arity <span class="free">t</span> <span class="main">=</span> Arity <span class="free">t'</span> <span class="main">⟹</span>
   set <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   can_take_transition <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   can_take_transition <span class="free">t'</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def apply_guards_subset<span class="main">)</span>

<span class="keyword1" id="Transition-valid_list_can_take"><span class="command">lemma</span></span> valid_list_can_take<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span><span class="main">.</span> valid <span class="bound">g</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t</span> <span class="bound">i</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def apply_guards_def valid_def Ex_list_of_length<span class="main">)</span>

<span class="keyword1" id="Transition-cant_take_if"><span class="command">lemma</span></span> cant_take_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span><span class="main">.</span> gval <span class="bound">g</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> true <span class="main">⟹</span>
   <span class="main">¬</span> can_take_transition <span class="free">t</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_guards_cons apply_guards_rearrange can_take_def can_take_transition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_outputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aexp list <span class="main">⇒</span> <span class="tfree">'a</span> datastate <span class="main">⇒</span> value option list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_outputs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> aval <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">evaluate_outputs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> apply_outputs <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transition-apply_outputs_nth"><span class="command">lemma</span></span> apply_outputs_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> apply_outputs <span class="free">p</span> <span class="free">s</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> aval <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_outputs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> apply_outputs <span class="main">=</span> datastate apply_outputs_def value_plus_def value_minus_def value_times_def

<span class="keyword1" id="Transition-apply_outputs_empty"><span class="command">lemma</span></span> apply_outputs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_outputs <span class="main">[]</span> <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_outputs_def<span class="main">)</span>

<span class="keyword1" id="Transition-apply_outputs_preserves_length"><span class="command">lemma</span></span> apply_outputs_preserves_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>apply_outputs <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> length <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_outputs_def<span class="main">)</span>

<span class="keyword1" id="Transition-apply_outputs_literal"><span class="command">lemma</span></span> apply_outputs_literal<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> L <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_outputs <span class="free">P</span> <span class="free">s</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms apply_outputs_nth<span class="main">)</span>

<span class="keyword1" id="Transition-apply_outputs_register"><span class="command">lemma</span></span> apply_outputs_register<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_outputs <span class="main">(</span>list_update <span class="free">P</span> <span class="free">r</span> <span class="main">(</span>V <span class="main">(</span>R <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> <span class="free">c</span> <span class="main">$</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apply_outputs_nth assms aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> join_ir_R length_list_update nth_list_update_eq<span class="main">)</span>

<span class="keyword1" id="Transition-apply_outputs_unupdated"><span class="command">lemma</span></span> apply_outputs_unupdated<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">≠</span> <span class="free">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">&lt;</span> length <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_outputs <span class="free">P</span> <span class="free">j</span> <span class="main">!</span> <span class="free">ia</span> <span class="main">=</span> apply_outputs <span class="main">(</span>list_update <span class="free">P</span> <span class="free">r</span> <span class="free">v</span><span class="main">)</span><span class="free">j</span> <span class="main">!</span> <span class="free">ia</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apply_outputs_nth assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_list_update nth_list_update_neq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list <span class="main">⇒</span> vname datastate <span class="main">⇒</span> registers <span class="main">⇒</span> registers"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_updates</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">(</span>fst <span class="bound">h</span> <span class="main">$:=</span> aval <span class="main">(</span>snd <span class="bound">h</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">old</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">evaluate_updates</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> apply_updates <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Transition-apply_updates_cons"><span class="command">lemma</span></span> apply_updates_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ra</span> <span class="main">≠</span> <span class="free">r</span> <span class="main">⟹</span>
       apply_updates <span class="free">u</span> <span class="main">(</span>join_ir <span class="free">ia</span> <span class="free">c</span><span class="main">)</span> <span class="free">c</span> <span class="main">$</span> <span class="free">ra</span> <span class="main">=</span> apply_updates <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">ia</span> <span class="free">c</span><span class="main">)</span> <span class="free">c</span> <span class="main">$</span> <span class="free">ra</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ra</span> <span class="main">=</span> <span class="improper">aa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transition-update_twice"><span class="command">lemma</span></span> update_twice<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_updates <span class="main">[</span><span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="free">s</span> <span class="free">regs</span> <span class="main">=</span> <span class="free">regs</span> <span class="main">(</span><span class="free">r</span> <span class="main">$:=</span> aval <span class="free">b</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def<span class="main">)</span>

<span class="keyword1" id="Transition-r_not_updated_stays_the_same"><span class="command">lemma</span></span> r_not_updated_stays_the_same<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">U</span> <span class="main">⟹</span> apply_updates <span class="free">U</span> <span class="free">c</span> <span class="free">d</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> <span class="free">d</span> <span class="main">$</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_updates_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rename_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> transition <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦇</span>
      Guards  <span class="main">:=</span> map <span class="main">(</span>GExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
      Outputs <span class="main">:=</span> map <span class="main">(</span>AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
      Updates <span class="main">:=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">r</span><span class="main">,</span> AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_upto_rename_strong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_upto_rename_strong</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span> <span class="main">∧</span> rename_regs <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eq_upto_rename</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span>
   Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span>
   apply_guards <span class="main">(</span>map <span class="main">(</span>GExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> apply_guards <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">⟹</span>

   apply_outputs <span class="main">(</span>map <span class="main">(</span>AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> apply_outputs <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">⟹</span>

   apply_updates <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">r</span><span class="main">,</span> AExp.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> apply_updates <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">⟹</span>

   <span class="free">eq_upto_rename</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Transition_Lexorder">
<div class="head">
<h1>Theory Transition_Lexorder</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Transition Lexorder›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory defines a lexicographical ordering on transitions such that we can convert from
the set representation of EFSMs to a sorted list that we can recurse over.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_Lexorder
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Transition.html">Transition</a>"</span>
    <a href="GExp_Lexorder.html">GExp_Lexorder</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"transition_ext"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_transition_ext</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder transition_scheme <span class="main">⇒</span> <span class="tfree">'a</span> transition_scheme <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">less_transition_ext</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> more <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> more <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_transition_ext</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder transition_scheme <span class="main">⇒</span> <span class="tfree">'a</span> transition_scheme <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">less_eq_transition_ext</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_transition_ext_def less_transition_ext_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> less_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> less_imp_not_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject equality neqE<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EFSM">
<div class="head">
<h1>Theory EFSM</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extended Finite State Machines›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory defines extended finite state machines as presented in \cite{foster2018}. States
are indexed by natural numbers, however, since transition matrices are implemented by finite sets,
the number of reachable states in $S$ is necessarily finite. For ease of implementation, we
implicitly make the initial state zero for all EFSMs. This allows EFSMs to be represented purely by
their transition matrix which, in this implementation, is a finite set of tuples of the form
$((s_1, s_2), t)$ in which $s_1$ is the origin state, $s_2$ is the destination state, and $t$ is a
transition.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> EFSM
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span> <a href="Transition.html">Transition</a> <a href="FSet_Utils.html">FSet_Utils</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> One_nat_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">type_synonym</span></span> cfstate <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> inputs <span class="main">=</span> <span class="quoted"><span class="quoted">"value list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> outputs <span class="main">=</span> <span class="quoted"><span class="quoted">"value option list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> action <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>label <span class="main">×</span> inputs<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> execution <span class="main">=</span> <span class="quoted"><span class="quoted">"action list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> observation <span class="main">=</span> <span class="quoted"><span class="quoted">"outputs list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> transition_matrix <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> <span class="main">×</span> transition<span class="main">)</span> fset"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> relcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">O</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> comp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">o</span>"</span> 55<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> event <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>label <span class="main">×</span> inputs <span class="main">×</span> value list<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"event list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> log <span class="main">=</span> <span class="quoted"><span class="quoted">"trace list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Str</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Str</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> value.Str <span class="main">(</span>String.implode <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-str_not_num"><span class="command">lemma</span></span> str_not_num<span class="main">:</span> <span class="quoted"><span class="quoted">"Str <span class="free">s</span> <span class="main">≠</span> Num <span class="free">x1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Str_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">|∪|</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1" id="EFSM-S_ffUnion"><span class="command">lemma</span></span> S_ffUnion<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">e</span> <span class="main">=</span> ffUnion <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">{|</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">|}</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Possible Steps›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹From a given state, the possible steps for a given action are those transitions with labels
which correspond to the action label, arities which correspond to the number of inputs, and guards
which are satisfied by those inputs.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">possible_steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> label <span class="main">⇒</span> inputs <span class="main">⇒</span> <span class="main">(</span>cfstate <span class="main">×</span> transition<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">possible_steps</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">dest</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span>Label <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Arity <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-possible_steps_finsert"><span class="command">lemma</span></span> possible_steps_finsert<span class="main">:</span>
<span class="quoted"><span class="quoted">"possible_steps <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="free">ss</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free">s</span> <span class="main">=</span> <span class="free">ss</span> <span class="main">∧</span> <span class="main">(</span>Label <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Arity <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">then</span>
    finsert <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>
  <span class="keyword1">else</span>
    possible_steps <span class="free">e</span> <span class="free">ss</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span>
<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def ffilter_finsert<span class="main">)</span>


<span class="keyword1" id="EFSM-split_origin"><span class="command">lemma</span></span> split_origin<span class="main">:</span>
<span class="quoted"><span class="quoted">"ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span>
ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-split_label"><span class="command">lemma</span></span> split_label<span class="main">:</span>
<span class="quoted"><span class="quoted">"ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span>
ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-possible_steps_empty_guards_false"><span class="command">lemma</span></span> possible_steps_empty_guards_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span><span class="main">)</span> <span class="free">e</span><span class="main">.</span> <span class="main">¬</span>can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
  possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def can_take<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> split_label<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_ffilter fBall_def Ball_def<span class="main">)</span>

<span class="keyword1" id="EFSM-fmember_possible_steps"><span class="command">lemma</span></span> fmember_possible_steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound"><span class="bound">origin</span></span><span class="main">,</span> <span class="bound"><span class="bound">dest</span></span><span class="main">)</span><span class="main">,</span> <span class="bound"><span class="bound">t</span></span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">e</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def ffilter_def fimage_def fmember_def Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="EFSM-possible_steps_alt_aux"><span class="command">lemma</span></span> possible_steps_alt_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span>
       ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fempty_not_finsert possible_steps_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa _
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_finsert<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="skolem">b</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="skolem">b</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-possible_steps_alt"><span class="command">lemma</span></span> possible_steps_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ffilter
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
     <span class="free">e</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_alt_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def<span class="main">)</span>

<span class="keyword1" id="EFSM-possible_steps_alt3"><span class="command">lemma</span></span> possible_steps_alt3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ffilter
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span>
     <span class="free">e</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_alt_aux can_take<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def can_take<span class="main">)</span>

<span class="keyword1" id="EFSM-possible_steps_alt_atom"><span class="command">lemma</span></span> possible_steps_alt_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="free">dt</span><span class="main">|}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ffilter
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span>
     <span class="free">e</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> fst <span class="free">dt</span><span class="main">)</span><span class="main">,</span> snd <span class="free">dt</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dt</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_alt can_take_transition_def can_take_def<span class="main">)</span>

<span class="keyword1" id="EFSM-possible_steps_alt2"><span class="command">lemma</span></span> possible_steps_alt2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> filter_filter<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">origin</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">dest</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">origin</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">∧</span></span> Label <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">l</span></span> <span class="main"><span class="main">∧</span></span> length <span class="free"><span class="free">i</span></span> <span class="main"><span class="main">=</span></span> Arity <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">∧</span></span> apply_guards <span class="main"><span class="main">(</span></span>Guards <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>join_ir <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="EFSM-possible_steps_single_out"><span class="command">lemma</span></span> possible_steps_single_out<span class="main">:</span>
<span class="quoted"><span class="quoted">"ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span>
Label <span class="free">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="free">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_alt2 Abs_ffilter<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-possible_steps_singleton"><span class="command">lemma</span></span> possible_steps_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound"><span class="bound">origin</span></span><span class="main">,</span> <span class="bound"><span class="bound">dest</span></span><span class="main">)</span><span class="main">,</span> <span class="bound"><span class="bound">t</span></span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">e</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_alt Abs_ffilter Set.filter_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="EFSM-possible_steps_apply_guards"><span class="command">lemma</span></span> possible_steps_apply_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span>
   apply_guards <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-possible_steps_empty"><span class="command">lemma</span></span> possible_steps_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">e</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">∨</span> Label <span class="bound">t</span> <span class="main">≠</span> <span class="free">l</span> <span class="main">∨</span> <span class="main">¬</span> can_take_transition <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def Abs_ffilter Set.filter_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-singleton_dest"><span class="command">lemma</span></span> singleton_dest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fis_singleton <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">aa</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fthe_elem <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">aa</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">baa</span><span class="main">,</span> <span class="free">aba</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">baa</span><span class="main">)</span><span class="main">,</span> <span class="free">aba</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fis_singleton_fthe_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> possible_steps_alt_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="EFSM-no_outgoing_transitions"><span class="command">lemma</span></span> no_outgoing_transitions<span class="main">:</span>
<span class="quoted"><span class="quoted">"ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span>
possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-ffilter_split"><span class="command">lemma</span></span> ffilter_split<span class="main">:</span> <span class="quoted"><span class="quoted">"ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span>
                      ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-one_outgoing_transition"><span class="command">lemma</span></span> one_outgoing_transition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">outgoing</span> <span class="free">s</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>ffilter <span class="main">(</span><span class="free">outgoing</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> less_eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> size_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span>size <span class="bound">f</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> prem
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> possible_steps_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fimage_size_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ffilter_split outgoing_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> size_ffilter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Choice›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define the \texttt{choice} operator which determines whether or not two transitions are
nondeterministic.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">choice</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> apply_guards <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choice_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">choice_alt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> apply_guards <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">@</span>Guards <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-choice_alt"><span class="command">lemma</span></span> choice_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"choice <span class="free">t</span> <span class="free">t'</span> <span class="main">=</span> choice_alt <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> choice_def choice_alt_def apply_guards_append<span class="main">)</span>

<span class="keyword1" id="EFSM-choice_symmetry"><span class="command">lemma</span></span> choice_symmetry<span class="main">:</span> <span class="quoted"><span class="quoted">"choice <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> choice <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> choice_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deterministic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deterministic</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> size <span class="main">(</span>possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span> <span class="bound">r</span> <span class="bound">l</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-deterministic_alt_aux"><span class="command">lemma</span></span> deterministic_alt_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">=</span><span class="main">(</span>
        possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span> <span class="bound">t</span><span class="main">.</span>
            ffilter
             <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span>
            <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_equiv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> possible_steps_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_neq_implies_less le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_one prod.collapse size_fsingleton<span class="main">)</span>

<span class="keyword1" id="EFSM-deterministic_alt"><span class="command">lemma</span></span> deterministic_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">∀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">l</span> <span class="bound">i</span><span class="main">.</span>
    possible_steps <span class="free">e</span> <span class="bound">s</span> <span class="bound">r</span> <span class="bound">l</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span> <span class="bound">t</span><span class="main">.</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span>Label <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="bound">l</span> <span class="main">∧</span> <span class="main">(</span>length <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Arity <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span>
<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> deterministic_alt_aux
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def<span class="main">)</span>

<span class="keyword1" id="EFSM-size_le_1"><span class="command">lemma</span></span> size_le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">f</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">e</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> bot.not_eq_extremum gr_implies_not0 le_neq_implies_less less_one size_fsingleton size_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-ffilter_empty_if"><span class="command">lemma</span></span> ffilter_empty_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> ffilter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-empty_ffilter"><span class="command">lemma</span></span> empty_ffilter<span class="main">:</span> <span class="quoted"><span class="quoted">"ffilter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-all_states_deterministic"><span class="command">lemma</span></span> all_states_deterministic<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">l</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span>
  ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span>Label <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="bound">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span>Label <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="bound">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span>
<span class="main">)</span> <span class="main">⟹</span> deterministic <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> deterministic_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s r l i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> size_le_1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> disjI1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def can_take_transition_def can_take_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ ba
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def can_take_transition_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> can_take_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-deterministic_finsert"><span class="command">lemma</span></span> deterministic_finsert<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">r</span> <span class="bound">l</span><span class="main">.</span>
<span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span><span class="main">.</span>
Label <span class="bound">t</span> <span class="main">=</span> <span class="bound">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">⟶</span> <span class="main">¬</span> can_take_transition <span class="free">t'</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">⟹</span>
deterministic <span class="free">e</span> <span class="main">⟹</span>
deterministic <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def possible_steps_finsert can_take <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_fset_overloaded_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Label <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Label <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-ffilter_fBall"><span class="command">lemma</span></span> ffilter_fBall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ffilter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-fsubset_if"><span class="command">lemma</span></span> fsubset_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">f1</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">f2</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">|⊆|</span> <span class="free">f2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-in_possible_steps"><span class="command">lemma</span></span> in_possible_steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|∈|</span><span class="free">e</span> <span class="main">∧</span> Label <span class="free">t</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> can_take_transition <span class="free">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember_possible_steps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_def can_take_transition_def fmember.rep_eq<span class="main">)</span>

<span class="keyword1" id="EFSM-possible_steps_can_take_transition"><span class="command">lemma</span></span> possible_steps_can_take_transition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">⟹</span> can_take_transition <span class="free">t1</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_possible_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-not_deterministic"><span class="command">lemma</span></span> not_deterministic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">l</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">d1</span> <span class="bound">d2</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span>
      <span class="bound">d1</span> <span class="main">≠</span> <span class="bound">d2</span> <span class="main">∧</span> <span class="bound">t1</span> <span class="main">≠</span> <span class="bound">t2</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d1</span><span class="main">)</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span>
      Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span> <span class="main">∧</span>
      can_take_transition <span class="bound">t1</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">∧</span>
      can_take_transition <span class="bound">t2</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">⟹</span>
  <span class="main">¬</span>deterministic <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def not_le <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_fset_overloaded_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s i r d1 d2 t1 t2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Label <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="main">(</span>Label <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> in_possible_steps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="main">(</span>Label <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fempty_iff fsingleton_iff not_le_imp_less prod.inject size_le_1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> in_possible_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-not_deterministic_conv"><span class="command">lemma</span></span> not_deterministic_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>deterministic <span class="free">e</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s</span> <span class="bound">l</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">d1</span> <span class="bound">d2</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">d1</span> <span class="main">≠</span> <span class="bound">d2</span> <span class="main">∨</span> <span class="bound">t1</span> <span class="main">≠</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d1</span><span class="main">)</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span>
      Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span> <span class="main">∧</span>
      can_take_transition <span class="bound">t1</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">∧</span>
      can_take_transition <span class="bound">t2</span> <span class="bound">i</span> <span class="bound">r</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def not_le <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_fset_overloaded_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s r l i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">f'</span><span class="main">.</span> <span class="bound">e1</span> <span class="main">≠</span> <span class="bound">e2</span> <span class="main">∧</span> possible_steps <span class="free">e</span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">l</span> <span class="skolem">i</span> <span class="main">=</span> finsert <span class="bound">e1</span> <span class="main">(</span>finsert <span class="bound">e2</span> <span class="bound">f'</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> size_gt_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e1 e2 f'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">e1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">e2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b aa ba
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_fset_overloaded_simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finsertI1 finsert_commute in_possible_steps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-deterministic_if"><span class="command">lemma</span></span> deterministic_if<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">s</span> <span class="bound">l</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span>
  <span class="main">∃</span><span class="bound">d1</span> <span class="bound">d2</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">d1</span> <span class="main">≠</span> <span class="bound">d2</span> <span class="main">∨</span> <span class="bound">t1</span> <span class="main">≠</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d1</span><span class="main">)</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span>
    Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span> <span class="main">∧</span>
    can_take_transition <span class="bound">t1</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">∧</span>
    can_take_transition <span class="bound">t2</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">⟹</span>
  deterministic <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_deterministic_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span><span class="main">.</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="bound">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∄</span><span class="bound">t'</span> <span class="bound">s''</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span> <span class="main">≠</span> <span class="bound">s''</span> <span class="main">∨</span> <span class="bound">t'</span> <span class="main">≠</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> Label <span class="bound">t'</span> <span class="main">=</span> <span class="bound">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t'</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
 <span class="main">⟹</span> deterministic <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_fset_overloaded_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> size_le_1 possible_steps_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="improper">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|∈|</span><span class="free">e</span> <span class="main">∧</span> Label <span class="bound">t</span> <span class="main">=</span> <span class="improper">l</span> <span class="main">∧</span> can_take_transition <span class="bound">t</span> <span class="improper">i</span> <span class="improper">r</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> notin_fset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">s'</span><span class="main">,</span> <span class="improper">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> fempty_fsubsetI finsert_fsubset in_possible_steps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Label <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="improper">s</span><span class="main">,</span> <span class="improper">s'</span><span class="main">)</span><span class="main">,</span> <span class="improper">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">outgoing_transitions</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">o</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">o</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1" id="EFSM-in_outgoing"><span class="command">lemma</span></span> in_outgoing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> outgoing_transitions <span class="free">e</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">s1</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outgoing_transitions_def<span class="main">)</span>

<span class="keyword1" id="EFSM-outgoing_transitions_deterministic"><span class="command">lemma</span></span> outgoing_transitions_deterministic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span>
    <span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> outgoing_transitions <span class="free">e</span> <span class="bound">s</span><span class="main">.</span>
      <span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">|∈|</span> outgoing_transitions <span class="free">e</span> <span class="bound">s</span><span class="main">.</span>
        <span class="bound">s2</span> <span class="main">≠</span> <span class="bound">s2'</span> <span class="main">∨</span> <span class="bound">t</span> <span class="main">≠</span> <span class="bound">t'</span> <span class="main">⟶</span> Label <span class="bound">t</span> <span class="main">=</span> Label <span class="bound">t'</span> <span class="main">⟶</span> <span class="main">¬</span> choice <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟹</span> deterministic <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> deterministic_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fBall_def Ball_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i r d1 d2 t1
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">d1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>outgoing_transitions <span class="free">e</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outgoing_transitions_def choice_def can_take<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> fmember_implies_member<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outgoing_transitions_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fmember_implies_member<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-outgoing_transitions_deterministic2"><span class="command">lemma</span></span> outgoing_transitions_deterministic2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">ba</span> <span class="bound">aa</span> <span class="bound">bb</span> <span class="bound">bc</span><span class="main">.</span>
       <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span> <span class="main">|∈|</span> outgoing_transitions <span class="free">e</span> <span class="bound">s</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="bound">bb</span><span class="main">)</span><span class="main">,</span> <span class="bound">bc</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">(</span>outgoing_transitions <span class="free">e</span> <span class="bound">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{|</span><span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">≠</span> <span class="bound">bb</span> <span class="main">∨</span> <span class="bound">ba</span> <span class="main">≠</span> <span class="bound">bc</span> <span class="main">⟹</span> <span class="main">¬</span>choice <span class="bound">ba</span> <span class="bound">bc</span><span class="main">)</span>
        <span class="main">⟹</span> deterministic <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> outgoing_transitions_deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-outgoing_transitions_fprod_deterministic"><span class="command">lemma</span></span> outgoing_transitions_fprod_deterministic<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">b</span> <span class="bound">ba</span> <span class="bound">bb</span> <span class="bound">bc</span><span class="main">.</span>
<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">bb</span><span class="main">)</span><span class="main">,</span> <span class="bound">bc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>outgoing_transitions <span class="free">e</span> <span class="bound">s</span><span class="main">)</span> <span class="main">×</span> fset <span class="main">(</span>outgoing_transitions <span class="free">e</span> <span class="bound">s</span><span class="main">)</span>
<span class="main">⟹</span> <span class="bound">b</span> <span class="main">≠</span> <span class="bound">bb</span> <span class="main">∨</span> <span class="bound">ba</span> <span class="main">≠</span> <span class="bound">bc</span> <span class="main">⟹</span> Label <span class="bound">ba</span> <span class="main">=</span> Label <span class="bound">bc</span> <span class="main">⟹</span> <span class="main">¬</span>choice <span class="bound">ba</span> <span class="bound">bc</span><span class="main">)</span>
<span class="main">⟹</span> deterministic <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> outgoing_transitions_deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SigmaI fmember_implies_member in_outgoing<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \texttt{random\_member} function returns a random member from a finite set, or
\texttt{None}, if the set is empty.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">random_member</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">random_member</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-random_member_nonempty"><span class="command">lemma</span></span> random_member_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">=</span> <span class="main">(</span>random_member <span class="free">s</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>

<span class="keyword1" id="EFSM-random_member_singleton"><span class="command">lemma</span></span> random_member_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"random_member <span class="main">{|</span><span class="free">a</span><span class="main">|}</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>

<span class="keyword1" id="EFSM-random_member_is_member"><span class="command">lemma</span></span> random_member_is_member<span class="main">:</span>
  <span class="quoted"><span class="quoted">"random_member <span class="free">ss</span> <span class="main">=</span> Some <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">|∈|</span> <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equalsffemptyI option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject verit_sko_ex_indirect<span class="main">)</span>

<span class="keyword1" id="EFSM-random_member_None"><span class="command">lemma</span></span> random_member_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"random_member <span class="free">ss</span> <span class="main">=</span> None <span class="main">=</span> <span class="main">(</span><span class="free">ss</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>

<span class="keyword1" id="EFSM-random_member_empty"><span class="command">lemma</span></span> random_member_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"random_member <span class="main">{||}</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> label <span class="main">⇒</span> inputs <span class="main">⇒</span> <span class="main">(</span>transition <span class="main">×</span> cfstate <span class="main">×</span> outputs <span class="main">×</span> registers<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> random_member <span class="main">(</span>possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None <span class="main">|</span>
      Some <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span>  Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> evaluate_outputs <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-possible_steps_not_empty_iff"><span class="command">lemma</span></span> possible_steps_not_empty_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> None <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">aa</span> <span class="bound">ba</span><span class="main">.</span> <span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-step_member"><span class="command">lemma</span></span> step_member<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"random_member <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_is_member<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-step_outputs"><span class="command">lemma</span></span> step_outputs<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">⟹</span> evaluate_outputs <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"random_member <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-step"><span class="command">lemma</span></span> step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">possibilities</span> <span class="main">=</span> <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span>
   random_member <span class="free">possibilities</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   evaluate_outputs <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⟹</span>
   evaluate_updates <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">⟹</span>
   step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>

<span class="keyword1" id="EFSM-step_None"><span class="command">lemma</span></span> step_None<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> None <span class="main">=</span> <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def prod.case_eq_if random_member_def<span class="main">)</span>

<span class="keyword1" id="EFSM-step_Some"><span class="command">lemma</span></span> step_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span>
    random_member <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span>
    evaluate_outputs <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span>
    evaluate_updates <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"random_member <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-no_possible_steps_1"><span class="command">lemma</span></span> no_possible_steps_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span> step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def random_member_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Execution Observation›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹One of the key features of this formalisation of EFSMs is their ability to produce
\emph{outputs}, which represent function return values. When action sequences are executed in an
EFSM, they produce a corresponding \emph{observation}.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{observe}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">observe_execution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> execution <span class="main">⇒</span> outputs list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observe_execution</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">observe_execution</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">viable</span> <span class="main">=</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">viable</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span>
      <span class="main">[]</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="bound">viable</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">(</span>evaluate_outputs <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">observe_execution</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="EFSM-observe_execution_step_def"><span class="command">lemma</span></span> observe_execution_step_def<span class="main">:</span> <span class="quoted"><span class="quoted">"observe_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">[]</span><span class="main">|</span>
      Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">#</span><span class="main">(</span>observe_execution <span class="free">e</span> <span class="bound">s'</span> <span class="bound">r'</span> <span class="free">as</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x S'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="bound">xa</span> <span class="main">|∈|</span> <span class="skolem">S'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-observe_execution_first_outputs_equiv"><span class="command">lemma</span></span> observe_execution_first_outputs_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"observe_execution <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> observe_execution <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
   step <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">|∈|</span>possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> evaluate_outputs <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> observe_execution_step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"step <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> step_member case_prodI rev_fBexI step_outputs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-observe_execution_step"><span class="command">lemma</span></span> observe_execution_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">⟹</span>
   observe_execution <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">es</span> <span class="main">=</span> <span class="free">obs</span> <span class="main">⟹</span>
   observe_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">es</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">#</span><span class="free">obs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="improper">a</span> <span class="improper">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-observe_execution_possible_step"><span class="command">lemma</span></span> observe_execution_possible_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span>
   apply_outputs <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⟹</span>
   apply_updates <span class="main">(</span>Updates <span class="free">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">⟹</span>
   observe_execution <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">es</span> <span class="main">=</span> <span class="free">obs</span> <span class="main">⟹</span>
   observe_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">es</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">#</span><span class="free">obs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observe_execution_step step<span class="main">)</span>

<span class="keyword1" id="EFSM-observe_execution_no_possible_step"><span class="command">lemma</span></span> observe_execution_no_possible_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span>
   observe_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">es</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="EFSM-observe_execution_no_possible_steps"><span class="command">lemma</span></span> observe_execution_no_possible_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span>
   possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span>
   <span class="main">(</span>observe_execution <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>observe_execution <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observe_execution_no_possible_step<span class="main">)</span>

<span class="keyword1" id="EFSM-observe_execution_one_possible_step"><span class="command">lemma</span></span> observe_execution_one_possible_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">s1'</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span>
   possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">s2'</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span>
   apply_outputs <span class="main">(</span>Outputs <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> apply_outputs <span class="main">(</span>Outputs <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>

   apply_updates <span class="main">(</span>Updates <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">⟹</span>
   apply_updates <span class="main">(</span>Updates <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">⟹</span>
   <span class="main">(</span>observe_execution <span class="free">e1</span> <span class="free">s1'</span> <span class="free">r'</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>observe_execution <span class="free">e2</span> <span class="free">s2'</span> <span class="free">r'</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>observe_execution <span class="free">e1</span> <span class="free">s1</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>observe_execution <span class="free">e2</span> <span class="free">s2</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observe_execution_possible_step<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Utilities›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define some utility functions to access the various key properties of a given EFSM.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_reg</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">maxes</span> <span class="main">=</span> <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Transition.max_reg <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">maxes</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> fMax <span class="bound">maxes</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_ints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_ints</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Transition.enumerate_ints <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>fset <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_int</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>enumerate_ints <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_output</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_output</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> fMax <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>Outputs <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_regs</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> enumerate_regs <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>fset <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{finiteRegs}{1}{2}{%›</span></span>
<span class="keyword1" id="EFSM-finite_all_regs"><span class="command">lemma</span></span> finite_all_regs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>all_regs <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_regs_def enumerate_regs_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_UnI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> GExp.finite_enumerate_regs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> AExp.finite_enumerate_regs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AExp.finite_enumerate_regs prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_input</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> fMax <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Transition.max_input <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">maxS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maxS</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> fMax <span class="main">(</span><span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">|∪|</span> <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">dest</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Execution Recognition›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \texttt{recognises} function returns true if the given EFSM recognises a given execution.
That is, the EFSM is able to respond to each event in sequence. There is no restriction on the
outputs produced. When a recognised execution is observed, it produces an accepted trace of the
EFSM.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{recognises}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">recognises_execution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat <span class="main">⇒</span> registers <span class="main">⇒</span> execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">recognises_execution</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span>
         <span class="free">recognises_execution</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span>
         <span class="free">recognises_execution</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">recognises</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> recognises_execution <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> recognises <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="EFSM-no_possible_steps_rejects"><span class="command">lemma</span></span> no_possible_steps_rejects<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span> <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="EFSM-recognises_step_equiv"><span class="command">lemma</span></span> recognises_step_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> recognises_execution <span class="free">e</span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> recognises_execution.step<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">recognises_prim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat <span class="main">⇒</span> registers <span class="main">⇒</span> execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">recognises_prim</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">recognises_prim</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">poss_steps</span> <span class="main">=</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">poss_steps</span><span class="main">.</span> <span class="free">recognises_prim</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-recognises_prim"><span class="command">lemma</span></span> recognises_prim <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">t</span> <span class="main">=</span> recognises_prim <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> recognises_execution.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-recognises_single_possible_step"><span class="command">lemma</span></span> recognises_single_possible_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s'</span> <span class="main">(</span>evaluate_updates <span class="free">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">trace</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">trace</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.step<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-recognises_single_possible_step_atomic"><span class="command">lemma</span></span> recognises_single_possible_step_atomic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s'</span> <span class="main">(</span>apply_updates <span class="main">(</span>Updates <span class="free">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">trace</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">trace</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms prod.collapse recognises_single_possible_step<span class="main">)</span>

<span class="keyword1" id="EFSM-recognises_must_be_possible_step"><span class="command">lemma</span></span> recognises_must_be_possible_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">aa</span> <span class="bound">ba</span><span class="main">.</span> <span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> recognises_step_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="EFSM-recognises_possible_steps_not_empty"><span class="command">lemma</span></span> recognises_possible_steps_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-recognises_must_be_step"><span class="command">lemma</span></span> recognises_must_be_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">t</span> <span class="bound">s'</span> <span class="bound">p</span> <span class="bound">d'</span><span class="main">.</span> step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">d'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> recognises_step_equiv step_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_member_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ x S' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="bound">xa</span> <span class="main">|∈|</span> <span class="skolem">S'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-recognises_cons_step"><span class="command">lemma</span></span> recognises_cons_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">≠</span>  None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> recognises_must_be_step<span class="main">)</span>

<span class="keyword1" id="EFSM-no_step_none"><span class="command">lemma</span></span> no_step_none<span class="main">:</span>
  <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">aa</span> <span class="free">ba</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> recognises_cons_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="EFSM-step_none_rejects"><span class="command">lemma</span></span> step_none_rejects<span class="main">:</span>
  <span class="quoted"><span class="quoted">"step <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_step_none surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="EFSM-trace_reject"><span class="command">lemma</span></span> trace_reject<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> recognises_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="EFSM-trace_reject_no_possible_steps_atomic"><span class="command">lemma</span></span> trace_reject_no_possible_steps_atomic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span> <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> recognises_possible_steps_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-trace_reject_later"><span class="command">lemma</span></span> trace_reject_later<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span>
   <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_reject <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-recognition_prefix_closure"><span class="command">lemma</span></span> recognition_prefix_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">t</span><span class="main">@</span><span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.step<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-rejects_prefix"><span class="command">lemma</span></span> rejects_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">t</span> <span class="main">@</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> recognition_prefix_closure <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-recognises_head"><span class="command">lemma</span></span> recognises_head<span class="main">:</span> <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> recognises_execution <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">[</span><span class="free">h</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> recognition_prefix_closure<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Trace Acceptance›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \texttt{accepts} function returns true if the given EFSM accepts a given trace. That is,
the EFSM is able to respond to each event in sequence \emph{and} is able to produce the expected
output. Accepted traces represent valid runs of an EFSM.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{accepts}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">accepts_trace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> trace <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">accepts_trace</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span>
         evaluate_outputs <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> map Some <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free">accepts_trace</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span>
         <span class="free">accepts_trace</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{T}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> trace set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> accepts_trace <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rejects_trace</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">¬</span> accepts_trace <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="EFSM-accepts_trace_step"><span class="command">lemma</span></span> accepts_trace_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepts_trace <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span>
         evaluate_outputs <span class="bound">T</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> map Some <span class="free">p</span> <span class="main">∧</span>
         accepts_trace <span class="free">e</span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> accepts_trace.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> accepts_trace.step<span class="main">)</span>

<span class="keyword1" id="EFSM-accepts_trace_exists_possible_step"><span class="command">lemma</span></span> accepts_trace_exists_possible_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepts_trace <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∃</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span><span class="main">|∈|</span>possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">aa</span> <span class="free">b</span><span class="main">.</span>
          evaluate_outputs <span class="bound">t1</span> <span class="free">b</span> <span class="free">r1</span> <span class="main">=</span> map Some <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> accepts_trace_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-rejects_trace_step"><span class="command">lemma</span></span> rejects_trace_step<span class="main">:</span>
<span class="quoted"><span class="quoted">"rejects_trace <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span>  evaluate_outputs <span class="bound">T</span> <span class="free">i</span> <span class="free">r</span> <span class="main">≠</span> map Some <span class="free">p</span> <span class="main">∨</span> rejects_trace <span class="free">e</span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>
<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_trace_step<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accepts_log</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace set <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accepts_log</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> accepts_trace <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{prefixClosure}{1}{2}{%›</span></span>
<span class="keyword1" id="EFSM-prefix_closure"><span class="command">lemma</span></span> prefix_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"accepts_trace <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">t</span><span class="main">@</span><span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> accepts_trace <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_trace_step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For code generation, it is much more efficient to re-implement the \texttt{accepts\_trace}
function primitively than to use the code generator's default setup for inductive definitions.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">accepts_trace_prim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> trace <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accepts_trace_prim</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">accepts_trace_prim</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">poss_steps</span> <span class="main">=</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> fis_singleton <span class="bound">poss_steps</span> <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="bound">poss_steps</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> evaluate_outputs <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> map Some <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
        <span class="free">accepts_trace_prim</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
      <span class="keyword1">else</span> False
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">poss_steps</span><span class="main">.</span>
         evaluate_outputs <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>map Some <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∧</span>
         <span class="free">accepts_trace_prim</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-accepts_trace_prim"><span class="command">lemma</span></span> accepts_trace_prim <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"accepts_trace <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="main">=</span> accepts_trace_prim <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_trace_step Let_def fis_singleton_alt<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹EFSM Comparison›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here, we define some different metrics of EFSM equality.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹State Isomporphism›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Two EFSMs are isomorphic with respect to states if there exists a bijective function between
the state names of the two EFSMs, i.e. the only difference between the two models is the way the
states are indexed.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isomorphic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isomorphic</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">f</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">s2</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Register Isomporphism›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Two EFSMs are isomorphic with respect to registers if there exists a bijective function between
the indices of the registers in the two EFSMs, i.e. the only difference between the two models is
the way the registers are indexed.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rename_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> transition_matrix"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_regs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tf</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">tf</span><span class="main">,</span> Transition.rename_regs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_upto_rename_strong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_upto_rename_strong</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span> <span class="main">∧</span> rename_regs <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Trace Simulation›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An EFSM, $e_1$ simulates another EFSM $e_2$ if there is a function between the states of the
states of $e_1$ and $e_1$ such that in each state, if $e_1$ can respond to the event and produce
the correct output, so can $e_2$.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{traceSim}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">trace_simulation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">⇒</span> cfstate<span class="main">)</span> <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span>
transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> trace <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⟹</span> <span class="free">trace_simulation</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⟹</span>
         <span class="main">∀</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">=</span> map Some <span class="free"><span class="bound"><span class="entity">o</span></span></span><span class="main">)</span> <span class="main">(</span>possible_steps <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">.</span>
           <span class="main">∃</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> evaluate_outputs <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">=</span> map Some <span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">∧</span>
            <span class="free">trace_simulation</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⟹</span>
         <span class="free">trace_simulation</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">o</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="EFSM-trace_simulation_step"><span class="command">lemma</span></span> trace_simulation_step<span class="main">:</span>
<span class="quoted"><span class="quoted">"trace_simulation <span class="free">f</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span><span class="main">#</span><span class="free">es</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="free">s2</span> <span class="main">=</span> <span class="free">f</span> <span class="free">s1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span> <span class="main">=</span> map Some <span class="free">o</span><span class="main">)</span> <span class="main">(</span>possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span>
         <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> evaluate_outputs <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span> <span class="main">=</span> map Some <span class="free">o</span> <span class="main">∧</span>
         trace_simulation <span class="free">f</span> <span class="free">e1</span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span><span class="main">)</span> <span class="free">e2</span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span>
<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_simulation.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_simulation.step<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-trace_simulation_step_none"><span class="command">lemma</span></span> trace_simulation_step_none<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> <span class="free">f</span> <span class="free">s1</span> <span class="main">⟹</span>
   <span class="main">∄</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span> <span class="main">=</span> map Some <span class="free">o</span> <span class="main">⟹</span>
   trace_simulation <span class="free">f</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span><span class="main">#</span><span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_simulation.step<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span> <span class="main">=</span> map Some <span class="free">o</span><span class="main">)</span> <span class="main">(</span>possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace_simulates</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> trace_simulation <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-rejects_trace_simulation"><span class="command">lemma</span></span> rejects_trace_simulation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rejects_trace <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">t</span> <span class="main">⟹</span>
   accepts_trace <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">t</span> <span class="main">⟹</span>
   <span class="main">¬</span>trace_simulation <span class="free">f</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quoted"><span class="free">r2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> accepts_trace.base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rejects_trace_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_trace_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_simulation.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l o _ _ i
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="skolem">i</span> <span class="skolem">r1</span> <span class="main">=</span> map Some <span class="skolem">o</span><span class="main">)</span> <span class="main">(</span>possible_steps <span class="free">e1</span> <span class="skolem">s1</span> <span class="skolem">r1</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-accepts_trace_simulation"><span class="command">lemma</span></span> accepts_trace_simulation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepts_trace <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">t</span> <span class="main">⟹</span>
   trace_simulation <span class="free">f</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">t</span> <span class="main">⟹</span>
   accepts_trace <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rejects_trace_simulation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-simulates_trace_subset"><span class="command">lemma</span></span> simulates_trace_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_simulates <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟹</span> T <span class="free">e1</span> <span class="main">⊆</span> T <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> T_def accepts_trace_simulation trace_simulates_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Trace Equivalence›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Two EFSMs are trace equivalent if they accept the same traces. This is the intuitive definition
of ``observable equivalence'' between the behaviours of the two models. If two EFSMs are trace
equivalent, there is no trace which can distinguish the two.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{traceEquiv}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace_equivalent</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> T <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{simEquiv}{1}{2}{%›</span></span>
<span class="keyword1" id="EFSM-simulation_implies_trace_equivalent"><span class="command">lemma</span></span> simulation_implies_trace_equivalent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_simulates <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟹</span> trace_simulates <span class="free">e2</span> <span class="free">e1</span> <span class="main">⟹</span> trace_equivalent <span class="free">e1</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command">using</span></span> simulates_trace_subset trace_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-trace_equivalent_reflexive"><span class="command">lemma</span></span> trace_equivalent_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_equivalent <span class="free">e1</span> <span class="free">e1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_equivalent_def<span class="main">)</span>

<span class="keyword1" id="EFSM-trace_equivalent_symmetric"><span class="command">lemma</span></span> trace_equivalent_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_equivalent <span class="free">e1</span> <span class="free">e2</span> <span class="main">=</span> trace_equivalent <span class="free">e2</span> <span class="free">e1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_equivalent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-trace_equivalent_transitive"><span class="command">lemma</span></span> trace_equivalent_transitive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_equivalent <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟹</span>
   trace_equivalent <span class="free">e2</span> <span class="free">e3</span> <span class="main">⟹</span>
   trace_equivalent <span class="free">e1</span> <span class="free">e3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_equivalent_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Two EFSMs are trace equivalent if they accept the same traces.›</span></span>
<span class="keyword1" id="EFSM-trace_equivalent"><span class="command">lemma</span></span> trace_equivalent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> accepts_trace <span class="free">e1</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">=</span> accepts_trace <span class="free">e2</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">⟹</span> trace_equivalent <span class="free">e1</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_def trace_equivalent_def<span class="main">)</span>

<span class="keyword1" id="EFSM-accepts_trace_step_2"><span class="command">lemma</span></span> accepts_trace_step_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s2'</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span> <span class="main">⟹</span>
       accepts_trace <span class="free">e2</span> <span class="free">s2'</span> <span class="main">(</span>evaluate_updates <span class="free">t2</span> <span class="free">i</span> <span class="free">r2</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span>
       evaluate_outputs <span class="free">t2</span> <span class="free">i</span> <span class="free">r2</span> <span class="main">=</span> map Some <span class="free">p</span> <span class="main">⟹</span>
       accepts_trace <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> accepts_trace.step<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Execution Simulation›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Execution simulation is similar to trace simulation but for executions rather than traces.
Execution simulation has no notion of ``expected'' output. It simply requires that the simulating
EFSM must be able to produce equivalent output for each action.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{execSim}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">execution_simulation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">⇒</span> cfstate<span class="main">)</span> <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span>
registers <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⟹</span> <span class="free">execution_simulation</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⟹</span>
         <span class="main">∀</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">(</span>possible_steps <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">.</span>
           <span class="main">∃</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span>
            evaluate_outputs <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">=</span> evaluate_outputs <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">∧</span>
            <span class="free">execution_simulation</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⟹</span>
         <span class="free">execution_simulation</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">execution_simulates</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> execution_simulation <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM-execution_simulation_step"><span class="command">lemma</span></span> execution_simulation_step<span class="main">:</span>
<span class="quoted"><span class="quoted">"execution_simulation <span class="free">f</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">es</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="free">s2</span> <span class="main">=</span> <span class="free">f</span> <span class="free">s1</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">(</span>possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span>
         <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span> <span class="main">=</span> evaluate_outputs <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span> <span class="main">∧</span>
         execution_simulation <span class="free">f</span> <span class="free">e1</span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span><span class="main">)</span> <span class="free">e2</span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span>
<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> execution_simulation.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> execution_simulation.step<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{execTraceSim}{1}{2}{%›</span></span>
<span class="keyword1" id="EFSM-execution_simulation_trace_simulation"><span class="command">lemma</span></span> execution_simulation_trace_simulation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"execution_simulation <span class="free">f</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   trace_simulation <span class="free">f</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> execution_simulation.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_simulation.base<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> execution_simulation.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_simulation.step<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ aa ba
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-execution_simulates_trace_simulates"><span class="command">lemma</span></span> execution_simulates_trace_simulates<span class="main">:</span>
  <span class="quoted"><span class="quoted">"execution_simulates <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟹</span> trace_simulates <span class="free">e1</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> execution_simulates_def trace_simulates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> execution_simulation_trace_simulation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Executional Equivalence›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Two EFSMs are executionally equivalent if there is no execution which can distinguish between
the two. That is, for every execution, they must produce equivalent outputs.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{execEquiv}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">executionally_equivalent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span>
transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">executionally_equivalent</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span>
           <span class="main">∃</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span>
             evaluate_outputs <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">=</span> evaluate_outputs <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">∧</span>
             <span class="free">executionally_equivalent</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⟹</span>
         <span class="main">∀</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span>
           <span class="main">∃</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span>
             evaluate_outputs <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">=</span> evaluate_outputs <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">∧</span>
             <span class="free">executionally_equivalent</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⟹</span>
         <span class="free">executionally_equivalent</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="EFSM-executionally_equivalent_step"><span class="command">lemma</span></span> executionally_equivalent_step<span class="main">:</span>
<span class="quoted"><span class="quoted">"executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">es</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">(</span>possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span> <span class="main">=</span> evaluate_outputs <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span> <span class="main">∧</span>
   executionally_equivalent <span class="free">e1</span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span><span class="main">)</span> <span class="free">e2</span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s2'</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">(</span>possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> evaluate_outputs <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span> <span class="main">=</span> evaluate_outputs <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span> <span class="main">∧</span>
   executionally_equivalent <span class="free">e1</span> <span class="bound">s1'</span> <span class="main">(</span>evaluate_updates <span class="bound">t1</span> <span class="free">i</span> <span class="free">r1</span><span class="main">)</span> <span class="free">e2</span> <span class="bound">s2'</span> <span class="main">(</span>evaluate_updates <span class="bound">t2</span> <span class="free">i</span> <span class="free">r2</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> executionally_equivalent.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> executionally_equivalent.step<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="EFSM-execution_end"><span class="command">lemma</span></span> execution_end<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span>
   possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span>
  executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step<span class="main">)</span>

<span class="keyword1" id="EFSM-possible_steps_disparity"><span class="command">lemma</span></span> possible_steps_disparity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">l</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">⟹</span>
   possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span>
   <span class="main">¬</span>executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="EFSM-executionally_equivalent_acceptance_map"><span class="command">lemma</span></span> executionally_equivalent_acceptance_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   accepts_trace <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">t</span> <span class="main">=</span> accepts_trace <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> executionally_equivalent.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i p l
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> accepts_trace.cases<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> accepts_trace.step<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"possible_steps <span class="free"><span class="free">e2</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> accepts_trace.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ aa b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> accepts_trace.step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-executionally_equivalent_acceptance"><span class="command">lemma</span></span> executionally_equivalent_acceptance<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="bound">x</span> <span class="main">⟹</span> accepts_trace <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span>  <span class="free">t</span> <span class="main">⟹</span> accepts_trace <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> executionally_equivalent_acceptance_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-executionally_equivalent_trace_equivalent"><span class="command">lemma</span></span> executionally_equivalent_trace_equivalent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> executionally_equivalent <span class="free">e1</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">e2</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">x</span> <span class="main">⟹</span> trace_equivalent <span class="free">e1</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_equivalent<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_acceptance_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-executionally_equivalent_symmetry"><span class="command">lemma</span></span> executionally_equivalent_symmetry<span class="main">:</span>
  <span class="quoted"><span class="quoted">"executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">x</span> <span class="main">⟹</span>
   executionally_equivalent <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b aaa ba
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aaa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"possible_steps <span class="free"><span class="free">e2</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="skolem"><span class="skolem">b</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b aaa ba
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aaa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-executionally_equivalent_transitivity"><span class="command">lemma</span></span> executionally_equivalent_transitivity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">x</span> <span class="main">⟹</span>
   executionally_equivalent <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">e3</span> <span class="free">s3</span> <span class="free">r3</span> <span class="free">x</span> <span class="main">⟹</span>
   executionally_equivalent <span class="free">e1</span> <span class="free">s1</span> <span class="free">r1</span> <span class="free">e3</span> <span class="free">s3</span> <span class="free">r3</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quoted"><span class="free">s3</span></span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quoted"><span class="free">r3</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b ab ba
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ab</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"possible_steps <span class="free"><span class="free">e1</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="skolem"><span class="skolem">b</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fBexE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b ab ba
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ab</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"possible_steps <span class="free"><span class="free">e3</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="skolem"><span class="skolem">r3</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="skolem"><span class="skolem">b</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fBexE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aaa baa
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aaa</span><span class="main">,</span> <span class="skolem">baa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBallE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"possible_steps <span class="free"><span class="free">e2</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="skolem"><span class="skolem">b</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Reachability›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here, we define the function \texttt{visits} which returns true if the given execution
leaves the given EFSM in the given state.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{reachable}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">visits</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cfstate <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">visits</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="free">visits</span> <span class="free"><span class="bound"><span class="entity">target</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span>
         <span class="free">visits</span> <span class="free"><span class="bound"><span class="entity">target</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> visits <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="EFSM-no_further_steps"><span class="command">lemma</span></span> no_further_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">¬</span> visits <span class="free">s</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> visits.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-visits_base"><span class="command">lemma</span></span> visits_base<span class="main">:</span> <span class="quoted"><span class="quoted">"visits <span class="free">target</span> <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">=</span> <span class="free">target</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> visits.base no_further_steps<span class="main">)</span>

<span class="keyword1" id="EFSM-visits_step"><span class="command">lemma</span></span> visits_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"visits <span class="free">target</span> <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">h</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span><span class="main">.</span> visits <span class="free">target</span> <span class="free">e</span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="main">(</span>snd <span class="free">h</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> visits.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> visits.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-reachable_initial"><span class="command">lemma</span></span> reachable_initial<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">0</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="EFSM-visits_finsert"><span class="command">lemma</span></span> visits_finsert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"visits <span class="free">s</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span> visits <span class="free">s</span> <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> visits_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> visits_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fBexE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_finsert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-reachable_finsert"><span class="command">lemma</span></span> reachable_finsert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reachable <span class="free">s</span> <span class="free">e</span> <span class="main">⟹</span> reachable <span class="free">s</span> <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> visits_finsert<span class="main">)</span>

<span class="keyword1" id="EFSM-reachable_finsert_contra"><span class="command">lemma</span></span> reachable_finsert_contra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> reachable <span class="free">s</span> <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>reachable <span class="free">s</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reachable_finsert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-visits_empty"><span class="command">lemma</span></span> visits_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"visits <span class="free">s</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">=</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> visits.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">remove_state</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">from</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="bound">to</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{obtainable}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="quoted">"<span class="entity">obtains</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">obtains</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="free">obtains</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s''</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span>
         <span class="free">obtains</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">obtainable</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> obtains <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="EFSM-obtains_obtainable"><span class="command">lemma</span></span> obtains_obtainable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtains <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">t</span> <span class="main">⟹</span> obtainable <span class="free">s</span> <span class="free">r</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtainable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-obtains_base"><span class="command">lemma</span></span> obtains_base<span class="main">:</span> <span class="quoted"><span class="quoted">"obtains <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtains.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="EFSM-obtains_step"><span class="command">lemma</span></span> obtains_step<span class="main">:</span> <span class="quoted"><span class="quoted">"obtains <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">l</span> <span class="free">i</span><span class="main">.</span> obtains <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="bound">s''</span> <span class="main">(</span>evaluate_updates <span class="bound">T</span> <span class="free">i</span> <span class="free">r'</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtains.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains.step<span class="main">)</span>

<span class="keyword1" id="EFSM-obtains_recognises"><span class="command">lemma</span></span> obtains_recognises<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtains <span class="free">s</span> <span class="free">c</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span> recognises_execution <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtains.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">using</span></span> recognises_execution.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-ex_comm4"><span class="command">lemma</span></span> ex_comm4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">c1</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> obtains <span class="bound">s</span> <span class="bound">c1</span> <span class="free">e</span> <span class="bound">a</span> <span class="main">(</span>evaluate_updates <span class="bound">b</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">s</span> <span class="bound">c1</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> obtains <span class="bound">s</span> <span class="bound">c1</span> <span class="free">e</span> <span class="bound">a</span> <span class="main">(</span>evaluate_updates <span class="bound">b</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM-recognises_execution_obtains"><span class="command">lemma</span></span> recognises_execution_obtains<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c1</span> <span class="bound">s</span><span class="main">.</span> obtains <span class="bound">s</span> <span class="bound">c1</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fBex_def Bex_def ex_comm4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ aa ba
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember_implies_member<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-obtainable_empty_efsm"><span class="command">lemma</span></span> obtainable_empty_efsm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtainable <span class="free">s</span> <span class="free">c</span> <span class="main">{||}</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="main">&lt;&gt;</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtainable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ffilter_empty no_outgoing_transitions no_step_none obtains.cases obtains_recognises step_None<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> obtains_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-obtains_visits"><span class="command">lemma</span></span> obtains_visits<span class="main">:</span> <span class="quoted"><span class="quoted">"obtains <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">t</span> <span class="main">⟹</span> visits <span class="free">s</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">r'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtains.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> visits.step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-unobtainable_if"><span class="command">lemma</span></span> unobtainable_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> visits <span class="free">s</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> obtains <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> obtains_visits <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM-obtainable_if_unreachable"><span class="command">lemma</span></span> obtainable_if_unreachable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>reachable <span class="free">s</span> <span class="free">e</span> <span class="main">⟹</span> <span class="main">¬</span>obtainable <span class="free">s</span> <span class="free">r</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def obtainable_def unobtainable_if<span class="main">)</span>

<span class="keyword1" id="EFSM-obtains_step_append"><span class="command">lemma</span></span> obtains_step_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtains <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="free">t</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">s''</span><span class="main">,</span> <span class="free">ta</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">⟹</span>
  obtains <span class="free">s''</span> <span class="main">(</span>evaluate_updates <span class="free">ta</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">e</span> <span class="free">s'</span> <span class="free">r'</span> <span class="main">(</span><span class="free">t</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">r'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtains.step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s''</span><span class="main">,</span> <span class="free">ta</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtains.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtains.step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EFSM-reachable_if_obtainable_step"><span class="command">lemma</span></span> reachable_if_obtainable_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtainable <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="bound">l</span> <span class="bound">i</span> <span class="main">⟹</span> reachable <span class="free">s'</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def obtainable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t l i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> obtains_step_append unobtainable_if <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EFSM-possible_steps_remove_unreachable"><span class="command">lemma</span></span> possible_steps_remove_unreachable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtainable <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="main">⟹</span>
  <span class="main">¬</span> reachable <span class="free">s'</span> <span class="free">e</span> <span class="main">⟹</span>
  possible_steps <span class="main">(</span>remove_state <span class="free">s'</span> <span class="free">e</span><span class="main">)</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fsubset_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ffmember_filter in_possible_steps remove_state_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fsubset_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">s'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> reachable_if_obtainable_step <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ffmember_filter in_possible_steps obtainable_if_unreachable old.prod.case<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{removeUnreachableArb}{1}{2}{%›</span></span>
<span class="keyword1" id="EFSM-executionally_equivalent_remove_unreachable_state_arbitrary"><span class="command">lemma</span></span> executionally_equivalent_remove_unreachable_state_arbitrary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtainable <span class="free">s</span> <span class="free">r</span> <span class="free">e</span> <span class="main">⟹</span> <span class="main">¬</span> reachable <span class="free">s'</span> <span class="free">e</span> <span class="main">⟹</span> executionally_equivalent <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>remove_state <span class="free">s'</span> <span class="free">e</span><span class="main">)</span> <span class="free">s</span> <span class="free">r</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> executionally_equivalent.step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_remove_unreachable<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b ab ba
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ab</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> obtainable_def obtains_step_append case_prodI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">ab</span><span class="main">,</span> <span class="improper">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> obtainable_def obtains_step_append possible_steps_remove_unreachable<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_remove_unreachable<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{removeUnreachable}{1}{2}{%›</span></span>
<span class="keyword1" id="EFSM-executionally_equivalent_remove_unreachable_state"><span class="command">lemma</span></span> executionally_equivalent_remove_unreachable_state<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> reachable <span class="free">s'</span> <span class="free">e</span> <span class="main">⟹</span> executionally_equivalent <span class="free">e</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="main">(</span>remove_state <span class="free">s'</span> <span class="free">e</span><span class="main">)</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> executionally_equivalent_remove_unreachable_state_arbitrary
      obtains.simps obtains_obtainable<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Transition Replacement›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here, we define the function \texttt{replace} to replace one transition with another, and prove
some of its properties.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">replace</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="keyword1">else</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span>"</span></span>

<span class="keyword1" id="EFSM-replace_finsert"><span class="command">lemma</span></span> replace_finsert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"replace <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">aaa</span><span class="main">,</span> <span class="free">baa</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">e1</span><span class="main">)</span> <span class="free">old</span> <span class="free">new</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free">aaa</span><span class="main">,</span> <span class="free">baa</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">old</span> <span class="keyword1">then</span> <span class="main">(</span>finsert <span class="free">new</span> <span class="main">(</span>replace <span class="free">e1</span> <span class="free">old</span> <span class="free">new</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>finsert <span class="main">(</span><span class="main">(</span><span class="free">aaa</span><span class="main">,</span> <span class="free">baa</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>replace <span class="free">e1</span> <span class="free">old</span> <span class="free">new</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replace_def<span class="main">)</span>

<span class="keyword1" id="EFSM-possible_steps_replace_unchanged"><span class="command">lemma</span></span> possible_steps_replace_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">aa</span><span class="main">)</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e1</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="main">(</span>replace <span class="free">e1</span> <span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> replace_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EFSM_LTL">
<div class="head">
<h1>Theory EFSM_LTL</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹LTL for EFSMs›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory builds off the \texttt{Linear\_Temporal\_Logic\_on\_Streams} theory from the HOL
library and defines functions to ease the expression of LTL properties over EFSMs. Since the LTL
operators effectively act over traces of models we must find a way to express models as streams.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> EFSM_LTL
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="EFSM.html">Extended_Finite_State_Machines.EFSM</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Linear_Temporal_Logic_on_Streams.html">HOL-Library.Linear_Temporal_Logic_on_Streams</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{statedef}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">record</span></span> state <span class="main">=</span>
  statename <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option"</span></span>
  datastate <span class="main">::</span> <span class="quoted">registers</span>
  action <span class="main">::</span> <span class="quoted">action</span>
  <span class="quoted">"output"</span> <span class="main">::</span> <span class="quoted">outputs</span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{whitebox}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> whitebox_trace <span class="main">=</span> <span class="quoted"><span class="quoted">"state stream"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> property <span class="main">=</span> <span class="quoted"><span class="quoted">"whitebox_trace <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">label</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">label</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>action <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> value list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inputs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>action <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{ltlStep}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate option <span class="main">⇒</span> registers <span class="main">⇒</span> action <span class="main">⇒</span> <span class="main">(</span>nat option <span class="main">×</span> outputs <span class="main">×</span> registers<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_step</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> None <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_step</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">possibilities</span> <span class="main">=</span> possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span>
                   <span class="keyword1">if</span> <span class="bound">possibilities</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
                   <span class="keyword1">else</span>
                     <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="bound">possibilities</span><span class="main">)</span> <span class="keyword1">in</span>
                     <span class="main">(</span>Some <span class="bound">s'</span><span class="main">,</span> <span class="main">(</span>evaluate_outputs <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
                  <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1" id="EFSM_LTL-ltl_step_singleton"><span class="command">lemma</span></span> ltl_step_singleton<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> possible_steps <span class="free">e</span> <span class="free">n</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">v</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|}</span> <span class="main">∧</span> evaluate_outputs <span class="bound">t</span> <span class="main">(</span>snd <span class="free">v</span><span class="main">)</span> <span class="free">r</span>  <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> evaluate_updates <span class="bound">t</span> <span class="main">(</span>snd <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="free">c</span><span class="main">⟹</span>
ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="free">n</span><span class="main">)</span> <span class="free">r</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM_LTL-ltl_step_none"><span class="command">lemma</span></span> ltl_step_none<span class="main">:</span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span> ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="EFSM_LTL-ltl_step_none_2"><span class="command">lemma</span></span> ltl_step_none_2<span class="main">:</span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">ie</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ie</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span> ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">r</span> <span class="free">ie</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl_step_none prod.exhaust_sel<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-ltl_step_alt"><span class="command">lemma</span></span> ltl_step_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">r</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="bound">possibilities</span> <span class="main">=</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> <span class="bound">possibilities</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span>
    <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>
  <span class="keyword1">else</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">=</span> Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="bound">possibilities</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">(</span>Some <span class="bound">s'</span><span class="main">,</span> <span class="main">(</span>apply_outputs <span class="main">(</span>Outputs <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>apply_updates <span class="main">(</span>Updates <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-ltl_step_some"><span class="command">lemma</span></span> ltl_step_some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">|}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"evaluate_outputs <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"evaluate_updates <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free">s'</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-ltl_step_cases"><span class="command">lemma</span></span> ltl_step_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invalid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">(</span>possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Some <span class="bound">s'</span><span class="main">,</span> <span class="main">(</span>evaluate_outputs <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invalid<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x S'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="bound">xa</span> <span class="main">|∈|</span> <span class="skolem">S'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fBall_def Ball_def fmember_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fst_conv prod.case_eq_if snd_conv someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \texttt{make\_full\_observation} function behaves similarly to \texttt{observe\_execution}
from the \texttt{EFSM} theory. The main difference in behaviour is what is recorded. While the
observe execution function simply observes an execution of the EFSM to produce the corresponding
output for each action, the intention here is to record every detail of execution, including the
values of internal variables.

Thinking of each action as a step forward in time, there are five components which characterise
a given point in the execution of an EFSM. At each point, the model has a current control state and
data state. Each action has a label and some input parameters, and its execution may produce
some observableoutput. It is therefore sufficient to provide a stream of 5-tuples containing the
current control state, data state, the label and inputs of the action, and computed output. The
make full observation function can then be defined as in Figure 9.1, with an additional
function watch defined on top of this which starts the make full observation off in the
initial control state with the empty data state.

Careful inspection of the definition reveals another way that \texttt{make\_full\_observation}
differs from \texttt{observe\_execution}. Rather than taking a cfstate, it takes a cfstate option.
The reason for this is that we need to make our EFSM models complete. That is, we need them to be
able to respond to every action from every state like a DFA. If a model does not recognise a given
action in a given state, we cannot simply stop processing because we are working with necessarily
infinite traces. Since these traces are generated by observing action sequences, the make full
observation function must keep processing whether there is a viable transition or not.

To support this, the make full observation adds an implicit ``sink state'' to every EFSM it
processes by lifting control flow state indices from \texttt{nat} to \texttt{nat option} such that
state $n$ is seen as state \texttt{Some} $n$. The control flow state \texttt{None} represents a sink
state. If a model is unable to recognise a particular action from its current state, it moves into
the \texttt{None} state. From here, the behaviour is constant for the rest of the time --- the
control flow state remains None; the data state does not change, and no output is produced.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{makeFullObservation}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">make_full_observation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> cfstate option <span class="main">⇒</span> registers <span class="main">⇒</span> outputs <span class="main">⇒</span> action stream <span class="main">⇒</span> whitebox_trace"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_full_observation</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">o'</span><span class="main">,</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">=</span> ltl_step <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">⦇</span>statename <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> datastate <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> action<span class="main">=</span><span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span> output <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⦈</span><span class="main">##</span><span class="main">(</span><span class="free">make_full_observation</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="bound">d'</span> <span class="bound">o'</span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{watch}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">watch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> action stream <span class="main">⇒</span> whitebox_trace"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">watch</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span>make_full_observation <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">&lt;&gt;</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Expressing Properties›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In order to simplify the expression and understanding of properties, this theory defines a
number of named functions which can be used to express certain properties of EFSMs.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹State Equality›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \textsc{state\_eq} takes a cfstate option representing a control flow state index and
returns true if this is the control flow state at the head of the full observation.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">state_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cfstate option <span class="main">⇒</span> whitebox_trace <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> statename <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1" id="EFSM_LTL-state_eq_holds"><span class="command">lemma</span></span> state_eq_holds<span class="main">:</span> <span class="quoted"><span class="quoted">"state_eq <span class="free">s</span> <span class="main">=</span> holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> statename <span class="bound">x</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> holds_def<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-state_eq_None_not_Some"><span class="command">lemma</span></span> state_eq_None_not_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"state_eq None <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> state_eq <span class="main">(</span>Some <span class="free">n</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Label Equality›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \textsc{label\_eq} function takes a string and returns true if this is equal to the label
at the head of the full observation.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">label_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>action <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>String.implode <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM_LTL-watch_label"><span class="command">lemma</span></span> watch_label<span class="main">:</span> <span class="quoted"><span class="quoted">"label_eq <span class="free">l</span> <span class="main">(</span>watch <span class="free">e</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>shd <span class="free">t</span><span class="main">)</span> <span class="main">=</span> String.implode <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Input Equality›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \textsc{input\_eq} function takes a value list and returns true if this is equal to the
input at the head of the full observation.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">input_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> inputs <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Action Equality›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \textsc{action\_eq} function takes a (label, value list) pair and returns true if this is
equal to the action at the head of the full observation. This effectively combines
\texttt{label\_eq} and \texttt{input\_eq} into one function.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">action_eq</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> label_eq <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">aand</span> input_eq <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Output Equality›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \textsc{output\_eq} function takes a takes a value option list and returns true if this is
equal to the output at the head of the full observation.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">output_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> output <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{ltlVName}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ltl_vname <span class="main">=</span> Ip <span class="quoted">nat</span> <span class="main">|</span> Op <span class="quoted">nat</span> <span class="main">|</span> Rg <span class="quoted">nat</span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Checking Arbitrary Expressions›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \textsc{check\_exp} function takes a guard expression and returns true if the guard
expression evaluates to true in the given state.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ltl_gexp <span class="main">=</span> <span class="quoted"><span class="quoted">"ltl_vname gexp"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">join_iro</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> registers <span class="main">⇒</span> outputs <span class="main">⇒</span> ltl_vname datastate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join_iro</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
    Rg <span class="bound">n</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">$</span> <span class="bound">n</span> <span class="main">|</span>
    Ip <span class="bound">n</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">|</span>
    Op <span class="bound">n</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">!</span> <span class="bound">n</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM_LTL-join_iro_R"><span class="command">lemma</span></span> join_iro_R <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"join_iro <span class="free">i</span> <span class="free">r</span> <span class="free">p</span> <span class="main">(</span>Rg <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">$</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_iro_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_exp</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>gval <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>join_iro <span class="main">(</span>snd <span class="main">(</span>action <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>datastate <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>output <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> trilean.true<span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM_LTL-alw_ev"><span class="command">lemma</span></span> alw_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">f</span> <span class="main">=</span> not <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="EFSM_LTL-alw_state_eq_smap"><span class="command">lemma</span></span> alw_state_eq_smap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>state_eq <span class="free">s</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> shd <span class="bound">ss</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>smap statename <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop <span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_mono alw_smap <span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Sink State›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Once the sink state is entered, it cannot be left and there are no outputs or updates
henceforth.›</span></span>

<span class="keyword1" id="EFSM_LTL-shd_state_is_none"><span class="command">lemma</span></span> shd_state_is_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state_eq None<span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-unfold_observe_none"><span class="command">lemma</span></span> unfold_observe_none<span class="main">:</span> <span class="quoted"><span class="quoted">"make_full_observation <span class="free">e</span> None <span class="free">d</span> <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦇</span>statename <span class="main">=</span> None<span class="main">,</span> datastate <span class="main">=</span> <span class="free">d</span><span class="main">,</span> action<span class="main">=</span><span class="main">(</span>shd <span class="free">t</span><span class="main">)</span><span class="main">,</span> output <span class="main">=</span> <span class="free">p</span><span class="main">⦈</span><span class="main">##</span><span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">d</span> <span class="main">[]</span> <span class="main">(</span>stl <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.expand<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-once_none_always_none_aux"><span class="command">lemma</span></span> once_none_always_none_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">r</span> <span class="bound">i</span><span class="main">.</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>state_eq None<span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">coinduct</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="EFSM_LTL-once_none_always_none"><span class="command">lemma</span></span> once_none_always_none<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>state_eq None<span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> once_none_always_none_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM_LTL-once_none_nxt_always_none"><span class="command">lemma</span></span> once_none_nxt_always_none<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>nxt <span class="main">(</span>state_eq None<span class="main">)</span><span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> once_none_always_none
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop.simps<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-snth_sconst"><span class="command">lemma</span></span> snth_sconst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">=</span> sconst <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> funpow_code_def id_funpow sdrop_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sdrop_siterate siterate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> smap_alt smap_sconst snth.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stream.map_id<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-alw_sconst"><span class="command">lemma</span></span> alw_sconst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="free">h</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">=</span> sconst <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snth_sconst<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> alw_iff_sdrop<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-smap_statename_None"><span class="command">lemma</span></span> smap_statename_None<span class="main">:</span> <span class="quoted"><span class="quoted">"smap statename <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> sconst None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> EFSM_LTL.alw_sconst alw_state_eq_smap once_none_always_none<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-alw_not_some"><span class="command">lemma</span></span> alw_not_some<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> statename <span class="main">(</span>shd <span class="bound">xs</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">s</span><span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_mono once_none_always_none option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-state_none"><span class="command">lemma</span></span> state_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>state_eq None<span class="main">)</span> <span class="keyword1">impl</span> nxt <span class="main">(</span>state_eq None<span class="main">)</span><span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-state_none_2"><span class="command">lemma</span></span> state_none_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>state_eq None<span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>state_eq None<span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">p</span> <span class="main">(</span>stl <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-no_output_none_aux"><span class="command">lemma</span></span> no_output_none_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">r</span> <span class="bound">i</span><span class="main">.</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="bound">r</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>output_eq <span class="main">[]</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">coinduct</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="EFSM_LTL-no_output_none"><span class="command">lemma</span></span> no_output_none<span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>alw <span class="main">(</span>output_eq <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_output_none_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EFSM_LTL-nxt_alw"><span class="command">lemma</span></span> nxt_alw<span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>nxt <span class="free">P</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop<span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-no_output_none_nxt"><span class="command">lemma</span></span> no_output_none_nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>nxt <span class="main">(</span>output_eq <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nxt_alw no_output_none <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM_LTL-no_output_none_if_empty"><span class="command">lemma</span></span> no_output_none_if_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>output_eq <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="main">[]</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_nxt make_full_observation.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> no_output_none state.select_convs<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="EFSM_LTL-no_updates_none_aux"><span class="command">lemma</span></span> no_updates_none_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> datastate <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">coinduct</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="EFSM_LTL-no_updates_none"><span class="command">lemma</span></span> no_updates_none<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> datastate <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>make_full_observation <span class="free">e</span> None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_updates_none_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EFSM_LTL-action_components"><span class="command">lemma</span></span> action_components<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>label_eq <span class="free">l</span> <span class="keyword1">aand</span> input_eq <span class="free">i</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>action <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>String.implode <span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv prod.collapse snd_conv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Drinks_Machine">
<div class="head">
<h1>Theory Drinks_Machine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Examples›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this chapter, we provide some examples of EFSMs and proofs over them. We first present a
formalisation of a simple drinks machine. Next, we prove observational equivalence of an alternative
model. Finally, we prove some temporal properties of the first example.›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Drinks Machine›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory formalises a simple drinks machine. The \emph{select} operation takes one
argument - the desired beverage. The \emph{coin} operation also takes one parameter representing
the value of the coin. The \emph{vend} operation has two flavours - one which dispenses the drink if
the customer has inserted enough money, and one which dispenses nothing if the user has not inserted
sufficient funds.

We first define a datatype \emph{statemane} which corresponds to $S$ in the formal definition.
Note that, while statename has four elements, the drinks machine presented here only requires three
states. The fourth element is included here so that the \emph{statename} datatype may be used in
the next example.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Drinks_Machine
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="EFSM.html">Extended_Finite_State_Machines.EFSM</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{selectdef}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">select</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">select</span> <span class="main">≡</span> <span class="main">⦇</span>
        Label <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span>
        Arity <span class="main">=</span> <span class="main">1</span><span class="main">,</span>
        Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span>
        Outputs <span class="main">=</span> <span class="main">[]</span><span class="main">,</span>
        Updates <span class="main">=</span> <span class="main">[</span>
                    <span class="main">(</span><span class="main">1</span><span class="main">,</span> V <span class="main">(</span>I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                    <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> L <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">]</span>
      <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{coindef}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">coin</span> <span class="main">≡</span> <span class="main">⦇</span>
        Label <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span>
        Arity <span class="main">=</span> <span class="main">1</span><span class="main">,</span>
        Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span>
        Outputs <span class="main">=</span> <span class="main">[</span>Plus <span class="main">(</span>V <span class="main">(</span>R <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
        Updates <span class="main">=</span> <span class="main">[</span>
                    <span class="main">(</span><span class="main">1</span><span class="main">,</span> V <span class="main">(</span>R <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                    <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> Plus <span class="main">(</span>V <span class="main">(</span>R <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">]</span>
      <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{venddef}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vend</span><span class="main">::</span> <span class="quoted"><span class="quoted">"transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vend</span><span class="main">≡</span> <span class="main">⦇</span>
        Label <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span>
        Arity <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
        Guards <span class="main">=</span> <span class="main">[</span><span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>R <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
        Outputs <span class="main">=</span>  <span class="main">[</span><span class="main">(</span>V <span class="main">(</span>R <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
        Updates <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> V <span class="main">(</span>R <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> V <span class="main">(</span>R <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{vendfaildef}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vend_fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vend_fail</span> <span class="main">≡</span> <span class="main">⦇</span>
        Label <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span>
        Arity <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
        Guards <span class="main">=</span> <span class="main">[</span><span class="main">(</span>Lt <span class="main">(</span>V <span class="main">(</span>R <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
        Outputs <span class="main">=</span>  <span class="main">[]</span><span class="main">,</span>
        Updates <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> V <span class="main">(</span>R <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> V <span class="main">(</span>R <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{drinksdef}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">drinks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">drinks</span> <span class="main">≡</span> <span class="main">{|</span>
          <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> select<span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> coin<span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> vend_fail<span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span><span class="main">,</span> vend<span class="main">)</span>
         <span class="main">|}</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> transitions <span class="main">=</span> select_def coin_def vend_def vend_fail_def

<span class="keyword1" id="Drinks_Machine-apply_updates_vend"><span class="command">lemma</span></span> apply_updates_vend<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_updates <span class="main">(</span>Updates vend<span class="main">)</span> <span class="main">(</span>join_ir <span class="main">[]</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_def apply_updates_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_states"><span class="command">lemma</span></span> drinks_states<span class="main">:</span> <span class="quoted"><span class="quoted">"S drinks <span class="main">=</span> <span class="main">{|</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine-possible_steps_0"><span class="command">lemma</span></span> possible_steps_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
   possible_steps drinks <span class="main">0</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> select<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions apply_guards_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-first_step_select"><span class="command">lemma</span></span> first_step_select<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps drinks <span class="main">0</span> <span class="free">r</span> <span class="free">aa</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> select"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def fimage_def ffilter_def fmember_def Abs_fset_inverse Set.filter_def drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_vend_insufficient"><span class="command">lemma</span></span> drinks_vend_insufficient<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="free">x1</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x1</span> <span class="main">&lt;</span> <span class="numeral">100</span> <span class="main">⟹</span>
   possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> vend_fail<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions apply_guards_def value_gt_def join_ir_def connectives<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_vend_invalid"><span class="command">lemma</span></span> drinks_vend_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span>
   possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MaybeBoolInt_not_num_1 value_gt_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-possible_steps_1_coin"><span class="command">lemma</span></span> possible_steps_1_coin<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> coin<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-possible_steps_2_vend"><span class="command">lemma</span></span> possible_steps_2_vend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≥</span> <span class="numeral">100</span> <span class="main">⟹</span>
   possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> vend<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions apply_guards_def value_gt_def join_ir_def connectives<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-recognises_from_2"><span class="command">lemma</span></span> recognises_from_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution drinks <span class="main">1</span> <span class="main">&lt;</span><span class="main">1</span> <span class="main">$:=</span> <span class="free">d</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">$:=</span> Some <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">[</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.step<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">,</span> vend<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_2_vend<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-recognises_from_1a"><span class="command">lemma</span></span> recognises_from_1a<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution drinks <span class="main">1</span> <span class="main">&lt;</span><span class="main">1</span> <span class="main">$:=</span> <span class="free">d</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">$:=</span> Some <span class="main">(</span>Num <span class="numeral">50</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">[</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.step<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> coin<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def coin_def finfun_update_twist value_plus_def recognises_from_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_1_coin<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-recognises_from_1"><span class="command">lemma</span></span> recognises_from_1<span class="main">:</span> <span class="quoted"><span class="quoted">"recognises_execution drinks <span class="main">1</span> <span class="main">&lt;</span><span class="numeral">2</span> <span class="main">$:=</span> Some <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span> <span class="main">$:=</span> Some <span class="free">d</span><span class="main">&gt;</span>
     <span class="main">[</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recognises_execution.step<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> coin<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def coin_def value_plus_def finfun_update_twist recognises_from_1a<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_1_coin<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-purchase_coke"><span class="command">lemma</span></span> purchase_coke<span class="main">:</span>
  <span class="quoted"><span class="quoted">"observe_execution drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="main">[</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span>Str <span class="inner_quoted">''coke''</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
                       <span class="main">[</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">(</span>Num <span class="numeral">50</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">(</span>Str <span class="inner_quoted">''coke''</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0 possible_steps_1_coin possible_steps_2_vend transitions
                   apply_outputs_def apply_updates_def value_plus_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-rejects_input"><span class="command">lemma</span></span> rejects_input<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span> <span class="main">⟹</span>
   <span class="free">l</span> <span class="main">≠</span> <span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span> <span class="main">⟹</span>
   <span class="main">¬</span> recognises_execution drinks <span class="main">1</span> <span class="free">d'</span> <span class="main">[</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_possible_steps_rejects<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-rejects_recognises_prefix"><span class="command">lemma</span></span> rejects_recognises_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span> <span class="main">⟹</span>
   <span class="free">l</span> <span class="main">≠</span> <span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span> <span class="main">⟹</span>
   <span class="main">¬</span> <span class="main">(</span>recognises drinks <span class="main">[</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span>Str <span class="inner_quoted">''coke''</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_reject_later<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0 select_def join_ir_def input2state_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> rejects_input <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Drinks_Machine-rejects_termination"><span class="command">lemma</span></span> rejects_termination<span class="main">:</span>
  <span class="quoted"><span class="quoted">"observe_execution drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="main">[</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span>Str <span class="inner_quoted">''coke''</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''rejects''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> observe_execution_step<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def possible_steps_0 select_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> observe_execution_no_possible_step<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>

<span class="comment1">(* Part of Example 2 in Foster et. al. *)</span>
<span class="keyword1" id="Drinks_Machine-r2_0_vend"><span class="command">lemma</span></span> r2_0_vend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_take_transition vend <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≥</span> <span class="numeral">100</span>"</span></span> <span class="comment1">(* You can't take vendimmediately after taking select *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def vend_def apply_guards_def maybe_negate_true maybe_or_false connectives value_gt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> MaybeBoolInt.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine-drinks_vend_sufficient"><span class="command">lemma</span></span> drinks_vend_sufficient<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="free">x1</span><span class="main">)</span> <span class="main">⟹</span>
                <span class="free">x1</span> <span class="main">≥</span> <span class="numeral">100</span> <span class="main">⟹</span>
                possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> vend<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> possible_steps_2_vend <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Drinks_Machine-drinks_end"><span class="command">lemma</span></span> drinks_end<span class="main">:</span> <span class="quoted"><span class="quoted">"possible_steps drinks <span class="numeral">2</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def drinks_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine-drinks_vend_r2_String"><span class="command">lemma</span></span> drinks_vend_r2_String<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>value.Str <span class="free">x2</span><span class="main">)</span> <span class="main">⟹</span>
   possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_gt_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_vend_r2_rejects"><span class="command">lemma</span></span> drinks_vend_r2_rejects<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> step drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_possible_steps_1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MaybeBoolInt_not_num_1 value_gt_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_0_rejects"><span class="command">lemma</span></span> drinks_0_rejects<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>fst <span class="free">a</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span>possible_steps drinks <span class="main">0</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_def possible_steps_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine-drinks_vend_empty"><span class="command">lemma</span></span> drinks_vend_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>possible_steps drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> drinks_0_rejects
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine-drinks_1_rejects"><span class="command">lemma</span></span> drinks_1_rejects<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="free">a</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span> <span class="main">⟶</span> length <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span>
          <span class="free">a</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
          possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_rejects_future"><span class="command">lemma</span></span> drinks_rejects_future<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> recognises_execution drinks <span class="numeral">2</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_possible_steps_rejects<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_1_rejects_trace"><span class="command">lemma</span></span> drinks_1_rejects_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_vend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> not_coin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> recognises_execution drinks <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="free">e</span> <span class="main">#</span> <span class="free">es</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_possible_steps_rejects<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> not_vend <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> not_coin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Machine-rejects_state_step"><span class="command">lemma</span></span> rejects_state_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> step drinks <span class="free">s</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_possible_steps_1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-invalid_other_states"><span class="command">lemma</span></span> invalid_other_states<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">¬</span> recognises_execution drinks <span class="free">s</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_possible_steps_rejects<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-vend_ge_100"><span class="command">lemma</span></span> vend_ge_100<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> vend<span class="main">)</span><span class="main">|}</span> <span class="main">⟹</span>
   <span class="main">¬?</span> value_gt <span class="main">(</span>Some <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> trilean.true"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> possible_steps_apply_guards<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">drinks</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">2</span></span></span></span> <span class="quoted"><span class="quoted">vend</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def apply_guards_def vend_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-drinks_no_possible_steps_1"><span class="command">lemma</span></span> drinks_no_possible_steps_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_coin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span> <span class="main">∧</span> length <span class="free">b</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> not_vend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> drinks_1_rejects not_coin not_vend <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine-possible_steps_0_not_select"><span class="command">lemma</span></span> possible_steps_0_not_select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">⟹</span>
       possible_steps drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def ffilter_def fset_both_sides Abs_fset_inverse Set.filter_def drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-possible_steps_select_wrong_arity"><span class="command">lemma</span></span> possible_steps_select_wrong_arity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">⟹</span>
       length <span class="free">b</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span>
       possible_steps drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def ffilter_def fset_both_sides Abs_fset_inverse Set.filter_def drinks_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine-possible_steps_0_invalid"><span class="command">lemma</span></span> possible_steps_0_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">l</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span>
   possible_steps drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> possible_steps_0_not_select possible_steps_select_wrong_arity <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Drinks_Machine_2">
<div class="head">
<h1>Theory Drinks_Machine_2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹An Observationally Equivalent Model›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory defines a second formalisation of the drinks machine example which produces
identical output to the first model. This property is called \emph{observational equivalence} and is
discussed in more detail in \cite{foster2018}.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Drinks_Machine_2
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Drinks_Machine.html">Drinks_Machine</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Only imports Drinks_Machine_LTL so I can easily open all three at once for testing *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vend_nothing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vend_nothing</span> <span class="main">≡</span> <span class="main">⦇</span>
        Label <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">,</span>
        Arity <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
        Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span>
        Outputs <span class="main">=</span>  <span class="main">[]</span><span class="main">,</span>
        Updates <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> V <span class="main">(</span>R <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> V <span class="main">(</span>R <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> transitions <span class="main">=</span> Drinks_Machine.transitions vend_nothing_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">drinks2</span> <span class="main">::</span> <span class="quoted">transition_matrix</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">drinks2</span> <span class="main">=</span> <span class="main">{|</span>
              <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> select<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> vend_nothing<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span><span class="main">,</span> coin<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span><span class="main">,</span> coin<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span><span class="main">,</span> vend_fail<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">)</span><span class="main">,</span> vend<span class="main">)</span>
         <span class="main">|}</span>"</span></span>

<span class="keyword1" id="Drinks_Machine_2-possible_steps_0"><span class="command">lemma</span></span> possible_steps_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
   possible_steps drinks2 <span class="main">0</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> select<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def drinks2_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine_2-possible_steps_1"><span class="command">lemma</span></span> possible_steps_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
   possible_steps drinks2 <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> coin<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def drinks2_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine_2-possible_steps_2_coin"><span class="command">lemma</span></span> possible_steps_2_coin<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
   possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> coin<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def drinks2_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine_2-possible_steps_2_vend"><span class="command">lemma</span></span> possible_steps_2_vend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">n</span> <span class="main">≥</span> <span class="numeral">100</span> <span class="main">⟹</span>
   possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span> vend<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton drinks2_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions apply_guards_def value_gt_def join_ir_def connectives<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-recognises_first_select"><span class="command">lemma</span></span> recognises_first_select<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recognises_execution drinks <span class="main">0</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">aa</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">∧</span> length <span class="free">b</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> recognises_must_be_possible_step<span class="main">[</span><span class="operator">of</span> <span class="quoted">drinks</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> first_step_select recognises_possible_steps_not_empty drinks_0_rejects fst_conv snd_conv<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_vend_insufficient"><span class="command">lemma</span></span> drinks2_vend_insufficient<span class="main">:</span>
  <span class="quoted"><span class="quoted">"possible_steps drinks2 <span class="main">1</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> vend_nothing<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def drinks2_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_vend_insufficient2"><span class="command">lemma</span></span> drinks2_vend_insufficient2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="free">x1</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x1</span> <span class="main">&lt;</span> <span class="numeral">100</span> <span class="main">⟹</span>
   possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> vend_fail<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton drinks2_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions apply_guards_def value_gt_def join_ir_def connectives<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_vend_sufficient"><span class="command">lemma</span></span> drinks2_vend_sufficient<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="free">x1</span><span class="main">)</span> <span class="main">⟹</span>
                <span class="main">¬</span> <span class="free">x1</span> <span class="main">&lt;</span> <span class="numeral">100</span> <span class="main">⟹</span>
                possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span> vend<span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_singleton drinks2_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions apply_guards_def value_gt_def join_ir_def connectives<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-recognises_1_2"><span class="command">lemma</span></span> recognises_1_2<span class="main">:</span> <span class="quoted"><span class="quoted">"recognises_execution drinks <span class="main">1</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟶</span> recognises_execution drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> recognises_step_equiv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">r</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span> <span class="main">&lt;</span> <span class="numeral">100</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_vend_insufficient drinks2_vend_insufficient2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_vend_sufficient drinks2_vend_sufficient<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> recognises_prim recognises_prim.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> drinks_rejects_future<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> drinks_vend_invalid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_1_coin possible_steps_2_coin<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> recognises_execution.simps drinks_1_rejects_trace<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine_2-drinks_reject_0_2"><span class="command">lemma</span></span> drinks_reject_0_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
   possible_steps drinks <span class="main">0</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> drinks_0_rejects<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"snd <span class="free">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-purchase_coke"><span class="command">lemma</span></span> purchase_coke<span class="main">:</span>
  <span class="quoted"><span class="quoted">"observe_execution drinks2 <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Str <span class="inner_quoted">''coke''</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">50</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
                       <span class="main">[</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">(</span>Num <span class="numeral">50</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">(</span>Str <span class="inner_quoted">''coke''</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0 select_def apply_updates_def
                   possible_steps_1 coin_def apply_outputs finfun_update_twist
                   possible_steps_2_coin possible_steps_2_vend vend_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_0_invalid"><span class="command">lemma</span></span> drinks2_0_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">aa</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span>possible_steps drinks2 <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">aa</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def possible_steps_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_vend_r2_none"><span class="command">lemma</span></span> drinks2_vend_r2_none<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> None <span class="main">⟹</span> possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks2_def can_take_transition_def can_take_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_gt_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_end"><span class="command">lemma</span></span> drinks2_end<span class="main">:</span> <span class="quoted"><span class="quoted">"possible_steps drinks2 <span class="numeral">3</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def drinks2_def transitions<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_vend_r2_String"><span class="command">lemma</span></span> drinks2_vend_r2_String<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>value.Str <span class="free">x2</span><span class="main">)</span> <span class="main">⟹</span>
                possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks2_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions can_take_transition_def can_take_def value_gt_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_2_invalid"><span class="command">lemma</span></span> drinks2_2_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">)</span> <span class="main">⟶</span> length <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span>
          <span class="free">a</span> <span class="main">≠</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
          possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks2_def transitions can_take_transition_def can_take_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_1_invalid"><span class="command">lemma</span></span> drinks2_1_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">b</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">¬</span><span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
    possible_steps drinks2 <span class="main">1</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks2_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions can_take_transition_def can_take_def value_gt_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-drinks2_vend_invalid"><span class="command">lemma</span></span> drinks2_vend_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span>
   possible_steps drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks2_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transitions can_take_transition_def can_take_def value_gt_def MaybeBoolInt_not_num_1<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_2-equiv_1_2"><span class="command">lemma</span></span> equiv_1_2<span class="main">:</span> <span class="quoted"><span class="quoted">"executionally_equivalent drinks <span class="main">1</span> <span class="free">r</span> drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Drinks_Machine.possible_steps_1_coin possible_steps_2_coin<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> drinks2_2_invalid drinks_no_possible_steps_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> drinks_vend_invalid drinks2_vend_invalid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b n
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="numeral">100</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Drinks_Machine.drinks_vend_insufficient drinks2_vend_insufficient2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Drinks_Machine.drinks_vend_sufficient drinks2_vend_sufficient<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa t <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">aa</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step drinks_end drinks2_end<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine_2-equiv_1_1"><span class="command">lemma</span></span> equiv_1_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> executionally_equivalent drinks <span class="main">1</span> <span class="free">r</span> drinks2 <span class="main">1</span> <span class="free">r</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span> <span class="main">∧</span> length <span class="skolem">b</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_1_coin possible_steps_1 equiv_1_2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_vend_insufficient drinks2_vend_insufficient<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def apply_updates_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finfun_upd_triv<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_1_invalid drinks_no_possible_steps_1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(* Corresponds to Example 3 in Foster et. al. *)</span>
<span class="keyword1" id="Drinks_Machine_2-executional_equivalence"><span class="command">lemma</span></span> executional_equivalence<span class="main">:</span> <span class="quoted"><span class="quoted">"executionally_equivalent drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> drinks2 <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executionally_equivalent_step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">∧</span> length <span class="skolem">b</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Drinks_Machine.possible_steps_0 possible_steps_0<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def select_def equiv_1_1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_0_invalid possible_steps_0_invalid<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine_2-observational_equivalence"><span class="command">lemma</span></span> observational_equivalence<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_equivalent drinks drinks2"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> executional_equivalence executionally_equivalent_trace_equivalent<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Drinks_Machine_LTL">
<div class="head">
<h1>Theory Drinks_Machine_LTL</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Temporal Properties›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory presents some examples of temporal properties over the simple drinks machine.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Drinks_Machine_LTL
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Drinks_Machine.html">Drinks_Machine</a>"</span> <span class="quoted">"<a href="EFSM_LTL.html">Extended_Finite_State_Machines.EFSM_LTL</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> One_nat_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Drinks_Machine_LTL-P_ltl_step_0"><span class="command">lemma</span></span> P_ltl_step_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invalid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">&lt;&gt;</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Some <span class="main">1</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">&lt;</span><span class="main">1</span> <span class="main">$:=</span> Some <span class="main">(</span>hd <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">$:=</span> Some <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>ltl_step drinks <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">&lt;&gt;</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> length_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span><span class="bound">d</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_i_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">[</span><span class="bound">d</span><span class="main">]</span> <span class="main">⟹</span> length <span class="free">i</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span><span class="bound">d</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0 length_i select_def apply_updates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> select <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0_invalid length_i_2 invalid<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Machine_LTL-P_ltl_step_1"><span class="command">lemma</span></span> P_ltl_step_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invalid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Some <span class="main">1</span><span class="main">,</span> <span class="main">[</span>value_plus <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="free">r</span><span class="main">(</span><span class="numeral">2</span> <span class="main">$:=</span> value_plus <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">i</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vend_fail<span class="main">:</span> <span class="quoted"><span class="quoted">"value_gt <span class="main">(</span>Some <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> trilean.true <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Some <span class="main">1</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬?</span> value_gt <span class="main">(</span>Some <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> trilean.true <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Some <span class="numeral">2</span><span class="main">,</span> <span class="main">[</span><span class="free">r</span><span class="main">$</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>ltl_step drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> length_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main">[</span><span class="bound">d</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_i_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">[</span><span class="bound">d</span><span class="main">]</span> <span class="main">⟹</span> length <span class="free">i</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span><span class="bound">d</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_1_coin length_i coin_def apply_outputs_def apply_updates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> coin <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">100</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_vend_sufficient vend_def apply_updates_def apply_outputs_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finfun_upd_triv possible_steps_2_vend vend vend_ge_100<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_vend_insufficient vend_fail_def apply_updates_def apply_outputs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> MaybeBoolInt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finfun_upd_triv not_less value_gt_def vend_fail<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_vend_invalid invalid<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_no_possible_steps_1 length_i_2 invalid<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Machine_LTL-LTL_r2_not_always_gt_100"><span class="command">lemma</span></span> LTL_r2_not_always_gt_100<span class="main">:</span> <span class="quoted"><span class="quoted">"not <span class="main">(</span>alw <span class="main">(</span>check_exp <span class="main">(</span>Gt <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>watch drinks <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> value_gt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine_LTL-drinks_step_2_none"><span class="command">lemma</span></span> drinks_step_2_none<span class="main">:</span> <span class="quoted"><span class="quoted">"ltl_step drinks <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span> <span class="free">r</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_end ltl_step_none_2<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-one_before_two_2"><span class="command">lemma</span></span> one_before_two_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> statename <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="numeral">2</span> <span class="main">⟶</span> statename <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">1</span><span class="main">)</span> <span class="main">(</span>make_full_observation drinks <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span> <span class="free">r</span> <span class="main">[</span><span class="free">r</span> <span class="main">$</span> <span class="main">1</span><span class="main">]</span> <span class="free">x2a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> alw
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_step_2_none<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_mono nxt.simps once_none_nxt_always_none option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Machine_LTL-one_before_two_aux"><span class="command">lemma</span></span> one_before_two_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">r</span> <span class="bound">i</span><span class="main">.</span> <span class="free">j</span> <span class="main">=</span> nxt <span class="main">(</span>make_full_observation drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nxt <span class="main">(</span>state_eq <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> state_eq <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_ltl_step_1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>state_eq None<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> once_none_nxt_always_none<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_before_two_2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Drinks_Machine_LTL-LTL_nxt_2_means_vend"><span class="command">lemma</span></span> LTL_nxt_2_means_vend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>nxt <span class="main">(</span>state_eq <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">impl</span> <span class="main">(</span>state_eq <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>watch drinks <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> alw
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_ltl_step_0<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>state_eq None<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> once_none_nxt_always_none<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> one_before_two_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Machine_LTL-costsMoney_aux"><span class="command">lemma</span></span> costsMoney_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">r</span> <span class="bound">i</span><span class="main">.</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>nxt <span class="main">(</span>make_full_observation drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> nxt <span class="main">(</span>state_eq <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">⟶</span> check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">coinduct</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_ltl_step_1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>state_eq None<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> once_none_nxt_always_none<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>state_eq None<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> drinks_step_2_none fst_conv make_full_observation.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nxt.simps nxt_alw once_none_always_none_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* costsMoney: THEOREM drinks |- G(X(cfstate=State_2) =&gt; gval(value_ge(r_2, Some(NUM(100))))); *)</span>
<span class="keyword1" id="Drinks_Machine_LTL-LTL_costsMoney"><span class="command">lemma</span></span> LTL_costsMoney<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>alw <span class="main">(</span>nxt <span class="main">(</span>state_eq <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">impl</span> <span class="main">(</span>check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>watch drinks <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> alw
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"shd <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l ip
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span> <span class="main">∧</span> length <span class="skolem">ip</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0_invalid<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>state_eq None<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> once_none_nxt_always_none<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0 select_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> nxt.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> costsMoney_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Machine_LTL-LTL_costsMoney_aux"><span class="command">lemma</span></span> LTL_costsMoney_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>alw <span class="main">(</span>not <span class="main">(</span>check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">impl</span> <span class="main">(</span>not <span class="main">(</span>nxt <span class="main">(</span>state_eq <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>watch drinks <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LTL_costsMoney alw_mono<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-implode_select"><span class="command">lemma</span></span> implode_select<span class="main">:</span> <span class="quoted"><span class="quoted">"String.implode <span class="inner_quoted">''select''</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''select''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Literal.rep_eq String.implode_explode_eq zero_literal.rep_eq<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-implode_coin"><span class="command">lemma</span></span> implode_coin<span class="main">:</span> <span class="quoted"><span class="quoted">"String.implode <span class="inner_quoted">''coin''</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Literal.rep_eq String.implode_explode_eq zero_literal.rep_eq<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-implode_vend"><span class="command">lemma</span></span> implode_vend<span class="main">:</span> <span class="quoted"><span class="quoted">"String.implode <span class="inner_quoted">''vend''</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Literal.rep_eq String.implode_explode_eq zero_literal.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> implode_labels <span class="main">=</span> implode_select implode_coin implode_vend

<span class="keyword1" id="Drinks_Machine_LTL-LTL_neverReachS2"><span class="command">lemma</span></span> LTL_neverReachS2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>action_eq <span class="main">(</span><span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span>Str <span class="inner_quoted">''coke''</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="keyword1">aand</span>
                    <span class="main">(</span>nxt <span class="main">(</span><span class="main">(</span>action_eq <span class="main">(</span><span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span>Num <span class="numeral">100</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="keyword1">aand</span>
                    <span class="main">(</span>nxt <span class="main">(</span>nxt<span class="main">(</span><span class="main">(</span>label_eq <span class="inner_quoted">''vend''</span> <span class="keyword1">aand</span> <span class="main">(</span>input_eq <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="keyword1">impl</span>
                    <span class="main">(</span>nxt <span class="main">(</span>nxt <span class="main">(</span>nxt <span class="main">(</span>state_eq <span class="main">(</span>Some <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>watch drinks <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implode_labels<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0 select_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="improper">x2</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_1_coin coin_def value_plus_def finfun_update_twist apply_updates_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="improper">x2</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_vend_sufficient <span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-ltl_step_not_select"><span class="command">lemma</span></span> ltl_step_not_select<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
   ltl_step drinks <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="free">r</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ltl_step_none<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def select_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Drinks_Machine_LTL-ltl_step_select"><span class="command">lemma</span></span> ltl_step_select<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ltl_step drinks <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">&lt;&gt;</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''select''</span><span class="main">,</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">1</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">&lt;</span><span class="main">1</span> <span class="main">$:=</span> Some <span class="free">i</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">$:=</span> Some <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>  ltl_step_some<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">select</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_0<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def finfun_update_twist apply_updates_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-ltl_step_not_coin_or_vend"><span class="command">lemma</span></span> ltl_step_not_coin_or_vend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">e</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
    ltl_step drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ltl_step_none<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def can_take_transition_def can_take_def transitions<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Drinks_Machine_LTL-ltl_step_coin"><span class="command">lemma</span></span> ltl_step_coin<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">r'</span><span class="main">.</span> ltl_step drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">1</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_1_coin<span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-alw_tl"><span class="command">lemma</span></span> alw_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="main">(</span>make_full_observation <span class="free">e</span> <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">&lt;&gt;</span> <span class="main">[]</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
    alw <span class="free">φ</span>
     <span class="main">(</span>make_full_observation <span class="free">e</span> <span class="main">(</span>fst <span class="main">(</span>ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">&lt;&gt;</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">&lt;&gt;</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>ltl_step <span class="free">e</span> <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">&lt;&gt;</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Drinks_Machine_LTL-stop_at_none"><span class="command">lemma</span></span> stop_at_none<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> output <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>Some <span class="main">(</span>EFSM.Str <span class="free">drink</span><span class="main">)</span><span class="main">]</span> <span class="main">⟶</span> check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>
            <span class="main">(</span>make_full_observation drinks None <span class="free">r</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>output_eq <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_output_none_nxt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Drinks_Machine_LTL-drink_costs_money_aux"><span class="command">lemma</span></span> drink_costs_money_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">r</span> <span class="bound">t</span><span class="main">.</span> <span class="free">j</span> <span class="main">=</span> make_full_observation drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> output <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>Some <span class="main">(</span>EFSM.Str <span class="free">drink</span><span class="main">)</span><span class="main">]</span> <span class="main">⟶</span> check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">coinduct</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="improper">t</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_ltl_step_1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>output_eq <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_output_none_nxt<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Str_def value_plus_never_string<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>output_eq <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_step_2_none no_output_none_if_empty nxt_alw<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Drinks_Machine_LTL-LTL_drinks_cost_money"><span class="command">lemma</span></span> LTL_drinks_cost_money<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>nxt <span class="main">(</span>output_eq <span class="main">[</span>Some <span class="main">(</span>Str <span class="free">drink</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">impl</span> <span class="main">(</span>check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>watch drinks <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> alw
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_ltl_step_0<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>output_eq <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_output_none_nxt<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> drink_costs_money_aux
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Machine_LTL-steps_1_invalid"><span class="command">lemma</span></span> steps_1_invalid<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''coin''</span><span class="main">,</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
       possible_steps drinks <span class="main">1</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_empty drinks_def transitions can_take_transition_def can_take_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Drinks_Machine_LTL-output_vend_aux"><span class="command">lemma</span></span> output_vend_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">r</span> <span class="bound">t</span><span class="main">.</span> <span class="free">j</span> <span class="main">=</span> make_full_observation drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> label_eq <span class="inner_quoted">''vend''</span> <span class="bound">xs</span> <span class="main">∧</span> output <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>Some <span class="free">d</span><span class="main">]</span> <span class="main">⟶</span> check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">coinduct</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implode_vend <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_ltl_step_1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>output_eq <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_output_none_nxt<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>output_eq <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks_step_2_none no_output_none_if_empty nxt_alw<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{outputVend}{1}{2}{%›</span></span>
<span class="keyword1" id="Drinks_Machine_LTL-LTL_output_vend"><span class="command">lemma</span></span> LTL_output_vend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">(</span><span class="main">(</span>label_eq <span class="inner_quoted">''vend''</span><span class="main">)</span> <span class="keyword1">aand</span> <span class="main">(</span>nxt <span class="main">(</span>output_eq <span class="main">[</span>Some <span class="free">d</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">impl</span>
         <span class="main">(</span>check_exp <span class="main">(</span>Ge <span class="main">(</span>V <span class="main">(</span>Rg <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>watch drinks <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> alw
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implode_vend<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"shd <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ltl_step.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_ltl_step_0<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"nxt <span class="main"><span class="main">(</span></span>output_eq <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_output_none_nxt<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
      <span class="keyword1"><span class="command">using</span></span> output_vend_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>make_full_observation drinks <span class="main">(</span>Some <span class="main">1</span><span class="main">)</span>
              <span class="main">&lt;</span><span class="main">1</span> <span class="main">$:=</span> Some <span class="main">(</span>hd <span class="skolem">b</span><span class="main">)</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">$:=</span> Some <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">&gt;</span> <span class="main">[]</span> <span class="main">(</span>stl <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> implode_vend <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{outputVendUnfolded}{1}{2}{%›</span></span>
<span class="keyword1" id="Drinks_Machine_LTL-LTL_output_vend_unfolded"><span class="command">lemma</span></span> LTL_output_vend_unfolded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span>label <span class="main">(</span>shd <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''vend''</span> <span class="main">∧</span>
             nxt <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> output <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>Some <span class="free">d</span><span class="main">]</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">¬?</span> value_gt <span class="main">(</span>Some <span class="main">(</span>Num <span class="numeral">100</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>datastate <span class="main">(</span>shd <span class="bound">xs</span><span class="main">)</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> trilean.true<span class="main">)</span>
     <span class="main">(</span>watch drinks <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> LTL_output_vend<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">d</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implode_vend<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>