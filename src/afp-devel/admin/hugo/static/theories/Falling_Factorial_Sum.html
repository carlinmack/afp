<div id="Falling_Factorial_Sum_Combinatorics">
<div class="head">
<h1>Theory Falling_Factorial_Sum_Combinatorics</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving Falling Factorial of a Sum with Combinatorics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Falling_Factorial_Sum_Combinatorics
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Discrete_Summation/Factorials.html">Discrete_Summation.Factorials</a>
  <a href="../Card_Partitions/Injectivity_Solver.html">Card_Partitions.Injectivity_Solver</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Addition to Factorials Theory›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_lists_distinct_length_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">∏</span><span class="main">{</span>card <span class="free">A</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> card <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_lists_distinct_length_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> card <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_rev_ffact_nat'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">n</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟶</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> eq_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">n</span> <span class="main">≤</span> card <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_nat_triv eq_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interleavings of Two Lists›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">interleavings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interleavings</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interleavings</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interleavings</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">⟹</span> <span class="free">interleavings</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interleavings</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">⟹</span> <span class="free">interleavings</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleaving_Nil_implies_eq1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleavings.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interleaving_Nil_iff1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"interleavings <span class="main">[]</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">ys</span> <span class="main">=</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> interleaving_Nil_implies_eq1
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleavings.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interleaving_Nil_implies_eq2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleavings.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interleaving_Nil_iff2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="main">[]</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">xs</span> <span class="main">=</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> interleaving_Nil_implies_eq2
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleavings.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="free">x</span><span class="main">#</span><span class="bound">zs</span><span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="free">xs</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">y</span><span class="main">#</span><span class="bound">zs</span><span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="bound">zs</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?expr</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="var">?expr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interleavings.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?expr</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleavings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="main">[</span><span class="bound">z</span><span class="main">←</span><span class="free">zs</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span><span class="main">]</span> <span class="main">[</span><span class="bound">z</span><span class="main">←</span><span class="free">zs</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">]</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleavings.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_filter_eq1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">ys</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleavings.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_filter_eq2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleavings.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleavings.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">=</span> set <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleavings.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">∧</span> distinct <span class="free">ys</span> <span class="main">∧</span> set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> distinct <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms interleavings_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleavings.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> two_mutual_lists_induction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">(</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction_schema</span><span class="main">)</span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">lexicographic_order</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_interleavings<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="bound">zs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_mutual_lists_induction<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleaving_Nil_iff1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleaving_Nil_iff2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleavings_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_interleavings<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span> <span class="keyword1">choose</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_mutual_lists_induction<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">[]</span> <span class="skolem">ys</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="skolem">ys</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleaving_Nil_iff1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>length <span class="main">[]</span> <span class="main">+</span> length <span class="skolem">ys</span> <span class="keyword1">choose</span> <span class="main">(</span>length <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="skolem">xs</span> <span class="main">[]</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="skolem">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleaving_Nil_iff2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> length <span class="main">[]</span> <span class="keyword1">choose</span> <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span>
    card <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">#</span><span class="bound">zs</span><span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">y</span><span class="main">#</span><span class="bound">zs</span><span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">zs</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleavings_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="skolem">x</span><span class="main">#</span><span class="bound">zs</span><span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="skolem">y</span><span class="main">#</span><span class="bound">zs</span><span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">zs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="skolem">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_interleavings<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="skolem">y</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">zs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_interleavings<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">y</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span>
    card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">zs</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setcompr_eq_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">zs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">choose</span> length <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">ys</span> <span class="keyword1">choose</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">choose</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cardinality of Distinct Fixed-Length Lists from a Union of Two Sets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lists_distinct_union_by_interleavings<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">zs</span> <span class="main">∧</span> set <span class="bound">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">k</span> <span class="main">←</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">xs</span> <span class="main">←</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">ys</span> <span class="main">←</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="bound">k</span> <span class="main">∧</span> distinct <span class="bound">ys</span> <span class="main">∧</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">}</span><span class="main">;</span>
    <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">}</span>
  <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?expr</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="var">?expr</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">zs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">z</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">z</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">X</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> filter_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="skolem">xs</span> <span class="main">∧</span> set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">zs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> xs_def ys_def eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_add_inverse sum_length_filter_compl<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span> <span class="main">∧</span> set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">zs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_def ys_def <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleavings_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> <span class="var">?expr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?expr</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">zs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> <span class="var">?expr</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">xs</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> length <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹interleavings <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> interleavings_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹interleavings <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="free">Y</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> interleavings_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹interleavings <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="free">Y</span>›</span></span> interleavings_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleavings_inject<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs'</span> <span class="free">ys'</span> <span class="free">zs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">=</span> <span class="free">zs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleavings_filter_eq1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="free">zs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">zs</span> <span class="main">=</span> <span class="free">zs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹interleavings <span class="free">xs'</span> <span class="free">ys'</span> <span class="free">zs'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleavings_filter_eq1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleavings_filter_eq2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="free">zs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">zs</span> <span class="main">=</span> <span class="free">zs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹interleavings <span class="free">xs'</span> <span class="free">ys'</span> <span class="free">zs'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleavings_filter_eq2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> injectivity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="free">k'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">xs</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> distinct <span class="free">xs</span> <span class="main">∧</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">xs'</span> <span class="main">=</span> <span class="free">k'</span> <span class="main">∧</span> distinct <span class="free">xs'</span> <span class="main">∧</span> set <span class="free">xs'</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k</span> <span class="main">∧</span> distinct <span class="free">ys</span> <span class="main">∧</span> set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">ys'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k'</span> <span class="main">∧</span> distinct <span class="free">ys'</span> <span class="main">∧</span> set <span class="free">ys'</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interleavings <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">∧</span> interleavings <span class="free">xs'</span> <span class="free">ys'</span> <span class="free">zs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">=</span> <span class="free">zs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">xs'</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">zs</span> <span class="main">=</span> <span class="free">zs'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interleavings_inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_lists_distinct_length_eq_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">zs</span> <span class="main">∧</span> set <span class="bound">zs</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="main">(</span>card <span class="free">X</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>card <span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">k</span> <span class="main">←</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">xs</span> <span class="main">←</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">ys</span> <span class="main">←</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="bound">k</span> <span class="main">∧</span> distinct <span class="bound">ys</span> <span class="main">∧</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">}</span><span class="main">;</span>
    <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> interleavings <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">}</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> card <span class="var">?expr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lists_distinct_union_by_interleavings<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?expr</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?expr</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?expr</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">Y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span>
        <span class="keyword3"><span class="command">assume</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_interleavings<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> xs ys <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_interleavings<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">}</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> injectivity<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>card <span class="free">Y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_lists_distinct_length_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>card <span class="free">Y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind_constant<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_bind finite_interleavings<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>card <span class="free">Y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> injectivity<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> ffact <span class="skolem">k</span> <span class="main">(</span>card <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_lists_distinct_length_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="skolem">k</span> <span class="main">(</span>card <span class="free">X</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>card <span class="free">Y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind_constant<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_bind finite_interleavings<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="skolem">k</span> <span class="main">(</span>card <span class="free">X</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>card <span class="free">Y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> injectivity<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="main">(</span>card <span class="free">X</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>card <span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_bind<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">_</span> <span class="main">=</span> card <span class="var">?expr</span>›</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">X</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">Y</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def Y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="main">(</span>card <span class="skolem">X</span> <span class="main">+</span> card <span class="skolem">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">X</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">Y</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="main">(</span>card <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_lists_distinct_length_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="main">(</span>card <span class="skolem">X</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>card <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_lists_distinct_length_eq_union<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">X</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">Y</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Falling_Factorial_Sum_Induction">
<div class="head">
<h1>Theory Falling_Factorial_Sum_Induction</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving Falling Factorial of a Sum with Induction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Falling_Factorial_Sum_Induction
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Discrete_Summation/Factorials.html">Discrete_Summation.Factorials</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note the potentially special copyright license condition of the following proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_add_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> ffact <span class="skolem">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_Suc_rev_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?s</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?s</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="bound">k</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?s</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">y</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_nat_triv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?t</span> <span class="bound">k</span> <span class="main">+</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_le ffact_Suc_rev_nat<span class="main">)</span> <span class="operator">algebra</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib add_mult_distrib2 mult.commute mult.left_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>sum <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">o</span> Suc<span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted">Suc</span><span class="main"><span class="main">]</span></span> inj_Suc image_Suc_atLeastAtMost<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="var">?v</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.shift_bounds_cl_Suc_ivl diff_Suc_Suc mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: what's the right class here? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ffact_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ab_group_add<span class="main">,</span> comm_semiring_1_cancel<span class="main">,</span> ring_1<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> ffact <span class="skolem">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_Suc_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?s</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> of_nat <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?s</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> of_nat <span class="bound">k</span> <span class="main">-</span> of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> of_nat <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_add_eq add_diff_eq add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?t</span> <span class="bound">k</span> <span class="main">+</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">k</span> <span class="main">=</span> ffact <span class="skolem">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">y</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> of_nat <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_Suc_rev Suc_diff_le of_nat_diff mult.commute mult.left_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="skolem">k</span> <span class="main">=</span> ffact <span class="skolem">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">y</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> of_nat <span class="skolem">k</span> <span class="main">-</span> of_nat <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_Suc_rev Suc_diff_le of_nat_diff diff_diff_eq2 mult.commute mult.left_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> of_nat <span class="skolem">k</span> <span class="main">-</span> of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> of_nat <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?t</span> <span class="skolem">k</span> <span class="main">+</span> <span class="var">?u</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distrib_left mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib distrib_left mult.commute mult.left_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_eq_0<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>sum <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">o</span> Suc<span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted">Suc</span><span class="main"><span class="main">]</span></span> inj_Suc image_Suc_atLeastAtMost<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?t</span> <span class="bound">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="var">?v</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.shift_bounds_cl_Suc_ivl diff_Suc_Suc mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">x</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Falling_Factorial_Sum_Vandermonde">
<div class="head">
<h1>Theory Falling_Factorial_Sum_Vandermonde</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving Falling Factorial of a Sum with Vandermonde Identity›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Falling_Factorial_Sum_Vandermonde
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../Discrete_Summation/Factorials.html">Discrete_Summation.Factorials</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note the potentially special copyright license condition of the following proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_add_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ffact <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">i</span> <span class="free">n</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> fact <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ffact_eq_fact_mult_binomial<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fact <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> vandermonde<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> fact <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span>fact <span class="bound">i</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_fact_lemma<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fact <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">i</span> <span class="free">n</span> <span class="main">*</span> ffact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ffact_eq_fact_mult_binomial<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>