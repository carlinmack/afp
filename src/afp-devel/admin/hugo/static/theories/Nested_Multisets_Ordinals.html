<div id="Multiset_More">
<div class="head">
<h1>Theory Multiset_More</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       More about Multisets
    Author:      Mathias Fleury &lt;mathias.fleury at mpi-inf.mpg.de&gt;, 2015
    Author:      Jasmin Blanchette &lt;blanchette at in.tum.de&gt;, 2014, 2015
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Author:      Dmitriy Traytel &lt;traytel at in.tum.de&gt;, 2014
    Maintainer:  Mathias Fleury &lt;mathias.fleury at mpi-inf.mpg.de&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹More about Multisets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Multiset_More
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset_Order.html">HOL-Library.Multiset_Order</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Isabelle's theory of finite multisets is not as developed as other areas, such as lists and sets.
The present theory introduces some missing concepts and lemmas. Some of it is expected to move to
Isabelle's library.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Setup›</span></span>

<span class="keyword1"><span class="command">declare</span></span>
  diff_single_trivial <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  in_image_mset <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
  image_mset.compositionality <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="comment1">(*To have the same rules as the set counter-part*)</span>
  mset_subset_eqD<span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">?</span></span><span class="main">]</span> <span class="comment1">(*@{thm subsetD}*)</span>

  Multiset.in_multiset_in_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  inter_add_left1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  inter_add_left2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  inter_add_right1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  inter_add_right2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  sum_mset_sum_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Intersection, Union and Pointwise Inclusion›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_mset_imp_subset_add_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆#</span> add_mset <span class="free">x</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_diff_bothsides diff_subset_eq_self multiset_inter_def subset_mset.inf.absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_add_mset_notin_subset_mset<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆#</span> add_mset <span class="free">b</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∉#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.le_iff_sup<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_msetE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">A</span> <span class="main">⊂#</span> <span class="free">B</span><span class="main">;</span> <span class="main">⟦</span><span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span><span class="main">;</span> <span class="main">¬</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.less_le_not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Diff_triv_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∩#</span> <span class="free">N</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">-</span> <span class="free">N</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_intersect_left_idem diff_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_intersect_sym_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">∩#</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> multiset_inter_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_intersect_right_idem multiset_inter_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_add diff_cancel diff_subset_eq_self subset_mset.diff_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> subset_msetE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> subseq_mset_subseteq_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"subseq <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> mset <span class="free">xs</span> <span class="main">⊆#</span> mset <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Outer_Cons <span class="main">=</span> this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subseq_Cons' subseq_Cons2_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mset_subset_eq_add_mset_cancel subseq_Cons2_iff
          subset_mset_imp_subset_add_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Filter and Image›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_ge_count<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span><span class="main">)</span> <span class="main">≥</span> count <span class="free">A</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">f</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> count <span class="free">M</span> <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> inj_on_def›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_le_count_inj_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span> <span class="main">⟹</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">y</span> <span class="main">≤</span> count <span class="free">M</span> <span class="main">(</span>inv_into <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span> <span class="free">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> inj_xM <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> inj_M<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>set_mset <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inj_xM <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">M</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> x_in_M<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> y_eq_fx<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> x_in_M ih<span class="main">[</span><span class="operator">OF</span> inj_M<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> y_eq_fx <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_M insert_absorb<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> y_ne_fx<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> x_in_M ih<span class="main">[</span><span class="operator">OF</span> inj_M<span class="main">]</span> y_ne_fx insert_absorb <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> x_ni_M<span class="main">:</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> y_eq_fx<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">∉#</span> image_mset <span class="free">f</span> <span class="skolem">M</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x_ni_M inj_xM <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> y_eq_fx
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> inj_xM count_add_mset count_greater_eq_Suc_zero_iff count_inI
          image_mset_add_mset inv_into_f_f union_single_eq_member<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> y_ne_fx<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> neg_conj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span>
          <span class="main">≤</span> count <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="main">(</span>set_mset <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> cnt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>add_mset <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="skolem">M</span><span class="main">)</span> <span class="free">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> y_ne_fx <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_into <span class="main">(</span>set_mset <span class="skolem">M</span><span class="main">)</span> <span class="free">f</span> <span class="free">y</span> <span class="main">∈#</span> add_mset <span class="skolem">x</span> <span class="skolem">M</span> <span class="main">⟹</span>
          inv_into <span class="main">(</span>set_mset <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>inv_into <span class="main">(</span>set_mset <span class="skolem">M</span><span class="main">)</span> <span class="free">f</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          inv_into <span class="main">(</span>set_mset <span class="skolem">M</span><span class="main">)</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> inj_xM inv_into_f_f<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>
          count <span class="skolem">M</span> <span class="main">(</span>inv_into <span class="main">(</span>set_mset <span class="skolem">M</span><span class="main">)</span> <span class="free">f</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> inv_into <span class="main">(</span>set_mset <span class="skolem">M</span><span class="main">)</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> neg_conj cnt_y ih<span class="main">[</span><span class="operator">OF</span> inj_M<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> count_add_mset count_greater_zero_iff count_inI f_inv_into_f
            image_mset_add_mset set_image_mset<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> neg_conj cnt_y x_ni_M ih<span class="main">[</span><span class="operator">OF</span> inj_M<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> count_greater_zero_iff count_inI eq_iff image_mset_add_mset
            less_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_filter_compl<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>filter <span class="free">p</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> mset <span class="main">(</span>filter <span class="main">(</span>Not <span class="main">∘</span> <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Near duplicate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] filter_eq_replicate_mset<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> filter_eq_replicate_mset<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="main">(</span><span class="main">(=)</span> <span class="free">L</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> replicate_mset <span class="main">(</span>count <span class="free">A</span> <span class="free">L</span><span class="main">)</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">M'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">Q</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="free">M</span> <span class="main">=</span> filter_mset <span class="free">Q</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">-</span> filter_mset <span class="free">Q</span> <span class="free">M</span> <span class="main">=</span> filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">¬</span><span class="free">Q</span> <span class="bound">a</span><span class="main">)</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset_partition add_diff_cancel_left'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_mset_eq_conv assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_filter_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> image_mset <span class="free">f</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_cong2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟹</span> image_mset <span class="free">f</span> <span class="free">M</span> <span class="main">=</span> image_mset <span class="free">g</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> image_mset_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_empty_conv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>filter_mset <span class="free">P</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">L</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">L</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_filter_mono2<span class="main">:</span> <span class="quoted"><span class="quoted">‹filter_mset <span class="free">P</span> <span class="free">A</span> <span class="main">⊆#</span> filter_mset <span class="free">Q</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">a</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_filter_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">C</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">C</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">C</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="free">f</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">C</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">C</span><span class="main">#}</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">g</span> <span class="bound">C</span> <span class="main">|</span> <span class="bound"><span class="bound">C</span></span><span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">C</span><span class="main">#}</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_filter_swap2<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="bound">C</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">P</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">D</span><span class="main">#}</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">C</span> <span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">P</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">C</span><span class="main">|</span> <span class="bound"><span class="bound">C</span></span> <span class="main">∈#</span> <span class="free">D</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">P</span> <span class="bound">C</span><span class="main">)</span><span class="main">#}</span><span class="main">#}</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_filter_swap<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> image_mset_cong2 <span class="main">[</span><span class="operator">cong</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_empty_if_finite_and_filter_set_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> empty_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Y</span><span class="main">.</span> set_mset <span class="bound">Y</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> empty_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Sum›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_image_mset_sum_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sum_mset <span class="main">(</span>image_mset <span class="free">f</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_map sum_mset_sum_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_image_mset_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>canonically_ordered_monoid_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_union le_iff_add sub subset_mset.add_diff_inverse sum_mset.union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_image_mset_mono_mem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">n</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>canonically_ordered_monoid_add"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_iff_add multi_member_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> count_sum_mset_if_1_0<span class="main">:</span> <span class="quoted"><span class="quoted">‹count <span class="free">M</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_mset_dvd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_semiring_1_cancel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="bound">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_mset_distrib_div_if_dvd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>unique_euclidean_semiring"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="bound">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="keyword1">div</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_plus_div_distrib_dvd_left<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Remove›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_minus_replicate_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> count <span class="free">A</span> <span class="free">a</span> <span class="main">⟹</span> set_mset <span class="main">(</span><span class="free">A</span> <span class="main">-</span> replicate_mset <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> count <span class="free">A</span> <span class="free">a</span> <span class="main">⟹</span> set_mset <span class="main">(</span><span class="free">A</span> <span class="main">-</span> replicate_mset <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">removeAll_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">removeAll_mset</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">-</span> replicate_mset <span class="main">(</span>count <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_removeAll<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"removeAll_mset <span class="free">C</span> <span class="main">(</span>mset <span class="free">L</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>removeAll <span class="free">C</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> multiset_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> removeAll_mset_filter_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"removeAll_mset <span class="free">C</span> <span class="free">M</span> <span class="main">=</span> filter_mset <span class="main">(</span><span class="main">(≠)</span> <span class="free">C</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">remove1_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove1_mset</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">-</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> removeAll_subseteq_remove1_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"removeAll_mset <span class="free">x</span> <span class="free">M</span> <span class="main">⊆#</span> remove1_mset <span class="free">x</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subseteq_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_remove1_mset_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> remove1_mset <span class="free">b</span> <span class="free">C</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms diff_single_trivial in_diffD insert_DiffM insert_noteq_member<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_mset_removeAll_mset_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>removeAll_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> count_inI mset_subset_size <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_mset_def multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_remove1_mset_If<span class="main">:</span> <span class="quoted"><span class="quoted">‹size <span class="main">(</span>remove1_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> size <span class="free">M</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_Diff_subset_Int<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_mset_remove1_mset_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>remove1_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_irrefl
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_subset_size <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_countE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_mset_def multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_1_mset_id_iff_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1_mset <span class="free">a</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∉#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_single_trivial multi_drop_mem_not_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_remove_1_mset_iff_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> remove1_mset <span class="free">a</span> <span class="free">M</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∉#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remove_1_mset_id_iff_notin <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_mset_eqE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remove1_mset <span class="free">L</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">L</span> <span class="main">∈#</span> <span class="free">x1</span> <span class="main">⟹</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">L</span> <span class="main">∉#</span> <span class="free">x1</span> <span class="main">⟹</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> <span class="free">x1</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> image_filter_ne_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">#}</span> <span class="main">=</span> removeAll_mset <span class="free">y</span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_remove1_mset_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="main">(</span>remove1_mset <span class="free">a</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">M</span> <span class="keyword1">then</span> remove1_mset <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="keyword1">else</span> image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_Diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">#}</span> <span class="main">=</span> removeAll_mset <span class="free">y</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' filter_eq_replicate_mset multiset_partition<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_neq_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">#}</span> <span class="main">=</span> removeAll_mset <span class="free">y</span> <span class="main">{#</span> <span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_filter_mset filter_mset_neq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_mset_add_mset_If<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remove1_mset <span class="free">L</span> <span class="main">(</span>add_mset <span class="free">L'</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">L</span> <span class="main">=</span> <span class="free">L'</span> <span class="keyword1">then</span> <span class="free">C</span> <span class="keyword1">else</span> remove1_mset <span class="free">L</span> <span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_remove1_mset_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> remove1_mset <span class="free">b</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">∧</span> count <span class="free">A</span> <span class="free">b</span> <span class="main">≥</span> count <span class="free">B</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_greater_zero_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> count_greater_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_eq_add_mset_ne<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟹</span> add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> add_mset <span class="free">b</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> add_mset <span class="free">b</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_single_eq_union diff_union_swap multi_self_add_other_not_self
    remove_1_mset_id_iff_notin union_single_eq_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_eq_add_mset<span class="main">:</span> <span class="quoted"><span class="quoted">‹add_mset <span class="free">a</span> <span class="free">M</span> <span class="main">=</span> add_mset <span class="free">b</span> <span class="free">M'</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">∧</span> add_mset <span class="free">a</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="free">M'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_eq_add_mset_ne add_mset_remove_trivial union_single_eq_member<span class="main">)</span>

<span class="comment1">(* TODO move to Multiset: could replace add_mset_remove_trivial_eq? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> add_mset_remove_trivial_iff<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">N</span> <span class="main">=</span> add_mset <span class="free">a</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_left_cancel add_mset_remove_trivial insert_DiffM2 single_eq_single
      size_mset_remove1_mset_le_iff union_single_eq_member<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trivial_add_mset_remove_iff<span class="main">:</span> <span class="quoted"><span class="quoted">‹add_mset <span class="free">a</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> add_mset_remove_trivial_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_single_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹remove1_mset <span class="free">L</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">L</span> <span class="main">=</span> <span class="free">L'</span>›</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_mset_remove_trivial_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_less_imp_less_remove1_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xM_lt_N<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> remove1_mset <span class="free">x</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms le_multiset_right_total mset_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_less_cancel_right add_mset_add_single diff_single_trivial insert_DiffM2 xM_lt_N<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Replicate›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_mset_minus_replicate_mset_same<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"replicate_mset <span class="free">m</span> <span class="free">x</span> <span class="main">-</span> replicate_mset <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> replicate_mset <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> left_diff_repeat_mset_distrib' repeat_mset_replicate_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_mset_subset_iff_lt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="free">m</span> <span class="free">x</span> <span class="main">⊂#</span> replicate_mset <span class="free">n</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> diff_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.gr_zeroI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_mset_subseteq_iff_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="free">m</span> <span class="free">x</span> <span class="main">⊆#</span> replicate_mset <span class="free">n</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> diff_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_mset_lt_iff_lt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="free">m</span> <span class="free">x</span> <span class="main">&lt;</span> replicate_mset <span class="free">n</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> diff_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.gr_zeroI gr_zeroI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_mset_le_iff_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="free">m</span> <span class="free">x</span> <span class="main">≤</span> replicate_mset <span class="free">n</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> diff_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_mset_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"replicate_mset <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> replicate_mset <span class="free">n</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="free">m</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> in_replicate_mset insert_noteq_member size_replicate_mset union_single_eq_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_mset_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> replicate_mset <span class="free">a</span> <span class="free">C</span> <span class="main">+</span> replicate_mset <span class="free">b</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_replicate_replicate_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>replicate <span class="free">n</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> replicate_mset <span class="free">n</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_single_iff_replicate_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">U</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">.</span> <span class="free">U</span> <span class="main">=</span> replicate_mset <span class="bound">n</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> count_greater_zero_iff count_replicate_mset insertI1 multi_count_eq singletonD
    zero_less_iff_neq_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_replicate_mset_if_all_elems_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> replicate_mset <span class="bound">n</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_replicate_mset mem_Collect_eq multiset_eqI neq0_conv set_mset_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multiset and Set Conversions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_mset_set_if<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset_set <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> finite <span class="free">A</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_set_set_mset_empty_mempty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_set <span class="main">(</span>set_mset <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">D</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_set_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_mset_set_le_one<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset_set <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_mset_set_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_set_set_mset_subseteq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_set <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_set_set_mset_msubset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_sorted_list_of_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_sorted_list_of_multiset sorted_list_of_mset_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sorted_list_of_multiset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>sorted_list_of_multiset <span class="main">(</span><span class="free">M</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>linorder multiset<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_sorted_list_of_multiset sorted_list_of_multiset_mset sorted_sort<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_take_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆#</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_list_of_multiset_eq_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_list_of_multiset <span class="free">M</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_sorted_list_of_multiset sorted_list_of_multiset_empty<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Duplicate Removal›</span></span>

<span class="comment1">(* TODO: use abbreviation? *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remdups_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> multiset <span class="main">⇒</span> <span class="tfree">'v</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remdups_mset</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> mset_set <span class="main">(</span>set_mset <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_remdups_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹set_mset <span class="main">(</span>remdups_mset <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> count_remdups_mset_eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> remdups_mset <span class="free">A</span> <span class="main">⟷</span> count <span class="main">(</span>remdups_mset <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_eq_zero_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> count_inI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_mset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"remdups_mset <span class="main">{#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_mset_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"remdups_mset <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_mset_eq_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"remdups_mset <span class="free">D</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">D</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_mset_singleton_sum<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups_mset <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="keyword1">then</span> remdups_mset <span class="free">A</span> <span class="keyword1">else</span> add_mset <span class="free">a</span> <span class="main">(</span>remdups_mset <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_remdups_remdups_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remdups <span class="free">D</span><span class="main">)</span> <span class="main">=</span> remdups_mset <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">D</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> mset_remdups_remdups_mset<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinct_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distinct_mset</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> count <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_count_less_1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">S</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> count <span class="free">S</span> <span class="bound">a</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_iff nat_le_linear <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_count_less_1
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹count <span class="free">A</span> <span class="skolem">a</span> <span class="main">≤</span> count <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹count <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_count_less_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹count <span class="free">A</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_minus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span> <span class="main">⟹</span> distinct_mset <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_subset_eq_self mset_subset_eq_exists_conv distinct_mset_union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_remdups_mset_If<span class="main">:</span> <span class="quoted"><span class="quoted">‹count <span class="main">(</span>remdups_mset <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_rempdups_union_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪#</span> <span class="free">B</span> <span class="main">=</span> remdups_mset <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms nat_le_linear <span class="keyword1"><span class="command">unfolding</span></span> remdups_mset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_eq_iff max_def count_mset_set_if distinct_mset_def not_in_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∉#</span> <span class="free">L</span> <span class="main">∧</span> distinct_mset <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_size_eq_card<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">C</span> <span class="main">⟹</span> size <span class="free">C</span> <span class="main">=</span> card <span class="main">(</span>set_mset <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct_mset <span class="main">(</span><span class="free">L</span> <span class="main">+</span> <span class="free">L'</span><span class="main">)</span> <span class="main">⟷</span> distinct_mset <span class="free">L</span> <span class="main">∧</span> distinct_mset <span class="free">L'</span> <span class="main">∧</span> <span class="free">L</span> <span class="main">∩#</span> <span class="free">L'</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">L</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_set_mset_ident<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">M</span> <span class="main">⟹</span> mset_set <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_finite_set_mset_subseteq_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">⊆#</span> mset_set <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms distinct_mset_set_mset_ident finite_set_mset msubset_mset_set_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mem_diff_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set_mset <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">M</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist mem <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distinct_mset_def in_diffD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mem <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_greater_eq_one_iff in_diff_count not_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_set_mset_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">=</span> set_mset <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_mset_set_mset_ident <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_union_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‹distinct_mset <span class="main">(</span><span class="free">D</span> <span class="main">∪#</span> <span class="free">C</span><span class="main">)</span> <span class="main">⟷</span> distinct_mset <span class="free">D</span> <span class="main">∧</span> distinct_mset <span class="free">C</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_count_less_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_inter_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct_mset <span class="free">C</span> <span class="main">⟹</span> distinct_mset <span class="main">(</span><span class="free">C</span> <span class="main">∩#</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"distinct_mset <span class="free">D</span> <span class="main">⟹</span> distinct_mset <span class="main">(</span><span class="free">C</span> <span class="main">∩#</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_inter_def<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> distinct_mset_minus multiset_inter_commute multiset_inter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_remove1_All<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">C</span> <span class="main">⟹</span> remove1_mset <span class="free">L</span> <span class="free">C</span> <span class="main">=</span> removeAll_mset <span class="free">L</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff distinct_mset_count_less_1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_size_2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">M</span> <span class="main">⟹</span> distinct_mset <span class="main">{#</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">L</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_mset_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹distinct_mset <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> distinct <span class="free">xs</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_image_mset_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span> <span class="main">⟹</span> distinct_mset <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">⟷</span> distinct_mset <span class="free">M</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Repeat Operation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_mset_compower<span class="main">:</span> <span class="quoted"><span class="quoted">"repeat_mset <span class="free">n</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(+)</span> <span class="free">A</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_mset_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"repeat_mset <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>repeat_mset <span class="free">n</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">^^</span> <span class="free">m</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> repeat_mset_distrib<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cartesian Product›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of the cartesian products over multisets. The construction mimics of the cartesian
  product on sets and use the same theorem names (adding only the suffix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>_mset›</span></span></span></span> to Sigma
  and Times). See file <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹~~/src/HOL/Product_Type.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sigma_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> multiset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sigma_mset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">{#</span><span class="main">{#</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">a</span><span class="main">#}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Times_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'b</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> multiset"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">×#</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Times_mset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> Sigma_mset <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Times_mset

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Contrary to the set version <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1"><span class="keyword1">SIGMA</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">:</span></span><span class="free"><span class="free">A</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">B</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we use the non-ASCII symbol <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∈#›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_Sigma_mset"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span> multiset<span class="main">,</span> <span class="tfree">'b</span> multiset<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span> multiset"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">SIGMAMSET</span> _<span class="keyword1">∈#</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="keyword1">SIGMAMSET</span> <span class="free">x</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="free">B</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> Sigma_mset <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">B</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Link between the multiset and the set cartesian product:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">A</span> <span class="main">×</span> set_mset <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_msetI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">;</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈#</span> Sigma_mset <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Sigma_mset_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_msetE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="main">∈#</span> Sigma_mset <span class="free">A</span> <span class="free">B</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">B</span> <span class="bound">x</span><span class="main">;</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Sigma_mset_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Elimination of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">a</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">b</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈#</span></span> <span class="free"><span class="free">A</span></span> <span class="main"><span class="main">×#</span></span> <span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- introduces no eigenvariables.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_msetD1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈#</span> Sigma_mset <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_msetD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈#</span> Sigma_mset <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_msetE2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈#</span> Sigma_mset <span class="free">A</span> <span class="free">B</span><span class="main">;</span> <span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">;</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">D</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">SIGMAMSET</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SIGMAMSET</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sigma_mset_def image_mset_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_sum_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="free">M</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">P</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> count <span class="bound">P</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_plus_distrib1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sigma_mset <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> Sigma_mset <span class="free">A</span> <span class="free">C</span> <span class="main">+</span> Sigma_mset <span class="free">B</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_plus_distrib2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Sigma_mset <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">C</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Sigma_mset <span class="free">A</span> <span class="free">B</span> <span class="main">+</span> Sigma_mset <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_single_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">=</span> image_mset <span class="main">(</span>Pair <span class="free">a</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_single_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Pair <span class="bound">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_single_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_Pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="main">(</span>Pair <span class="free">a</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">then</span> count <span class="free">B</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> count_Sigma_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>Sigma_mset <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> count <span class="free">A</span> <span class="free">a</span> <span class="main">*</span> count <span class="main">(</span><span class="free">B</span> <span class="free">a</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sigma_mset_def count_image_mset_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_empty1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sigma_mset <span class="main">{#}</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_empty2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">×#</span> <span class="main">{#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_Sigma_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">⊆#</span> <span class="free">D</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sigma_mset <span class="free">A</span> <span class="free">B</span> <span class="main">⊆#</span> Sigma_mset <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> count <span class="main">(</span><span class="free">B</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">≤</span> count <span class="free">C</span> <span class="skolem">a</span> <span class="main">*</span> count <span class="main">(</span><span class="free">D</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> subseteq_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_inI eq_iff mult_eq_0_iff mult_le_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subseteq_mset_def count_Sigma_mset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_Sigma_mset_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈#</span> Sigma_mset <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_Times_mset_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">⟷</span> fst <span class="free">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">∧</span> snd <span class="free">x</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SIGMAMSET</span> <span class="bound">i</span><span class="main">∈#</span><span class="free">I</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈#</span><span class="free">I</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sigma_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_subset_mset_cancel1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subseteq_mset_def count_Sigma_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_subset_mset_cancel2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">⊆#</span> <span class="free">B</span> <span class="main">×#</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subseteq_mset_def count_Sigma_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_eq_cancel2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">=</span> <span class="free">B</span> <span class="main">×#</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_Sigma_mset <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_countE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_paired_Ball_mset_Sigma_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">∈#</span>Sigma_mset <span class="free">A</span> <span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈#</span><span class="free">B</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> split_paired_Bex_mset_Sigma_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">∈#</span>Sigma_mset <span class="free">A</span> <span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈#</span><span class="free">B</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_mset_if_eq_constant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">^^</span> <span class="main">(</span>count <span class="free">M</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iterate_op_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(+)</span> <span class="free">k</span><span class="main">)</span> <span class="main">^^</span> <span class="free">m</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> untion_image_mset_Pair_distribute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span>image_mset <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">J</span> <span class="main">-</span> <span class="free">I</span><span class="main">#}</span> <span class="main">=</span>
   <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">{#</span>image_mset <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">J</span><span class="main">#}</span> <span class="main">-</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span>image_mset <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">I</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_sum_mset count_image_mset_Pair sum_mset_if_eq_constant
    iterate_op_plus diff_mult_distrib2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_Un_distrib1<span class="main">:</span> <span class="quoted"><span class="quoted">"Sigma_mset <span class="main">(</span><span class="free">I</span> <span class="main">∪#</span> <span class="free">J</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> Sigma_mset <span class="free">I</span> <span class="free">C</span> <span class="main">∪#</span> Sigma_mset <span class="free">J</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sigma_mset_def sup_subset_mset_def untion_image_mset_Pair_distribute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_Un_distrib2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SIGMAMSET</span> <span class="bound">i</span><span class="main">∈#</span><span class="free">I</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∪#</span> <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Sigma_mset <span class="free">I</span> <span class="free">A</span> <span class="main">∪#</span> Sigma_mset <span class="free">I</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_sum_mset count_image_mset_Pair sum_mset_if_eq_constant
    Sigma_mset_def diff_mult_distrib2 iterate_op_plus max_def not_in_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_Int_distrib1<span class="main">:</span> <span class="quoted"><span class="quoted">"Sigma_mset <span class="main">(</span><span class="free">I</span> <span class="main">∩#</span> <span class="free">J</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> Sigma_mset <span class="free">I</span> <span class="free">C</span> <span class="main">∩#</span> Sigma_mset <span class="free">J</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_sum_mset count_image_mset_Pair sum_mset_if_eq_constant
    Sigma_mset_def iterate_op_plus min_def not_in_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_Int_distrib2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SIGMAMSET</span> <span class="bound">i</span><span class="main">∈#</span><span class="free">I</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∩#</span> <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Sigma_mset <span class="free">I</span> <span class="free">A</span> <span class="main">∩#</span> Sigma_mset <span class="free">I</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_sum_mset count_image_mset_Pair sum_mset_if_eq_constant
    Sigma_mset_def iterate_op_plus min_def not_in_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_Diff_distrib1<span class="main">:</span> <span class="quoted"><span class="quoted">"Sigma_mset <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="free">J</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> Sigma_mset <span class="free">I</span> <span class="free">C</span> <span class="main">-</span> Sigma_mset <span class="free">J</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_sum_mset count_image_mset_Pair sum_mset_if_eq_constant
    Sigma_mset_def iterate_op_plus min_def not_in_iff diff_mult_distrib2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_Diff_distrib2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SIGMAMSET</span> <span class="bound">i</span><span class="main">∈#</span><span class="free">I</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Sigma_mset <span class="free">I</span> <span class="free">A</span> <span class="main">-</span> Sigma_mset <span class="free">I</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_sum_mset count_image_mset_Pair sum_mset_if_eq_constant
    Sigma_mset_def iterate_op_plus min_def not_in_iff diff_mult_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_Union<span class="main">:</span> <span class="quoted"><span class="quoted">"Sigma_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free">X</span><span class="main">)</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> Sigma_mset <span class="bound">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_sum_mset count_image_mset_Pair sum_mset_if_eq_constant
    Sigma_mset_def iterate_op_plus min_def not_in_iff sum_mset_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_Un_distrib1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">∪#</span> <span class="free">B</span><span class="main">)</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">∪#</span> <span class="free">B</span> <span class="main">×#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> Sigma_mset_Un_distrib1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_Int_distrib1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">∩#</span> <span class="free">B</span><span class="main">)</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">∩#</span> <span class="free">B</span> <span class="main">×#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> Sigma_mset_Int_distrib1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_Diff_distrib1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">-</span> <span class="free">B</span> <span class="main">×#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> Sigma_mset_Diff_distrib1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sigma_mset_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_insert_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">×#</span> add_mset <span class="free">x</span> <span class="free">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">+</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Pair <span class="bound">a</span> <span class="free">x</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> Sigma_mset_plus_distrib2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_insert_right<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">+</span> image_mset <span class="main">(</span>Pair <span class="free">a</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> Sigma_mset_plus_distrib1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_image_mset_times_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"image_mset fst <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{#}</span> <span class="keyword1">then</span> <span class="main">{#}</span> <span class="keyword1">else</span> repeat_mset <span class="main">(</span>size <span class="free">B</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Times_mset_single_right <span class="dynamic"><span class="dynamic">ac_simps</span></span> Times_insert_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> snd_image_mset_times_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"image_mset snd <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{#}</span> <span class="keyword1">then</span> <span class="main">{#}</span> <span class="keyword1">else</span> repeat_mset <span class="main">(</span>size <span class="free">A</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_right Times_insert_left image_mset_const_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> product_swap_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset prod.swap <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">×#</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_left Times_mset_single_right
      Times_insert_right Times_insert_left<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">product_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'b</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">product_mset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> member_product_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> product_mset <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Multiset_More.product_mset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_Sigma_mset_abs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>Sigma_mset <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> count <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> count <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff count_Sigma_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_image_mset1<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Times_insert_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_image_mset2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">×#</span> image_mset <span class="free">f</span> <span class="free">B</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Times_insert_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_le_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_singleton_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">×#</span> <span class="free">C</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">×#</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_Sigma_mset count_image_mset vimage_def Times_mset_Times
      Int_commute count_eq_zero_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> sum_le_singleton<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sum.cong if_cong<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer Rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_multiset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(+)</span> <span class="main">(+)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> rel_fun_def rel_mset_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_appendI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">@</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> conjI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_multiset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(-)</span> <span class="main">(-)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> rel_fun_def rel_mset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">(</span>fold remove1 <span class="skolem">xs'</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>fold remove1 <span class="skolem">ys'</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>fold remove1 <span class="skolem">xs'</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">xs</span> <span class="main">-</span> mset <span class="skolem">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>fold remove1 <span class="skolem">ys'</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">ys</span> <span class="main">-</span> mset <span class="skolem">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs''</span> <span class="bound">ys''</span><span class="main">.</span>
    mset <span class="bound">xs''</span> <span class="main">=</span> mset <span class="skolem">xs</span> <span class="main">-</span> mset <span class="skolem">xs'</span> <span class="main">∧</span> mset <span class="bound">ys''</span> <span class="main">=</span> mset <span class="skolem">ys</span> <span class="main">-</span> mset <span class="skolem">ys'</span> <span class="main">∧</span> list_all2 <span class="free">R</span> <span class="bound">xs''</span> <span class="bound">ys''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> rel_mset_Zero<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> count_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(</span>rel_fun <span class="free">R</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span> count count"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def rel_mset_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x'</span> <span class="skolem">xs</span> <span class="skolem">y'</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bi_unique_alt_def2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subseteq_multiset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> filter_mset <span class="main">(</span>Domainp <span class="free">R</span><span class="main">)</span> <span class="bound">M</span> <span class="main">⊆#</span> filter_mset <span class="main">(</span>Domainp <span class="free">R</span><span class="main">)</span> <span class="bound">N</span><span class="main">)</span> <span class="main">(⊆#)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> count_filter_mset_less<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> count <span class="main">(</span>filter_mset <span class="main">(</span>Domainp <span class="free">R</span><span class="main">)</span> <span class="skolem">M</span><span class="main">)</span> <span class="bound">a</span> <span class="main">≤</span> count <span class="main">(</span>filter_mset <span class="main">(</span>Domainp <span class="free">R</span><span class="main">)</span> <span class="skolem">N</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟷</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> Domainp <span class="free">R</span> <span class="bound">x</span><span class="main">}</span><span class="main">.</span> count <span class="skolem">M</span> <span class="bound">a</span> <span class="main">≤</span> count <span class="skolem">N</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">M</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">N</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> subseteq_mset_def count_filter_mset_less
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_mset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">0</span> <span class="main">0</span> <span class="main">⟹</span> rel_fun <span class="free">R</span> <span class="main">(</span>rel_fun <span class="free">R</span> <span class="free">R</span><span class="main">)</span> <span class="main">(+)</span> <span class="main">(+)</span> <span class="main">⟹</span> <span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="free">R</span><span class="main">)</span> sum_mset sum_mset"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_list_transfer<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def rel_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_mset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun <span class="main">(</span>rel_mset <span class="free">R</span><span class="main">)</span> <span class="main">(</span>rel_fun <span class="main">(</span>rel_fun <span class="free">R</span> <span class="main">(</span>rel_mset <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rel_mset <span class="main">(</span>rel_prod <span class="free">R</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     Sigma_mset Sigma_mset"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Sigma_mset_def<span class="main">)</span> <span class="operator">transfer_prover</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Even More about Multisets›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets and Functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> range_image_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Ds</span> <span class="main">⊆</span> range <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">∈</span> range <span class="main">(</span>image_mset <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="free">Ds</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="free">f</span> <span class="bound">C</span> <span class="main">=</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f_i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="free">Ds</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">f_i</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">≡</span> image_mset <span class="skolem">f_i</span> <span class="free">Ds</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> f_p Cs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="skolem">Cs</span> <span class="main">=</span> <span class="free">Ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets and Lists›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_sorted_list_of_multiset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>sorted_list_of_multiset <span class="free">A</span><span class="main">)</span> <span class="main">=</span> size <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_sorted_list_of_multiset size_mset<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_of_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_of_mset</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> mset <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_of_mset_exi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> mset <span class="bound">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_list_of_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>list_of_mset <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ex_mset list_of_mset_def someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_list_of_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_of_mset <span class="free">A</span><span class="main">)</span> <span class="main">=</span> size <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_of_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> ex_mset size_mset someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> range_mset_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Ds</span> <span class="main">⊆</span> range <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">Cl</span><span class="main">.</span> mset <span class="main">(</span>map <span class="free">f</span> <span class="bound">Cl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">∈</span> range <span class="main">(</span>image_mset <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms range_image_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Cs_p<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="skolem">Cs</span> <span class="main">=</span> <span class="free">Ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cl</span> <span class="main">=</span> list_of_mset <span class="skolem">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">Cl</span> <span class="main">=</span> <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="main">(</span>mset <span class="skolem">Cl</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cs_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map <span class="free">f</span> <span class="skolem">Cl</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_of_mset_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_of_mset <span class="free">m</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ex_mset list_of_mset_def mset_zero_iff_right someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_mset_conv_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_mset_sum_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> <span class="free">LL</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">LL</span> <span class="main">∈</span> set <span class="free">Ci</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> sum_list <span class="free">Ci</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ci</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_mset_sum_list2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> sum_list <span class="free">Ci</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">LL</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">LL</span> <span class="main">∈</span> set <span class="free">Ci</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> <span class="free">LL</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ci</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* TODO: Make [simp]. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> in_mset_sum_list_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> sum_list <span class="free">𝒜</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="main">∈</span> set <span class="free">𝒜</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈#</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_mset_sum_list in_mset_sum_list2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subseteq_list_Union_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ci</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">CAi</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span>  <span class="free">Ci</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⊆#</span> <span class="free">CAi</span> <span class="main">!</span> <span class="bound">i</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">Ci</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAi</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ci</span></span> <span class="quoted"><span class="free">CAi</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> tl <span class="skolem">Ci</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⊆#</span> tl <span class="skolem">CAi</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">(</span>mset <span class="main">(</span>tl <span class="skolem">Ci</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">(</span>mset <span class="main">(</span>tl <span class="skolem">CAi</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">Ci</span> <span class="main">⊆#</span> hd <span class="skolem">CAi</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_conv_nth length_greater_0_conv zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">(</span>mset <span class="skolem">Ci</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">(</span>mset <span class="skolem">CAi</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Ci</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">CAi</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹More on Multisets and Functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subseteq_mset_size_eql<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆#</span> <span class="free">Y</span> <span class="main">⟹</span> size <span class="free">Y</span> <span class="main">=</span> size <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mset_subset_size subset_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_of_subset_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="free">η</span> <span class="free">C'</span> <span class="main">=</span> mset <span class="free">lC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">qC'</span><span class="main">.</span> map <span class="free">η</span> <span class="bound">qC'</span> <span class="main">=</span> <span class="free">lC</span> <span class="main">∧</span> mset <span class="bound">qC'</span> <span class="main">=</span> <span class="free">C'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lC</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> msed_map_invR <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_of_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆#</span> image_mset <span class="free">η</span> <span class="free">C'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> image_mset <span class="free">η</span> <span class="bound">A'</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">⊆#</span> <span class="free">C'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> image_mset <span class="free">η</span> <span class="free">C'</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lA</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lA</span> <span class="main">=</span> list_of_mset <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lD</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lD</span> <span class="main">=</span> list_of_mset <span class="main">(</span><span class="skolem">C</span><span class="main">-</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lC</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lC</span> <span class="main">=</span> <span class="skolem">lA</span> <span class="main">@</span> <span class="skolem">lD</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">lC</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_def assms <span class="keyword1"><span class="command">unfolding</span></span> lD_def lC_def lA_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">qC'</span><span class="main">.</span> map <span class="free">η</span> <span class="bound">qC'</span> <span class="main">=</span> <span class="skolem">lC</span> <span class="main">∧</span> mset <span class="bound">qC'</span> <span class="main">=</span> <span class="free">C'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms image_mset_of_subset_list <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qC'</span></span> <span class="keyword2"><span class="keyword">where</span></span> qC'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">η</span> <span class="skolem">qC'</span> <span class="main">=</span> <span class="skolem">lC</span> <span class="main">∧</span> mset <span class="skolem">qC'</span> <span class="main">=</span> <span class="free">C'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lA'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">lA</span><span class="main">)</span> <span class="skolem">qC'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">η</span> <span class="var">?lA'</span> <span class="main">=</span> <span class="skolem">lA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qC'_p lC_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj take_map<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="var">?lA'</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="free">η</span> <span class="var">?A'</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">using</span></span> lA_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> ex_mset list_of_mset_def mset_map someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">⊆#</span> <span class="free">C'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qC'_p <span class="keyword1"><span class="command">unfolding</span></span> lA_def
    <span class="keyword1"><span class="command">using</span></span> mset_take_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_the_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> card <span class="main">(</span>set_mset <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.empty card.insert card_mono finite.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_insert le_SucI singletonI subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Melem_subseteq_Union_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sum_mset.remove <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> Melem_subset_eq_sum_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆#</span> sum_list <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_subset_eq_add_left sum_mset.remove sum_mset_sum_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_subset_eq_Union_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">CAi</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CAi</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">(</span>mset <span class="free">CAi</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CAi</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈#</span> mset <span class="free">CAi</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_subset_eq_sum_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">CAi</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CAi</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⊆#</span> sum_list <span class="free">CAi</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CAi</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈#</span> mset <span class="free">CAi</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹More on Multiset Order›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_multiset_doubletons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">t</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">s</span>"</span></span>  
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">t</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">#}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="var">?X</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">#}</span> <span class="main">∧</span> <span class="main">{#</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">#}</span> <span class="main">-</span> <span class="var">?X</span> <span class="main">+</span> <span class="var">?Y</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="var">?Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="var">?X</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_eq_conv_diff assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Signed_Multiset">
<div class="head">
<h1>Theory Signed_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Signed (Finite) Multisets
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Signed (Finite) Multisets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Signed_Multiset
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Multiset_More.html">Multiset_More</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span>
  <span class="quoted">"!z"</span> <span class="main">=</span> <span class="quoted">"<span class="hidden">⇩</span><sub>z</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of Signed Multisets›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">equiv_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">×</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">×</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">equiv_zmset</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span> <span class="main">(</span><span class="bound">Np</span><span class="main">,</span> <span class="bound">Nn</span><span class="main">)</span><span class="main">.</span> <span class="bound">Mp</span> <span class="main">+</span> <span class="bound">Nn</span> <span class="main">=</span> <span class="bound">Np</span> <span class="main">+</span> <span class="bound">Mn</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span> <span class="tfree">'a</span> zmultiset <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">×</span> <span class="tfree">'a</span> multiset"</span></span> <span class="main">/</span> <span class="quoted">equiv_zmset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equivpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_zmset_def reflp_def symp_def transp_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> multi_union_self_other_eq union_lcomm<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Operations on Signed Multisets›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">cancel_comm_monoid_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_zmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">empty_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_zmset</span> <span class="main">≡</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_zmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span> <span class="main">(</span><span class="bound">Np</span><span class="main">,</span> <span class="bound">Nn</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">Mp</span> <span class="main">+</span> <span class="bound">Nn</span><span class="main">,</span> <span class="bound">Mn</span> <span class="main">+</span> <span class="bound">Np</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def union_commute union_lcomm<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_zmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span> <span class="main">(</span><span class="bound">Np</span><span class="main">,</span> <span class="bound">Nn</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">Mp</span> <span class="main">+</span> <span class="bound">Np</span><span class="main">,</span> <span class="bound">Mn</span> <span class="main">+</span> <span class="bound">Nn</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def union_commute union_lcomm<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">group_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_zmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">Mn</span><span class="main">,</span> <span class="bound">Mp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> zcount <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> int <span class="main">(</span>count <span class="bound">Mp</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>count <span class="bound">Mn</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_add <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def fun_eq_iff multiset_eq_iff diff_eq_eq
    diff_add_eq eq_diff_eq of_nat_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="main">=</span> zcount <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_add <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def fun_eq_iff multiset_eq_iff
    diff_eq_eq diff_add_eq eq_diff_eq of_nat_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmultiset_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">a</span> <span class="main">=</span> zcount <span class="free">N</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zcount_inject<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmultiset_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> zcount <span class="free">A</span> <span class="bound">x</span> <span class="main">=</span> zcount <span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zmultiset_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">-</span> zcount <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> add_zmset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>add_mset <span class="bound">x</span> <span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_zmultiset"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{#</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">,</span> <span class="free">xs</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> add_zmset <span class="free">x</span> <span class="main">{#</span><span class="free">xs</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span>
  <span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> add_zmset <span class="free">x</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>add_zmset <span class="free">b</span> <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">then</span> zcount <span class="free">A</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> zcount <span class="free">A</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_single<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">{#</span><span class="free">b</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> add_add_same_iff_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zmset_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">x</span> <span class="main">(</span>add_zmset <span class="free">y</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> add_zmset <span class="free">y</span> <span class="main">(</span>add_zmset <span class="free">x</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  singleton_ne_empty_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  empty_ne_singleton_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">≠</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">x</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">zcount</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  singleton_ne_uminus_singleton_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">≠</span> <span class="main">-</span> <span class="main">{#</span><span class="free">y</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  uminus_singleton_ne_singleton_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">≠</span> <span class="main">{#</span><span class="free">y</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted">zcount</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion to Set and Membership›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_zmset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">elem_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">elem_zmset</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> set_zmset <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword1">'(∈#<span class="hidden">⇩</span><sub>z</sub>')</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword1">'(:#z')</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">:#z</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">not_elem_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">not_elem_zmset</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> set_zmset <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  not_elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword1">'(∉#<span class="hidden">⇩</span><sub>z</sub>')</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  not_elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  not_elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword1">'(~:#z')</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  not_elem_zmset <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">~:#z</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Ball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ball</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> Set.Ball <span class="main">(</span>set_zmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Bex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Bex</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> Set.Bex <span class="main">(</span>set_zmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_ZMBall"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_ZMBex"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_ZMBall"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">:#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_ZMBex"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">:#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> Signed_Multiset.Ball <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> Signed_Multiset.Bex <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_eq_zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_iff_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟷</span> zcount <span class="free">M</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_eq_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_ne_zero_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_inI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff_zmset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_zmset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_zmset <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_zmset_single<span class="main">:</span> <span class="quoted"><span class="quoted">"set_zmset <span class="main">{#</span><span class="free">b</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_zmset_eq_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_zmset <span class="free">M</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff zcount_eq_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_count_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">x</span> <span class="main">≠</span> count <span class="free">N</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">x</span> <span class="main">≠</span> count <span class="free">N</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> set_mset <span class="free">M</span> <span class="main">∪</span> set_mset <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_mset <span class="free">M</span> <span class="main">∪</span> set_mset <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_UnI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set_mset finite_set_mset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_set_zmset<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_zmset <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_zmset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_count_ne<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmultiset_nonemptyE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Union›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="free">a</span> <span class="main">+</span> zcount <span class="free">N</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> union_add_left_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">A</span> <span class="main">+</span> <span class="free">B</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> union_zmset_add_zmset_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> add_zmset <span class="free">a</span> <span class="free">B</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zmset_add_single<span class="main">:</span> <span class="quoted"><span class="quoted">‹add_zmset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> union_zmset_add_zmset_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add.comm_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Difference›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="free">a</span> <span class="main">-</span> zcount <span class="free">N</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zmset_diff_bothsides<span class="main">:</span> <span class="quoted"><span class="quoted">‹add_zmset <span class="free">a</span> <span class="free">M</span> <span class="main">-</span> add_zmset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> <span class="free">M</span> <span class="main">-</span> <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_diff_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">-</span> <span class="free">N</span> <span class="main">⟷</span> zcount <span class="free">N</span> <span class="free">a</span> <span class="main">≠</span> zcount <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_add_zmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="free">N</span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">-</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span> <span class="main">-</span> <span class="free">N</span> <span class="main">-</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> diff_diff_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_Diff_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">x</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_union_swap_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">b</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">=</span> add_zmset <span class="free">b</span> <span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_add_zmset_swap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">b</span> <span class="free">M</span> <span class="main">-</span> <span class="free">A</span> <span class="main">=</span> add_zmset <span class="free">b</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_diff_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">::</span> <span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">-</span> <span class="free">N</span> <span class="main">-</span> <span class="free">P</span> <span class="main">=</span> <span class="free">M</span> <span class="main">-</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_diff_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_add<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equality of Signed Multisets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> single_eq_single_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{#</span><span class="free">b</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> multi_self_add_other_not_self_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> add_zmset <span class="free">x</span> <span class="free">M</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zmset_remove_trivial<span class="main">:</span> <span class="quoted"><span class="quoted">‹add_zmset <span class="free">x</span> <span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="free">M</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_single_eq_union_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> add_zmset <span class="free">x</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> union_single_eq_diff_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">x</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_zmset_add_single<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> add_implies_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zmset_eq_conv_diff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">M</span> <span class="main">=</span> add_zmset <span class="free">b</span> <span class="free">N</span> <span class="main">⟷</span>
   <span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">=</span> add_zmset <span class="free">b</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">b</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zmset_eq_conv_ex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>add_zmset <span class="free">a</span> <span class="free">M</span> <span class="main">=</span> add_zmset <span class="free">b</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">K</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> add_zmset <span class="free">b</span> <span class="bound">K</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="bound">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_zmset_eq_conv_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> multi_member_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> add_zmset <span class="free">x</span> <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">M</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">{#</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversions from and to Multisets›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> zmset_of <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span>Abs_multiset <span class="bound">f</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="free">M</span> <span class="main">=</span> zmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="main">{#}</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_def zero_zmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> add_zmset <span class="free">x</span> <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def add_mset_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_of_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> int <span class="main">(</span>count <span class="free">M</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def eq_onp_same_args plus_multiset.abs_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> mset_pos <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span><span class="main">.</span> count <span class="main">(</span><span class="bound">Mp</span> <span class="main">-</span> <span class="bound">Mn</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">count</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_right<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> mset_neg <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span><span class="main">.</span> count <span class="main">(</span><span class="bound">Mn</span> <span class="main">-</span> <span class="bound">Mp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">count</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  zmset_of_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_pos <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  minus_zmset_of_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="main">(</span><span class="main">-</span> zmset_of <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> neg_zmset_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zmset_of_inject<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  count_mset_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset_pos <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> nat <span class="main">(</span>zcount <span class="free">M</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  count_mset_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset_neg <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">-</span> zcount <span class="free">M</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  mset_pos_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_pos <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  mset_neg_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  mset_pos_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_pos <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  mset_neg_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  mset_pos_neg_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zmset_of <span class="main">(</span>mset_pos <span class="free">M</span><span class="main">)</span> <span class="main">-</span> zmset_of <span class="main">(</span>mset_neg <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  mset_pos_as_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="main">(</span>mset_pos <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="main">(</span>mset_neg <span class="free">M</span><span class="main">)</span> <span class="main">+</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  mset_neg_as_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="main">(</span>mset_neg <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="main">(</span>mset_pos <span class="free">M</span><span class="main">)</span> <span class="main">-</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zmultiset_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pos_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_pos <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> mset_neg <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> mset_pos <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pos_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset_pos <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mset_pos <span class="free">A</span> <span class="main">-</span> mset_neg <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>mset_pos <span class="free">B</span> <span class="main">-</span> mset_neg <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset_neg <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mset_neg <span class="free">A</span> <span class="main">-</span> mset_pos <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>mset_neg <span class="free">B</span> <span class="main">-</span> mset_pos <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pos_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset_pos <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mset_pos <span class="free">A</span> <span class="main">-</span> mset_pos <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>mset_neg <span class="free">B</span> <span class="main">-</span> mset_neg <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_pos_plus<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span> <span class="free"><span class="free"><span class="free">B</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset_neg <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mset_neg <span class="free">A</span> <span class="main">-</span> mset_neg <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>mset_pos <span class="free">B</span> <span class="main">-</span> mset_pos <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_neg_plus<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span> <span class="free"><span class="free"><span class="free">B</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pos_neg_dual<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset_pos <span class="free">a</span> <span class="main">+</span> mset_pos <span class="free">b</span> <span class="main">+</span> <span class="main">(</span>mset_neg <span class="free">a</span> <span class="main">-</span> mset_pos <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>mset_neg <span class="free">b</span> <span class="main">-</span> mset_pos <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
   mset_neg <span class="free">a</span> <span class="main">+</span> mset_neg <span class="free">b</span> <span class="main">+</span> <span class="main">(</span>mset_pos <span class="free">a</span> <span class="main">-</span> mset_neg <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>mset_pos <span class="free">b</span> <span class="main">-</span> mset_neg <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">linarith_split_limit</span> <span class="main"><span class="main">=</span></span> 20<span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> decompose_zmset_of2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zmset_of <span class="free">A</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> zmset_of <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zmset_of <span class="main">(</span>mset_pos <span class="free">M</span> <span class="main">+</span> mset_neg <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zmset_of <span class="main">(</span>mset_pos <span class="free">N</span> <span class="main">+</span> mset_neg <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span>zmset_of <span class="main">(</span>mset_neg <span class="free">M</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="main">(</span>mset_neg <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">+</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_plus mset_pos_neg_partition<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="var">?B</span> <span class="main">+</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_plus diff_add_zmset mset_pos_neg_partition<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pointwise Ordering Induced by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> zcount<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subseteq_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">⊆#<span class="hidden">⇩</span><sub>z</sub></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="main">≤</span> zcount <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subset_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">⊂#<span class="hidden">⇩</span><sub>z</sub></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">supseteq_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊇#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supseteq_zmset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">supset_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊃#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supset_zmset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span>
  subseteq_zmset <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  supseteq_zmset <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊇#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  subseteq_zmset <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  subset_zmset <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  supseteq_zmset <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊇#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  supset_zmset <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;#<span class="hidden">⇩</span><sub>z</sub></span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> subset_zmset<span class="main">:</span> ordered_ab_semigroup_add_imp_le <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(-)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⊆#<span class="hidden">⇩</span><sub>z</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⊂#<span class="hidden">⇩</span><sub>z</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_zmset_def subseteq_zmset_def zmultiset_eq_iff
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans antisym<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> subset_zmset<span class="main">:</span>
  ordered_ab_semigroup_monoid_add_imp_le <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="main">(-)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⊆#<span class="hidden">⇩</span><sub>z</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⊂#<span class="hidden">⇩</span><sub>z</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> zcount <span class="free">A</span> <span class="bound">a</span> <span class="main">≤</span> zcount <span class="free">B</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_eq_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> zcount <span class="free">A</span> <span class="free">a</span> <span class="main">≤</span> zcount <span class="free">B</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_eq_add_zmset_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">‹add_zmset <span class="free">a</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> add_zmset <span class="free">a</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_zmset_add_single<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> add_zmset_add_single<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_zmset.add_le_cancel_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_eq_zmultiset_union_diff_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="free">C</span> <span class="main">-</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_diff_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_eq_insertD<span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">x</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subset_zmset_def subseteq_zmset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute add_le_same_cancel2 zcount_add_zmset dual_order.trans le_cases
    le_numeral_extra<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_insertD<span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">x</span> <span class="free">A</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zmset_subset_eq_insertD<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> subset_zmset.less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_eq_diff_conv_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">C</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_zmset_def ordered_ab_group_add_class.diff_le_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> multi_psub_of_add_self_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> add_zmset <span class="free">x</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_zmset_def subseteq_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> multi_psub_self_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">A</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_zmset <span class="free">x</span> <span class="free">N</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> add_zmset <span class="free">x</span> <span class="free">M</span> <span class="main">⟷</span> <span class="free">N</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_zmset_add_single<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> add_zmset_add_single<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> subset_zmset.add_less_cancel_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_subseteq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="free">M</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> zmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">⊆#</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_zmset_def subseteq_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_subset_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="free">M</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> zmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">⊂#</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_zmset_def subset_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  mset_pos_supset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> zmset_of <span class="main">(</span>mset_pos <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  mset_neg_supset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> zmset_of <span class="main">(</span>mset_neg <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zmset_subset_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_mset_zmsetE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zmset_of <span class="free">A</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> zmset_of <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂#</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms decompose_zmset_of2 subset_zmset.add_less_cancel_right zmset_of_subset_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subseteq_mset_zmsetE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zmset_of <span class="free">A</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> zmset_of <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms add.commute add.right_neutral subset_mset.order_refl subset_mset_def
    subset_mset_zmsetE subset_zmset_def zmset_of_empty<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Subset is an Order›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> subset_zmset<span class="main">:</span> order <span class="quoted"><span class="quoted">"<span class="keyword1">(⊆#<span class="hidden">⇩</span><sub>z</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⊂#<span class="hidden">⇩</span><sub>z</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Replicate and Repeat Operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replicate_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replicate_zmset</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>add_zmset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_zmset_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replicate_zmset <span class="main">0</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> replicate_zmset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_zmset_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replicate_zmset <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> add_zmset <span class="free">x</span> <span class="main">(</span>replicate_zmset <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> replicate_zmset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_replicate_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>replicate_zmset <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> of_nat <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> replicate_zmset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">repeat_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">repeat_zmset</span> <span class="main">0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">repeat_zmset</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free">repeat_zmset</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_repeat_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>repeat_zmset <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> of_nat <span class="free">i</span> <span class="main">*</span> zcount <span class="free">A</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_zmset_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">a</span> <span class="main">(</span>repeat_zmset <span class="free">b</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> repeat_zmset <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff left_diff_distrib'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> left_diff_repeat_zmset_distrib'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≥</span> <span class="free">j</span> <span class="main">⟹</span> repeat_zmset <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> repeat_zmset <span class="free">i</span> <span class="free">u</span> <span class="main">-</span> repeat_zmset <span class="free">j</span> <span class="free">u</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff int_distrib<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> of_nat_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> left_add_mult_distrib_zmset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">i</span> <span class="free">u</span> <span class="main">+</span> <span class="main">(</span>repeat_zmset <span class="free">j</span> <span class="free">u</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> repeat_zmset <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">j</span><span class="main">)</span> <span class="free">u</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff add_mult_distrib int_distrib<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_zmset_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"repeat_zmset <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> repeat_zmset <span class="free">m</span> <span class="free">A</span> <span class="main">+</span> repeat_zmset <span class="free">n</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff Nat.add_mult_distrib int_distrib<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_zmset_distrib2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> repeat_zmset <span class="free">n</span> <span class="free">A</span> <span class="main">+</span> repeat_zmset <span class="free">n</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff add_mult_distrib2 int_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_zmset_replicate_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">n</span> <span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> replicate_zmset <span class="free">n</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_zmset_distrib_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">n</span> <span class="main">(</span>add_zmset <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> replicate_zmset <span class="free">n</span> <span class="free">a</span> <span class="main">+</span> repeat_zmset <span class="free">n</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff int_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_zmset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">n</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Filter (with Comprehension Syntax)›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> filter_zmset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span> <span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>filter_mset <span class="bound">P</span> <span class="bound">Mp</span><span class="main">,</span> filter_mset <span class="bound">P</span> <span class="bound">Mn</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_union_mset <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def filter_union_mset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_ZMCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{#</span>_ <span class="keyword1">:#z</span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_ZMCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{#</span>_ <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{#</span><span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span><span class="main">#}</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> filter_zmset <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span> <span class="free">M</span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> count_filter_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>filter_zmset <span class="free">P</span> <span class="free">M</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">a</span> <span class="keyword1">then</span> zcount <span class="free">M</span> <span class="free">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_empty_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter_zmset <span class="free">P</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zmultiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_single_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_zmset <span class="free">P</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="keyword1">else</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zmultiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_union_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter_zmset <span class="free">P</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> filter_zmset <span class="free">P</span> <span class="free">M</span> <span class="main">+</span> filter_zmset <span class="free">P</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zmultiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_diff_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter_zmset <span class="free">P</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> filter_zmset <span class="free">P</span> <span class="free">M</span> <span class="main">-</span> filter_zmset <span class="free">P</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zmultiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter_zmset <span class="free">P</span> <span class="main">(</span>add_zmset <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">x</span> <span class="keyword1">then</span> add_zmset <span class="free">x</span> <span class="main">(</span>filter_zmset <span class="free">P</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">else</span> filter_zmset <span class="free">P</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmultiset_filter_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter_zmset <span class="free">f</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> filter_zmset <span class="free">f</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_filter_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_zmset <span class="free">P</span> <span class="main">(</span>filter_zmset <span class="free">Q</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  filter_zmset_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> True<span class="main">#}</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  filter_zmset_False<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> False<span class="main">#}</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Uncategorized›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multi_drop_mem_not_eq_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">c</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_single_eq_union_zmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmultiset_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> zmultiset_eq_iff<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Image›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">image_zmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">image_zmset</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span>
   zmset_of <span class="main">(</span>fold_mset <span class="main">(</span>add_mset <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">{#}</span> <span class="main">(</span>mset_pos <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
   zmset_of <span class="main">(</span>fold_mset <span class="main">(</span>add_mset <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">{#}</span> <span class="main">(</span>mset_neg <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multiset Order›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_zmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span> <span class="main">(</span><span class="bound">Np</span><span class="main">,</span> <span class="bound">Nn</span><span class="main">)</span><span class="main">.</span> <span class="bound">Mp</span> <span class="main">+</span> <span class="bound">Nn</span> <span class="main">&lt;</span> <span class="bound">Mn</span> <span class="main">+</span> <span class="bound">Np</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A1</span> <span class="skolem">B2</span> <span class="skolem">B1</span> <span class="skolem">A2</span> <span class="skolem">C1</span> <span class="skolem">D2</span> <span class="skolem">D1</span> <span class="skolem">C2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">=</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C1</span> <span class="main">+</span> <span class="skolem">C2</span> <span class="main">=</span> <span class="skolem">D1</span> <span class="main">+</span> <span class="skolem">D2</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">D2</span> <span class="main">&lt;</span> <span class="skolem">B2</span> <span class="main">+</span> <span class="skolem">C1</span> <span class="main">⟷</span> <span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">D2</span> <span class="main">&lt;</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">B2</span> <span class="main">+</span> <span class="skolem">C1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span> <span class="main">+</span> <span class="skolem">D2</span> <span class="main">&lt;</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">B2</span> <span class="main">+</span> <span class="skolem">C1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">D2</span> <span class="main">&lt;</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">C1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">D1</span> <span class="main">+</span> <span class="skolem">D2</span> <span class="main">&lt;</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">C1</span> <span class="main">+</span> <span class="skolem">D1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">C1</span> <span class="main">+</span> <span class="skolem">C2</span> <span class="main">&lt;</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">C1</span> <span class="main">+</span> <span class="skolem">D1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">C2</span> <span class="main">&lt;</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">D1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">D2</span> <span class="main">&lt;</span> <span class="skolem">B2</span> <span class="main">+</span> <span class="skolem">C1</span> <span class="main">⟷</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">C2</span> <span class="main">&lt;</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">D1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_zmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_zmultiset</span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> less_eq_zmultiset_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def union_commute<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A1</span> <span class="skolem">B1</span> <span class="skolem">D</span> <span class="skolem">C</span> <span class="skolem">B2</span> <span class="skolem">A2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">≠</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ab1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">C</span> <span class="main">&lt;</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ab2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">&lt;</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">&lt;</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">B2</span> <span class="main">+</span> <span class="bound">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ab2 add_less_cancel_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">A1</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">D</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">B1</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab1 add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">A1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">D</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc add.commute mset_le_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ab2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">&lt;</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">A1</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">D</span> <span class="main">+</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="bound">m</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab1 add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">A2</span> <span class="main">+</span> <span class="skolem">A1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">D</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ab2 add.assoc add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ab1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ab2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">&lt;</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">&lt;</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> <span class="skolem">A2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> <span class="skolem">B2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ab1 ab2 add.assoc add_less_cancel_left<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ab2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ab ab1 ab2 add.assoc add.commute add_diff_cancel_right'<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">+</span> <span class="skolem">A2</span> <span class="main">&lt;</span> <span class="skolem">B1</span> <span class="main">+</span> <span class="skolem">B2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">ordered_cancel_comm_monoid_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> less_eq_zmultiset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">ordered_ab_group_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">distrib_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">inf_zmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inf_zmultiset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">sup_zmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sup_zmultiset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_lt_iff_ge_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_zmultiset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_zmultiset_def inf_zmultiset_def sup_zmultiset_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> not_lt_iff_ge_zmset<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_less<span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="free">M</span> <span class="main">&lt;</span> zmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zmset_of_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_le<span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_of <span class="free">M</span> <span class="main">≤</span> zmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_zmultiset_def zmset_of_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">ordered_ab_semigroup_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> less_eq_zmultiset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_add_conv_diff_mset<span class="main">[</span><span class="operator">cancelation_simproc_pre</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">-</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span> zmultiset›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_add_add_uminus<span class="main">[</span><span class="operator">cancelation_simproc_pre</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">-</span><span class="free">a</span> <span class="main">+</span> <span class="free">c</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">-</span> <span class="free">a</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span> zmultiset›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_add_conv_diff_mset zmset_subset_eq_zmultiset_union_diff_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zmset_eq_add_NO_MATCH<span class="main">[</span><span class="operator">cancelation_simproc_pre</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‹NO_MATCH <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">H</span> <span class="main">⟹</span> add_zmset <span class="free">a</span> <span class="free">H</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">+</span> <span class="free">H</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> repeat_zmset_iterate_add<span class="main">:</span> <span class="quoted"><span class="quoted">‹repeat_zmset <span class="free">n</span> <span class="free">M</span> <span class="main">=</span> iterate_add <span class="free">n</span> <span class="free">M</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> iterate_add_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> repeat_zmset_iterate_add<span class="main">[</span><span class="operator">cancelation_simproc_pre</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> repeat_zmset_iterate_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">cancelation_simproc_post</span><span class="main">]</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> zmseteq_cancel_numerals
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> add_zmset <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"replicate_zmset <span class="free">p</span> <span class="free">a</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> replicate_zmset <span class="free">p</span> <span class="free">a</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">p</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> repeat_zmset <span class="free">p</span> <span class="free">m</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.eq_cancel</span>›</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subseteq_add_iff1<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span>repeat_zmset <span class="free">i</span> <span class="free">u</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="free">j</span> <span class="free">u</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>repeat_zmset <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="free">u</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_diff_eq left_diff_repeat_zmset_distrib' subset_eq_diff_conv_zmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subseteq_add_iff2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span>repeat_zmset <span class="free">i</span> <span class="free">u</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="free">j</span> <span class="free">u</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="free">u</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> repeat_zmset <span class="free">j</span> <span class="main">(</span><span class="bound">z</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">-</span> repeat_zmset <span class="free">i</span> <span class="bound">z</span> <span class="main">=</span> repeat_zmset <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_repeat_zmset_distrib'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_diff_eq2 subset_eq_diff_conv_zmset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_add_iff1<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span>repeat_zmset <span class="free">i</span> <span class="free">u</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="free">j</span> <span class="free">u</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>repeat_zmset <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="free">u</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_zmset.less_le_not_le zmset_subseteq_add_iff1 zmset_subseteq_add_iff2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_subset_add_iff2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span>repeat_zmset <span class="free">i</span> <span class="free">u</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="free">j</span> <span class="free">u</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="free">u</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_zmset.less_le_not_le zmset_subseteq_add_iff1 zmset_subseteq_add_iff2<span class="main">)</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹zmultiset_simprocs.ML›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> zmsetsubset_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> add_zmset <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"replicate_zmset <span class="free">p</span> <span class="free">a</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> replicate_zmset <span class="free">p</span> <span class="free">a</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">p</span> <span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="free">p</span> <span class="free">m</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">ZMultiset_Simprocs.subset_cancel_zmsets</span>›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> zmsetsubseteq_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> add_zmset <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"replicate_zmset <span class="free">p</span> <span class="free">a</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> replicate_zmset <span class="free">p</span> <span class="free">a</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">p</span> <span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> repeat_zmset <span class="free">p</span> <span class="free">m</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">ZMultiset_Simprocs.subseteq_cancel_zmsets</span>›</span>

<span class="keyword1"><span class="command">instance</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">ordered_ab_semigroup_add_imp_le</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> less_eq_zmultiset_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> zmsetless_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>preorder zmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> add_zmset <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"replicate_zmset <span class="free">p</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> replicate_zmset <span class="free">p</span> <span class="free">a</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">p</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> repeat_zmset <span class="free">p</span> <span class="free">m</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.less_cancel</span>›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> zmsetless_eq_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>preorder zmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> add_zmset <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"replicate_zmset <span class="free">p</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> replicate_zmset <span class="free">p</span> <span class="free">a</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">p</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> repeat_zmset <span class="free">p</span> <span class="free">m</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.less_eq_cancel</span>›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> zmsetdiff_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> zmultiset<span class="main">)</span> <span class="main">-</span> <span class="free">m</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"add_zmset <span class="free">a</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> add_zmset <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"replicate_zmset <span class="free">p</span> <span class="free">r</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> replicate_zmset <span class="free">p</span> <span class="free">r</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"repeat_zmset <span class="free">p</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> repeat_zmset <span class="free">p</span> <span class="free">m</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.diff_cancel</span>›</span>

<span class="keyword1"><span class="command">instance</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linordered_cancel_ab_semigroup_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> less_eq_zmultiset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_mset_zmsetE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zmset_of <span class="free">A</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> zmset_of <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_less_imp_less_right assms decompose_zmset_of2 zmset_of_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_mset_zmsetE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zmset_of <span class="free">A</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> zmset_of <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.right_neutral assms le_neq_trans less_imp_le less_mset_zmsetE order_refl
    zmset_of_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_eq_imp_le_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_mono_thms_linordered_semiring<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_eq_imp_le_multiset
    subseteq_mset_zmsetE zmset_of_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_imp_less_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">⊂#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_neq_trans subset_eq_imp_le_zmset subset_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lt_imp_ex_zcount_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m_lt_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">y</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> zcount <span class="free">M</span> <span class="bound">y</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">y</span> <span class="main">≥</span> zcount <span class="free">N</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">⊇#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_subset_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≥</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_eq_imp_le_zmset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> m_lt_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> zmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">no_top</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span> zmultiset›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted">True</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹zmset_of <span class="main">(</span>mset_pos <span class="skolem">M</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="main">(</span>mset_neg <span class="skolem">M</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">&lt;</span> add_zmset <span class="skolem">a</span> <span class="var">?M</span> <span class="main">+</span> <span class="var">?M</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mset_pos_neg_partition<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_zmset_def subseteq_zmset_def zmultiset_eq_iff
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subset_imp_less_zmset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">&lt;</span> <span class="bound">N</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/zmultiset_simprocs.ML">
<div class="head">
<h1>File ‹zmultiset_simprocs.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       $AFP/Nested_Multisets_Ordinals/zmultiset_simprocs.ML
    Author:      Mathias Fleury &lt;mathias.fleury at mpi-inf.mpg.de&gt;, 2017

Simprocs for zmultisets, based on Larry Paulson's simprocs for natural numbers
and numerals.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">ZMULTISET_SIMPROCS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> subset_cancel_zmsets<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> thm option
  <span class="keyword1"><span class="keyword">val</span></span> subseteq_cancel_zmsets<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> thm option
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">ZMultiset_Simprocs</span> <span class="main">:</span> <span class="entity">ZMULTISET_SIMPROCS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Subset_Cancel_Multiset</span> <span class="main">=</span> <span class="entity">Cancel_Fun</span>
 <span class="main">(</span><span class="keyword3"><span class="keyword">open</span></span> Cancel_Data
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_bal</span>   <span class="main">=</span> <span class="entity">HOLogic.mk_binrel</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> subset_zmset<span class="antiquote">}</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_bal</span> <span class="main">=</span> <span class="entity">HOLogic.dest_bin</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> subset_zmset<span class="antiquote">}</span></span> dummyT
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bal_add1</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> zmset_subset_add_iff1<span class="main">[</span><span class="operator">unfolded</span> repeat_zmset_iterate_add<span class="main">]</span><span class="antiquote">}</span></span></span> RS <span class="entity">trans</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bal_add2</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> zmset_subset_add_iff2<span class="main">[</span><span class="operator">unfolded</span> repeat_zmset_iterate_add<span class="main">]</span><span class="antiquote">}</span></span></span> RS <span class="entity">trans</span>
<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Subseteq_Cancel_Multiset</span> <span class="main">=</span> <span class="entity">Cancel_Fun</span>
 <span class="main">(</span><span class="keyword3"><span class="keyword">open</span></span> Cancel_Data
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_bal</span>   <span class="main">=</span> <span class="entity">HOLogic.mk_binrel</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> subseteq_zmset<span class="antiquote">}</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_bal</span> <span class="main">=</span> <span class="entity">HOLogic.dest_bin</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> subseteq_zmset<span class="antiquote">}</span></span> dummyT
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bal_add1</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> zmset_subseteq_add_iff1<span class="main">[</span><span class="operator">unfolded</span> repeat_zmset_iterate_add<span class="main">]</span><span class="antiquote">}</span></span></span> RS <span class="entity">trans</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bal_add2</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> zmset_subseteq_add_iff2<span class="main">[</span><span class="operator">unfolded</span> repeat_zmset_iterate_add<span class="main">]</span><span class="antiquote">}</span></span></span> RS <span class="entity">trans</span>
<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subset_cancel_zmsets</span> <span class="main">=</span> <span class="entity">Subset_Cancel_Multiset.proc</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subseteq_cancel_zmsets</span> <span class="main">=</span> <span class="entity">Subseteq_Cancel_Multiset.proc</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Nested_Multiset">
<div class="head">
<h1>Theory Nested_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Nested Multisets
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2016
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nested Multisets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Nested_Multiset
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset_Order.html">HOL-Library.Multiset_Order</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> multiset.map_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> multiset.map_cong <span class="main">[</span><span class="operator">cong</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> nmultiset <span class="main">=</span>
  Elem <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="main">|</span> MSet <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset multiset"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">no_elem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟹</span> <span class="free">no_elem</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">no_elem</span> <span class="main">(</span>MSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">sub_nmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> nmultiset <span class="main">×</span> <span class="tfree">'a</span> nmultiset<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> MSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">sub_nmset</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_sub_nmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf sub_nmset"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wfUNIVI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">N</span><span class="main">.</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">M</span><span class="main">)</span> <span class="main">∈</span> sub_nmset <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">N</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">M</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">M</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sub_nmset.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">depth_nmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">|</span>_<span class="keyword1">|</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">|</span></span>Elem <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">|</span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">|</span></span>MSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">|</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> set_mset <span class="main">(</span>image_mset <span class="free">depth_nmset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>Max <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> depth_nmset_MSet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">|</span><span class="free">x</span><span class="main">|</span> <span class="main">&lt;</span> <span class="main">|</span>MSet <span class="free">M</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> depth_nmset.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dershowitz and Manna's Nested Multiset Order›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Dershowitz--Manna extension:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">-</span> <span class="bound">X</span><span class="main">)</span> <span class="main">+</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="bound">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="bound">X</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_imp_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    N_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">N</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="free">R</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> less <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆#</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> N_A M_A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">,</span> <span class="free">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> one_step_implies_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodI mem_Collect_eq mset_subset_eqD mset_subset_eq_add_right
        subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆#</span> <span class="free">N</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.diff_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_imp_less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    N_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">N</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    in_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="free">R</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_mult N_A M_A <span class="keyword1"><span class="command">unfolding</span></span> mult_def less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> add_mset <span class="skolem">y</span> <span class="skolem">M0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">a</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">N</span> <span class="skolem">N'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> N_N'_in_mult1 <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> N'_A <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> M_A <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> N_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">N</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N_N'_in_mult1 N'_A <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_sub_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> N_A M_A<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">Ya</span></span> <span class="keyword2"><span class="keyword">where</span></span> N'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N'</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">Ya</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    z_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Ya</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">y</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N_N'_in_mult1<span class="main">[</span><span class="operator">unfolded</span> mult1_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Za</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Xa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> xa_sub_x_ya<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="var">?Xa</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_subset_eq_self in_diffD subsetI subset_mset.diff_diff_right<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> x_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M_A M_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ya_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Ya</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetI z_gt<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ex_y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">R</span> <span class="skolem">x</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Ya</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y_in count_greater_zero_iff in_diff_count <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> y_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trans y_gt_x x_A ya_A x_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> subsetCE union_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">Ya</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Za</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Xa</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="skolem">N'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_mono_add subset_eq_diff_conv y_sub_N N_eq N'_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_eq_diff_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">N'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_eq N_eq N'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_y' xa_sub_x_ya <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_iff_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    N_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">N</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="free">R</span> <span class="free">M</span> <span class="free">N</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult_imp_less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_imp_mult<span class="main">[</span><span class="operator">OF</span> N_A M_A<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">instantiation</span></span> nmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">preorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">X</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">⊆#</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">X</span><span class="main">)</span> <span class="main">+</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">k</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">S</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟹</span>
  less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="free">R</span> <span class="free">M</span> <span class="free">N</span> <span class="main">=</span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="free">S</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity"><span class="class_parameter">less_nmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset <span class="main">⇒</span> <span class="tfree">'a</span> nmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_nmultiset</span> <span class="main">(</span>Elem <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Elem <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_nmultiset</span> <span class="main">(</span>Elem <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>MSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_nmultiset</span> <span class="main">(</span>MSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">(</span>Elem <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_nmultiset</span> <span class="main">(</span>MSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">(</span>MSet <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">⟷</span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="free">less_nmultiset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"sub_nmset <span class="keyword1">&lt;*lex*&gt;</span> sub_nmset"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> sub_nmset.simps in_lex_prod mset_subset_eqD mset_subset_eq_add_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> less_nmultiset_induct <span class="main">=</span>
  less_nmultiset.induct<span class="main">[</span><span class="operator">case_names</span> Elem_Elem Elem_MSet MSet_Elem MSet_MSet<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> less_nmultiset_cases <span class="main">=</span>
  less_nmultiset.cases<span class="main">[</span><span class="operator">case_names</span> Elem_Elem Elem_MSet MSet_Elem MSet_MSet<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_less_nmultiset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">&lt;</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">&lt;</span> <span class="free">Z</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">&lt;</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="free">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="main">|</span><span class="free">X</span><span class="main">|</span><span class="main">,</span> <span class="main">|</span><span class="free">Y</span><span class="main">|</span><span class="main">,</span> <span class="main">|</span><span class="free">Z</span><span class="main">|</span><span class="main">}</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">Z</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">Y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">Z</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">N</span> <span class="skolem">N'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset multiset"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> set_mset <span class="skolem">M</span> <span class="main">∪</span> set_mset <span class="skolem">N</span> <span class="main">∪</span> set_mset <span class="skolem">N'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> XYZ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> MSet <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> MSet <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> MSet <span class="skolem">N'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> depth_nmset_MSet <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">M</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">N</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">N'</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> XYZ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">&lt;</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_iff_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ trans<span class="main"><span class="main">]</span></span> mult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irrefl_less_nmultiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">&lt;</span> <span class="free">X</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MSet <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MSet<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_nmultiset.simps less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset multiset"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">XY</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XY</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">XY</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="skolem">XY</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans_less_nmultiset
        finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_cartesian_product<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆#</span> <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_subset_eq_exists_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> MSet<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆#</span> <span class="skolem">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="skolem">XY</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> XY_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_subset_eqD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irrefl_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"acyclic <span class="skolem">XY</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> acyclic_irrefl<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> acyclic <span class="skolem">XY</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> finite_acyclic_wf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Y</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_eq_minimal XY_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> antisym_less_nmultiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">&lt;</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">&lt;</span> <span class="free">X</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans_less_nmultiset irrefl_less_nmultiset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_nmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset <span class="main">⇒</span> <span class="tfree">'a</span> nmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_nmultiset</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> less_def refl trans<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_def <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> irrefl_less_nmultiset antisym_less_nmultiset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trans <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trans_less_nmultiset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main">:</span> <span class="quoted"><span class="quoted">"less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">(&lt;)</span> <span class="main">=</span> <span class="main">(&lt;)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>antisym <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trans_less_nmultiset irrefl_less_nmultiset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> total_less_nmultiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">X</span> <span class="main">&lt;</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≠</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">&lt;</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_nmultiset_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MSet_MSet <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nmultiset.inject less_nmultiset.simps less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' count_inI diff_add_zero in_diff_count less_imp_not_less
      mset_subset_eq_multiset_union_diff_commute subset_mset.order.refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> total<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>total <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> total_less_nmultiset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_depth_nmset_imp_less_nmultiset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="main">&lt;</span> <span class="main">|</span><span class="free">Y</span><span class="main">|</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">&lt;</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_nmultiset_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MSet_MSet <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> MSet_MSet <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> depth_nmset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def not_le Max_gr_iff
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">N</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> depth_nmset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> less_nmultiset_imp_le_depth_nmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">&lt;</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="main">≤</span> <span class="main">|</span><span class="free">Y</span><span class="main">|</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_nmultiset_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MSet_MSet <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">&lt;</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bool.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> bool.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False_False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> depth_nmset.simps<span class="main">(</span>2<span class="main">)</span> Let_def False_False Suc_le_mono set_image_mset image_is_empty
      set_mset_eq_empty_iff if_False
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_le_iff<span class="main"><span class="main">]</span></span> ballI iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_ge_iff<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> imageE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈#</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> MSet_MSet<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">N</span></span> <span class="quoted"><span class="skolem">M</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">&lt;</span> <span class="skolem">N</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">∈#</span><span class="skolem">N</span><span class="main">.</span> <span class="main">|</span><span class="skolem">X</span><span class="main">|</span> <span class="main">≤</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ex_gt_imp_less_multiset less_asym' less_depth_nmset_imp_less_nmultiset
          not_le_imp_less<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> depth_nmset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mlex_I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">X</span> <span class="bound">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"antisymp <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="free">R</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">X</span> <span class="skolem">Y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">Y</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="skolem">X</span> <span class="skolem">Y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> mlex_less<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> equal
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="skolem">X</span> <span class="skolem">Y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mlex_leq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> greater
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="skolem">X</span> <span class="skolem">Y</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> greater<span class="main">]</span> <span class="quoted"><span class="quoted">‹antisymp <span class="free">R</span>›</span></span> greater <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> antisymp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">X</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mlex_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nmultiset <span class="main">::</span> <span class="main">(</span><span class="quoted">wellorder</span><span class="main">)</span> <span class="quoted">wellorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> depth_nmset_eq_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> MSet <span class="main">{#}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> Elem <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> depth_nmset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> depth_nmset_eq_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">X</span><span class="main">|</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> MSet <span class="bound">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Y</span> <span class="main">∈#</span> <span class="bound">N</span><span class="main">.</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Y</span> <span class="main">∈#</span> <span class="bound">N</span><span class="main">.</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> depth_nmset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_eqI<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Max_in finite_imageI finite_set_mset imageE image_is_empty
      set_mset_eq_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_less_nmultiset_depth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">X</span> <span class="main">::</span> <span class="tfree">'a</span> nmultiset<span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">|</span><span class="bound">X</span><span class="main">|</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nmultiset set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="main">|</span><span class="bound">X</span><span class="main">|</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">(</span>depth_nmset <span class="main">::</span> <span class="tfree">'a</span> nmultiset <span class="main">⇒</span> nat<span class="main">)</span> <span class="keyword1">&lt;*mlex*&gt;</span>
      <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">|</span><span class="bound">X</span><span class="main">|</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_UN wf_mlex<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>mult <span class="main">{</span><span class="main">(</span><span class="bound">X</span> <span class="main">::</span> <span class="tfree">'a</span> nmultiset<span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> wf_subset<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def mlex_prod_def not_less_iff_gr_or_eq
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_depth_nmset_imp_less_nmultiset<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
        wf_Un<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> wf_map_prod_image<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> wf<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">of</span> <span class="quoted">Elem</span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> wf_UN<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Elem <span class="main">`</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> MSet <span class="main">{#}</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_map_prod_image<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> *<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">MSet</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_prod_def image_iff inj_on_def A_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_imp_mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_less_nmultiset<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">X</span> <span class="main">::</span> <span class="tfree">'a</span> nmultiset<span class="main">,</span> <span class="bound">Y</span> <span class="main">::</span> <span class="tfree">'a</span> nmultiset<span class="main">)</span><span class="main">.</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> depth_nmset <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">|</span><span class="bound">X</span><span class="main">|</span> <span class="main">=</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_mlex_I<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> antisymp_def less_depth_nmset_imp_less_nmultiset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">|</span><span class="bound">X</span><span class="main">|</span> <span class="main">=</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">|</span><span class="bound">X</span><span class="main">|</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">|</span><span class="bound">Y</span><span class="main">|</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mlex wf_Union wf_less_nmultiset_depth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">using</span></span> wf_less_nmultiset <span class="keyword1"><span class="command">unfolding</span></span> wf_def mem_Collect_eq prod.case <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Hereditary_Multiset">
<div class="head">
<h1>Theory Hereditary_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Hereditar(il)y (Finite) Multisets
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Hereditar(il)y (Finite) Multisets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Hereditary_Multiset
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Multiset_More.html">Multiset_More</a> <a href="Nested_Multiset.html">Nested_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> hmultiset <span class="main">=</span>
  HMSet <span class="main">(</span><span class="free"><span class="entity">hmsetmset</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmultiset multiset"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="free">A</span> <span class="main">=</span> hmsetmset <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hmultiset.expand<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">Rep_hmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> unit nmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Rep_hmultiset</span> <span class="main">(</span>HMSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> MSet <span class="main">(</span>image_mset <span class="free">Rep_hmultiset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span> <span class="entity">Abs_hmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit nmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Abs_hmultiset</span> <span class="main">(</span>MSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> HMSet <span class="main">(</span>image_mset <span class="free">Abs_hmultiset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> type_definition_hmultiset<span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition Rep_hmultiset Abs_hmultiset <span class="main">{</span><span class="bound">X</span><span class="main">.</span> no_elem <span class="bound">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"no_elem <span class="main">(</span>Rep_hmultiset <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> no_elem.intros<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_hmultiset <span class="main">(</span>Rep_hmultiset <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit nmultiset"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"no_elem <span class="skolem">Y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Rep_hmultiset <span class="main">(</span>Abs_hmultiset <span class="skolem">Y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> no_elem.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_hmultiset

<span class="keyword1"><span class="command">lemma</span></span> HMSet_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="main">=</span> Abs_hmultiset <span class="keyword1">o</span> MSet <span class="keyword1">o</span> image_mset Rep_hmultiset"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_definition.Rep_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> type_definition_hmultiset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HMSet_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fun <span class="main">(</span>rel_mset pcr_hmultiset<span class="main">)</span> pcr_hmultiset MSet HMSet"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMSet_alt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def multiset.in_rel nmultiset.rel_eq
    pcr_hmultiset_def cr_hmultiset_def
    type_definition.Rep_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> type_definition_hmultiset<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multiset.map_cong<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Restriction of Dershowitz and Manna's Nested Multiset Order›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> hmultiset <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_hmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_hmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_HMSet_iff_less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="free">M</span> <span class="main">&lt;</span> HMSet <span class="free">N</span> <span class="main">⟷</span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="main">(&lt;)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> less_nmultiset.simps less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit nmultiset multiset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mset no_elem <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mset no_elem <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆#</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> Collect <span class="main">(</span>pred_mset no_elem<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> multiset.pred_set mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_subsetD set_mset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> Collect <span class="main">(</span>pred_mset no_elem<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> multiset.pred_set mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' in_diffD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X'</span><span class="main">∈</span>Collect <span class="main">(</span>pred_mset no_elem<span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Y'</span><span class="main">∈</span>Collect <span class="main">(</span>pred_mset no_elem<span class="main">)</span><span class="main">.</span>
      <span class="bound">X'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> filter_mset no_elem <span class="bound">X'</span> <span class="main">⊆#</span> filter_mset no_elem <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">-</span> <span class="bound">X'</span> <span class="main">+</span> <span class="bound">Y'</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>Collect no_elem<span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="bound">Y'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">∈</span>Collect no_elem<span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="bound">X'</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> Collect <span class="main">(</span>pred_mset no_elem<span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> Collect <span class="main">(</span>pred_mset no_elem<span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_mset_diff multiset.pred_set multiset_filter_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit nmultiset multiset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"pred_mset no_elem <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mset no_elem <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mset no_elem <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mset no_elem <span class="skolem">Y</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"filter_mset no_elem <span class="skolem">X</span> <span class="main">⊆#</span> filter_mset no_elem <span class="skolem">N</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>Collect no_elem<span class="main">.</span>  <span class="bound">k</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">∈</span>Collect no_elem<span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset no_elem <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"filter_mset no_elem <span class="skolem">N</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_mset_eq_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset.pred_set<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X'</span> <span class="bound">Y'</span><span class="main">.</span> <span class="bound">X'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="bound">X'</span> <span class="main">⊆#</span> <span class="skolem">N</span> <span class="main">∧</span>  <span class="skolem">N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">-</span> <span class="bound">X'</span> <span class="main">+</span> <span class="bound">Y'</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="bound">Y'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="bound">X'</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="free">M</span> <span class="main">&lt;</span> hmsetmset <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">N</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less less_HMSet_iff_less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="free">M</span> <span class="main">≤</span> hmsetmset <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_less hmsetmset_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmultiset.collapse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_less_hmultiset<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">X</span> <span class="main">::</span> hmultiset<span class="main">,</span> <span class="bound">Y</span> <span class="main">::</span> hmultiset<span class="main">)</span><span class="main">.</span> <span class="bound">X</span> <span class="main">&lt;</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_eq_minimal <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">insert</span> wf_less_nmultiset<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_eq_minimal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">wellorder</span>
  <span class="keyword1"><span class="command">using</span></span> wf_less_hmultiset <span class="keyword1"><span class="command">unfolding</span></span> wf_def mem_Collect_eq prod.case <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> HMSet_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="free">M</span> <span class="main">&lt;</span> HMSet <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_HMSet_iff_less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HMSet_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="free">M</span> <span class="main">≤</span> HMSet <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hmsetmset_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_imp_less_HMSet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈#</span> <span class="free">L</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> HMSet <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ex_gt_imp_less_multiset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_hmsetmset_imp_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈#</span> hmsetmset <span class="free">N</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mem_imp_less_HMSet <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Disjoint Union and Truncated Difference›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> hmultiset <span class="main">::</span> <span class="quoted">cancel_comm_monoid_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">zero_hmultiset</span></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> HMSet <span class="main">{#}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="free">n</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> zero_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="main">0</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span>
  HMSet_eq_0_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="free">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  zero_eq_HMSet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> HMSet <span class="free">m</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">plus_hmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> HMSet <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> hmsetmset <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">minus_hmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> HMSet <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> hmsetmset <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def plus_hmultiset_def minus_hmultiset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMSet_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> HMSet <span class="free">A</span> <span class="main">+</span> HMSet <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HMSet_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> HMSet <span class="free">A</span> <span class="main">-</span> HMSet <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> hmsetmset <span class="free">M</span> <span class="main">+</span> hmsetmset <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> hmsetmset <span class="free">M</span> <span class="main">-</span> hmsetmset <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_diff_add_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">-</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> diff_diff_add<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">comm_monoid_diff</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def minus_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> hmseteq_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.eq_cancel</span>›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> hmsetdiff_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.diff_cancel</span>›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> hmsetless_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.less_cancel</span>›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> hmsetless_eq_cancel
  <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">::</span>hmultiset<span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">=</span>
  <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="entity">Cancel_Simprocs.less_eq_cancel</span>›</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">ordered_cancel_comm_monoid_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> hmsetmset_less <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_hmultiset_def order_le_less
    hmsetmset_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">ordered_ab_semigroup_add_imp_le</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_hmultiset_def order_le_less less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> hmultiset <span class="main">::</span> <span class="quoted">order_bot</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">bot_hmultiset</span></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bot_hmultiset</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> bot_hmultiset_def zero_hmultiset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> bot_least<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bot_least <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> no_elem.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_nmultiset_def less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">no_top</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> gt_ex<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gt_ex <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">a</span> <span class="main">+</span> HMSet <span class="main">{#</span><span class="main">0</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> le_minus_plus_same_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hmultiset.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> hmultiset.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>HMSet_HMSet <span class="skolem">m0</span> <span class="skolem">n0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> m <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> n <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n0</span> <span class="main">⊆#</span> <span class="skolem">m0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m0</span> <span class="main">=</span> <span class="skolem">m0</span> <span class="main">-</span> <span class="skolem">n0</span> <span class="main">+</span> <span class="skolem">n0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n0</span> <span class="main">⊆#</span> <span class="skolem">m0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m0</span> <span class="main">⊂#</span> <span class="skolem">m0</span> <span class="main">-</span> <span class="skolem">n0</span> <span class="main">+</span> <span class="skolem">n0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_subset_eq_add_right subset_eq_diff_conv subset_mset.dual_order.refl
        subset_mset_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m0</span> <span class="main">&lt;</span> <span class="skolem">m0</span> <span class="main">-</span> <span class="skolem">n0</span> <span class="main">+</span> <span class="skolem">n0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_imp_less_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m n order_le_less plus_hmultiset_def minus_hmultiset_def<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infimum and Supremum›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> hmultiset <span class="main">::</span> <span class="quoted">distrib_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">inf_hmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inf_hmultiset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">sup_hmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sup_hmultiset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inf_hmultiset_def sup_hmultiset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inequalities›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_le_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_le_less<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> hmsetmset_less le_multiset_empty_left hmsetmset_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  le_add1_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_add2_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_zero_eq_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_order.antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_less_zero_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">using</span></span> not_le zero_le_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> not_gr_zero_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">using</span></span> neqE not_less_zero_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_less_iff_neq_zero_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">using</span></span> not_gr_zero_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_less_HMSet_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> HMSet <span class="free">M</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zero_less_iff_neq_zero_hmset HMSet_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gr_zeroI_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">using</span></span> not_gr_zero_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> gr_implies_not_zero_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_eq_0_iff_both_eq_0_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> <span class="free">N</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_nonneg_eq_0_iff zero_le_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_less_add1_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_increasing2 leD le_less not_gr_zero_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_less_add2_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">+</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute trans_less_add1_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_le_add1_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_le_add2_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">+</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_le_self_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.right_neutral diff_add_zero diff_diff_add_hmset
    le_minus_plus_same_hmset<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Signed_Hereditary_Multiset">
<div class="head">
<h1>Theory Signed_Hereditary_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Signed Hereditar(il)y (Finite) Multisets
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Signed Hereditar(il)y (Finite) Multisets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Signed_Hereditary_Multiset
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Signed_Multiset.html">Signed_Multiset</a> <a href="Hereditary_Multiset.html">Hereditary_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> zhmultiset <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> hmultiset zmultiset set"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> zhmsetmset ZHMSet
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> ZHMSet_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> ZHMSet_inverse<span class="main">[</span><span class="operator">OF</span> UNIV_I<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> ZHMSet_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> ZHMSet_inject<span class="main">[</span><span class="operator">OF</span> UNIV_I UNIV_I<span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span>
  zhmsetmset_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  zhmsetmset_inject <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_zhmultiset


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multiset Order›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> zhmultiset <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_zhmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_zhmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ZHMSet_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> less_zhmultiset.abs_eq
<span class="keyword1"><span class="command">lemmas</span></span> ZHMSet_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> less_eq_zhmultiset.abs_eq
<span class="keyword1"><span class="command">lemmas</span></span> zhmsetmset_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> less_zhmultiset.rep_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> zhmsetmset_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> less_eq_zhmultiset.rep_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding and Projections of Syntactic Ordinals›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">zhmset_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zhmset_of</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> ZHMSet <span class="main">(</span>zmset_of <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="free">M</span> <span class="main">=</span> zhmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_less<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="free">M</span> <span class="main">&lt;</span> zhmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_le<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="free">M</span> <span class="main">≤</span> zhmset_of <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_le<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hmset_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hmset_pos</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> HMSet <span class="main">(</span>mset_pos <span class="main">(</span>zhmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hmset_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hmset_neg</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> HMSet <span class="main">(</span>mset_neg <span class="main">(</span>zhmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Disjoint Union and Difference›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> zhmultiset <span class="main">::</span> <span class="quoted">cancel_comm_monoid_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_zhmultiset</span> <span class="main">::</span> <span class="quoted">zhmultiset</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_zhmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">+</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_zhmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">-</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ZHMSet_plus <span class="main">=</span> plus_zhmultiset.abs_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> ZHMSet_diff <span class="main">=</span> minus_zhmultiset.abs_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> zhmsetmset_plus <span class="main">=</span> plus_zhmultiset.rep_eq
<span class="keyword1"><span class="command">lemmas</span></span> zhmsetmset_diff <span class="main">=</span> minus_zhmultiset.rep_eq

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> zhmset_of <span class="free">A</span> <span class="main">+</span> zhmset_of <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hmsetmset_plus ZHMSet_plus zmset_of_plus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="main">0</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hmultiset.inject<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult.assoc add.commute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_0<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_zhmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_pos_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmset_pos <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>hmset_pos <span class="free">A</span> <span class="main">-</span> hmset_neg <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>hmset_pos <span class="free">B</span> <span class="main">-</span> hmset_neg <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HMSet_diff HMSet_plus zhmsetmset_plus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_neg_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmset_neg <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>hmset_neg <span class="free">A</span> <span class="main">-</span> hmset_pos <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>hmset_neg <span class="free">B</span> <span class="main">-</span> hmset_pos <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HMSet_diff HMSet_plus zhmsetmset_plus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_pos_neg_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zhmset_of <span class="main">(</span>hmset_pos <span class="free">M</span><span class="main">)</span> <span class="main">-</span> zhmset_of <span class="main">(</span>hmset_neg <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ZHMSet_diff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mset_pos_neg_partition<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_pos_as_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span>hmset_pos <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zhmset_of <span class="main">(</span>hmset_neg <span class="free">M</span><span class="main">)</span> <span class="main">+</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mset_pos_as_neg zhmsetmset_plus zhmsetmset_inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_neg_as_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span>hmset_neg <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zhmset_of <span class="main">(</span>hmset_pos <span class="free">M</span><span class="main">)</span> <span class="main">-</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zhmsetmset_diff mset_neg_as_pos zhmsetmset_inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_pos_neg_dual<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmset_pos <span class="free">a</span> <span class="main">+</span> hmset_pos <span class="free">b</span> <span class="main">+</span> <span class="main">(</span>hmset_neg <span class="free">a</span> <span class="main">-</span> hmset_pos <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>hmset_neg <span class="free">b</span> <span class="main">-</span> hmset_pos <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
   hmset_neg <span class="free">a</span> <span class="main">+</span> hmset_neg <span class="free">b</span> <span class="main">+</span> <span class="main">(</span>hmset_pos <span class="free">a</span> <span class="main">-</span> hmset_neg <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>hmset_pos <span class="free">b</span> <span class="main">-</span> hmset_neg <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HMSet_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> HMSet_diff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> mset_pos_neg_dual<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_sum_list<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span>sum_list <span class="free">Ms</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map zhmset_of <span class="free">Ms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Ms</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_zhmultiset_def zhmset_of_plus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_hmset_zhmsetE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m_lt_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zhmset_of <span class="free">A</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> zhmset_of <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_mset_zmsetE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_lt_n<span class="main"><span class="main">[</span></span><span class="operator">folded</span> zhmsetmset_less<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> hmsetmset_less hmultiset.sel ZHMSet_plus zhmsetmset_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_hmset_zhmsetE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> zhmset_of <span class="free">A</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> zhmset_of <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_eq_mset_zmsetE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_le_n<span class="main"><span class="main">[</span></span><span class="operator">folded</span> zhmsetmset_le<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> hmsetmset_le hmultiset.sel ZHMSet_plus zhmsetmset_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> zhmultiset <span class="main">::</span> <span class="quoted">ab_group_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_zhmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">-</span> <span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ZHMSet_uminus <span class="main">=</span> uminus_zhmultiset.abs_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> zhmsetmset_uminus <span class="main">=</span> uminus_zhmultiset.rep_eq

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infimum and Supremum›</span></span>

<span class="keyword1"><span class="command">instance</span></span> zhmultiset <span class="main">::</span> <span class="quoted">ordered_cancel_comm_monoid_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_left_mono<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> zhmultiset <span class="main">::</span> <span class="quoted">ordered_ab_group_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> zhmultiset <span class="main">::</span> <span class="quoted">distrib_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">inf_zhmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inf_zhmultiset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">sup_zhmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sup_zhmultiset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inf_zhmultiset_def sup_zhmultiset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Syntactic_Ordinal">
<div class="head">
<h1>Theory Syntactic_Ordinal</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Syntactic Ordinals in Cantor Normal Form
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Mathias Fleury &lt;mfleury at mpi-inf.mpg.de&gt;, 2016
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Ordinals in Cantor Normal Form›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Syntactic_Ordinal
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Hereditary_Multiset.html">Hereditary_Multiset</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Product_Order.html">HOL-Library.Product_Order</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Extended_Nat.html">HOL-Library.Extended_Nat</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Natural (Hessenberg) Product›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> hmultiset <span class="main">::</span> <span class="quoted">comm_semiring_1</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ω_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ω^</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ω^</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">m</span><span class="main">.</span> HMSet <span class="main">{#</span><span class="bound">m</span><span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">one_hmultiset</span></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="keyword1">ω^</span><span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ω</span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ω</span> <span class="main">≡</span> <span class="keyword1">ω^</span><span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">times_hmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset <span class="main">⇒</span> hmultiset"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> HMSet <span class="main">(</span>image_mset <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span> <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×#</span> hmsetmset <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hmsetmset_times<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmsetmset <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> image_mset <span class="main">(</span>case_prod <span class="main">(+)</span><span class="main">)</span> <span class="main">(</span>hmsetmset <span class="free">m</span> <span class="main">×#</span> hmsetmset <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> times_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> assoc comm one distrib_plus zeroL zeroR zero_one<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assoc <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_hmultiset_def Times_mset_image_mset1 Times_mset_image_mset2
      Times_mset_assoc <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiset.map_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comm <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> times_hmultiset_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> product_swap_mset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiset.map_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>one <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_hmultiset_def times_hmultiset_def Times_mset_single_left<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>distrib_plus <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_hmultiset_def times_hmultiset_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>zeroL <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_hmultiset_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>zeroR <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_hmultiset_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> zero_one
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_hmultiset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_times_left_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMSet <span class="main">{#}</span> <span class="main">*</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_times_right_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">*</span> HMSet <span class="main">{#}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_zero_right zero_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_times_left_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ω^</span><span class="free">M</span> <span class="main">*</span> <span class="free">N</span> <span class="main">=</span> HMSet <span class="main">(</span>image_mset <span class="main">(</span><span class="main">(+)</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>hmsetmset <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_hmultiset_def Times_mset_single_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_times_right_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">*</span> <span class="keyword1">ω^</span><span class="free">M</span> <span class="main">=</span> HMSet <span class="main">(</span>image_mset <span class="main">(</span><span class="main">(+)</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>hmsetmset <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute singleton_times_left_hmset<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inequalities›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">plus_nmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit nmultiset <span class="main">⇒</span> unit nmultiset <span class="main">⇒</span> unit nmultiset"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_nmultiset</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> Rep_hmultiset <span class="main">(</span>Abs_hmultiset <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">+</span> Abs_hmultiset <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_nmultiset_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">X'</span><span class="main">,</span> <span class="free">Y'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> no_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"no_elem <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"no_elem <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"no_elem <span class="free">X'</span>"</span></span> <span class="quoted"><span class="quoted">"no_elem <span class="free">Y'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plus_nmultiset <span class="free">X</span> <span class="free">Y</span> <span class="main">&lt;</span> plus_nmultiset <span class="free">X'</span> <span class="free">Y'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less<span class="main">[</span><span class="operator">unfolded</span> less_le_not_le<span class="main">]</span> no_elem
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_nmultiset_def plus_hmultiset_def less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less less_eq_nmultiset_def
          union_less_mono type_definition.Abs_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> type_definition_hmultiset<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> no_elem.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_hmultiset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun pcr_hmultiset <span class="main">(</span>rel_fun pcr_hmultiset pcr_hmultiset<span class="main">)</span><span class="main">)</span> plus_nmultiset <span class="main">(+)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def plus_nmultiset_def pcr_hmultiset_def nmultiset.rel_eq eq_OO cr_hmultiset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_definition.Rep_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> type_definition_hmultiset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Times_mset_monoL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Z_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">×#</span> <span class="free">Z</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">×#</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    Y_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y_sub_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less<span class="main">[</span><span class="operator">unfolded</span> less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">×#</span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">×#</span> <span class="free">Z</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">×#</span> <span class="free">Z</span> <span class="main">=</span> <span class="free">N</span> <span class="main">×#</span> <span class="free">Z</span> <span class="main">-</span> <span class="var">?Y</span> <span class="main">+</span> <span class="var">?X</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sigma_mset_Diff_distrib1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="skolem">y</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_Y <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="var">?X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?Y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="var">?X</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?Y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> snd <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le_not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Z_nemp Y_nemp Y_sub_N Sigma_mset_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> times_hmultiset_monoL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">*</span> <span class="free">c</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">*</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst_thin</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">unfold</span> times_hmultiset_def zero_hmultiset_def hmultiset.sel<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less multiset.pred_set
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_mset_strict_mono Times_mset_monoL <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> plus_nmultiset_mono<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">linordered_semiring_strict</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> mult.commute<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fact</span> times_hmultiset_monoL<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_mono1_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">*</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_right_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_mono2_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">*</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_mono_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">*</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">*</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_iff_add1_le_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hmultiset.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> hmultiset.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>HMSet_HMSet <span class="skolem">m0</span> <span class="skolem">n0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> m <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> n <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m n one_hmultiset_def plus_hmultiset_def order.order_iff_strict
      less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> m0_lt_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m0</span> <span class="main">&lt;</span> <span class="skolem">n0</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span>
      m0_ne_n0 <span class="main">=</span> m0_lt_n0<span class="main">[</span><span class="operator">unfolded</span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub><span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
      ex_n0_gt_m0 <span class="main">=</span> m0_lt_n0<span class="main">[</span><span class="operator">unfolded</span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub><span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> zero_m0_gt_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="main">0</span> <span class="skolem">m0</span> <span class="main">&gt;</span> <span class="skolem">n0</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span>
        n0_ne_0m0 <span class="main">=</span> zero_m0_gt_n0<span class="main">[</span><span class="operator">unfolded</span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub><span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
        ex_0m0_gt_n0 <span class="main">=</span> zero_m0_gt_n0<span class="main">[</span><span class="operator">unfolded</span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub><span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> m0y_lt_n0y<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">m0</span> <span class="skolem">y</span> <span class="main">&lt;</span> count <span class="skolem">n0</span> <span class="skolem">y</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span> <span class="main">&gt;</span> <span class="skolem">y</span><span class="main">.</span> count <span class="skolem">n0</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="skolem">m0</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>add_mset <span class="main">0</span> <span class="skolem">m0</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&lt;</span> count <span class="skolem">n0</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            aa_gt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            count_n0aa_lt_count_0m0aa<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">n0</span> <span class="skolem">aa</span> <span class="main">&lt;</span> count <span class="main">(</span>add_mset <span class="main">0</span> <span class="skolem">m0</span><span class="main">)</span> <span class="skolem">aa</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ex_0m0_gt_n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gr_implies_not_zero_hmset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> aa_gt_y<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>add_mset <span class="main">0</span> <span class="skolem">m0</span><span class="main">)</span> <span class="skolem">aa</span> <span class="main">=</span> count <span class="skolem">m0</span> <span class="skolem">aa</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> count_n0aa_lt_count_0m0aa aa_gt_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> not_0m0_y_lt_n0y<span class="main">:</span> False
          <span class="keyword1"><span class="command">hence</span></span> y_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_add_mset m0y_lt_n0y<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> sm0y_eq_n0y<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>count <span class="skolem">m0</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> count <span class="skolem">n0</span> <span class="skolem">y</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> m0y_lt_n0y not_0m0_y_lt_n0y count_add_mset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> y_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bb</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">n0</span> <span class="skolem">bb</span> <span class="main">&lt;</span> count <span class="main">(</span>add_mset <span class="main">0</span> <span class="skolem">m0</span><span class="main">)</span> <span class="skolem">bb</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lt_imp_ex_count_lt<span class="main">[</span><span class="operator">OF</span> zero_m0_gt_n0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> n0bb_lt_m0bb<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">n0</span> <span class="skolem">bb</span> <span class="main">&lt;</span> count <span class="skolem">m0</span> <span class="skolem">bb</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> count_add_mset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> less_irrefl_nat sm0y_eq_n0y y_eq_0<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bb</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> sm0y_eq_n0y y_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> y_eq_0 <span class="keyword1"><span class="command">using</span></span> n0bb_lt_m0bb not_gr_zero_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n0</span> <span class="main">&lt;</span> <span class="skolem">m0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> <span class="keyword1"><span class="command">using</span></span> m0_ne_n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> m0_lt_n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="main">0</span> <span class="skolem">m0</span> <span class="main">&lt;</span> <span class="skolem">n0</span> <span class="main">∨</span> add_mset <span class="main">0</span> <span class="skolem">m0</span> <span class="main">=</span> <span class="skolem">n0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> antisym_conv3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="main">0</span> <span class="skolem">m0</span> <span class="main">&lt;</span> <span class="skolem">n0</span> <span class="main">∨</span> add_mset <span class="main">0</span> <span class="skolem">m0</span> <span class="main">=</span> <span class="skolem">n0</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m0</span> <span class="main">&lt;</span> <span class="skolem">n0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans le_multiset_right_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_less_iff_1_le_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_iff_add1_le_hmset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_add_1_iff_le_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_iff_add1_le_hmset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">ordered_cancel_comm_semiring</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_le_mono2_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">zero_less_one</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_iff_neq_zero_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">linordered_semiring_1_strict</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">bounded_lattice_bot</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">linordered_nonzero_semiring</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">semiring_no_zero_divisors</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">use</span> mult_pos_pos not_gr_zero_hmset <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lt_1_iff_eq_0_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_iff_add1_le_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_less_mult_iff_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">using</span></span> mult_eq_0_iff not_gr_zero_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> one_le_mult_iff_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lt_1_iff_eq_0_hmset mult_eq_0_iff not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_less_cancel2_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> <span class="free">k</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr_zeroI_hmset leD leI le_cases mult_right_mono mult_zero_right times_hmultiset_monoL<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_less_cancel1_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">*</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_cancel1_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟶</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_not_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_cancel2_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">*</span> <span class="free">k</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟶</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_not_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_cancel_left1_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_less_iff_1_le_hmset mult.commute mult.left_neutral mult_le_cancel2_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_cancel_left2_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute mult.left_neutral mult_le_cancel2_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_cancel_right1_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">*</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult.commute<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> mult_le_cancel_left1_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_le_cancel_right2_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">*</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult.commute<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> mult_le_cancel_left2_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_square_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">using</span></span> mult_le_cancel_left1_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> le_cube_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">using</span></span> mult_le_cancel_left1_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span>
  less_imp_minus_plus_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">-</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_imp_minus_plus_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_less_cancel_left leD le_minus_plus_same_hmset less_le_trans not_le_imp_less<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_0_lt_mult_gt_1_hmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.right_neutral mult_less_cancel1_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">linordered_comm_semiring_strict</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding of Natural Numbers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">=</span> HMSet <span class="main">(</span>replicate_mset <span class="free">n</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def one_hmultiset_def plus_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_inject_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="free">m</span> <span class="main">::</span> hmultiset<span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> of_nat_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_minus_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>of_nat <span class="free">m</span> <span class="main">::</span> hmultiset<span class="main">)</span> <span class="main">-</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> of_nat_hmset minus_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_of_nat_plus_of_nat_hmset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> of_nat <span class="free">m</span> <span class="main">+</span> of_nat <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_of_nat_minus_of_nat_hmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> of_nat <span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_commute add_diff_cancel_left' le_add_diff_inverse of_nat_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_lt_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">&lt;</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_nat_hmset zero_less_iff_neq_zero_hmset less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_ne_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">≠</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_less_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="free">M</span> <span class="main">::</span> hmultiset<span class="main">)</span> <span class="main">&lt;</span> of_nat <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> of_nat_hmset less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_le_hmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="free">M</span> <span class="main">::</span> hmultiset<span class="main">)</span> <span class="main">≤</span> of_nat <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> of_nat_hmset order_le_less less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_times_ω_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">*</span> <span class="keyword1">ω^</span><span class="free">m</span> <span class="main">=</span> HMSet <span class="main">(</span>replicate_mset <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hmsetmset_plus one_hmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ω_exp_times_of_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ω^</span><span class="free">m</span> <span class="main">*</span> of_nat <span class="free">n</span> <span class="main">=</span> HMSet <span class="main">(</span>replicate_mset <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_times_ω_exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding of Extended Natural Numbers›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="entity">hmset_of_enat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="quoted">"enat <span class="main"><span class="main">⇒</span></span> hmultiset"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">hmset_of_enat</span></span> <span class="main"><span class="main">(</span></span>enat <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">n</span></span></span></span></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> of_nat <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">n</span></span></span></span></span></span>"</span></span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">hmset_of_enat</span></span> <span class="main"><span class="main">∞</span></span> <span class="main"><span class="main">=</span></span> ω"</span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_eq_enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">=</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_enat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_le_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="free">n</span> <span class="main">≤</span> ω"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_lt_ω<span class="main">[</span><span class="operator">THEN</span> less_imp_le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_eq_ω_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="free">n</span> <span class="main">=</span> ω <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Head Omega›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">head_ω</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">head_ω</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">ω^</span><span class="main">(</span>Max <span class="main">(</span>set_mset <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="main">(</span>head_ω <span class="free">M</span><span class="main">)</span> <span class="main">⊆#</span> hmsetmset <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> head_ω_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_eq_0_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="free">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> head_ω_def zero_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> head_ω_def one_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> head_ω_def one_hmultiset_def of_nat_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> head_ω_of_nat of_nat_numeral zero_neq_numeral<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω ω <span class="main">=</span> ω"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> head_ω_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> le_imp_head_ω_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"head_ω <span class="free">m</span> <span class="main">≤</span> head_ω <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> le_in_le_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">M</span> <span class="main">≤</span> <span class="bound">N</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≤</span> Max <span class="main">(</span>set_mset <span class="bound">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Max_ge finite_set_mset le_less less_eq_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> linorder_not_less
      mem_Collect_eq neq0_conv order_trans set_mset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> m_le_n <span class="keyword1"><span class="command">unfolding</span></span> head_ω_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> hmsetmset_le <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> head_ω_def hmsetmset_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zero_hmultiset_def<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> Max_in dual_order.antisym finite_set_mset le_in_le_max le_less set_mset_eq_empty_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_lt_imp_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="free">m</span> <span class="main">&lt;</span> head_ω <span class="free">n</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> head_ω_def hmsetmset_less<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> all_lt_Max_imp_lt_mset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span>head_ω <span class="free">m</span><span class="main">)</span> <span class="main">(</span>head_ω <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hmultiset.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> hmultiset.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> m_n<span class="main">:</span> <span class="main">(</span>HMSet_HMSet <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Max_mset <span class="skolem">M</span> <span class="main">&lt;</span> Max_mset <span class="skolem">N</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_n head_ω_def sup_hmultiset_def zero_hmultiset_def plus_hmultiset_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max.union max_def dual_order.strict_implies_order<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_n head_ω_def sup_hmultiset_def zero_hmultiset_def plus_hmultiset_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> False Max.union finite_set_mset leI max_def set_mset_eq_empty_iff sup.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> head_ω_times<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> head_ω <span class="free">m</span> <span class="main">*</span> head_ω <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> m_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> hmsetmset <span class="free">m</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ε</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">=</span> hmsetmset <span class="free">n</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> δ_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> δ_def <span class="keyword1"><span class="command">using</span></span> m_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ε_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ε_def <span class="keyword1"><span class="command">using</span></span> n_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">δ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">ε</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?DE</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?D</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="var">?E</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> max_D_in<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?D</span> <span class="main">∈</span> <span class="var">?D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> δ_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> max_E_in<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?E</span> <span class="main">∈</span> <span class="var">?E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ε_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?DE</span> <span class="main">=</span> Max <span class="var">?D</span> <span class="main">+</span> Max <span class="var">?E</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order_antisym<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> le ge<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> le
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?D</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?E</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">≤</span> Max <span class="var">?D</span> <span class="main">+</span> Max <span class="var">?E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> mem_imp_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="var">?DE</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">≤</span> Max <span class="var">?D</span> <span class="main">+</span> Max <span class="var">?E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mem_imp_le Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> δ_nemp ε_nemp <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ge
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>Max <span class="var">?D</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span>Max <span class="var">?E</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">ε</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> max_D_in max_E_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> δ_def ε_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> head_ω_def image_def times_hmultiset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More Inequalities and Some Equalities›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lt_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_lt_ω of_nat_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_lt_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_defs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hmset_of_enat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hmset_of_enat_1 of_nat_lt_ω<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> numeral_lt_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span> <span class="main">&lt;</span> ω"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hmset_of_enat_numeral<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> hmset_of_enat.simps<span class="main">(</span>1<span class="main">)</span> of_nat_lt_ω numeral_eq_enat
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> one_le_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_le_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">≤</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> numeral_le_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span> <span class="main">≤</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω_lt_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω_lt_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω <span class="main">&lt;</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω_lt_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω <span class="main">&lt;</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω_le_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω_le_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω <span class="main">≤</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω_le_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω <span class="main">≤</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_ne_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_ω_le_1 zero_le_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_ne_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≠</span> ω"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_ω_le_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> numeral_ne_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span> <span class="main">≠</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_ω_le_numeral numeral_le_ω<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  ω_ne_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ω_ne_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ω_ne_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω <span class="main">≠</span> of_nat <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ω_ne_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω <span class="main">≠</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_ne_ω one_ne_ω of_nat_ne_ω numeral_ne_ω <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  hmset_of_enat_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="free">m</span> <span class="main">=</span> hmset_of_enat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hmset_of_enat_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="free">m</span> <span class="main">&lt;</span> hmset_of_enat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  hmset_of_enat_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="free">m</span> <span class="main">≤</span> hmset_of_enat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lt_ω_imp_ex_of_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M_lt_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> ω"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> of_nat <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> M_lt_single_1<span class="main">:</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="free">M</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="main">1</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M_lt_ω<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> hmsetmset_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less hmultiset.sel<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈#</span> hmsetmset <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">N</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="main">(</span>hmsetmset <span class="free">M</span><span class="main">)</span> <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> M_lt_single_1 count_single gr_implies_not0 less_eq_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> less_one
        neq_iff not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lt_1_iff_eq_0_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> hmmM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> HMSet <span class="main">(</span>replicate_mset <span class="skolem">n</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_replicate_mset_if_all_elems_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmultiset.collapse<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hmmM of_nat_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_ω_imp_ex_hmset_of_enat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M_le_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> ω"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> hmset_of_enat <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> ω"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmset_of_enat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> M_le_ω lt_ω_imp_ex_of_nat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmset_of_enat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lt_ω_lt_ω_imp_times_lt_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> ω <span class="main">⟹</span> <span class="free">N</span> <span class="main">&lt;</span> ω <span class="main">⟹</span> <span class="free">M</span> <span class="main">*</span> <span class="free">N</span> <span class="main">&lt;</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lt_ω_imp_ex_of_nat of_nat_lt_ω of_nat_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> times_ω_minus_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> ω <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Diff_triv_mset <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_hmultiset_def minus_hmultiset_def
    Times_mset_single_right of_nat_hmset disjunct_not_in image_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> times_ω_minus_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> ω <span class="main">-</span> numeral <span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_numeral times_ω_minus_of_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ω_minus_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">=</span> ω"</span></span>
  <span class="keyword1"><span class="command">using</span></span> times_ω_minus_of_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.left_neutral<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ω_minus_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> ω"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ω_minus_of_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ω_minus_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω <span class="main">-</span> numeral <span class="free">n</span> <span class="main">=</span> ω"</span></span>
  <span class="keyword1"><span class="command">using</span></span> times_ω_minus_numeral<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.left_neutral<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_minus_enat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="main">(</span><span class="free">m</span> <span class="main">-</span> enat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> hmset_of_enat <span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_nat_minus_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_lt_hmset_of_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">m</span> <span class="main">&lt;</span> hmset_of_enat <span class="free">n</span> <span class="main">⟷</span> enat <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmset_of_enat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hmset_of_enat_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_le_hmset_of_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">m</span> <span class="main">≤</span> hmset_of_enat <span class="free">n</span> <span class="main">⟷</span> enat <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmset_of_enat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hmset_of_enat_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_of_enat_lt_iff_ne_infinity<span class="main">:</span> <span class="quoted"><span class="quoted">"hmset_of_enat <span class="free">x</span> <span class="main">&lt;</span> ω <span class="main">⟷</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_diff_sym_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">unfolding</span></span> minus_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> multiset_inter_def subset_mset.inf_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_plus_sym_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span> <span class="bound">ha</span> <span class="main">::</span> hmultiset<span class="main">.</span> <span class="bound">h</span> <span class="main">-</span> <span class="main">(</span><span class="bound">ha</span> <span class="main">+</span> <span class="bound">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span> <span class="bound">ha</span> <span class="bound">hb</span> <span class="main">::</span> hmultiset<span class="main">.</span> <span class="bound">h</span> <span class="main">+</span> <span class="bound">ha</span> <span class="main">-</span> <span class="main">(</span><span class="bound">h</span> <span class="main">-</span> <span class="bound">hb</span><span class="main">)</span> <span class="main">=</span> <span class="bound">hb</span> <span class="main">+</span> <span class="bound">ha</span> <span class="main">-</span> <span class="main">(</span><span class="bound">hb</span> <span class="main">-</span> <span class="bound">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_diff_cancel_right minus_diff_sym_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span> <span class="bound">ha</span> <span class="bound">hb</span> <span class="main">::</span> hmultiset<span class="main">.</span> <span class="bound">h</span> <span class="main">+</span> <span class="main">(</span><span class="bound">ha</span> <span class="main">+</span> <span class="bound">hb</span><span class="main">)</span> <span class="main">-</span> <span class="bound">hb</span> <span class="main">=</span> <span class="bound">h</span> <span class="main">+</span> <span class="bound">ha</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.assoc add_diff_cancel_right'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute add.right_neutral diff_diff_add_hmset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> times_diff_plus_sym_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="main">*</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_left diff_plus_sym_hmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> times_of_nat_minus_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">l</span> <span class="main">=</span> of_nat <span class="free">m</span> <span class="main">*</span> <span class="free">l</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> diff_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> times_of_nat_minus_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">*</span> of_nat <span class="free">m</span> <span class="main">-</span> <span class="free">l</span> <span class="main">*</span> of_nat <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> times_of_nat_minus_left mult.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lt_ω_imp_times_minus_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> ω <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> ω <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">l</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> <span class="free">l</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lt_ω_imp_ex_of_nat times_of_nat_minus_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lt_ω_imp_times_minus_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> ω <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> ω <span class="main">⟹</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">*</span> <span class="free">m</span> <span class="main">-</span> <span class="free">l</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lt_ω_imp_ex_of_nat times_of_nat_minus_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_pair_decompose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="free">m1</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">∧</span> <span class="free">m2</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">+</span> <span class="bound">n2</span> <span class="main">∧</span> <span class="main">(</span>head_ω <span class="bound">n1</span> <span class="main">≠</span> head_ω <span class="bound">n2</span> <span class="main">∨</span> <span class="bound">n1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">n2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="keyword2"><span class="keyword">where</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="free">m1</span> <span class="main">-</span> <span class="free">m2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> <span class="free">m2</span> <span class="main">-</span> <span class="free">m1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">m1</span> <span class="main">-</span> <span class="skolem">n1</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> k2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">m2</span> <span class="main">-</span> <span class="skolem">n2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k1 <span class="keyword1"><span class="command">unfolding</span></span> n1 n2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_diff_sym_hmset<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> n1 add_diff_cancel_left add.commute add_diff_cancel_right' diff_add_zero
      diff_diff_add minus_diff_sym_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> n2 add.commute add_diff_cancel_left add_diff_cancel_left' add_diff_cancel_right'
      diff_add_zero diff_diff_add diff_zero k2 minus_diff_sym_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> hd_n<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">n1</span> <span class="main">≠</span> head_ω <span class="skolem">n2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> n1_or_n2_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bool.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> bool.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False_False
    <span class="keyword1"><span class="command">note</span></span> n1_nz <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> n2_nz <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">δ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ1</span> <span class="main">=</span> hmsetmset <span class="skolem">n1</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">δ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ2</span> <span class="main">=</span> hmsetmset <span class="skolem">n2</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> δ1_inter_δ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ1</span> <span class="main">∩#</span> <span class="skolem">δ2</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> δ1_def δ2_def n1 n2 minus_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_intersect_sym_diff<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> δ1_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ1</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> δ1_def <span class="keyword1"><span class="command">using</span></span> n1_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> δ2_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> δ2_def <span class="keyword1"><span class="command">using</span></span> n2_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> max_δ1<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set_mset <span class="skolem">δ1</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">δ1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> δ1_ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> max_δ2<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set_mset <span class="skolem">δ2</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">δ2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> δ2_ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> max_δ1_ne_δ2<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set_mset <span class="skolem">δ1</span><span class="main">)</span> <span class="main">≠</span> Max <span class="main">(</span>set_mset <span class="skolem">δ2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> δ1_inter_δ2 disjunct_not_in max_δ1 max_δ2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> n1_nz n2_nz
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hmultiset.exhaust_sel<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">n2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hmultiset.exhaust_sel<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> head_ω_def zero_hmultiset_def max_δ1_ne_δ2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> δ1_def δ2_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> n1_or_n2_nz <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> head_ω_def›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_pair_decompose_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m1_lt_m2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">&lt;</span> <span class="free">m2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="free">m1</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">∧</span> <span class="free">m2</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">+</span> <span class="bound">n2</span> <span class="main">∧</span> head_ω <span class="bound">n1</span> <span class="main">&lt;</span> head_ω <span class="bound">n2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    m1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    m2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    hds<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">n1</span> <span class="main">≠</span> head_ω <span class="skolem">n2</span> <span class="main">∨</span> <span class="skolem">n1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">n2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hmset_pair_decompose<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m1</span></span> <span class="quoted"><span class="free">m2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m1 m2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> m1_lt_m2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">n1</span> <span class="main">&gt;</span> head_ω <span class="skolem">n2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&gt;</span> <span class="skolem">n2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> head_ω_lt_imp_lt<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">&gt;</span> <span class="free">m2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m1 m2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> m1_lt_m2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> m1 m2 hds <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> neqE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hmset_pair_decompose_less_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">≤</span> <span class="free">m2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="free">m1</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">∧</span> <span class="free">m2</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">+</span> <span class="bound">n2</span> <span class="main">∧</span> <span class="main">(</span>head_ω <span class="bound">n1</span> <span class="main">&lt;</span> head_ω <span class="bound">n2</span> <span class="main">∨</span> <span class="bound">n1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">n2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_right hmset_pair_decompose_less order.not_eq_order_implies_strict<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_cross_mult_less_hmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Aa</span> <span class="free">A</span> <span class="free">Ba</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&lt;</span> <span class="free">Aa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">&lt;</span> <span class="free">Ba</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="free">Ba</span> <span class="main">+</span> <span class="free">B</span> <span class="main">*</span> <span class="free">Aa</span> <span class="main">&lt;</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">+</span> <span class="free">Aa</span> <span class="main">*</span> <span class="free">Ba</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="skolem"><span class="skolem">m2</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">m1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Aa</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">m2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hd_m<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">m1</span> <span class="main">&lt;</span> head_ω <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmset_pair_decompose_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A_lt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ba</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hd_n<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">n1</span> <span class="main">&lt;</span> head_ω <span class="skolem">n2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmset_pair_decompose_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B_lt<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> hd_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="main">(</span><span class="skolem">m1</span> <span class="main">*</span> <span class="skolem">n2</span> <span class="main">+</span> <span class="skolem">m2</span> <span class="main">*</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">&lt;</span> head_ω <span class="main">(</span><span class="skolem">m1</span> <span class="main">*</span> <span class="skolem">n1</span> <span class="main">+</span> <span class="skolem">m2</span> <span class="main">*</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span> <span class="bound">ha</span> <span class="main">::</span> hmultiset<span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">h</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">ha</span> <span class="main">&lt;</span> <span class="bound">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> head_ω <span class="skolem">m2</span> <span class="main">*</span> head_ω <span class="skolem">n2</span> <span class="main">≤</span> sup <span class="main">(</span>head_ω <span class="skolem">m1</span> <span class="main">*</span> head_ω <span class="skolem">n2</span><span class="main">)</span> <span class="main">(</span>head_ω <span class="skolem">m2</span> <span class="main">*</span> head_ω <span class="skolem">n1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_m hd_n sup_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sup <span class="main">(</span>head_ω <span class="skolem">m1</span> <span class="main">*</span> head_ω <span class="skolem">n2</span><span class="main">)</span> <span class="main">(</span>head_ω <span class="skolem">m2</span> <span class="main">*</span> head_ω <span class="skolem">n1</span><span class="main">)</span>
      <span class="main">&lt;</span> sup <span class="main">(</span>head_ω <span class="skolem">m1</span> <span class="main">*</span> head_ω <span class="skolem">n1</span><span class="main">)</span> <span class="main">(</span>head_ω <span class="skolem">m2</span> <span class="main">*</span> head_ω <span class="skolem">n2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> leI sup.bounded_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A Aa B Ba ring_distribs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> head_ω_lt_imp_lt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_lt<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> triple_cross_mult_hmset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">An</span> <span class="main">*</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cn</span> <span class="main">+</span> <span class="free">Bp</span> <span class="main">*</span> <span class="free">Cp</span> <span class="main">-</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cp</span> <span class="main">+</span> <span class="free">Cn</span> <span class="main">*</span> <span class="free">Bp</span><span class="main">)</span><span class="main">)</span>
   <span class="main">+</span> <span class="main">(</span><span class="free">Cn</span> <span class="main">*</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">+</span> <span class="free">Bn</span> <span class="main">*</span> <span class="free">Ap</span> <span class="main">-</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bn</span> <span class="main">+</span> <span class="free">Ap</span> <span class="main">*</span> <span class="free">Bp</span><span class="main">)</span><span class="main">)</span>
      <span class="main">+</span> <span class="main">(</span><span class="free">Ap</span> <span class="main">*</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cp</span> <span class="main">+</span> <span class="free">Cn</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">-</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cn</span> <span class="main">+</span> <span class="free">Bp</span> <span class="main">*</span> <span class="free">Cp</span><span class="main">)</span><span class="main">)</span>
         <span class="main">+</span> <span class="free">Cp</span> <span class="main">*</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bn</span> <span class="main">+</span> <span class="free">Ap</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">-</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">+</span> <span class="free">Bn</span> <span class="main">*</span> <span class="free">Ap</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   <span class="free">An</span> <span class="main">*</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cp</span> <span class="main">+</span> <span class="free">Cn</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">-</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cn</span> <span class="main">+</span> <span class="free">Bp</span> <span class="main">*</span> <span class="free">Cp</span><span class="main">)</span><span class="main">)</span>
   <span class="main">+</span> <span class="main">(</span><span class="free">Cn</span> <span class="main">*</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bn</span> <span class="main">+</span> <span class="free">Ap</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">-</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">+</span> <span class="free">Bn</span> <span class="main">*</span> <span class="free">Ap</span><span class="main">)</span><span class="main">)</span>
      <span class="main">+</span> <span class="main">(</span><span class="free">Ap</span> <span class="main">*</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cn</span> <span class="main">+</span> <span class="free">Bp</span> <span class="main">*</span> <span class="free">Cp</span> <span class="main">-</span> <span class="main">(</span><span class="free">Bn</span> <span class="main">*</span> <span class="free">Cp</span> <span class="main">+</span> <span class="free">Cn</span> <span class="main">*</span> <span class="free">Bp</span><span class="main">)</span><span class="main">)</span>
         <span class="main">+</span> <span class="free">Cp</span> <span class="main">*</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bp</span> <span class="main">+</span> <span class="free">Bn</span> <span class="main">*</span> <span class="free">Ap</span> <span class="main">-</span> <span class="main">(</span><span class="free">An</span> <span class="main">*</span> <span class="free">Bn</span> <span class="main">+</span> <span class="free">Ap</span> <span class="main">*</span> <span class="free">Bp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Ap</span> <span class="free">An</span> <span class="free">Bp</span> <span class="free">Bn</span> <span class="free">Cp</span> <span class="free">Cn</span> <span class="free">Dp</span> <span class="free">Dn</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_right_cancel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">Cp</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">An</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Bp</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">Ap</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Bn</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> times_diff_plus_sym_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_right_cancel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">Cn</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">An</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Bn</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">Ap</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Bp</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> times_diff_plus_sym_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_right_cancel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ap</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Bn</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Cn</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">Bp</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Cp</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> times_diff_plus_sym_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_right_cancel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">An</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Bn</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Cp</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">Bp</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Cn</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> times_diff_plus_sym_hmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversions to Natural Numbers›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">offset_hmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">offset_hmset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> count <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> offset_hmset_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"offset_hmset <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> offset_hmset_def of_nat_hmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> offset_hmset_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"offset_hmset <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">=</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> offset_hmset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> offset_hmset_def offset_hmset_of_nat of_nat_numeral<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_coefs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_coefs</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> size <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_coefs_distrib_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sum_coefs <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> sum_coefs <span class="free">M</span> <span class="main">+</span> sum_coefs <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_hmultiset_def sum_coefs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_coefs_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_coefs <span class="free">M</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_coefs_def zero_hmultiset_def hmsetmset_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_multiset_ext<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_less
    nonempty_has_size<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An Example›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following proof is based on an informal proof by Uwe Waldmann, inspired by
a similar argument by Michel Ludwig.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ludwig_waldmann_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α1</span> <span class="free">α2</span> <span class="free">β1</span> <span class="free">β2</span> <span class="free">γ</span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    αβ2γ_lt_αβ1γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">+</span> <span class="free">β2</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">&lt;</span> <span class="free">α1</span> <span class="main">+</span> <span class="free">β1</span> <span class="main">*</span> <span class="free">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    β2_le_β1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β2</span> <span class="main">≤</span> <span class="free">β1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    γ_lt_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">+</span> <span class="free">β2</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">&lt;</span> <span class="free">α1</span> <span class="main">+</span> <span class="free">β1</span> <span class="main">*</span> <span class="free">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β0</span></span> <span class="skolem"><span class="skolem">β2a</span></span> <span class="skolem"><span class="skolem">β1a</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    β1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β1</span> <span class="main">=</span> <span class="skolem">β0</span> <span class="main">+</span> <span class="skolem">β1a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    β2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β2</span> <span class="main">=</span> <span class="skolem">β0</span> <span class="main">+</span> <span class="skolem">β2a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    hd_β2a_vs_β1a<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">β2a</span> <span class="main">&lt;</span> head_ω <span class="skolem">β1a</span> <span class="main">∨</span> <span class="skolem">β2a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">β1a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hmset_pair_decompose_less_eq<span class="main">[</span><span class="operator">OF</span> β2_le_β1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">η</span></span> <span class="skolem"><span class="skolem">γa</span></span> <span class="skolem"><span class="skolem">δa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">γa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">δa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    hd_γa_lt_δa<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">γa</span> <span class="main">&lt;</span> head_ω <span class="skolem">δa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hmset_pair_decompose_less<span class="main">[</span><span class="operator">OF</span> γ_lt_δ<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">+</span> <span class="free">β2</span> <span class="main">*</span> <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> β2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute distrib_left mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">α1</span> <span class="main">+</span> <span class="free">β1</span> <span class="main">*</span> <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> αβ2γ_lt_αβ1γ<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">α1</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">+</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> β1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute distrib_left mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">&lt;</span> <span class="free">α1</span> <span class="main">+</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_less_cancel_right semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">+</span> <span class="free">β2</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> β2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab_semigroup_add_class.add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> δ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left semiring_normalization_rules<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">α2</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">γa</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">α2</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> γ distrib_left add.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">α1</span> <span class="main">+</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">α1</span> <span class="main">+</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">γa</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="skolem">δa</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> γ δ distrib_left add.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">α1</span> <span class="main">+</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="skolem">η</span> <span class="main">+</span> <span class="skolem">β0</span> <span class="main">*</span> <span class="skolem">δa</span> <span class="main">+</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">δa</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">γa</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span> <span class="main">≤</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">δa</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">β2a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">β1a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">β2a</span> <span class="main">&lt;</span> head_ω <span class="skolem">β1a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hd_β2a_vs_β1a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"head_ω <span class="main">(</span><span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">γa</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span><span class="main">)</span> <span class="main">&lt;</span> head_ω <span class="main">(</span><span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">δa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hd_γa_lt_δa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gr_zeroI_hmset <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sup_hmultiset_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">γa</span> <span class="main">+</span> <span class="skolem">β2a</span> <span class="main">*</span> <span class="skolem">δa</span> <span class="main">&lt;</span> <span class="skolem">β1a</span> <span class="main">*</span> <span class="skolem">δa</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> head_ω_lt_imp_lt<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> β1 δ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left distrib_right add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Signed_Syntactic_Ordinal">
<div class="head">
<h1>Theory Signed_Syntactic_Ordinal</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Signed Syntactic Ordinals in Cantor Normal Form
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Mathias Fleury &lt;mfleury at mpi-inf.mpg.de&gt;, 2016
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Signed Syntactic Ordinals in Cantor Normal Form›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Signed_Syntactic_Ordinal
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Signed_Hereditary_Multiset.html">Signed_Hereditary_Multiset</a> <a href="Syntactic_Ordinal.html">Syntactic_Ordinal</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Natural (Hessenberg) Product›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> zhmultiset <span class="main">::</span> <span class="quoted">comm_ring_1</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ω<span class="hidden">⇩</span><sub>z</sub>_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ω<span class="hidden">⇩</span><sub>z</sub>^</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ω<span class="hidden">⇩</span><sub>z</sub>^</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">m</span><span class="main">.</span> ZHMSet <span class="main">{#</span><span class="bound">m</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_zhmultiset</span> <span class="main">::</span> <span class="quoted">zhmultiset</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">0</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ω<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">::</span> <span class="quoted">zhmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ω<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">≡</span> <span class="keyword1">ω<span class="hidden">⇩</span><sub>z</sub>^</span><span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω<span class="hidden">⇩</span><sub>z</sub>_as_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">=</span> zhmset_of ω"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_zhmultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">N</span><span class="main">.</span>
       zmset_of <span class="main">(</span>hmsetmset <span class="main">(</span>HMSet <span class="main">(</span>mset_pos <span class="bound">M</span><span class="main">)</span> <span class="main">*</span> HMSet <span class="main">(</span>mset_pos <span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">-</span> zmset_of <span class="main">(</span>hmsetmset <span class="main">(</span>HMSet <span class="main">(</span>mset_pos <span class="bound">M</span><span class="main">)</span> <span class="main">*</span> HMSet <span class="main">(</span>mset_neg <span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">+</span> zmset_of <span class="main">(</span>hmsetmset <span class="main">(</span>HMSet <span class="main">(</span>mset_neg <span class="bound">M</span><span class="main">)</span> <span class="main">*</span> HMSet <span class="main">(</span>mset_neg <span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">-</span> zmset_of <span class="main">(</span>hmsetmset <span class="main">(</span>HMSet <span class="main">(</span>mset_neg <span class="bound">M</span><span class="main">)</span> <span class="main">*</span> HMSet <span class="main">(</span>mset_pos <span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> zhmsetmset_times <span class="main">=</span> times_zhmultiset.rep_eq

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mult_assoc mult_comm mult_1 distrib zero_neq_one<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mult_assoc <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> zmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hmsetmset_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> HMSet_diff<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule</span> triple_cross_mult_hmset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mult_comm <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mult_1 <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> mset_pos_neg_partition<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>distrib <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_zhmultiset_def ZHMSet_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        hmsetmset_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> hmset_pos_plus hmset_neg_plus<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"hmset_pos <span class="skolem">c</span>"</span></span><span class="main"><span class="main">]</span></span> mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"hmset_neg <span class="skolem">c</span>"</span></span><span class="main"><span class="main">]</span></span>
        add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hmset_neg <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"hmset_pos <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">M</span> <span class="skolem">N</span><span class="main"><span class="main">]</span></span>
        add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ring_distribs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hmset_pos_neg_dual<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> zero_neq_one
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zero_zhmultiset_def one_zhmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_1<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_hmultiset_def one_zhmultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_times<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> zhmset_of <span class="free">A</span> <span class="main">*</span> zhmset_of <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_prod_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span>prod_list <span class="free">Ms</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>map zhmset_of <span class="free">Ms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Ms</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_hmultiset_def one_zhmultiset_def zhmset_of_times<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding of Natural Numbers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_zhmset<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">=</span> zhmset_of <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_zhmultiset_def zhmset_of_plus zhmset_of_1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_inject_zhmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="free">m</span> <span class="main">::</span> zhmultiset<span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> of_nat_zhmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_of_nat_plus_of_nat_zhmset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> of_nat <span class="free">m</span> <span class="main">+</span> of_nat <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_of_nat_minus_of_nat_zhmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> of_nat <span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_lt_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">&lt;</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ω<span class="hidden">⇩</span><sub>z</sub>_as_ω <span class="keyword1"><span class="command">using</span></span> of_nat_lt_ω of_nat_zhmset zhmset_of_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_ne_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">≠</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_lt_ω<span class="hidden">⇩</span><sub>z</sub> mset_le_asym mset_lt_single_iff<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding of Extended Natural Numbers›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="entity">zhmset_of_enat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="quoted">"enat <span class="main"><span class="main">⇒</span></span> zhmultiset"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">zhmset_of_enat</span></span> <span class="main"><span class="main">(</span></span>enat <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">n</span></span></span></span></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> of_nat <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">n</span></span></span></span></span></span>"</span></span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">zhmset_of_enat</span></span> <span class="main"><span class="main">∞</span></span> <span class="main"><span class="main">=</span></span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_enat_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_enat_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_enat_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_eq_enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_enat_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">=</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_enat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_enat_le_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="free">n</span> <span class="main">≤</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_lt_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">THEN</span> less_imp_le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_enat_eq_ω<span class="hidden">⇩</span><sub>z</sub>_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="free">n</span> <span class="main">=</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inequalities and Some (Dis)equalities›</span></span>

<span class="keyword1"><span class="command">instance</span></span> zhmultiset <span class="main">::</span> <span class="quoted">zero_less_one</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> zhmultiset <span class="main">::</span> <span class="quoted">linordered_idom</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">sgn_zhmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sgn_zhmultiset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">abs_zhmultiset</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"zhmultiset <span class="main">⇒</span> zhmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abs_zhmultiset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_0_times_gt_0_imp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_gt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_gt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a_gt0 b_gt0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2 4<span class="main"><span class="main">)</span></span> zhmset_pos_neg_partition<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HMSet_less <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> zmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hmsetmset_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        zmset_of_less HMSet_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> mono_cross_mult_less_hmset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">intro_classes</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>

  <span class="keyword3"><span class="command">assume</span></span>
    a_lt_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    zero_lt_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_0_times_gt_0_imp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_lt_b zero_lt_c<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sgn_zhmultiset_def abs_zhmultiset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_zhmset_of_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> zhmset_of <span class="main">(</span>hmset_pos <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_zhmultiset.rep_eq mset_pos_supset subset_eq_imp_le_zmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_zhmset_of_pos_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> zhmset_of <span class="main">(</span>hmset_neg <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_zhmset_of_pos minus_le_iff mset_pos_uminus zhmsetmset_uminus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of <span class="free">M</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hmsetmset_0 zero_le_hmset zero_zhmultiset_def zhmset_of_le zmset_of_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    le_add1_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    le_add2_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_iff_add1_le_zhmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> m_lt_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hh</span></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">zz</span></span> <span class="main">::</span> <span class="quoted">zhmultiset</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">hha</span></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
      f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> zhmset_of <span class="skolem">hh</span> <span class="main">+</span> <span class="skolem">zz</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">=</span> zhmset_of <span class="skolem">hha</span> <span class="main">+</span> <span class="skolem">zz</span> <span class="main">∧</span> <span class="skolem">hh</span> <span class="main">&lt;</span> <span class="skolem">hha</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_hmset_zhmsetE<span class="main">[</span><span class="operator">OF</span> m_lt_n<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zhmset_of <span class="main">(</span><span class="skolem">hh</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> zhmset_of <span class="skolem">hha</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> less_iff_add1_le_hmset zhmset_of_le<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zhmset_of_1 zhmset_of_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_0_lt_mult_gt_1_zhmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_less_iff_1_le_zhmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_iff_add1_le_zhmset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_add_1_iff_le_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_iff_add1_le_zhmset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonneg_le_mult_right_mono_zhmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted">zhmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">*</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> x zero_less_iff_1_le_zhmset<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> y<span class="main">]</span> z
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans leD mult_less_cancel_right2 not_le_imp_less<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">ordered_cancel_comm_semiring</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">linordered_semiring_1_strict</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">bounded_lattice_bot</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">zero_less_one</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">linordered_nonzero_semiring</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">instance</span></span> hmultiset <span class="main">::</span> <span class="quoted">semiring_no_zero_divisors</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lt_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_lt_ω<span class="hidden">⇩</span><sub>z</sub> of_nat_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_lt_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_defs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zhmset_of_enat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zhmset_of_enat_1 of_nat_lt_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> numeral_lt_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span> <span class="main">&lt;</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zhmset_of_enat_numeral<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> zhmset_of_enat.simps<span class="main">(</span>1<span class="main">)</span> of_nat_lt_ω<span class="hidden">⇩</span><sub>z</sub> numeral_eq_enat
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> one_le_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_le_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">≤</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> numeral_le_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span> <span class="main">≤</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω<span class="hidden">⇩</span><sub>z</sub>_lt_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω<span class="hidden">⇩</span><sub>z</sub>_lt_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">&lt;</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω<span class="hidden">⇩</span><sub>z</sub>_lt_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">&lt;</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω<span class="hidden">⇩</span><sub>z</sub>_le_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω<span class="hidden">⇩</span><sub>z</sub>_le_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">≤</span> of_nat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_ω<span class="hidden">⇩</span><sub>z</sub>_le_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">≤</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_ne_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_lt_ω<span class="hidden">⇩</span><sub>z</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1"><span class="command">lemma</span></span> one_ne_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≠</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_ω<span class="hidden">⇩</span><sub>z</sub>_le_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> numeral_ne_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span> <span class="main">≠</span> ω<span class="hidden">⇩</span><sub>z</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_ω<span class="hidden">⇩</span><sub>z</sub>_le_numeral numeral_le_ω<span class="hidden">⇩</span><sub>z</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  ω<span class="hidden">⇩</span><sub>z</sub>_ne_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ω<span class="hidden">⇩</span><sub>z</sub>_ne_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ω<span class="hidden">⇩</span><sub>z</sub>_ne_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">≠</span> of_nat <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ω<span class="hidden">⇩</span><sub>z</sub>_ne_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">≠</span> numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_ne_ω<span class="hidden">⇩</span><sub>z</sub> one_ne_ω<span class="hidden">⇩</span><sub>z</sub> of_nat_ne_ω<span class="hidden">⇩</span><sub>z</sub> numeral_ne_ω<span class="hidden">⇩</span><sub>z</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  zhmset_of_enat_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="free">m</span> <span class="main">=</span> zhmset_of_enat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  zhmset_of_enat_lt_iff_lt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="free">m</span> <span class="main">&lt;</span> zhmset_of_enat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  zhmset_of_enat_le_iff_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="free">m</span> <span class="main">≤</span> zhmset_of_enat <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_lt_zhmset_of_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">m</span> <span class="main">&lt;</span> zhmset_of_enat <span class="free">n</span> <span class="main">⟷</span> enat <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zhmset_of_enat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zhmset_of_enat_lt_iff_lt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_le_zhmset_of_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">m</span> <span class="main">≤</span> zhmset_of_enat <span class="free">n</span> <span class="main">⟷</span> enat <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zhmset_of_enat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zhmset_of_enat_le_iff_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zhmset_of_enat_lt_iff_ne_infinity<span class="main">:</span> <span class="quoted"><span class="quoted">"zhmset_of_enat <span class="free">x</span> <span class="main">&lt;</span> ω<span class="hidden">⇩</span><sub>z</sub> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An Example›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A new proof of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> ludwig_waldmann_less<span class="antiquote"><span class="antiquote">}</span></span></span></span>:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α1</span> <span class="free">α2</span> <span class="free">β1</span> <span class="free">β2</span> <span class="free">γ</span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted">hmultiset</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    αβ2γ_lt_αβ1γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">+</span> <span class="free">β2</span> <span class="main">*</span> <span class="free">γ</span> <span class="main">&lt;</span> <span class="free">α1</span> <span class="main">+</span> <span class="free">β1</span> <span class="main">*</span> <span class="free">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    β2_le_β1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β2</span> <span class="main">≤</span> <span class="free">β1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    γ_lt_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α2</span> <span class="main">+</span> <span class="free">β2</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">&lt;</span> <span class="free">α1</span> <span class="main">+</span> <span class="free">β1</span> <span class="main">*</span> <span class="free">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted">zhmset_of</span>

  <span class="keyword1"><span class="command">note</span></span> αβ2γ_lt_αβ1γ' <span class="main">=</span> αβ2γ_lt_αβ1γ<span class="main">[</span><span class="operator">THEN</span> zhmset_of_less<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">,</span>
    <span class="operator">simplified</span> zhmset_of_plus zhmset_of_times<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> β2_le_β1' <span class="main">=</span> β2_le_β1<span class="main">[</span><span class="operator">THEN</span> zhmset_of_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> γ_lt_δ' <span class="main">=</span> γ_lt_δ<span class="main">[</span><span class="operator">THEN</span> zhmset_of_less<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="free">α2</span> <span class="main">+</span> <span class="var">?z</span> <span class="free">β2</span> <span class="main">*</span> <span class="var">?z</span> <span class="free">δ</span> <span class="main">&lt;</span> <span class="var">?z</span> <span class="free">α1</span> <span class="main">+</span> <span class="var">?z</span> <span class="free">β1</span> <span class="main">*</span> <span class="var">?z</span> <span class="free">γ</span> <span class="main">+</span> <span class="var">?z</span> <span class="free">β2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?z</span> <span class="free">δ</span> <span class="main">-</span> <span class="var">?z</span> <span class="free">γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> αβ2γ_lt_αβ1γ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?z</span> <span class="free">α1</span> <span class="main">+</span> <span class="var">?z</span> <span class="free">β1</span> <span class="main">*</span> <span class="var">?z</span> <span class="free">γ</span> <span class="main">+</span> <span class="var">?z</span> <span class="free">β1</span> <span class="main">*</span> <span class="main">(</span><span class="var">?z</span> <span class="free">δ</span> <span class="main">-</span> <span class="var">?z</span> <span class="free">γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> β2_le_β1' γ_lt_δ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_less zhmset_of_times<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zhmset_of_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Syntactic_Ordinal_Bridge">
<div class="head">
<h1>Theory Syntactic_Ordinal_Bridge</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Syntactic Ordinals in Cantor Normal Form
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2017
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Syntactic_Ordinal_Bridge
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span> <a href="../Ordinal/OrdinalOmega.html">Ordinal.OrdinalOmega</a> <a href="Syntactic_Ordinal.html">Syntactic_Ordinal</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span>
  <span class="quoted">"!h"</span> <span class="main">=</span> <span class="quoted">"<span class="hidden">⇩</span><sub>h</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bridge between Huffman's Ordinal Library and the Syntactic Ordinals›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Missing Lemmas about Huffman's Ordinals›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ordinal <span class="main">::</span> <span class="quoted">order_bot</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">bot_ordinal</span></span> <span class="main">::</span> <span class="quoted">ordinal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bot_ordinal</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_ordinal_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insort_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insort bot <span class="free">xs</span> <span class="main">=</span> bot <span class="main">#</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>order_bot<span class="main">,</span>linorder<span class="main">}</span> list"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_is_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> insort_0_ordinal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> insort_bot<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">::</span> ordinal list"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">xs</span><span class="main">,</span> <span class="operator">unfolded</span> bot_ordinal_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> from_cnf_less_ω_exp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> set <span class="free">ks</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"from_cnf <span class="free">ks</span> <span class="main">&lt;</span> <span class="keyword1">ω</span> <span class="main">**</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> additive_principal.sum_less additive_principal_omega_exp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_cnf_0_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_cnf <span class="free">ks</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">ks</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ordinal_plus_not_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_cnf_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_cnf <span class="main">(</span><span class="free">ks</span> <span class="main">@</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> from_cnf <span class="free">ks</span> <span class="main">+</span> from_cnf <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ordinal_plus_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subseq_from_cnf_less_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Sublist.subseq <span class="free">ks</span> <span class="free">ls</span> <span class="main">⟹</span> from_cnf <span class="free">ks</span> <span class="main">≤</span> from_cnf <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_emb.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ordinal_le_plusL order_trans<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding of Syntactic Ordinals into Huffman's Ordinals›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ω<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted">hmultiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ω<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">≡</span> Syntactic_Ordinal.ω"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ω<span class="hidden">⇩</span><sub>h</sub>_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> hmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ω<span class="hidden">⇩</span><sub>h</sub>^</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ω<span class="hidden">⇩</span><sub>h</sub>^</span></span> <span class="main">≡</span> Syntactic_Ordinal.ω_exp"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ordinal_of_hmset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> ordinal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ordinal_of_hmset</span> <span class="main">(</span>HMSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>
   from_cnf <span class="main">(</span>rev <span class="main">(</span>sorted_list_of_multiset <span class="main">(</span>image_mset <span class="free">ordinal_of_hmset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_of_hmset_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> zero_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_of_hmset_suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> ordinal_of_hmset <span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_hmultiset_def one_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_of_hmset_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ordinal_of_hmset_suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_of_hmset_ω<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset ω<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="keyword1">ω</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_of_hmset_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="main">(</span><span class="keyword1">ω^</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ω</span> <span class="main">**</span> ordinal_of_hmset <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_of_hmset_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="free">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> less_imp_ordinal_of_hmset_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span> ordinal_of_hmset <span class="free">k</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span><span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">k</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="bound"><span class="bound">l</span></span> <span class="main"><span class="main">⟶</span></span> ordinal_of_hmset <span class="bound"><span class="bound">k</span></span> <span class="main"><span class="main">&lt;</span></span> ordinal_of_hmset <span class="bound"><span class="bound">l</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">l</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ka</span> <span class="bound">la</span><span class="main">.</span> <span class="main">{#</span><span class="bound">ka</span><span class="main">,</span> <span class="bound">la</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">l</span><span class="main">#}</span> <span class="main">⟹</span> <span class="bound">ka</span> <span class="main">&lt;</span> <span class="bound">la</span> <span class="main">⟹</span> ordinal_of_hmset <span class="bound">ka</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="bound">la</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    k_lt_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="skolem">k</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> k_lt_l ordinal_neq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> k_nz<span class="main">:</span> False

    <span class="keyword1"><span class="command">have</span></span> l_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k_lt_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> hmsetmset <span class="skolem">k</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> hmsetmset <span class="skolem">l</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> HMSet <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> HMSet <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K L<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> K_lt_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">&lt;</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> K L <span class="keyword1"><span class="command">using</span></span> k_lt_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Max_mset <span class="skolem">K</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ka</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ka<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ka</span> <span class="main">=</span> <span class="skolem">K</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> k_eq_xKa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> HMSet <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">Ka</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> K x Ka k_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> x_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">Ka</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> x Ka <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Max_ge finite_set_mset in_diffD<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> ord_x_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">Ka</span><span class="main">.</span> ordinal_of_hmset <span class="bound">a</span> <span class="main">≤</span> ordinal_of_hmset <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈#</span> <span class="skolem">Ka</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> a_le_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_max a_in<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a_lt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> x_lt_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> k_eq_xKa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mem_imp_less_HMSet<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> a_lt_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">x</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">k</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_lt_k a_lt_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">l</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> k_eq_xKa <span class="keyword1"><span class="command">using</span></span> a_in
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="skolem">a</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ a_lt_x<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="skolem">a</span> <span class="main">≤</span> ordinal_of_hmset <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Max_mset <span class="skolem">L</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">La</span></span> <span class="keyword2"><span class="keyword">where</span></span> La<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">La</span> <span class="main">=</span> <span class="skolem">L</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> l_eq_yLa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> HMSet <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">La</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L y La l_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> y_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span> <span class="main">∈#</span> <span class="skolem">La</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> y La <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Max_ge finite_set_mset in_diffD<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> ord_y_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span> <span class="main">∈#</span> <span class="skolem">La</span><span class="main">.</span> ordinal_of_hmset <span class="bound">b</span> <span class="main">≤</span> ordinal_of_hmset <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> b_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="skolem">La</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> b_le_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_max b_in<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> b_lt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> y_lt_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> l_eq_yLa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mem_imp_less_HMSet<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> b_lt_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">y</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">l</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> y_lt_l b_lt_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">l</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> l_eq_yLa <span class="keyword1"><span class="command">using</span></span> b_in
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="skolem">b</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ b_lt_y<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="skolem">b</span> <span class="main">≤</span> ordinal_of_hmset <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x_eq_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="main">(</span>HMSet <span class="skolem">Ka</span><span class="main">)</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="main">(</span>HMSet <span class="skolem">La</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>HMSet <span class="skolem">Ka</span><span class="main">,</span> HMSet <span class="skolem">La</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">l</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> k l
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single hmsetmset_less hmultiset.sel k k_eq_xKa l l_eq_yLa
            le_multiset_right_total mset_lt_single_iff union_less_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ω^</span><span class="skolem">x</span> <span class="main">+</span> HMSet <span class="skolem">Ka</span> <span class="main">&lt;</span> <span class="keyword1">ω^</span><span class="skolem">y</span> <span class="main">+</span> HMSet <span class="skolem">La</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_lt_l<span class="main">[</span><span class="operator">unfolded</span> k_eq_xKa l_eq_yLa<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> HMSet_plus add.commute add_mset_add_single<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"HMSet <span class="skolem">Ka</span> <span class="main">&lt;</span> HMSet <span class="skolem">La</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_eq_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> k_eq_xKa l_eq_yLa
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> sorted_insort_is_snoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ord_x_max ord_y_max<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_eq_y<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x_ne_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> x_lt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> K L head_ω_def head_ω_lt_imp_lt hmsetmset_less hmultiset.sel k_lt_l k_nz l_nz
          less_imp_not_less mset_lt_single_iff neqE x x_ne_y y<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> ord_y_smax_K<span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="skolem">a</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> a_in_K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">l</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> k_eq_xKa l_eq_yLa <span class="keyword1"><span class="command">using</span></span> a_in_K k k_eq_xKa
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single mem_imp_less_HMSet mset_lt_single_iff union_less_mono
            union_single_eq_member<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_ge finite_set_mset less_le_trans not_less_iff_gr_or_eq that x x_lt_y<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="skolem">k</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="main">(</span><span class="keyword1">ω^</span><span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">La</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> empty
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> from_cnf_less_ω_exp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord_y_smax_K<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> La<span class="main">:</span> <span class="main">(</span>add <span class="skolem">ya</span> <span class="skolem">Lb</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">k</span><span class="main">,</span> <span class="keyword1">ω^</span><span class="skolem">y</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">l</span><span class="main">#}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> l_eq_yLa La <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="keyword1">ω^</span><span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> Max_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Max_ge finite_set_mset less_le_trans union_single_eq_member x_lt_y<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> K x head_ω_def head_ω_lt_imp_lt hmsetmset_less hmultiset.sel k_nz
                mset_lt_single_iff x_lt_y<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ordinal_of_hmset <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> l_eq_yLa
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> from_cnf.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subseq_from_cnf_less_eq
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subseq_from_cnf_less_eq sorted_insort_is_snoc ord_y_max<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_of_hmset_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_of_hmset <span class="free">k</span> <span class="main">&lt;</span> ordinal_of_hmset <span class="free">l</span> <span class="main">⟷</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_imp_not_less less_imp_ordinal_of_hmset_less neq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="McCarthy_91">
<div class="head">
<h1>Theory McCarthy_91</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Termination of McCarthy's 91 function
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2017
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Termination of McCarthy's 91 Function›</span></span>

<span class="keyword1"><span class="command">theory</span></span> McCarthy_91
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset_Order.html">HOL-Library.Multiset_Order</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: move to Isabelle *)</span>
<span class="keyword1"><span class="command">lemma</span></span> funpow_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> id <span class="keyword1">else</span> <span class="free">f</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">^^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> function captures the semantics of McCarthy's 91 function. The
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> function is a tail-recursive implementation of the function, whose
termination is established using the multiset order. The definitions follow
Dershowitz and Manna.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="numeral">100</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="numeral">10</span> <span class="keyword1">else</span> <span class="numeral">91</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">τ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> int multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> mset <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">&gt;</span> <span class="numeral">100</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">-</span> <span class="numeral">10</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lt</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">×</span> int<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">lt</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">b</span> <span class="main">&lt;</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≤</span> <span class="numeral">111</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> lt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="skolem">lt</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> trans_def lt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> lt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="skolem">lt</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> irrefl_def lt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?LT</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mult <span class="skolem">lt</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> τ <span class="bound">n</span> <span class="bound">z</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="var">?LT</span> <span class="var">?T</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_inv_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_mult<span class="main"><span class="main">]</span></span>
        wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> nat <span class="main">(</span><span class="numeral">111</span> <span class="main">-</span> <span class="bound">z</span><span class="main">)</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword3"><span class="command">assume</span></span> n_ne_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> z_gt_100<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&gt;</span> <span class="numeral">100</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="numeral">10</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">=</span>
        map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n_ne_0
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> n_ne_0 <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> n_ge_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_ne_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">have</span></span>
            split_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            split_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upto_rec2<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> f_repeat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="numeral">10</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>f <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> z_gt_100 n_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">rename_tac</span> m<span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">m</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> n_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_l split_r f_repeat nat_diff_distrib'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> image_mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="numeral">10</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">]</span><span class="main">#}</span> <span class="main">=</span>
        <span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="skolem">z</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> mset_map<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">mset</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> mset_eq_add_0_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> add_mset <span class="main">0</span> <span class="main">(</span>mset <span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n_ne_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upto.simps<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> nm1m1<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> int <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n_ne_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">-</span> <span class="numeral">10</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_eq mset_eq_add_0_mset nm1m1 τ_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_implies_mult image_mset_subset_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> z_le_100<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">z</span> <span class="main">&gt;</span> <span class="numeral">100</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="numeral">2</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span>
        map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n_ne_0
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> n_ne_0 <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> n_ge_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_ne_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">have</span></span>
            split_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="numeral">2</span><span class="main">..</span>int <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>int <span class="skolem">n</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            split_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upto_rec2<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> z_le_100 <span class="keyword1"><span class="command">have</span></span> f_f_z_11<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="main">(</span>f <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> f <span class="skolem">z</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> n_ge_2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> f_repeat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>f <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_Suc_right <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> n_ge_2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ih <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less.hyps split_l split_r nat_add_distrib nat_diff_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="numeral">2</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n_ne_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upto_rec1<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span><span class="main">#}</span> <span class="main">=</span>
        <span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">]</span><span class="main">#}</span>
        <span class="main">+</span> <span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="numeral">2</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> factor_out_first_two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span><span class="main">#}</span> <span class="main">=</span>
        <span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> f <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="numeral">2</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upto_rec1<span class="main">)</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?etc1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="numeral">2</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?etc2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">i</span><span class="main">)</span> <span class="skolem">z</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">1</span><span class="main">..</span>int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">#}</span>"</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≥</span> <span class="numeral">90</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> z_ge_90<span class="main">:</span> True

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> f <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc1</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> z_ge_90
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">add_mset</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_eq f_def mset_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mset_map<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> image_mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span><span class="main">#}</span> <span class="main">=</span>
          <span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> factor_out_first_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="skolem">lt</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> z_le_100 z_ge_90 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult1I <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult <span class="skolem">lt</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span><span class="main">)</span> <span class="main">∈</span> mult <span class="skolem">lt</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_cancel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> lt_trans lt_irrefl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> n_ne_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_eq τ_def upto_rec1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> z_lt_90<span class="main">:</span> False

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> f <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc1</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="numeral">91</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> z_lt_90
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">add_mset</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_eq f_def mset_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mset_map<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> image_mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>f <span class="main">^^</span> nat <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">0</span><span class="main">..</span>int <span class="skolem">n</span><span class="main">]</span><span class="main">#}</span> <span class="main">=</span>
          <span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="numeral">91</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> factor_out_first_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="numeral">91</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="skolem">lt</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> z_le_100 z_lt_90 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult1I <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="numeral">91</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult <span class="skolem">lt</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">z</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">,</span> <span class="numeral">91</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?etc2</span><span class="main">)</span> <span class="main">∈</span> mult <span class="skolem">lt</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_cancel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> lt_trans lt_irrefl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> n_ne_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_eq τ_def upto_rec1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> g.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Hydra_Battle">
<div class="head">
<h1>Theory Hydra_Battle</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Termination of the hydra battle
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2017
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Termination of the Hydra Battle›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Hydra_Battle
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Syntactic_Ordinal.html">Syntactic_Ordinal</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Nil Cons

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h›</span></span></span></span> function and its auxiliaries <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span> represent the
hydra battle. The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>encode›</span></span></span></span> function converts a hydra (represented as a
Lisp-like tree) to a syntactic ordinal. The definitions follow Dershowitz and
Moser.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> lisp <span class="main">=</span>
  Nil
<span class="main">|</span> Cons <span class="main">(</span><span class="free"><span class="free"><span class="entity">car</span></span></span><span class="main">:</span> <span class="quoted">lisp</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">cdr</span></span></span><span class="main">:</span> <span class="quoted">lisp</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">car</span> Nil <span class="main">=</span> Nil"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cdr</span> Nil <span class="main">=</span> Nil"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"lisp <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">encode</span> Nil <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">encode</span> <span class="main">(</span>Cons <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ω^</span><span class="main">(</span><span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> lisp <span class="main">⇒</span> lisp <span class="main">⇒</span> lisp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Cons <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">f</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> encode_f<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span>f <span class="free">n</span> <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="keyword1">ω^</span><span class="main">(</span>encode <span class="free">y</span><span class="main">)</span> <span class="main">+</span> encode <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> of_nat_times_ω_exp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HMSet_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> lisp <span class="main">⇒</span> lisp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> car <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Nil <span class="keyword1">then</span> cdr <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> car <span class="main">(</span>car <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Nil <span class="keyword1">then</span> f <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>cdr <span class="main">(</span>car <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cdr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> Cons <span class="main">(</span><span class="free">d</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>car <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cdr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> size <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> n x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> d.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> lisp <span class="main">⇒</span> lisp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Nil <span class="keyword1">then</span> Nil <span class="keyword1">else</span> <span class="free">h</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>d <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="main">{</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> encode <span class="bound">x</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_inv_image<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> wf<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> Nil"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> d <span class="skolem">n</span> <span class="skolem">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_image_def mem_Collect_eq prod.case
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> ihl <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> d.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> l_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> Nil"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"car <span class="skolem">l</span> <span class="main">=</span> Nil"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span>f <span class="skolem">n</span> <span class="main">(</span>cdr <span class="skolem">l</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">&lt;</span> <span class="keyword1">ω^</span><span class="main">(</span>encode <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> encode <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l_cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> encode_f<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span>d <span class="skolem">n</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">&lt;</span> encode <span class="skolem">l</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ihl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> l_cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> h.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Goodstein_Sequence">
<div class="head">
<h1>Theory Goodstein_Sequence</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Termination of the Goodstein Sequence
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2017
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Termination of the Goodstein Sequence›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Goodstein_Sequence
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Multiset_More.html">Multiset_More</a> <a href="Syntactic_Ordinal.html">Syntactic_Ordinal</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>goodstein›</span></span></span></span> function returns the successive values of the Goodstein
sequence. It is defined in terms of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>encode›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>decode›</span></span></span></span> functions,
which convert between natural numbers and ordinals. The development culminates
with a proof of Goodstein's theorem.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Division›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> div_mult_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">div</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> div_times_less_eq_dividend<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> power_div_same_base<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">^</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">^</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">b</span> <span class="main">^</span> <span class="free">y</span> <span class="main">=</span> <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semidom_divide"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse leD nonzero_mult_div_cancel_left power_add<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hereditary and Nonhereditary Base-<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> Systems›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">base</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> base_ge_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">base</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">well_base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> count <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">base</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">well_base</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> well_base_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base <span class="free">M</span> <span class="main">⟹</span> well_base <span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">p</span> <span class="bound">m</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> well_base.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> well_base_image_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base <span class="free">M</span> <span class="main">⟹</span> inj_on <span class="free">f</span> <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span> <span class="main">⟹</span> well_base <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_base.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_image_mset_le_count_inj_on le_less_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> well_base_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"well_base <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">base</span> <span class="main">^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">base</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> well_M <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> in_M_lt_Sn <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Meq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> <span class="bound">m</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Mne</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≠</span> <span class="skolem">n</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">base</span> <span class="main">^</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">#}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="var">?Meq</span> <span class="main">+</span> <span class="var">?Mne</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> well_Mne<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base <span class="var">?Mne</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> well_base_filter<span class="main"><span class="main">[</span></span><span class="operator">OF</span> well_M<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> in_Mne_lt_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> <span class="var">?Mne</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_M_lt_Sn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mset <span class="main">(</span>image_mset <span class="main">(</span><span class="main">(^)</span> <span class="free">base</span><span class="main">)</span> <span class="var">?Meq</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">base</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_eq_replicate_mset <span class="keyword1"><span class="command">using</span></span> base_ge_2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Suc_pred diff_self_eq_0 le_SucE less_imp_le less_le_trans less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
      pos2 well_M well_base.cases zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">base</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="free">base</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base_ge_2 mult_eq_if <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> well_Mne in_Mne_lt_n<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> M<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> union_filter_mset_complement<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">well_base<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"hmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">N</span> <span class="main">∈#</span> hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="free">well_base<span class="hidden">⇩</span><sub>h</sub></span> <span class="bound">N</span><span class="main">)</span> <span class="main">⟹</span> well_base <span class="main">(</span>hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">well_base<span class="hidden">⇩</span><sub>h</sub></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> well_base<span class="hidden">⇩</span><sub>h</sub>_mono_hmset<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">M</span> <span class="main">⟹</span> hmsetmset <span class="free">N</span> <span class="main">⊆#</span> hmsetmset <span class="free">M</span> <span class="main">⟹</span> well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> well_base<span class="hidden">⇩</span><sub>h</sub>.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> well_base<span class="hidden">⇩</span><sub>h</sub>.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">meson</span> leD leI order_trans subseteq_mset_def well_base.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> well_base<span class="hidden">⇩</span><sub>h</sub>_imp_well_base<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">M</span> <span class="main">⟹</span> well_base <span class="main">(</span>hmsetmset <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> well_base<span class="hidden">⇩</span><sub>h</sub>.cases<span class="main">)</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Encoding of Natural Numbers into Ordinals›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> hmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> of_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="free">base</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">ω^</span><span class="main">(</span><span class="free">encode</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">encode</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> base_ge_2
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">base</span> <span class="main">^</span> <span class="bound">e</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> n_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">+</span> <span class="skolem">e</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' add_leD1 diff_is_0_eq' double_not_eq_Suc_double
      le_antisym mult_2 not_less_eq_eq power_eq_0_iff zero_neq_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_ge_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_ge_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">+</span> <span class="skolem">e</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">*</span> <span class="main">(</span><span class="free">base</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> div_mult_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_ge_0 base_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">*</span> <span class="main">(</span><span class="free">base</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> encode.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="free">e</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encode.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"encode <span class="free">e</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">base</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">ω^</span><span class="main">(</span>encode <span class="main">0</span> <span class="free">e</span><span class="main">)</span> <span class="main">+</span> encode <span class="main">(</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encode.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="free">e</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> n<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">base</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> div_eq_0_iff n <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span> <span class="keyword1">div</span> <span class="free">base</span>"</span></span><span class="main">]</span> n
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_Suc<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> One_nat_def base_ge_2 div_eq_dividend_iff div_le_dividend
          leD lessI nat_neq_iff numeral_2_eq_2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> n plus_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_Suc<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> encode_Suc_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span>Suc <span class="free">e</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> encode <span class="free">e</span> <span class="main">(</span><span class="free">base</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> base_ge_2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> encode.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> encode.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_exp_0<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="free">e</span> <span class="free">n</span> <span class="main">=</span> encode <span class="main">0</span> <span class="main">(</span><span class="free">base</span> <span class="main">^</span> <span class="free">e</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_Suc_exp mult.assoc mult.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_hmsetmset_encodeD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈#</span> hmsetmset <span class="main">(</span>encode <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">e'</span></span> <span class="main">≥</span> <span class="free">e</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> encode <span class="main">0</span> <span class="bound">e'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> encode.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">e</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> M_in <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> M_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> n<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈#</span> replicate_mset <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">base</span><span class="main">)</span> <span class="main">(</span>encode <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_replicate_mset order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈#</span> hmsetmset <span class="main">(</span>encode <span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">(</span>2<span class="main">)</span> le_add1 n order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> M_in<span class="main">[</span><span class="operator">unfolded</span> n encode_Suc<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> n<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> hmsetmset_plus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_imp_encode_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span> encode <span class="free">e</span> <span class="free">n</span> <span class="main">&lt;</span> encode <span class="free">e</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> encode.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">e</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> n_lt_p <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> n_lt_p base_ge_2 encode_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> le_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> n_nz<span class="main">:</span> False

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">base</span><span class="main">)</span> <span class="main">(</span>encode <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Na</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">mod</span> <span class="free">base</span><span class="main">)</span> <span class="main">(</span>encode <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Pa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate_mset <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">base</span> <span class="main">-</span> <span class="skolem">p</span> <span class="keyword1">mod</span> <span class="free">base</span><span class="main">)</span> <span class="main">(</span>encode <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HMSet <span class="var">?Ma</span> <span class="main">+</span> encode <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span> <span class="main">&lt;</span> HMSet <span class="var">?Na</span> <span class="main">+</span> encode <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">base</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="keyword1">mod</span> <span class="free">base</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> mod_lt<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_less_le_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_lt<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">metis</span> ih<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">div</span></span></span> <span class="free"><span class="free"><span class="free">base</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> n_nz<span class="main"><span class="main">]</span></span> Suc_eq_plus1 div_le_mono le_less n_lt_p<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> mod_ge<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> div_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="keyword1">div</span> <span class="free">base</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_left div_le_mono div_mult_mod_eq le_neq_implies_less less_imp_le
          n_lt_p nat_neq_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="main">(</span>encode <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hmsetmset <span class="main">(</span>encode <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> Suc_eq_plus1<span class="main"><span class="main">]</span></span> n_nz div_lt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        X_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        X_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆#</span> <span class="var">?N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="var">?N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        ex_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> x_in_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> x_in_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="var">?N</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          e'_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">&gt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> encode <span class="main">0</span> <span class="skolem">e'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mem_hmsetmset_encodeD<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> encode <span class="main">0</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">using</span></span> ih<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> n_nz<span class="main">]</span> e'_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Suc_lessD<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> ex_gt_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> encode <span class="main">0</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> X_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> X_sub'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆#</span> <span class="var">?Na</span> <span class="main">+</span> <span class="var">?N</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> X_sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.add_increasing<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> mam_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Ma</span> <span class="main">+</span> <span class="var">?M</span> <span class="main">=</span> <span class="var">?Na</span> <span class="main">+</span> <span class="var">?N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">+</span> <span class="var">?Pa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> mod_ge <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ma</span> <span class="main">=</span> <span class="var">?Na</span> <span class="main">+</span> <span class="var">?Pa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replicate_mset_plus <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Na</span> <span class="main">+</span> <span class="var">?N</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">=</span> <span class="var">?Na</span> <span class="main">+</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> X_sub multiset_diff_union_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> max_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="var">?Pa</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_gt mod_ge ex_gt_e <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_replicate_mset union_iff<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4 8<span class="main"><span class="main">)</span></span> hmultiset.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">unfold</span> HMSet_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> HMSet_less less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">Y</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="var"><span class="var"><span class="var">?Pa</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">intro</span> conjI impI allI X_nemp X_sub' mam_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> max_X<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> n_nz n_lt_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> encode.simps<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">aligned<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> hmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> encode <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">aligned<span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aligned<span class="hidden">⇩</span><sub>e</sub>_encode<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>e</sub> <span class="free">e</span> <span class="main">(</span>encode <span class="free">e</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encode_exp_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> aligned<span class="hidden">⇩</span><sub>e</sub>.intros<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> encode_exp_0 leD leI lessI less_imp_encode_less lift_Suc_mono_less_iff
      mem_hmsetmset_encodeD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> well_base<span class="hidden">⇩</span><sub>h</sub>_encode<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>encode <span class="free">e</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> encode.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">e</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> well2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈#</span> hmsetmset <span class="main">(</span>encode <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> well_base<span class="hidden">⇩</span><sub>h</sub> <span class="bound">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">(</span>2<span class="main">)</span> well_base<span class="hidden">⇩</span><sub>h</sub>.cases <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Zero_not_Suc count_empty div_0
      encode_0_iff hmsetmset_empty_iff in_countE<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> cnt1<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>hmsetmset <span class="main">(</span>encode <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>encode <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aligned<span class="hidden">⇩</span><sub>e</sub>_encode<span class="main">[</span><span class="operator">unfolded</span> aligned<span class="hidden">⇩</span><sub>e</sub>.simps<span class="main">]</span>
      less_imp_encode_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">n</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> count_inI leD<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> well_base<span class="hidden">⇩</span><sub>h</sub>.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈#</span> hmsetmset <span class="main">(</span>encode <span class="skolem">e</span> <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> well_base<span class="hidden">⇩</span><sub>h</sub> <span class="bound">M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encode.simps<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_hmultiset_def hmsetmset_plus<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> ih<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> well2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"well_base <span class="main">(</span>hmsetmset <span class="main">(</span>encode <span class="skolem">e</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt1 base_ge_2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encode.simps<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> well_base.simps zero_hmultiset_def hmsetmset_plus<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">metis</span> ih<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> well_base<span class="hidden">⇩</span><sub>h</sub>.simps Suc_eq_plus1 less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> well_base.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Decoding of Natural Numbers from Ordinals›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> hmultiset <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decode</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>HMSet <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="free">base</span> <span class="main">^</span> <span class="free">decode</span> <span class="main">0</span> <span class="bound">m</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decode_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"decode <span class="free">e</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈#</span> hmsetmset <span class="free">M</span><span class="main">.</span> <span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="bound">m</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">^</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> decode_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"decode <span class="free">e</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> zero_hmultiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">aligned<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> hmultiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> hmsetmset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> decode <span class="main">0</span> <span class="bound">m</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">aligned<span class="hidden">⇩</span><sub>d</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="main">0</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aligned<span class="hidden">⇩</span><sub>d</sub>.intros<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>_mono_exp_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>Suc <span class="free">e</span><span class="main">)</span> <span class="free">M</span> <span class="main">⟹</span> aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>_mono_hmset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hmsetmset <span class="free">M'</span> <span class="main">⊆#</span> hmsetmset <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">M'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> decode_exp_shift_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> align<span class="hidden">⇩</span><sub>d</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>Suc <span class="free">e</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decode <span class="free">e</span> <span class="free">M</span> <span class="main">=</span> <span class="free">base</span> <span class="main">*</span> decode <span class="main">(</span>Suc <span class="free">e</span><span class="main">)</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> decode_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> sum_mset_distrib_div_if_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> align' <span class="main">=</span> align<span class="hidden">⇩</span><sub>d</sub><span class="main">[</span><span class="operator">unfolded</span> aligned<span class="hidden">⇩</span><sub>d</sub>.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> Suc_le_eq<span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> hmsetmset <span class="free">M</span><span class="main">.</span> <span class="free">base</span> <span class="main">^</span> Suc <span class="free">e</span> <span class="keyword1">dvd</span> <span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> align' Suc_leI le_imp_power_dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> hmsetmset <span class="free">M</span><span class="main">.</span> <span class="free">base</span> <span class="main">^</span> <span class="free">e</span> <span class="keyword1">dvd</span> <span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> align' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_imp_power_dvd le_less<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> base_e_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">base</span> <span class="main">^</span> <span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> mult_base<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="skolem">m</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">^</span> <span class="free">e</span> <span class="main">=</span> <span class="free">base</span> <span class="main">*</span> <span class="main">(</span><span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="skolem">m</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">base</span> <span class="main">*</span> <span class="free">base</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> m_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈#</span> hmsetmset <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> m_in align'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> power_div_same_base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> base_e_nz<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> Suc_diff_Suc Suc_leI mult_is_0 power_Suc power_div_same_base power_not_zero<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈#</span>hmsetmset <span class="free">M</span><span class="main">.</span> <span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="bound">m</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">base</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈#</span>hmsetmset <span class="free">M</span><span class="main">.</span> <span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="bound">m</span> <span class="keyword1">div</span> <span class="free">base</span> <span class="main">^</span> Suc <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_mset_distrib_left <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">sum_mset</span><span class="main"><span class="main">]</span></span> image_mset_cong
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_base<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decode_exp_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decode <span class="main">0</span> <span class="free">M</span> <span class="main">=</span> <span class="free">base</span> <span class="main">^</span> <span class="free">e</span> <span class="main">*</span> decode <span class="free">e</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decode_exp_shift_Suc <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>_mono_exp_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> decode_plus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> align<span class="hidden">⇩</span><sub>d</sub>_M<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decode <span class="free">e</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> decode <span class="free">e</span> <span class="free">M</span> <span class="main">+</span> decode <span class="free">e</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> align<span class="hidden">⇩</span><sub>d</sub>_M<span class="main">[</span><span class="operator">unfolded</span> aligned<span class="hidden">⇩</span><sub>d</sub>.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> decode_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hmsetmset_plus
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_imp_power_dvd div_plus_div_distrib_dvd_left<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum_mset_dvd<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_imp_decode_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decode <span class="free">e</span> <span class="free">M</span> <span class="main">&lt;</span> decode <span class="free">e</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> well<span class="hidden">⇩</span><sub>h</sub>_M <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> align<span class="hidden">⇩</span><sub>d</sub>_M <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> align<span class="hidden">⇩</span><sub>d</sub>_N <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    M_lt_N <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="skolem"><span class="skolem">Ma</span></span> <span class="skolem"><span class="skolem">Na</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">K</span> <span class="main">+</span> <span class="skolem">Ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">K</span> <span class="main">+</span> <span class="skolem">Na</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    hds<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">Ma</span> <span class="main">&lt;</span> head_ω <span class="skolem">Na</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hmset_pair_decompose_less<span class="main">[</span><span class="operator">OF</span> M_lt_N<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    H<span class="main">:</span> <span class="quoted"><span class="quoted">"head_ω <span class="skolem">Na</span> <span class="main">=</span> <span class="keyword1">ω^</span><span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hds head_ω_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> H_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈#</span> hmsetmset <span class="skolem">Na</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> H Max_in add_mset_eq_single add_mset_not_empty finite_set_mset head_ω_def
      hmsetmset_empty_iff hmultiset.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_mset_eq_empty_iff zero_hmultiset_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> well<span class="hidden">⇩</span><sub>h</sub>_Ma<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">Ma</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> well_base<span class="hidden">⇩</span><sub>h</sub>_mono_hmset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> well<span class="hidden">⇩</span><sub>h</sub>_M<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M hmsetmset_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> align<span class="hidden">⇩</span><sub>d</sub>_K<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">e</span> <span class="skolem">K</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M align<span class="hidden">⇩</span><sub>d</sub>_M aligned<span class="hidden">⇩</span><sub>d</sub>_mono_hmset hmsetmset_plus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> align<span class="hidden">⇩</span><sub>d</sub>_Ma<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">e</span> <span class="skolem">Ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M align<span class="hidden">⇩</span><sub>d</sub>_M aligned<span class="hidden">⇩</span><sub>d</sub>_mono_hmset hmsetmset_plus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> align<span class="hidden">⇩</span><sub>d</sub>_Na<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">e</span> <span class="skolem">Na</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N align<span class="hidden">⇩</span><sub>d</sub>_N aligned<span class="hidden">⇩</span><sub>d</sub>_mono_hmset hmsetmset_plus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>decode <span class="main">0</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span>hmsetmset <span class="skolem">Ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span>
      x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> hmsetmset <span class="skolem">Ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> hmsetmset <span class="skolem">Ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dec_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"decode <span class="main">0</span> <span class="skolem">x</span> <span class="main">=</span> decode <span class="main">0</span> <span class="skolem">y</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span>
        x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> hmsetmset <span class="skolem">Ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> hmsetmset <span class="skolem">Ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        x_lt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> x_lt_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">M</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> M <span class="keyword1"><span class="command">using</span></span> mem_hmsetmset_imp_less<span class="main">[</span><span class="operator">OF</span> x_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trans_less_add2_hmset<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> well<span class="hidden">⇩</span><sub>h</sub>_x<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> well<span class="hidden">⇩</span><sub>h</sub>_Ma well_base<span class="hidden">⇩</span><sub>h</sub>.simps x_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decode <span class="main">0</span> <span class="skolem">x</span> <span class="main">&lt;</span> decode <span class="main">0</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_lt_M well<span class="hidden">⇩</span><sub>h</sub>_x aligned<span class="hidden">⇩</span><sub>d</sub>_0 aligned<span class="hidden">⇩</span><sub>d</sub>_0 x_lt_y<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_in y_in dec_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leI less_irrefl_nat order.not_eq_order_implies_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> well_dec_Ma<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base <span class="main">(</span>image_mset <span class="main">(</span>decode <span class="main">0</span><span class="main">)</span> <span class="main">(</span>hmsetmset <span class="skolem">Ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> well_base_image_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> well_base<span class="hidden">⇩</span><sub>h</sub>_imp_well_base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> well<span class="hidden">⇩</span><sub>h</sub>_Ma<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> H_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> hmsetmset <span class="skolem">Ma</span><span class="main">.</span> decode <span class="main">0</span> <span class="bound">m</span> <span class="main">&lt;</span> decode <span class="main">0</span> <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> m_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈#</span> hmsetmset <span class="skolem">Ma</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈#</span> hmsetmset <span class="main">(</span>head_ω <span class="skolem">Ma</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">H</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hds<span class="main">[</span><span class="operator">unfolded</span> H<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> head_ω_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> m_lt_H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">H</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m_in
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_less_iff empty_iff finite_set_mset head_ω_def hmultiset.sel insert_iff
        set_mset_add_mset_insert<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> m_lt_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mem_hmsetmset_imp_less<span class="main">[</span><span class="operator">OF</span> m_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M trans_less_add2_hmset<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> well<span class="hidden">⇩</span><sub>h</sub>_m<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m_in well<span class="hidden">⇩</span><sub>h</sub>_Ma well_base<span class="hidden">⇩</span><sub>h</sub>.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decode <span class="main">0</span> <span class="skolem">m</span> <span class="main">&lt;</span> decode <span class="main">0</span> <span class="skolem">H</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_lt_M well<span class="hidden">⇩</span><sub>h</sub>_m aligned<span class="hidden">⇩</span><sub>d</sub>_0 aligned<span class="hidden">⇩</span><sub>d</sub>_0 m_lt_H<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decode <span class="main">0</span> <span class="skolem">Ma</span> <span class="main">&lt;</span> <span class="free">base</span> <span class="main">^</span> decode <span class="main">0</span> <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_base_bound<span class="main">[</span><span class="operator">OF</span> well_dec_Ma<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> H_bound<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> decode_unfold<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> decode <span class="main">0</span> <span class="skolem">Na</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> decode_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum_image_mset_mono_mem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> H_in<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decode <span class="skolem">e</span> <span class="skolem">Ma</span> <span class="main">&lt;</span> decode <span class="skolem">e</span> <span class="skolem">Na</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decode_exp_shift<span class="main">[</span><span class="operator">OF</span> align<span class="hidden">⇩</span><sub>d</sub>_Ma<span class="main">]</span> decode_exp_shift<span class="main">[</span><span class="operator">OF</span> align<span class="hidden">⇩</span><sub>d</sub>_Na<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"decode <span class="skolem">e</span> <span class="skolem">M</span> <span class="main">&lt;</span> decode <span class="skolem">e</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decode_plus<span class="main"><span class="main">[</span></span><span class="operator">OF</span> align<span class="hidden">⇩</span><sub>d</sub>_K<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_decode<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>decode <span class="free">e</span><span class="main">)</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> well_base<span class="hidden">⇩</span><sub>h</sub> <span class="bound">M</span> <span class="main">∧</span> aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="bound">M</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def Ball_def mem_Collect_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_decode_less less_irrefl_nat neqE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> decode_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">M</span> <span class="main">⟹</span> aligned<span class="hidden">⇩</span><sub>d</sub> <span class="free">e</span> <span class="free">M</span> <span class="main">⟹</span> decode <span class="free">e</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> aligned<span class="hidden">⇩</span><sub>d</sub>_0 decode_0 decode_exp_shift encode_0 less_imp_decode_less mult_0_right neqE
    not_less_zero well_base<span class="hidden">⇩</span><sub>h</sub>_encode<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> decode_encode<span class="main">:</span> <span class="quoted"><span class="quoted">"decode <span class="free">e</span> <span class="main">(</span>encode <span class="free">e</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> encode.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">e</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> n_nz<span class="main">:</span> False

    <span class="keyword1"><span class="command">have</span></span> align<span class="hidden">⇩</span><sub>d</sub>1<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">e</span> <span class="main">(</span>of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">base</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">ω^</span><span class="main">(</span>encode <span class="main">0</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> of_nat_times_ω_exp <span class="keyword1"><span class="command">using</span></span> n_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> align<span class="hidden">⇩</span><sub>d</sub>2<span class="main">:</span> <span class="quoted"><span class="quoted">"aligned<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span>encode <span class="main">(</span>Suc <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> aligned<span class="hidden">⇩</span><sub>d</sub>.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ih<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> n_nz<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mem_hmsetmset_encodeD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Suc_le_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span>
          less_imp_decode_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> well_base<span class="hidden">⇩</span><sub>h</sub>_encode aligned<span class="hidden">⇩</span><sub>d</sub>_0 aligned<span class="hidden">⇩</span><sub>d</sub>_0<span class="main"><span class="main">]</span></span> less_imp_encode_less<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih base_ge_2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encode.simps<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decode_plus<span class="main"><span class="main">[</span></span><span class="operator">OF</span> align<span class="hidden">⇩</span><sub>d</sub>1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> of_nat_times_ω_exp<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
           decode_exp_shift_Suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> align<span class="hidden">⇩</span><sub>d</sub>2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> encode_decode_exp_0<span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">M</span> <span class="main">⟹</span> encode <span class="main">0</span> <span class="main">(</span>decode <span class="main">0</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_decode<span class="main"><span class="main">]</span></span> decode_encode well_base<span class="hidden">⇩</span><sub>h</sub>_encode<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> well_base<span class="hidden">⇩</span><sub>h</sub>_mono_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    well<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">base</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">base</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">base</span> <span class="main">≤</span> <span class="free">base'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="free">base'</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> two well<span class="hidden">⇩</span><sub>h</sub>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> well_base<span class="hidden">⇩</span><sub>h</sub>.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">meson</span> two bases less_le_trans order_trans well_base<span class="hidden">⇩</span><sub>h</sub>.intros well_base.simps<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Goodstein Sequence and Goodstein's Theorem›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">start</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">goodstein</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">goodstein</span> <span class="main">0</span> <span class="main">=</span> <span class="free">start</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">goodstein</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> decode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="free">goodstein</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> goodstein_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gi_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"goodstein <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>goodstein <span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span> encode <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>goodstein <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ei</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>goodstein <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?reencode</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?decoded_Ei</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decode <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span> <span class="var">?Ei</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> two_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="var">?Ei</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> well_base<span class="hidden">⇩</span><sub>h</sub>_encode<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> well<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"well_base<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="var">?Ei</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> well_base<span class="hidden">⇩</span><sub>h</sub>_mono_base<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> decoded_Ei_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?decoded_Ei</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gi_gt_0 gr0I encode_0_iff le_add2 decode_0_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ well<span class="hidden">⇩</span><sub>h</sub> aligned<span class="hidden">⇩</span><sub>d</sub>_0<span class="main"><span class="main">]</span></span> two_le<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?reencode</span> <span class="main">(</span><span class="var">?decoded_Ei</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?reencode</span> <span class="var">?decoded_Ei</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_imp_encode_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> two_le<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> decoded_Ei_gt_0 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">linarith</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?Ei</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> encode_decode_exp_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> two_le well<span class="hidden">⇩</span><sub>h</sub><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> goodsteins_theorem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> goodstein <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> encode <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>goodstein <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?G</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="var">?G</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_iff_no_infinite_down_chain<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf<span class="main">,</span>
      <span class="operator">unfolded</span> not_ex not_all mem_Collect_eq prod.case<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"goodstein <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> goodstein_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc gr0I one_plus_numeral semiring_norm<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Unary_PCF">
<div class="head">
<h1>Theory Unary_PCF</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Towards Decidability of Behavioral Equivalence for Unary PCF
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2017
    Maintainer:  Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Towards Decidability of Behavioral Equivalence for Unary PCF›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Unary_PCF
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Countable_Set_Type.html">HOL-Library.Countable_Set_Type</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Nat_Bijection.html">HOL-Library.Nat_Bijection</a>"</span>
    <a href="Hereditary_Multiset.html">Hereditary_Multiset</a>
    <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> UNIV <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_cartesian_productI1<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> infinite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_cartesian_productD1<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Types›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> type <span class="main">=</span> ℬ <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">ℬ</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span> <span class="main">|</span> Fun <span class="quoted">type</span> <span class="quoted">type</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">→</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_fun</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→→</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main"><span class="free">→→</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> fold <span class="main">(→)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">dest_fun</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dest_fun</span> <span class="keyword1">ℬ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dest_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">#</span> <span class="free">dest_fun</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> length <span class="main">(</span>dest_fun <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_fun_dest_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dest_fun <span class="free">T</span> <span class="main">→→</span> <span class="keyword1">ℬ</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dest_fun_mk_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dest_fun <span class="main">(</span><span class="free">Ts</span> <span class="main">→→</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ts</span> <span class="main">@</span> dest_fun <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">δ</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="keyword1">ℬ</span> <span class="main">=</span> HMSet <span class="main">{#}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">=</span> HMSet <span class="main">(</span>add_mset <span class="main">(</span><span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span>hmsetmset <span class="main">(</span><span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> δ_mk_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"δ <span class="main">(</span><span class="free">Ts</span> <span class="main">→→</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> HMSet <span class="main">(</span>hmsetmset <span class="main">(</span>δ <span class="free">T</span><span class="main">)</span> <span class="main">+</span> mset <span class="main">(</span>map δ <span class="free">Ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> type_induct <span class="main">[</span><span class="operator">case_names</span> Fun<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">T1</span> <span class="bound">T2</span><span class="main">.</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">T1</span> <span class="main">→</span> <span class="bound">T2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T1</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">T1</span> <span class="bound">T2</span><span class="main">.</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">T1</span> <span class="main">→</span> <span class="bound">T2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ℬ
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Fun
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> Fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Terms›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">string</span>
<span class="keyword1"><span class="command">type_synonym</span></span> idx <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">datatype</span></span> expr <span class="main">=</span>
    Var <span class="quoted"><span class="quoted">"name <span class="main">*</span> type"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⟨</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span> <span class="main">|</span> Bound <span class="quoted">idx</span> <span class="main">|</span> B <span class="quoted">bool</span>
  <span class="main">|</span> Seq <span class="quoted">expr</span> <span class="quoted">expr</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">?</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 75<span class="main">)</span> <span class="main">|</span> App <span class="quoted">expr</span> <span class="quoted">expr</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⋅</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 75<span class="main">)</span>
  <span class="main">|</span> Abs <span class="quoted">type</span> <span class="quoted">expr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">Λ⟨</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 800<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion_enabled</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted">B</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted">Bound</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> B <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> Bound <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="quoted">"<span class="entity">open</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"idx <span class="main">⇒</span> expr <span class="main">⇒</span> expr <span class="main">⇒</span> expr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">::</span> idx<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">⟩</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">open</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⟩</span> <span class="main">(</span><span class="free">open</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">open0</span> <span class="main">≡</span> open <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">open_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">≡</span> open <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">xT</span></span></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">open0_Var</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">≡</span> open <span class="main">0</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">xT</span></span></span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="quoted">"<span class="entity">close_Var</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"idx <span class="main">⇒</span> name <span class="main">×</span> type <span class="main">⇒</span> expr <span class="main">⇒</span> expr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">::</span> idx<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">yU</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">close_Var</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⟩</span> <span class="main">(</span><span class="free">close_Var</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">close0_Var</span> <span class="main">≡</span> close_Var <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="quoted">"<span class="entity">fv</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> <span class="main">(</span>name <span class="main">×</span> type<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">::</span> idx<span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">|}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">|∪|</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">|∪|</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fresh</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|∉|</span> fv <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> char list<span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">|∉|</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> not_ex not_not<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?P</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_UNIV_listI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⊆</span> fst <span class="main">`</span> fset <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> finite_surj<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lc</span> <span class="keyword2"><span class="keyword">where</span></span>
  lc_Var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">xT</span></span></span><span class="main">⟩</span>"</span></span>
<span class="main">|</span> lc_B<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">::</span> bool<span class="main">)</span>"</span></span>
<span class="main">|</span> lc_Seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⟹</span> <span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">⟹</span> <span class="free">lc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> lc_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⟹</span> <span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">⟹</span> <span class="free">lc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> lc_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">|∉|</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> <span class="free">lc</span> <span class="main">(</span>open0_Var <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">lc</span> <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> lc.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">body</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">|∉|</span> <span class="bound">X</span> <span class="main">⟶</span> lc <span class="main">(</span>open0_Var <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lc_Abs_iff_body<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> body <span class="free">T</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> body_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lc.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_open_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="free">xT</span> <span class="free">t</span> <span class="main">⟹</span> fv <span class="main">(</span>open_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">t</span><span class="main">)</span> <span class="main">|⊆|</span> finsert <span class="free">xT</span> <span class="main">(</span>fv <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_close_Var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>close_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">t</span> <span class="main">|-|</span> <span class="main">{|</span><span class="free">xT</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> close_Var_open_Var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="free">xT</span> <span class="free">t</span> <span class="main">⟹</span> close_Var <span class="free">i</span> <span class="free">xT</span> <span class="main">(</span>open_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> open_Var_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="free">xT</span> <span class="free">t</span> <span class="main">⟹</span> fresh <span class="free">xT</span> <span class="free">u</span> <span class="main">⟹</span> open_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">t</span> <span class="main">=</span> open_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> close_Var_open_Var<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> open_Var_open_Var_close_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">xT</span> <span class="main">≠</span> <span class="free">yU</span> <span class="main">⟹</span> fresh <span class="free">yU</span> <span class="free">t</span> <span class="main">⟹</span>
  open_Var <span class="free">i</span> <span class="free">yU</span> <span class="main">(</span>open_Var <span class="free">j</span> <span class="free">zV</span> <span class="main">(</span>close_Var <span class="free">j</span> <span class="free">xT</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> open_Var <span class="free">j</span> <span class="free">zV</span> <span class="main">(</span>close_Var <span class="free">j</span> <span class="free">xT</span> <span class="main">(</span>open_Var <span class="free">i</span> <span class="free">yU</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> open_Var_close_Var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span> <span class="main">⟹</span> open_Var <span class="free">i</span> <span class="free">xT</span> <span class="main">(</span>close_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lc_Abs <span class="skolem">T</span> <span class="skolem">X</span> <span class="skolem">e</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">≠</span> <span class="free">xT</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_fresh<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">e</span> <span class="main">|∪|</span> finsert <span class="free">xT</span> <span class="skolem">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> lc_Abs.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>open0_Var <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"open_Var <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xT</span> <span class="main">(</span>close_Var <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xT</span> <span class="main">(</span>open0_Var <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> open0_Var <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_Var_open_Var_close_Var
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fset_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fv_open_Var<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_Var_inj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> close_Var_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span> <span class="main">⟹</span> lc <span class="free">u</span> <span class="main">⟹</span> close_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">t</span> <span class="main">=</span> close_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> open_Var_close_Var<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">Apps</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∙</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">∙</span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">∙</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">∙</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∙</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∙</span> <span class="free">xs</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∙</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∙</span>  <span class="free">xs</span> <span class="main">∙</span>  <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_Apps_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="main">::</span> <span class="quoted">idx</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">bool</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted">expr</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">m</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">m</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span>  <span class="main">∙</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">m</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">m</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e1</span> <span class="main">?</span> <span class="free">e2</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">e1</span> <span class="main">?</span> <span class="free">e2</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">e1</span> <span class="main">?</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">e1</span> <span class="main">?</span> <span class="free">e2</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">t</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">t</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">t</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_Var_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">xT</span><span class="main">⟩</span> <span class="main">∙</span> <span class="free">ss</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">yU</span><span class="main">⟩</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">⟷</span> <span class="free">xT</span> <span class="main">=</span> <span class="free">yU</span> <span class="main">∧</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> snoc
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Apps_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_Abs_neq_Apps<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">⟨</span><span class="free">xT</span><span class="main">⟩</span> <span class="main">∙</span> <span class="free">ss</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">(</span><span class="free">i</span> <span class="main">::</span> idx<span class="main">)</span> <span class="main">∙</span> <span class="free">ss</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">(</span><span class="free">b</span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">∙</span> <span class="free">ss</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">(</span><span class="free">e1</span> <span class="main">?</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∙</span> <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Apps_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> App_Abs_eq_Apps_Abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="free">T'</span><span class="main">⟩</span> <span class="free">r'</span> <span class="main">∙</span> <span class="free">ss</span> <span class="main">⟷</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T'</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">∧</span> <span class="free">ss</span> <span class="main">=</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Apps_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_Var_neq_Apps_Abs<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">xT</span><span class="main">⟩</span> <span class="main">∙</span> <span class="free">ss</span> <span class="main">≠</span> <span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">∙</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Apps_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_Var_neq_Apps_beta<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">THEN</span> not_sym<span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">xT</span><span class="main">⟩</span> <span class="main">∙</span> <span class="free">ss</span> <span class="main">≠</span> <span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">∙</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Apps_Var_neq_Apps_Abs Apps_append Apps_snoc eq_Apps_conv<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">r</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="free">T'</span><span class="main">⟩</span> <span class="free">r'</span> <span class="main">⋅</span> <span class="free">s'</span> <span class="main">∙</span> <span class="free">ts'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="main">=</span> <span class="free">T'</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">∧</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">#</span> <span class="free">ts'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Apps_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> snoc
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Apps_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_eq_Bool_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(→)</span> <span class="main">(</span>rev <span class="free">Ts</span><span class="main">)</span> <span class="free">T</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="main">⟷</span> <span class="free">Ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="keyword1">ℬ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ</span> <span class="main">=</span> fold <span class="main">(→)</span> <span class="main">(</span>rev <span class="free">Ts</span><span class="main">)</span> <span class="free">T</span> <span class="main">⟷</span> <span class="free">Ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="keyword1">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Ts</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_eq_Fun_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(→)</span> <span class="main">(</span>rev <span class="free">Ts</span><span class="main">)</span> <span class="free">T</span> <span class="main">=</span> <span class="free">U</span> <span class="main">→</span> <span class="free">V</span> <span class="main">⟷</span>
   <span class="main">(</span><span class="free">Ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="free">U</span> <span class="main">→</span> <span class="free">V</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Us</span><span class="main">.</span> <span class="free">Ts</span> <span class="main">=</span> <span class="free">U</span> <span class="main">#</span> <span class="bound">Us</span> <span class="main">∧</span> fold <span class="main">(→)</span> <span class="main">(</span>rev <span class="bound">Us</span><span class="main">)</span> <span class="free">T</span> <span class="main">=</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Ts</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">subst</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">yU</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">yU</span></span></span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">::</span> idx<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⟩</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">xT</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fv <span class="main">(</span>subst <span class="free">xT</span> <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">u</span> <span class="main">|-|</span> <span class="main">{|</span><span class="free">xT</span><span class="main">|}</span> <span class="main">|∪|</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xT</span> <span class="main">|∈|</span> fv <span class="free">u</span> <span class="keyword1">then</span> fv <span class="free">t</span> <span class="keyword1">else</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="free">xT</span> <span class="free">u</span> <span class="main">⟹</span> subst <span class="free">xT</span> <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> open_open_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> open <span class="free">i</span> <span class="free">t</span> <span class="main">(</span>open <span class="free">j</span> <span class="free">t'</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> open <span class="free">j</span> <span class="free">t'</span> <span class="free">u</span> <span class="main">⟹</span> open <span class="free">i</span> <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 6 0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lc_open_id<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">u</span> <span class="main">⟹</span> open <span class="free">k</span> <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lc_Abs <span class="skolem">T</span> <span class="skolem">X</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_fresh<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">e</span> <span class="main">|∪|</span> <span class="skolem">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> lc_Abs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> open_open_id <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_open<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">u</span> <span class="main">⟹</span> subst <span class="free">xT</span> <span class="free">u</span> <span class="main">(</span>open <span class="free">i</span> <span class="free">t</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> open <span class="free">i</span> <span class="main">(</span>subst <span class="free">xT</span> <span class="free">u</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">xT</span> <span class="free">u</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lc_open_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_open_Var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xT</span> <span class="main">≠</span> <span class="free">yU</span> <span class="main">⟹</span> lc <span class="free">u</span> <span class="main">⟹</span> subst <span class="free">xT</span> <span class="free">u</span> <span class="main">(</span>open_Var <span class="free">i</span> <span class="free">yU</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> open_Var <span class="free">i</span> <span class="free">yU</span> <span class="main">(</span>subst <span class="free">xT</span> <span class="free">u</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_open<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_Apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst <span class="free">xT</span> <span class="free">u</span> <span class="main">(</span><span class="free">f</span> <span class="main">∙</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">xT</span> <span class="free">u</span> <span class="free">f</span> <span class="main">∙</span> map <span class="main">(</span>subst <span class="free">xT</span> <span class="free">u</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> fresh_close_Var_id<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="free">xT</span> <span class="free">t</span> <span class="main">⟹</span> close_Var <span class="free">k</span> <span class="free">xT</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_close_Var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xT</span> <span class="main">≠</span> <span class="free">yU</span> <span class="main">⟹</span> fresh <span class="free">yU</span> <span class="free">u</span> <span class="main">⟹</span> subst <span class="free">xT</span> <span class="free">u</span> <span class="main">(</span>close_Var <span class="free">i</span> <span class="free">yU</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> close_Var <span class="free">i</span> <span class="free">yU</span> <span class="main">(</span>subst <span class="free">xT</span> <span class="free">u</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_close_Var_id<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="free">xT</span> <span class="free">t</span> <span class="main">⟹</span> lc <span class="free">u</span> <span class="main">⟹</span> open0 <span class="free">u</span> <span class="free">t</span> <span class="main">=</span> subst <span class="free">xT</span> <span class="free">u</span> <span class="main">(</span>open0_Var <span class="free">xT</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_fresh subst_open<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lc_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">u</span> <span class="main">⟹</span> lc <span class="free">t</span> <span class="main">⟹</span> lc <span class="main">(</span>subst <span class="free">xT</span> <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lc_Abs <span class="skolem">T</span> <span class="skolem">X</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_open_Var <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lc.lc_Abs<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">e</span> <span class="main">|∪|</span> <span class="skolem">X</span> <span class="main">|∪|</span> <span class="main">{|</span><span class="free">xT</span><span class="main">|}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> body_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="free">U</span> <span class="free">u</span> <span class="main">⟹</span> lc <span class="free">t</span> <span class="main">⟹</span> body <span class="free">U</span> <span class="main">(</span>subst <span class="free">xT</span> <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> body_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span> <span class="main">⟶</span> lc <span class="main">(</span>open0_Var <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="free">U</span> <span class="main">(</span>subst <span class="free">xT</span> <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> body_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"finsert <span class="free"><span class="free">xT</span></span> <span class="skolem"><span class="skolem">X</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> conjI allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">|∉|</span> finsert <span class="free">xT</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>open0_Var <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">xT</span> <span class="free">t</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_open_Var<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lc_open_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">u</span> <span class="main">⟹</span> lc <span class="main">(</span>open_Var <span class="free">i</span> <span class="free">xT</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_open_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lc_open<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="free">U</span> <span class="free">u</span> <span class="main">⟹</span> lc <span class="free">t</span> <span class="main">⟹</span> lc <span class="main">(</span>open0 <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> body_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span> <span class="main">⟶</span> lc <span class="main">(</span>open0_Var <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ex_fresh<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"fv <span class="free">u</span> <span class="main">|∪|</span> <span class="skolem">X</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fresh <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subst_intro<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">U</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">welltyped</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">:::</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  welltyped_Var<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">⟩</span> <span class="main"><span class="free">:::</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> welltyped_B<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">::</span> bool<span class="main">)</span> <span class="main"><span class="free">:::</span></span> <span class="keyword1">ℬ</span>"</span></span>
<span class="main">|</span> welltyped_Seq<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="keyword1">ℬ</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="keyword1">ℬ</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="keyword1">ℬ</span>"</span></span>
<span class="main">|</span> welltyped_App<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>
<span class="main">|</span> welltyped_Abs<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">|∉|</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> open0_Var <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:::</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> welltypedE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">::</span> idx<span class="main">)</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">?</span> <span class="free">e2</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⋅</span> <span class="free">e2</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">e</span> <span class="main">:::</span> <span class="free">U</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> welltyped.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>welltyped_Abs <span class="skolem">T</span> <span class="skolem">X</span> <span class="skolem">t</span> <span class="skolem">U</span> <span class="skolem">T'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> welltyped_Abs.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> welltypedE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="skolem">U'</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_fresh<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">|∪|</span> <span class="skolem">Y</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T'</span> <span class="main">=</span> <span class="skolem">T</span> <span class="main">→</span> <span class="skolem">U'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">Y</span> <span class="main">⟶</span> open0_Var <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">:::</span> <span class="skolem">U'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">→</span> <span class="skolem">U</span> <span class="main">=</span> <span class="skolem">T'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> welltyped_Abs.IH<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">rule_format</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">⟹</span> lc <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> welltyped.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_subst<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">:::</span> snd <span class="free">xT</span> <span class="main">⟹</span> subst <span class="free">xT</span> <span class="free">t</span> <span class="free">u</span> <span class="main">:::</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> welltyped.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>welltyped_Abs <span class="skolem">T'</span> <span class="skolem">X</span> <span class="skolem">u</span> <span class="skolem">U</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> welltyped.welltyped_Abs<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"finsert <span class="free"><span class="free"><span class="free">xT</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">X</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_open_Var<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rename_welltyped<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟹</span> subst <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟨</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span><span class="main">⟩</span> <span class="free">u</span> <span class="main">:::</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> welltyped_subst<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_Abs_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fresh <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"open0_Var <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">u</span> <span class="main">:::</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="free">u</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">→</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> welltyped_Abs<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fv <span class="free"><span class="free">u</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fresh <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟨</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span><span class="main">⟩</span> <span class="main">(</span>open0_Var <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">:::</span> <span class="free">U</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">:::</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rename_welltyped<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> open0_Var <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subst_intro<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open0_Var <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="free">u</span> <span class="main">:::</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Apps_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span><span class="main">.</span> <span class="free">f</span> <span class="main">:::</span> fold <span class="main">(→)</span> <span class="main">(</span>rev <span class="bound">Ts</span><span class="main">)</span> <span class="free">T</span> <span class="main">∧</span> list_all2 <span class="main">(:::)</span> <span class="free">ts</span> <span class="bound">Ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition 10 and Lemma 11 from Schmidt-Schau{\ss}'s paper›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> fv <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">constant0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">constant0</span> <span class="keyword1">ℬ</span> <span class="main">=</span> Var <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constant0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⟩</span> <span class="main">(</span><span class="free">constant0</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">constant</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="keyword1">Λ⟨</span><span class="keyword1">ℬ</span><span class="main">⟩</span> <span class="main">(</span>close0_Var <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>constant0 <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_constant0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>constant0 <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_constant<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>constant <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> constant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_constant0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"constant0 <span class="free">T</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lc_open_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lc_constant0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>constant0 <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> welltyped_constant0 welltyped_lc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_constant<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"constant <span class="free">T</span> <span class="main">:::</span> <span class="keyword1">ℬ</span> <span class="main">→</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> constant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> welltyped_Abs_fresh<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''bool''</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nth_drop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_drop</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nth_arg</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">!-</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_arg</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> nth <span class="main">(</span>dest_fun <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ar</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ar</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> length <span class="main">(</span>dest_fun <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_nth_arg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ar <span class="free">T</span> <span class="main">⟹</span> size <span class="main">(</span><span class="free">T</span> <span class="main">!-</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' nth_arg_def gr0_conv_Suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">π</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> type"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span> nth_drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>dest_fun <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">→→</span> <span class="keyword1">ℬ</span> <span class="keyword1">else</span> <span class="keyword1">ℬ</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> ar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="free">π</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">0</span> <span class="main">→</span>
      map <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">o</span> Suc<span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">→→</span> <span class="free">π</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">ℬ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> π_induct<span class="main">[</span><span class="operator">rotated</span> -2<span class="main">,</span> <span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> 0 Suc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> ar <span class="bound">T</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T</span> <span class="bound">i</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> ar <span class="bound">T</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> ar <span class="main">(</span><span class="bound">T</span> <span class="main">!-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">T</span> <span class="main">!-</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">j</span> <span class="main">0</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&lt;</span> ar <span class="main">(</span><span class="bound">T</span> <span class="main">!-</span> <span class="bound">i</span> <span class="main">!-</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">T</span> <span class="main">!-</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ar <span class="free">T</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> ar <span class="main">(</span><span class="free">T</span> <span class="main">!-</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">T</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> π.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ε</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> nat <span class="main">⇒</span> type"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> π <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">→</span> map <span class="main">(</span>π <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">o</span> Suc<span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">→→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Abss</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Λ[</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 800<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ[</span></span><span class="free"><span class="bound"><span class="entity">xTs</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">xT</span> <span class="bound">t</span><span class="main">.</span> <span class="keyword1">Λ⟨</span>snd <span class="bound">xT</span><span class="main">⟩</span> close0_Var <span class="bound">xT</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xTs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Seqs</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">??</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main"><span class="free">??</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">u</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">u</span> <span class="main">?</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">variant</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="main">@</span> replicate <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">CHR</span> <span class="inner_quoted">''*''</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> variant_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"variant <span class="free">i</span> <span class="free">base</span> <span class="main">=</span> variant <span class="free">j</span> <span class="free">base</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> variant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> variant_inj2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">CHR</span> <span class="inner_quoted">''*''</span> <span class="main">∉</span> set <span class="free">b1</span> <span class="main">⟹</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''*''</span> <span class="main">∉</span> set <span class="free">b2</span> <span class="main">⟹</span> variant <span class="free">i</span> <span class="free">b1</span> <span class="main">=</span> variant <span class="free">j</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">b1</span> <span class="main">=</span> <span class="free">b2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> variant_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> Nil_is_append_conv hd_append2 hd_in_set hd_rev last_ConsR
     last_snoc replicate_append_same rev_replicate<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> nat <span class="main">⇒</span> expr"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> expr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">let</span>
       <span class="bound">Ti</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">x</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>variant <span class="bound">k</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="bound">k</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">xs</span> <span class="main">=</span> map <span class="bound">x</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">;</span>
       <span class="bound">xx_var</span> <span class="main">=</span> <span class="main">⟨</span>nth <span class="bound">xs</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟩</span><span class="main">;</span>
       <span class="bound">x_vars</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>nth_drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">yy</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''z''</span><span class="main">,</span> π <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">yy_var</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">yy</span><span class="main">⟩</span><span class="main">;</span>
       <span class="bound">y</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>variant <span class="bound">j</span> <span class="inner_quoted">''y''</span><span class="main">,</span> π <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">ys</span> <span class="main">=</span> map <span class="bound">y</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="bound">Ti</span><span class="main">]</span><span class="main">;</span>
       <span class="bound">e</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">y</span> <span class="bound">j</span><span class="main">⟩</span> <span class="main">∙</span> <span class="main">(</span><span class="free">P</span> <span class="bound">Ti</span> <span class="bound">j</span> <span class="main">0</span> <span class="main">⋅</span> <span class="bound">xx_var</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">Ti</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">⋅</span> <span class="bound">xx_var</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="main">(</span><span class="bound">Ti</span><span class="main">!-</span><span class="bound">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">guards</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">xx_var</span> <span class="main">∙</span>
           map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> constant <span class="main">(</span><span class="bound">Ti</span><span class="main">!-</span><span class="bound">j</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">e</span> <span class="bound">i</span> <span class="main">∙</span> <span class="bound">x_vars</span> <span class="keyword1">else</span> True<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="bound">Ti</span><span class="main">]</span><span class="main">)</span>
         <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="bound">Ti</span><span class="main">]</span>
     <span class="keyword1">in</span> <span class="keyword1">Λ[</span><span class="main">(</span><span class="bound">yy</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="bound">guards</span> <span class="main">??</span> <span class="main">(</span><span class="bound">yy_var</span> <span class="main">∙</span> <span class="bound">x_vars</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> constant <span class="main">(</span>ε <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⋅</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">let</span>
       <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''f''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">f_var</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">f</span><span class="main">⟩</span><span class="main">;</span>
       <span class="bound">x</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>variant <span class="bound">k</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="bound">k</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">xs</span> <span class="main">=</span> nth_drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>map <span class="bound">x</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">x_vars</span> <span class="main">=</span> insert_nth <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>constant <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⋅</span> True<span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="keyword1">Λ[</span><span class="main">(</span><span class="bound">f</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="bound">f_var</span> <span class="main">∙</span> <span class="bound">x_vars</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> constant <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> π <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">⋅</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> ar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">let</span>
       <span class="bound">Ti</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">Tij</span> <span class="main">=</span> <span class="bound">Ti</span><span class="main">!-</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
       <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''f''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">f_var</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">f</span><span class="main">⟩</span><span class="main">;</span>
       <span class="bound">x</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>variant <span class="bound">k</span> <span class="inner_quoted">''x''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">!-</span><span class="bound">k</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">xs</span> <span class="main">=</span> nth_drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>map <span class="bound">x</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">yy</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''z''</span><span class="main">,</span> π <span class="bound">Ti</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">yy_var</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">yy</span><span class="main">⟩</span><span class="main">;</span>
       <span class="bound">y</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>variant <span class="bound">k</span> <span class="inner_quoted">''y''</span><span class="main">,</span> π <span class="bound">Ti</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">ys</span> <span class="main">=</span> map <span class="bound">y</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="bound">Tij</span><span class="main">]</span><span class="main">;</span>
       <span class="bound">y_vars</span> <span class="main">=</span> <span class="bound">yy_var</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">ys</span><span class="main">;</span>
       <span class="bound">x_vars</span> <span class="main">=</span> insert_nth <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free">E</span> <span class="bound">Ti</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∙</span> <span class="bound">y_vars</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="keyword1">Λ[</span><span class="main">(</span><span class="bound">f</span> <span class="main">#</span> <span class="bound">yy</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="bound">f_var</span> <span class="main">∙</span> <span class="bound">x_vars</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> constant <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> π <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Abss_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ[</span><span class="main">[]</span><span class="main">]</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Abss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Abss_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ[</span><span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">]</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">Λ⟨</span>snd <span class="free">x</span><span class="main">⟩</span> <span class="main">(</span>close0_Var <span class="free">x</span> <span class="main">(</span><span class="keyword1">Λ[</span><span class="free">xs</span><span class="main">]</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Abss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_Abss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">=</span> map snd <span class="free">xTs</span> <span class="main">→→</span> <span class="free">U</span> <span class="main">⟹</span> <span class="keyword1">Λ[</span><span class="free">xTs</span><span class="main">]</span> <span class="free">b</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">hypsubst_thin</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xTs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> welltyped_Abs_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_Apps<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(:::)</span> <span class="free">ts</span> <span class="free">Ts</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">:::</span> <span class="free">Ts</span> <span class="main">→→</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">:::</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">Ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_open_Var_close_Var<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">⟹</span> open0_Var <span class="free">xT</span> <span class="main">(</span>close0_Var <span class="free">xT</span> <span class="free">t</span><span class="main">)</span> <span class="main">:::</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_Var_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span><span class="main">⟩</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟷</span> <span class="free">T</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_bool_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">⟷</span> <span class="free">T</span> <span class="main">=</span> <span class="keyword1">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_constant0_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"constant0 <span class="free">T</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">U</span> <span class="main">=</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ex_fresh lc_open_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_constant_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"constant <span class="free">T</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">U</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="main">→</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> constant_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> welltypedE<span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst_thin</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> type.inject simp_thms<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span> <span class="main">⟶</span> open0_Var <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>close0_Var <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>constant0 <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">:::</span> <span class="skolem">U</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_fresh<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">ℬ</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open0_Var <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>close0_Var <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>constant0 <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">:::</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open0_Var <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>close0_Var <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>constant0 <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">:::</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rename_welltyped<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹open0_Var <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>close0_Var <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">,</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">(</span>constant0 <span class="free">T</span><span class="main">)</span><span class="main">)</span>›</span></span>
       <span class="quoted"><span class="skolem">U</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="keyword1">ℬ</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''bool''</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_open subst_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> welltyped_Abs_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_Seq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">?</span> <span class="free">e2</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">T</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="main">∧</span> <span class="free">e1</span> <span class="main">:::</span> <span class="keyword1">ℬ</span> <span class="main">∧</span> <span class="free">e2</span> <span class="main">:::</span> <span class="keyword1">ℬ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_Seqs_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">??</span> <span class="free">e</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">(</span><span class="free">es</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">T</span> <span class="main">=</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="free">es</span><span class="main">.</span> <span class="bound">e</span> <span class="main">:::</span> <span class="keyword1">ℬ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">:::</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Seqs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_App_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="free">f</span> <span class="main">:::</span> <span class="bound">T</span> <span class="main">→</span> <span class="free">U</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">:::</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_Apps_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∙</span> <span class="free">ts</span> <span class="main">:::</span> <span class="free">U</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span><span class="main">.</span> <span class="free">f</span> <span class="main">:::</span> <span class="bound">Ts</span> <span class="main">→→</span> <span class="free">U</span> <span class="main">∧</span> list_all2 <span class="main">(:::)</span> <span class="free">ts</span> <span class="bound">Ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_fun_def list_all2_Cons1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mk_fun_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="free">Ts</span> <span class="main">→→</span> <span class="keyword1">ℬ</span> <span class="main">⟷</span> <span class="free">Ts</span> <span class="main">=</span> dest_fun <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_nth_eq_drop_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> drop <span class="free">i</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dest_fun_π_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ar <span class="free">T</span> <span class="main">⟹</span> dest_fun <span class="main">(</span>π <span class="free">T</span> <span class="free">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> nth_drop <span class="free">i</span> <span class="main">(</span>dest_fun <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> welltyped_E<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">T</span> <span class="free">i</span> <span class="main">:::</span> ε <span class="free">T</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> welltyped_P<span class="main">:</span> <span class="quoted"><span class="quoted">"P <span class="free">T</span> <span class="free">i</span> <span class="free">j</span> <span class="main">:::</span> <span class="free">T</span> <span class="main">→</span> π <span class="free">T</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> E_P.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">T</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> P.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> π.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> ε_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> nth_drop_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> nth_arg_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ refl refl refl refl refl refl refl refl refl<span class="main">]</span>
       1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ refl refl refl refl refl refl refl refl refl<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def o_def take_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> drop_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      list_all2_conv_all_nth nth_append min_def dest_fun_π_0 π.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> welltyped_Abs_fresh welltyped_Abss<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="keyword1">ℬ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">T</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def take_map drop_map o_def list_all2_conv_all_nth nth_append nth_Cons'
       nth_drop_def nth_arg_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> welltyped_constant welltyped_Abs_fresh welltyped_Abss<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="keyword1">ℬ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">T</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> E.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> π.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> Abss_Cons<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> ε_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    nth_drop_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> nth_arg_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ refl refl refl refl refl refl refl refl refl refl refl<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def o_def take_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> drop_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      list_all2_conv_all_nth nth_append nth_Cons' min_def π.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> welltyped_Abs_fresh welltyped_Abss<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="keyword1">ℬ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> δ_gt_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≠</span> <span class="keyword1">ℬ</span> <span class="main">⟹</span> HMSet <span class="main">{#}</span> <span class="main">&lt;</span> δ <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_nth_drop_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> mset <span class="main">(</span>nth_drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Cons' nth_drop_def gr0_conv_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_nth_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="main">(</span>nth_drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> nth_drop <span class="free">i</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Cons' nth_drop_def gr0_conv_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_less_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">&lt;</span> mset <span class="free">xs</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dest_fun_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"dest_fun <span class="free">T</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">T</span> <span class="main">!-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>ar <span class="free">T</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq nth_arg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> π.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="keyword2"><span class="keyword">notes</span></span> One_nat_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> δ_π<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ar <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> ar <span class="main">(</span><span class="free">T</span> <span class="main">!-</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"δ <span class="main">(</span>π <span class="free">T</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">&lt;</span> δ <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> π_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> ar <span class="skolem">T</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"δ <span class="main">(</span>π <span class="skolem">T</span> <span class="skolem">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> δ <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mk_fun_dest_fun<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> δ_mk_fun<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> δ_mk_fun mset_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> take_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> drop_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> π.simps
        mset_nth_drop_less map_nth_drop <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mset_map<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ti</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">!-</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> ar <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> ar <span class="var">?Ti</span>"</span></span> <span class="quoted"><span class="quoted">"δ <span class="main">(</span>π <span class="var">?Ti</span> <span class="skolem">j</span> <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> δ <span class="var">?Ti</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> ar <span class="main">(</span><span class="var">?Ti</span> <span class="main">!-</span> <span class="skolem">j</span><span class="main">)</span><span class="main">.</span> δ <span class="main">(</span>π <span class="var">?Ti</span> <span class="skolem">j</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> δ <span class="var">?Ti</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{#</span>δ <span class="var">?Ti</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">{#</span>δ <span class="main">(</span>π <span class="var">?Ti</span> <span class="skolem">j</span> <span class="main">0</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span>δ <span class="main">(</span>π <span class="var">?Ti</span> <span class="skolem">j</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈#</span> mset <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> ar <span class="main">(</span><span class="var">?Ti</span> <span class="main">!-</span> <span class="skolem">j</span><span class="main">)</span><span class="main">]</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">≡</span> <span class="main">{#</span> δ <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> mset <span class="main">(</span>nth_drop <span class="skolem">i</span> <span class="main">(</span>dest_fun <span class="skolem">T</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"δ <span class="main">(</span>π <span class="skolem">T</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> HMSet <span class="main">(</span><span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> One_nat_def π.simps δ_mk_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">M</span> <span class="main">&lt;</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">X</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">Y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HMSet <span class="main">(</span><span class="skolem">X</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> δ <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mk_fun_dest_fun<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> id_take_nth_drop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"dest_fun <span class="skolem"><span class="skolem"><span class="skolem">T</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> δ_mk_fun nth_arg_def nth_drop_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"δ <span class="main">(</span>π <span class="skolem">T</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> δ <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>